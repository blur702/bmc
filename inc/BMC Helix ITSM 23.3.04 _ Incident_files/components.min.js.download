"use strict";function EmailWindowVO(){this.ticketData=[],this.senderList=[]}function ChatMessageDataVO(){this.text="",this.created=null,this.author="",this.data=[],this.type="",this.fromHistory="",this.chatWindow={}}function ChatMessageVO(){this.text="",this.created=null,this.author="",this.type="",this.eventType="",this.chatWindow={}}function ChatWindowVO(){this.id=(new Date).getTime()+"_roomDummy@conf.host",this.room={},this.parent=null,this.inviterJID=null,this.participants={},this.roster=null,this.messages=[],this.isOpened=!1,this.isLoading=!0,this.conversationThumbnail="",this.roomOwner=null}!function(){angular.module("myitsmApp").directive("emailAccelerators",["$window",function(e){return{restrict:"E",replace:!0,templateUrl:"components/email/email-accelerators.html",link:function(e,t){t.show(function(){var e,n,i,s=t.parent(),a=t[0].offsetWidth,o=t[0].offsetHeight;e=$(window).width()-(s.offset().left+s.outerWidth()),n=s.offset().left,i=s.offset().top,e>=a?t.css({left:"100%",right:"auto"}):n>=a?t.css({right:"100%",left:"auto"}):i>=o?t.css({left:"auto",right:"auto",top:"-100%"}):t.css({maxWidth:n,right:"auto",left:"auto"})})}}}])}(),function(){angular.module("myitsmApp").factory("emailModel",["attachmentService","feedModel","userModel","systemAlertService",function(e,t,n,i){var s={emailInstances:[]};return s.createEmail=function(e,t){var n=s.createEmailWindowInstance(e,t);s.emailInstances.push(n)},s.createEmailWindowInstance=function(e,t){var n=new EmailWindowVO,i={};return e&&(i.ticketData=e,t&&(i.senderList=t),n.build(i)),n},s.deleteEmailWindow=function(e){var t=s.emailInstances.indexOf(e);t>=0&&s.emailInstances.splice(t,1)},s.addAttachment=function(t){return e.prepareFileToUpload({fileInput:t})},s.sendEmail=function(e,s,a){var o,r={worknote:e.messageBody,access:!0,"Email.From.Person":{email:n.userFullData.email,fullName:n.userFullData.fullName,loginId:n.userFullData.loginId},"Email.Subject":e.subjectText,"Email.Body":e.messageBody};if(e.attachment&&(r.attachments=[e.attachment]),a){var c=_.map(a,"email");r["Email.To.InternetEmail"]=c.join(";")}if(s&&s.length&&(s=_.map(s,function(e){return{email:e.email,loginId:e.loginId,fullName:e.fullName}}),r["Email.To.Person"]=s),e.kba&&(r.articleId=e.kba.id,r.articleDisplayId=e.kba.displayId,r.attachmentType="pdf"),e.ticketList){e.attachment&&_.forEach(e.ticketList,function(e){e.workNoteType=FeedItemVO.WORK_INFO_TYPES[e.type]}),r.ticketList=e.ticketList;var l=t.saveNoteBulk(r);return l["catch"](function(e){i.error({text:e.data.error,clear:!1})}),l}return o={type:e.ticketType,id:e.ticketId},r.workInfoType=FeedItemVO.WORK_INFO_TYPES[e.ticketType],t.saveNote(o,r)},s}])}(),function(){angular.module("myitsmApp").controller("EmailPopupWindowController",["$scope","emailModel",function(e,t){e.emailModel=t;var n=window.opener.popupDetails;e.emailInstance=n.emailWindow}])}(),function(){angular.module("myitsmApp").directive("emailRecipient",["$timeout","$q","i18nService","createTicketModel","userModel","personModel","collisionModel","browser",function(e,t,n,i,s,a,o,r){var c=/^[a-z0-9!#$%&'*+\/=?^_`{|}~.-]+@[a-z0-9-]+(\.[a-z0-9-]+)*$/i;return{restrict:"E",templateUrl:"components/email/email-recipient.html",replace:!0,scope:{label:"@",recipientList:"=",ticketData:"=",inputText:"="},link:function(l,d){function u(e,t,n,i){l.recipientList.push({email:e,fullName:t?t:e,loginId:n,internal:!!n,type:i||""})}function h(){var e=l.recipientList.length;e>0&&l.recipientList.splice(e-1,1)}function m(){e(function(){l.inputText.length&&g.text(l.inputText),l.recipientList.length>0&&_.each(l.recipientList,function(e){e.email||a.getPersonDetailsByID(e.id).then(function(t){e.email=t.email,e.loginId=t.loginId,e.internal=!!e.loginId})}),l.focusInput()},0)}l.userModel=s;var p={backspace:8,enter:13,leftArrow:37,rightArrow:39,upArrow:38,downArrow:40,space:32,comma:188,semiColon:186,semiColon_FF:59},g=d.find("span.email__recipient-input"),f=null;l.defaultListLoading=!1,l.getList=function(e,s){if("***"===s&&1===l.ticketData.length){var r=[],c=[],d=l.ticketData[0],u=[{name:"customer",label:"common.label.customer"},{name:"contact",label:"common.label.contact"},{name:d.type===EntityVO.TYPE_RELEASE?"coordinator":"assignee",label:"common.labels.assignee"},{name:"manager",label:"create.workorder.requestmanager"}];return d.type===EntityVO.TYPE_CHANGE&&u.push({name:"collisionManagers",label:"change.detail.emailRecipients.allCollisionManagers"}),d.type===EntityVO.TYPE_RELEASE&&null!=d.releaseCoordinator&&u.push({name:"releaseCoordinator",label:"common.labels.assignee"}),d.type!==EntityVO.TYPE_PROBLEM&&d.type!==EntityVO.TYPE_KNOWNERROR||null==d.problemCoordinator?d.type!==EntityVO.TYPE_PROBLEM&&d.type!==EntityVO.TYPE_KNOWNERROR||null==d.coordinator||u.push({name:"coordinator",label:"problem.details.coordinator"}):u.push({name:"problemCoordinator",label:"problem.details.coordinator"}),_.each(u,function(e){var t;if(d[e.name]&&d[e.name].loginId)if(t=d[e.name],t.fullName||!t.firstName&&!t.lastName||(t.fullName=t.firstName+" "+t.lastName),t.type=n.getLocalizedString(e.label),t.email)r.push(t);else{l.defaultListLoading=!0;var i=a.getPersonDetailsByID(t.loginId).then(function(e){e&&(t.email=e.email?e.email:"",t.company={},t.company.name=e.company?e.company.name:"",r.push(t))});c.push(i)}if("collisionManagers"===e.name){l.defaultListLoading=!0,t={isPersonList:!0,type:n.getLocalizedString(e.label),personList:[],companySummary:[],emailSummary:[]};var s=o.getListOfCollisionsById(d,!1);s.then(function(e){if(e&&e.count>0){var n=[];_.each(e.changeList,function(e){n.push(e.assignee)}),t.personList=_.uniqBy(n,"id");var i=[];_.each(t.personList,function(e){e.loginId=e.id,e.company={},i.push(e.fullName)}),t.combinedNames=i.join(),r.push(t)}}),c.push(s)}}),t.all(c).then(function(){return l.defaultListLoading=!1,r})}return"***"===s&&(s="%%%"),i.getList(e,s,null,null,!0).then(function(e){return e.items})},l.removeRecipient=function(e){if(l.recipientList){var t=l.recipientList.indexOf(e);t>=0&&l.recipientList.splice(t,1)}},l.focusInput=function(){g.focus()},l.handleBlurEvent=function(){l.typeaheadLoading=!1,f||e.cancel(f),f=e(function(){l.inputText&&c.test(l.inputText)&&(u(l.inputText),g.empty())},200)},l.handleKeydown=function(e){switch(e.keyCode||e.which){case p.backspace:var t=g.text().trim();0===t.length?(h(),l.focusInput(),e.stopPropagation()):1===t.length&&r.isEdge&&(g.text(""),e.stopPropagation());break;case p.enter:l.inputText.length>0&&(u(l.inputText),g.empty(),l.focusInput()),e.stopPropagation(),e.preventDefault()}},l.onTextChange=function(){if(l.inputText&&"***"!==l.inputText){var e=l.inputText.substr(l.inputText.length-1);[",",";"].indexOf(e)>=0&&l.inputText.length>0&&(u(l.inputText.substr(0,l.inputText.length-1)),g.empty(),l.focusInput())}},l.onRecipientSelect=function(e){e.isPersonList&&_.each(e.personList,function(t){u(t.email,t.fullName,t.id,e.type),g.empty()}),e.email&&(u(e.email,e.fullName,e.loginId,e.type),g.empty()),l.focusInput()},m()}}}]).directive("bindContenteditable",["$timeout",function(e){return{restrict:"A",require:"?ngModel",scope:{isDisabled:"="},link:function(t,n,i,s){function a(i){if(i.keyCode===d.downArrow&&""===l)t.$apply(c),i.stopPropagation(),i.preventDefault();else{if((i.keyCode===d.upArrow||i.keyCode===d.downArrow)&&"***"===l)return;i.keyCode===d.escape?s.$setViewValue(""):t.isDisabled?(n.empty(),i.stopPropagation(),i.preventDefault()):e(function(){r()})}}function o(e){t.isDisabled&&(n.empty(),e.stopPropagation(),e.preventDefault())}function r(){var e=n.text().trim();l!==e&&(l=e,s.$setViewValue(e))}function c(){s.$setViewValue("***")}var l="",d={upArrow:38,downArrow:40,escape:27};s&&(n.on("blur keyup change",a),n.on("keydown",o),t.$on("$destroy",function(){console.log("emailRecipientGraph: unbind events"),n.off("blur",a),n.off("keyup",a),n.off("change",a),n.off()}),r())}}}])}(),function(){angular.module("myitsmApp").directive("emailWindow",["$window","$filter","$timeout","$state","ticketModel","emailModel","systemAlertService","events","accelerators","i18nService","relationModel","browser","elementFocus",function(e,t,n,i,s,a,o,r,c,l,d,u,h){return{restrict:"E",templateUrl:"components/email/email-window.html",replace:!0,scope:{emailInstance:"=",isPopupWindow:"@"},link:function(i,s){function m(){i.showPopOver=!1;var e,t;i.emailInstance.ticketData&&(1===i.emailInstance.ticketData.length&&i.emailInstance.ticketData[0].type===EntityVO.TYPE_INCIDENT&&(i.showPopOver=!0,d.getRelations(i.emailInstance.ticketData[0].id,i.emailInstance.ticketData[0].type).then(function(){i.pinnedKBA=_.filter(d.cache[i.emailInstance.ticketData[0].id],function(e){return e.type===EntityVO.TYPE_KNOWLEDGE&&e.realObject.internalUse===!1&&!e.isDecisionTree()}),i.disableKBAttachment=!i.pinnedKBA.length,i.showArticles=!1})),i.emailInstance.ticketData[0].type===EntityVO.TYPE_KNOWLEDGE?(e="articleId",t="title"):i.emailInstance.ticketData[0].type===EntityVO.TYPE_SBEREQUEST?(e="id",t="serviceName"):(e="displayId",t="summary"),i.emailInstance.ticketData.length>1?i.emailContext.headerText=_.map(i.emailInstance.ticketData,function(t){return t[e]}).join("; "):i.emailContext.headerText=i.emailInstance.ticketData[0][e]+" : "+i.emailInstance.ticketData[0][t],i.emailContext.subjectText=i.emailContext.headerText,i.checkByteLength(255))}function p(e){var t=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return t.test(e)}var g,f=s.find("textarea.email__message-editor"),y=!1,v=!1,C=0,b=0,S={enter:13,escape:27,tab:9,leftArrow:37,rightArrow:39,upArrow:38,downArrow:40,space:32},O=[S.leftArrow,S.rightArrow,S.enter,S.upArrow,S.downArrow,S.tab],T=!!i.isPopupWindow;T?(e.document.body.style.minWidth=0,e.document.body.style.overflow="hidden",i.emailContext=i.emailInstance.parentEmailContext):(s.draggable({containment:"parent",scroll:!1,handle:".drag-handle"}),i.emailContext={headerText:"",recipientInputText:"",senderList:i.emailInstance.senderList||[],subjectText:"",messageBody:""},i.emailInstance.ticketData.length>1?i.emailContext.ticketList=_.map(i.emailInstance.ticketData,function(e){return{id:e.id,type:e.type}}):(i.emailContext.ticketType=i.emailInstance.ticketData[0].type,i.emailContext.ticketId=i.emailInstance.ticketData[0].id)),i.sendingEmail=!1,i.showArticles=!1,i.articlesLoading=!1,i.emailActions={},i.accelerators={expression:"",showAcceleratorsList:!1,availableExpressions:[]},i.emailContext.ticketList||(i.accelerators.availableExpressions=_.filter(c.ticket,function(e){return!(e.onlyFor&&e.onlyFor.indexOf(i.emailInstance.ticketData[0].type)<0)&&(e.expr="!"+l.getLocalizedString(e.key),e.text=i.$eval(e.valueExpr,{exprContext:i.emailInstance.ticketData[0]}),e.type&&(e.text=t("localizeLabel")(e.text,e.type,i.emailInstance.ticketData[0].type)),!!e.text&&e.text.trim())})),i.emailControls=[{iconClass:"icon-trash",name:"deleteEmail",inactive:!1},{iconClass:"icon-pop_up",name:"popoutEmail",inactive:!!i.isPopupWindow}],i.handleEmailControlsClick=function(e,t){return i.emailActions[t.name]()},i.checkByteLength=function(e){i.emailContext.subjectText.length>e&&(i.emailContext.subjectText=i.emailContext.subjectText.substring(0,e));for(var t=new Blob([i.emailContext.subjectText]).size,n=i.emailContext.subjectText.length;t>e;)n-=Math.ceil((t-n)/4),i.emailContext.subjectText=i.emailContext.subjectText.substring(0,n),t=new Blob([i.emailContext.subjectText]).size},i.emailActions.deleteEmail=function(){var n={title:t("i18n")("email.deleteEmailModal.title"),text:t("i18n")("email.deleteEmailModal.label"),buttons:[{text:t("i18n")("email.button.keepEmail")},{text:t("i18n")("email.button.deleteEmail"),data:{"delete":!0}}]},s=o.modal(n);s.result.then(function(t){_.isEmpty(t)||t["delete"]&&(i.isPopupWindow&&e.close(),a.deleteEmailWindow(i.emailInstance))})},i.emailActions.popoutEmail=function(){i.emailInstance.parentEmailContext=i.emailContext,e.popupDetails={emailWindow:i.emailInstance};var t=10*Math.round(screen.width/3/10),n=Math.round(70*screen.height/100);e.open("#/emailPopupWindow","","location=no, scrollbars=no, resizable=yes, width="+t+", height="+n),a.deleteEmailWindow(i.emailInstance)},i.sendEmail=function(){var e=s.find(".email__recipient-list span").text(),t=i.$root,n=!1;e&&(n=p(e));var o=_.filter(i.emailContext.senderList,{internal:!0}),c=_.filter(i.emailContext.senderList,{internal:!1});n&&c.push({email:e,internal:!1});try{t=window.opener.angular.element("body").scope()}catch(l){}i.sendingEmail=!0,a.sendEmail(i.emailContext,o,c)["finally"](function(){_.delay(function(){t.$broadcast(r.REFRESH_ACTIVITY_FEED)},400),a.deleteEmailWindow(i.emailInstance),i.isPopupWindow&&window.close()})},i.handleEmailBodyKeyDown=function(e){i.emailContext.ticketList||(49!==e.which&&49!==e.keyCode||!e.shiftKey||(i.accelerators.showAcceleratorsList=!0,C=e.target.selectionStart,y=!0,u.isIE11&&f[0].value.length<C&&(C=f[0].value.length)),i.accelerators.showAcceleratorsList&&(O.indexOf(e.keyCode)>=0||e.keyCode==S.space&&v)&&e.preventDefault())},i.handleEmailBodyChange=function(e){if(!i.emailContext.ticketList){b=e.target.selectionEnd,f=s.find("textarea.email__message-editor");var a=f[0];if(a.value.length>1&&y&&C>b)return void(i.accelerators.showAcceleratorsList=!1);if(a.normalize&&a.normalize(),i.accelerators.showAcceleratorsList){if(v&&[S.tab,S.rightArrow,S.space].indexOf(e.keyCode)>=0)return i.insertAcceleratorText(i.acceleratorsList[0]),void(v=!1);if(y&&e.keyCode==S.tab){var o=a.value;i.typeAheadListPos==i.acceleratorsList.length-1?i.typeAheadListPos=0:i.typeAheadListPos++;var r=i.acceleratorsList[i.typeAheadListPos]?i.acceleratorsList[i.typeAheadListPos].expr:"",c=[o.slice(0,C),r,o.slice(b)].join("");return b=parseInt(C+r.length),g=c.substring(C,b),i.emailContext.messageBody=c,void n(function(){a.setSelectionRange(C,b),a.selectionStart=C,a.selectionEnd=b})}if(e.ctrlKey===!0||e.altKey===!0||e.keyCode===S.leftArrow||e.keyCode===S.rightArrow)return;if(e.keyCode===S.upArrow)return void(i.typeAheadListPos>0&&i.typeAheadListPos--);if(e.keyCode===S.downArrow)return void(i.typeAheadListPos<i.acceleratorsList.length-1&&i.typeAheadListPos++);if(e.keyCode===S.enter){i.accelerators.expression=g;var r=_.filter(i.accelerators.availableExpressions,{expr:i.accelerators.expression})[0];return void(r?i.insertAcceleratorText(r):i.insertAcceleratorText(i.acceleratorsList[i.typeAheadListPos]))}if(e.keyCode===S.escape)return void i.disableTypeAheadMode()}if(i.emailContext.messageBody.length>0?y&&(g=a.value.substring(C,b),i.typeAheadListPos=0):y&&i.hideTypeAheadPopup(),y&&g.length>0&&g!=i.accelerators.expression)if(i.acceleratorsList=t("filter")(i.accelerators.availableExpressions,{expr:g.substring(1)}),i.acceleratorsList.length>0||0==i.accelerators.expression.length){if(i.acceleratorsList.length>0?i.accelerators.showAcceleratorsList=!0:angular.noop(),i.accelerators.expression=g,i.popupLeftPosition=0,i.popupTopPosition=0,1===i.acceleratorsList.length){var l=i.acceleratorsList[0],d=new RegExp(l.expr,"gi");v=d.test(g),v&&(i.emailContext.messageBody.replace(d,l.expr),a.setSelectionRange(C,b),a.selectionStart=C,a.selectionEnd=b)}}else 0===i.acceleratorsList.length&&i.accelerators.expression.length>=1&&(i.hideTypeAheadPopup(),i.accelerators.expression="")}},i.handleEmailBodyClick=function(e){if(b=e.target.selectionEnd,f=s.find("textarea.email__message-editor"),f[0]&&f[0].value.length>1&&i.accelerators.showAcceleratorsList&&C>b)return void(i.accelerators.showAcceleratorsList=!1)},i.handleTextPaste=function(t){f=s.find("textarea.email__message-editor");var n;if(t.preventDefault(),t.stopImmediatePropagation(),t.originalEvent&&t.originalEvent.clipboardData)n=t.originalEvent.clipboardData.getData("text/plain");else{if(!e.clipboardData)return;n=e.clipboardData.getData("Text")}var a=[n];_(i.accelerators.availableExpressions).forEach(function(e,t){var n=a[t],i=new RegExp(e.expr,"gi"),s=e.text;a.push(n.replace(i,s))});var o=f[0].value,r=0,c=0;t.target.selectionStart==t.target.selectionEnd&&t.target.selectionStart>0?r=c=t.target.selectionStart:t.target.selectionStart!=t.target.selectionEnd&&(t.target.selectionStart>t.target.selectionEnd?(r=t.target.selectionEnd,c=t.target.selectionStart):(r=t.target.selectionStart,c=t.target.selectionEnd));var l=a.pop();i.emailContext.messageBody=o.substring(0,r)+l+o.substring(c,o.length)},i.acceleratorMouseover=function(e){i.typeAheadListPos=e},i.insertAcceleratorText=function(e){var t=f[0].value,n=e||i.acceleratorsList[i.typeAheadListPos],s=n.text,a=t;i.accelerators.expression?0===C?a=s+" ":(s+=" ",a=[t.slice(0,C),s,t.slice(b)].join("")):0===t.length?a=s:b>0?a=[t.slice(0,b)," "+s+" ",t.slice(b)].join(""):a+=" "+s,i.disableTypeAheadMode(),i.emailContext.messageBody=a},i.hideTypeAheadPopup=function(){i.accelerators.showAcceleratorsList=!1},i.disableTypeAheadMode=function(){g="",i.accelerators.expression="",i.accelerators.showAcceleratorsList=!1,i.typeAheadListPos=0,i.acceleratorsList=null,y=!1,C=0,b=0},i.acceleratorsHelp=function(){g="!",i.accelerators.expression="",i.accelerators.showAcceleratorsList=!0,i.typeAheadListPos=0,i.acceleratorsList=i.accelerators.availableExpressions,C=i.emailContext.messageBody.length,f=s.find("textarea.email__message-editor"),f.focus()},i.addEmailAttachment=function(e){return!i.emailContext.attachment&&(i.emailContext.attachment=a.addAttachment(e),void h("emailBtn"))},i.openPinnedArticles=function(){i.showArticles=!0},i.selectResource=function(e,t){e.stopPropagation(),i.emailContext.kba=i.emailContext.kba===t?null:t},i.isResourceSelected=function(e){return i.emailContext.kba&&i.emailContext.kba.displayId===e.displayId},i.attachKBA=function(){i.showArticles=!1},i.showEmailBody=function(){i.emailContext.kba=null,i.showArticles=!1},i.removeKBAttachment=function(){i.emailContext.kba=null},i.removeEmailAttachment=function(){i.emailContext.attachment&&(i.emailContext.attachment=null)},i.handleAttachClick=function(){setTimeout(function(){document.getElementById("email-ka-attach-btn").click()},0)},m()}}}])}(),EmailWindowVO.prototype=new BaseVO,EmailWindowVO.prototype.constructor=EmailWindowVO,EmailWindowVO.prototype.getProps=function(){return["ticketData","senderList"]},EmailWindowVO.prototype.postBuild=function(){},function(){angular.module("myitsmApp").directive("chatAssignSuggestion",["chatModel",function(e){return{restrict:"AE",templateUrl:"components/chat/chat-assign-suggestion.html",replace:!0,link:function(t,n){var i="";if(t.userProfilesCache=e.cachedProfiles,t.item.hasOwnProperty("firstName")||t.item.hasOwnProperty("loginId")){if(t.item.isPerson=!0,i=t.item.jid){var s=_.find(e.cachedProfiles,{loginId:t.item.loginId})||{};i=s.jid,i||(i=e.generateUserJID(t.item.loginId),i&&e.checkUserAvailability(t.jid))}}else t.item.hasOwnProperty("category")&&(t.item.isPerson=!1,t.item.itemStatus=t.item.additionalInformation&&t.item.additionalInformation.status?t.item.additionalInformation.status.value:"");var a=t.$watch(function(){return i&&t.userProfilesCache[i]},function(n){n&&(t.item.available=e.cachedProfiles[i].available)});t.generateSelectedClass=function(e){var i=e==t.searchBar.selectedSuggestionIndex?"chat__search-result_selected-item":"";return i&&null!==t.searchBar.alignWithTop&&(n[0].scrollIntoView(!1),t.searchBar.alignWithTop=null),i},t.$on("destroy",a)}}}])}(),ChatMessageDataVO.prototype=new BaseVO,ChatMessageDataVO.prototype.constructor=ChatMessageDataVO,ChatMessageDataVO.prototype.getProps=function(){return["text","created","author","data","type","fromHistory","chatWindow"]},ChatMessageDataVO.prototype.postBuild=function(){this.created=this.created?new Date(this.created).getTime():(new Date).getTime()},ChatMessageVO.prototype=new BaseVO,ChatMessageVO.prototype.constructor=ChatMessageVO,ChatMessageVO.prototype.getProps=function(){return["text","created","author","type","chatWindow","parent","eventType"]},ChatMessageVO.prototype.postBuild=function(){this.created=this.created?new Date(this.created).getTime():(new Date).getTime()},function(){angular.module("myitsmApp").directive("chatMessage",["$timeout","chatModel","chatSwarm","$filter","$state",function(e,t,n,i,s){return{restrict:"AE",templateUrl:"components/chat/chat-message.html",replace:!0,scope:{message:"=context",type:"@"},link:function(e,i,a){e.message.author&&t.currentUser.jid==e.message.author.jid&&(e.selfMessage=!0),e.getMessageAge=function(){return moment(e.message.created).fromNow()},e.redirectTo=function(e,t){switch(e){case"person":s.go("person",{id:t.loginId||t.elementId});break;case"ticket":s.go(t.type,{id:t.id});break;case"asset":s.go("asset",{assetId:t.reconciliationId,assetClassId:t.classId})}},e.inviteUser=function(e,n){t.inviteUserToChat(e,n)},e.tools=function(e,n,i){i||(i=_.find(t.activeChatRooms,{id:n})),i&&t.processChatMessage(e,i)},e.linkKnowledgeArticle=function(e,t,i){n.linkKnowledgeArticles(e,t,i)},e.unlinkKnowledgeArticle=function(e,t,i){n.unlinkKnowledgeArticles(e,t,i)},e.inviteUser=function(e,n){t.inviteUserToChat(e,n)},e.formatMessage=function(e,t){return e.startsWith(EntityVO.CHATOPS_DETAILS)?n.checkIfJson(e.substring(8))?EntityVO.CHATOPS_DETAILS:e:e.startsWith(EntityVO.CHATOPS_SWARM)?n.checkIfJson(e.substring(6))?EntityVO.CHATOPS_SWARM:e:e.startsWith(EntityVO.CHATOPS_INCIDENT)?n.checkIfJson(e.substring(9))?EntityVO.CHATOPS_SIMILARINCIDENTS:e:e.startsWith(EntityVO.CHATOPS_KNOWLEDGE)?n.checkIfJson(e.substring(10))?EntityVO.CHATOPS_KNOWLEDGE:e:e.startsWith(EntityVO.CHATOPS_SIMILARINCIDENTS)&&n.checkIfJson(e.substring(17))?EntityVO.CHATOPS_SIMILARINCIDENTS:e}}}}]).directive("scrollToLastItem",["$timeout",function(e){return{restrict:"A",link:function(t,n){t.$last===!0&&e(function(){var e=n.parent();e[0].scrollTop=e[0].scrollHeight})}}}])}(),function(){angular.module("myitsmApp").factory("chatModel",["$http","$timeout","$filter","$q","chatService","chatSwarm","userModel","systemAlertService","ticketModel","assetModel",function(e,t,n,i,s,a,o,r,c,l){function d(e,t){var n="connection"==t.type?"connected":"disconnected",i=t.data?t.data.connectorsJid:"",s=i==g.currentUser.jid?g.currentUser:g.cachedProfiles[i],a=e.parent?_.clone(e.parent):t.parent,o={author:s,type:"system",created:(new Date).getTime(),eventType:n,parent:a};return(new ChatMessageVO).build(o)}function u(e){console.log("Processing History: ",e);var t={requestProfiles:[],requestTickets:[],pendingTicketDetails:[]},n=[];return _.map(e,function(e){if(!(0==e.conversation.messagesCount||e.conversation.participants.length<2)){var i=e.conversation.id,s=angular.extend(e.conversation,{connection:e.connection});s.participants=_.without(s.participants,g.currentUser.jid),t[i]=(new ChatHistoryItemVO).build(s),n.push(t[i]),e.connection&&(t[i].parent=e.connection,e.connection.objectType==EntityVO.TYPE_SERVICEREQUEST||e.connection.objectType==EntityVO.TYPE_ASSET?g.fillRoomParentData(t[i],e.connection).then(function(e){t[i].parent=e}):(t.requestTickets=_.union(t.requestTickets,[{uuid:e.connection.objectId,type:e.connection.objectType}]),t.pendingTicketDetails.push(t[i]))),t.requestProfiles=_.union(t.requestProfiles,t[i].participants)}}),t.requestProfiles.length>0&&g.getUserProfileByJID(t.requestProfiles,!0).then(function(){t.requestProfiles=null,_.each(n,function(e){e.fillRoster(g.cachedProfiles)})}),t.requestTickets.length>0&&g.Client.getTicketDetailsBulk(t.requestTickets).then(function(e){t.requestTickets=null,_.each(t.pendingTicketDetails,function(t){var n=e[t.parent.objectId][0];n?t.parent=n:angular.noop(),c.cache[t.parent.objectId]=n}),t.pendingTicketDetails=[]}),{obj:t,arr:n}}function h(e){var t="";if(a.checkIfChatOpsMessage(e.body)){var n={text:e.body,created:e.sentDate};t=a.formatChatMessage(t,n,null,e.senderProfile,!0)}else if(e.body!=EntityVO.CHATOPS_SWARM&&e.body.startsWith(EntityVO.CHATOPS_SWARM)&&a.checkIfJson(e.body.substring(6)))try{for(var i=e.body.substring(6),s=JSON.parse(i),o=JSON.parse(s.participants),r=0;r<o.length;r++){var c=o[r];if(null!=e.senderProfile&&e.senderProfile.hasOwnProperty("fullName")&&c[0].fullName==e.senderProfile.fullName){o.splice(r,1);break}}for(var l=0;l<o.length;l++){var d=o[l];g.checkUserAvailability(d[0].jid);try{o[l].available=g.cachedProfiles[d[0].jid].available}catch(u){o[l].available="offline"}}s.participants=o,t=(new ChatMessageDataVO).build({created:e.sentDate,data:s,author:e.senderProfile,type:"swarmPeopleDetails",fromHistory:!0,chatWindow:null})}catch(u){t=(new ChatMessageDataVO).build({created:e.sentDate,data:[],author:e.senderProfile,type:"swarmPeopleDetails",fromHistory:!0,chatWindow:null})}else{var h={text:e.text||e.body,author:e.senderProfile,type:e.type||"chat",created:e.sentDate,eventType:e.eventType};e.parent?h.parent=e.parent:angular.noop(),t=(new ChatMessageVO).build(h)}return t}function m(e){_.each(e,function(e){var n=_.find(g.activeChatRooms,{id:e});if(n){var i=g.activeChatRooms.indexOf(n);i>=0&&t(function(){g.activeChatRooms.splice(i,1)})}})}var p,g={Client:{},connectInProgress:!1,connected:!1,cachedProfiles:{},pendingProfileRequests:{},currentUser:{available:EntityVO.CHAT_STATUS_OFFLINE},activeChatRooms:[],pendingChatRoomMessages:{}},f=[],y=[];g.openChatConnection=function(){g.connectInProgress||(g.connectInProgress=!0,o.getFullCurrentUserData().then(function(){return s.openChatConnection({userCallbacks:g.chatEventHandlers})}).then(function(e){g.Client=e,g.Client.pendingPromises.connectionState.promise.then(function(){g.currentUser=o.userFullData,g.currentUser.available=EntityVO.CHAT_STATUS_ONLINE,g.currentUser.jid||(g.currentUser.jid=Strophe.getNodeFromJid(g.Client.conn.jid)),g.connected=!0,g.Client.pendingPromises.disconnect.promise.then(function(){g.connected=!0,g.currentUser.available=EntityVO.CHAT_STATUS_ONLINE})})})["finally"](function(){g.connectInProgress=!1}))},g.getUserProfileByJID=function(e){var t=_.uniq([].concat(e));return t&&y.length>0&&(t=_.difference(t,y)),0==t.length?p:(y=angular.copy(t),p=g.Client.getUserProfileByJID(y).then(function(e){return _.each(e,function(e){g.cachedProfiles[e.jid]?angular.extend(g.cachedProfiles[e.jid],e):g.cachedProfiles[e.jid]=e}),e})["finally"](function(){y=[]}))};var v=_.debounce(function(e){var t=1==e.length?e[0]:e;return g.Client.checkPresence(t).then(function(e){var n={};return e.available?n[t]=e.available:n=e.availability,_.each(n,function(e,t){e=e.toLowerCase(),g.cachedProfiles[t]?g.cachedProfiles[t].available=e:g.cachedProfiles[t]={available:e}}),f=[],e.available||e.availability})},400);return g.checkUserAvailability=function(e){f=_.uniq(f.concat(e)),v(_.compact(f))},g.generateUserJID=function(e){if(!e)return"";var t=g.currentUser.jid,n=g.currentUser.loginId,i=t.split(n.toLowerCase()).pop();return e.toLowerCase()+i},g.updateCachedProfiles=function(e){e&&e.length&&_.each(e,function(e){e.jid&&(g.cachedProfiles[e.jid]=e)})},g.setUserAvailability=function(e){return g.currentUser.available=e,g.currentUser.manualStatus=e,g.Client.setUserPresence(e)},g.createChatRoom=function(e){var t=g.createChatWindowInstance({isOpened:!0,messages:[]});return g.activeChatRooms.push(t),g.Client.createChatRoom(e).then(function(e){var n=g.Client.conn.muc.rooms[e.name],i=g.Client.conn.jid,s=g.createChatMessageInstance({eventType:"enter",author:{jid:i},type:"system"},n.name);return t.build({id:n.name,room:n,isLoading:!1,participants:n.roster,messages:[s]}),t})["finally"](function(){t.isLoading=!1})},g.createChatWindowInstance=function(e){var t=e.room?_.find(g.activeChatRooms,{id:e.room.name}):angular.noop();if(t)return t;var n=new ChatWindowVO;return e&&n.build(e),n},g.createChatMessageInstance=function(e,t){var n,i,s,o=_.find(g.activeChatRooms,{id:t}),r=e.author,c=g.Client.conn.muc.rooms[t],l=c.nick;if(r.nick&&o)r.jid=o.participants[r.nick]?o.participants[r.nick].jid:"",r.jid||l!=r.nick||(r.jid=g.currentUser.jid);else if(r.nick&&!o){var d=c.roster?c.roster[r.nick]:angular.noop();if(!d){if(l!=r.nick)return{message:e,roomName:t,skipped:!0};d=g.currentUser}r.jid=d.jid}if(i=r.jid?r.jid.split("@")[0]:angular.noop(),n=i==g.currentUser.jid?g.currentUser:g.cachedProfiles[i],!n||n&&!n.firstName?g.getUserProfileByJID([i]).then(function(){s.author=g.cachedProfiles[i],o&&o.roster&&!o.roster[i]?o.roster[i]=s.author:angular.noop()}):o&&o.roster&&!o.roster[i]?o.roster[i]=n:angular.noop(),a.checkIfChatOpsMessage(e.text))s=a.formatChatMessage(s,e,o,n,!1);else if(e.hasOwnProperty("text")&&e.text!=EntityVO.CHATOPS_SWARM&&e.text.startsWith(EntityVO.CHATOPS_SWARM))try{var u=e.text.substring(6);if(a.checkIfJson(u)){for(var h=JSON.parse(u),m=JSON.parse(h.participants),p=0;p<m.length;p++){var f=m[p];if(null!=n&&n.hasOwnProperty("fullName")&&f[0].fullName==n.fullName){m.splice(p,1);break}}for(var y=0;y<m.length;y++){var v=m[y];g.checkUserAvailability(v[0].jid);try{m[y].available=g.cachedProfiles[v[0].jid].available}catch(C){m[y].available="offline"}}h.participants=m,s=(new ChatMessageDataVO).build({created:e.created,data:h,author:n,type:e.type||"swarmPeopleDetails",chatWindow:o})}else s=(new ChatMessageVO).build({text:e.text,author:n,chatWindow:o,type:e.type||"chat",created:e.created||"",eventType:e.eventType})}catch(C){s=(new ChatMessageDataVO).build({created:e.created,data:[],author:n,type:e.type||"swarmPeopleDetails",chatWindow:o})}else s=(new ChatMessageVO).build({text:e.text,author:n,chatWindow:o,type:e.type||"chat",created:e.created||"",eventType:e.eventType});return s},g.assignChatRoom=function(e,t){return g.Client.assignChatRoom(e,t)},g.createAssignedChatRoom=function(e,t){return g.createChatRoom(t).then(function(t){return t.parent=e,g.assignChatRoom(t.room,e)})},g.createAssignedChatRoomWithUser=function(e,t){return g.createAssignedChatRoom(t,e)},g.removeChatAssignment=function(e){return g.Client.removeChatAssignment(e)},g.inviteUserToChat=function(e,t){g.Client.inviteUserToChatRoom(e,t.room),t.roster[e.jid]||(t.roster[e.jid]=e)},g.processChatMessage=function(e,t){e==EntityVO.CHATOPS_DETAILS||e==EntityVO.CHATOPS_KNOWLEDGE||e==EntityVO.CHATOPS_SIMILARINCIDENTS||e==EntityVO.CHATOPS_SWARM||e==EntityVO.CHATOPS_TOOLS?a.processChatMessage(e,t).then(function(e){g.sendChatMessage(e,t.room)},function(e){g.sendChatMessage(EntityVO.CHATOPS_ERROR,t.room)}):g.sendChatMessage(e,t.room)},g.generateChatWindowByRoomId=function(e){return e?g.Client.joinChat(e).then(function(e){var t={room:e,roster:{},isLoading:!0},n=g.createChatWindowInstance(t),s=g.getParticipantsProfiles(n),a=g.getRoomAdditionalInfo(n);return i.all([s,a])["finally"](function(){if(n.isLoading=!1,!n.parent&&n.assignedTo){var e=c.cache[n.assignedTo.objectId];e&&(n.parent=e)}}),g.activeChatRooms.push(n),n}):i.when(1)},g.sendChatMessage=function(e,t){var n=t.client.nick;t.message(n,e,null,"groupchat")},g.getParticipantsProfiles=function(e){var n=e.room,i=[];_.each(n.roster,function(t){var n=Strophe.getNodeFromJid(t.jid),s=g.cachedProfiles[n];return n==g.currentUser.jid?void(e.roster[n]=g.currentUser):void(s&&(s.fullName||s.displayName)?e.roster[n]=g.cachedProfiles[n]:i.push(n))}),i.length>0&&g.getUserProfileByJID(i).then(function(){t(function(){_.each(i,function(t){e.roster[t]=g.cachedProfiles[t]})})})},g.getRoomAdditionalInfo=function(e){var t=e.room,n=g.pendingChatRoomMessages[e.id];return n&&(e.messages?angular.noop():e.messages=[],_.each(n,function(t){if(t.skipped)var n=g.createChatMessageInstance(t.message,t.roomName);e.messages.push(n||t)}),g.pendingChatRoomMessages[e.id]=null),e.loadingAssignments=!0,g.Client.getRoomAssignments(t).then(function(t){return t.assignmentData&&!_.isEmpty(t.assignmentData)?(e.assignedTo=t.assignmentData,g.fillRoomParentData(e,t.assignmentData)):(e.loadingAssignments=!1,i.when(1))})["catch"](function(){e.loadingAssignments=!1}),i.when(1)},g.fillRoomParentData=function(e,t){var n;return t.objectType==EntityVO.TYPE_ASSET?n=l.getAssetDetailsByID(t.objectId,t.classId).then(function(){return e.parent=l.assetDetails,l.assetDetails}):(t.chatWindow=e,n=c.getTicket(t.objectId,t.objectType).then(function(){return e&&(e.parent=c.cache[t.objectId]),c.cache[t.objectId]})),n["finally"](function(){e.loadingAssignments=!1})},g.showNotification=function(e){var t=e.inviterJID,i=g.cachedProfiles[t]||{};
if(i.fullName||i.displayName)var s=i.fullName||i.displayName,a=n("i18n")("chat.invitationMessage",s);else{var o=_.find(e.participants,function(e){var n=Strophe.getNodeFromJid(e.jid);return n==t}),c=o.nick.split("_").join(" ");a=n("i18n")("chat.invitationMessage",c)}r.success({text:a,icon:"icon-comments",clear:!0,hide:1e4,click:function(){this.isOpened=!0}.bind(e)})},g.getCurrentStateTicketData=function(e){return c.cache[e]},g.saveChatLogToTicketWorknote=function(e,t){return t.reconciliationId?g.Client.saveChatLogToTicketWorknote(e.room,t.reconciliationId,t.ticketType,t.classId):g.Client.saveChatLogToTicketWorknote(e.room,t.id,t.type)},g.openChatWindow=function(e){return e.hasOwnProperty("isOpened")&&(e.isOpened=!0),e},g.leaveRoomAndDestroyChatWindow=function(e){g.Client.destroyChatRoom(e.room),g.removeChatFromActiveList(e),g.Client.removeRoosterItemByJID(e.room.name)},g.leaveConversation=function(e){g.Client.leaveChatRoom(e.room),g.removeChatFromActiveList(e),g.Client.removeRoosterItemByJID(e.room.name)},g.removeChatFromActiveList=function(e){var t=g.activeChatRooms.indexOf(e);t>=0&&g.activeChatRooms.splice(t,1)},g.chatEventHandlers={connectionState:function(e){g.connected="connected"==e},presence:function(e,n,i){t(function(){var t=e.split("@")[0];return t==g.Client.conn.authcid&&e!=g.Client.conn.jid?void(i&&i!=g.currentUser.manualStatus&&(g.currentUser.available=n,g.currentUser.manualStatus=i,g.Client.setUserPresence(n))):void(g.cachedProfiles[t]?g.cachedProfiles[t].available=n:g.cachedProfiles[t]={available:n})})},invite:function(e){var n=e.from,s=n.split("@")[0];g.Client.joinChat(e.roomId).then(function(e){var n={room:e,roster:{},inviterJID:s,isLoading:!0},a=g.createChatWindowInstance(n),o=g.getParticipantsProfiles(a),r=g.getRoomAdditionalInfo(a);i.all([o,r])["finally"](function(){a.isLoading=!1,t(function(){g.showNotification(a),g.activeChatRooms.push(a)}),g.Client.addToRoster(e.name)})})},message:function(e,n){var i=g.createChatMessageInstance(e,n),s=i?i.chatWindow:null;return s?void t(function(){s.messages?s.messages.push(i):s.messages=[i]}):(g.pendingChatRoomMessages[n]?g.pendingChatRoomMessages[n].push(i):g.pendingChatRoomMessages[n]=[i],!0)},history:function(e,n){var i=g.createChatMessageInstance(e,n),s=i.chatWindow;s?t(function(){s.messages?s.messages.push(i):s.messages=[i]}):g.pendingChatRoomMessages[n]?g.pendingChatRoomMessages[n].push(i):g.pendingChatRoomMessages[n]=[i]},roomAutoJoin:function(e){var t={room:e,roster:{},isLoading:!0},n=g.createChatWindowInstance(t),s=g.getParticipantsProfiles(n),a=g.getRoomAdditionalInfo(n);i.all([s,a])["finally"](function(){n.isLoading=!1}),g.activeChatRooms.push(n)},roomAutoLeave:function(e){var t=n("i18n")("chat.popup.systemMessage.leaveChatRoom.self"),i=_.find(g.activeChatRooms,{id:e.name});if(window.opener&&(i.inactiveRoom=!0),i){i.inactiveRoomReason=t;var s=g.activeChatRooms.indexOf(i);s>=0&&g.activeChatRooms.splice(s,1)}return e.name},chatRoomChanges:function(e,i){if(i){var s=_.find(g.activeChatRooms,{id:e?e.name:i.data.roomId});if("connection"==i.type)s.loadingAssignments=!0,g.fillRoomParentData(s,i.data).then(function(){var e=d(s,i);t(function(){s.messages.push(e)})});else if("disconnection"==i.type){i.parent=_.clone(s.parent);var a=d(s,i);t(function(){s.messages.push(a)}),s.parent&&(s.parent=null)}else if("roster"==i.type){var o=Strophe.getBareJidFromJid(i.data.jid),c=g.createChatMessageInstance({eventType:i.data.eventType,author:{jid:o},type:"system"},i.data.roomId);s?t(function(){"enter"==i.data.eventType&&(s.participants=_.clone(s.room.roster)),s.messages?s.messages.push(c):s.messages=[c]}):g.pendingChatRoomMessages[i.data.roomId]?g.pendingChatRoomMessages[i.data.roomId].push(c):g.pendingChatRoomMessages[i.data.roomId]=[c]}else if("destroy"==i.type&&s){if(e){var l=s.roomOwner||_.find(s.participants,{affiliation:"owner"}),u=l.jid.split("@")[0],h=s.roster[u],m=h?""+(h.displayName||h.firstName+" "+h.lastName):l.nick.replace("_"," "),p=n("i18n")("chat.ownerLeave.notification",m);r.success({text:p,icon:"icon-comments",clear:!0,hide:1e4}),s.inactiveRoomReason=p}t(function(){s.inactiveRoom=!0,s.isOpened=!1;var e=g.activeChatRooms.indexOf(s);e>=0?g.activeChatRooms.splice(e,1):angular.noop(),window.opener&&window.close()})}}},rosterUpdates:function(e){var t=e.removed;t.length&&m(t)}},g.generateRosterSummary=function(e){if(e.generateRosterSummary)return e.generateRosterSummary()},g.getArchivedConversationDetails=function(e){var t=e.mucJid;return g.Client.getArchivedConversationById(e.id).then(function(e){var n,i=[];try{n=JSON.parse(e)}catch(s){n={}}if(e){var a=n.messages||[];_.each(a,function(e,n,s){if(n>0){var a=s[n-1];if(a&&(a.sentDate==e.sentDate||a.body==e.body)&&a.fromJid==e.fromJid&&a.event&&e.event)return}e.event||t==e.fromJid&&t==e.toJid?(e.type="system",e.body.indexOf("disconnection")>=0?(e.eventType="disconnected",e.parent=e.body.match(/[^{}]+(?=\})/g)):e.body.indexOf("connection")>=0?(e.eventType="connected",e.parent=e.body.match(/[^{}]+(?=\})/g)):(e.eventType="other",e.text=e.body),e.parent&&(e.parent=JSON.parse("{"+e.parent+"}"),e.parent.connectorsJid==g.currentUser.jid?e.senderProfile=g.currentUser:e.senderProfile=g.cachedProfiles[e.parent.connectorsJid])):e.fromJid!=g.currentUser.jid?e.senderProfile=g.cachedProfiles[e.fromJid]:e.senderProfile=g.currentUser;var o=h(e);e.parent&&g.fillRoomParentData(o,e.parent),i.push(o)}),i=_.sortBy(i,"created")}return i})},g.getConversationsHistory=function(e,t){var n={start:e||0,limit:t||100};return g.Client.requestConversationsHistoryForCurrentUser(n).then(function(e){return e?u(e):i.when(1)})},g}])}(),function(){angular.module("myitsmApp").factory("chatService",["chatDefaults","userModel","$q","$resource","idService","$timeout","$interval","$log",function(e,t,n,i,s,a,o,r){var c,l=i("/smartit/rest/chat/:action/:jid:subAction/:roomId",{action:"@action",jid:"@jid",subAction:"@subAction",roomId:"@roomId"},{getSocialProfileByJID:{method:"GET",params:{action:"profiles",fields:"jid,elementId,displayName,lastName,firstName,thumbnail"}},assignChatRoom:{method:"POST",params:{action:"assign"}},getRoomAssignments:{method:"GET",params:{action:"assignment"},isArray:!1,transformResponse:function(e){return!e||_.isEmpty(e)?{assignmentData:null}:{assignmentData:JSON.parse(e)}}},removeRoomAssignment:{method:"DELETE",params:{action:"removeassignment"}},saveChatLogToTicketWorknote:{method:"POST",params:{action:"save"},isArray:!1,transformResponse:function(e){return{success:!e,error:e}}},requestConversationsHistoryForCurrentUser:{method:"GET",isArray:!0,params:{action:"history",subAction:"conversations"}},getChatCredentials:{method:"GET",params:{action:"credentials"}},getTicketsBulk:{method:"POST",url:"/smartit/rest/bulkupdate/details",isArray:!0}});return c={openChatConnection:function(t){if(c.chatServerIsDisabled){var i=n.defer();return a(function(){i.reject("Chat server not installed")},100),i.promise}return _.each(e.additional_namespaces,function(e){Strophe.addNamespace(e.name,e.def)}),l.getChatCredentials().$promise.then(function(e){if(e.boshUrl)return new c.Connection(e,t);c.chatServerIsDisabled=!0;var i=n.defer();return a(function(){i.reject("Chat server not installed")},100),i.promise})},activeConnection:{},defaultOptions:e,generateFullJID:function(e,t,n){var i=n;if("undefined"==typeof i&&(i=c.defaultOptions.domain),"User"==e)return t+"@"+i;if("UserList"==e)return angular.forEach(t,function(e,n){t[n]=e+"@"+i}),t;if("ChatRoom"==e){var a=s.getRandomId();return(t?t:a)+"@"+c.activeConnection.options.conference_service_name}},runCallback:function(e,t,n){var i=c.callbacks,s=i[e];return s.apply(t,n)},resolvePromise:function(e,t){var n=c.activeConnection.pendingPromises;n[e]&&n[e].hasOwnProperty("resolve")&&(c.activeConnection.pendingPromises[e].resolve(t),delete c.activeConnection.pendingPromises[e])},listeners:{onPresence:function(e){var t=$(e),n=e.getAttribute("from")||"",i=e.getAttribute("type")||"",s=e.getElementsByTagName("x");if("subscribed"==i)return!0;if("subscribe"==i)return this.handleSubscriptionRequest(e,n);if(0==s.length){var a,o,r=Strophe.getNodeFromJid(n);if("unavailable"==i){var l=this.conn.muc.rooms;if(this.userSessions[r]=_.without(this.userSessions[r],n),_.each(l,function(e){if(e.userSessions&&e.userSessions[r]){var t=e.userSessions[r].indexOf(n);t>=0&&e.userSessions[r].splice(t,1)}}),this.userSessions[r]&&this.userSessions[r].length>0)return!0;a=EntityVO.CHAT_STATUS_OFFLINE}else{if(e.childNodes.length){var d=t.find("status"),u=t.find("show");o=d.text(),a=u.length>0?u.text():EntityVO.CHAT_STATUS_ONLINE}else a=EntityVO.CHAT_STATUS_ONLINE;r=Strophe.getNodeFromJid(n),this.userSessions[r]=_.union(this.userSessions[r],[n])}return this.options.userCallbacks.presence(n,a,o),!0}return c.listeners.onMUCPresence.apply(this,arguments),!0},onMUCPresence:function(e){var t=this,n=$(e),i=e.getAttribute("id")||"",s=e.getAttribute("from")||"",a=e.getAttribute("type")||"",o=n.find("x");return _.each(o,function(e){var n=e.getAttribute("xmlns");if(n&&n.match(Strophe.NS.MUC)){var o=s.split("/")[0],r=t.conn.muc.rooms[o];if(e.getElementsByTagName("destroy").length>0)return t.options.userCallbacks.chatRoomChanges(r,{type:"destroy",data:{roomId:o}}),!0;var l=e.getElementsByTagName("item"),d=l[0]?l[0].getAttribute("affiliation"):null,u=l[0]?l[0].getAttribute("jid"):"",h=u?Strophe.getNodeFromJid(u):null,m="unavailable"==a?"leave":"enter";if(t.pendingPromises[i]&&c.resolvePromise(i,r),"unavailable"!=a){if(r.userSessions[h]&&(!r.userSessions[h]||0!=r.userSessions[h].length))return r.userSessions[h]=_.union(r.userSessions[h],[u]),!0;r.userSessions[h]=[u]}else r.userSessions[h]&&(r.userSessions[h]=[]);u&&t.options.userCallbacks.chatRoomChanges(r,{type:"roster",data:{jid:u,eventType:m,roomId:o,affiliation:d}})}}),!0},onMessage:function(e){var t=this,n=$(e),i="[xmlns='"+Strophe.NS.INVITE+"']",s="[xmlns='"+Strophe.NS.DELAY+"']",a=n.find(i).length>0,o=n.find(s);if(y=e.getAttribute("type"),"headline"==y){var r=e.getElementsByTagName("thread"),l=e.getAttribute("from");if(r.length>0&&l!=this.conn.jid){var d=r[0].getAttribute("parent");d&&this.joinChat(d).then(function(e){t.options.userCallbacks.roomAutoJoin(e)})}}if("groupchat"==y){if(n.has("subject").length)return!0;var u,h=e.getAttribute("from").split("/"),m=h[1],p=h[0],g=this.conn.muc.rooms[p],f=n.text();if(f.indexOf("smart-it-connection")>=0||f.indexOf("smart-it-disconnection")>=0){var y=f.indexOf("smart-it-connection")>=0?"smart-it-connection":"smart-it-disconnection",v=JSON.parse(f.replace(y+":",""));return this.options.userCallbacks.chatRoomChanges(g,{type:y.split("-").pop(),data:v}),!0}if(o.length>0){var C=o[0].getAttribute("from")&&o[0].getAttribute("from").split("/")[0],b=o[0].getAttribute("stamp");u={author:{jid:C},created:b,text:n.text()}}u?angular.noop():u={author:{nick:m},text:f},this.options.userCallbacks&&this.options.userCallbacks.message(u,p)}return a&&!window.opener&&c.listeners.onInvite.apply(this,arguments),!0},onInvite:function(e){var t=$(e),n=t.find("[xmlns='"+Strophe.NS.INVITE+"']");if(!n.length)return!0;var i=Strophe.getBareJidFromJid(n[0].getAttribute("jid")),s={from:e.getAttribute("from"),roomId:i};return this.options.userCallbacks&&this.options.userCallbacks.invite(s),!0},onRosterUpdate:function(e){var t=this,n=e.getElementsByTagName("item"),i={removed:[],added:[]};return _.each(n,function(e){var n=e.getAttribute("jid"),s=e.getAttribute("subscription");if("remove"==s){i.removed.push(n);var a=t.conn.muc.rooms[n];a&&t.leaveChatRoom(a),window.opener&&window.close()}else i.added.push(n)}),this.options.userCallbacks.rosterUpdates(i),!0},onPingReceived:function(e){return this.conn.ping.pong(e),!0}},callbacks:{connectionState:function(e,t){switch(e){case Strophe.Status.CONNECTING:r.log("STROPHE CONNECTION: Initiating BOSH session");break;case Strophe.Status.AUTHENTICATING:r.log("STROPHE CONNECTION: BOSH session initiated, authenticating user");break;case Strophe.Status.CONNECTED:this.reconnecting&&(this.resendItems=_.clone(this.conn.cm.element_queue)),this.chatConnReconnectTimeOut=100,this.options.userCallbacks.connectionState("connected"),c.runCallback("connected",this,[e,t]);break;case Strophe.Status.CONNFAIL:case Strophe.Status.AUTHFAIL:case Strophe.Status.ERROR:e==Strophe.Status.AUTHFAIL&&r.log("User authorization failed"),this.pendingPromises.disconnect.resolve(e,t);break;case Strophe.Status.DISCONNECTED:if(r.log("Strophe is disconnected."),this.options.userCallbacks.connectionState("disconnected"),this.chatConnReconnectTimeOut=this.chatConnReconnectTimeOut+100,this.conn.auto_reconnect){this.chatConnReconnectTimeOut=this.chatConnReconnectTimeOut+100;var n=this;this.reconnecting=!1,a(function(){n.reconnect()},this.chatConnReconnectTimeOut)}else this.pendingPromises.disconnect.resolve(e,t)}},connected:function(){this.reconnectAttempts=0,this.conn.addHandler(c.listeners.onPresence.bind(this),null,"presence"),this.conn.addHandler(c.listeners.onMessage.bind(this),null,"message"),this.conn.addHandler(c.listeners.onRosterUpdate.bind(this),Strophe.NS.ROSTER,"iq","set"),this.conn.ping.addPingHandler(c.listeners.onPingReceived.bind(this)),this.conn.send($pres().tree()),this.reconnecting?(r.log("Strophe has reconnected successfully!"),this.resendItems&&this.resendItems.length>0&&this.resendLostStanzas(),this.reconnectInterval&&(o.cancel(this.reconnectInterval),this.reconnectInterval=null),this.reconnecting=!1):this.pendingPromises.connectionState.resolve(this),window.opener||this.getUserRoster(!0),r.log("Strophe is connected!")},requestSuccess:function(e){var t=c.activeConnection.xmlTool.xml2json(e),n=t._id,i={};return _.map(t,_.bind(function(t,n){if(n.indexOf("_")<0){var i;switch(t._xmlns){case Strophe.NS.SMARTITIQ:this.queryResponse={data:t.__text,name:t._name};break;case Strophe.NS.DISCO_ITEMS:case Strophe.NS.DISCO_INFO:var s=[].concat(t.identity||[],t.feature||[],t.item||[]);this.queryResponse={data:s,node:t._node},this.queryResponse.name=t._xmlns==Strophe.NS.DISCO_INFO?"DISCO_INFO":"DISCO_ITEM";break;case Strophe.NS.MUC_OWNER:i=t.destroy||c.activeConnection.conn.x.parseFromResult(e),this.queryResponse={data:i,name:"MUC_OWNER"};break;case Strophe.NS.MUC_ADMIN:this.queryResponse={data:t.item,name:"MUC_ADMIN"};break;case Strophe.NS.SEARCH:i=c.activeConnection.conn.x.parseFromResult(e),this.queryResponse={data:i,name:"SEARCH"};break;case Strophe.NS.ROSTER:this.queryResponse={data:t.item,name:"ROSTER"};break;case Strophe.NS.ARCHIVE:this.queryResponse={data:t,name:"ARCHIVE"}}}else t?this[n]=t:angular.noop()},i)),c.resolvePromise(n,i),!0},requestError:function(e){var t=e.getAttribute("id"),n=e.getElementsByTagName("error"),i=[];return _.each(n,function(e){var t={type:e.getAttribute("type"),code:e.getAttribute("code"),details:[]},n=e.hasChildNodes()?e.childNodes:[];_.each(n,function(e){var n={name:e.nodeName,ns:e.getAttribute("xmlns")};t.details.push(n)}),i.push(t)}),c.activeConnection.pendingPromises[t]&&(c.activeConnection.pendingPromises[t].reject(i),delete c.activeConnection.pendingPromises[t]),i}}},c.Connection=function(e,t){this.xmlTool=new X2JS({attributePrefix:""}),this.options=angular.extend(c.defaultOptions,t),this.options.domain=e.domain,this.options.conference_service_name+=this.options.domain,this.pendingPromises={connectionState:n.defer(),disconnect:n.defer()},this.conn=new Strophe.Connection(e.boshUrl),this.conn.connect(c.generateFullJID("User",e.JID)+"/"+s.getRandomId(),e.password,c.callbacks.connectionState.bind(this)),this.conn._sendIQ=this.conn.sendIQ,this.conn.sendIQ=this.sendIQDefered.bind(this),this.conn.getUniqueId=s.getRandomId,this.conn.auto_reconnect=!0,this.reconnectAttempts=0,this.maxReconnects=5,this.reconnectTimeout=1e3,this.chatConnReconnectTimeOut=100,this.userSessions={},Strophe.log=function(e,t){[Strophe.LogLevel.ERROR,Strophe.LogLevel.FATAL].indexOf(e)>=0&&r.log("STROPHE LOG: "+t)},c.activeConnection=this,this.beforeUnload=function(e){this.conn.auto_reconnect=!1,this.conn.options.sync=!0,this.conn.flush(),this.conn.disconnect("logout")},window.onbeforeunload=this.beforeUnload.bind(this)},c.Connection.prototype={detachSession:function(){if(this.conn.pause(),sessionStorage){var e={sid:this.conn.sid||this.conn._proto.sid,rid:this.conn.rid||this.conn._proto.rid,jid:this.conn.jid};sessionStorage.chatSession=JSON.stringify(e)}},reconnect:function(){return this.reconnectAttempts>=this.maxReconnects&&!this.reconnectInterval?(this.reconnectInterval=o(this.reconnectTimeout,this.reconnect()),!0):(this.conn.lastReconnect=(new Date).toISOString(),this.reconnecting||(this.reconnecting=!0,this.conn.connect(this.conn.jid,this.conn.pass,this.conn.connect_callback,this.conn.wait,this.conn.hold,this.conn.route)),void this.reconnectAttempts++)},sendIQDefered:function(){var e=s.getRandomId(),t=Array.prototype.slice.call(arguments,0),i=t[0];return"function"==typeof i.tree&&(i=i.tree()),i.setAttribute("id",e),t[1]||(t[1]=c.callbacks.requestSuccess.bind(this)),t[2]||(t[2]=c.callbacks.requestError.bind(this)),this.conn._sendIQ.apply(this.conn,t),this.pendingPromises[e]=n.defer(),this.pendingPromises[e].promise},setUserPresence:function(e){var t=$pres();switch(e.toLowerCase()){case EntityVO.CHAT_STATUS_AWAY:t.c("show").t(EntityVO.CHAT_STATUS_AWAY).up().c("status").t(EntityVO.CHAT_STATUS_AWAY);break;case EntityVO.CHAT_STATUS_OFFLINE:t=$pres({xmlns:Strophe.NS.CLIENT,type:"unavailable"}).c("status").t(EntityVO.CHAT_STATUS_OFFLINE);break;default:t.c("status").t(EntityVO.CHAT_STATUS_ONLINE)}this.conn.send(t)},getUserRoster:function(e){var t=$iq({type:"get"}).c("query",{xmlns:Strophe.NS.ROSTER}),n=this,i=e;return this.sendIQDefered(t,c.callbacks.requestSuccess,c.callbacks.requestError).then(function(e){if(e&&e.queryResponse)return i?n.processRoomsInRoster(e.queryResponse.data):angular.noop(),e.queryResponse})},addToRoster:function(e){var t=this,n=$iq({type:"set"}).c("query",{xmlns:Strophe.NS.ROSTER}).c("item",{jid:e,name:e.split("@")[0]}).c("group",{},"conversations");this.sendIQDefered(n,c.callbacks.requestSuccess,c.callbacks.requestError).then(function(){var n=$pres({to:e,type:"subscribe"});t.conn.send(n)})},removeRoosterItemByJID:function(e){var t=$iq({type:"set"}).c("query",{xmlns:Strophe.NS.ROSTER}).c("item",{jid:e,subscription:"remove"});return this.sendIQDefered(t,c.callbacks.requestSuccess,c.callbacks.requestError)},processRoomsInRoster:function(e){if(e){var t=this,n=_.filter([].concat(e),{group:"conversations"});n.forEach(function(e){var n=e._jid;n&&t.conn.disco.info(n,null,c.callbacks.requestSuccess,c.callbacks.requestError.bind(t)).then(function(e){var i,s=!!t.conn.muc.rooms[n];t.conn.lastReconnect&&(i={since:t.conn.lastReconnect}),t.joinChat(n,i).then(function(e){!s&&t.options.userCallbacks.roomAutoJoin(e)})})["catch"](function(e){t.removeRoosterItemByJID(n)})})}},handleSubscriptionRequest:function(e,t){var n=$pres({to:t.split("/")[0],from:this.conn.authzid,type:"subscribed"});return this.conn.send(n)},checkPresence:function(e){var t=e instanceof Array,n=t?"bulkPresenceRequest":"presenceRequest",i=t?JSON.stringify({jids:e}):JSON.stringify({jid:e}),s=$iq({type:"get"}).c("smart-it-iq",{xmlns:Strophe.NS.SMARTITIQ,name:n},i);return this.sendIQDefered(s,c.callbacks.requestSuccess,c.callbacks.requestError).then(function(e){var t=e.queryResponse.data;return JSON.parse(t||"{}")})},createChatRoom:function(e){var n=this,i=c.generateFullJID("ChatRoom"),s=t.userFullData.fullName.replace(/\s/g,"_")||this.conn.authcid.split("_")[0]+"_"+this.options.resource,a=e,o=this.conn.muc.createRoom(i,s);this.conn.flush();var r=this.generateRoomConfigStanza(o.name,this.options.chatroom_default_config);return this.sendIQDefered(r,c.callbacks.requestSuccess,c.callbacks.requestError).then(function(){n.notifyAllResources({type:"new_room",jid:o.name}),a&&(o.directInvite(c.generateFullJID("User",a)),n.conn.flush());var e=_.map(o.roster,"jid");return n.sendArchiveMessage(o.name,n.conn.jid,e),n.addToRoster(o.name),o})},generateRoomConfigStanza:function(e,t){var n;return n=$iq({to:e,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}),n.c("x",{xmlns:"jabber:x:data",type:"submit"}),n.c("field",{"var":"FORM_TYPE"}).c("value").t("http://jabber.org/protocol/muc#roomconfig").up().up(),_.each(t,function(e,t){n.c("field",{"var":"muc#roomconfig_"+t}).c("value").t(""+e).up().up()}),n.tree()},notifyAllResources:function(e){if("new_room"==e.type){var t=$msg({to:this.conn.authzid,type:"headline"}).c("body").t(e.type).up().c("thread",{parent:e.jid});this.conn.send(t)}},sendArchiveMessage:function(e,t,n){var i=n instanceof Array?n:[n],s={chatRoomId:e,notification:"smart-it-start:"+JSON.stringify({inviterJid:t,inviteesJids:i})},a=$iq({type:"get"}).c("smart-it-iq",{xmlns:Strophe.NS.SMARTITIQ,name:"chatRoomNotification"},JSON.stringify(s));this.sendIQDefered(a,c.callbacks.requestSuccess,c.callbacks.requestError).then(function(e){var t=e.queryResponse.data;return JSON.parse(t||"{}")})},inviteUserToChatRoom:function(e,t){t.directInvite(c.generateFullJID("User",e.jid))},joinChat:function(e,i){var a=s.getRandomId(),o=t.userFullData.fullName.replace(/\s/g,"_")||this.conn.authcid.split("_")[0]+"_"+this.options.resource;return this.pendingPromises[a]=n.defer(),this.conn.muc.join(e,o,null,null,null,null,i||null,a),this.pendingPromises[a].promise},leaveChatRoom:function(e,t){var n=$pres({to:e.name+"/"+e.nick,from:Strophe.getBareJidFromJid(this.conn.jid),type:"unavailable"}).tree();n.removeAttribute("xmlns"),this.conn.send(n)},destroyChatRoom:function(e){var t=$iq({to:e.name,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}).c("destroy").c("reason","Owner request");return this.sendIQDefered(t,c.callbacks.requestSuccess,c.callbacks.requestError).then(function(e){})["catch"](function(e){})},getUserProfileByJID:function(e){return e?l.getSocialProfileByJID({jids:JSON.stringify(e)}).$promise.then(function(e){if(e&&e.items)return e.items}):n.when(1)},assignChatRoom:function(e,t){var n=e.name.split("@")[0],i={chatRoom:n,objectType:t.type,objectId:t.id,classId:t.additionalInformation?t.additionalInformation.classId:t.classId};return l.assignChatRoom(i,null).$promise.then(function(t){return e})},getRoomAssignments:function(e){var t=Strophe.getNodeFromJid(e.name);return l.getRoomAssignments({jid:t}).$promise},removeChatAssignment:function(e){var t=Strophe.getNodeFromJid(e.name);return l.removeRoomAssignment({jid:t}).$promise},saveChatLogToTicketWorknote:function(e,t,n){var i=Strophe.getNodeFromJid(e.name);return l.saveChatLogToTicketWorknote({jid:i},null).$promise},requestConversationsHistoryForCurrentUser:function(e){return l.requestConversationsHistoryForCurrentUser(e).$promise},getArchivedConversationById:function(e){var t={conversationId:e},n=$iq({type:"get"}).c("smart-it-iq",{xmlns:Strophe.NS.SMARTITIQ,name:"archiveMessagesRequest"},JSON.stringify(t));return this.sendIQDefered(n).then(function(e){var t=e.queryResponse.data;return t})},getTicketDetailsBulk:function(e){var t={ids:e};return l.getTicketsBulk(t).$promise.then(function(e){return _.groupBy(e,"id")})},resendLostStanzas:function(){this.conn.cm.onDequeueElement=this.resolveResendPromise.bind(this),this.conn.cm.resendStanzas(this.resendItems)},resolveResendPromise:function(e){var t=e.getAttribute("id"),n=this.pendingPromises[t];n&&c.callbacks.requestSuccess.call(this,e)}},c}])}(),function(){angular.module("myitsmApp").factory("chatSwarm",["$http","$timeout","$filter","$q","relationModel","chatService","consoleService","userModel","personModel","searchService","ticketService","systemAlertService","personService","ticketModel","assetModel","utilityFunctions",function(e,t,n,i,s,a,o,r,c,l,d,u,h,m,p,g){function f(){return document.getElementsByClassName("app__pwa-iframe")&&document.getElementsByClassName("app__pwa-iframe").length?document.getElementsByClassName("app__pwa-iframe")[0].contentWindow:null}function y(){var e=f();if(e){var t=localStorage.getItem("pwaDomain"),n={eventType:"RefreshRecommendedKA",eventData:{}};g.windowPostMessage(e,n,t)}}var v={};return v.processChatMessage=function(e,t){function n(e){var t=[];return e=e.filter(function(e){return"true"===e.related&&t.push(e),"true"!==e.related}),t.concat(e)}var a=i.defer(),o="";switch(e){case EntityVO.CHATOPS_DETAILS:m.getTicket(t.parent.id,"incident").then(function(e){var n=e;n.chatWindowParentId=t.parent.id,n.chatWindowParentType=t.parent.type,o=EntityVO.CHATOPS_DETAILS+JSON.stringify(n),a.resolve(o)},function(e){o=EntityVO.CHATOPS_ERROR,a.resolve(o)});break;case EntityVO.CHATOPS_KNOWLEDGE:m.getTicket(t.parent.id,"incident").then(function(e){var i=e.summary,r={types:["knowledge"],search_text:i};l.getGlobalSearchResults(i,r).then(function(e){s.getRelations(t.parent.id,"incident").then(function(i){for(var s=e.items[0].results,o=0;o<s.length;o++)for(var r=0;r<i.length;r++){if(s[o].id==i[r].id){s[o].related="true";break}s[o].related="false"}s=n(s);var c=JSON.stringify(s),l={KA:c,chatWindowParentId:t.parent.id,chatWindowParentType:t.parent.type};e=EntityVO.CHATOPS_KNOWLEDGE+JSON.stringify(l),a.resolve(e)},function(e){o=EntityVO.CHATOPS_ERROR,a.resolve(o)})},function(e){o=EntityVO.CHATOPS_ERROR,a.resolve(o)})},function(e){o=EntityVO.CHATOPS_ERROR,a.resolve(o)});break;case EntityVO.CHATOPS_SIMILARINCIDENTS:m.getTicket(t.parent.id,"incident").then(function(e){var i=e.summary,r={types:["incident"],search_text:i};l.getGlobalSearchResults(i,r).then(function(e){s.getRelations(t.parent.id,"incident").then(function(i){for(var s=e.items[0].results,o=0;o<s.length;o++)for(var r=0;r<i.length;r++){if(s[o].id==i[r].id){s[o].related="true";break}s[o].related="false"}s=n(s);var c=JSON.stringify(s),l={incidents:c,chatWindowParentId:t.parent.id,chatWindowParentType:t.parent.type};e=EntityVO.CHATOPS_INCIDENT+JSON.stringify(l),a.resolve(e)},function(e){o=EntityVO.CHATOPS_ERROR,a.resolve(o)})},function(e){o=EntityVO.CHATOPS_ERROR,a.resolve(o)})},function(e){o=EntityVO.CHATOPS_ERROR,a.resolve(o)});break;case EntityVO.CHATOPS_SWARM:m.getTicket(t.parent.id,"incident").then(function(e){var n=e.summary,i={types:["incident"],search_text:n};l.getGlobalSearchResults(n,i).then(function(e){for(var n=e.items[0].results,i=[],s=0;s<n.length;s++)n[s].hasOwnProperty("additionalInformation")&&n[s].additionalInformation.hasOwnProperty("assignee")&&n[s].additionalInformation.assignee.hasOwnProperty("fullName")&&(i[i.length]=n[s].additionalInformation.assignee.fullName);for(var r=new Set(i),l=Array.from(r),d=[],u=0,h=function(e){if(d[u++]=e,d.length==l.length){var n={participants:JSON.stringify(d),chatWindowId:t.id};o=EntityVO.CHATOPS_SWARM+JSON.stringify(n),a.resolve(o)}},m=function(e){if(d[u++]="Not Found",d.length==l.length){var n={participants:JSON.stringify(d),chatWindowId:t.id};o=EntityVO.CHATOPS_SWARM+JSON.stringify(n),a.resolve(o)}},p=0;p<l.length;p++){var g=l[p].split(" ");c.getListOfPersonByName(g[0],g[1]).then(h,m)}},function(e){o=EntityVO.CHATOPS_ERROR,a.resolve(o)})},function(e){o=EntityVO.CHATOPS_ERROR,a.resolve(o)});break;case EntityVO.CHATOPS_TOOLS:var r={chatWindowId:t.id};o=EntityVO.CHATOPS_TOOLS+JSON.stringify(r),a.resolve(o);break;default:o=e,a.resolve(o)}return a.promise},v.linkKnowledgeArticles=function(e,t,n){var a=i.defer(),o={uuid:n,type:"incident"},r=[{id:e,relationshipType:"relatedto",tag:"resource",type:t}];return s.addRelation(o,r).then(function(e){y()},function(e){}),a.promise},v.unlinkKnowledgeArticles=function(e,t,n){var a=i.defer(),o={parentId:n,parentType:"incident"},r=[{id:e,relationshipType:"relatedto",tag:"resource",type:t}];return s.removeRelation(o,r).then(function(e){y()},function(e){}),a.promise},v.checkIfJson=function(e){if(0==e.length)return!1;try{if(JSON.parse(e),!isNaN(e))return!1}catch(t){return!1}return!0},v.checkIfChatOpsMessage=function(e){return!(null==e||!e.startsWith(EntityVO.CHATOPS_DETAILS)||!v.checkIfJson(e.substring(8)))||(!(null==e||!e.startsWith(EntityVO.CHATOPS_INCIDENTDETAILS)||!v.checkIfJson(e.substring(16)))||(!(null==e||!e.startsWith(EntityVO.CHATOPS_KNOWLEDGE)||!v.checkIfJson(e.substring(10)))||(!(null==e||!e.startsWith(EntityVO.CHATOPS_INCIDENT)||!v.checkIfJson(e.substring(9)))||(!(null==e||!e.startsWith(EntityVO.CHATOPS_LINKKNOWLEDGE)||!v.checkIfJson(e.substring(14)))||(!(null==e||!e.startsWith(EntityVO.CHATOPS_TOOLS)||!v.checkIfJson(e.substring(2)))||!(null==e||!e.startsWith(EntityVO.CHATOPS_ERROR)))))))},v.formatChatMessage=function(e,t,n,i,s){if(!t.hasOwnProperty("text")||t.text!=EntityVO.CHATOPS_DETAILS&&t.text!=EntityVO.CHATOPS_KNOWLEDGE&&t.text!=EntityVO.CHATOPS_SIMILARINCIDENTS)if(t.hasOwnProperty("text")&&t.text.startsWith(EntityVO.CHATOPS_DETAILS)){var a="incidentDetails",o=t.text.substring(8);if(v.checkIfJson(o))try{var r=JSON.parse(o);e=(new ChatMessageDataVO).build({created:t.created,data:r,author:i,type:t.type||a,chatWindow:n})}catch(c){e=(new ChatMessageVO).build({text:"",author:i,chatWindow:n,type:t.type||"error",created:t.created||"",eventType:t.eventType})}else e=(new ChatMessageVO).build({text:t.text,author:i,chatWindow:n,type:t.type||"chat",created:t.created||"",eventType:t.eventType})}else if(t.hasOwnProperty("text")&&t.text.startsWith(EntityVO.CHATOPS_KNOWLEDGE)){var l=t.text.substring(10);if(v.checkIfJson(l))try{for(var d=JSON.parse(l),u=JSON.parse(d.KA),h=0;h<u.length;h++)u[h].title=u[h].title.split("[").join(""),u[h].title=u[h].title.split("]").join("");d.KA=u,e=(new ChatMessageDataVO).build({created:t.created,data:d,author:i,type:t.type||"knowledgeResourceDetails",fromHistory:s,chatWindow:n})}catch(c){e=(new ChatMessageVO).build({text:"",author:i,chatWindow:n,type:t.type||"error",created:t.created||"",eventType:t.eventType})}else e=(new ChatMessageVO).build({text:t.text,author:i,chatWindow:n,type:t.type||"chat",created:t.created||"",eventType:t.eventType})}else if(t.hasOwnProperty("text")&&t.text.startsWith(EntityVO.CHATOPS_INCIDENT)){var m=t.text.substring(9);if(v.checkIfJson(m))try{for(var p=JSON.parse(m),g=JSON.parse(p.incidents),f=0;f<g.length;f++)g[f].title=g[f].title.split("[").join(""),g[f].title=g[f].title.split("]").join("");for(var y=0;y<g.length;y++)g[y].id==p.chatWindowParentId&&g.splice(y,1);p.incidents=g,e=(new ChatMessageDataVO).build({created:t.created,data:p,author:i,type:t.type||"similarIncidentDetails",fromHistory:s,chatWindow:n})}catch(c){e=(new ChatMessageVO).build({text:"",author:i,chatWindow:n,type:t.type||"error",created:t.created||"",eventType:t.eventType})}else e=(new ChatMessageVO).build({text:t.text,author:i,chatWindow:n,type:t.type||"chat",created:t.created||"",eventType:t.eventType})}else if(t.hasOwnProperty("text")&&t.text.startsWith(EntityVO.CHATOPS_TOOLS)){if(""!==t.text.substring(2)&&v.checkIfJson(t.text.substring(2))){var C={chatWindowId:JSON.parse(t.text.substring(2)).chatWindowId};e=(new ChatMessageDataVO).build({text:"/?",author:i,chatWindow:n,type:t.type||"tools",created:t.created||"",eventType:t.eventType,data:C,fromHistory:s})}}else t.text.startsWith(EntityVO.CHATOPS_ERROR)&&(t.text=t.text.substring(6),e=(new ChatMessageVO).build({text:"",author:i,chatWindow:n,type:t.type||"error",created:t.created||"",eventType:t.eventType}));else e=(new ChatMessageVO).build({text:t.text,author:i,chatWindow:n,type:t.type||"chat",created:t.created||"",eventType:t.eventType});return e},v}])}(),ChatWindowVO.prototype=new BaseVO,ChatWindowVO.prototype.constructor=ChatWindowVO,ChatWindowVO.prototype.getProps=function(){return["id","room","parent","inviterJID","participants","roster","messages","isOpened","isLoading"]},ChatWindowVO.prototype.postBuild=function(){this.id=this.room.name,this.room&&(this.participants=_.clone(this.room.roster),this.roomOwner=_.find(this.participants,{affiliation:"owner"}))},ChatWindowVO.prototype.getUserThumbnailForChatList=function(){if(this.conversationThumbnail){var e=this.getLastMessageInConversation(),t=this.room.nick,n=this.participants[t],i=n?n.jid.split("@")[0]:"";return e&&e.author&&e.author.thumbnail&&e.author.jid!=i&&(this.conversationThumbnail=e.author.thumbnail),this.conversationThumbnail}var s=this.roomOwner||_.find(this.room.roster,{affiliation:"owner"});if(s&&s.jid&&this.participants){var a=Strophe.getNodeFromJid(s.jid),o=this.room.client._connection.authcid;
if(a!=o)this.conversationThumbnail=this.roster[a]?this.roster[a].thumbnail:"";else{var r=_.filter(this.roster,function(e){return!(!e.thumbnail||e.jid==o)}),c=_.sample(r||[]);c&&c.jid!=o&&(this.conversationThumbnail=c.thumbnail)}}return this.conversationThumbnail},ChatWindowVO.prototype.toggleChatWindow=function(){this.isOpened=!this.isOpened},ChatWindowVO.prototype.generateConversationSummary=function(){var e,t=this,n=[],i=_.size(this.participants);if(i>1&&(_.each(this.participants,function(e){if(!e.nick||Strophe.unescapeNode(e.nick)!=t.room.nick){var i=e.jid?Strophe.getNodeFromJid(e.jid):angular.noop(),s=i&&t.roster?t.roster[i]:angular.noop();if(s)n.push(s.firstName);else{var a=e.nick?e.nick.split("_")[0]:angular.noop();a&&n.push(a)}}}),n.length>0))if(n.length<=3)e=n.join(", ");else{var s=_.sampleSize(n,3);e=s.join(", ")+" ..."}return this.parent&&(e=this.parent.ticketType&&this.parent.ticketType==EntityVO.TYPE_ASSET?(e||"")+" ("+this.parent.name+")":(e||"")+" ("+this.parent.displayId+")"),e},ChatWindowVO.prototype.getLastMessageText=function(){var e=this.getLastMessageInConversation();return e.hasOwnProperty("text")&&(e.text.startsWith(EntityVO.CHATOPS_DETAILS)||e.text.startsWith(EntityVO.CHATOPS_INCIDENTDETAILS)||e.text.startsWith(EntityVO.CHATOPS_KNOWLEDGE)||e.text.startsWith(EntityVO.CHATOPS_INCIDENT)||e.text.startsWith(EntityVO.CHATOPS_LINKKNOWLEDGE)||e.text.startsWith(EntityVO.CHATOPS_SWARM)||e.text.startsWith(EntityVO.CHATOPS_TOOLS)||e.text.startsWith(EntityVO.CHATOPS_ERROR))?"":e?e.text:""},ChatWindowVO.prototype.generateChatTopic=function(){if(this.parent){var e=[];return e=this.parent.ticketType&&this.parent.ticketType==EntityVO.TYPE_ASSET?[EntityVO.TYPE_ASSET.toUpperCase(),this.parent.name]:window.isRtl?[this.parent.summary,this.parent.displayId]:[this.parent.displayId,this.parent.summary],e.join(": ")}},ChatWindowVO.prototype.getLastMessageInConversation=function(){var e=_.findLastIndex(this.messages,{type:"chat"});return e>0?this.messages[e]:""},ChatWindowVO.prototype.getTimeSinceLastMessage=function(){var e=this.getLastMessageInConversation();if(e){var t=e.created;return moment(t).fromNow()}},ChatWindowVO.prototype.getParticipantJIDsArray=function(){var e=[];return _.each(this.room.roster,function(t){var n=Strophe.getNodeFromJid(t.jid);e.push(n)}),e},ChatWindowVO.prototype.generateRosterSummary=function(){var e=this;if(this.participants){var t,n=[],i=0;try{_.each(this.room.userSessions,function(e){e.length>0&&i++})}catch(s){i=_.size(this.participants)}if(_.each(this.participants,function(s,a){if(Strophe.unescapeNode(a)!=e.room.nick&&e.room.roster[a]){var o=s.jid.split("@")[0],r=e.roster[o]||{};t=i<=3?r.firstName?r.firstName+" "+r.lastName:a.replace("_"," "):r.firstName?r.firstName:a.split("_")[0],n.push(t)}}),n.length)return n.join(", ")}return""},function(){angular.module("myitsmApp").directive("chatWindow",["$filter","$state","personModel","chatModel","searchModel","systemAlertService","$window","userModel","$timeout",function(e,t,n,i,s,a,o,r,c){return{restrict:"AE",templateUrl:"components/chat/chat-window.html",replace:!0,scope:{chatRoom:"=",isPopupWindow:"@"},link:function(l,d){function u(e,t){var n=t||localStorage.getItem(e);try{n=JSON.parse(n)||[]}catch(i){n=[]}return n}function h(e){"app.popup.setFocusRequest"==e.key&&e.newValue==l.chatRoom.id&&(localStorage.setItem("app.popup.setFocusRequest",""),console.log("Already opened"))}var m=!!l.isPopupWindow;if(l.parentWindow=window.opener,m){var p=u("app.popup.rooms");p.push(l.chatRoom.id),localStorage["app.popup.rooms"]=JSON.stringify(p),o.document.body.style.minWidth=0,o.document.body.style.overflow="hidden",o.addEventListener("storage",h,!1),o.onbeforeunload=function(){var e=u("app.popup.rooms"),t=_.without(e,l.chatRoom.id)||[];localStorage.setItem("app.popup.rooms",JSON.stringify(t))}}else d.draggable({containment:"parent",scroll:!1,handle:".drag-handle"});l.state={searchUserFormActive:!1,searchTicketProfileActive:!1,searchInProgress:!1},l.userModel=r,l.pendingSearchPromises=[],l.chatActions={},l.searchBar={selectedItem:null},l.messageEditor={messageBody:""},l.chatRoom.roster={},l.headerText="";var g=d.find(".chat__message-editor");g.focus();var f=function(){var e={getProfileForJids:[]};_.each(l.chatRoom.participants,function(t){var n=Strophe.getNodeFromJid(t.jid);n!=i.Client.conn.authcid&&(i.cachedProfiles[n]&&i.cachedProfiles[n].firstName?l.chatRoom.roster[n]=i.cachedProfiles[n]:e.getProfileForJids.push(n))}),e.getProfileForJids.length&&i.getUserProfileByJID(e.getProfileForJids).then(function(){_.each(e.getProfileForJids,function(e){l.chatRoom.roster[e]=i.cachedProfiles[e]})})};l.$watch(function(){return l.chatRoom.participants},function(e){e&&f()}),l.$watch("searchBar.searchParam",function(e,t){e&&e!=t&&l.searchBar.handleUserQuery(),t&&!e&&(l.pendingSearchPromises=[],l.state.searchInProgress=!1,l.searchBar.resultsList=null)}),l.generateChatHeaderCaption=function(){if(l.chatRoom.generateRosterSummary)return l.chatRoom.generateRosterSummary();var t=_.toArray(l.chatRoom.roster),n=_.map(l.chatRoom.roster,function(e){return t.length<3?e.fullName||e.displayName:e.firstName});return n.length>0?n.join(", "):e("i18n")("chat.header.generic")},window.isRtl?l.chatControls=[{label:"Minimize Chat",iconClass:"glyphicon glyphicon-minus",name:"minimize",disabled:l.isPopupWindow},{label:"Popin Chat",iconClass:"icon-pop_in",name:"popinChatWindow",disabled:!l.isPopupWindow||l.parentWindow&&l.parentWindow.closed},{label:"Popout Chat",iconClass:"icon-pop_up",name:"popoutChatWindow",disabled:l.isPopupWindow},{label:"Invite User",iconClass:"icon-user_plus",name:"showSearchForm",args:"invite"},{label:"Leave Chat",iconClass:"icon-exit",name:"leaveChat"}]:l.chatControls=[{label:"Leave Chat",iconClass:"icon-exit",name:"leaveChat"},{label:"Invite User",iconClass:"icon-user_plus",name:"showSearchForm",args:"invite"},{label:"Popout Chat",iconClass:"icon-pop_up",name:"popoutChatWindow",disabled:l.isPopupWindow},{label:"Popin Chat",iconClass:"icon-pop_in",name:"popinChatWindow",disabled:!l.isPopupWindow||l.parentWindow&&l.parentWindow.closed},{label:"Minimize Chat",iconClass:"glyphicon glyphicon-minus",name:"minimize",disabled:l.isPopupWindow}],l.redirectToAsignedItem=function(){var e,n=l.chatRoom.parent;if(!n)return!1;if(n.ticketType==EntityVO.TYPE_ASSET){if(l.isPopupWindow)return e=t.href(EntityVO.TYPE_ASSET,{assetId:n.reconciliationId,assetClassId:n.classId}),void window.open(e,"_blank");t.go(EntityVO.TYPE_ASSET,{assetId:n.reconciliationId,assetClassId:n.classId})}else{if(l.isPopupWindow)return e=t.href(n.type,{id:n.id}),void window.open(e,"_blank");t.go(n.type,{id:n.id})}},l.getConditionalClasses=function(e){return i.connected||"minimize"===e.name?"showSearchForm"==e.name?l.state.searchUserFormActive?"active":angular.noop():void 0:"chat-disable-events"},l.handleChatControlsClick=function(e,t){return!l.chatRoom.inactiveRoom&&l.chatActions[t.name](t.args)},l.removeChatAssignment=function(){l.chatRoom.loadingAssignments=!0,i.removeChatAssignment(l.chatRoom.room)["finally"](function(){l.chatRoom.loadingAssignments=!1})},l.chatActions.popoutChatWindow=function(){var e=localStorage.getItem("app.popup.rooms")||"[]",t="#/chatPopupWindow";if(e.indexOf(l.chatRoom.id)>=0)return localStorage.setItem("app.popup.setFocusRequest",l.chatRoom.id),void l.chatActions.minimize();o.popupDetails={roomId:l.chatRoom.id};var n=400,i=500,s=10*Math.round(screen.width/3/10),a=Math.round(70*screen.height/100),r=_.max([i,a]),c=_.max([n,s]),d="chatPopup_"+(Strophe.getNodeFromJid(l.chatRoom.id)||"").split("-").join("_"),u="location=no, scrollbars=no, resizable=yes, width="+c+", height="+r,h=o.open(t,d,u);h.focus(),l.chatActions.minimize()},l.chatActions.popinChatWindow=function(){var e,t;if(!l.parentWindow.closed){try{e=l.parentWindow.angular.element("body").scope(),t=_.find(e.chatModel.activeChatRooms,{id:l.chatRoom.id})}catch(n){}e&&t&&(e.$apply(function(){t.isOpened=!0}),window.close())}},l.chatActions.minimize=function(){l.chatRoom.isOpened=!1},l.chatActions.leaveChat=function(){if(!l.chatRoom.isLoading){var t,n=Strophe.escapeNode(l.chatRoom.room.nick),s=l.chatRoom.participants[n].affiliation,o=e("i18n")("chat.participantLeave.modal.confirmAction.leave"),r={leave:!0};"owner"==s&&(l.chatRoom.parent?(o=e("i18n")("chat.ownerLeave.modal.confirmAction.saveLog"),r={save:!0}):(o=e("i18n")("chat.ownerLeave.modal.confirmAction.leave"),r={close:!0})),t={title:e("i18n")("chat.ownerLeave.modal.title"),text:o,buttons:[{text:e("i18n")("common.labels.leave"),data:r},{text:e("i18n")("common.button.cancel")}],isPopoutWindow:!0};var c=a.modal(t);c.result.then(function(e){if(!_.isEmpty(e)){var t=e?e.save?"saveLog":"destroyRoom":"leave";if(l.isPopupWindow){var n,s;try{n=l.parentWindow.angular.element("body").scope(),s=_.find(n.chatModel.activeChatRooms,{id:l.chatRoom.id}),n&&s&&n.$apply(function(){s.isOpened=!1,"saveLog"==t&&n.chatModel.saveChatLogToTicketWorknote(s,s.parent),"leave"!=t&&n.chatModel.leaveRoomAndDestroyChatWindow(s),"leave"==t&&n.chatModel.leaveConversation(s)})}catch(a){}window.close()}else l.chatRoom.isOpened=!1,"saveLog"==t&&i.saveChatLogToTicketWorknote(l.chatRoom,l.chatRoom.parent),"leave"!=t&&i.leaveRoomAndDestroyChatWindow(l.chatRoom),"leave"==t&&i.leaveConversation(l.chatRoom)}})}},l.chatActions.showSearchForm=function(e){l.chatRoom.isLoading||("connect"==e?(l.searchBar.clearSelection(),l.state.searchTicketProfileActive=!0,l.state.searchUserFormActive=!1):"invite"==e&&(l.state.searchUserFormActive?(l.searchBar.clearSelection(),l.state.searchUserFormActive=!1):(l.searchBar.searchParam=null,l.searchBar.clearSelection(),l.state.searchUserFormActive=!0,l.state.searchTicketProfileActive=!1,l.filteredList=[])),c(function(){try{d.find("[ng-model*='searchParam']")[0].focus()}catch(e){}},500))},l.searchBar.suggestionMouseOver=function(e){var t=l.filteredList[e];return(!l.state.searchUserFormActive||t.active==EntityVO.CHAT_STATUS_ONLINE)&&(l.searchBar.alignWithTop=null,void(l.searchBar.selectedSuggestionIndex=e))},l.searchBar.checkPressedKey=function(e){var t=e.keyCode||e.which;if(27==t&&(l.searchBar.clearSelection(),l.state.searchUserFormActive=!1,l.state.searchTicketProfileActive=!1),13==t){e.preventDefault();var n=l.filteredList[l.searchBar.selectedSuggestionIndex];if(!n||l.state.searchUserFormActive&&n.available!=EntityVO.CHAT_STATUS_ONLINE)return!1;l.searchBar.selectSuggestion(n)}if((38==t||40==t)&&(l.state.searchUserFormActive||l.state.searchTicketProfileActive&&l.filteredList&&l.searchBar.resultsList.length>0)){if(e.preventDefault(),38==t)return 0!=l.searchBar.selectedSuggestionIndex&&(l.searchBar.alignWithTop=!0,l.searchBar.selectedSuggestionIndex--,!1);if(l.searchBar.selectedSuggestionIndex==l.filteredList.length-1)return!1;var i=l.searchBar.selectedSuggestionIndex+1,s=l.filteredList[i];return(!l.state.searchUserFormActive||!s||s.available==EntityVO.CHAT_STATUS_ONLINE)&&(l.searchBar.alignWithTop=!1,l.searchBar.selectedSuggestionIndex++,!1)}return!0},l.searchBar.handleUserQuery=function(){var e=l.searchBar.searchParam;if(!l.searchBar.selectedItem)return e?void(e.length>=3?(l.searchBar.selectedSuggestionIndex=0,l.state.searchInProgress=!0,l.getSearchResultsDebounce(e)):(l.searchBar.resultsList=[],l.filteredList=[])):(l.searchBar.selectedSuggestionIndex=0,l.searchBar.resultsList=[],void(l.filteredList=[]))},l.searchBar.getSearchBarPlaceholder=function(){return l.state.searchUserFormActive?e("i18n")("chat.searchBar.userSearch.placeholder"):l.state.searchTicketProfileActive?e("i18n")("chat.searchBar.ticketProfile.placeholder"):void 0},l.searchBar.selectSuggestion=function(e){if(e.hasOwnProperty("firstName")||e.hasOwnProperty("loginId")){var t=e.available?e.available.toLowerCase():EntityVO.CHAT_STATUS_OFFLINE;if(t!=EntityVO.CHAT_STATUS_ONLINE)return}l.searchBar.selectedItem=e,l.searchBar.confirmSelection(),c(function(){try{d.find(".chat__search-bar_confirm-action")[0].focus()}catch(e){}},500)},l.searchBar.clearSelection=function(){l.searchBar.selectedItem=null,l.searchBar.searchParam="",l.searchBar.resultsList=[]},l.searchBar.confirmSelection=function(){l.state.searchUserFormActive?(l.chatRoom.roster[l.searchBar.selectedItem.jid]=l.searchBar.selectedItem,i.inviteUserToChat(l.searchBar.selectedItem,l.chatRoom),l.state.searchUserFormActive=!1):(i.assignChatRoom(l.chatRoom.room,l.searchBar.selectedItem),l.chatRoom.parent=l.searchBar.selectedItem,l.state.searchTicketProfileActive=!1),l.searchBar.clearSelection()},l.sortResults=function(e){if(l.state.searchUserFormActive){e.available?e.available=e.available.toLowerCase():e.available=EntityVO.CHAT_STATUS_OFFLINE;var t=i.Client.options.users_status_list.indexOf(e.available);return t+(e.fullName||e.firstName+" "+e.lastName)}},l.getSearchResultsDebounce=_.debounce(function(e){var t;if(l.state.searchUserFormActive)t=n.getListOfPersonByName(e).then(function(e){if(i.updateCachedProfiles(e),l.filteredList=[],l.searchBar.searchParam&&!l.searchBar.selectedItem&&l.state.searchUserFormActive){var t=l.chatRoom.getParticipantJIDsArray();l.searchBar.resultsList=_.filter(e,function(e){var n=i.currentUser.loginId==e.loginId;if(e.jid)var s=t.indexOf(e.jid)>=0;return!s&&!n})}});else{var a={types:[EntityVO.TYPE_INCIDENT,EntityVO.TYPE_WORKORDER,EntityVO.TYPE_SERVICEREQUEST,EntityVO.TYPE_TASK,EntityVO.TYPE_ASSET,EntityVO.TYPE_CHANGE,EntityVO.TYPE_KNOWNERROR,EntityVO.TYPE_PROBLEM,EntityVO.TYPE_RELEASE]};t=s.getGlobalSearchResults(e,a).then(function(){if(0!=l.pendingSearchPromises.length&&l.searchBar.searchParam&&!l.searchBar.selectedItem&&l.state.searchTicketProfileActive)if(s.globalSearchResults.totalCount>0){l.searchBar.resultsList=[];var e=s.globalSearchResults.items;_.each(e,function(e){l.searchBar.resultsList=l.searchBar.resultsList.concat(e.results)})}else l.searchBar.resultsList=[]})}l.pendingSearchPromises.push(t),t["finally"](function(){var e=l.pendingSearchPromises.indexOf(t);e>=0&&l.pendingSearchPromises.splice(e,1),0==l.pendingSearchPromises.length&&(l.state.searchInProgress=!1)})},400),l.tools=function(){i.processChatMessage(EntityVO.CHATOPS_TOOLS,l.chatRoom)},l.messageEditor.handleTyping=function(e){var t=e.which||e.keyCode;if(13==t&&!e.shiftKey&&l.messageEditor.messageBody){var n=l.messageEditor.messageBody;if(null!=l.chatRoom.parent&&"incident"==l.chatRoom.parent.type){var s=l.chatRoom;n==EntityVO.CHATOPS_DETAILS||n==EntityVO.CHATOPS_KNOWLEDGE||n==EntityVO.CHATOPS_SIMILARINCIDENTS||n==EntityVO.CHATOPS_SWARM||n==EntityVO.CHATOPS_TOOLS?i.processChatMessage(n,s):i.sendChatMessage(l.messageEditor.messageBody,l.chatRoom.room)}else i.sendChatMessage(l.messageEditor.messageBody,l.chatRoom.room);l.messageEditor.messageBody="",e.preventDefault()}},l.isChatEnabled=function(){return i.connected}}}}])}(),function(){angular.module("graphModule").directive("directedGraph",["$timeout","$window","ciExplorerModel","$interval",function(e,t,n,i){return{restrict:"AE",replace:!0,scope:{nodes:"=",edges:"=",selections:"=",servicesCount:"=",isFixed:"=",isFullScreen:"="},templateUrl:"components/graph/directed-graph-template.html",link:function(s,a){function o(){var e=cytoscape.stylesheet().selector("node[?hover]").css({content:"data(label)"}).selector("node[!hover]").css({content:"data(shortLabel)"}).selector("node").css({"background-fit":"cover","font-size":8,shape:"rectangle","background-opacity":0,"text-valign":"bottom","text-wrap":"wrap","text-max-width":80}).selector("node.selected").css({"background-fit":"cover","font-size":8,shape:"rectangle","background-opacity":0,"text-valign":"bottom"}).selector(".big-node").css({width:35,height:35}).selector(".small-node[?hover]").css({content:"data(label)"}).selector(".small-node[!hover]").css({content:"data(shortLabel)"}).selector(".small-node").css({height:20,width:20,"background-fit":"cover","font-size":5,"background-opacity":0,"text-valign":"bottom"}).selector("edge").css({width:.3,"line-color":"#666666","target-arrow-shape":"triangle","curve-style":"straight"}).selector(".group-node").css({shape:"roundrectangle"}).selector(".collapsed-node").css({content:"data(label)",color:"#2bb5dc","background-color":"#2bb5dc","background-opacity":.5,"background-image":"none","border-width":.2,"font-size":12,"text-valign":"center",height:75,width:100}).selector(".expanded-node").css({content:"","background-color":"#2bb5dc","background-opacity":.2,"background-image":"none","border-width":.2}).selector(".hidden-node").css({visibility:"hidden"}).selector(".expand-button").css({height:"30px",width:"75px"});return E?e.selector("node").css({"background-image":"styles/img/ci-type-icons/generic_ci.png"}).selector("node.selected").css({"background-image":"styles/img/ci-type-icons/generic_ci_selected.png"}).selector(".collapsed-node").css({"background-image":"none"}).selector(".expanded-node").css({"background-image":"none"}).selector(".application").css({"background-image":"styles/img/ci-type-icons/application.png"}).selector(".application-selected").css({"background-image":"styles/img/ci-type-icons/application_selected.png"}).selector(".cluster").css({"background-image":"styles/img/ci-type-icons/cluster.png"}).selector(".cluster-selected").css({"background-image":"styles/img/ci-type-icons/cluster_selected.png"}).selector(".computersystem").css({"background-image":"styles/img/ci-type-icons/computer_system.png"}).selector(".computersystem-selected").css({"background-image":"styles/img/ci-type-icons/computer_system_selected.png"}).selector(".database").css({"background-image":"styles/img/ci-type-icons/database.png"}).selector(".database-selected").css({"background-image":"styles/img/ci-type-icons/database_selected.png"}).selector(".filesystem").css({"background-image":"styles/img/ci-type-icons/file_system.png"}).selector(".filesystem-selected").css({"background-image":"styles/img/ci-type-icons/file_system_selected.png"}).selector(".group").css({"background-image":"styles/img/ci-type-icons/group.png"}).selector(".group-selected").css({"background-image":"styles/img/ci-type-icons/group_selected.png"}).selector(".media").css({"background-image":"styles/img/ci-type-icons/media.png"}).selector(".media-selected").css({"background-image":"styles/img/ci-type-icons/media_selected.png"}).selector(".network").css({"background-image":"styles/img/ci-type-icons/network.png"}).selector(".network-selected").css({"background-image":"styles/img/ci-type-icons/network_selected.png"}).selector(".people").css({"background-image":"styles/img/ci-type-icons/people.png"}).selector(".people-selected").css({"background-image":"styles/img/ci-type-icons/people_selected.png"}).selector(".resource").css({"background-image":"styles/img/ci-type-icons/resource.png"}).selector(".resource-selected").css({"background-image":"styles/img/ci-type-icons/resource_selected.png"}).selector(".service").css({"background-image":"styles/img/ci-type-icons/service.png"}).selector(".service-selected").css({"background-image":"styles/img/ci-type-icons/service_selected.png"}).selector(".software").css({"background-image":"styles/img/ci-type-icons/software.png"}).selector(".software-selected").css({"background-image":"styles/img/ci-type-icons/software_selected.png"}).selector(".ups").css({"background-image":"styles/img/ci-type-icons/ups.png"}).selector(".ups-selected").css({"background-image":"styles/img/ci-type-icons/ups_selected.png"}).selector(".collapsed-node").css({"background-image":"none"}):e.selector("node").css({"background-image":"styles/img/ci-type-icons/generic_ci.svg"}).selector("node.selected").css({"background-image":"styles/img/ci-type-icons/generic_ci_selected.svg"}).selector(".collapsed-node").css({"background-image":"none"}).selector(".expanded-node").css({"background-image":"none"}).selector(".application").css({"background-image":"styles/img/ci-type-icons/application.svg"}).selector(".application-selected").css({"background-image":"styles/img/ci-type-icons/application_selected.svg"}).selector(".cluster").css({"background-image":"styles/img/ci-type-icons/cluster.svg"}).selector(".cluster-selected").css({"background-image":"styles/img/ci-type-icons/cluster_selected.svg"}).selector(".computersystem").css({"background-image":"styles/img/ci-type-icons/computer_system.svg"}).selector(".computersystem-selected").css({"background-image":"styles/img/ci-type-icons/computer_system_selected.svg"}).selector(".database").css({"background-image":"styles/img/ci-type-icons/database.svg"}).selector(".database-selected").css({"background-image":"styles/img/ci-type-icons/database_selected.svg"}).selector(".filesystem").css({"background-image":"styles/img/ci-type-icons/file_system.svg"}).selector(".filesystem-selected").css({"background-image":"styles/img/ci-type-icons/file_system_selected.svg"}).selector(".group").css({"background-image":"styles/img/ci-type-icons/group.svg"}).selector(".group-selected").css({"background-image":"styles/img/ci-type-icons/group_selected.svg"}).selector(".media").css({"background-image":"styles/img/ci-type-icons/media.svg"}).selector(".media-selected").css({"background-image":"styles/img/ci-type-icons/media_selected.svg"}).selector(".network").css({"background-image":"styles/img/ci-type-icons/network.svg"}).selector(".network-selected").css({"background-image":"styles/img/ci-type-icons/network_selected.svg"}).selector(".people").css({"background-image":"styles/img/ci-type-icons/people.svg"}).selector(".people-selected").css({"background-image":"styles/img/ci-type-icons/people_selected.svg"}).selector(".resource").css({"background-image":"styles/img/ci-type-icons/resource.svg"}).selector(".resource-selected").css({"background-image":"styles/img/ci-type-icons/resource_selected.svg"}).selector(".service").css({"background-image":"styles/img/ci-type-icons/service.svg"}).selector(".service-selected").css({"background-image":"styles/img/ci-type-icons/service_selected.svg"}).selector(".software").css({"background-image":"styles/img/ci-type-icons/software.svg"}).selector(".software-selected").css({"background-image":"styles/img/ci-type-icons/software_selected.svg"}).selector(".ups").css({"background-image":"styles/img/ci-type-icons/ups.svg"}).selector(".ups-selected").css({"background-image":"styles/img/ci-type-icons/ups_selected.svg"}),e}function r(){s.isFixed=!s.isFixed,e(function(){s.isFullScreen=!s.isFullScreen,u(w)},k)}function c(){s.isFullScreen=!s.isFullScreen,e(function(){s.isFixed=!s.isFixed,u()},w)}function l(){d()?document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen():document.documentElement.requestFullscreen?document.documentElement.requestFullscreen():document.documentElement.msRequestFullscreen?document.documentElement.msRequestFullscreen():document.documentElement.mozRequestFullScreen?document.documentElement.mozRequestFullScreen():document.documentElement.webkitRequestFullscreen&&document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT)}function d(){return document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement}function u(t){t=t||0,e(function(){A.resize(),f()},t)}function h(e){var t=e.data("id"),n=e.incomers().filter("edge"),i=A.elements('edge[source = "'+t+'"]');n.show(),i.show(),e.descendants().remove(),e.removeClass("expanded-node").addClass("collapsed-node")}function m(e){var t=e.data("groupElements"),n=e.data("id"),i=e.incomers().filter("edge"),s=A.elements('edge[source = "'+n+'"]');i&&i.hide(),s&&s.hide(),p(t,{parent:n}),e.removeClass("collapsed-node").addClass("expanded-node")}function p(e,t){var n=t.parent,i=null===n||A.getElementById(n).length>0;if(i){var s=e.jsons(),a=e.descendants(),o=a.merge(a.add(e).connectedEdges());e.remove();for(var r=0;r<e.length;r++){var c=s[r];"nodes"===c.group&&(c.data.parent=null===n?void 0:n)}}A.add(s).merge(o&&o.restore())}function g(e){e&&e.hasClass("collapsed-node")?m(e):h(e),f()}function f(){return A.layout({name:"dagre",fit:!1,ready:function(){_.each(A.nodes(),function(e){if(!S){var t=e.position();e.position({x:t.y,y:t.x})}}),A.fit(),A.zoom()>C?A.zoom(C):A.zoom()<v&&A.zoom(v),A.center()}}).run()}var y=a.find(".directed-graph__pan"),v=.4,C=1.5,b=.2,S=!1,O=["Chrome","Safari","Firefox"],T=t.navigator.userAgent,E=!0;_.each(O,function(e){var t=new RegExp(e,"i");t.exec(T)&&(E=!1)}),_.each(s.nodes,function(e){e.data.label=n.getGraphLabel(e.data.label),e.data.shortLabel=n.getShortGraphLabel(e.data.label)});var A=s.cy=cytoscape({container:y[0],style:o(),elements:{nodes:s.nodes,edges:s.edges},layout:{name:"dagre",fit:!1},boxSelectionEnabled:!1,wheelSensitivity:.2,selectionType:"additive",zoom:1,ready:function(){e(function(){s.init(),s.$emit("impactGraphInit",{state:0}),s.state.isLoading=!1})}}),I=null;A.on("tap",function(t){var n=t.target;e(function(){I=null},300),I===n?(n.trigger("doubleTap"),I=null):I=n}),A.on("doubleTap",".group-node",function(e){g(e.target)}),A.on("select","node",function(e){for(var t=this,n=0;n<t.length;n++){var i=t[n];i.hasClass("group-node")||(i.data("icon")&&(i.removeClass(i.data("icon")),i.addClass(i.data("icon")+"-selected selected")),s.selections.push(i.data("id")))}A.boxSelectionEnabled(!1)}),A.on("unselect","node",function(e){for(var t=this,n=0;n<t.length;n++){var i=t[n];i.data("icon")&&(i.addClass(i.data("icon")),i.removeClass(i.data("icon")+"-selected selected"));var a=s.selections.indexOf(i.data("id"));s.selections.splice(a,1)}}),A.on("mouseover","node",function(e){var t=e.target;t.data("hover",!0)}),A.on("mouseout","node",function(e){var t=e.target;t.data("hover",!1)}),s.init=function(){var e,t=A.nodes().roots(),n={},i=t.outgoers().filter("edge");_.each(t,function(e){var t=e.data("id"),i=e.successors(),s=i.leaves(),a=i.difference(s).filter("node");n[t]=a.length>0}),_.each(t,function(t){t.unselectify();var s=t.data("id"),a=t.successors(),o=a.leaves(),r=a.difference(o),c=r.filter("node");if(e&&n[s]&&A.add({group:"edges",data:{source:s,target:e[0].data.id}}),c.length>0){c.addClass("small-node");var l=[];_.each(o,function(e){var n=e.data("id"),i=c.edgesWith(e);if(i.length>0){var a={group:"edges",data:{source:"groupNode__"+s,target:n}};l.push(a);var o=t.edgesWith(e).remove();r=r.difference(o)}e.addClass("big-node")}),e=[{group:"nodes",data:{id:"groupNode__"+s,groupElements:r.add(i),parentId:s,label:c.length+" CIs"},classes:"group-node collapsed-node"},{group:"edges",data:{source:s,target:"groupNode__"+s}}],t.addClass("big-node"),c.remove(),A.add(e.concat(l))}}),f()},s.state={isLoading:!0,largeData:s.nodes.length>1e3},s.switchLayoutDirection=function(){S=!S,f()};var w=250,k=10;s.toggleFullScreen=function(){l(),s.isFullScreen?c():r()};var R=i(function(){!d()&&s.isFullScreen&&c()},500);s.$on("$destroy",function(){console.log("directedGraph: unbind events"),i.cancel(R),A.removeListener("tap"),A.removeListener("doubletap"),A.removeListener("select"),A.removeListener("unselect"),A.removeListener("mouseover"),A.removeListener("mouseout"),A=null,y=null}),s.resetCanvas=function(){f()},s.changeZoomLevel=function(e){var t=A.zoom();"in"===e?t+=b:"out"===e&&(t-=b),t=Math.max(v,t),A.zoom(t)},s.enableBoxSelection=function(){A.boxSelectionEnabled(!0)},s.collapseAll=function(){var e=A.$(".group-node.expanded-node");e&&e.length>0&&(_.each(e,function(e){h(e)}),f())},s.expandAll=function(){var e=A.$(".group-node.collapsed-node");e&&e.length>0&&(_.each(e,function(e){m(e)}),f())},s.clearSelection=function(){var e=A.$(":selected");e.deselect()}}}}])}(),function(){angular.module("bmcSystemAlert").directive("systemAlertNotificator",["systemAlertService",function(e){return{restrict:"AE",replace:!0,templateUrl:"components/system-alert/system-alert-inline.html",scope:{},link:function(t){t.systemAlertService=e,t.$on("$locationChangeSuccess",function(){e.dismissAllAlerts()}),t.$watch("systemAlertService.alertStack",function(){t.displayAlerts=e.alertStack},!0)}}}])}(),function(){angular.module("bmcSystemAlert").service("idService",[function(){this.getRandomId=function e(t){return t?(0|16*Math.random()).toString(16):(""+1e7+-1e3+-4e3+-8e3+-1e11).replace(/1|0/g,e)}}]).factory("systemAlertService",["$timeout","$modal","$q","idService",function(e,t,n,i){var s={error:"icon-cross_circle",success:"icon-check_circle",info:"icon-exclamation_triangle",warning:"icon-exclamation_triangle"},a={alertStack:[],error:function(e){return e.stopHideControl||(e.hide=!1),o(angular.extend(e,{type:"error"}))},success:function(e){return o(angular.extend(e,{type:"success"}))},info:function(e){return o(angular.extend(e,{type:"info"}))},warning:function(e){return o(angular.extend(e,{type:"warning"}))},modal:function(e){var t=r(e);return t.rendered.then(function(){var e=angular.element(".modal-btn")&&angular.element(".modal-btn")[0];e.focus()}),t},dismissAlert:function(e){_.find(a.alertStack,{key:e}).dismiss()},dismissAllAlerts:function(){angular.forEach(a.alertStack,function(e){e.options.displayOnStateChange||e.dismiss()})}},o=function(t){var s={key:i.getRandomId(),options:t,result:n.defer(),close:function(e){this.result.resolve(e)},dismiss:function(e){this.result.reject(e)},click:function(){this.options.click&&angular.isFunction(this.options.click)&&(this.options.click(),this.result.resolve())}},o=s.result.promise;return o["finally"](function(){_.remove(a.alertStack,{key:s.key})}),t.text?(t.icon||(t.icon="icon-"+("success"==t.type?"check":"alert")),t.clear&&a.dismissAllAlerts(),a.alertStack.push(s),t.hide&&e(function(){s.dismiss()},t.hide),{key:s.key,result:o}):s.dismiss("Obligatory parameter title is missing.")},r=function(e){e.type||(e.type="info");var n="bmc-system-alert-modal";return e&&e.isPopoutWindow&&(n="popout-window-alert-modal"),e.icon=s[e.type],t.open({templateUrl:"components/system-alert/system-alert-modal.html",windowClass:n,backdrop:e.backdrop||"static",controller:["$scope",function(t){t.modalOptions=e}]})};return a}])}();