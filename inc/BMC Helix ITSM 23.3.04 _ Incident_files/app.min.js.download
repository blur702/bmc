"use strict";function AccessMappingVO(){}function AttachmentVO(){this.name="",this.modifiedDate="",this.size=0,this.type="",this.contentType="",this.thumbnail="",this.attachmentReference=""}function BaseVO(){this.id="",this.createDate=null}function EntityVO(){this.entityId="",this.type="",this.displayValue="",this.classId=null,this.entityLink=""}function GlobalSearchItemVO(){this.additionalInformation={},this.category="",this.desc="",this.displayId="",this.id="",this.relevancy=0,this.title="",this.type="",this.templateName="",this.visited=!1,this.subType="",this.internalUse=""}function HistoryVO(){this.type="",this.ticketType="",this.summary="",this.id="",this.displayId="",this.priority="",this.articleId="",this.title="",this.serviceName=""}function LocationVO(){this.floorMapId="",this.poi=""}function MetadataVO(){this.impacts=[],this.availableValueFields={},this.priorities=[],this.urgencies=[],this.metadatatype="",this.statuses=[],this.types=[],this.majorIncident=[],this.documentTypes=[],this.enableGainsight=!1,this.categories=[],this.resCategories=[],this.workinfoTypes=[],this.primaryCapabilities=[],this.visibilities=[],this.timings=[],this.timingReasons=[],this.changeReasons=[],this.languages=[],this.riskLevels=[],this.milestones=[],this.reportedSources=[],this.businessJustifications=[],this.ootbMapping={},this.requiredOOTBObjectName=[],this.configurationParameters={},this.investigationDrivers=[],this.collisionStatuses=[],this.rootCause={},this.viewAccesses={},this.assetTypes=[],this.currencyFields={},this.depreciated=[],this.systemConfigurations={},this.systemType=[],this.virtualSystemType=[],this.clientSensitivities=[],this.clientTypes=[],this.vip=[],this.contactTypes=[],this.consoleColumns={},this.useCognitive=!1,this.ootbFieldOptionsMapping={urgency:"urgencies",priority:"priorities",impact:"impacts",status:"statuses",serviceType:"types",changeReason:"changeReasons"},this.applyCognitiveForCategorization="No",this.callLogEventTypes=[],this.contractTerms=[],this.quickSearchHighlightedCols=[],this.removeDateRestriction=[],this.comaroundEnabled=!1,this.comaroundHostUrl=""}function OrganizationVO(){this.name="",this.attributeMap={}}function PersonVO(){this.type=EntityVO.TYPE_PERSON,this.firstName="",this.lastName="",this.fullName="",this.department="",this.email="",this.company=null,this.phone="",this.thumbnailMime="",this.thumbnail="",this.site=null,this.organization="",this.loginId="",this.personId="",this.available="",this.jid="",this.supportGroups=null}function SiteVO(){this.name="",this.region="",this.siteGroup="",this.companyName="",this.id="",this.address={}}function SLAVO(){this.parentId="",this.title="",this.goal="",this.startTime="",this.endTime="",this.measurementStatus="",this.metMissedAmount="",this.overallStopTime="",this.downStartTime="",this.upStartTime="",this.downElapsedTime="",this.upElapsedTime="",this.warningDate="",this.slaType="",this.iconClass="",this.position="",this.slaStatusClass="",this.statusColor;var e;!function(e){e[e.GREEN=1]="GREEN",e[e.ORANGE=2]="ORANGE",e[e.RED=3]="RED"}(e||(e={})),this.processIconClass=function(){switch(this.measurementStatus){case SLAVO.MEASUREMENT_STATUS_IN_PROGRESS:case SLAVO.MEASUREMENT_STATUS_WARNING:this.iconClass="circle_o";var t=Date.now();this.warningDate>t?(this.slaStatusClass="sla-icon_color-green",this.statusColor=e.GREEN):(this.slaStatusClass="sla-icon_color-orange",this.statusColor=e.ORANGE);break;case SLAVO.MEASUREMENT_STATUS_PENDING:this.iconClass="circle_o",this.downStartTime>this.endTime?(this.slaStatusClass="sla-icon_color-red",this.statusColor=e.RED):this.warningDate?(this.slaStatusClass=this.downStartTime>this.warningDate?"sla-icon_color-orange":"sla-icon_color-green",this.statusColor=this.downStartTime>this.warningDate?e.ORANGE:e.GREEN):(this.slaStatusClass="sla-icon_color-green",this.statusColor=e.GREEN);break;case SLAVO.MEASUREMENT_STATUS_MET:this.iconClass="check_circle_o",this.slaStatusClass="sla-icon_color-green",this.statusColor=e.GREEN;break;case SLAVO.MEASUREMENT_STATUS_MISSED:case SLAVO.MEASUREMENT_STATUS_MISSED_GOAL:this.iconClass="cross_circle_o",this.slaStatusClass="sla-icon_color-red",this.statusColor=e.RED;break;default:this.iconClass="circle_o",this.statusColor=e.GREEN}}}function SocialProfileVO(){this.jid="",this.elementId="",this.available="",this.deleted=!1,this.desc="",this.displayName="",this.firstName="",this.lastName="",this.tenantId="",this.profileType="",this.extraData="",this.thumbnail=""}function SupportGroupVO(){this.name="",this.organization="",this.cognitiveFlag="",this.autoRecommended=!1,this.company={}}function TicketVO(){this.priority="",this.summary="",this.desc="",this.type="",this.numAttachments="",this.status={},this.assignee=null,this.customer=null,this.serviceTargets=null,this.contact=null,this.supportGroup=null,this.customFields=null,this.dynamicFields=[],this.following=!1,this.company=null,this.accessMappings={},this.locationCompany={},this.ownerGroup={}}function AssetVO(){this.name="",this.desc="",this.company=null,this.product=null,this.reconciliationId="",this.classId="",this.assetId="",this.instanceId="",this.site={},this.status=null,this.assetExtension=null,this.thumbnail="",this.thumbnailMime="",this.type="",this.subType="",this.lifecycleDates=null,this.financial=null,this.needsReconciliation=!1,this.floor="",this.room="",this.systemRole="",this.serialNumber="",this.partNumber="",this.tagNumber="",this.supplier=null,this.manufacturer="",this.impact=null,this.urgency=null,this.priority=null,this.invoiceNumber="",this.orderId="",this.submitter=null,this.lastModifiedBy=null,this.supplier=null,this.version=null,this.owner=null,this.ticketType=EntityVO.TYPE_ASSET,this.extensionAttrs={},this.domainAttrs={},this.productAttrs={},this.accessMappings={},this.poiInfo={},this.following=!1,this.assetType="",this.customFields={},this.bcmDeviceId=null}function AssetConsoleItemVO(){this.name="",this.desc="",this.company=null,this.product=null,this.reconciliationId="",this.classId="",this.assetId="",this.instanceId="",this.site={},this.status=null,this.assetExtension=null,this.thumbnail="",this.thumbnailMime="",this.type="",this.owner="",this.ticketType=EntityVO.TYPE_ASSET,this.extensionAttrs={},this.dateAttrs={},this.domainAttrs={},this.productAttrs={},this.accessMappings={},this.poiInfo={},this.following=!1,this.serialNumber="",this.manufacturer="",this.room="",this.floor="",this.systemRole=""}function RelationItemVO(){this.desc="",this.displayId="",this.parentId="",this.relationshipType="",this.tag="",this.type="",this.templateName="",this.relationshipClassId,this.realObject={},this.visited=!1,this.subType=""}function ChatHistoryItemVO(){this.id="",this.mucJid="",this.messagesCount=0,this.connection=null,this.startDate=null,this.lastActivity=null,this.participants=[],this.roster={}}function CommentVO(){this.message="",this.author=null,this.attachmentCount=0,this.attachments=[],this.title=""}function EventVO(){this.messageId="",this.eventType="",this.labelTemplate="",this.title="",this.priority="",this.startDate=null,this.endDate=null,this.summary="",this.description="",this.classId="",this.entities=[],this.recipients=[]}function FeedItemVO(){this.type="",this.priority=0,this.isSystemGenerated="",this.attachmentCount=0,this.author=null,this.relatedObject=null,this.event=null,this.note=null,this.attachments=null,this.createDateLabel="",this.message="",this.expanded=!1,this.repliesExpanded=!1,this.title="",this.tagLine=""}function RelatedObjectVO(){this.displayId="",this.type="",this.title="",this.classId="",this.eventType="",this.showHeader=!0,this.entityLink=""}function AssessmentQuestionVO(){this.questionId="",this.text="",this.isDefault=!1,this.desirableAnswer=!1,this.weight=.01,this.actionLabel=null,this.actionType=null,this._persistence_shouldRefreshFetchGroup=!1,this.textMap={"default":""},this.isVisible=!1,this.sequenceNo=0,this.isOpen=!1,this["delete"]=!1}function KnowledgeArticleVO(){this.title="",this.isDraft=!1,this.createDate=null,this.updateDate=null,this.modifiedDate=null,this.desc="",this.likePercentage=0,this.rating="",this.useCount=0,this.notUsefulCount=0,this.viewCount=0,this.type=EntityVO.TYPE_KNOWLEDGE,this.articleId="",this.status="",this.following=!1,this.tags="",this.entityLink="",this.uuid="",this.templateId="",this.templateName="",this.version=0,this.favorite=!1,this.flagged=!1,this.articleGUID="",this.isLastVersion=!1,this.isInApproval=!1,this.attachmentLimit=0,this.internalUse=!1,this.perfAssessment=!1,this.additionalCategoriesOrganization=[],this.additionalCategoriesSite=[],this.additionalCategoriesBusinessService=[],this.additionalCategoriesCompanies=[],this.additionalCategorization=[],this.articleVisibilityGroup=[],this.categorizations=[],this.content=[],this.assignee={},this.author={},this.owner={},this.company={},this.comments=[],this.hashTags=[],this.accessMappings={},this.assigneeGroup={},this.supportGroup={},this.language="",this.autoAssign=!0,this.site={},this.businessService={},this.organization={},this.commentCount=0,this.allCompanies=[],this.allSites=[],this.allServices=[],this.allOrganizations=[],this.approvalProcessName="",this.isPasswordEnabled=!1,this.nextReviewDate=null}function KnowledgeConsoleItemVO(){this.articleId="",this.title="",this.type="",this.language="",this.version="",this.assignee="",this.owner="",this.tags="",this.favorite="",this.flagged="",this.internal="",this.service="",this.createDate="",this.modifiedDate="",this.templateName="",this.organization="",this.validateCompany=!1,this.articleModifiedDate="",this.company={},this.author={},this.assignee={},this.statusValue={},this.assignedGroup={}}function LocalizedMessageVO(){this.messageType="",this.messageId="",this.locale="",this.name="",this.value=""}function LayoutConfigurationVO(){this.id="",this.name="",this.layout="",this.panels=[]}function markNotConfigurablePanels(e){e.forEach(function(e){notConfigurablePanels.indexOf(e.name)!==-1&&(e.notConfigurable=!0)})}function markNotExpandablePanels(e){e.forEach(function(e){notExpandableSections.indexOf(e.name)!==-1&&(e.notExpandable=!0)})}function PersonAssetVO(){this.reconciliationId="",this.name="",this.desc="",this.type="",this.assetType="",this.ticketCount=0,this.selected=!1,this.receivedDate="",this.classId="",this.categories=null,this.product=null,this.entityLink="",this.assetExtension={},this.status={},this.manufacturer=""}function PersonProfileVO(){this.firstName="",this.lastName="",this.fullName="",this.department="",this.email="",this.company=null,this.phone="",this.site=null,this.organization="",this.loginId="",this.available="",this.jid="",this.cell="",this.fax="",this.jobTitle="",this.customFields=null,this.following=!1,this.type=EntityVO.TYPE_PERSON,this.isVIP=!1,this.isSupportStaff=!1,this.enabled=!1,this.introduction="",this.linkedIn="",this.twitter="",this.availableForAssignment=!1,this.deskLocation="",this.manager=null,this.costCenter="",this.openTickets=0,this.accessMappings={},this.supportGroups=[],this.personId=""}function TicketSummaryVO(){this.summary="",this.type="",this.status="",this.submitDate="",this.assignee="",this.modifiedDate="",this.isAutomatic=!1,this.subType="",this.categorizations="",this.detailedDescription="",this.priority="",this.templateGuid="",this.templateId="",this.chatSessionId="",this.reportedSource="",this.relRequestId="",this.relDwpcRequestId=""}function ServiceRequestVO(){this.type=EntityVO.TYPE_SERVICEREQUEST,this.quantity="",this.price="",this.expectedDate="",this.requiredDate="",this.isCrossLaunchRequest="",this.isCrossLaunchSubmitted="",this.crossLaunchURL="",this.crossLaunchURLDisplay="",this.crossLaunchURLCreate="",this.requestTemplateTitle="",this.requestTemplateId="",this.currency="",this.instructions="",this.ticketType=EntityVO.TYPE_SERVICEREQUEST,this.accessMappings={},this.questionDefinitions=null,this.conditionalQuestions=null,this.questionResponses=null,this.approvalSummaries=null,this.hideAttributes=null,this.isAttributeHidden={}}function SmartRecorderVO(){this.desc="",this.inputTextHtml="",this.textareaHtml="",this.previewId="",this.resolution="",this.type="",this.status=null,this.impactedService=null,this.causalCI=null,this.relatedAsset=[],this.customer=null,this.contact=null,this.assignee=null,this.template=null,this.confirmedResourceList=[],this.confirmedItems=[]}function ActivityTemplateVO(){this.name="",this.summary="",this.id="",this.type="activityTemplate",this.desc="",this.company=null,this.templateObject=null}function ChangeTemplateVO(){this.name="",this.summary="",this.id="",this.type="changeTemplate",this.desc="",this.company=null,this.templateObject=null,this.impact="",this.urgency="",this.priority="",this.riskLevel="",this.timing="",this.changeReason="",this.impactedService="",this.categorizations=[],this.allCategories=[]}function IncidentTemplateVO(){this.name="",this.type="",this.desc="",this.notes="",this.summary="",this.company=null,this.templateObject=null,this.modifiedDate=null,this.status="",this.priority="",this.assignedGroup="",this.categorizations=[],this.resCategorizations=[],this.allCategories=[],this.templateCategory="",this.createDateLabel="",this.modifiedDateLabel="",this.tier1="",this.tier2="",this.tier3=""}function ReleaseTemplateVO(){this.name="",this.summary="",this.id="",this.type="releaseTemplate",this.desc="",this.company=null,this.templateObject=null,this.releaseType="",this.impact="",this.urgency="",this.riskLevel="",this.categorizations=[]}function ServicerequestTemplateVO(){this.name="",this.type="",this.desc="",this.company=null,this.templateObject=null,this.modifiedDate=null,this.categorizations=[],this.createDateLabel="",this.modifiedDateLabel="",this.turnaroundTimeUnits="",this.turnaroundTime="",this.cost="",this.isAttributeHidden={}}function SmartRecorderTemplateVO(){this.name="",this.desc="",this.displayId="",this.type="",this.summary="",this.createDate=null,this.modifiedDate=null,this.company=null,this.templateObject=null}function TaskTemplateVO(){this.name="",this.summary="",this.type="",this.desc="",this.notes="",this.company=null,this.templateObject=null,this.modifiedDate=null,this.context="",this.priority="",this.activityType="",this.supportGroup=null,this.assignee=null,this.categorizations=null}function WorkorderTemplateVO(){this.name="",this.type="",this.desc="",this.notes="",this.summary="",this.company=null,this.templateObject=null,this.modifiedDate=null,this.status="",this.priority="",this.supportGroup="",this.managerGroup="",this.categorizations=[],this.allCategories=[],this.templateCategory="",this.createDateLabel="",this.modifiedDateLabel=""}function TicketConsoleItemVO(){this.detailedDescription="",this.type="",this.desc="",this.impact="",this.displayId="",this.parentId="",this.isEscalated=!1,this.priority="",this.productName="",this.urgency="",this.scheduledStartDate="",this.submitDate="",this.slaStatus="",this.summary="",this.modifiedDate="",this.targetDate="",this.urgency="",this.deploymentStartDate="",this.deploymentEndDate="",this.scheduledEndDate="",this.actualEndDate="",this.actualStartDate="",this.completedDate="",this.submittedBy="",this.vendorTicketNumber="",this.resolvedDate="",this.respondedDate="",this.incidentType="",this.majorIncident="",this.reportedSource="",this.taskType="",this.workOrderType="",this.changeClass="",this.changeReason="",this.riskLevel="",this.investigationDriver="",this.validateCompany=!1,this.requiredResolutionDate="",this.resolutionNote="",this.processFlowInstanceId="",this.processFlowName="",this.milestone="",this.businessJustification="",this.releaseType="",this.chatSessionId="",this.templateId="",this.templateGuid="",this.supportGroup={},this.assignee={},this.customFields={},this.customer={},this.company={},this.impactedService={},this.status={},this.serviceTargets={},this.categories={},this.categorizations={},this.vendorGroup={},this.contact={},this.owner={},this.ownerGroup={},this.requestManager={},this.requestManagerGroup={},this.changeManager={},this.changeManagerGroup={},this.problemCoordinator={},this.problemCoordinatorGroup={},this.releaseCoordinator={},this.releaseCoordinatorGroup={},this.isInApproval=!1,this.allowBulkUpdateStatus=!0,this.needsAttention=""}function ActivityVO(){this.type=EntityVO.TYPE_ACTIVITY,this.scheduledEndDate=null,this.scheduledStartDate=null,this.actualStartDate=null,this.actualEndDate=null,this.location=null,this.templateId=null,this.templateGuid=null,this.requestedBy={},this.parentId=null,this.parentGuid=null,this.parentName=null,this.parentTitle=null}function ChangeVO(){this.type=EntityVO.TYPE_CHANGE,this.crossLaunchURL="",this.icon="CRQ",this.label="Change",this.impactedService=null,this.changeReason="",this.timing="",this.timingReason="",this.manager=null,this.scheduledEndDate=null,this.scheduledStartDate=null,this.actualStartDate=null,this.actualEndDate=null,this.targetDate=null,this.earliestStartDate=null,this.riskLevel="",this.riskIsUserSpecified=null,this.impact="",this.urgency="",this.managerGroup=null,this.location=null,this.questionResponses=null,this.impactedAreas=null,this.templateId=null,this.taskPhaseId=null,this.previousStatus=null,this.requestedByCompany="",this.isPasswordEnabled=!1,this.isAutomatic=!1,this.brokerVendorName="",this.templateName="",this.parentId=null,this.leadTime=0,this.createdfromParentTemplate=null,this.copyTasks=null}function DLPVO(){this.summary="",this.company="",this.triggeredBy="",this.parentName="incident",this.parentDisplayId="",this.parentId="",this.parentSummary="",this.type="",this.eventSourceInfo="",this.policies=""}function IncidentVO(){this.type=EntityVO.TYPE_INCIDENT,this.resolvedDate=null,this.resCategorizations=null,this.impactedService=null,this.causalCI=null,this.impact="",this.urgency="",this.resolution=null,this.templateId="",this.serviceType="",this.brokerVendorName="",this.needsAttention="No",this.vendorTicketNumber="",this.templateName=""}function KnownErrorVO(){this.type=EntityVO.TYPE_KNOWNERROR,this.crossLaunchURL="",this.icon="icon-file_exclamation_o",this.label="Known Error",this.rootCause="",this.targetDate=null}function OutageVO(){this.type="",this.outageType={},this.outageTypeName="",this.scheduledEndDate=null,this.scheduledStartDate=null,this.actualStartDate=null,this.actualEndDate=null,this.affectedAsset=null}function ProblemVO(){this.type=EntityVO.TYPE_PROBLEM,this.impact="",this.urgency="",this.crossLaunchURL="",this.icon="PBI",this.label="Problem",this.investigationDriver="",this.rootCause="",this.workaround="",this.resolution="",this.location=null,this.impactedAreas=null,this.impactedService=null,this.causalCI=null,this.targetDate=null,this.coordinator=null,this.coordinatorGroup=null,this.brokerVendorName=""}function ReleaseVO(){this.type=EntityVO.TYPE_RELEASE,this.crossLaunchURL="",this.impactedService=null,this.businessJustification="",this.coordinator=null,this.coordinatorGroup=null,this.timing="",this.timingReason="",this.manager=null,this.completedDate=null,this.scheduledEndDate=null,this.scheduledStartDate=null,this.actualStartDate=null,this.actualEndDate=null,this.deploymentStartDate,this.deploymentEndDate,this.targetDate=null,this.riskLevel="",this.riskIsUserSpecified=null,this.impact="",this.urgency="",this.priority="",this.managerGroup=null,this.location=null,this.questionResponses=null,this.impactedAreas=null,this.templateId=null,this.templateGuid=null,this.templateName=null,this.taskPhaseId=null,this.previousStatus=null,this.isPasswordEnabled=!1,this.isAutomatic=!1,this.releaseType=null,this.milestone=null}function SbeRequestVO(){this.type=EntityVO.TYPE_SBEREQUEST,this.serviceName="",this.orderId="",this.serviceId="",this.description="",this.desc="",this.excerpt="",this.status={},this.quantity="",this.paymentType="",this.freeLabelText="",this.currency="",this.completedDate="",this.onceCost="",this.monthlyCost="",this.yearlyCost="",this.ticketType=EntityVO.TYPE_SBEREQUEST,this.requestedBy={},this.requestedFor={},this.canRequestAgain="",this.orderTitle="",this.modifiedDate=null,this.customFields=null,this.questionDefinitions=null,this.conditionalQuestions=null,this.answers=null,this.approvalSummaries=null,this.hideAttributes=null,this.isAttributeHidden={}}function TaskVO(){this.name="",this.parentType="",this.parentName="",this.parentDisplayId="",this.parentId="",this.parentSummary="",this.type=EntityVO.TYPE_TASK,this.scheduledEndDate=null,this.scheduledStartDate=null,this.actualStartDate=null,this.actualEndDate=null,this.isAutomatic=!1,this.subType="",this.jobID="",this.jobType="",this.jobVersion=""}function WorkOrderVO(){this.type=EntityVO.TYPE_WORKORDER,this.workorderType="",this.completedDate="",this.impactedService=null,this.manager=null,this.managerGroup=null,this.location={},this.brokerVendorName="",this.needsAttention="No",this.templateName="",this.woAutomationStatus="",this.templateName=""}function UserVO(){this.accessRestrictions=[],this.available="",this.availableForAssignment=!1,this.cell="",this.company={},this.costCenter="",this.createDate="",this.customFields={},this.department="",this.displayId="",this.email="",this.enabled=!1,this.fax="",this.firstName="",this.following=!1,this.fullName="",this.id="",this.instanceId="",this.isSupportStaff=!1,this.jid="",this.jobTitle="",this.lastName="",this.loginId="",this.manager={},this.modifiedDate="",this.openTickets=0,this.organization="",this.personId="",this.phone="",this.site={},this.supportGroups=[],this.svcProviderCompanyNames=[],this.thumbnail="",this.thumbnailMime="",this.groups=null,this.roles=null,this.entityLink=""}function ActionVO(){this.resource="",this.actionType="client",this.actionName="",this.supportedPlatforms=["web"],this.url="",this.labels={"default":""},this.sequenceNo=0,this.scope={},this.subActions,this.target="new",this.mode="both",this.isOpen=!1,this["delete"]=!1,this.screenId="",this.templateId="",this.actionOrder="",this.mappings=[],this.isExpression=!1,this.expressions=null,this.mappedFields=[],this.entryId=null,this.formName=null,this.isSynchronous=!1}function ApplicationConfigurationVO(){this.id="",this.name="",this.version="",this.tenantId="",this.screens=[]}function FieldVO(){this.name="",this.label="",this.arFieldName="",this.type="",this.dataType="",this.required=!1,this.requiredCondition="",this.requiredConditionFlag=!1,this.itsmRequired=!1,this.itsmEditable=!0,this.editable=!0,this.readOnly=!1,this.readOnlyCondition="",this.readOnlyConditionFlag=!1,this.hide=!1,this.hideCondition="",this.hideConditionFlag=!1,this.setValueCondition="",this.setValueConditionFlag=!1,this.displayOrder=0,this.order=0,this.columnIndex=0,this.hideLabel=!1,this.accessible=!0,this.min=0,this.max=0,this.maxLength=0,this.precision=0,this.availability=0,this.menu=null,this.dependency=[],this.fieldUnavailableOn=[],this.valueField=null,this.members=[],this.options=[],this.groupMember=!1,this.rowCount=0,this.expanded=!1,this.sealed=!1,this.hasValue=!1,this.isDynamic=!1,this.widgetMember=!1,this.value=null,this.previousValue=null,this.extension=[],this.isRequired=!1,this.isReadOnly=!1,this.isHidden=!1,this.isMapped=!1,this.selectionDisabled=!1,this.mappedAction=null,this.selectedIcon="",this.setValueFlag="#$#"}function GalileoFieldVO(){}function GalileoFieldV2VO(){}function PanelVO(){this.name="",this.type="",this.columnCount=0,this.fields=[],this.parentScreenId=null,this.parentScreenTitle="",this.parentScreenName="",this.shortId="",this.dataSource="",this.addedFields=[],this.removedFields=[],this.sectionName="",this.addFieldAllowed=!0}function processGroupFields(e){var t=_.filter(e,function(e){return e.isGroupField()});_.forEach(t,function(t){t.members=_.sortBy(_.map(t.members,function(t){var a=_.find(e,{name:t.name});return a&&(a.current=t),a||(new FieldVO).build(t)}),"displayOrder")})}function ScreenConfigurationVO(){this.id="",this.name="",this.title="",this.datasource="",this.panels=[],this.opened=!1,this.hoveredPanelId=""}!function(){angular.module("myitsmApp",["ui.router","ui.map","ui.bootstrap","ui.bootstrap-custom","colorpicker.module","ngResource","ngCookies","ngSanitize","ngGrid","ngCkeditor","nvd3ChartDirectives","LocalStorageModule","securityModule","adminModule","userModule","feedModule","dashboardModule","chartModule","ticketModule","searchModule","i18nModule","l10nModule","resourceModule","serviceRequestModule","bmcSystemAlert","personModule","assetModule","createTicketModule","knowledgeArticleModule","knowledgeTeamModule","smartRecorderModule","graphModule","feedModule","templateModule","srdModule","locationModule","changeModule","releaseModule","headerNavigationModule","consoleModule","createProblemModule","mcsmModule","layoutConfigModule","customWidgetsModule","dibari.angular-ellipsis","pwa","innovationStudio","liveChatModule","calendarModule"]).constant("DOCSLINK",{VERSION:"Smart IT 23.3.04",CUSTOM_FIELDS:"https://docs.bmc.com/docs/display/smartIT233/Adding+custom+fields+to+your+views+using+Smart+IT",EXPRESSION:"https://docs.bmc.com/docs/display/smartIT233/Configuration+details+of+expression"}),angular.module("i18nModule",[]),angular.module("l10nModule",[]),angular.module("securityModule",[]),angular.module("adminModule",["ui.sortable"]),angular.module("dashboardModule",[]),angular.module("chartModule",[]),angular.module("userModule",[]),angular.module("feedModule",[]),angular.module("ticketModule",[]),angular.module("searchModule",[]),angular.module("resourceModule",[]),angular.module("serviceRequestModule",[]),angular.module("personModule",[]),angular.module("graphModule",[]),angular.module("assetModule",[]),angular.module("bmcSystemAlert",["ui.bootstrap"]),angular.module("createTicketModule",[]),angular.module("knowledgeArticleModule",[]),angular.module("knowledgeTeamModule",[]),angular.module("smartRecorderModule",[]),angular.module("feedModule",[]),angular.module("templateModule",[]),angular.module("srdModule",[]),angular.module("locationModule",[]),angular.module("changeModule",["daypilot"]),angular.module("releaseModule",[]),angular.module("headerNavigationModule",[]),angular.module("consoleModule",[]),angular.module("createProblemModule",[]),angular.module("mcsmModule",[]),angular.module("layoutConfigModule",[]),angular.module("customWidgetsModule",[]),angular.module("pwa",[]),angular.module("innovationStudio",[]),angular.module("liveChatModule",[]),angular.module("calendarModule",[]),angular.module("myitsmApp").config(["$stateProvider","$qProvider","$locationProvider","$urlRouterProvider","roles","$provide","$logProvider","topicLoggerProvider","queryStringParser",function(e,t,a,n,i,o,r,s,l){function c(e,t,a){return a.authPromise.then(function(){return e.getMetadataByType("global").then(function(e){var a="T"===e.configurationParameters["Enable-Progressive-Views"]||"true"===e.configurationParameters["Enable-Progressive-Views"];a="T"!==localStorage.getItem("overridePV")&&a,e.comaroundEnabled===!0&&a&&localStorage.getItem("midtierUrl")?t.go("dashboard",{},{location:"replace"}):console.info("Either Comaround or PV not enabled or invalid midtierUrl")})["catch"](function(e){console.info(e.data.error)})})["finally"](function(){a.authPromise=null})}function d(e,t,a,n){e.isMobile&&($rootScope.authPromise||($rootScope.authPromise=a.isAuthenticated()?n.when(1):a.checkSessionStatus()),$rootScope.authPromise.then(function(){a.isAuthenticated()&&t.go("ticketConsole",{},{location:"replace"})}))}t.errorOnUnhandledRejections(!1),a.hashPrefix("");var u,p=window.location.search;"/"===p.charAt(p.length-1)&&(p=p.substring(0,p.length-1)),u=l.parse(p),r.debugEnabled("2"===u.debug),u.debug&&u.debugTopic&&u.debugTopic.split(",").forEach(function(e){s.addTopic(e)},this),o.value("$logProvider",r),o.value("topicLoggerProvider",s),n.otherwise("/"),e.state("unauthorized",{url:"/unauthorized",templateUrl:"views/unauthorized.html",access:[],controller:["$scope","permissionModel",function(e,t){e.isAdminOnlyPersona=t.hasAdminOnlyRole()}]}).state("dashboard",{url:"^/",templateUrl:"views/dashboard/index.html",controller:"DashboardController",data:{pageTitle:"header.navigation.dashboard"},access:[i.ITSM_AGENT_ROLE,i.ITSM_CHANGE_USER_ROLE,i.ITSM_KNOWLEDGE_USER_ROLE,i.ITSM_PROBLEM_USER_ROLE,i.ITSM_ASSET_USER_ROLE],resolve:{isMobileDevice:["browser","$state","authModel","$q",d]}}).state("calendar",{url:"/calendar",controller:"CalendarController",template:'<div loading-spinner if="dataLoading" centered="true" overlay="true"></div><iframe ng-if="ccsEnabledForCalendar" src="/smartit/app-pwa/#/calendar" class="app__calendar-iframe" frameborder="0" width="100%"></iframe><div class="unauthorized" ng-if="!ccsEnabledForCalendar"><h4>{{"error" | i18n}}</h4><p>{{"error.unauthorized" | i18n}}</p><a href="" ui-sref="dashboard">{{"error.click.return.home"|i18n}}</a></div>',data:{pageTitle:"header.navigation.calendar"},access:[i.ITSM_CHANGE_USER_ROLE,i.ITSM_RELEASE_USER_ROLE,i.ITSM_AGENT_ROLE,i.ITSM_PROBLEM_USER_ROLE,i.ITSM_ASSET_USER_ROLE]}).state("ticketConsole",{url:"/ticket-console",template:'<console class="ticket-console" console-type="ticket" default-filters="" default-criteria="" display-metric="true" display-filter="true"></console>',params:{refreshMetadata:!1},data:{pageTitle:"header.navigation.ticketConsole"},access:[i.ITSM_AGENT_ROLE,i.ITSM_CHANGE_USER_ROLE,i.ITSM_PROBLEM_USER_ROLE]}).state("knowledgeConsole",{url:"/knowledge-console",template:'<console class="ticket-console" console-type="knowledge" default-filters="" default-criteria="" display-metric="true" display-filter="true"></console>',access:[i.ITSM_KNOWLEDGE_USER_ROLE],data:{pageTitle:"header.navigation.knowledgeConsole"},resolve:{comaroundEnable:["metadataModel","$state","$rootScope",c]}}).state("assetConsole",{url:"/asset-console",template:'<console class="ticket-console" console-type="asset" default-filters="" default-criteria="" display-metric="false" display-filter="true"></console>',access:[i.ITSM_ASSET_USER_ROLE],data:{pageTitle:"header.navigation.assetConsole"}}).state("knowledge",{url:"/knowledge/:id",templateUrl:"views/knowledge-article/knowledge-article-profile.html",controller:"KnowledgeArticleProfileController",params:{id:null,editMode:!1,content:null,preventIncrement:null,assessMode:!1},data:{pageTitle:"header.navigation.knowledge"},access:[i.ITSM_AGENT_ROLE,i.ITSM_CHANGE_USER_ROLE,i.ITSM_KNOWLEDGE_USER_ROLE,i.ITSM_PROBLEM_USER_ROLE,i.ITSM_ASSET_USER_ROLE],resolve:{comaroundEnable:["metadataModel","$state","$rootScope",c]}}).state("knowledgePreview",{url:"/knowledgePreview/:id",templateUrl:"views/knowledge-article/knowledge-article-details.html",controller:"KnowledgeArticleController",access:[]}).state("requestPreview",{url:"/requestPreview/:id",templateUrl:"views/ticket/service-request-details.html",controller:"TicketController",access:[]}).state("sberequestPreview",{url:"/sberequestPreview/:id",templateUrl:"views/ticket/sbe-request-details.html",controller:"TicketController",access:[]}).state("knowledgeLatest",{url:"/knowledge/:version/:id",templateUrl:"views/knowledge-article/knowledge-article-profile.html",controller:"KnowledgeArticleProfileController",access:[i.ITSM_AGENT_ROLE,i.ITSM_CHANGE_USER_ROLE,i.ITSM_KNOWLEDGE_USER_ROLE,i.ITSM_PROBLEM_USER_ROLE,i.ITSM_ASSET_USER_ROLE],data:{pageTitle:"header.navigation.knowledge"},resolve:{comaroundEnable:["metadataModel","$state","$rootScope",c]}}).state("knowledgeNewTab",{url:"/knowledge-new-tab/:id?preventIncrement",template:"",controller:"KnowledgeNewTabController",access:[i.ITSM_AGENT_ROLE,i.ITSM_CHANGE_USER_ROLE,i.ITSM_KNOWLEDGE_USER_ROLE,i.ITSM_PROBLEM_USER_ROLE,i.ITSM_ASSET_USER_ROLE],data:{pageTitle:"header.navigation.knowledge"},resolve:{comaroundEnable:["metadataModel","$state","$rootScope",c]}}).state("search",{url:"/search/{searchText:.*}",templateUrl:"views/search/search-content.html",controller:"SearchController",params:{searchCriteria:null,isNewSearch:null},access:[i.ITSM_AGENT_ROLE,i.ITSM_CHANGE_USER_ROLE,i.ITSM_KNOWLEDGE_USER_ROLE,i.ITSM_PROBLEM_USER_ROLE,i.ITSM_ASSET_USER_ROLE],data:{pageTitle:"common.placeholder.search"}}).state("search.task",{template:'<div preview-task="{{selectedItem.id}}" class="full-height" is-full-version="false"></div>',
access:[]}).state("search.taskPV",{params:{guid:null,displayId:null},controller:"PwaTicketController",templateProvider:["$stateParams","$state",function(e,t){var a=localStorage.getItem("midtierUrl"),n=localStorage.getItem("homeServer"),i=e.guid,o="Task",r="SV_View";if(a){var s;return s=n?a+"/pwa/#/forms/"+n+"/SHR:SV_TicketDisplay/SV_TicketDisplay?origin="+window.location.origin+"&targetForm="+o+"&targetView="+r+"&targetId="+i+"&mode=GET&context=PREVIEW":a+"/pwa/#/goto/SHR:SV_TicketDisplay/SV_TicketDisplay?origin="+window.location.origin+"&targetForm="+o+"&targetView="+r+"&targetId="+i+"&mode=GET&context=PREVIEW",'<div loading-spinner if="dataLoading" centered="true" overlay="true"></div><iframe src="'+s+'" frameborder="0" width="100%" height="100%"></iframe><div class="unauthorized" ng-if="!ccsEnabledForPWA"><h4>{{"error" | i18n}}</h4><p>{{"error.unauthorized" | i18n}}</p><a href="" ui-sref="dashboard">{{"error.click.return.home"|i18n}}</a></div>'}}],access:[]}).state("search.knowledge",{template:'<div preview-knowledge-article="{{selectedItem.id}}" selected-item="selectedItem" class="full-height" is-full-version="false"></div>',access:[]}).state("search.asset",{template:'<div preview-asset={{assetIdsObject}} display-menu="true" class="full-height" is-full-version="false"></div>',access:[]}).state("search.assetPV",{params:{guid:null,displayId:null},controller:"PwaTicketController",templateProvider:["$stateParams","$state",function(e,t){var a=localStorage.getItem("midtierUrl"),n=localStorage.getItem("homeServer"),i=e.guid,o="Configuration Item",r="SV_View";if(a){var s;return s=n?a+"/pwa/#/forms/"+n+"/SHR:SV_TicketDisplay/SV_TicketDisplay?origin="+window.location.origin+"&targetForm="+o+"&targetView="+r+"&targetId="+i+"&mode=GET&context=PREVIEW":a+"/pwa/#/goto/SHR:SV_TicketDisplay/SV_TicketDisplay?origin="+window.location.origin+"&targetForm="+o+"&targetView="+r+"&targetId="+i+"&mode=GET&context=PREVIEW",'<div loading-spinner if="dataLoading" centered="true" overlay="true"></div><iframe src="'+s+'" frameborder="0" width="100%" height="100%"></iframe><div class="unauthorized" ng-if="!ccsEnabledForPWA"><h4>{{"error" | i18n}}</h4><p>{{"error.unauthorized" | i18n}}</p><a href="" ui-sref="dashboard">{{"error.click.return.home"|i18n}}</a></div>'}}],access:[]}).state("search.person",{template:'<div preview-person="{{selectedItem.id}}" display-menu="false" class="full-height" is-full-version="false"></div>',access:[]}).state("search.personPV",{access:[],controller:"PwaTicketController",params:{guid:null,displayId:null},templateProvider:["$stateParams","$state",function(e,t){var a=localStorage.getItem("midtierUrl"),n=localStorage.getItem("homeServer"),i=e.guid,o="People",r="SV_View";if(a){var s;return s=n?a+"/pwa/#/forms/"+n+"/SHR:SV_TicketDisplay/SV_TicketDisplay?origin="+window.location.origin+"&targetForm="+o+"&targetView="+r+"&targetId="+i+"&mode=GET&context=PREVIEW":a+"/pwa/#/goto/SHR:SV_TicketDisplay/SV_TicketDisplay?origin="+window.location.origin+"&targetForm="+o+"&targetView="+r+"&targetId="+i+"&mode=GET&context=PREVIEW",'<div loading-spinner if="dataLoading" centered="true" overlay="true"></div><iframe src="'+s+'" frameborder="0" width="100%" height="100%"></iframe><div class="unauthorized" ng-if="!ccsEnabledForPWA"><h4>{{"error" | i18n}}</h4><p>{{"error.unauthorized" | i18n}}</p><a href="" ui-sref="dashboard">{{"error.click.return.home"|i18n}}</a></div>'}}]}).state("search.workorder",{template:'<div preview-work-order="{{selectedItem.id}}" class="full-height" is-full-version="false"></div>',access:[]}).state("search.workorderPV",{params:{guid:null,displayId:null},controller:"PwaTicketController",templateProvider:["$stateParams","$state",function(e,t){var a=localStorage.getItem("midtierUrl"),n=localStorage.getItem("homeServer"),i=e.guid,o="Work Order",r="SV_View";if(a){var s;return s=n?a+"/pwa/#/forms/"+n+"/SHR:SV_TicketDisplay/SV_TicketDisplay?origin="+window.location.origin+"&targetForm="+o+"&targetView="+r+"&targetId="+i+"&mode=GET&context=PREVIEW":a+"/pwa/#/goto/SHR:SV_TicketDisplay/SV_TicketDisplay?origin="+window.location.origin+"&targetForm="+o+"&targetView="+r+"&targetId="+i+"&mode=GET&context=PREVIEW",'<div loading-spinner if="dataLoading" centered="true" overlay="true"></div><iframe src="'+s+'" frameborder="0" width="100%" height="100%"></iframe><div class="unauthorized" ng-if="!ccsEnabledForPWA"><h4>{{"error" | i18n}}</h4><p>{{"error.unauthorized" | i18n}}</p><a href="" ui-sref="dashboard">{{"error.click.return.home"|i18n}}</a></div>'}}],access:[]}).state("search.incidentPV",{params:{guid:null,displayId:null},controller:"PwaTicketController",templateProvider:["$stateParams","$state",function(e,t){var a=localStorage.getItem("midtierUrl"),n=localStorage.getItem("homeServer"),i=e.guid,o="Incident",r="SV_View";if(a){var s;return s=n?a+"/pwa/#/forms/"+n+"/SHR:SV_TicketDisplay/SV_TicketDisplay?origin="+window.location.origin+"&targetForm="+o+"&targetView="+r+"&targetId="+i+"&mode=GET&context=PREVIEW":a+"/pwa/#/goto/SHR:SV_TicketDisplay/SV_TicketDisplay?origin="+window.location.origin+"&targetForm="+o+"&targetView="+r+"&targetId="+i+"&mode=GET&context=PREVIEW",'<div loading-spinner if="dataLoading" centered="true" overlay="true"></div><iframe src="'+s+'" frameborder="0" width="100%" height="100%"></iframe><div class="unauthorized" ng-if="!ccsEnabledForPWA"><h4>{{"error" | i18n}}</h4><p>{{"error.unauthorized" | i18n}}</p><a href="" ui-sref="dashboard">{{"error.click.return.home"|i18n}}</a></div>'}}],access:[]}).state("search.releasePV",{params:{guid:null,displayId:null},controller:"PwaTicketController",templateProvider:["$stateParams","$state",function(e,t){var a=localStorage.getItem("midtierUrl"),n=localStorage.getItem("homeServer"),i=e.guid,o="Release",r="SV_View";if(a){var s;return s=n?a+"/pwa/#/forms/"+n+"/SHR:SV_TicketDisplay/SV_TicketDisplay?origin="+window.location.origin+"&targetForm="+o+"&targetView="+r+"&targetId="+i+"&mode=GET&context=PREVIEW":a+"/pwa/#/goto/SHR:SV_TicketDisplay/SV_TicketDisplay?origin="+window.location.origin+"&targetForm="+o+"&targetView="+r+"&targetId="+i+"&mode=GET&context=PREVIEW",'<div loading-spinner if="dataLoading" centered="true" overlay="true"></div><iframe src="'+s+'" frameborder="0" width="100%" height="100%"></iframe><div class="unauthorized" ng-if="!ccsEnabledForPWA"><h4>{{"error" | i18n}}</h4><p>{{"error.unauthorized" | i18n}}</p><a href="" ui-sref="dashboard">{{"error.click.return.home"|i18n}}</a></div>'}}],access:[]}).state("search.changePV",{params:{guid:null,displayId:null},controller:"PwaTicketController",templateProvider:["$stateParams","$state",function(e,t){var a=localStorage.getItem("midtierUrl"),n=localStorage.getItem("homeServer"),i=e.guid,o="Infrastructure Change",r="SV_View";if(a){var s;return s=n?a+"/pwa/#/forms/"+n+"/SHR:SV_TicketDisplay/SV_TicketDisplay?origin="+window.location.origin+"&targetForm="+o+"&targetView="+r+"&targetId="+i+"&mode=GET&context=PREVIEW":a+"/pwa/#/goto/SHR:SV_TicketDisplay/SV_TicketDisplay?origin="+window.location.origin+"&targetForm="+o+"&targetView="+r+"&targetId="+i+"&mode=GET&context=PREVIEW",'<div loading-spinner if="dataLoading" centered="true" overlay="true"></div><iframe src="'+s+'" frameborder="0" width="100%" height="100%"></iframe><div class="unauthorized" ng-if="!ccsEnabledForPWA"><h4>{{"error" | i18n}}</h4><p>{{"error.unauthorized" | i18n}}</p><a href="" ui-sref="dashboard">{{"error.click.return.home"|i18n}}</a></div>'}}],access:[]}).state("search.request",{template:'<div preview-service-request="{{selectedItem.id}}" class="full-height" is-full-version="false"></div>',access:[]}).state("search.sberequest",{template:'<div preview-sbe-request="{{selectedItem.id}}" class="full-height" is-full-version="false"></div>',access:[]}).state("search.incident",{template:'<div preview-incident="{{selectedItem.id}}" class="full-height" is-full-version="false"></div>',access:[]}).state("search.change",{template:'<div preview-change-request="{{selectedItem.id}}" class="full-height" is-full-version="false"></div>',access:[]}).state("search.release",{template:'<div preview-release="{{selectedItem.id}}" class="full-height" is-full-version="false"></div>',access:[]}).state("search.activity",{template:'<div preview-activity="{{selectedItem.id}}" class="full-height" is-full-version="false"></div>',access:[]}).state("search.activityPV",{params:{guid:null,displayId:null},controller:"PwaTicketController",templateProvider:["$stateParams","$state",function(e,t){var a=localStorage.getItem("midtierUrl"),n=localStorage.getItem("homeServer"),i=e.guid,o="Activity",r="SV_View";if(a){var s;return s=n?a+"/pwa/#/forms/"+n+"/SHR:SV_TicketDisplay/SV_TicketDisplay?origin="+window.location.origin+"&targetForm="+o+"&targetView="+r+"&targetId="+i+"&mode=GET&context=PREVIEW":a+"/pwa/#/goto/SHR:SV_TicketDisplay/SV_TicketDisplay?origin="+window.location.origin+"&targetForm="+o+"&targetView="+r+"&targetId="+i+"&mode=GET&context=PREVIEW",'<div loading-spinner if="dataLoading" centered="true" overlay="true"></div><iframe src="'+s+'" frameborder="0" width="100%" height="100%"></iframe><div class="unauthorized" ng-if="!ccsEnabledForPWA"><h4>{{"error" | i18n}}</h4><p>{{"error.unauthorized" | i18n}}</p><a href="" ui-sref="dashboard">{{"error.click.return.home"|i18n}}</a></div>'}}],access:[]}).state("search.problem",{template:'<div preview-problem="{{selectedItem.id}}" class="full-height" is-full-version="false"></div>',access:[]}).state("search.problemPV",{params:{guid:null,displayId:null},controller:"PwaTicketController",templateProvider:["$stateParams","$state",function(e,t){var a=localStorage.getItem("midtierUrl"),n=localStorage.getItem("homeServer"),i=e.guid,o="Problem Investigation",r="SV_View";if(a){var s;return s=n?a+"/pwa/#/forms/"+n+"/SHR:SV_TicketDisplay/SV_TicketDisplay?origin="+window.location.origin+"&targetForm="+o+"&targetView="+r+"&targetId="+i+"&mode=GET&context=PREVIEW":a+"/pwa/#/goto/SHR:SV_TicketDisplay/SV_TicketDisplay?origin="+window.location.origin+"&targetForm="+o+"&targetView="+r+"&targetId="+i+"&mode=GET&context=PREVIEW",'<div loading-spinner if="dataLoading" centered="true" overlay="true"></div><iframe src="'+s+'" frameborder="0" width="100%" height="100%"></iframe><div class="unauthorized" ng-if="!ccsEnabledForPWA"><h4>{{"error" | i18n}}</h4><p>{{"error.unauthorized" | i18n}}</p><a href="" ui-sref="dashboard">{{"error.click.return.home"|i18n}}</a></div>'}}],access:[]}).state("search.knownerror",{template:'<div preview-known-error="{{selectedItem.id}}" class="full-height" is-full-version="false"></div>',access:[]}).state("search.knownerrorPV",{access:[],params:{guid:null,displayId:null},controller:"PwaTicketController",templateProvider:["$stateParams","$state",function(e,t){var a=localStorage.getItem("midtierUrl"),n=localStorage.getItem("homeServer"),i=e.guid,o="Known Error",r="SHR:SV_TicketDisplay/SV_TicketDisplay",s="SV_View";if(a){var l;return l=n?a+"/pwa/#/forms/"+n+"/"+r+"?origin="+window.location.origin+"&targetForm="+o+"&targetView="+s+"&targetId="+i+"&mode=GET&context=PREVIEW":a+"/pwa/#/goto/"+r+"?origin="+window.location.origin+"&targetForm="+o+"&targetView="+s+"&targetId="+i+"&mode=GET&context=PREVIEW",'<div loading-spinner if="dataLoading" centered="true" overlay="true"></div><iframe src="'+l+'" frameborder="0" width="100%" height="100%"></iframe><div class="unauthorized" ng-if="!ccsEnabledForPWA"><h4>{{"error" | i18n}}</h4><p>{{"error.unauthorized" | i18n}}</p><a href="" ui-sref="dashboard">{{"error.click.return.home"|i18n}}</a></div>'}}]}).state("person",{url:"/person/{id:.*}",templateUrl:"views/person/person-profile.html",controller:"PersonProfileController",data:{pageTitle:"customization.screen.personDetailsScreen"},access:[i.ITSM_AGENT_ROLE,i.ITSM_CHANGE_USER_ROLE,i.ITSM_KNOWLEDGE_USER_ROLE,i.ITSM_PROBLEM_USER_ROLE,i.ITSM_ASSET_USER_ROLE],resolve:{PVEnable:["metadataModel","$state","$stateParams",function(e,t,a){return e.getMetadataByType("global").then(function(e){var n="T"===e.configurationParameters["Enable-Progressive-Views"]||"true"===e.configurationParameters["Enable-Progressive-Views"];n="T"!==localStorage.getItem("overridePV")&&n,n&&localStorage.getItem("midtierUrl")?t.go("personPV",{id:a.id},{location:"replace"}):console.info("Either PV not enabled or invalid midtierUrl")})["catch"](function(e){console.info(e.data.error)})}]}}).state("personPV",{url:"/personPV/:id",controller:"PwaTicketController",data:{pageTitle:"customization.screen.personDetailsScreen",formName:"SHR:SV_TicketDisplay/SV_TicketDisplay",targetForm:"People",targetView:"SV_View",mode:"GET"},access:[i.ITSM_AGENT_ROLE,i.ITSM_CHANGE_USER_ROLE,i.ITSM_KNOWLEDGE_USER_ROLE,i.ITSM_PROBLEM_USER_ROLE,i.ITSM_ASSET_USER_ROLE]}).state("asset",{url:"/asset/:assetId/:assetClassId",templateUrl:"views/asset/asset-profile.html",controller:"AssetProfileController",data:{history:{type:"assets",label:"asset"},pageTitle:"header.navigation.asset"},access:[i.ITSM_AGENT_ROLE,i.ITSM_ADMIN_ROLE,i.ITSM_CHANGE_USER_ROLE,i.ITSM_KNOWLEDGE_USER_ROLE,i.ITSM_PROBLEM_USER_ROLE,i.ITSM_ASSET_USER_ROLE]}).state("assetPV",{url:"/assetPV/:assetId/:assetClassId",controller:"PwaTicketController",data:{history:{type:"assets",label:"asset"},pageTitle:"header.navigation.asset",formName:"SHR:SV_TicketDisplay/SV_TicketDisplay",targetForm:"Configuration Item",targetView:"SV_View",mode:"GET"},access:[i.ITSM_AGENT_ROLE,i.ITSM_ADMIN_ROLE,i.ITSM_CHANGE_USER_ROLE,i.ITSM_KNOWLEDGE_USER_ROLE,i.ITSM_PROBLEM_USER_ROLE,i.ITSM_ASSET_USER_ROLE]}).state("editAssetPV",{url:"/edit/assetPV/:assetId/:assetClassId",controller:"PwaTicketController",data:{history:{type:"assets",label:"asset"},pageTitle:"header.navigation.asset",formName:"SHR:SV_TicketDisplay/SV_TicketDisplay",targetForm:"Configuration Item",targetView:"SV_Edit",mode:"GET"},params:{context:"ASSETCONSOLE"},access:[i.ITSM_AGENT_ROLE,i.ITSM_ADMIN_ROLE,i.ITSM_CHANGE_USER_ROLE,i.ITSM_KNOWLEDGE_USER_ROLE,i.ITSM_PROBLEM_USER_ROLE,i.ITSM_ASSET_USER_ROLE]}).state("assetCiExplorer",{"abstract":!0,url:"/asset/:assetId/:assetClassId",templateUrl:"views/asset/ci-explorer.html",controller:"AssetController",access:[i.ITSM_AGENT_ROLE,i.ITSM_CHANGE_USER_ROLE,i.ITSM_KNOWLEDGE_USER_ROLE,i.ITSM_PROBLEM_USER_ROLE,i.ITSM_ASSET_USER_ROLE],data:{pageTitle:"header.navigation.asset"}}).state("assetCiExplorer.list",{url:"/list-ci",templateUrl:"views/asset/list-ci-explorer.html",controller:"AssetListCiExplorerController",access:[i.ITSM_AGENT_ROLE,i.ITSM_CHANGE_USER_ROLE,i.ITSM_KNOWLEDGE_USER_ROLE,i.ITSM_PROBLEM_USER_ROLE,i.ITSM_ASSET_USER_ROLE],data:{pageTitle:"asset.relationship.list-explorer"}}).state("assetCiExplorer.graphical",{url:"/graphical-ci",templateUrl:"views/asset/graphical-ci-explorer.html",controller:"AssetGraphicalCiExplorerController",access:[i.ITSM_AGENT_ROLE,i.ITSM_CHANGE_USER_ROLE,i.ITSM_KNOWLEDGE_USER_ROLE,i.ITSM_PROBLEM_USER_ROLE,i.ITSM_ASSET_USER_ROLE],data:{pageTitle:"asset.relationship.graphical-explorer"}}).state("createIncident",{url:"/create/incident",templateUrl:"views/create/create-incident-v2.html",controller:"CreateIncidentV2Controller",access:[i.ITSM_AGENT_ROLE],data:{pageTitle:"create.incident.header"}}).state("createIncidentPV",{url:"/create/incidentPV",controller:"PwaTicketController",data:{pageTitle:"create.incident.header",formName:"SHR:SV_TicketCreate/SV_TicketCreate",targetForm:"Incident",targetView:"SV_Create",mode:"CREATE"},access:[i.ITSM_AGENT_ROLE]}).state("pwaAction",{url:"/pwa-action",controller:"PwaActionController",data:{pageTitle:"common.label.actions"},params:{data:null},access:[i.ITSM_AGENT_ROLE]}).state("createKnowledge",{url:"/create/knowledge",templateUrl:"views/create/create-ka.html",controller:"CreateKnowledgeArticleController",access:[i.ITSM_KNOWLEDGE_USER_ROLE],data:{pageTitle:"create.knowledge.header"},resolve:{comaroundEnable:["metadataModel","$state","$rootScope",c]}}).state("createAqiQuestions",{url:"/create/aqiQuestions",templateUrl:"views/create/aqi-question-sets.html",controller:"createAqiController",access:[i.ITSM_KCS_COACH_ROLE],data:{pageTitle:"create.aqi.questionSets.header"},resolve:{comaroundEnable:["metadataModel","$state","$rootScope",c]}}).state("changeCalendar",{url:"/changeCalendar/:defaultData",template:"<calendar></calendar>",controller:"ChangeCalendarController",access:[i.ITSM_CHANGE_USER_ROLE],data:{pageTitle:"create.change.header"}}).state("changeCalendar.book",{url:"",access:[i.ITSM_CHANGE_USER_ROLE],template:"<calendar-book-view></calendar-book-view>",data:{pageTitle:"create.change.header"}}).state("changeCalendar.day",{url:"",access:[i.ITSM_CHANGE_USER_ROLE],template:'<calendar-view id="changeCalendarDayView" view-type="Day"></calendar-view>',data:{pageTitle:"create.change.header"}}).state("changeCalendar.week",{url:"",access:[i.ITSM_CHANGE_USER_ROLE],template:'<calendar-month-view id="changeCalendarWeekView" view-type="Weeks"></calendar-month-view>',data:{pageTitle:"create.change.header"}}).state("changeCalendar.month",{url:"",access:[i.ITSM_CHANGE_USER_ROLE],template:'<calendar-month-view id="changeCalendarMonthView" view-type="Month"></calendar-month-view>',data:{pageTitle:"create.change.header"}}).state("createChange",{url:"/create/change",template:"<ui-view></ui-view>",controller:"CreateChangeV2Controller",params:{fromRelated:!1,crossLaunchContext:""},access:[i.ITSM_CHANGE_USER_ROLE],data:{pageTitle:"create.change.header"},resolve:{PVEnable:["metadataModel","$state","$stateParams",function(e,t,a){e.getMetadataByType("global").then(function(e){var n="T"===e.configurationParameters["Enable-Progressive-Views"]||"true"===e.configurationParameters["Enable-Progressive-Views"];n="T"!==localStorage.getItem("overridePV")&&n,n&&localStorage.getItem("midtierUrl")?a.fromRelated?t.go("pwaDraftChange",a):t.go("createChangePV"):console.info("Either PV not enabled or invalid midtierUrl")})["catch"](function(e){console.info(e.data.error)})}]}}).state("createChangePV",{url:"/create/changePV",controller:"PwaTicketController",data:{pageTitle:"create.change.header",formName:"SHR:SV_TicketCreate/SV_TicketCreate",targetForm:"Infrastructure Change",targetView:"SV_Create",mode:"CREATE"},access:[i.ITSM_CHANGE_USER_ROLE]}).state("createChange.selector",{url:"/",templateUrl:"views/change/create-change-selector.html",access:[i.ITSM_CHANGE_USER_ROLE],data:{pageTitle:"create.change.header"}}).state("createChange.wizard",{url:"/",template:"<change-wizard></change-wizard>",access:[i.ITSM_CHANGE_USER_ROLE],data:{pageTitle:"create.change.header"}}).state("createChange.wizard.calendar",{url:"",access:[i.ITSM_CHANGE_USER_ROLE],template:"<calendar></calendar>",data:{pageTitle:"create.change.header"}}).state("createChange.wizard.calendar.book",{url:"",access:[i.ITSM_CHANGE_USER_ROLE],template:"<calendar-book-view></calendar-book-view>",data:{pageTitle:"create.change.header"}}).state("createChange.wizard.calendar.day",{url:"",access:[i.ITSM_CHANGE_USER_ROLE],template:'<calendar-view id="calendarDayView" view-type="Day"></calendar-view>',data:{pageTitle:"create.change.header"}}).state("createChange.wizard.calendar.week",{url:"",access:[i.ITSM_CHANGE_USER_ROLE],template:'<calendar-month-view id="calendarWeekView" view-type="Weeks"></calendar-month-view>',data:{pageTitle:"create.change.header"}}).state("createChange.wizard.calendar.month",{url:"",access:[i.ITSM_CHANGE_USER_ROLE],template:'<calendar-month-view id="calendarMonthView" view-type="Month"></calendar-month-view>',data:{pageTitle:"create.change.header"}}).state("changeEditCollisions",{url:"/change/:id/collisions",templateUrl:"views/change/edit-dates.html",controller:"EditDatesController",data:{editMode:!0,pageTitle:"create.change.header"},access:[i.ITSM_CHANGE_USER_ROLE]}).state("changeEditCollisions.calendar",{url:"",access:[i.ITSM_CHANGE_USER_ROLE],template:"<calendar></calendar>",data:{pageTitle:"create.change.header"}}).state("changeEditCollisions.calendar.book",{url:"",template:"<calendar-book-view></calendar-book-view>",access:[i.ITSM_CHANGE_USER_ROLE],data:{pageTitle:"create.change.header"}}).state("changeEditCollisions.calendar.day",{url:"",template:'<calendar-view id="calendarDayView" view-type="Day"></calendar-view>',access:[i.ITSM_CHANGE_USER_ROLE],data:{pageTitle:"create.change.header"}}).state("changeEditCollisions.calendar.week",{url:"",template:'<calendar-month-view id="calendarWeekView" view-type="Weeks"></calendar-month-view>',access:[i.ITSM_CHANGE_USER_ROLE],data:{pageTitle:"create.change.header"}}).state("changeEditCollisions.calendar.month",{url:"",template:'<calendar-month-view id="calendarMonthView" view-type="Month"></calendar-month-view>',access:[i.ITSM_CHANGE_USER_ROLE],data:{pageTitle:"create.change.header"}}).state("changeEditDates",{url:"/change/:id/dates",templateUrl:"views/change/edit-dates.html",controller:"EditDatesController",data:{editMode:!1,pageTitle:"create.change.header"},access:[i.ITSM_CHANGE_USER_ROLE]}).state("changeEditDates.calendar",{url:"",access:[i.ITSM_CHANGE_USER_ROLE],template:"<calendar></calendar>",data:{pageTitle:"create.change.header"}}).state("changeEditDates.calendar.book",{url:"",template:"<calendar-book-view></calendar-book-view>",access:[i.ITSM_CHANGE_USER_ROLE],data:{pageTitle:"create.change.header"}}).state("changeEditDates.calendar.day",{url:"",template:'<calendar-view id="calendarDayView" view-type="Day"></calendar-view>',access:[i.ITSM_CHANGE_USER_ROLE],data:{pageTitle:"create.change.header"}}).state("changeEditDates.calendar.week",{url:"",template:'<calendar-month-view id="calendarWeekView" view-type="Weeks"></calendar-month-view>',access:[i.ITSM_CHANGE_USER_ROLE],data:{pageTitle:"create.change.header"}}).state("changeEditDates.calendar.month",{url:"",template:'<calendar-month-view id="calendarMonthView" view-type="Month"></calendar-month-view>',access:[i.ITSM_CHANGE_USER_ROLE],data:{pageTitle:"create.change.header"}}).state("impactGraph",{url:"/:type/:id/impactGraph",templateUrl:"views/change/impact-simulator.html",controller:"ImpactAnalysisController",params:{id:null,type:null,displayId:null},access:[i.ITSM_CHANGE_USER_ROLE],data:{pageTitle:"create.change.header"}}).state("createRelease",{url:"/create/release",template:"<ui-view></ui-view>",controller:"CreateReleaseController",access:[i.ITSM_RELEASE_USER_ROLE],data:{pageTitle:"create.release.header"},params:{fromRelated:!1,crossLaunchContext:""}}).state("createReleasePV",{url:"/create/releasePV",controller:"PwaTicketController",data:{pageTitle:"create.release.header",formName:"SHR:SV_TicketCreate/SV_TicketCreate",targetForm:"Release",targetView:"SV_Create",mode:"CREATE"},access:[i.ITSM_RELEASE_USER_ROLE]}).state("createRelease.selector",{url:"/",templateUrl:"views/release/create-release-selector.html",access:[i.ITSM_RELEASE_USER_ROLE],data:{pageTitle:"create.release.header"}}).state("createRelease.wizard",{url:"/",template:"<release-wizard></release-wizard>",access:[i.ITSM_RELEASE_USER_ROLE],data:{pageTitle:"create.release.header"}}).state("createActivity",{url:"/create/activity",templateUrl:"views/create/create-activity.html",controller:"CreateActivityController",access:[i.ITSM_RELEASE_USER_ROLE],data:{pageTitle:"create.release.releasePlan.createActivity"}}).state("createActivityPV",{url:"/create/activityPV",controller:"PwaTicketController",data:{pageTitle:"create.activity.header",formName:"SHR:SV_TicketCreate/SV_TicketCreate",targetForm:"Activity",targetView:"SV_Create",mode:"CREATE"},access:[i.ITSM_RELEASE_USER_ROLE]}).state("smartRecorder",{url:"/create/smart-recorder?customer&contact&desc",templateUrl:"views/smart-recorder/smart-recorder.html",controller:"SmartRecorderController",data:{pageTitle:"globalNav.smartRecorder"},access:[i.ITSM_AGENT_ROLE]}).state("screenConfiguration",{url:"/admin/screen-configuration",templateUrl:"views/admin/screen-configuration/screen-configuration.html",controller:"ScreenConfigurationController",access:[i.ITSM_ADMIN_ROLE],data:{pageTitle:"header.navigation.screenConfiguration"}}).state("adminConsoleConfig",{url:"/admin/admin-console-configuration",templateUrl:"views/admin/console-config/admin-console-configuration.html",controller:"AdminConsoleConfigurationController",access:[i.ITSM_ADMIN_ROLE],data:{pageTitle:"header.navigation.adminConsoleConfig"}}).state("knowledgeStyleConfiguration",{url:"/admin/knowledge-style-configuration",templateUrl:"views/admin/knowledge-style-configuration/knowledge-style-config.html",controller:"KnowledgeStyleConfigController",access:[i.ITSM_ADMIN_ROLE],data:{pageTitle:"header.navigation.knowledgeTemplateStyles"},resolve:{comaroundEnable:["metadataModel","$state","$rootScope",c]}}).state("knowledgeTeam",{url:"/knowledgeTeam",templateUrl:"views/knowledge-team/knowledge-team-profile.html",controller:"KnowledgeTeamController",access:[i.ITSM_KCS_COACH_ROLE],data:{pageTitle:"header.navigation.knowledge"},resolve:{comaroundEnable:["metadataModel","$state","$rootScope",c]}}).state("createTask",{url:"/create/task",templateUrl:"views/create/create-task-v2.html",controller:"CreateTaskV2Controller",access:[i.ITSM_AGENT_ROLE,i.ITSM_CHANGE_USER_ROLE,i.ITSM_PROBLEM_USER_ROLE],data:{pageTitle:"create.task.header"}}).state("createTaskPV",{url:"/create/taskPV",controller:"PwaTicketController",access:[i.ITSM_AGENT_ROLE,i.ITSM_CHANGE_USER_ROLE,i.ITSM_PROBLEM_USER_ROLE],data:{pageTitle:"create.task.header"},templateProvider:["$stateParams","$state",function(e,t){var a=localStorage.getItem("midtierUrl"),n=localStorage.getItem("homeServer"),i="Task",o="SV_Create";if(a){var r;return r=n?a+"/pwa/#/forms/"+n+"/SHR:SV_TicketCreate/SV_TicketCreate?origin="+window.location.origin+"&targetForm="+i+"&targetView="+o+"&mode=GET":a+"/pwa/#/goto/SHR:SV_TicketCreate/SV_TicketCreate?origin="+window.location.origin+"&targetForm="+i+"&targetView="+o+"&mode=GET",'<div loading-spinner if="dataLoading" centered="true" overlay="true"></div><iframe src="'+r+'" class="app__pwa-iframe app__pwa-iframe-create" frameborder="0" width="100%"></iframe><div class="unauthorized" ng-if="!ccsEnabledForPWA"><h4>{{"error" | i18n}}</h4><p>{{"error.unauthorized" | i18n}}</p><a href="" ui-sref="dashboard">{{"error.click.return.home"|i18n}}</a></div>'}t.go("createTask")}]}).state("draftIncident",{url:"/draft-incident",templateUrl:"views/ticket/profiles/draft-incident-profile.html",controller:"DraftTicketController",access:[i.ITSM_AGENT_ROLE],params:{error:null,isSrcLiveChat:"false"},data:{pageTitle:"create.draft.incident"}}).state("pwaDraftIncident",{url:"/pwa-draft-incident",controller:"PwaTicketController",access:[i.ITSM_AGENT_ROLE],params:{error:null,isSrcLiveChat:"false",isSrcAsset:"false",isSrcChange:"false",isSrcKnownError:"false",isSrcProblem:"false",crossLaunchContext:""},data:{pageTitle:"create.draft.incident",formName:"SHR:SV_TicketDisplay/SV_TicketDisplay",targetForm:"Incident",targetView:"SV_Edit"}}).state("pwaDraftWorkorder",{url:"/pwa-draft-workorder",controller:"PwaTicketController",access:[i.ITSM_AGENT_ROLE],params:{error:null,isSrcLiveChat:"false",isSrcAsset:"false",isSrcChange:"false",isSrcKnownError:"false",isSrcProblem:"false",crossLaunchContext:""},data:{pageTitle:"create.draft.workorder",formName:"SHR:SV_TicketDisplay/SV_TicketDisplay",targetForm:"Work Order",targetView:"SV_Edit"}}).state("liveChatDraft",{url:"/lc-draft?:draftType?:launchMode?:id",template:"",controller:"LiveChatDraftTicketController",access:[i.ITSM_AGENT_ROLE],params:{error:null,isSrcLiveChat:"true",draftType:null,crossLaunchContext:"LIVECHAT",launchMode:"view",id:null}}).state("draftChange",{url:"/draft-change/:id",templateUrl:"views/ticket/profiles/draft-change-profile.html",controller:"DraftTicketController",params:{isCopyChange:!1,copyChangeId:null,ticket:null,hasRelatedCis:!1},access:[i.ITSM_CHANGE_USER_ROLE],data:{pageTitle:"create.draft.change"}}).state("pwaDraftChange",{url:"/pwa-draft-change",controller:"PwaTicketController",access:[i.ITSM_CHANGE_USER_ROLE],params:{error:null,isSrcLiveChat:"false",isSrcAsset:"false",isSrcChange:"false",isSrcKnownError:"false",isSrcProblem:"false",isSrcRelease:"false",crossLaunchContext:""},data:{pageTitle:"create.draft.change",formName:"SHR:SV_TicketDisplay/SV_TicketDisplay",targetForm:"Infrastructure Change",targetView:"SV_Edit"}}).state("draftWorkorder",{url:"/draft-workorder",templateUrl:"views/ticket/profiles/draft-workorder-profile.html",controller:"DraftTicketController",access:[i.ITSM_AGENT_ROLE],params:{error:null,isSrcLiveChat:"false"},data:{pageTitle:"create.draft.workorder"}}).state("draftServicerequest",{url:"/draft-request",templateUrl:"views/ticket/profiles/draft-service-request-profile.html",controller:"DraftTicketController",access:[i.ITSM_AGENT_ROLE],params:{error:null},data:{pageTitle:"create.draft.servicerequest"}}).state("extDraft",{url:"/ext-draft?draftType",template:"",controller:"ExtDraftTicketController",access:[i.ITSM_AGENT_ROLE]}).state("draftProblem",{url:"/draft-problem",templateUrl:"views/ticket/profiles/draft-problem-profile.html",controller:"DraftTicketController",access:[i.ITSM_PROBLEM_USER_ROLE],data:{pageTitle:"create.draft.problem"}}).state("pwaDraftProblem",{url:"/pwa-draft-problem",controller:"PwaTicketController",access:[i.ITSM_PROBLEM_USER_ROLE],params:{error:null,isSrcChange:"false",isSrcExt:"false",crossLaunchContext:""},data:{pageTitle:"create.draft.problem",formName:"SHR:SV_TicketDisplay/SV_TicketDisplay",targetForm:"Problem Investigation",targetView:"SV_Edit"}}).state("draftKnownerror",{url:"/draft-knownerror",templateUrl:"views/ticket/profiles/draft-knownerror-profile.html",controller:"DraftTicketController",access:[i.ITSM_PROBLEM_USER_ROLE],data:{pageTitle:"create.draft.knownerror"}}).state("pwaDraftKnownerror",{url:"/pwa-draft-knownerror",controller:"PwaTicketController",access:[i.ITSM_PROBLEM_USER_ROLE],params:{error:null,isSrcChange:"false",crossLaunchContext:""},data:{pageTitle:"create.draft.knownerror",formName:"SHR:SV_TicketDisplay/SV_TicketDisplay",targetForm:"Known Error",targetView:"SV_Edit"}}).state("ticket",{url:"/:type/displayid/:displayid",templateUrl:"views/common/ticket-transition.html",controller:"TicketTransitionController",access:[i.ITSM_CHANGE_USER_ROLE,i.ITSM_RELEASE_USER_ROLE,i.ITSM_AGENT_ROLE,i.ITSM_PROBLEM_USER_ROLE,i.ITSM_ASSET_USER_ROLE]}).state("incident",{url:"/incident/:id",templateUrl:"views/ticket/profiles/incident-profile.html",controller:"TicketProfileController",access:[i.ITSM_AGENT_ROLE],params:{editMode:!1},data:{pageTitle:"common.labels.incident"}}).state("incidentPV",{url:"/incidentPV/:id",controller:"PwaTicketController",data:{pageTitle:"common.labels.incident",formName:"SHR:SV_TicketDisplay/SV_TicketDisplay",targetForm:"Incident",targetView:"SV_View",mode:"GET"},access:[i.ITSM_AGENT_ROLE]}).state("editIncidentPV",{url:"/edit/incidentPV/:id",controller:"PwaTicketController",data:{pageTitle:"common.labels.incident",formName:"SHR:SV_TicketDisplay/SV_TicketDisplay",targetForm:"Incident",targetView:"SV_Edit",mode:"GET"},access:[i.ITSM_AGENT_ROLE],params:{context:"TICKETCONSOLE"}}).state("calendarStudio",{url:"/calendarStudio",controller:"StudioController",data:{pageTitle:"header.navigation.calendar"},access:[i.ITSM_CHANGE_USER_ROLE,i.ITSM_RELEASE_USER_ROLE,i.ITSM_AGENT_ROLE,i.ITSM_PROBLEM_USER_ROLE,i.ITSM_ASSET_USER_ROLE]}).state("ticketConsoleStudio",{url:"/ticket-consoleStudio",controller:"StudioController",data:{pageTitle:"header.navigation.ticketConsole"},access:[i.ITSM_CHANGE_USER_ROLE,i.ITSM_RELEASE_USER_ROLE,i.ITSM_AGENT_ROLE,i.ITSM_PROBLEM_USER_ROLE,i.ITSM_ASSET_USER_ROLE]}).state("globalSearchStudio",{url:"/globalSearchStudio",controller:"StudioController",data:{pageTitle:"common.placeholder.search"},access:[i.ITSM_AGENT_ROLE,i.ITSM_CHANGE_USER_ROLE,i.ITSM_KNOWLEDGE_USER_ROLE,i.ITSM_PROBLEM_USER_ROLE,i.ITSM_ASSET_USER_ROLE]}).state("assetConsoleStudio",{url:"/asset-consoleStudio",controller:"StudioController",data:{pageTitle:"header.navigation.assetConsole"},access:[i.ITSM_ASSET_USER_ROLE]}).state("workorder",{url:"/workorder/:id",templateUrl:"views/ticket/profiles/workorder-profile.html",controller:"TicketProfileController",
access:[i.ITSM_AGENT_ROLE],params:{editMode:!1},data:{pageTitle:"common.labels.workorder"}}).state("workorderPV",{url:"/workorderPV/:id",controller:"PwaTicketController",data:{pageTitle:"smartrecorder.button.createWorkorder",formName:"SHR:SV_TicketDisplay/SV_TicketDisplay",targetForm:"Work Order",targetView:"SV_View",mode:"GET"},access:[i.ITSM_AGENT_ROLE]}).state("editWorkorderPV",{url:"/edit/workorderPV/:id",controller:"PwaTicketController",data:{pageTitle:"smartrecorder.button.createWorkorder",formName:"SHR:SV_TicketDisplay/SV_TicketDisplay",targetForm:"Work Order",targetView:"SV_Edit",mode:"GET"},params:{context:"TICKETCONSOLE"},access:[i.ITSM_AGENT_ROLE]}).state("task",{url:"/task/:id",templateUrl:"views/ticket/profiles/task-profile.html",controller:"TicketProfileController",access:[i.ITSM_AGENT_ROLE,i.ITSM_CHANGE_USER_ROLE,i.ITSM_PROBLEM_USER_ROLE],data:{pageTitle:"common.labels.task"}}).state("taskPV",{url:"/taskPV/:id",controller:"PwaTicketController",access:[i.ITSM_AGENT_ROLE,i.ITSM_CHANGE_USER_ROLE,i.ITSM_PROBLEM_USER_ROLE],data:{pageTitle:"common.labels.task",formName:"SHR:SV_TicketDisplay/SV_TicketDisplay",targetForm:"Task",targetView:"SV_View",mode:"GET"}}).state("editTaskPV",{url:"/edit/taskPV/:id",controller:"PwaTicketController",access:[i.ITSM_AGENT_ROLE,i.ITSM_CHANGE_USER_ROLE,i.ITSM_PROBLEM_USER_ROLE],data:{pageTitle:"common.labels.task",formName:"SHR:SV_TicketDisplay/SV_TicketDisplay",targetForm:"Task",targetView:"SV_Edit",mode:"GET"},params:{context:"TICKETCONSOLE"}}).state("request",{url:"/request/:id",templateUrl:"views/ticket/profiles/service-request-profile.html",controller:"TicketProfileController",access:[i.ITSM_AGENT_ROLE],data:{pageTitle:"common.labels.request"}}).state("outage",{url:"/outage/:id",templateUrl:"views/ticket/ticket-profile.html",controller:"TicketProfileController",access:[i.ITSM_AGENT_ROLE,i.ITSM_CHANGE_USER_ROLE,i.ITSM_KNOWLEDGE_USER_ROLE,i.ITSM_ASSET_USER_ROLE],data:{pageTitle:"common.labels.outage"}}).state("createWorkorder",{url:"/create/workorder",templateUrl:"views/create/create-work-order-v2.html",controller:"CreateWorkOrderV2Controller",access:[i.ITSM_AGENT_ROLE],data:{pageTitle:"smartrecorder.button.createWorkorder"}}).state("createWorkorderPV",{url:"/create/workorderPV",controller:"PwaTicketController",data:{pageTitle:"smartrecorder.button.createWorkorder",formName:"SHR:SV_TicketCreate/SV_TicketCreate",targetForm:"Work Order",targetView:"SV_Create",mode:"CREATE"},access:[i.ITSM_AGENT_ROLE]}).state("createBroadcast",{url:"/create/broadcast",templateUrl:"views/create/create-broadcast.html",controller:"CreateBroadcastController",access:[i.ITSM_BROADCAST_USER_ROLE],data:{pageTitle:"create.broadcast.header"},resolve:{PVEnable:["metadataModel","$state",function(e,t){return e.getMetadataByType("global").then(function(e){var a="T"===e.configurationParameters["Enable-Progressive-Views"]||"true"===e.configurationParameters["Enable-Progressive-Views"];a="T"!==localStorage.getItem("overridePV")&&a,a&&localStorage.getItem("midtierUrl")?t.go("createBroadcastPV"):console.info("Either PV not enabled or invalid midtierUrl")})["catch"](function(e){console.info(e.data.error)})}]}}).state("createBroadcastPV",{url:"/create/broadcastPV",controller:"PwaTicketController",access:[i.ITSM_BROADCAST_USER_ROLE],data:{pageTitle:"create.broadcast.header",formName:"SHR:SV_TicketCreate/SV_TicketCreate",targetForm:"Broadcast",targetView:"SV_Create",mode:"CREATE"}}).state("createAsset",{url:"/create/asset",templateUrl:"views/create/create-asset.html",controller:"CreateAssetController",access:[i.ITSM_ASSET_ADMIN_ROLE],data:{pageTitle:"create.asset.header"},resolve:{PVEnable:["metadataModel","$state",function(e,t){return e.getMetadataByType("global").then(function(e){var a="T"===e.configurationParameters["Enable-Progressive-Views"]||"true"===e.configurationParameters["Enable-Progressive-Views"];a="T"!==localStorage.getItem("overridePV")&&a,a&&localStorage.getItem("midtierUrl")?t.go("createAssetPV"):console.info("Either PV not enabled or invalid midtierUrl")})["catch"](function(e){console.info(e.data.error)})}]}}).state("createAssetPV",{url:"/create/assetPV",controller:"PwaTicketController",access:[i.ITSM_ASSET_ADMIN_ROLE,i.ITSM_ASSET_CREATOR_ROLE],data:{pageTitle:"create.asset.header",formName:"SHR:SV_TicketCreate/SV_TicketCreate",targetForm:"Configuration Item",targetView:"SV_Create",mode:"CREATE"}}).state("conversationsHistory",{url:"/conversations",templateUrl:"views/chat/history.html",controller:"ChatHistoryController",access:[i.ITSM_AGENT_ROLE,i.ITSM_CHANGE_USER_ROLE,i.ITSM_KNOWLEDGE_USER_ROLE,i.ITSM_PROBLEM_USER_ROLE,i.ITSM_ASSET_USER_ROLE],data:{pageTitle:"chat.history.title"}}).state("change",{url:"/change/:id",templateUrl:"views/ticket/profiles/change-profile.html",controller:"TicketProfileController",access:[i.ITSM_CHANGE_USER_ROLE],data:{pageTitle:"common.labels.change"}}).state("changePV",{url:"/changePV/:id",controller:"PwaTicketController",access:[i.ITSM_CHANGE_USER_ROLE],data:{pageTitle:"common.change.problem",formName:"SHR:SV_TicketDisplay/SV_TicketDisplay",targetForm:"Infrastructure Change",targetView:"SV_View",mode:"GET"}}).state("editChangePV",{url:"/edit/changePV/:id",controller:"PwaTicketController",access:[i.ITSM_CHANGE_USER_ROLE],data:{pageTitle:"common.change.problem",formName:"SHR:SV_TicketDisplay/SV_TicketDisplay",targetForm:"Infrastructure Change",targetView:"SV_Edit",mode:"GET"},params:{context:"TICKETCONSOLE"}}).state("release",{url:"/release/:id",templateUrl:"views/ticket/profiles/release-profile.html",controller:"TicketProfileController",access:[i.ITSM_RELEASE_USER_ROLE],data:{pageTitle:"common.labels.release"}}).state("releasePV",{url:"/releasePV/:id",controller:"PwaTicketController",data:{pageTitle:"common.labels.release",formName:"SHR:SV_TicketDisplay/SV_TicketDisplay",targetForm:"Release",targetView:"SV_View",mode:"GET"},access:[i.ITSM_RELEASE_USER_ROLE]}).state("editReleasePV",{url:"/edit/releasePV/:id",controller:"PwaTicketController",data:{pageTitle:"common.labels.release",formName:"SHR:SV_TicketDisplay/SV_TicketDisplay",targetForm:"Release",targetView:"SV_Edit",mode:"GET"},access:[i.ITSM_RELEASE_USER_ROLE],params:{context:"TICKETCONSOLE"}}).state("activity",{url:"/activity/:id",templateUrl:"views/ticket/profiles/activity-profile.html",controller:"TicketProfileController",access:[i.ITSM_RELEASE_USER_ROLE],data:{pageTitle:"common.labels.activity"}}).state("activityPV",{url:"/activityPV/:id",controller:"PwaTicketController",access:[i.ITSM_RELEASE_USER_ROLE],data:{pageTitle:"common.labels.activity",formName:"SHR:SV_TicketDisplay/SV_TicketDisplay",targetForm:"Activity",targetView:"SV_View",mode:"GET"}}).state("knownerror",{url:"/knownerror/:id",templateUrl:"views/ticket/profiles/known-error-profile.html",controller:"TicketProfileController",access:[i.ITSM_PROBLEM_USER_ROLE],data:{pageTitle:"common.labels.knownerror"}}).state("knownerrorPV",{url:"/knownerrorPV/:id",controller:"PwaTicketController",access:[i.ITSM_PROBLEM_USER_ROLE],data:{pageTitle:"common.labels.knownerror",formName:"SHR:SV_TicketDisplay/SV_TicketDisplay",targetForm:"Known Error",targetView:"SV_View",mode:"GET"}}).state("editKnownerrorPV",{url:"/edit/knownerrorPV/:id",controller:"PwaTicketController",access:[i.ITSM_PROBLEM_USER_ROLE],data:{pageTitle:"common.labels.knownerror",formName:"SHR:SV_TicketDisplay/SV_TicketDisplay",targetForm:"Known Error",targetView:"SV_Edit",mode:"GET"},params:{context:"TICKETCONSOLE"}}).state("createKnownerror",{url:"/create/knownerror",templateUrl:"views/known-error/create-known-error.html",controller:"CreateKnownErrorController",access:[i.ITSM_PROBLEM_USER_ROLE],data:{pageTitle:"create.knownerror.header"},resolve:{PVEnable:["metadataModel","$state",function(e,t){return e.getMetadataByType("global").then(function(e){var a="T"===e.configurationParameters["Enable-Progressive-Views"]||"true"===e.configurationParameters["Enable-Progressive-Views"];a="T"!==localStorage.getItem("overridePV")&&a,a&&localStorage.getItem("midtierUrl")?t.go("createKnownerrorPV"):console.info("Either PV not enabled or invalid midtierUrl")})["catch"](function(e){console.info(e.data.error)})}]}}).state("createKnownerrorPV",{url:"/create/knownerrorPV",controller:"PwaTicketController",access:[i.ITSM_PROBLEM_USER_ROLE],data:{pageTitle:"create.knownerror.header",formName:"SHR:SV_TicketCreate/SV_TicketCreate",targetForm:"Known Error",targetView:"SV_Create",mode:"CREATE"}}).state("createProblem",{url:"/create/problem",templateUrl:"views/problem/create-problem.html",controller:"CreateProblemController",access:[i.ITSM_PROBLEM_USER_ROLE],data:{pageTitle:"create.problem.header"},resolve:{PVEnable:["metadataModel","$state",function(e,t){e.getMetadataByType("global").then(function(e){var a="T"===e.configurationParameters["Enable-Progressive-Views"]||"true"===e.configurationParameters["Enable-Progressive-Views"];a="T"!==localStorage.getItem("overridePV")&&a,a&&localStorage.getItem("midtierUrl")?t.go("createProblemPV"):console.info("Either PV not enabled or invalid midtierUrl")})["catch"](function(e){console.info(e.data.error)})}]}}).state("createProblemPV",{url:"/create/problemPV",controller:"PwaTicketController",data:{pageTitle:"create.problem.header",formName:"SHR:SV_TicketCreate/SV_TicketCreate",targetForm:"Problem Investigation",targetView:"SV_Create",mode:"CREATE"},access:[i.ITSM_PROBLEM_USER_ROLE]}).state("problem",{url:"/problem/:id",templateUrl:"views/ticket/profiles/problem-profile.html",controller:"TicketProfileController",access:[i.ITSM_PROBLEM_USER_ROLE],data:{pageTitle:"common.labels.problem"}}).state("problemPV",{url:"/problemPV/:id",controller:"PwaTicketController",access:[i.ITSM_PROBLEM_USER_ROLE],data:{pageTitle:"common.labels.problem",formName:"SHR:SV_TicketDisplay/SV_TicketDisplay",targetForm:"Problem Investigation",targetView:"SV_View",mode:"GET"}}).state("editProblemPV",{url:"/edit/problemPV/:id",controller:"PwaTicketController",access:[i.ITSM_PROBLEM_USER_ROLE],data:{pageTitle:"common.labels.problem",formName:"SHR:SV_TicketDisplay/SV_TicketDisplay",targetForm:"Problem Investigation",targetView:"SV_Edit",mode:"GET"},params:{context:"TICKETCONSOLE"}}).state("location",{url:"/location/:id",template:'<div class="location-map full-height"><div loading-spinner if="state.loadingMap" centered="true" overlay="true"></div><location-map class="full-height"></location-map></div>',controller:"LocationMapController",access:[i.ITSM_AGENT_ROLE,i.ITSM_CHANGE_USER_ROLE,i.ITSM_KNOWLEDGE_USER_ROLE,i.ITSM_PROBLEM_USER_ROLE],data:{pageTitle:"field.widget.customerLocationMap.label"}}).state("chatPopupWindow",{url:"/chatPopupWindow",template:"<div> <loading-spinner if='!chatWindow' centered='true' overlay='true'></loading-spinner><chat-window is-popup-window='true' chat-room='chatWindow' ng-if='chatWindow'></chat-window> </div>",controller:"ChatPopupWindowController",data:{separateWindowMode:!0,pageTitle:"headerMainBar.icon.title.chat"},access:[i.ITSM_AGENT_ROLE,i.ITSM_CHANGE_USER_ROLE,i.ITSM_KNOWLEDGE_USER_ROLE,i.ITSM_PROBLEM_USER_ROLE,i.ITSM_ASSET_USER_ROLE]}).state("EmailPopupWindow",{url:"/emailPopupWindow",template:"<div> <loading-spinner if='!emailInstance' centered='true' overlay='true'></loading-spinner><email-window email-instance='emailInstance' is-popup-window='true' ng-if='emailInstance'></email-window> </div>",controller:"EmailPopupWindowController",data:{separateWindowMode:!0,pageTitle:"personInfoCard.label.email"},access:[i.ITSM_AGENT_ROLE,i.ITSM_CHANGE_USER_ROLE,i.ITSM_KNOWLEDGE_USER_ROLE,i.ITSM_PROBLEM_USER_ROLE,i.ITSM_ASSET_USER_ROLE]}).state("dlp",{url:"/dlp/:id",templateUrl:"views/ticket/profiles/data-loss-prevention-profile.html",controller:"dataLossPreventionProfileController",access:[i.ITSM_AGENT_ROLE],data:{pageTitle:"ticket.detail.dlp"}}).state("sberequest",{url:"/sberequest/:id",templateUrl:"views/ticket/profiles/sbe-request-profile.html",controller:"TicketProfileController",access:[i.ITSM_SBE_USER_ROLE],data:{pageTitle:"ticket.type.sberequest"}}).state("healthcheck",{url:"/healthcheck",templateUrl:"views/admin/health-check/health-check.html",controller:"MonitorController as ctrl",access:[i.ITSM_ADMIN_ROLE],data:{pageTitle:"admin.health.title"}}).state("liveChatAgentConsole",{url:"/live-chat/console",templateUrl:"views/live-chat/live-chat.html",controller:"LiveChatController",access:[i.ITSM_AGENT_ROLE,i.ESCHAT_AGENT_ROLE],data:{pageTitle:"common.labels.live-chat",path:"console"}}).state("liveChatDashboard",{url:"/live-chat/dashboard",templateUrl:"views/live-chat/live-chat.html",controller:"LiveChatController",access:[i.ITSM_AGENT_ROLE,i.ESCHAT_ADMIN_ROLE],data:{pageTitle:"common.labels.live-chat",path:"dashboard"}})}]).decorator("$log",["$logProvider","topicLoggerProvider","$delegate",function(e,t,a){return a.debug=function(){e.debugEnabled()&&a.log.apply(a,arguments)},a.topic=function(){var e=Array.prototype.slice.call(arguments);t.includesTopic(e[0])&&a.info.apply(a,e.slice(1,e.length))},a}]).run(["$rootScope","$state","$location","authModel","AUTH_EVENTS","i18nService","$q","roles","permissionModel","$locale","customLocale","$modalStack","DOCSLINK","$timeout","browser","systemAlertService",function(e,t,a,n,i,o,r,s,l,c,d,u,p,m,f,g){function h(t){var a="BMC Helix ITSM",i=" 23.3.04";n.isAuthenticated()?n.isAuthorized(t.access)&&t&&t.data&&t.data.pageTitle&&(a+=i+" | "+o.getLocalizedString(t.data.pageTitle)):a+=" | "+o.getLocalizedString("user.loginForm.loginButton"),e.pageTitle=a}var y=null,E=!0;e.docsLink=p,$.cookie.raw=!0,$.cookie("user_timezone")&&(e.timezone=$.cookie("user_timezone"),moment.tz.setDefault(e.timezone)),$.cookie("user_locale")&&(e.locale=$.cookie("user_locale")),e.$on("$stateChangeSuccess",function(e,t,a,i){y||(y=n.isAuthenticated()?r.when(1):n.checkSessionStatus()),y["finally"](function(){y=null,!n.isAuthenticated()&&n.isSSOEnabled()&&E?(E=!1,m(function(){h(t)},1500)):h(t)})}),e.$on("$stateChangeStart",function(a,s,c,d){var p=u.getTop();!p||p.value&&p.value.modalScope&&p.value.modalScope.modalOptions||u.dismiss(p.key),y||(y=n.isAuthenticated()?r.when(1):n.checkSessionStatus()),e.authPromise=y,y.then(function(){n.isAuthorized(s.access)?!f.isMobile||"request"!==s.name&&"createKnowledge"!==s.name&&("release"!==s.name&&"activity"!==s.name||"true"===localStorage.getItem("enableReleasePV"))||(g.error({text:o.getLocalizedString("error."+s.name+".notSupported"),clear:!1,displayOnStateChange:!0}),t.go(d)):(a.preventDefault(),n.isAuthenticated()&&(l.hasAdminOnlyRole()?"dashboard"!==s.name||d?e.$broadcast(i.NOT_AUTHORIZED):t.go("screenConfiguration"):e.$broadcast(i.NOT_AUTHORIZED)))})["finally"](function(){y=null})}),e.$on(i.NOT_AUTHORIZED,function(){console.log("$rootScope.$on(AUTH_EVENTS.NOT_AUTHORIZED)"),t.go("unauthorized")}),angular.merge(c,d)}])}(),AccessMappingVO.prototype=new BaseVO,AccessMappingVO.prototype.constructor=AccessMappingVO,AccessMappingVO.prototype.getProps=function(){var e=Object.keys(new AccessMappingVO);return BaseVO.prototype.getProps().concat(e)},AccessMappingVO.prototype.parseAccessMap=function(e,t){var a={};if(t===EntityVO.TYPE_INCIDENT||t===EntityVO.TYPE_CHANGE||t===EntityVO.TYPE_WORKORDER||t===EntityVO.TYPE_TASK){var n=_.filter(e,{type:1});e=_.reject(e,{type:1}),a.fieldMappings={},_.forEach(n,function(e){a.fieldMappings[e.id]=e.permission})}return _.forEach(e,function(e){if(e.id){var t="";t=e.id.indexOf("action")!==-1?e.id.replace(/\-/g,"").replace("action","")+"ActionAllowed":e.id.indexOf("self-assignment")!==-1?e.id.replace("self-assignment","").replace(/\-/g,"")+"SelfAssignmentAllowed":e.id.indexOf("add-approver")!==-1?e.id.replace("add-approver","").replace(/\-/g,"")+"addApproverEditAllowed":e.id+"EditAllowed",a[t]="write"===e.permission,"relationsEditAllowed"===t&&(a.relationsDeleteAllowed="delete"===e.permission||a.relationsEditAllowed),a.fieldMappings&&!a.fieldMappings[e.id]&&(a.fieldMappings[e.id]=e.permission)}}),a},AttachmentVO.prototype=new BaseVO,AttachmentVO.prototype.constructor=AttachmentVO,AttachmentVO.prototype.getProps=function(){return BaseVO.prototype.getProps().concat("name","modifiedDate","fileContentType","fileName","fileSize","size","type","contentType","thumbnail","attachmentReference")},AttachmentVO.prototype.getFileGenericIconClass=function(e){var t=e?e.split(".").pop():"",a=["xls","xlsx","doc","docx","pdf","csv","rtf","odt","ods"],n=["jpg","jpeg","png","gif","tif","tiff","bmp"],i="icon-paperclip_square";return a.indexOf(t)>=0?i="icon-"+t+"_square":n.indexOf(t)>=0&&(i="icon-image_square"),i},AttachmentVO.prototype.base64Validate=new RegExp("^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=|[A-Za-z0-9+/]{4})$"),AttachmentVO.prototype.normalizeThumbnail=function(e){var t=e.split(",").length>1?e.split(","):e.split(";"),a=t.pop(),n=t[0]||"";if(this.base64Validate.test(a)&&n.indexOf("base64")!==-1&&n.indexOf("image/")!==-1)return e;if(this.base64Validate.test(a)&&n.indexOf("base64")===-1){var i,o={jpeg:"/9j/4",gif:"R0lGOD",png:"iVBORw"};return _.each(o,function(e,t){0===a.indexOf(e)&&(i=t)}),i?"data:image/"+(i||"png")+";base64,"+a:""}return""},AttachmentVO.prototype.postBuild=function(){this.name=this.name||this.fileName,this.contentType=this.contentType||this.fileContentType||(this.name?this.name.split(".").pop():""),this.size=this.size||this.fileSize,this.thumbnail=this.normalizeThumbnail(this.thumbnail),this.thumbnail||(this.fileGenericIconClass=this.getFileGenericIconClass(this.name),this.badThumbSource=!0)},BaseVO.prototype.getProps=function(){return["id","createDate"]},BaseVO.prototype.build=function(e){var t=this.getProps();if(e&&t&&t.length)for(var a,n=0,i=t.length;n<i;n++)a=t[n],e.hasOwnProperty(a)&&(this[a]=e[a]);return this.postBuild(),this},BaseVO.prototype.postBuild=function(){},EntityVO.prototype=Object.create(BaseVO.prototype),EntityVO.prototype.constructor=EntityVO,EntityVO.TYPE_ASSET="asset",EntityVO.TYPE_TICKET="ticket",EntityVO.TYPE_INCIDENT="incident",EntityVO.TYPE_SERVICEREQUEST="request",EntityVO.TYPE_SBEREQUEST="sberequest",EntityVO.TYPE_SLM="slm",EntityVO.TYPE_WORKORDER="workorder",EntityVO.TYPE_TASK="task",EntityVO.TYPE_KNOWLEDGE="knowledge",EntityVO.TYPE_PERSON="person",EntityVO.TYPE_SMARTRECORDER="smartRecorder",EntityVO.TYPE_ORGANIZATION="organization",EntityVO.TYPE_DEPARTMENT="department",EntityVO.TYPE_REGION="region",EntityVO.TYPE_SITE_GROUP="sitegroup",EntityVO.TYPE_SITE="site",EntityVO.TYPE_SUPPORTGROUP="supportgroup",EntityVO.TYPE_COMPANY="company",EntityVO.TYPE_BROADCAST="broadcast",EntityVO.TYPE_OUTAGE="outage",EntityVO.TYPE_CONTRACT="contract",EntityVO.TYPE_PRIORITY="priority",EntityVO.TYPE_CALCULATED_PRIORITY="calculatedPriority",EntityVO.TYPE_SELECTED_URGENCY="selectedUrgency",EntityVO.TYPE_SELECTED_IMPACT="selectedImpact",EntityVO.TYPE_SELECTED_STATUS="selectedStatus",EntityVO.TYPE_STATUS="status",EntityVO.TYPE_STATUS_REASON="statusReason",EntityVO.TYPE_MILESTONE="milestone",EntityVO.TYPE_IMPACT="impact",EntityVO.TYPE_URGENCY="urgency",EntityVO.TYPE_TEXT="text",EntityVO.TYPE_TIME="time",EntityVO.TYPE_TIMESTAMP="timestamp",EntityVO.TYPE_CHANGE="change",EntityVO.TYPE_KNOWNERROR="knownerror",EntityVO.TYPE_PROBLEM="problem",EntityVO.TYPE_PEOPLE="people",EntityVO.TYPE_EMAIL_LINK="email",EntityVO.TYPE_INTEGER="integer",EntityVO.TYPE_RISKQUESTION="riskquestion",EntityVO.TYPE_REPORTS="reports",EntityVO.TYPE_HELIX_DASHBOARD="helixdashboard",EntityVO.TYPE_GLOBAL="global",EntityVO.TYPE_SMART_RECORDER="smartrecorder",EntityVO.TYPE_BUSINESS_EVENT="businessevent",EntityVO.TYPE_DLP="dlp",EntityVO.TYPE_RELEASE="release",EntityVO.TYPE_ACTIVITY="activity",EntityVO.TYPE_URL="url",EntityVO.TYPE_CALL_LOG="callLog",EntityVO.TYPE_LIVE_CHAT="eschat",EntityVO.TYPE_ITSM_INSIGHTS="itsminsights",EntityVO.TYPE_OUTAGE_TYPE="outage-type",EntityVO.METADATA_TYPE_GLOBAL="global",EntityVO.METADATA_TYPE_PURCHASE_ORDER="purchaseOrder",EntityVO.METADATA_TYPE_LINE_ITEM="lineItem",EntityVO.TICKET_TYPES=[EntityVO.TYPE_INCIDENT,EntityVO.TYPE_WORKORDER,EntityVO.TYPE_TASK,EntityVO.TYPE_SERVICEREQUEST,EntityVO.TYPE_CHANGE,EntityVO.TYPE_PROBLEM,EntityVO.TYPE_KNOWNERROR,EntityVO.TYPE_RELEASE],EntityVO.ALL_TYPES=[EntityVO.TYPE_INCIDENT,EntityVO.TYPE_WORKORDER,EntityVO.TYPE_TASK,EntityVO.TYPE_SERVICEREQUEST,EntityVO.TYPE_CHANGE,EntityVO.TYPE_ASSET,EntityVO.TYPE_OUTAGE,EntityVO.TYPE_PROBLEM,EntityVO.TYPE_KNOWNERROR,EntityVO.TYPE_DLP,EntityVO.TYPE_RELEASE,EntityVO.TYPE_ACTIVITY],EntityVO.ALL_METADATA_TYPES=[EntityVO.TYPE_INCIDENT,EntityVO.TYPE_WORKORDER,EntityVO.TYPE_TASK,EntityVO.TYPE_SERVICEREQUEST,EntityVO.TYPE_CHANGE,EntityVO.TYPE_ASSET,EntityVO.TYPE_OUTAGE,EntityVO.TYPE_PROBLEM,EntityVO.TYPE_KNOWNERROR,EntityVO.TYPE_DLP,EntityVO.TYPE_RELEASE,EntityVO.TYPE_ACTIVITY,EntityVO.TYPE_BROADCAST,EntityVO.TYPE_KNOWLEDGE,EntityVO.TYPE_PERSON,EntityVO.METADATA_TYPE_GLOBAL,EntityVO.METADATA_TYPE_PURCHASE_ORDER,EntityVO.METADATA_TYPE_LINE_ITEM],EntityVO.ENTITIES_WITH_APPROVALS=[EntityVO.TYPE_CHANGE,EntityVO.TYPE_RELEASE],EntityVO.ENTITIES_HAVE={approvals:[EntityVO.TYPE_CHANGE,EntityVO.TYPE_RELEASE],attachments:[EntityVO.TYPE_INCIDENT,EntityVO.TYPE_WORKORDER,EntityVO.TYPE_TASK,EntityVO.TYPE_CHANGE,EntityVO.TYPE_PROBLEM,EntityVO.TYPE_RELEASE],metadata:[EntityVO.TYPE_ASSET,EntityVO.TYPE_INCIDENT,EntityVO.TYPE_WORKORDER,EntityVO.TYPE_TASK,EntityVO.TYPE_SERVICEREQUEST,EntityVO.TYPE_OUTAGE,EntityVO.TYPE_BROADCAST,EntityVO.TYPE_CHANGE,EntityVO.TYPE_PROBLEM,EntityVO.TYPE_RELEASE]},EntityVO.ENTITIES_WITH_NEW_CUSTOMIZATION=[EntityVO.TYPE_INCIDENT,EntityVO.TYPE_CHANGE,EntityVO.TYPE_WORKORDER,EntityVO.TYPE_TASK],EntityVO.TYPE_RESOURCE="resource",EntityVO.TYPE_LINKEDITEM="linkeditem",EntityVO.TYPE_RELATEDTO="relatedto",EntityVO.TYPE_DUPLICATEOF="duplicateof",EntityVO.TYPE_ORIGINALOF="originalof",EntityVO.TYPE_CAUSED="caused",EntityVO.TYPE_CAUSEDBY="causedby",EntityVO.TYPE_CHANGEDBY="changedby",EntityVO.TYPE_INSTALLEDBY="installedby",EntityVO.TYPE_MOVEDBY="movedby",EntityVO.TYPE_REMOVEDBY="removedby",EntityVO.TYPE_REPAIREDBY="repairedby",EntityVO.TYPE_UPGRADEDBY="upgradedby",EntityVO.TYPE_RESOLVED="resolved",EntityVO.TYPE_RESOLVEDBY="resolvedby",EntityVO.TYPE_IMPACTS="impacts",EntityVO.TYPE_IMPACTEDBY="impactedby",EntityVO.TYPE_RESTORES="restores",EntityVO.TYPE_RESTOREDBY="restoredby",EntityVO.TYPE_REOPENEDFROM="reopenedfrom",EntityVO.TYPE_REOPENEDBY="reopenedby",EntityVO.TYPE_USEDBY="usedby",EntityVO.TYPE_CORRECTEDBY="correctedby",EntityVO.TYPE_CREATED="created",EntityVO.TYPE_INVESTIGATEDBY="investigatedby",EntityVO.TYPE_COMPONENT="component",EntityVO.TYPE_DEPENDENCY="dependency",EntityVO.TYPE_IMPACT="impact",EntityVO.TYPE_MEMBEROFCOLLECTION="memberofcollection",EntityVO.TYPE_HOSTEDSYSTEMCOMPONENTS="hostedsystemcomponents",EntityVO.TYPE_HOSTEDACCESSPOINT="hostedaccesspoint",EntityVO.TYPE_HOSTEDSERVICE="hostedservice",EntityVO.TYPE_ACCOUNTONSYSTEM="accountonsystem",EntityVO.TYPE_ELEMENTLOCATION="elementlocation",EntityVO.TYPE_SETTINGSOF="settingsof",EntityVO.TYPE_ALLRELATED="allrelated",EntityVO.TYPE_PEOPLETYPE="peopleType",EntityVO.TYPE_SOFTWARE="Software",EntityVO.TYPE_HARDWARE="Hardware",EntityVO.TYPE_BUSINESSSERVICE="Business Service",EntityVO.TYPE_NETWORK="Network",EntityVO.TYPE_OTHER="OTHER",EntityVO.FIELD_CHANGE_RISK="changeRisk",EntityVO.FIELD_CHANGE_PRIORITY="priority",EntityVO.FIELD_RISK_LEVEL="riskLevel",EntityVO.WIDGET_IMPACTED_AREAS="impactedAreas",EntityVO.FIELD_REQUESTED_BY_COMPANY="requestedByCompany",EntityVO.ACTION_REOPEN="reopen",EntityVO.ACTION_REQUESTAGAIN="requestagain",EntityVO.ACTION_CANCEL="cancel",EntityVO.ACTION_DUPLICATE="duplicate",EntityVO.SOCIAL_PROFILE_USER="user",EntityVO.SOCIAL_PROFILE_ASSET="asset",EntityVO.SOCIAL_PROFILE_LOCATION="location",EntityVO.SOCIAL_PROFILE_SERVICE="service",EntityVO.SOCIAL_PROFILE_GROUP="group",EntityVO.SOCIAL_PROFILE_APP="application",EntityVO.CATEGORY_OPERATIONAL="operational",EntityVO.CATEGORY_PRODUCT="product",EntityVO.CATEGORY_RESOLUTION="resolution",EntityVO.CATEGORY_RESOLUTION_PRODUCT="resolutionProduct",EntityVO.CHATOPS_DETAILS="/details",EntityVO.CHATOPS_KNOWLEDGE="/knowledge",EntityVO.CHATOPS_SIMILARINCIDENTS="/similarincidents",EntityVO.CHATOPS_TOOLS="/?",EntityVO.CHATOPS_INCIDENT="/incident",EntityVO.CHATOPS_INCIDENTDETAILS="/incidentDetails",EntityVO.CHATOPS_LINKKNOWLEDGE="/linkKnowledge",EntityVO.CHATOPS_ERROR="/error",EntityVO.CHATOPS_SWARM="/swarm",EntityVO.STATUS_CLOSED="closed",EntityVO.STATUS_RESOLVED="resolved",EntityVO.STATUS_IN_PROGRESS="Work In Progress",EntityVO.STATUS_DRAFT="Draft",EntityVO.STATUS_CONTENT_REVIEW="Optional Review 1",EntityVO.STATUS_SME_REVIEW="SME Review",EntityVO.STATUS_IN_INVENTORY="In Inventory",EntityVO.CHAT_STATUS_ONLINE="online",EntityVO.CHAT_STATUS_AWAY="away",EntityVO.CHAT_STATUS_OFFLINE="offline",EntityVO.APPROVAL_STATUS_REJECTED="Rejected",EntityVO.APPROVAL_STATUS_APPROVED="Approved",EntityVO.APPROVAL_STATUS_HOLD="Hold",EntityVO.APPROVAL_STATUS_PENDING="Pending",EntityVO.APPROVAL_STATUS_MORE_INFO="More Information",EntityVO.PENDING_APPROVAL_STATUSES_LIST=[EntityVO.APPROVAL_STATUS_HOLD,EntityVO.APPROVAL_STATUS_PENDING,EntityVO.APPROVAL_STATUS_MORE_INFO],EntityVO.APPROVAL_ACTIONS=[{name:"approve",statusLabel:EntityVO.APPROVAL_STATUS_APPROVED},{name:"reject",statusLabel:EntityVO.APPROVAL_STATUS_REJECTED},{name:"hold",statusLabel:EntityVO.APPROVAL_STATUS_HOLD}],EntityVO.FILTER_TYPE_TICKETS="tickets",EntityVO.FILTER_TYPE_PERSON="person",EntityVO.FILTER_TYPE_ASSET="asset",EntityVO.FILTER_TYPE_KNOWLEDGE="knowledge",EntityVO.COGNITIVE_SG_APPLY_AUTO="Apply Automatically",EntityVO.COGNITIVE_SG_SHOW_RECOMMENDATION="Show Recommendation",EntityVO.COGNITIVE_SG_NO="No",EntityVO.prototype.getProps=function(){return["entityId","type","displayValue","classId"]},EntityVO.prototype.postBuild=function(){this.type===EntityVO.TYPE_EMAIL_LINK?this.entityLink="mailto:"+this.displayValue:this.type===EntityVO.TYPE_INTEGER?this.entityLink="javascript:void(0)":this.type===EntityVO.TYPE_ASSET?this.entityLink="#/"+this.type+"/"+encodeURIComponent(this.entityId)+"/"+this.classId:this.type===EntityVO.TYPE_URL?this.entityLink=decodeURIComponent(this.entityId):this.entityLink="#/"+this.type+"/"+encodeURIComponent(this.entityId)},EntityVO.entityHas=function(e,t){if(e)var a=this.ENTITIES_HAVE[e];return _.includes(a||[],t)},EntityVO.hasApprovalsFlow=function(e){return this.entityHas("approvals",e)},EntityVO.hasMetadata=function(e){var t=[this.TYPE_ASSET,this.TYPE_INCIDENT,this.TYPE_WORKORDER,this.TYPE_TASK,this.TYPE_SERVICEREQUEST,this.TYPE_OUTAGE,this.TYPE_KNOWLEDGE,EntityVO.TYPE_BROADCAST,EntityVO.TYPE_CHANGE,EntityVO.TYPE_PROBLEM,EntityVO.TYPE_KNOWNERROR,EntityVO.TYPE_RELEASE,EntityVO.TYPE_ACTIVITY];return _.includes(t,e)},EntityVO.hasAttachments=function(e){var t=[this.TYPE_INCIDENT,this.TYPE_WORKORDER,this.TYPE_TASK,this.TYPE_RELEASE,this.TYPE_CHANGE,this.TYPE_PROBLEM,this.TYPE_KNOWNERROR];return _.includes(t,e)},GlobalSearchItemVO.prototype=new BaseVO,GlobalSearchItemVO.prototype.constructor=GlobalSearchItemVO,GlobalSearchItemVO.prototype.getProps=function(){var e=Object.keys(new GlobalSearchItemVO);return BaseVO.prototype.getProps().concat(e)},GlobalSearchItemVO.prototype.getRating=function(e){return e?Math.round(this.additionalInformation.rating):Math.round(this.additionalInformation.useCount/(+this.additionalInformation.useCount+ +this.additionalInformation.notUsefulCount)*100)||0},GlobalSearchItemVO.prototype.getNumberOfViews=function(){return _.isUndefined(this.additionalInformation.viewCount)||null===this.additionalInformation.viewCount?-1:this.additionalInformation.viewCount},GlobalSearchItemVO.prototype.getNumberOfLinkedItems=function(){return _.isUndefined(this.additionalInformation.linkedItems)||null===this.additionalInformation.linkedItems?-1:this.additionalInformation.linkedItems},GlobalSearchItemVO.prototype.getLastModifyDate=function(){return this.additionalInformation.modifiedDate},GlobalSearchItemVO.prototype.getStatus=function(){return this.additionalInformation.status.value},GlobalSearchItemVO.prototype.getAssigneeFullName=function(){return this.additionalInformation.assignee&&this.additionalInformation.assignee.fullName},GlobalSearchItemVO.prototype.isDecisionTree=function(){return"Decision Tree"===this.templateName},GlobalSearchItemVO.prototype.isArticleActive=function(){var e=this.realObject||this.additionalInformation;return this.type!==EntityVO.TYPE_KNOWLEDGE||["Cancelled","Retire Approval","Retired","Closed Version"].indexOf(e&&e.status&&e.status.value)===-1},GlobalSearchItemVO.prototype.postBuild=function(){this.subType=this.additionalInformation.isAutomatic?"-auto":""},HistoryVO.prototype=Object.create(BaseVO.prototype),HistoryVO.prototype.constructor=HistoryVO,HistoryVO.prototype.getProps=function(){var e=Object.keys(new HistoryVO);return BaseVO.prototype.getProps().concat(e)},HistoryVO.prototype.postBuild=function(){this.ticketType=this.type,this.type===EntityVO.TYPE_KNOWLEDGE?(this.summary=this.title,this.displayId=this.articleId):this.type===EntityVO.TYPE_SBEREQUEST?(this.summary=this.serviceName,this.displayId=this.id):this.type=EntityVO.TYPE_TICKET},LocationVO.prototype=Object.create(BaseVO.prototype),LocationVO.prototype.constructor=LocationVO,LocationVO.SCALE_LEVELS=[100,50,25],LocationVO.MAP_TYPE="floormap",LocationVO.GMAP_MAX_ZOOM=10,LocationVO.GMAP_MIN_ZOOM=8,LocationVO.GMAP_TILE_SIZE=256,LocationVO.DEFAULT_SCALE=100,LocationVO.prototype.getProps=function(){return["entityId","type","displayValue"]},MetadataVO.prototype=new BaseVO,MetadataVO.prototype.constructor=MetadataVO,MetadataVO.prototype.getProps=function(){var e=Object.keys(new MetadataVO);return BaseVO.prototype.getProps().concat(e)},MetadataVO.prototype.postBuild=function(){this.allCategories=this.categories.concat(this.resCategories),_.forEach(this.allCategories,function(e){e.listOfTiersToShow=angular.copy(e.listOfTiersToShow).reverse()}),"broadcast"===this.metadatatype&&0===this.requiredOOTBObjectName.length&&this.requiredOOTBObjectName.push("desc");var e,t=!0;_.forEach(this.workinfoTypes,function(a){"section"===a.type?(a.options=[],a.expanded=t,e=a,t&&(t=!1)):e&&(e.options.push(a),a.hasParentSection=!0)})},OrganizationVO.prototype=new BaseVO,OrganizationVO.prototype.constructor=OrganizationVO,OrganizationVO.prototype.getProps=function(){return BaseVO.prototype.getProps().concat("name","attributeMap")},OrganizationVO.prototype.postBuild=function(){this.companyName=this.attributeMap.companyName},PersonVO.prototype=new BaseVO,PersonVO.prototype.constructor=PersonVO,PersonVO.prototype.getProps=function(){return BaseVO.prototype.getProps().concat("firstName","lastName","fullName","department","email","company","phone","thumbnailMime","thumbnail","site","organization","loginId","personId","available","jid","supportGroups")},PersonVO.prototype.postBuild=function(){this.supportGroups&&this.supportGroups[0]&&this.supportGroups[0].name&&(this.supportGroup=this.supportGroups[0].name,this.supportGroupId=this.supportGroups[0].id,this.supportOrganization=this.supportGroups[0].organization?this.supportGroups[0].organization:"")},SiteVO.prototype=new BaseVO,SiteVO.prototype.constructor=SiteVO,SiteVO.prototype.getProps=function(){return BaseVO.prototype.getProps().concat("name","region","siteGroup","address","companyName","id")},SLAVO.prototype=new BaseVO,SLAVO.prototype.constructor=SLAVO,SLAVO.MEASUREMENT_STATUS_IN_PROGRESS="1",SLAVO.MEASUREMENT_STATUS_PENDING="2",SLAVO.MEASUREMENT_STATUS_MET="4",SLAVO.MEASUREMENT_STATUS_MISSED="5",SLAVO.MEASUREMENT_STATUS_MISSED_GOAL="7",SLAVO.MEASUREMENT_STATUS_WARNING="9",SLAVO.prototype.getProps=function(){return BaseVO.prototype.getProps().concat("parentId","title","goal","startTime","endTime","measurementStatus","metMissedAmount","overallStopTime","downStartTime","upStartTime","downElapsedTime","upElapsedTime","warningDate","slaType","warningDate","warningPercentage")},SLAVO.prototype.postBuild=function(){this.processIconClass()},SocialProfileVO.prototype=new BaseVO,SocialProfileVO.prototype.constructor=SocialProfileVO,SocialProfileVO.prototype.getProps=function(){return BaseVO.prototype.getProps().concat("jid","elementId","available","deleted","desc","displayName","firstName","lastName","tenantId","profileType","extraData","thumbnail");
},SocialProfileVO.prototype.postBuild=function(){this.elementId.indexOf(" ")>=0&&(this.elementId=this.elementId.replace(/\s+/g,"_"),this.jid&&(this.jid=this.jid.replace(/\s+/g,"_"))),this.extraData=this.extraData?JSON.parse(this.extraData):{},this.available=this.available||"UNKNOWN",this.jid=this.jid||[this.elementId,this.tenantId].join("_")},SupportGroupVO.prototype=new BaseVO,SupportGroupVO.prototype.constructor=SupportGroupVO,SupportGroupVO.prototype.getProps=function(){return BaseVO.prototype.getProps().concat("name","organization","cognitiveFlag","autoRecommended","company")},SupportGroupVO.prototype.postBuild=function(){this.companyName=this.company.name,this.companyName&&this.organization&&(this.companyAndOrganization=this.companyName+" > "+this.organization)},TicketVO.prototype=Object.create(BaseVO.prototype),TicketVO.prototype.constructor=TicketVO,TicketVO.prototype.getProps=function(){return BaseVO.prototype.getProps().concat("displayId","modifiedDate","summary","priority","desc","numAttachments","status","assignee","supportGroup","serviceTargets","customer","contact","categorizations","customFields","dynamicFields","following","accessMappings","company","locationCompany","ownerGroup")},TicketVO.prototype.isOngoing=function(){return!this.isPaused()&&!this.isClosed()},TicketVO.prototype.isPaused=function(){return"Pending"===this.status.value||"Waiting Approval"===this.status.value||"Waiting"===this.status.value},TicketVO.prototype.isResolved=function(){return"Closed"===this.status.value||"Resolved"===this.status.value||"Completed"===this.status.value},TicketVO.prototype.isCancelled=function(){return"Cancelled"===this.status.value||"Rejected"===this.status.value||"Bypassed"===this.status.value},TicketVO.prototype.isClosed=function(){return this.isResolved()||this.isCancelled()},TicketVO.prototype.postBuild=function(){_.isEmpty(this.accessMappings)?this.accessMappings={detailsEditAllowed:!0,summaryEditAllowed:!0,statusEditAllowed:!0,timelineEditAllowed:!0,relationsEditAllowed:!0,relationsDeleteAllowed:!0,priorityEditAllowed:!0,coordinatorEditAllowed:!0,tasksEditAllowed:!0,requestedforEditAllowed:!0,incidentTypeEditAllowed:!0,coordinatorSelfAssignmentAllowed:!0}:this.accessMappings=(new AccessMappingVO).parseAccessMap(this.accessMappings,this.type),this.dynamicFields=_.sortBy(this.dynamicFields.map(function(e){return e.editable=!0,e.isDynamic=!0,(new FieldVO).build(e)}),"displayOrder"),null===this.company&&(this.company=this.customer?this.customer.company:null)},function(){angular.module("myitsmApp").directive("approvalBanner",["approvalModel","approvalService","events","systemAlertService","$filter","userModel","$window","authModel",function(e,t,a,n,i,o,r,s){return{restrict:"E",replace:!0,templateUrl:"views/approval/approval-banner.html",scope:{context:"="},link:function(l){function c(t){return l.state.approvalRequestIsPending=!0,e.getListOfApprovers(l.context,t).then(function(e){l.approval=e,l.context.approvalList=l.approval.approvalList,d()})["finally"](function(){l.state.approvalRequestIsPending=!1})}function d(){_.forEach(l.approval.approvalList&&l.approval.approvalList.open,function(e){e.userIsAlternateApprover&&l.state.alternateFor.push(e.approver.fullName)}),l.state.isAlternateApprover=!!l.state.alternateFor.length}function u(){var e=decodeURIComponent(o.userId),t=[];return _.forEach(l.approval.approvalSummaries,function(a){if(EntityVO.PENDING_APPROVAL_STATUSES_LIST.indexOf(a.status.value)>=0&&a.type===EntityVO.TYPE_PERSON&&(a.approver.id===e||a.userIsAlternateApprover)){var n={type:l.review.type,parentId:l.context.id,parentType:l.context.type,signatureId:a.signatureId,justification:l.review.justification,processName:l.context.approvalProcessName};l.review.password&&(n.password=l.review.password),t.push(n)}}),t}l._=_,l.init=function(){l.isSSOEnabled=!1,l.approval={},l.state={approvalRequestIsPending:!0,isAlternateApprover:!1,alternateFor:[],iconClass:{approve:"icon-check_shield",reject:"icon-cross_square",hold:"icon-sandglass"}},l.review={type:"",justification:"",justificationRequired:!1},l.reviewActions=EntityVO.APPROVAL_ACTIONS,c(!0),l.$on(a.REFRESH_APPROVAL_LIST,function(e,t){c(t&&t.ignoreCache)}),l.isSSOEnabled=s.isSSOEnabled()},l.clearApprovalData=function(){l.review={type:"",justification:"",justificationRequired:!1}},l.checkForRequirement=function(e){l.review.justificationRequired=e.statusLabel===EntityVO.APPROVAL_STATUS_REJECTED},l.handleUserReviewAction=function(){l.sendUserReview().then(function(){l.clearApprovalData(),l.approval.isUserApprovalPending=!1})},l.handleUserReviewActionViaSSO=function(){r.open("/smartit/rest/sso/validate-reauth?reauth=true")},r.approvalCallback=function(){console.log("Done with RSSO now submit approval!"),l.handleUserReviewAction()},r.approvalFailedCallback=function(){l.$apply(function(){l.handleUserReviewError()})},l.handleUserReviewError=function(){var e=i("i18n")("approval.error.sso.change");l.context.type===EntityVO.TYPE_KNOWLEDGE?e=i("i18n")("approval.error.sso.knowledge"):l.context.type===EntityVO.TYPE_RELEASE&&(e=i("i18n")("approval.error.sso.release")),n.error({text:e,clear:!1})},l.showApproversList=function(){l.context.approvalList=l.approval.approvalList;var e=!0;l.approval.approvalList&&Array.isArray(l.approval.approvalList.open)&&l.approval.approvalList.open.length>0&&(e=!1),t.showApproversDialog(l.context.approvalList,l.context,e)},l.sendUserReview=function(){l.state.approvalRequestIsPending=!0;var t=u();return e.sendReviewResult(t).then(function(){l.$emit(a.APPROVE_UPDATING_COMPLETE),l.$emit(a.TICKET_PROFILE_RESEND_EVENT,{eventName:a.REFRESH_ACTIVITY_FEED}),n.success({text:i("i18n")("approval.updating.complete"),hide:1e4})})["finally"](function(){l.state.approvalRequestIsPending=!1})},l.init()}}}])}(),function(){angular.module("myitsmApp").factory("approvalModel",["approvalService","$q","systemAlertService","$filter",function(e,t,a,n){var i={approvals:[]};return i.getListOfApprovers=function(a,n){var o={id:a.id,type:a.type};return i.approvals[a.id]&&!n?t.when(i.approvals[a.id]):(i.approvals[a.id]=e.getListOfApprovers(o)["finally"](function(){i.getListOfApproversPromise=null}),t.when(i.approvals[a.id]))},i.sendReviewResult=function(o){return i.approvals[o[0].parentId]=angular.noop(),e.sendReviewResult(o)["catch"](function(e){if(e){var i,o=/ERROR\s[(](\d+)[)]/,r=e.data?e.data.error:e.error,s=o.exec(r);s&&(i=parseInt(s[1]),45490===i&&(r=n("i18n")("approval.error.46490"))),a.error({text:r,clear:!1})}return t.reject(e)})},i.getApproverByText=function(t){return e.getApproverByText(t)},i.addApprover=function(t,a,n,i,o){return e.addApprover(t,a,n,i,o)},i.clearListOfApproversCache=function(e){i.approvals[e]&&delete i.approvals[e]},i}])}(),function(){angular.module("myitsmApp").service("approvalService",["$resource","$q","$modal",function(e,t,a){function n(e){var t;try{t=e[0].items[0][0].responseObject}catch(a){t={approvalSummaries:[]}}return t.approvalSummaries&&t.approvalSummaries.length>0&&(o.getApprovals(t),t.approvalList.rejected.length&&(t.approvalList.closed=(t.approvalList.closed||[]).concat(t.approvalList.rejected||[])),t.groupedSummary=_.groupBy(t.approvalSummaries,function(e){return e.status.name=e.status.value?e.status.value.split(" ").join("_").toLowerCase():"",e.status.value}),_.each(t.approvalSummaries,function(e){if("person"===e.type){var t=e.approver;e.approver=(new PersonVO).build(t)}})),t||{approvalSummaries:[],isUserApprovalPending:!1,groupedSummary:{}}}var i=e("",{},{useApprovalAPI:{url:"/smartit/rest/approval",method:"POST",isArray:!0},getApproverByText:{url:"/smartit/rest/person/search",method:"GET",isArray:!0},addApprover:{url:"/smartit/rest/approval",method:"POST",isArray:!0}}),o=this;this.getListOfApprovers=function(e){var a,o=Object.prototype.toString.call(e).slice(8,-1);if("Object"!==o)return t.when({error:"Bad input parameter. Request cancelled"});if(e.id&&e.type)a={parentId:e.id,parentType:e.type};else{if(!e.parentId||!e.parentType)return t.when({error:"Missing required parameter. Request cancelled"});a=e}return a.type="getListOfApprovers",i.useApprovalAPI(null,[a]).$promise.then(function(e){return n(e)})},this.sendReviewResult=function(e){return i.useApprovalAPI(null,e).$promise},this.getApprovals=function(e){e.approvalSummaries&&(e.approvalList={closed:[],open:[],rejected:[]},_.forEach(e.approvalSummaries,function(t){var a=t.status.value;_.includes(["Approved","Cancelled","Closed","Error"],a)?e.approvalList.closed.push(t):"Rejected"===a?e.approvalList.rejected.push(t):e.approvalList.open.push(t)}))},this.showApproversDialog=function(e,t,n){return a.open({templateUrl:"views/approval/approvals-action-blade.html",windowClass:"action-blade",controller:"ApproversDialogController",resolve:{changeApprovalParams:function(){return{approvalList:e,id:t&&t.id,type:t&&t.type,statusValue:t&&t.status.value,addApproverAllowed:t&&t.accessMappings&&t.accessMappings.addApproverEditAllowed,showClosedTabDefault:n}}}})},this.getApproverByText=function(e){var t={role:"approver",name:e,thumbnail:"true"};return i.getApproverByText(t).$promise.then(function(e){return e[0].items})},this.addApprover=function(e,t,a,n,o){var r=[{parentId:a,parentType:n,type:e,status:o,approverId:t}];return i.addApprover(null,r).$promise.then(function(e){return e[0].items[0][0]})}}])}(),function(){angular.module("myitsmApp").controller("ApproversDialogController",["$scope","changeApprovalParams","approvalModel","systemAlertService","$timeout","searchModel","$q","i18nService","events","$rootScope","configurationModel",function(e,t,a,n,i,o,r,s,l,c,d){function u(){return y.loadingOrganizations=!0,o.getApproverSupportOrganizations(null,e.assigneeCompany.name,null,e.ticketType).then(function(e){return y.loadingOrganizations=!1,e.length>=o.organizationChunkSize?(y.tooManyOrganizations=!0,[]):(e.length&&"All"!==e[0].id&&e.unshift(E),y.tooManyOrganizations=!1,e)})}function p(){return y.loadingGroups=!0,o.getApproverSupportGroups(null,e.assigneeCompany.name,"All"===e.assigneeOrganization.id?null:e.assigneeOrganization.name,null,e.ticketType).then(function(e){return y.loadingGroups=!1,y.tooManySupportGroups=e.exceedsChunkSize,e.supportGroups})}function m(e){e&&e.statusInfo&&2e3===e.statusInfo.number?i(function(){f()},500):n.error({text:e&&e.statusInfo&&e.statusInfo.message,clear:!1})}function f(){e.state.loadingApprovers=!0,a.getListOfApprovers(t,!0).then(function(t){t&&t.approvalList&&(e.closedList=g(t.approvalList.closed),e.openList=h(t.approvalList.open),c.$broadcast(l.REFRESH_APPROVAL_LIST,{ignoreCache:!1}))})["finally"](function(){e.state.loadingApprovers=!1})}function g(e){var t=[],a={};return _.forEach(e,function(e){var n=_.cloneDeep(e);return n.alternateApprover?void(a[n.signatureId]?a[n.signatureId].approvedFor.push(n.approver.fullName):(n.approvedFor=[n.approver.fullName],n.approver=n.alternateApprover,a[n.signatureId]=n)):void t.push(n)}),t.concat(_.values(a))}function h(e){var t={singleApprovers:[],multipleApprovers:[]},a=_.groupBy(e,"signatureId");return _.forEach(a,function(e){e.length<2?t.singleApprovers=t.singleApprovers.concat(e):t.multipleApprovers.push(e)}),t}var y={loadingApprovers:!1,loadingApproverSearch:!1,loadingCompanies:!1,loadingOrganizations:!1,loadingGroups:!1,tooManyCompanies:!1,tooManyOrganizations:!1,tooManySupportGroups:!1},E={name:s.getLocalizedString("assignBlade.organization.all"),id:"All"};e.state=y,e.addApproverAllowed=t.addApproverAllowed,e.ticketType=t.type,e.showClosedTabDefault=t.showClosedTabDefault,e.approverSelected=!1,e.approver={},e.assigneeCompany={},e.assigneeOrganization={},e.assigneeGroup=null,e.companies=[],e.organizations=[],e.groups=[],e.showMailstopOnPersoncard=d.showMailstopOnPersoncard,e.showPhoneNumOnPersonCard=d.showPhoneNumOnPersonCard,t.approvalList?(e.closedList=g(t.approvalList.closed),e.openList=h(t.approvalList.open)):f(),e.$watch("approver.model",function(t){e.approverSelected=_.isObject(t)}),e.enableSearchApprover=function(){e.showSearchApprover=!0,e.showSearchApprovalGroup=!1},e.enableSearchApprovalGroup=function(){e.showSearchApprover=!1,e.showSearchApprovalGroup=!0,e.getApproverSupportCompanies()},e.getApproverByText=function(e){return a.getApproverByText(e)},e.getApproverSupportCompanies=function(){return y.loadingCompanies=!0,o.getApproverSupportCompanies(null,null,e.ticketType).then(function(t){y.loadingCompanies=!1,t.length>=o.companyChunkSize?(e.companies=[],y.tooManyCompanies=!0):(e.companies=_.cloneDeep(t),y.tooManyCompanies=!1)})},e.getApproverSupportCompaniesByName=function(t){return o.getApproverSupportCompanies(t,null,e.ticketType).then(function(t){e.companies=_.cloneDeep(t)})},e.getApproverSupportOrganizationsByName=function(t){return o.getApproverSupportOrganizations(t,e.assigneeCompany.name,null,e.ticketType)},e.getApproverSupportGroupsByName=function(t){return o.getApproverSupportGroups(t,e.assigneeCompany.name,"All"===e.assigneeOrganization.id?null:e.assigneeOrganization.name,null,e.ticketType).then(function(e){return e.supportGroups})},e.selectCompany=function(t){e.assigneeCompany=t,e.organizations=[],e.assigneeOrganization=E,e.groups=[],e.assigneeGroup=null;var a=[];e.assigneeCompany.name&&(a.push(u()),a.push(p())),r.all(a).then(function(t){e.organizations=t[0],e.groups=t[1]})},e.selectOrganization=function(t){e.assigneeOrganization=t,e.groups=[],e.assigneeGroup=null,p().then(function(t){e.groups=t})},e.selectGroup=function(t){e.assigneeGroup=t},e.addApprover=function(){_.isObject(e.approver.model)&&e.approver.model.loginId&&(e.state.loadingApprovers=!0,a.addApprover("addApprover",e.approver.model.loginId,t.id,t.type,t.statusValue).then(m)["finally"](function(){e.state.loadingApprovers=!1}))},e.addApprovalGroup=function(){e.state.loadingApprovers=!0,a.addApprover("addApproverGroup",e.assigneeGroup.id,t.id,t.type,t.statusValue).then(m)["finally"](function(){e.state.loadingApprovers=!1})}}])}(),function(){angular.module("assetModule").controller("AddPeopleController",["$scope","assetModel","configurationModel","userService","searchService","userModel","$q","searchModel","events","systemAlertService","i18nService","$filter","$timeout",function(e,t,a,n,i,o,r,s,l,c,d,u,p){function m(){e.state={dataIsLoading:!1,isPeopleRelationsLoading:!1,tooManyCompanies:!1,dataSearching:!1},e.defaultExceeedChunkSize={company:!1,department:!1,organization:!1,supportgroup:!1},e.typeaheadSearch={text:"",isExceedChunkSize:!1},e.peopleTypes=_.find(a.get("link")[EntityVO.TYPE_PERSON],{type:EntityVO.TYPE_PEOPLETYPE}).relations,e.peopleRelationshipTypes=_.find(a.get("link")[EntityVO.TYPE_PERSON],{type:EntityVO.TYPE_PERSON}).relations,e.selectedType=e.peopleTypes[0],e.selectedRelationshipType=e.peopleRelationshipTypes[0],e.searchPeople={results:[],filter:""},e.company={},e.companyList=[],e.addPeopleData={relationshipType:e.selectedRelationshipType,type:EntityVO.TYPE_PERSON,subType:e.selectedType,selectedPerson:void 0},E=_.debounce(e.doSearch,500)}function f(e){return e?e.trim():""}function g(){var t={relationshipType:e.selectedRelationshipType,type:EntityVO.TYPE_PERSON,subType:e.selectedType};return e.selectedType===EntityVO.TYPE_PEOPLE?t.id=e.selectedPerson.displayId:t.id=e.selectedPerson.id,t.relationshipType=e.selectedRelationshipType,t}function h(){e.close()}function y(){e.searchPeople.text="",e.searchPeople.filter="",e.searchPeople.results=[],e.typeaheadSearch.text=""}var E;e.onSearchTextChange=function(){(e.typeaheadSearch.text.length>2||0===e.typeaheadSearch.text.length)&&(e.state.dataSearching=!0,E())},e.selectPeopleType=function(t){y(),e.selectedType=t,e.addPeopleData.subType=e.selectedType,t!==EntityVO.TYPE_PEOPLE&&e.doSearch()},e.selectRelationshipType=function(t){e.selectedRelationshipType=t,e.addPeopleData.relationshipType=e.selectedRelationshipType},e.selectPerson=function(t){e.selectedPerson=t,e.addPeopleData.selectedPerson=e.selectedPerson},e.addPeopleToAsset=function(){e.state.isPeopleRelationsLoading=!0;var a=g();t.addPeople(a).then(function(){e.state.isPeopleRelationsLoading=!1,e.modalInstance.close()})["catch"](function(t){t.data.results&&t.data.results.error&&c.error({text:t.data.results.error,clear:!1}),e.state.isPeopleRelationsLoading=!1,e.modalInstance.close({error:!0})})},e.changeCompany=function(t){y(),e.company=t,e.doSearch()},e.searchUserByNameDebounce=_.debounce(function(){f(e.searchPeople.text).length>=3&&e.doSearch()},500),e.doSearch=function(){var a,i=r.when(1);a=e.selectedType===EntityVO.TYPE_PEOPLE?r.when(1):s.getOperatingCompanies(null,-1),e.state.dataSearching=!0,a.then(function(a){return e.selectedType!==EntityVO.TYPE_PEOPLE&&(e.companyList=a.companies,e.state.tooManyCompanies=a.exceedsChunkSize,e.company.name||(e.company.name=t.assetDetails.company.name?t.assetDetails.company.name:a[0].name)),e.selectedType===EntityVO.TYPE_PEOPLE?i=n.searchUserByName(f(e.searchPeople.text)):e.selectedType===EntityVO.TYPE_ORGANIZATION?i=s.getOrganizationsByCompany(e.company.name,e.defaultExceeedChunkSize.organization?e.typeaheadSearch.text:""):e.selectedType===EntityVO.TYPE_SUPPORTGROUP?i=s.getSupportGroupsListByText(e.company.name,e.defaultExceeedChunkSize.supportgroup?e.typeaheadSearch.text:""):e.selectedType===EntityVO.TYPE_DEPARTMENT?i=s.getDepartmentsByCompany(e.company.name,e.defaultExceeedChunkSize.department?e.typeaheadSearch.text:""):e.selectedType===EntityVO.TYPE_COMPANY&&(i=o.getOperatingCompaniesByText(e.defaultExceeedChunkSize.company?e.typeaheadSearch.text:"")),i.then(function(t){0===e.typeaheadSearch.text.length&&e.selectedType!==EntityVO.TYPE_PEOPLE&&(e.defaultExceeedChunkSize[e.selectedType]=t.exceedsChunkSize),e.typeaheadSearch.isExceedChunkSize=t.exceedsChunkSize,e.selectedType===EntityVO.TYPE_SUPPORTGROUP?t=e.searchPeople.results=t.supportGroups:e.selectedType===EntityVO.TYPE_COMPANY?t=e.searchPeople.results=t.companies:e.selectedType===EntityVO.TYPE_DEPARTMENT?t=e.searchPeople.results=t.organizations:e.selectedType===EntityVO.TYPE_ORGANIZATION?t=e.searchPeople.results=t.organizations:e.searchPeople.results=t,t.length&&(e.selectedPerson=t[0],e.addPeopleData.selectedPerson=e.selectedPerson)})["catch"](function(e){e&&c.error({text:e.data&&e.data.error||u("i18n")("error.unknown"),clear:!1})})})["finally"](function(){e.state.isPeopleRelationsLoading=!1,e.state.dataSearching=!1})},e.getCompaniesByName=function(e){return s.getCompaniesByText(e).then(function(e){return e.companies})},e.showTypeaheadSearchBox=function(){var t;switch(e.selectedType){case EntityVO.TYPE_COMPANY:e.defaultExceeedChunkSize.company&&(t=!0);break;case EntityVO.TYPE_ORGANIZATION:e.defaultExceeedChunkSize.organization&&(t=!0);break;case EntityVO.TYPE_DEPARTMENT:e.defaultExceeedChunkSize.department&&(t=!0);break;case EntityVO.TYPE_SUPPORTGROUP:e.defaultExceeedChunkSize.supportgroup&&(t=!0);break;default:t=!1}return t},e.close=function(){if(e.searchPeople&&e.searchPeople.results&&e.searchPeople.results.length){var t=c.modal({title:d.getLocalizedString("common.notification.dirty.title"),text:d.getLocalizedString("common.notification.dirty.message"),buttons:[{text:d.getLocalizedString("common.labels.yes"),data:!0},{text:d.getLocalizedString("common.labels.no"),data:!1}]});t.result.then(function(t){t&&e.modalInstance.dismiss()})}else e.modalInstance.dismiss()},e.$on(l.MODAL_BACKDROP_CLICK_PROPOGATE,h),m()}])}(),angular.module("assetModule").directive("addPeople",function(){return{restrict:"E",templateUrl:"views/asset/add-people-action-blade.html",replace:!0,scope:{isConsoleMode:"=",modalInstance:"=",addPeopleData:"=?"},controller:"AddPeopleController"}}),angular.module("assetModule").directive("assetContract",["relationModel","metadataModel","$q",function(e,t,a){return{restrict:"E",replace:!0,scope:{context:"=",isDraft:"="},link:function(n){function i(){a.all([t.getMetadataByType(EntityVO.TYPE_CONTRACT),e.getRelations(n.context.reconciliationId,n.context.ticketType)]).then(function(e){n.metadata=e[0],n.savedContracts=_.filter(e[1],{type:EntityVO.TYPE_CONTRACT})})["finally"](function(){n.state.loadingContracts=!1})}n.state={loadingContracts:!0},n.getSelectedTypeObject=function(e,t){var a=_.find(n.metadata[e],{name:t});return a?a.label:t},i()},templateUrl:"views/resource/asset-contract.html"}}]),function(){angular.module("assetModule").controller("AssetController",["$scope","assetModel","attachmentService","$q","categoriesService","events","$modal","$state","systemAlertService","$filter","metadataModel","userModel","ticketActionService","googleMapService","relationModel","ciExplorerModel","i18nService","configurationModel","screenConfigurationModel","chatModel",function(e,t,a,n,i,o,r,s,l,c,d,u,p,m,f,g,h,y,E,v){function T(t){var a=r.open({templateUrl:"views/common/bcm-credentials-template.html",windowClass:"bcm-credential-alert-modal",controller:"BcmCredentialAlertController"});a.result.then(function(){u.getBCMIntegrationConfig().then(function(a){e.bcmConfig=a,e.bcmConfig.configLoaded&&t&&e.bcmActionsCallbacks[t]()})})}function S(a){var n=r.open({template:'<div class="modal-header system-alert__item_info">{{ "common.labels.loading" | i18n }}</div><div class="modal-body"><div loading-spinner if="true" centered="true"></div></div>',windowClass:"bcm-credential-alert-modal",size:"sm"});t.getBcmFilteredActionsFromServer().then(function(t){I(),n.close(),e.bcmFilteredActions=t,e.bcmActionsCallbacks[a]()})["catch"](function(e){I(),n.close(),"BCM_Unauthorized"===e.data.error?T(a):l.error({text:e.data.error,clear:!1})})}function C(e){var t=l.modal({title:c("i18n")("common.notification.dirty.title"),text:c("i18n")("asset.bcm."+e+".confirm"),buttons:[{text:c("i18n")("common.button.yes"),data:!0},{text:c("i18n")("common.button.no"),data:!1}]});t.result.then(function(t){t&&O(e)})}function O(e){var a=r.open({template:'<div class="modal-header system-alert__item_info">{{ "common.labels.loading" | i18n }}</div><div class="modal-body"><div loading-spinner if="true" centered="true"></div></div>',windowClass:"bcm-credential-alert-modal",size:"sm"});t.performBCMAction(e).then(function(){a.close(),l.success({text:c("i18n")("asset.bcm."+e+".success"),hide:1e4})})["catch"](function(t){a.close(),t.data&&t.data.error&&("BCM_Unauthorized"===t.data.error?T(e):l.error({text:t.data.error,clear:!1}))})}function A(){l.error({text:c("i18n")("error.unauthorized"),clear:!1})}function I(){e.dropDownOptions={actions:[],registeredCallbacks:{}};var a=_.find(e.metadata.assetTypes,{name:e.asset.assetType}),n=_.find(a.subType,{name:t.assetClassId});if(n.putIntoInventory&&e.asset.accessMappings.inventoryEditAllowed){var i=_.clone(y.get("moreActions.asset")),o=e.putIntoInventoryCallbackFuncs;e.asset.status.value===EntityVO.STATUS_IN_INVENTORY?(i.splice(0,1),o=e.takeOutOfInventoryCallbackFuncs):i.splice(1,1),e.dropDownOptions={actions:i,registeredCallbacks:o}}if(e.bcmConfig.integrated&&e.asset.bcmDeviceId){e.bcmFilteredActions=t.getBcmFilteredActions();var r=[{name:"bcmAssetDetails",functionCallback:"showBcmAssetDetails",addTopSeparator:!0,isDisabled:!e.bcmFilteredActions.actions.ConfigSummary},{name:"performAudit",functionCallback:"performAuditFromBCM",addTopSeparator:!0,isDisabled:!e.bcmFilteredActions.actions.PerformAudit},{name:"ping",functionCallback:"pingDeviceFromBCM",isDisabled:!e.bcmFilteredActions.actions.Ping},{name:"reboot",functionCallback:"rebootDeviceFromBCM",isDisabled:!e.bcmFilteredActions.actions.Reboot},{name:"shutdown",functionCallback:"shutdownDeviceFromBCM",isDisabled:!e.bcmFilteredActions.actions.Shutdown},{name:"wakeUp",functionCallback:"wakeupDeviceFromBCM",isDisabled:!e.bcmFilteredActions.actions.WakeUp}];r.forEach(function(t){var a={label:t.name,method:t.functionCallback,addTopSeparator:t.addTopSeparator||!1,isDisabled:t.isDisabled||!1};e.dropDownOptions.actions.push(a),e.dropDownOptions.registeredCallbacks[t.functionCallback]=e.bcmActionsCallbacks[t.functionCallback]})}}function b(){var e=_.cloneDeep(t.assetPeopleRelations);return Object.keys(e).map(function(t){return{key:t,value:e[t]}})}function k(){if(e.assetPeopleRelations=b(),_.isEmpty(t.assetPrimaryContact))e.asset.owner={},e.assetOwner={};else if(_.isEmpty(e.asset.owner)||e.asset.owner.id!==t.assetPrimaryContact.id||e.asset.owner.relationshipType!==t.assetPrimaryContact.relationshipType){var a=t.assetPrimaryContact;e.asset.owner=angular.copy(t.assetPrimaryContact);var n=angular.copy(t.assetPrimaryContact);a.id&&t.getAssetOwnerDetails(a.id).then(function(){e.assetOwner=t.assetOwner,e.assetOwnerNoAccess=!e.assetOwner.loginId,n.content=e.assetOwner,delete n.realObject,e.$emit(o.ADD_CUSTOMER_FROM_ASSET,n)})}}function D(){e.asset=t.assetDetails,t.assetDetails.outageResourceAvailable=1,e.asset&&!_.isEmpty(e.asset.customFields)&&(e.customFieldsAvailable=!0),e.asset.isPoi&&(e.asset.poiInfo.owner&&t.getPoiOwnerDetails(e.asset.poiInfo.owner).then(function(){e.poiOwner=t.poiOwner,e.poiOwnerNoAccess=!e.poiOwner.loginId}),e.asset.poiInfo.floorMapId&&(e.poiFloorMap="/../smartit/rest/getfile/locationFloorMap/"+e.asset.poiInfo.floorMapId),m.isAvailable&&e.asset.poiId&&(e.poiLocationLink="#/location/"+e.asset.poiId)),e.$emit(o.ASSET_DETAILS_LOADED,{asset:t.assetDetails})}function R(){e.assetFlattenRelations=t.flattenRelations}function P(){e.state.isAssetDataLoading=!1}function w(e){return e.realObject.reqType===EntityVO.TYPE_PEOPLE}function L(){e.dirty=!0}function N(){e.dirty=!1}function M(t,a){e.customFieldsAvailable=!0,a.typeSpecific&&(e.typeSpecificCustomFieldsAvailable=!0)}var V=E.getScreenNameByTicketType(EntityVO.TYPE_ASSET);e.ciExplorerModel=g,e.dirty=!1,e.dropDownOptions={},e.customFieldsAvailable=!1,e.typeSpecificCustomFieldsAvailable=!1,e.chatModel=v;var F=!1;e.bcmConfig={},e.setSection=function(t){e.activeSection=t},e.share=function(t){p.showShareDialog(e.asset).result.then(function(){t.currentTarget.focus()},function(){t.currentTarget.focus()})},e.follow=function(){var a=u.userFullData.loginId;return t.followAsset(a,e.asset.reconciliationId)},e.unfollow=function(){var a=u.userFullData.loginId;return t.unfollowAsset(a,e.asset.reconciliationId)},e.toggleFollowingFlag=function(){var t=e.asset.following?e.unfollow:e.follow;t(e.asset).then(function(){e.asset.following=!e.asset.following},function(e){l.error({text:e.data&&e.data.error,clear:!1})})},e.showPrintDialog=function(t){var a=r.open({templateUrl:"views/common/print-action-blade.html",controller:"PrintController",windowClass:"action-blade",size:"extra-lg",resolve:{params:function(){return{entity:e.asset,feed:e.asset.feed,customFieldsAvailable:e.customFieldsAvailable}}}});a.result["finally"](function(){t.currentTarget.focus()})},e.closeExplorer=function(){s.go("asset",{assetId:e.asset.reconciliationId,assetClassId:e.asset.classId})},e.bcmActionsCallbacks={showBcmAssetDetails:function(){e.bcmConfig.usermapped?e.bcmFilteredActions.configLoaded?e.bcmFilteredActions.actions.ConfigSummary?r.open({templateUrl:"views/asset/bcm-asset-action-blade.html",controller:"BcmAssetActionController",windowClass:"action-blade",size:"extra-lg",resolve:{linkParams:function(){return{entity:e.asset}}}}):A():S("showBcmAssetDetails"):T("showBcmAssetDetails")},performAuditFromBCM:function(){e.bcmConfig.usermapped?e.bcmFilteredActions.configLoaded?e.bcmFilteredActions.actions.PerformAudit?O("performAuditFromBCM"):A():S("performAuditFromBCM"):T("performAuditFromBCM")},pingDeviceFromBCM:function(){e.bcmConfig.usermapped?e.bcmFilteredActions.configLoaded?e.bcmFilteredActions.actions.Ping?O("pingDeviceFromBCM"):A():S("pingDeviceFromBCM"):T("pingDeviceFromBCM")},rebootDeviceFromBCM:function(){e.bcmConfig.usermapped?e.bcmFilteredActions.configLoaded?e.bcmFilteredActions.actions.Reboot?C("rebootDeviceFromBCM"):A():S("rebootDeviceFromBCM"):T("rebootDeviceFromBCM")},shutdownDeviceFromBCM:function(){e.bcmConfig.usermapped?e.bcmFilteredActions.configLoaded?e.bcmFilteredActions.actions.Shutdown?C("shutdownDeviceFromBCM"):A():S("shutdownDeviceFromBCM"):T("shutdownDeviceFromBCM")},wakeupDeviceFromBCM:function(){e.bcmConfig.usermapped?e.bcmFilteredActions.configLoaded?e.bcmFilteredActions.actions.WakeUp?O("wakeupDeviceFromBCM"):A():S("wakeupDeviceFromBCM"):T("wakeupDeviceFromBCM")}},e.putIntoInventoryCallbackFuncs={putIntoInventory:function(){var t=r.open({templateUrl:"views/asset/asset-edit-inventory-blade.html",windowClass:"action-blade",controller:"AssetEditInventoryController",backdrop:"custom"});t.result.then(function(){I(),e.$emit(o.ASSET_DETAILS_CHANGED,{eventName:o.REFRESH_ACTIVITY_FEED}),e.$emit(o.ASSET_DETAILS_CHANGED,{eventName:o.REFRESH_RELATED_ITEM_LIST})})}},e.takeOutOfInventoryCallbackFuncs={takeOutOfInventory:function(){var t=r.open({templateUrl:"views/asset/asset-edit-status-blade.html",windowClass:"action-blade",controller:"AssetEditStatusController",backdrop:"custom"});t.result.then(function(){I(),e.$emit(o.ASSET_DETAILS_CHANGED,{eventName:o.REFRESH_ACTIVITY_FEED}),e.$emit(o.ASSET_DETAILS_CHANGED,{eventName:o.REFRESH_RELATED_ITEM_LIST})})}};var x=function(){e.$on("$stateChangeStart",function(t,a,n){if(e.dirty&&e.dirty&&a.name!==EntityVO.TYPE_ASSET){t.preventDefault();var i=l.modal({title:h.getLocalizedString("common.notification.dirty.title"),text:h.getLocalizedString("common.notification.dirty.message"),buttons:[{text:h.getLocalizedString("common.labels.yes"),data:{stateName:a.name,stateParams:n}},{text:h.getLocalizedString("common.labels.no")}]});i.result.then(function(t){_.isEmpty(t)||(e.dirty=!1,s.transitionTo(t.stateName,t.stateParams))})}})};e.$on("new-relations",function(){t.refreshFlattenRelations(t.assetId).then(R)}),e.refreshTicket=function(){delete f.cache[t.assetId],e.init(t.assetId,t.assetClassId),t.refreshFlattenRelations(t.assetId).then(R)},e.init=function(a,o){if(e.isAttributesCollapsed=!1,e.activeSection="dates",e.editHeader=!1,e.asset={},e.asset.owner={},e.assetOwner={},e.poiOwner={},a){e.state={isAssetDataLoading:!0,isPersonRelationsLoading:!0,isAllMetadataLoaded:!1},t.assetOwner={},t.assetDetails={},t.assetId=a,t.assetClassId=o;var r,s,l=d.getMetadataByType(EntityVO.TYPE_ASSET).then(function(t){e.metadata=t||{}}),c=t.getAssetDetailsByID(a,o).then(D)["finally"](P),p=e.isFullVersion?t.getFlattenRelations(a).then(R):n.when(1),m=V?E.loadScreenConfigurationAndCustomFieldLabels(V,EntityVO.TYPE_ASSET):n.when({});u.getBCMIntegrationConfig().then(function(t){e.bcmConfig=t});var f=d.getMetadataByType(EntityVO.TYPE_GLOBAL).then(function(t){e.globalMetadata=t});F?(r=t.refreshPeopleRelations(a),F=!1):r=e.isFullVersion?t.getPeopleRelations(a):t.getPrimaryContact(a),r["finally"](function(){e.state.isPersonRelationsLoading=!1}),s=[l,c,p,r,m,f],n.all(s).then(k)["finally"](function(){var t=_.find(e.metadata.assetTypes,{name:e.asset.type});e.asset.extensionAttrs.primaryCapability&&E.loadDynamicSelectionFieldLabels(EntityVO.TYPE_ASSET,"SHR:SDF:AST-Capabilities",e.asset.extensionAttrs.primaryCapability,null,null,null,null,!0).then(function(t){e.asset.extensionAttrs.primaryCapability=_.find(t.items,function(t){return t.value===e.asset.extensionAttrs.primaryCapability}),e.asset.extensionAttrs.primaryCapability.name=e.asset.extensionAttrs.primaryCapability.value}),e.metadata.configurationParameters=e.globalMetadata&&e.globalMetadata.configurationParameters,e.metadata.allCategories=e.metadata.categories,e.state.isAllMetadataLoaded=!0,e.asset.allCategories=i.populateCategories(e.asset.product.categorizations,e.metadata),e.asset.noCategories=_.filter(e.asset.allCategories,"valueToShow").length,e.asset.typeLabel=t.label,e.asset.subTypeLabel=_.result(_.find(t.subType,function(t){return t.name.toUpperCase()===e.asset.subType.toUpperCase()}),"label"),I(),x()})}},e.handleFileChange=function(t){var n="classId="+e.asset.classId;a.uploadProfileThumbnail(e.asset.reconciliationId,"asset",t,n).then(function(t){t.thumbnail&&(e.asset.thumbnail=t.thumbnail)})["finally"](function(){e.state.uploadingThumbnail=!1})},e.showEditStatusDialog=function(){var t=r.open({templateUrl:"views/asset/asset-edit-status-blade.html",windowClass:"action-blade",controller:"AssetEditStatusController",backdrop:"custom"});t.result.then(function(){e.refreshTicket(),e.$emit(o.ASSET_DETAILS_CHANGED,{
eventName:o.REFRESH_ACTIVITY_FEED})})},e.showPersonDetails=function(e,t){t&&"href"in t.target||w(e)&&s.go(EntityVO.TYPE_PERSON,{id:e.id.replace(/\\\\/g,"\\")})},e.isPeopleType=function(e){return w(e)},e.updateAssetOwner=function(a){if(!a.relationData.id||a.relationData.id===t.assetPrimaryContact.displayId&&a.relationData.relationshipType===t.assetPrimaryContact.relationshipType){if(!a.relationData.id&&t.assetPrimaryContact.id){e.state.isAssetDataLoading=!0;var i={id:t.assetPrimaryContact.id,parentId:t.assetPrimaryContact.parentId,type:t.assetPrimaryContact.type,relationshipType:t.assetPrimaryContact.relationshipType};t.removePeople(i).then(function(){t.refreshPeopleRelations(t.assetId).then(function(){k(),l.success({text:c("i18n")("asset.details.people.removePeople.successMessage"),hide:1e4})})["catch"](function(e){e&&l.error({text:e.data.error,clear:!1})})["finally"](function(){e.state.isAssetDataLoading=!1})})["catch"](function(t){e.state.isAssetDataLoading=!1,t&&l.error({text:t.data.error,clear:!1})})}}else e.state.isAssetDataLoading=!0,f.addRelation({type:"asset",uuid:e.asset.reconciliationId},[a.relationData]).then(function(){if(t.assetPrimaryContact.id){var a={id:t.assetPrimaryContact.id,parentId:t.assetPrimaryContact.parentId,type:t.assetPrimaryContact.type,relationshipType:t.assetPrimaryContact.relationshipType};t.removePeople(a).then(function(){t.refreshPeopleRelations(t.assetId).then(k)["catch"](function(e){e&&l.error({text:e.data.error,clear:!1})})["finally"](function(){e.state.isAssetDataLoading=!1})})["catch"](function(t){e.state.isAssetDataLoading=!1,t&&l.error({text:t.data.error,clear:!1})})}else t.getPeopleRelations(t.assetId).then(k)["catch"](function(e){e&&l.error({text:e.data.error,clear:!1})})["finally"](function(){e.state.isAssetDataLoading=!1})})["catch"](function(t){e.state.isAssetDataLoading=!1,t&&l.error({text:t.data.error,clear:!1})});if(t.assetDetails.site.name!==a.siteData.name&&(void 0!==t.assetDetails.site.name||""!==a.siteData.name)){e.state.isAssetDataLoading=!0;var o={siteRegion:a.siteData.region,siteGroup:a.siteData.siteGroup,siteName:a.siteData.name};t.update(o).then(function(a){e.state.isAssetDataLoading=!1,t.updateCacheAssetDetails(a),a.needsReconciliation&&l.warning({text:c("i18n")("asset.reconWarning"),hide:1e4})})["catch"](function(t){return e.state.isAssetDataLoading=!1,t&&l.error({text:t.data.error,clear:!1}),n.reject(t)})}},e.addRelatedPeople=function(a){var i=r.open({templateUrl:"views/asset/relate-people.html",windowClass:"action-blade",controller:"RelatePeopleController",backdrop:"custom"});i.result.then(function(i){e.state.isPersonRelationsLoading=!0,t.refreshPeopleRelations(t.assetId).then(function(){e.assetRelations=t.assetRelations,e.assetPeopleRelations=b(),i&&i.error||l.success({text:c("i18n")("asset.details.people.addPeople.successMessage"),hide:1e4})})["catch"](function(e){return e&&l.error({text:e.data.error,clear:!1}),n.reject(e)})["finally"](function(){e.state.isPersonRelationsLoading=!1}),a&&a.currentTarget&&a.currentTarget.focus()},function(){a&&a.currentTarget&&a.currentTarget.focus()})},e.removePeople=function(a){var n=l.modal({title:c("i18n")("common.notification.delete.title"),text:c("i18n")("common.notification.delete.message"),buttons:[{text:c("i18n")("controls.action.ok"),data:!0},{text:c("i18n")("controls.action.cancel"),data:!1}]});n.result.then(function(n){if(n){e.state.isPersonRelationsLoading=!0;var i={id:a.id,parentId:a.parentId,type:a.type,relationshipType:a.relationshipType};t.removePeople(i).then(function(){t.refreshPeopleRelations(t.assetId).then(function(){e.assetRelations=t.assetRelations,e.assetPeopleRelations=b(),l.success({text:c("i18n")("asset.details.people.removePeople.successMessage"),hide:1e4})})["catch"](function(e){e&&l.error({text:e.data.error,clear:!1})})["finally"](function(){e.state.isPersonRelationsLoading=!1})})["catch"](function(e){e&&l.error({text:e.data.error,clear:!1})})["finally"](function(){e.state.isPersonRelationsLoading=!1})}})},e.openLaunchActionBlade=function(a){var n=r.open({templateUrl:"views/asset/asset-launch-action-blade.html",controller:"AssetLaunchActionController",windowClass:"action-blade",backdrop:"custom",size:"lg",resolve:{linkParams:function(){return{selectedItem:[e.asset],actionItem:a}}}});n.result.then(function(a){if(a&&a[e.asset.reconciliationId]){var n=!1;_.forEach(a[e.asset.reconciliationId],function(e){e.additionalInformation&&"peopleRelation"===e.additionalInformation.subActionName?F=!0:(e.additionalInformation&&"assetRelation"===e.additionalInformation.subActionName||"assetUpdate"===e.additionalInformation.subActionName)&&(n=!0)}),F&&!n?(e.state.isPersonRelationsLoading=!0,t.refreshPeopleRelations(e.asset.reconciliationId).then(k)["finally"](function(){e.state.isPersonRelationsLoading=!1,F=!1})):n&&e.refreshTicket()}})},e.$on(o.PROFILE_EDIT_HEADER,function(t,a){e.editHeader=a}),e.$on("$destroy",function(){y.isPWAEnabled&&f.deleteCacheById(t.assetId)}),e.$on(o.TOGGLE_EDIT_MODE,L),e.$on(o.EDIT_COMPLETE,N),e.$on(o.TS_CUSTOM_FIELDS_AVAILABLE,M)}])}(),function(){angular.module("assetModule").controller("AssetEditDetailsController",["$scope","$timeout","events","configurationModel","assetModel","metadataModel","$q","systemAlertService","$filter","searchModel",function(e,t,a,n,i,o,r,s,l,c){function d(){r.all([o.getMetadataByType(EntityVO.TYPE_ASSET),i.getAssetDetailsByID(i.assetId,i.assetClassId)]).then(function(t){var a=t[0],n=t[1];e.metadata=angular.copy(a),e.updatedModel=angular.copy(n),e.lifecycleDates={availableDate:{date:void 0,time:void 0},installationDate:{date:void 0,time:void 0},returnDate:{date:void 0,time:void 0},receivedDate:{date:void 0,time:void 0},lastScanDate:{date:void 0,time:void 0},purchaseDate:{date:void 0,time:void 0},disposalDate:{date:void 0,time:void 0}},e.selectedImpact=u("impacts",e.updatedModel.impact),e.selectedPriority=u("priorities",e.updatedModel.priority),e.selectedUrgency=u("urgencies",e.updatedModel.urgency),e.updatedModel.financial||(e.updatedModel.financial={}),e.updatedModel.lifecycleDates||(e.updatedModel.lifecycleDates={}),e.selectedDepreciated=u("depreciated",e.updatedModel.financial.depreciated),_.forOwn(e.updatedModel.lifecycleDates,_.bind(function(e,t){this.lifecycleDates[t]={date:e,time:e}},e))})}function u(t,a){return _.find(e.metadata[t],{name:a})}var p;e.isAssetSaving=!1,e.updatedModel={},e.state={isTooltipOpenCostCenter:!1,exceedsChunkSizeCostCenter:!1,isTooltipOpenManufacturer:!1,exceedsChunkSizeManufacturer:!1,isTooltipOpenSupplier:!1,exceedsChunkSizeSupplier:!1},d(),e.$on(a.TOGGLE_EDIT_MODE,d),e.$on(a.ASSET_UPDATE_PRODUCT_CATEGORY_MANUFACTURER,function(t,a){e.updatedModel.manufacturer=a.productManufacturer}),e.getCompaniesByType=function(a,n){return c.getCompaniesByText(a,-1,{companyType:n}).then(function(a){return"Supplier"===n?e.state.isTooltipOpenSupplier=e.state.exceedsChunkSizeSupplier=a.exceedsChunkSize:"Manufacturer"===n&&(e.state.isTooltipOpenManufacturer=e.state.exceedsChunkSizeManufacturer=a.exceedsChunkSize),t(function(){e.state.isTooltipOpenManufacturer=!1,e.state.isTooltipOpenSupplier=!1},1e4),a.companies})},e.setCompanyByType=function(t,a){e.updatedModel[a]=t.name},e.datePickerOptions={startingDay:n.getWeekStartingDay(),"show-weeks":!1,minDate:moment().year(1970).month(0).date(2),maxDate:moment().year(2038).month(0).date(18)},e.showMeridian=window.showMeridian,e.assetDate={availableDatePicker:{open:!1},installationDatePicker:{open:!1},returnDatePicker:{open:!1},receivedDatePicker:{open:!1},lastScanDatePicker:{open:!1},purchaseDatePicker:{open:!1},disposalDatePicker:{open:!1}},e.updateDateTime=function(t){(e.lifecycleDates[t].date&&!e.lifecycleDates[t].time||!e.lifecycleDates[t].date&&e.lifecycleDates[t].time)&&(e.lifecycleDates[t].time=_.clone(e.lifecycleDates[t].date));var a=moment(e.lifecycleDates[t].time);e.updatedModel.lifecycleDates[t]=moment(e.lifecycleDates[t].date).set("hours",a.get("hours")).set("minutes",a.get("minutes")).format("X")},e.openDatePicker=function(e){e.open=!0},e.isFieldValid=function(){return!(!e.updatedModel||e.updatedModel.type!==EntityVO.TYPE_HARDWARE||"BMC_PRINTER"!==e.updatedModel.classId&&"BMC_MAINFRAME"!==e.updatedModel.classId&&"BMC_COMPUTERSYSTEM"!==e.updatedModel.classId)},e.updateAssetField=function(t,a){"depreciated"===t&&(e.updatedModel.financial.depreciated=a.label),e.updatedModel[t]=a.name},e.getCostCentersByCompany=function(a){return e.loadingCostCenters=!0,i.getCostCentersByCompanyName(a,e.updatedModel.company.name).then(function(a){return e.state.isTooltipOpenCostCenter=e.state.exceedsChunkSizeCostCenter=a.exceedsChunkSize,p&&t.cancel(p),p=t(function(){e.state.exceedsChunkSizeCostCenter=!1,e.state.isTooltipOpenCostCenter=!1},1e4),a.items})["finally"](function(){e.loadingCostCenters=!1})},e.onInputFocusBlur=function(){e.state.isTooltipOpenManufacturer=!1,e.state.isTooltipOpenSupplier=!1,e.state.isTooltipOpenCostCenter=!1},e.updateCostCenter=function(t){e.updatedModel.financial.costCenter=t.value},e.$on(a.SAVE_CHANGES,function(){e.isAssetSaving=!0,null===e.selectedImpact&&(e.updatedModel.impact=""),null===e.selectedUrgency&&(e.updatedModel.urgency="");var t={assetId:e.updatedModel.assetId,description:e.updatedModel.desc,version:e.updatedModel.version,manufacturer:e.updatedModel.manufacturer,supplier:e.updatedModel.supplier,impact:e.updatedModel.impact,priority:e.updatedModel.priority,urgency:e.updatedModel.urgency,systemRole:e.updatedModel.systemRole,serialNumber:e.updatedModel.serialNumber,partNumber:e.updatedModel.partNumber,floor:e.updatedModel.floor,room:e.updatedModel.room,invoiceNumber:e.updatedModel.invoiceNumber,isAssetUpdate:!0};e.updatedModel.financial.invoiceNumber=e.updatedModel.invoiceNumber,_.each(e.updatedModel.financial,function(e,a){t[a]=e}),_.each(e.updatedModel.lifecycleDates,function(e,a){"string"==typeof e&&(e=1e3*e),t[a]=e}),delete t.modifiedDate,e.$emit(a.SAVE_CHANGES_REQUEST,t)}),e.$on(a.SAVE_ALL_CHANGES_COMPLETE,function(t,n){e.isAssetSaving=!1,e.$emit(a.SAVE_CHANGES_COMPLETE),n.needsReconciliation?s.warning({text:l("i18n")("asset.reconWarning"),hide:1e4}):i.updateCacheAssetDetails(n)}),e.$on(a.SAVE_ALL_CHANGES_FAULT,function(t,a){e.isAssetSaving=!1,a&&a.data&&s.error({text:a.data.error,clear:!1})}),e.$on(a.DISCARD_CHANGES,d)}])}(),function(){angular.module("assetModule").controller("AssetEditHeaderController",["$scope","events","assetModel","searchModel","systemAlertService","$filter","$q","createTicketModel",function(e,t,a,n,i,o,r,s){function l(){r.all([a.getAssetDetailsByID(a.assetId,a.assetClassId),n.getOperatingCompanies(null,-1)]).then(function(t){var a=t[1].companies;c=angular.copy(_.head(t)),e.currentAssetCompany=c.company.name,e.updatedModel=c,e.selections.companies=_.cloneDeep(a),e.state.tooManyCompanies=t[1].exceedsChunkSize})["finally"](function(){e.isAssetSaving=!1})}var c={};e.state={tooManyCompanies:!1},e.selections={},e.getList=function(e,t){return s.getList(e,t)},e.getCompaniesByName=function(e){return n.getCompaniesByText(e).then(function(e){return{list:e.companies,exceedsChunkSize:e.exceedsChunkSize}})},e.updateCompanyField=function(t){c.company=t,e.currentAssetCompany=t.name},e.currentAssetCompany="",e.isAssetSaving=!0,l(),e.$on(t.TOGGLE_EDIT_MODE,function(){l(),e.$emit(t.PROFILE_EDIT_HEADER,!0)}),e.$on(t.SAVE_CHANGES,function(){if(!_.isEmpty(c)){e.isAssetSaving=!0;var n={name:c.name,tag:c.tagNumber,companyName:c.company&&c.company.name};n.companyName||(n.companyName=""),a.update(n).then(function(n){e.$emit(t.PROFILE_EDIT_HEADER,!1),e.$emit(t.SAVE_CHANGES_COMPLETE),n.needsReconciliation?i.warning({text:o("i18n")("asset.reconWarning"),hide:1e4}):a.updateCacheAssetDetails(n)})["catch"](function(a){return e.$emit(t.SAVE_ALL_CHANGES_FAULT),a&&i.error({text:a.data.error,clear:!1}),r.reject(a)})["finally"](function(){e.isAssetSaving=!1})}}),e.$on(t.DISCARD_CHANGES,function(){l(),e.$emit(t.PROFILE_EDIT_HEADER,!1)})}])}(),function(){angular.module("assetModule").controller("AssetEditInventoryController",["$scope","assetModel","ticketService","searchModel","userModel","$q","i18nService","systemAlertService","$modalInstance","events",function(e,t,a,n,i,o,r,s,l,c){function d(){T.processing=!0,e.site=S,n.getSitesByCompany(e.company.name).then(function(t){e.sites=t.objects,T.tooManySites=t.exceedsChunkSize})["finally"](y)}function u(){T.loadingInventory=!0;var a={name:e.search.text,company:{name:e.company.name},site:"All"===e.site.id?{}:{name:e.site.name},floor:e.floor,room:e.room,grid:e.grid,bin:e.bin,supportCompany:"All"===e.supportCompany.id?{}:{name:e.supportCompany.name},supportOrganization:"All"===e.supportOrganization.id?{}:{organization:e.supportOrganization.name},supportOwnerGroup:"All"===e.supportGroup.id?{}:{name:e.supportGroup.name},supportOwner:"All"===e.owner.loginId?{}:{fullName:e.owner.fullName}};t.searchInventory(a).then(function(t){var a=t[0].items[0].objects;a.length>=n.inventoryChunkSize?(e.inventories=[],T.tooManyInventories=!0):(e.inventories=_.sortBy(a,"name"),T.tooManyInventories=!1)})["finally"](function(){T.loadingInventory=!1})}function p(e,t,a,i,o,r,s){return n.getSupportGroupsForCompanyAndOrg(e.name,"All"===t.id?"":t.name,a,null,i,o,r,s).then(function(e){return e.supportGroups.length&&"All"!==e.supportGroups[0].id&&e.supportGroups.unshift(A),T.tooManySupportGroups=e.exceedsChunkSize,e.supportGroups})}function m(e,t,a,i,o,r){return n.getSupportOrganizationsByCompany(e,null,t,a,i,o,r).then(function(e){return e.organizations.length&&"All"!==e.organizations[0].id&&e.organizations.unshift(O),T.tooManyOrganizations=e.exceedsChunkSize,e.organizations})}function f(){var t={};return n.getOperatingCompanies(t,-1).then(function(t){e.companies=_.cloneDeep(t.companies),T.tooManyCompanies=t.exceedsChunkSize})}function g(){var t={};return n.getSupportCompanies(t).then(function(t){e.supportCompanies=_.cloneDeep(t),t.length>=n.companyChunkSize?T.tooManySupportCompanies=!0:(t.length&&"All"!==t[0].id&&t.unshift(C),T.tooManySupportCompanies=!1)})}function h(t){t=_.uniqBy(t,function(e){return e.loginId}),e.owners=_.sortBy(t,"fullName")}function y(){T.processing=!1}function E(){e.close()}var v=null,T={processing:!1,loadingInventory:!1,tooManyCompanies:!1,tooManySites:!1,tooManySupportCompanies:!1,tooManyOrganizations:!1,tooManySupportGroups:!1,tooManySupportPeople:!1,tooManyInventories:!1,isDirty:!1},S={name:r.getLocalizedString("asset.actionBlade.editInventory.site.all"),id:"All"},C={name:r.getLocalizedString("asset.actionBlade.editInventory.company.all"),id:"All"},O={name:r.getLocalizedString("assignBlade.organization.all"),id:"All"},A={name:r.getLocalizedString("assignBlade.supportGroup.all"),id:"All"},I={fullName:r.getLocalizedString("asset.actionBlade.editInventory.owner.all"),loginId:"All"};e.company={},e.site={},e.floor="",e.room="",e.grid="",e.bin="",e.supportCompany={},e.supportOrganization={},e.supportGroup={},e.companies=[],e.organizations=[],e.groups=[],e.inventories=[],e.search={text:"",filterText:""},e.selectedInventory={},t.getAssetDetailsByID(t.assetId,t.assetClassId).then(function(t){e.asset=t,e.company=e.asset.company,e.supportCompany=C,f().then(function(){d()}),g().then(function(){e.selectSupportCompany(e.supportCompany)})}),e.selectCompany=function(t){e.company=t,d(),u()},e.selectSite=function(t){T.isDirty=!0,e.site=t,u()},e.getSitesByTextAndCompany=function(t){return n.getSitesByTextAndCompany(t,e.company.name).then(function(e){return{list:e.list,exceedsChunkSize:e.exceedsChunkSize}})},e.selectSupportCompany=function(t){T.isDirty=!0,T.processing=!0,e.supportCompany=t,e.organizations=[],e.supportOrganization=O,e.supportGroup=A,e.owner=I,e.groups=[],e.owners=[];var n=[],i=null,r=null,s=null,l=null;e.supportCompany.name&&(n.push(m(e.supportCompany.name,v,i,r,s,l)),n.push(p(e.supportCompany,e.supportOrganization,v,i,r,s,l)),n.push(a.getPersonsBySupportCompanyAndOrg(e.supportCompany.name,"","",v,null,i,r,s,l))),o.all(n).then(function(t){e.organizations=t[0],e.groups=t[1],(e.groups&&e.groups.length||T.tooManySupportGroups)&&(e.supportGroup=A),T.tooManySupportPeople=t[2].exceedsChunkSize,h(t[2].results)})["finally"](y),u()},e.selectSupportOrganization=function(t){T.processing=!0,e.supportOrganization=t,e.supportGroup={},e.owners=[],e.owner={};var n=[],i=null,r=null,s=null,l=null;n.push(p(e.supportCompany,e.supportOrganization,"",i,r,s,l)),n.push(a.getPersonsBySupportCompanyAndOrg(e.supportCompany.name,"All"===t.id?"":t.name,"","",null,i,r,s,l)),o.all(n).then(function(t){e.groups=t[0],(e.groups.length||T.tooManySupportGroups)&&(e.supportgroup=A),T.tooManySupportPeople=t[1].exceedsChunkSize,h(t[1].results)})["finally"](y),u()},e.selectSupportGroup=function(t){T.isDirty=!0,T.processing=!0,e.supportGroup=t,e.owner={};var n=null,i=null,o=null,r=null;"All"===t.id?a.getPersonsBySupportCompanyAndOrg(e.supportCompany.name,"All"===e.supportOrganization.id?"":e.supportOrganization.name,"",v,null,n,i,o,r).then(function(e){T.tooManySupportPeople=e.exceedsChunkSize,h(e.results)})["finally"](y):a.getPersonsBySupportGroupId(e.supportGroup.id,"",v,null).then(function(e){T.tooManySupportPeople=e.exceedsChunkSize,h(e.results)})["finally"](y),u()},e.selectOwner=function(t){T.isDirty=!0,e.owner=t,u()},e.onSearchTextChanged=function(){T.isDirty=!0,e.search.text.length>2?u():e.inventories=[]},e.onInputTextChanged=function(){T.isDirty=!0,u()},e.selectInventory=function(t){T.isDirty=!0,e.selectedInventory=t},e.isSaveButtonDisabled=function(){return!e.selectedInventory.name},e.submit=function(){T.processing=!0,t.putIntoInventory(t.assetId,t.assetClassId,e.selectedInventory).then(function(e){t.updateCacheAssetDetails(e),l.close()})["catch"](function(e){return e&&s.error({text:e.data.error,clear:!1}),o.reject(e)})["finally"](y)},e.getOwnersByName=function(t){e.owner={},"All"===e.supportGroup.id?a.getPersonsBySupportCompanyAndOrg(e.supportCompany.name,"All"===e.supportOrganization.id?"":e.supportOrganization.name,t,v,null).then(function(e){T.tooManySupportPeople=e.exceedsChunkSize,h(e.results)}):a.getPersonsBySupportGroupId(e.supportGroup.id,t,v,null).then(function(e){T.tooManySupportPeople=e.exceedsChunkSize,h(e.results)})},e.getSupportGroupsForCompanyAndOrgByName=function(t){return n.getSupportGroupsForCompanyAndOrgByName(e.supportCompany.name,"All"===e.supportOrganization.id?"":e.supportOrganization.name,t,n.supportGroupChunkSize)},e.getSupportOrganizationsByTextAndCompany=function(t){return n.getSupportOrganizationsByTextAndCompany(t,e.supportCompany.name,n.organizationChunkSize).then(function(e){return e.organizations})},e.getCompaniesByName=function(e){return n.getCompaniesByText(e).then(function(e){return e.companies})},e.getSupportCompaniesByName=function(e){return n.getCompaniesByText(e).then(function(e){return e.companies})},e.close=function(){if(T.isDirty){var e=s.modal({title:r.getLocalizedString("common.notification.dirty.title"),text:r.getLocalizedString("common.notification.dirty.message"),buttons:[{text:r.getLocalizedString("common.labels.yes"),data:!0},{text:r.getLocalizedString("common.labels.no"),data:!1}]});e.result.then(function(e){e&&l.dismiss()})}else l.dismiss()},e.$on(c.MODAL_BACKDROP_CLICK,E),e.state=T}])}(),function(){angular.module("assetModule").controller("AssetEditStatusController",["$scope","$modalInstance","assetModel","metadataModel","$q","systemAlertService","$filter","events","i18nService",function(e,t,a,n,i,o,r,s,l){function c(){e.close()}var d={updatingStatus:!1,isDirty:!1},u={status:{},statusReason:{}};e.state=d,e.selected=u;var p={value:"",reason:""},m="",f={},g=a.getAssetDetailsByID(a.assetId,a.assetClassId).then(function(e){p=angular.copy(e.status),m=e.assetType}),h=n.getMetadataByType(EntityVO.TYPE_ASSET).then(function(t){e.statuses=t.statuses,f=t.assetTypes});i.all([h,g])["finally"](function(){u.status=_.find(e.statuses,{name:p.value})||{},u.statusReason=_.find(u.status.statusReasons,{name:p.reason})||{};var t=_.find(f,{name:m}),n=_.find(t.subType,{name:a.assetClassId});n.putIntoInventory&&(e.statuses=_.filter(e.statuses,function(e){return e.name!==EntityVO.STATUS_IN_INVENTORY}))}),e.changeStatus=function(e){u.status=e,d.isDirty=!0,u.statusReason={}},e.changeStatusReason=function(e){u.statusReason=e,d.isDirty=!0},e.isSaveButtonDisabled=function(){return!!_.isEmpty(u.status)},e.submit=function(){d.updatingStatus=!0;var e={status:u.status.name,statusReason:u.statusReason.name?u.statusReason.name:""};_.isEmpty(p)||p.value!==EntityVO.STATUS_IN_INVENTORY||u.status.name==p.value||(e.removeFromInventory=!0),a.update(e).then(function(e){a.updateCacheAssetDetails(e),t.close(),e.needsReconciliation&&o.warning({text:r("i18n")("asset.reconWarning"),hide:1e4})})["catch"](function(e){return e&&o.error({text:e.data.error,clear:!1}),i.reject(e)})["finally"](function(){d.updatingStatus=!1})},e.close=function(){if(d.isDirty){var e=o.modal({title:l.getLocalizedString("common.notification.dirty.title"),text:l.getLocalizedString("common.notification.dirty.message"),buttons:[{text:l.getLocalizedString("common.labels.yes"),data:!0},{text:l.getLocalizedString("common.labels.no"),data:!1}]});e.result.then(function(e){e&&t.dismiss()})}else t.dismiss()},e.$on(s.MODAL_BACKDROP_CLICK,c)}])}(),function(){angular.module("assetModule").controller("AssetEditTypeAttrController",["$scope","events","assetModel","metadataModel","screenConfigurationModel","$q","systemAlertService","$filter",function(e,t,a,n,i,o,r,s){function l(){var t=n.getMetadataByType(EntityVO.TYPE_ASSET),i=a.getAssetDetailsByID(a.assetId,a.assetClassId);o.all([t,i]).then(function(t){e.metadata=angular.copy(t[0]),e.updatedModel=angular.copy(t[1]),e.updatedModel.assetExtension&&(e.updatedModel.assetExtension.primaryCapability?e.selectedPrimaryCapability=e.getSelectedTypeObject("primaryCapabilities",e.updatedModel.assetExtension.primaryCapability):e.selectedPrimaryCapability="",e.updatedModel.assetExtension.virtualSystemType?e.selecteVirtualSystemType=e.getSelectedTypeObject("virtualSystemType",e.updatedModel.assetExtension.virtualSystemType):e.selecteVirtualSystemType="",e.updatedModel.assetExtension.systemType?e.selecteSystemType=e.getSelectedTypeObject("systemType",e.updatedModel.assetExtension.systemType):e.selecteSystemType="",e.capabilityList=[],a.getCapabilityListByName("",2e3).then(function(t){e.capabilityList=t.items}),e.updatedModel.assetExtension.capabilityList&&(d=e.updatedModel.assetExtension.capabilityList.split("; ")))})}function c(){e.isAssetSaving=!0;var a={};if(e.updatedModel.assetExtension){null===e.selecteSystemType&&(e.updatedModel.assetExtension.systemType=""),null===e.selecteVirtualSystemType&&(e.updatedModel.assetExtension.virtualSystemType=""),null===e.selectedPrimaryCapability&&(e.updatedModel.assetExtension.primaryCapability="");var n=e.updatedModel.assetExtension.virtualSystemType&&_.find(e.metadata.virtualSystemType,{label:e.updatedModel.assetExtension.virtualSystemType}),i=e.updatedModel.assetExtension.primaryCapability&&_.find(e.metadata.primaryCapabilities,{label:e.updatedModel.assetExtension.primaryCapability});a={capabilityList:e.getCapabilities(!0),systemType:e.updatedModel.assetExtension.systemType&&_.find(e.metadata.systemType,{label:e.updatedModel.assetExtension.systemType})&&_.find(e.metadata.systemType,{label:e.updatedModel.assetExtension.systemType}).name,virtualSystemType:n&&n.name,hostName:e.updatedModel.assetExtension.hostName,primaryCapability:i&&i.name}}a.isAssetUpdate=!0,e.$emit(t.SAVE_CHANGES_REQUEST,a)}var d=[];e.isAssetSaving=!1,e.$on(t.TOGGLE_EDIT_MODE,l),e.isCapabilityChecked=function(e){return d.indexOf(e.value)>-1},e.addCapability=function(e){var t=d.indexOf(e.value);t>-1?d.splice(t,1):d.push(e.value)},e.getCapabilities=function(e){return d.length?d.join("; "):e?"":s("i18n")("common.button.select")},e.isFieldValid=function(){return!(!e.updatedModel||e.updatedModel.type!==EntityVO.TYPE_HARDWARE||"BMC_PRINTER"!==e.updatedModel.classId&&"BMC_MAINFRAME"!==e.updatedModel.classId&&"BMC_COMPUTERSYSTEM"!==e.updatedModel.classId)},e.updateAssetField=function(t,a){e.updatedModel.assetExtension[t]=a.label},e.getSelectedTypeObject=function(t,a){return _.find(e.metadata[t],{name:a})},e.$on(t.SAVE_CHANGES,c),e.$on(t.SAVE_ALL_CHANGES_COMPLETE,function(n,i){e.isAssetSaving=!1,i.needsReconciliation?r.warning({text:s("i18n")("asset.reconWarning"),hide:1e4}):a.updateCacheAssetDetails(i),e.$emit(t.SAVE_CHANGES_COMPLETE)}),e.$on(t.SAVE_ALL_CHANGES_FAULT,function(t,a){e.isAssetSaving=!1,r.error({text:a.data.error,clear:!1})}),e.$on(t.DISCARD_CHANGES,l)}])}(),function(){angular.module("assetModule").controller("AssetLaunchActionController",["$scope","$modalInstance","linkParams","events","assetModel","$q","systemAlertService","$filter","i18nService",function(e,t,a,n,i,o,r,s,l){function c(){e.close()}function d(){_.forEach(e.linkParams.actionItem.subActions,function(t){"assetUpdate"===t.name?(e.displayedTabs.assetUpdate={},_.forEach(t.fields,function(t){e.displayedTabs.assetUpdate[t]=!0}),e.displayedTabs.assetUpdate.model&&(e.displayedTabs.assetUpdate.productModelVersion=!0,delete e.displayedTabs.assetUpdate.model)):e.displayedTabs[t.name]=!0}),e.displayedTabs.assetUpdate?e.state.selectedTab=e.tabIds.assetUpdate:e.displayedTabs.assetRelation?e.state.selectedTab=e.tabIds.assetRelation:e.state.selectedTab=e.tabIds.peopleRelation,e.displayedTabs.peopleRelation?e.showSubmitTab=e.tabIds.peopleRelation:e.displayedTabs.assetRelation?e.showSubmitTab=e.tabIds.assetRelation:e.showSubmitTab=e.tabIds.assetUpdate}e.tabIds={assetUpdate:"assetUpdate",assetRelation:"assetRelation",peopleRelation:"peopleRelation"},e.state={selectedTab:e.tabIds.assetUpdate,processing:!1},e.close=function(){var e=r.modal({title:l.getLocalizedString("common.notification.dirty.title"),text:l.getLocalizedString("common.notification.dirty.message"),buttons:[{text:l.getLocalizedString("common.labels.yes"),data:!0},{text:l.getLocalizedString("common.labels.no"),data:!1}]});e.result.then(function(e){e&&t.dismiss()})},e.$on(n.MODAL_BACKDROP_CLICK,c),e.modalInstance=t,e.isConsoleMode=!0,e.linkParams=a,e.displayedTabs={assetRelation:!1,peopleRelation:!1,assetUpdate:!1},e.assetUpdateData={},e.addPeopleData={},e.linkAssetData={},e.saveLaunchActionForm=function(){var a={sourceList:[],sourceType:EntityVO.TYPE_ASSET,action:{resource:EntityVO.TYPE_ASSET,actionType:"launch",actionName:"",actionId:"",parameters:{peopleRelation:[],assetRelation:[],assetUpdate:{},direction:!1}}};if(e.displayedTabs.peopleRelation){var n=_.cloneDeep(e.addPeopleData);n.subType===EntityVO.TYPE_PEOPLE?n.id=n.selectedPerson.displayId:n.id=n.selectedPerson.id,delete n.selectedPerson,a.action.parameters.peopleRelation.push(n)}if(e.displayedTabs.assetUpdate){var l=_.cloneDeep(e.assetUpdateData);if(l.selectedStatus&&(l.status=l.selectedStatus.name,delete l.selectedStatus),l.selectedStatusReason&&(l.statusReason=l.selectedStatusReason.name||"",delete l.selectedStatusReason),l.primaryCapability&&(l.primaryCapability=l.primaryCapability.name),l.installationDate&&(l.installationDate=l.installationDate.value),l.company&&(l.companyName=l.company.name,delete l.company),l.site&&(l.siteName=l.site.name,l.siteRegion=l.site.region,delete l.site),l.allCategories){var c=_.find(e.assetUpdateData.allCategories,{name:EntityVO.CATEGORY_PRODUCT});_.forEach(c&&c.listOfTiers,function(e){e.selectedValue?l[e.name]=e.selectedValue:l[e.name]=""}),delete l.allCategories}a.action.parameters.assetUpdate=l}else delete a.action.parameters.assetUpdate;if("child"===e.linkAssetData.relationSubType.value){if(e.displayedTabs.assetRelation)for(var d in e.linkAssetData.entities){var u={instanceId:e.linkAssetData.entities[d].instanceId,reconciliationId:e.linkAssetData.entities[d].reconciliationId,classId:e.linkAssetData.entities[d].classId};a.sourceList.push(u)}for(var p in e.linkParams.selectedItem){var m={id:e.linkParams.selectedItem[p].instanceId,type:EntityVO.TYPE_ASSET,relationshipType:e.linkAssetData.relation.value,tag:"linkeditem",desc:e.linkAssetData.entities[p].desc};a.action.parameters.assetRelation.push(m)}}else{if(e.displayedTabs.assetRelation)for(var d in e.linkAssetData.entities){var m={id:e.linkAssetData.entities[d].instanceId,type:EntityVO.TYPE_ASSET,relationshipType:e.linkAssetData.relation.value,tag:"linkeditem",desc:e.linkAssetData.entities[d].desc};a.action.parameters.assetRelation.push(m)}for(var p in e.linkParams.selectedItem){var u={instanceId:e.linkParams.selectedItem[p].instanceId,reconciliationId:e.linkParams.selectedItem[p].reconciliationId,classId:e.linkParams.selectedItem[p].classId};a.sourceList.push(u)}}a.action.actionId=e.linkParams.actionItem.id,a.action.actionName=e.linkParams.actionItem.actionName,e.state.processing=!0,i.bulkUpdateRelateAsset(a).then(function(e){t.close(e);var a=!1,n=0,i=0;_.forEach(e,function(e){var t=_.find(e,{type:"Failure"}),o=_.find(e,{type:"Success"});t?n++:_.forEach(e,function(e){if(e.additionalInformation&&e.additionalInformation.listOfMessage){var t=_.countBy(e.additionalInformation.listOfMessage,"type").Failure;t&&(n=t+n)}}),o?i++:_.forEach(e,function(e){if(e.additionalInformation&&e.additionalInformation.listOfMessage){var t=_.countBy(e.additionalInformation.listOfMessage,"type").Success;t&&(i=t+i)}});var r=_.find(e,{additionalInformation:{subActionName:"assetUpdate"}});r&&r.additionalInformation.needsReconciliation&&(a=!0)}),n>0&&r.error({text:s("i18n")("ticket.notification.alreadyExist.message",n),clear:!1}),a&&r.warning({text:s("i18n")("asset.actionBlade.assetAction.warning.reconciliation"),hide:1e4}),i>1?r.success({text:s("i18n")("asset.actionBlade.assetAction.success.multiple"),hide:1e4}):1==i&&r.success({text:s("i18n")("asset.actionBlade.assetAction.success.single"),hide:1e4})})["catch"](function(e){return e&&r.error({text:e.data.error,clear:!1}),o.reject(e)})["finally"](function(){e.state.processing=!1})},e.disableSubmitButton=function(){var t=!1;if(e.displayedTabs.assetUpdate){var a=_.find(e.assetUpdateData.allCategories,{name:EntityVO.CATEGORY_PRODUCT});_.forEach(a&&a.listOfTiers,function(a){e.displayedTabs.assetUpdate[a.name]&&!a.selectedValue&&(t=!0)})}return e.displayedTabs.peopleRelation&&!(e.addPeopleData.subType&&e.addPeopleData.relationshipType&&e.addPeopleData.selectedPerson)||e.displayedTabs.assetRelation&&(!(e.linkAssetData.entities&&e.linkAssetData.entities.length)||!e.linkAssetData.relation)||e.displayedTabs.assetUpdate&&e.assetUpdateForm&&(e.assetUpdateForm.formObject.$invalid||t)},e.nextTab=function(t){t===e.tabIds.assetUpdate&&e.displayedTabs.assetRelation?e.state.selectedTab=e.tabIds.assetRelation:e.state.selectedTab=e.tabIds.peopleRelation},d()}])}(),function(){angular.module("assetModule").controller("AssetLinkController",["$scope","$q","assetModel","metadataModel","consoleService","$filter","relationModel","userModel","configurationModel","categoriesService","$rootScope","systemAlertService","i18nService","events",function(e,t,a,n,i,o,r,s,l,c,d,u,p,m){function f(e,t){var a,n,i,o={},r="sites",s=[],l={},c={},d={};return _.forEach(e,function(t){var u=t.criteria,p=_.isArray(u.value),m=u.name;o[m]?p?o[m]=_.union(o[m],u.value):(e.splice(_.findIndex(e,{name:t.name}),1),o[m]=u.value):"region"===u.name||"siteGroup"===u.name||"sites"===u.name?("region"===u.name?(a=u.name,l=u.value[0],l.id=a,s.push(l)):"siteGroup"===u.name?(n=u.name,c=u.value[0],c.id=n,s.push(c)):"sites"===u.name&&(i=u.name,d=u.value[0],d.id=i,s.push(d)),o[r]=s):o[m]=u.value}),t&&t.length>0&&(t=_.map(t.split(","),_.trim),o.keywords=t),o}function g(t){T.processing=!0,t.isSearching=!0;var a={filterCriteria:f(t.selectedFilters,t.searchKeywords),chunkInfo:e.chunkInfo,sortInfos:[{sortFieldName:"name",sortFieldOrder:"ASC"}],attributeNames:["name","desc","status","classId"]};t.lastUsedFilterCriteria=a,i.getAssetList(a,"cisearch").then(function(t){a.chunkInfo.startIndex?e.availableEntities=e.availableEntities.concat(t.itemList):e.availableEntities=t.itemList,e.totalAvailableEntitiesCount=t.totalCount,e.totalAvailableEntitiesCount>e.availableEntities.length?e.showLoadMore=!0:e.showLoadMore=!1,_.forEach(e.availableEntities,function(e){
e.status&&(e.status.value=o("localizeLabel")(e.status.value,EntityVO.TYPE_STATUS,EntityVO.TYPE_ASSET))})})["finally"](function(){t.isSearching=!1,T.processing=!1})}function h(){T.relateProcessing=!0,delete v.relation;var t={classId1:e.currentAsset.classId},n=_.uniq(_.map(v.entities,"classId"));t.classId2=1===n.length?n[0]:"BMC_ASSETBASE",a.getRelationshipTypes(t).then(function(t){v.entities.length>1&&(t=_.filter(t,function(e){return"1-1"!==e.cardinality})),e.relationshipTypes=t,T.relateProcessing=!1})}function y(){e.close()}e.currentAsset=e.linkParams.selectedItem;var E={filterCriteria:{assetConsoleKeywords:[],assetTypes:[]}},v={linkOption:{},relationSubType:{label:o("i18n")("asset.relationship.parent.option"),value:"parent"}},T={searching:!1,processing:!1,relateProcessing:!1};e.state=T,e.availableEntities=null,e.selected=v,e.assetTypes=[],e.relationshipTypes=[],e.criteria=E,e.expanded=!1,e.chunkInfo={startIndex:0,chunkSize:100},e.showLoadMore=!1,e.toggleMenu=function(){e.expanded=!e.expanded},e.assetTypesSelected=[],e.relationshipSubTypes=[{label:o("i18n")("asset.relationship.child.option"),value:"child"},{label:o("i18n")("asset.relationship.parent.option"),value:"parent"}];var S,C;e.filterConfig=angular.copy(l.get("ciSearch.assetConsoleFilter")),C=_.keyBy(e.filterConfig,"label"),e.columnPreferenceGroup="CIFilter",s.getUserPreferences(e.columnPreferenceGroup).then(function(t){e.userSavedSearchPresets=_.uniqBy(t,"name")||[];var a=_.findIndex(e.filterConfig,{name:"custom"});_.forEach(e.userSavedSearchPresets,function(t){if(!t.systemgenerated){var n={name:t.name,id:t.id,type:"custom",filters:_.map(t.value,function(e){var t,a,n,i;a=e.option,C[e.filter]?i=_.find(C[e.filter].options,{name:e.option}):"sites"===e.filter&&C.site&&(i=_.find(C.site.options,{name:e.option})),t=e.realOption&&e.realOption.criteria?e.realOption.criteria.value:i&&i.criteria?i.criteria.value:e;var o={active:!0,criteria:{name:e.filter,value:t},name:a,label:n,type:"keywords"!==e.filter?"dynamic":"keywords"};return o})};a!==-1&&"allAssets"!==n.id&&(e.filterConfig[a].expanded=!0,e.filterConfig[a].options.push(n))}})});var O=s.getFullCurrentUserData().then(function(){var e=s.userFullData,t=_.find(C.approvedBy.options,{label:"me"}),a=_.find(C.createdBy.options,{label:"me"}),n=_.find(C.managedBy.options,{label:"me"}),i=_.find(C.owner.options,{label:"me"}),o=_.find(C.supportedBy.options,{label:"me"}),r=_.find(C.usedBy.options,{label:"me"});t.subLabel=a.subLabel=n.subLabel=i.subLabel=o.subLabel=r.subLabel=e.fullName,t.criteria.value=a.criteria.value=n.criteria.value=i.criteria.value=o.criteria.value=r.criteria.value=[{id:e.personId}];var l=_.find(C.site.options,{label:"mySite"});l.criteria.value=[{name:s.userFullData.site.name,companyName:s.userFullData.company.name,region:s.userFullData.site.region,siteGroup:s.userFullData.site.siteGroup}],l.subLabel=s.userFullData.site.name;var c=_.find(C.siteGroup.options,{label:"mySiteGroup"});c.criteria.value=[{companyName:s.userFullData.company.name,region:s.userFullData.site.region,siteGroup:s.userFullData.site.siteGroup}],c.subLabel=s.userFullData.site.siteGroup;var d=_.find(C.region.options,{label:"myRegion"});d.criteria.value=[{companyName:s.userFullData.company.name,region:s.userFullData.site.region}],d.subLabel=s.userFullData.site.region}),A=n.getMetadataByType(EntityVO.TYPE_ASSET).then(function(t){S=t,e.metadata=S,e.assetTypes=e.metadata.assetTypes,_.forEach(t.statuses,function(e){C.statuses.options.push({name:e.label,type:"dynamic",criteria:{name:"ticketSpecificStatuses",value:[e.name]}})}),_.forEach(t.assetTypes,function(e){C.ciType.options.push({name:e.label,type:"dynamic",criteria:{name:"assetTypes",value:[e.name]},criteriaValue:e.name}),e.subType.forEach(function(t){C.assetSubType.options.push({name:t.label,type:"dynamic",filterName:"assetSubTypes",isHidden:!1,criteria:{name:"assetSubTypes",value:[t.name],typeName:e.name}})})})});T.processing=!0,t.all([O,A]).then(function(){T.processing=!1})["finally"](function(){T.processing=!1}),e.search={config:e.filterConfig,isSearching:!1,selectedFilters:[],searchKeywords:[]},e.getProductCategoriesByCompany=function(e){var t="product",a={entityType:EntityVO.TYPE_ASSET,categoryType:t,searchText:e,criteria:{company:s.userFullData.company}};return c.searchCategories(a).then(function(e){var a=_.find(S.categories,function(e){return e.name===t});return _.map(e.items,function(e){if(e.length){for(var n=_.compact(e).join(" > "),i={},o=0;o<a.listOfTiers.length;o++)i[a.listOfTiers[o].name]=e[o];return{value:n,attributeMap:{categorizations:[{name:t,tiers:i}]}}}})})};var I;e.searchCIs=function(t){e.chunkInfo.startIndex=0,I=t,g(t)},e.loadMore=function(){e.chunkInfo.startIndex+=e.chunkInfo.chunkSize,g(I)},e.selectEntity=function(){v.entities=_.filter(e.availableEntities,{isSelected:!0}),h()},e.checkItem=function(t){t.checked=!t.checked,E.filterCriteria.assetTypes=[],e.assetTypesSelected=[],_.forOwn(e.assetTypes,function(t){t.checked&&(E.filterCriteria.assetTypes.push(t.label),e.assetTypesSelected.push(t))},e)},e.addRelations=function(){T.processing=!0,r.getRelations(e.currentAsset.reconciliationId,"asset").then(function(t){var n={},i=0;t=_.filter(t,{relationshipClassId:v.relation.value}),v.relation&&v.relation.direction&&"child"===v.relationSubType.value?(n={ids:[],relationship:[{id:e.currentAsset.instanceId,relationshipType:v.relation.value,tag:"linkeditem",type:"asset",desc:""}]},_.forOwn(v.entities,function(e){var a=_.find(t,function(t){return t.realObject.instanceId===e.instanceId&&t.realObject.isParent});a?i++:n.ids.push({uuid:e.instanceId,type:"asset"})})):(n={ids:[{uuid:e.currentAsset.instanceId,type:"asset"}],relationship:[]},_.forOwn(v.entities,function(e){var a=_.find(t,function(t){return t.realObject.instanceId===e.instanceId&&t.realObject.isChild});a?i++:n.relationship.push({id:e.instanceId,relationshipType:v.relation.value,tag:"linkeditem",type:"asset",desc:""})})),n.ids.length&&n.relationship.length?a.addBulkRelations(n).then(function(t){T.processing=!1,e.modalInstance.close(t),d.$broadcast("new-relations");var a=0,n=!1;_.each(t,function(e){if(e.additionalInformation&&e.additionalInformation.listOfMessage){var t=e.additionalInformation.listOfMessage,o=_.countBy(t,"type");o.Success&&(a+=o.Success),o.Failure&&(i+=o.Failure),e.additionalInformation.listOfMessage.length>0&&e.additionalInformation.listOfMessage[0].additionalInformation&&e.additionalInformation.listOfMessage[0].additionalInformation.needsReconciliation&&(n=!0)}}),n&&u.error({text:o("i18n")("asset.actionBlade.assetAction.warning.reconciliation"),clear:!1}),i?a?u.success({text:o("i18n")("ticket.notification.link.message.mixed",[a,i]),hide:1e4}):u.error({text:o("i18n")("ticket.notification.link.message.error",i),clear:!1}):u.success({text:o("i18n")("ticket.notification.link.message",a),hide:1e4})})["catch"](function(t){T.processing=!1,e.modalInstance.close(t),t.data&&t.data.error&&u.error({text:t.data.error,clear:!1})}):(T.processing=!1,i&&u.error({text:o("i18n")("ticket.notification.link.message.error",i),clear:!1}),e.modalInstance.close())})},e.close=function(){if(v.linkOption!=={}||v.searchText||e.availableEntities&&e.availableEntities.length){var t=u.modal({title:p.getLocalizedString("common.notification.dirty.title"),text:p.getLocalizedString("common.notification.dirty.message"),buttons:[{text:p.getLocalizedString("common.labels.yes"),data:!0},{text:p.getLocalizedString("common.labels.no"),data:!1}]});t.result.then(function(t){t&&e.modalInstance.dismiss()})}else e.modalInstance.dismiss()},e.$on(m.MODAL_BACKDROP_CLICK_PROPOGATE,y)}])}(),function(){angular.module("assetModule").factory("assetModel",["assetService","$q","relationModel","screenConfigurationService","userModel",function(e,t,a,n,i){var o={assetDetails:{},assetOwner:{},poiOwner:{},assetId:{},assetClassId:{},assetPeopleRelations:{},flattenRelations:{},bcmFilteredActions:{},cache:{}};return o.getAssetDetailsByID=function(a,n){return _.isEmpty(o.assetDetails)||a!==o.assetDetails.reconciliationId||n!==o.assetDetails.classId?e.getAssetDetailsByID(a,n).then(function(e){return o.assetDetails=e,o.bcmFilteredActions={actions:{ConfigSummary:!0,PerformAudit:!0,Ping:!0,Reboot:!0,Shutdown:!0,WakeUp:!0},configLoaded:!1},o.assetDetails}):t.when(o.assetDetails)},o.getPrimaryContact=function(e){var t={types:"person",criteria:{primaryContact:!0}};return a.getRelations(e,EntityVO.TYPE_ASSET,null,t).then(function(e){o.assetPrimaryContact=_.find(e,function(e){return"Yes"===e.realObject.isPrimaryContact})||{}})},o.getPeopleRelations=function(e){return a.getRelations(e,EntityVO.TYPE_ASSET).then(function(e){o.assetPeopleRelations=_.chain(e).filter({type:EntityVO.TYPE_PERSON}).filter({realObject:{isPrimaryContact:"No"}}).groupBy("relationshipType").value(),o.assetPrimaryContact=_.find(e,function(e){return"Yes"===e.realObject.isPrimaryContact})||{}})},o.refreshPeopleRelations=function(e){return a.refreshRelations(e,EntityVO.TYPE_ASSET).then(function(e){o.assetPeopleRelations=_.chain(e).filter({type:EntityVO.TYPE_PERSON}).filter({realObject:{isPrimaryContact:"No"}}).groupBy("relationshipType").value(),o.assetPrimaryContact=_.find(e,function(e){return"Yes"===e.realObject.isPrimaryContact})||{}})},o.getFlattenRelations=function(e){return a.getRelations(e,EntityVO.TYPE_ASSET).then(function(e){o.flattenRelations=_.chain(e).filter({type:EntityVO.TYPE_ASSET}).filter({relationshipClassId:"BMC_HostedSystemComponents"}).groupBy("realObject.classId").value()})},o.refreshFlattenRelations=function(e){return a.refreshRelations(e,EntityVO.TYPE_ASSET).then(function(e){o.flattenRelations=_.chain(e).filter({type:EntityVO.TYPE_ASSET}).filter({relationshipClassId:"BMC_HostedSystemComponents"}).groupBy("realObject.classId").value()})},o.getAssetOwnerDetails=function(t){return i.userId!==t&&(t=encodeURIComponent(t)),e.getAssetOwnerDetails(t).then(function(e){o.assetOwner=e})},o.getPoiOwnerDetails=function(t){return i.userId!==t&&(t=encodeURIComponent(t)),e.getAssetOwnerDetails(t).then(function(e){o.poiOwner=e})},o.update=function(t){return e.update(o.assetDetails.reconciliationId,o.assetDetails.instanceId,o.assetClassId,t).then(function(e){return _.head(e).items[0].responseObject})},o.updateCacheAssetDetails=function(e){_.extend(o.assetDetails,e),o.assetDetails.postBuild(),_.isUndefined(e.manufacturer)&&(o.assetDetails.manufacturer=""),_.isUndefined(e.floor)&&(o.assetDetails.floor=""),_.isUndefined(e.invoiceNumber)&&(o.assetDetails.invoiceNumber=""),_.isUndefined(e.partNumber)&&(o.assetDetails.partNumber=""),_.isUndefined(e.serialNumber)&&(o.assetDetails.serialNumber=""),_.isUndefined(e.supplier)&&(o.assetDetails.supplier=""),_.isUndefined(e.systemRole)&&(o.assetDetails.systemRole=""),_.isUndefined(e.room)&&(o.assetDetails.room=""),_.isUndefined(e.impact)&&(o.assetDetails.impact=null),_.isUndefined(e.urgency)&&(o.assetDetails.urgency=null),_.isUndefined(e.financials)||(_.isUndefined(e.financial.costCenter)&&(o.assetDetails.financial.costCenter=""),_.isUndefined(e.financial.budgetCode)&&(o.assetDetails.financial.budgetCode=""),_.isUndefined(e.financial.projectNumber)&&(o.assetDetails.financial.projectNumber=""))},o.addPeople=function(e){return a.addRelation({uuid:o.assetId,type:EntityVO.TYPE_ASSET},[e])},o.removePeople=function(t){return e.removePeople(t)},o.followAsset=function(t,a){return e.followAsset(t,a)},o.unfollowAsset=function(t,a){return e.unfollowAsset(t,a)},o.searchInventory=function(t){return e.searchInventory(t)},o.putIntoInventory=function(t,a,n){return e.putIntoInventory(t,a,n).then(function(e){return _.head(e).items[0]})},o.getRelationshipTypes=function(a){if(o.cache[a.classId1]&&o.cache[a.classId1][a.classId2])return t.resolve(angular.copy(o.cache[a.classId1][a.classId2]));var n=e.getRelationshipTypes(a).then(function(e){return o.cache[a.classId1]=o.cache[a.classId1]?o.cache[a.classId1]:{},o.cache[a.classId1][a.classId2]=e,angular.copy(e)});return n},o.addBulkRelations=function(t){return e.addBulkRelations(t)},o.bulkUpdateRelateAsset=function(t){return e.bulkUpdateRelateAsset(t)},o.getCostCentersByCompanyName=function(e,t){return n.loadDynamicSelectionFieldLabels({datasource:"asset",menuName:"SHR:CostCenterAllForCompany",searchText:e},{companyName:t})},o.getCapabilityListByName=function(e,t){var a={datasource:"asset",menuName:"SHR:SDF:AST-Capabilities",searchText:e};return t&&(a.chunkInfo={startIndex:0,chunkSize:t}),n.loadDynamicSelectionFieldLabels(a,{})},o.getBcmFilteredActions=function(){return o.bcmFilteredActions},o.getBcmFilteredActionsFromServer=function(){var a=o.assetDetails.bcmDeviceId;if(o.bcmFilteredActions.configLoaded)return t.when(o.bcmFilteredActions);var n=e.getBcmFilteredActions(a).then(function(e){return o.bcmFilteredActions={actions:e,configLoaded:!0},o.bcmFilteredActions});return n["catch"](function(){o.bcmFilteredActions={actions:{ConfigSummary:!1,PerformAudit:!1,Ping:!1,Reboot:!1,Shutdown:!1,WakeUp:!1},configLoaded:!0}}),n},o.getBcmAssetGeneralData=function(){var t=o.assetDetails.bcmDeviceId;return e.getBcmAssetGeneralData(t)},o.getBcmAssetHardwareData=function(){var t=o.assetDetails.bcmDeviceId;return e.getBcmAssetHardwareData(t)},o.getBcmAssetSoftwareData=function(t){var a=o.assetDetails.bcmDeviceId;return e.getBcmAssetSoftwareData(a,t)},o.getBcmAssetFinancialData=function(){var t=o.assetDetails.bcmDeviceId;return e.getBcmAssetFinancialData(t)},o.getBcmAssetSecurityData=function(){var t=o.assetDetails.bcmDeviceId;return e.getBcmAssetSecurityData(t)},o.getBcmAssetActionHistory=function(t){var a=o.assetDetails.bcmDeviceId;return e.getBcmAssetActionHistory(a,t)},o.performBCMAction=function(t){var a,n=o.assetDetails.bcmDeviceId,i=o.assetDetails.reconciliationId;switch(t){case"performAuditFromBCM":a=e.performAuditFromBCM(n,i);break;case"pingDeviceFromBCM":a=e.pingDeviceFromBCM(n,i);break;case"rebootDeviceFromBCM":a=e.rebootDeviceFromBCM(n,i);break;case"wakeupDeviceFromBCM":a=e.wakeupDeviceFromBCM(n,i);break;case"shutdownDeviceFromBCM":a=e.shutdownDeviceFromBCM(n,i)}return a},o}])}(),function(){angular.module("assetModule").controller("AssetProfileController",["$scope","$state","events","$stateParams","metadataModel",function(e,t,a,n,i){var o=n.assetId,r=n.assetClassId;e.globalMetadataLoaded=!1,i.getMetadataByType("global").then(function(a){var n="T"===a.configurationParameters["Enable-Progressive-Views"]||"true"===a.configurationParameters["Enable-Progressive-Views"];n="T"!==localStorage.getItem("overridePV")&&n,n&&localStorage.getItem("midtierUrl")?t.go("assetPV",{assetId:o,assetClassId:r},{location:"replace"}):console.info("Either PV not enabled or invalid midtierUrl"),e.globalMetadataLoaded=!0})["catch"](function(e){console.info(e.data.error)}),e.asset={},e.assetIdsObject={assetId:t.params.assetId,assetClassId:t.params.assetClassId},e.$on(a.ASSET_DETAILS_LOADED,function(t,a){e.asset=a.asset}),e.$on(a.ASSET_DETAILS_CHANGED,function(t,a){t.stopPropagation(),e.$broadcast(a.eventName)})}])}(),AssetVO.prototype=new BaseVO,AssetVO.prototype.constructor=AssetVO,AssetVO.prototype.getProps=function(){return BaseVO.prototype.getProps().concat("name","desc","company","product","reconciliationId","classId","assetId","instanceId","site","status","assetExtension","thumbnail","thumbnailMime","type","subType","lifecycleDates","financial","needsReconciliation","floor","room","systemRole","serialNumber","partNumber","tagNumber","supplier","manufacturer","impact","urgency","priority","invoiceNumber","orderId","submitter","supplier","version","lastModifiedBy","owner","accessMappings","following","poiInfo","assetType","customFields","bcmDeviceId")},AssetVO.prototype.getSiteAddress=function(){var e=this.site&&this.site.address||{};return e.street+", "+e.city+", "+e.state+" "+(e.zip?e.zip:"")+", "+e.country},AssetVO.prototype.postBuild=function(){if(_.forOwn(this.lifecycleDates,_.bind(function(e,t){this.lifecycleDates[t]=e},this)),this.orderId&&(this.financial.orderId=this.orderId),this.invoiceNumber&&(this.financial.invoiceNumber=this.invoiceNumber),_.isEmpty(this.accessMappings))this.accessMappings={detailsEditAllowed:!0,statusEditAllowed:!0,timelineEditAllowed:!0,relationsEditAllowed:!0,financialReadAllowed:!0,financialEditAllowed:!0,inventoryEditAllowed:!0,assetrelationsEditAllowed:!0};else{for(var e={},t=0;t<this.accessMappings.length;t++)"financial"===this.accessMappings[t].id?(e.financialReadAllowed="write"===this.accessMappings[t].permission||"read"===this.accessMappings[t].permission,e.financialEditAllowed="write"===this.accessMappings[t].permission):e[this.accessMappings[t].id+"EditAllowed"]="write"===this.accessMappings[t].permission;this.accessMappings=e}this.isPoi=!_.isEmpty(this.poiInfo),this.isPoi&&(this.isPoiOnly=!this.reconciliationId,this.poiAttributes=_.toPairs(_.omit(this.poiInfo,["name","desc","type","status","owner","id","thumbnail","thumbnailMime","qrcode","tag","source","floorMapId"])),this.poiLink="../myitapp/#/resource/"+this.poiInfo.id,this.poiId=this.poiInfo.id,this.isPoiOnly&&(this.name=this.poiInfo.name,this.reconciliationId=this.poiInfo.id,this.classId="POI",this.poiInfo.thumbnail&&this.poiInfo.thumbnailMime&&(this.thumbnail=this.poiInfo.thumbnail,this.thumbnailMime=this.poiInfo.thumbnailMime)))},function(){angular.module("assetModule").service("assetService",["$resource","$http","$filter",function(e,t,a){function n(e){var t,n=[],i={};if(e.Total){var o=_.find(e.struct.member,{name:"Values"}),r=_.find(e.struct.member,{name:"KeywordTranslation"}),s=r.value.struct.member;_.each(s,function(e){i[e.name]=e.value.i4||e.value.string}),1===e.Total&&(o.value.array.data.value=[o.value.array.data.value]),_.each(o.value.array.data.value,function(e){var t={};_.each(e.struct.member,function(e){if("ObjectId"!==e.name){var n,o;n=i[e.name]||e.name,o=e.value.i4||e.value.string,t[n]=i[o]||o,"_DB_ATTR_LASTSTATUSUPDATE_"===e.name&&(t[n]=a("date")(t[n],"medium"))}}),n.push({fields:t})})}return t={aObjects:n,total:e.Total}}function i(e,t){var n,i,o={},r=a("i18n")("asset.bcm.component"),s=a("i18n")("asset.bcm.details");if(e.ErrorCode||delete e.ErrorCode,delete e.$promise,delete e.$resolved,"general"===t||"financial"===t){"general"===t&&(o={hardware:angular.copy(e)},e=e.Device,e.KeywordTranslation=o.hardware.KeywordTranslation,delete o.hardware.Device);var l=[],c=["ServiceStartDate","SupportExpirationDate","WarrantyExpirationDate","LastUpdate"];for(n in e)e.hasOwnProperty(n)&&"KeywordTranslation"!==n&&(i={},i[r]=e.KeywordTranslation[n]||n,i[s]=e.KeywordTranslation[e[n]]||e[n],c.indexOf(n)!==-1&&(i[s]=a("date")(i[s],"medium")),l.push({fields:i}));"general"===t?o.general=l:o=l}else if("software"===t){var d=[];_.each(e._DB_OBJECTTYPCLASS_SOFTWAREINVENTORY_,function(t){var a,i,o={};for(n in t)a=e.KeywordTranslation[n]||n,i=e.KeywordTranslation[t[n]]||t[n],o[a]=i;d.push({fields:o})}),o={sObjects:d,total:e.Total}}else o=e;return o}function o(e){return(new AssetVO).build(e)}function r(e){return(new PersonVO).build(e)}var s=e("/smartit/rest/asset/:reconciliationId/:assetClassId",{},{getAssetDetailsByID:{method:"GET",url:"/smartit/rest/asset/details/:reconciliationId/:assetClassId",isArray:!0},update:{method:"PUT",url:"/smartit/rest/asset/update/all/:reconciliationId",isArray:!0},getAssetOwnerDetails:{method:"GET",url:"/smartit/rest/person/:id",isArray:!0},saveCIPresetConfiguration:{url:"/smartit/rest/mtc/preference/:clientType/CI_FILTER_GROUP",method:"PUT",isArray:!1,transformResponse:function(e){return{id:e}}},removeCIPresetConfiguration:{url:"/smartit/rest/mtc/preference/",method:"DELETE",isArray:!1},getRelationshipTypes:{url:"/smartit/rest/asset/relationshiptypes",method:"POST",isArray:!0},addBulkRelations:{url:"/smartit/rest/bulkupdate/relations",method:"POST",isArray:!0},bulkUpdateRelateAsset:{url:"/smartit/rest/v2/action/bulk/execute",method:"POST",isArray:!1},searchInventory:{url:"/smartit/rest/inventory/search",method:"POST",isArray:!0},putIntoInventory:{url:"/smartit/rest/inventory/asset/:assetId/:assetClassId",method:"POST",isArray:!0},getBcmFilteredActions:{url:"/smartit/rest/bcm/device/:deviceId/filteredactions",method:"GET",isArray:!1},getBcmAssetGeneralData:{url:"/smartit/rest/bcm/device/:deviceId/summary",method:"GET",isArray:!1},getBcmAssetHardwareData:{url:"/smartit/rest/bcm/device/:deviceId/inventory/hardware/summary",method:"GET",isArray:!1},getBcmAssetSoftwareData:{url:"/smartit/rest/bcm/device/:deviceId/inventory/software/summary?offset=:offset",method:"GET",isArray:!1},getBcmAssetFinancialData:{url:"/smartit/rest/bcm/device/:deviceId/financial/summary",method:"GET",isArray:!1},getBcmAssetSecurityData:{url:"/smartit/rest/bcm/device/:deviceId/inventory/security/summary",method:"GET",isArray:!1},getBcmAssetActionHistory:{url:"/smartit/rest/bcm/device/:deviceId/oprule/history?offset=:offset",method:"GET",isArray:!1},performAuditFromBCM:{url:"/smartit/rest/bcm/device/:deviceId/audit?reconId=:reconId",method:"POST",isArray:!1},shutdownDeviceFromBCM:{url:"/smartit/rest/bcm/device/:deviceId/shutdown?reconId=:reconId",method:"POST",isArray:!1},pingDeviceFromBCM:{url:"/smartit/rest/bcm/device/:deviceId/ping?reconId=:reconId",method:"POST",isArray:!1},rebootDeviceFromBCM:{url:"/smartit/rest/bcm/device/:deviceId/reboot?reconId=:reconId",method:"POST",isArray:!1},wakeupDeviceFromBCM:{url:"/smartit/rest/bcm/device/:deviceId/wakeup?reconId=:reconId",method:"POST",isArray:!1}}),l=e("/smartit/rest/asset/search",{},{GetListOfAssets:{method:"GET",isArray:!0},getListOfAssetsWithFilter:{method:"POST",url:"/smartit/rest/asset/search/filter",isArray:!0}});this.getAssetDetailsByID=function(e,t){return s.getAssetDetailsByID({reconciliationId:e,assetClassId:t}).$promise.then(function(e){return o(e[0].items[0])})},this.update=function(e,t,a,n){return n.classId=a,n.instanceId=t,s.update({reconciliationId:e},n).$promise},this.getListOfAssets=function(e){return l.GetListOfAssets({searchParam:e}).$promise},this.getListOfAssetsForCompany=function(e,t,a,n){var i={searchParam:e,company:{name:t}};return a===EntityVO.TYPE_INCIDENT&&(i.customerId=n,i.ticket=a,i.affected=!0),a!==EntityVO.TYPE_PROBLEM&&a!==EntityVO.TYPE_KNOWNERROR||(i.affected=!0),l.GetListOfAssets(i).$promise},this.getListOfAssetsByType=function(e,t){return l.GetListOfAssets({searchParam:e,assetType:t}).$promise},this.getListOfAssetsByTypeForCompany=function(e,t,a,n,i){var o={searchParam:e,assetType:t,company:{name:a}};return n===EntityVO.TYPE_INCIDENT&&(o.customerId=i,o.ticket=n,o.affected=!0),l.GetListOfAssets(o).$promise},this.getListOfAssetsWithFilter=function(e){return l.getListOfAssetsWithFilter(e).$promise},this.removePeople=function(e){return t({method:"DELETE",headers:{"Content-Type":"application/json"},url:"/smartit/rest/relations/asset/"+e.parentId,data:[e]})},this.getAssetOwnerDetails=function(e){return s.getAssetOwnerDetails({id:e}).$promise.then(function(e){return r(e[0].items[0]||[])})},this.followAsset=function(e,a){return e=encodeURIComponent(e),t({method:"POST",headers:{"Content-Type":"application/json"},url:"/smartit/rest/v2/profile/user/"+e+"/following?follow_type=asset&following_id="+a})},this.unfollowAsset=function(e,a){return e=encodeURIComponent(e),t({method:"DELETE",headers:{"Content-Type":"application/json"},url:"/smartit/rest/v2/profile/user/"+e+"/following?follow_type=asset&following_id="+a})},this.searchInventory=function(e){return s.searchInventory(e).$promise},this.putIntoInventory=function(e,t,a){return s.putIntoInventory({assetId:e,assetClassId:t},a).$promise},this.saveCIPresetConfiguration=function(e,t){var a={name:e,criteria:t};return s.saveCIPresetConfiguration({clientType:"SHARED"},a).$promise},this.removeCIPresetConfiguration=function(e){return s.removeCIPresetConfiguration({name:e}).$promise},this.getRelationshipTypes=function(e){return s.getRelationshipTypes(e).$promise},this.addBulkRelations=function(e){return s.addBulkRelations(e).$promise},this.bulkUpdateRelateAsset=function(e){return s.bulkUpdateRelateAsset(e).$promise},this.getBcmFilteredActions=function(e){return s.getBcmFilteredActions({deviceId:e}).$promise.then(function(e){return i(e,"filterActions")})},this.getBcmAssetGeneralData=function(e){return s.getBcmAssetHardwareData({deviceId:e}).$promise.then(function(e){return i(e,"general")})},this.getBcmAssetHardwareData=function(e){return s.getBcmAssetHardwareData({deviceId:e}).$promise.then(function(e){return i(e,"hardware")})},this.getBcmAssetSoftwareData=function(e,t){return s.getBcmAssetSoftwareData({deviceId:e,offset:t}).$promise.then(function(e){return i(e,"software")})},this.getBcmAssetFinancialData=function(e){return s.getBcmAssetFinancialData({deviceId:e}).$promise.then(function(e){return i(e,"financial")})},this.getBcmAssetSecurityData=function(e){return s.getBcmAssetSecurityData({deviceId:e}).$promise.then(function(e){return i(e,"security")})},this.getBcmAssetActionHistory=function(e,t){return s.getBcmAssetActionHistory({deviceId:e,offset:t}).$promise.then(function(e){return n(e)})},this.performAuditFromBCM=function(e,t){return s.performAuditFromBCM({deviceId:e,reconId:t},{}).$promise},this.pingDeviceFromBCM=function(e,t){return s.pingDeviceFromBCM({deviceId:e,reconId:t},{}).$promise},this.rebootDeviceFromBCM=function(e,t){return s.rebootDeviceFromBCM({deviceId:e,reconId:t},{}).$promise},this.wakeupDeviceFromBCM=function(e,t){return s.wakeupDeviceFromBCM({deviceId:e,reconId:t},{}).$promise},this.shutdownDeviceFromBCM=function(e,t){return s.shutdownDeviceFromBCM({deviceId:e,reconId:t},{}).$promise}}])}(),function(){angular.module("assetModule").directive("assetSummary",[function(){return{restrict:"AE",templateUrl:"views/asset/asset-summary.html",scope:{asset:"="}}}])}(),function(){angular.module("assetModule").controller("AssetUpdateController",["$scope","$timeout","configurationModel","metadataModel","userModel","searchModel","createTicketModel","categoriesService",function(e,t,a,n,i,o,r,s){function l(t){return o.getSitesByCompany(t).then(function(t){e.sites=t.objects,e.state.tooManySites=t.exceedsChunkSize})}function c(t){(e.assetUpdateFields.productName||e.assetUpdateFields.productCategoryTier1||e.assetUpdateFields.productCategoryTier2||e.assetUpdateFields.productCategoryTier3||e.assetUpdateFields.productModelVersion)&&(e.assetEntity.company=e.asset.company,e.$broadcast(t.CLEAR_CATEGORY_DETAILS,e.assetEntity.company))}function d(){e.assetUpdateFields.status&&(e.asset.selectedStatus=_.head(e.assetMetadata.statuses),e.updateStatusReason())}function u(t){e.assetUpdateFields.name&&(e.asset.name=t.name),e.assetUpdateFields.status&&t.status&&(e.asset.selectedStatus=_.find(e.assetMetadata.statuses,{name:t.status.value}),e.assetUpdateFields.statusReason&&e.updateStatusReason(t.status.reason)),e.assetUpdateFields.partNumber&&(e.asset.partNumber=t.partNumber),e.assetUpdateFields.manufacturer&&(e.asset.manufacturer=t.manufacturer),e.assetUpdateFields.supplier&&(e.asset.supplier=t.supplier),e.assetUpdateFields.installationDate&&t.lifecycleDates&&t.lifecycleDates.installationDate&&(e.asset.installationDate.value=t.lifecycleDates.installationDate,e.asset.installationDate.date=moment(t.lifecycleDates.installationDate).toDate(),e.asset.installationDate.time=moment(t.lifecycleDates.installationDate).toDate()),e.assetUpdateFields.room&&(e.asset.room=t.room),e.assetUpdateFields.floor&&(e.asset.floor=t.floor),e.assetUpdateFields.primaryCapability&&t.assetExtension&&(e.asset.primaryCapability=_.find(e.primaryCapabilities,{name:t.assetExtension.primaryCapability})),(e.assetUpdateFields.productName||e.assetUpdateFields.productCategoryTier1||e.assetUpdateFields.productCategoryTier2||e.assetUpdateFields.productCategoryTier3||e.assetUpdateFields.productModelVersion)&&t.allCategories&&(e.asset.allCategories=t.allCategories)}function p(){e.state={tooManyCompanies:!1,isDataLoading:!1},e.selections={companies:[]},e.datePickerOptions={startingDay:a.getWeekStartingDay(),"show-weeks":!1,minDate:moment().year(1970).month(0).date(2),maxDate:moment().year(2038).month(0).date(18)},e.assetDate={installationDatePicker:{open:!1}},n.getMetadataByType(EntityVO.TYPE_ASSET).then(function(t){if(e.assetMetadata=t,e.assetMetadata.customStatusList=e.assetMetadata.statuses.filter(function(e){return"In Inventory"!==e.name}),e.primaryCapabilities=e.assetMetadata.primaryCapabilities,(e.assetUpdateFields.productName||e.assetUpdateFields.productCategoryTier1||e.assetUpdateFields.productCategoryTier2||e.assetUpdateFields.productCategoryTier3||e.assetUpdateFields.productModelVersion)&&(e.asset.allCategories=_.cloneDeep(s.populateCategories([{name:"product",tiers:{}}],e.assetMetadata))),e.assetEntity.company={name:e.assetMetadata.systemConfigurations.defaultCompany},e.linkParams.selectedItem.length>1)d();else{var a=_.cloneDeep(e.linkParams.selectedItem[0]);u(a)}}),i.getFullCurrentUserData().then(function(){e.state.isDataLoading=!0,o.getOperatingCompanies(null,-1).then(function(t){e.selections.companies=_.cloneDeep(t.companies),e.state.tooManyCompanies=t.exceedsChunkSize,e.linkParams.selectedItem.length<2&&e.assetUpdateFields.company&&e.linkParams.selectedItem[0].company?(e.asset.company=_.find(e.selections.companies,{name:e.linkParams.selectedItem[0].company.name}),e.asset.company&&(e.assetEntity.company=e.asset.company),e.assetUpdateFields.site?l(e.asset.company.name).then(function(){e.linkParams.selectedItem[0].site.name&&(e.asset.site=_.find(e.sites,{name:e.linkParams.selectedItem[0].site.name})),e.state.isDataLoading=!1}):e.state.isDataLoading=!1):e.state.isDataLoading=!1})})}e.asset={installationDate:{date:void 0,time:void 0}},e.assetEntity={ticketType:EntityVO.TYPE_ASSET,classId:"",assetUpdateFields:e.assetUpdateFields},e.updateStatusReason=function(t){e.assetUpdateFields.statusReason&&!_.isEmpty(e.asset.selectedStatus.statusReasons)?e.asset.selectedStatusReason=_.find(e.asset.selectedStatus.statusReasons,{name:t})||{}:e.assetUpdateFields.statusReason&&(e.asset.selectedStatusReason={})},e.getCompaniesByType=function(a,n){return o.getCompaniesByText(a,-1,{companyType:n}).then(function(a){return"Supplier"===n?e.isTooltipOpenSupplier=e.exceedsChunkSizeSupplier=a.exceedsChunkSize:"Manufacturer"===n&&(e.isTooltipOpenManufacturer=e.exceedsChunkSizeManufacturer=a.exceedsChunkSize),t(function(){e.isTooltipOpenManufacturer=!1,e.isTooltipOpenSupplier=!1},1e4),a.companies})},e.getCompaniesByName=function(e){return o.getCompaniesByText(e).then(function(e){return{list:e.companies,exceedsChunkSize:e.exceedsChunkSize}})},e.onInputFocusBlur=function(){e.isTooltipOpenManufacturer=!1,e.isTooltipOpenSupplier=!1},e.setCompany=function(t){e.asset.company=t,l(e.asset.company.name),c()},e.setCompanyByType=function(t,a){e.asset[a]=t.name},e.setSite=function(t){e.asset.site=t,e.asset.siteGroup=t.siteGroup},e.openDatePicker=function(e){e.open=!0},e.updateDateTime=function(t){(e.asset[t].date&&!e.asset[t].time||!e.asset[t].date&&e.asset[t].time)&&(e.asset[t].time=_.clone(e.asset[t].date));var a=moment(e.asset[t].time);e.asset[t].value=moment(e.asset[t].date).set("hours",a.get("hours")).set("minutes",a.get("minutes")).valueOf()},e.setPrimaryCapability=function(t){e.asset.primaryCapability=t},e.getSitesByText=function(e){return o.getSitesByText(e).then(function(e){return{list:e.list,exceedsChunkSize:e.exceedsChunkSize}})},e.getList=function(e,t){return r.getList(e,t)},p()}])}(),angular.module("assetModule").directive("assetUpdate",["relationModel","assetModel",function(){return{restrict:"E",templateUrl:"views/asset/asset-update-action-blade.html",replace:!0,scope:{linkParams:"=",modalInstance:"=",asset:"=assetUpdateData",assetUpdateFields:"=",assetUpdateForm:"="},controller:"AssetUpdateController"}}]),function(){angular.module("assetModule").controller("BcmAssetActionController",["$scope","$modalInstance","linkParams","$compile","assetModel","$timeout","systemAlertService","$modal",function(e,t,a,n,i,o,r,s){function l(e){var t,a=[];if(e)for(t in e.fields)e.fields.hasOwnProperty(t)&&a.push({field:"fields['"+t+"']",displayName:t});return a}function c(t){e.state.isDataLoading=!1,t.data&&t.data.error&&("BCM_Unauthorized"===t.data.error?d():r.error({
text:t.data.error,clear:!1}))}function d(){var t=s.open({templateUrl:"views/common/bcm-credentials-template.html",windowClass:"bcm-credential-alert-modal",controller:"BcmCredentialAlertController"});t.result.then(function(){e.changeTab(e.state.name)})}function u(){e.generalData?o(function(){e.state.isDataLoading=!1},100):i.getBcmAssetGeneralData().then(function(t){e.generalData=t.general,e.generalGridOptions=angular.copy(T),e.generalGridOptions.data="generalData",e.generalGridOptions.columnDefs=l(t.general[0]),e.state.general={pager:!1},e.keywordTranslation.hardware=angular.copy(t.hardware.KeywordTranslation),delete t.hardware.KeywordTranslation,e.hardwareData=t.hardware,e.state.hardware={pager:!1}})["catch"](c)["finally"](function(){e.state.isDataLoading=!1})}function p(){e.hardwareData?e.state.isDataLoading=!1:i.getBcmAssetHardwareData().then(function(t){e.keywordTranslation.hardware=angular.copy(t.KeywordTranslation),delete t.KeywordTranslation,e.hardwareData=t,e.state.hardware={pager:!1}})["catch"](c)["finally"](function(){e.state.isDataLoading=!1})}function m(){e.securityData?e.state.isDataLoading=!1:i.getBcmAssetSecurityData().then(function(t){e.keywordTranslation.security=angular.copy(t.KeywordTranslation),delete t.KeywordTranslation,e.securityData=t,e.state.security={pager:!1}})["catch"](c)["finally"](function(){e.state.isDataLoading=!1})}function f(){e.softwareData?o(function(){e.state.isDataLoading=!1},100):(e.state.software={offset:0,total:0,pager:!0},i.getBcmAssetSoftwareData(e.state.software.offset).then(function(t){e.softwareData=t.sObjects,e.state.software.total=t.total,e.softwareGridOptions=angular.copy(T),e.softwareGridOptions.data="softwareData",e.softwareGridOptions.columnDefs=l(t.sObjects[0])})["catch"](c)["finally"](function(){e.state.isDataLoading=!1}))}function g(){e.actionData?o(function(){e.state.isDataLoading=!1},100):(e.state.action={offset:0,total:0,pager:!0},i.getBcmAssetActionHistory(e.state.action.offset).then(function(t){e.actionData=t.aObjects,e.state.action.total=t.total,e.actionGridOptions=angular.copy(T),e.actionGridOptions.data="actionData",e.actionGridOptions.columnDefs=l(t.aObjects[0])})["catch"](c)["finally"](function(){e.state.isDataLoading=!1}))}function h(){e.financialData?o(function(){e.state.isDataLoading=!1},100):i.getBcmAssetFinancialData().then(function(t){e.financialData=t,e.financialGridOptions=angular.copy(T),e.financialGridOptions.data="financialData",e.financialGridOptions.columnDefs=l(t[0]),e.state.financial={pager:!1}})["catch"](c)["finally"](function(){e.state.isDataLoading=!1})}function y(){e.state.software.offset=e.softwareData.length,e.state.software.offset<e.state.software.total&&!e.state.loadingMore&&(e.state.loadingMore=!0,i.getBcmAssetSoftwareData(e.state.software.offset).then(function(t){e.softwareData=_.union(e.softwareData,t.sObjects)})["catch"](c)["finally"](function(){e.state.isDataLoading=!1,e.state.loadingMore=!1}))}function E(){e.state.action.offset=e.actionData.length,e.state.action.offset<e.state.action.total&&!e.state.loadingMore&&(e.state.loadingMore=!0,i.getBcmAssetActionHistory(e.state.action.offset).then(function(t){e.actionData=_.union(e.actionData,t.aObjects)})["catch"](c)["finally"](function(){e.state.isDataLoading=!1,e.state.loadingMore=!1}))}e.state={isDataLoading:!0,loadingMore:!1,name:"general"},e.asset=a.entity;var v={init:function(t,a){a.$viewport.append(n('<div class="ngLoadingMoreSpinnerContainer" ng-if="state.loadingMore"><div loading-spinner if="true" inline="true" centered="true"></div></div>')(e))}},T={headerRowHeight:43,rowHeight:40,enableRowSelection:!1,enableColumnResize:!0,plugins:[v]};e.$on("ngGridEventScroll",function(){e.state[e.state.name].pager&&("software"===e.state.name?y():"action"===e.state.name&&E())}),e.keywordTranslation=[],e.isArray=function(e){return e instanceof Array},e.getKeywordTranslation=function(t,a){return e.keywordTranslation[a][t]||t},e.changeTab=function(t){switch(e.state.isDataLoading=!0,e.state.name=t,t){case"general":u();break;case"hardware":p();break;case"software":f();break;case"financial":h();break;case"security":m();break;case"action":g()}},e.isEmpty=function(e){return _.isEmpty(e)}}])}(),function(){angular.module("assetModule").controller("BcmCredentialAlertController",["$scope","$filter","userModel","$modalInstance",function(e,t,a,n){e.errorGeneral="";var i={loginPending:!1},o="",r=function(){var t=e.bcmLoginForm;return t.username||(o="usernameRequired"),t.password||(o="passwordRequired"),t.username||t.password||(o="usernameAndPasswordRequired"),o};e.state=i,e.bcmLoginForm={username:"",password:"",submitForm:function(){e.errorGeneral="";var s=this;return o=null,i.loginPending=!0,r()?(e.errorMessageType=o,void(i.loginPending=!1)):void a.doBCMLogin(s.username,s.password).then(function(){i.loginPending=!1,s.password="",n.close()})["catch"](function(a){a.data&&a.data.error?"BCM_Unauthorized"===a.data.error?e.errorGeneral=t("i18n")("user.loginError.1006"):e.errorGeneral=a.data.error:o=a.status,i.loginPending=!1,s.password=""})}}}])}(),function(){angular.module("assetModule").factory("ciExplorerCache",["$log",function(e){function t(e,t){for(var a=0;a<e;a++)t.push({realObject:{name:a+1,isChild:!0},instanceId:"ACC"+a,assetType:"Software"})}function a(e){return JSON.stringify(e)}function n(){}var i={totalCount:198,relatedCis:[]};t(100,i.relatedCis),i.relatedCis[0]={relationshipClassId:"BMC_BaseRelationship",type:"asset",parentId:"ASHAA5V0GQBORANBA2B584OBL2G6PM",relationshipType:"allrelated",realObject:{reconciliationId:"REHAA5V0GQBORANBA16O83BDO6G66M",name:"Dell Latitude E6430 with a display, hard-drive, floppy disk, vintage cd-rom drive, and non-laser mouse",classId:"BMC_COMPUTERSYSTEM",status:{value:"In Repair Very Often"},hasImpact:!0,isParent:!0,isChild:!1,instanceId:"ASHAA5V0GQBORANBA16O83BDO6G66K",assetType:"Computer System",manufacturer:"Dell Group Incorporated",model:"E6430 XC1 BN234 77 XL",assetId:"GCS000000000002"},id:"REHAA5V0GQBORANBA2B584OBL2G6PO"},i.relatedCis[1]={relationshipClassId:"BMC_BaseRelationship",type:"asset",parentId:"ASHAA5V0GQBORANBA2B584OBL2G6PM",relationshipType:"component",realObject:{reconciliationId:"REHAA5V0GQBORANBA16O83BDO6G66M",name:"Dell Latitude E6430",classId:"BMC_COMPUTERSYSTEM",status:{value:"In Repair"},hasImpact:!1,isParent:!1,isChild:!0,instanceId:"ASHAA5V0GQBORANBA16O83BDO6G66K",assetType:"Computer System",manufacturer:"Dell",model:"E6430",assetId:"GCS000000000002"},id:"REHAA5V0GQBORANBA2B584OBL2G6PO"},i.relatedCis[2]={relationshipClassId:"BMC_BaseRelationship",type:"asset",parentId:"ASHAA5V0GQBORANBA2B584OBL2G6PM",relationshipType:"dependency",realObject:{reconciliationId:"REHAA5V0GQBORANBA16O83BDO6G66M",name:"Dell Latitude E6430 with a display, hard-drive, floppy disk, vintage cd-rom drive, and non-laser mouse",classId:"BMC_COMPUTERSYSTEM",status:{value:"In Repair Very Often"},hasImpact:!1,isParent:!1,isChild:!1,instanceId:"ASHAA5V0GQBORANBA16O83BDO6G66K",assetType:"Computer System",manufacturer:"Dell Group Incorporated",model:"E6430 XC1 BN234 77 XL",assetId:"GCS000000000002"},id:"REHAA5V0GQBORANBA2B584OBL2G6PO"};var o={totalCount:198,relatedCis:[]};t(98,o.relatedCis);var r={totalCount:105,relatedCis:[]};t(r.totalCount,r.relatedCis);var s={totalCount:10,relatedCis:[]};t(s.totalCount,s.relatedCis);var l={};return n(),{get:function(t){return e.log(a(t)),_.cloneDeep(l[a(t)])},put:function(e,t){l[a(e)]=_.cloneDeep(t)},reset:n}}])}(),function(){angular.module("assetModule").factory("ciExplorerModel",["assetConsoleModel","$q","ciExplorerCache","$filter",function(e,t,a,n){function i(){m.relationshipTypesLoading=!0,e.getRelationshipTypes({classId1:"BMC_SYSTEM",classId2:null}).then(function(e){m.relationshipTypesLoading=!1,m.relationshipTypes=e,o()})}function o(){m.relationshipType=null}function r(){if(!m.currentCi||!l(m.currentCi))return t.when(c([],0));if(m.totalCount&&m.totalCount<=m.relatedCis.length)return t.when(c(m.relatedCis,m.totalCount));var a="BMC.CORE:BMC_BASERELATIONSHIP",n={filterCriteria:{id:l(m.currentCi),relationshipTypes:[m.relationshipType&&m.relationshipType.relationshipClassName||a]},chunkInfo:{startIndex:m.relatedCis.length,chunkSize:100},sortInfo:{}};angular.merge(n.filterCriteria,s());var i=m.ciCache.get(n);return i?(m.totalCount=i.totalCount,m.relatedCis=m.relatedCis.concat(i.relatedCis),d(),t.when(c(m.relatedCis,m.totalCount))):(m.loading=!0,e.getRelatives(n).then(function(e){return m.loading=!1,m.relatedCis=m.relatedCis.concat(e.relatives),m.totalCount=e.totalCount,d(),m.ciCache.put(n,c(e.relatives,m.totalCount)),t.when(c(m.relatedCis,m.totalCount))}))}function s(){var e,t,a,n=angular.copy(m.filters.selected),i={},o="sites",r=[],s={},l={},c={};return _.forEach(n,function(d){var u=d.criteria,p=_.isArray(u.value),m=u.name;i[m]?p?i[m]=_.union(i[m],u.value):(n.splice(_.findIndex(n,{name:d.name}),1),i[m]=u.value):"region"===u.name||"siteGroup"===u.name||"sites"===u.name?("region"===u.name?(e=u.name,s=u.value[0],s.id=e,r.push(s)):"siteGroup"===u.name?(t=u.name,l=u.value[0],l.id=t,r.push(l)):"sites"===u.name&&(a=u.name,c=u.value[0],c.id=a,r.push(c)),i[o]=r):i[m]=u.value}),i}function l(e){return e.instanceId||e.realObject&&e.realObject.instanceId}function c(e,t){return{totalCount:t,relatedCis:e}}function d(){f.update(m.currentCi),m.navigationCis=f.all}function u(e){if(p(e))return e;for(var t=14,a=1;;a++){var n=a*t+(a-1);if(!(e.length>n))break;e=e.substring(0,n)+"\n"+e.substring(n)}return e}function p(e){return/\s/.test(e)}var m={currentCi:null,totalCount:0,relatedCis:[],navigationCis:[],ciCache:a,filters:{selected:[]},displayCi:function(e){this.currentCi=e,this.relatedCis=[e],r(),d()},displayRelations:function(e){return this.currentCi=e,this.totalCount=0,this.relatedCis=[],r()},displayMoreRelations:function(){return r()},reset:function(e){this.currentCi=null,this.ciCache.reset(),f.reset(),e&&(o(),this.filters.selected=[])},getAssetDisplayName:function(e){var t=this.getAssetName(e);return this.getShortGraphLabel(t)},getAssetName:function(e){return u(e?e.name||e.realObject&&e.realObject.name||"":"")},getShortGraphLabel:function(e){var t=60,a=e.length>t?e.substring(0,t)+"...":e;return u(a)},getGraphLabel:function(e){return u(e)},getRelationshipTypeLabel:function(e){var t="common.relationship.type."+e,a=n("i18n")(t);if(a!==t)return a;if(this.relationshipTypes){var i=_.head(_.filter(this.relationshipTypes,{value:e}));return i?i.label:e}return e}},f={all:[],update:function(e){if(e&&l(e)){var t=_.filter(this.all,function(t){return l(t)===l(e)});if(t.length>0){t=t[0];var a=this.all.indexOf(t);this.all.splice(a+1,this.all.length)}else this.all.push(e)}},reset:function(){this.all=[]}};return i(),m}])}(),function(){angular.module("assetModule").directive("ciExplorerSearchFilter",["ciExplorerModel","configurationModel","metadataModel","$q","categoriesService","userModel",function(e,t,a,n,i,o){return{restrict:"E",templateUrl:"views/asset/ci-explorer-search-filter.html",scope:{apply:"&",view:"@"},link:function(r){function s(e){return _.map(e,"name").join(",")}function l(){r.filters={config:"list"===r.view?angular.copy(t.get("ciSearch.assetListExplorerFilter")):angular.copy(t.get("ciSearch.assetGraphExplorerFilter"))};var e=_.keyBy(r.filters.config,"label"),s=null;a.getMetadataByType(EntityVO.TYPE_ASSET).then(function(t){s=t,_.forEach(t.assetTypes,function(t){e.ciType.options.push({name:t.label,type:"dynamic",criteria:{name:"assetTypes",value:[t.name]},criteriaValue:t.name}),t.subType.forEach(function(a){e.assetSubType.options.push({name:a.label,type:"dynamic",filterName:"assetSubTypes",onDisplay:!0,criteria:{name:"assetSubTypes",value:[a.name],typeName:t.name}})})})}),n.all([o.userFullData]).then(function(){var t=_.find(e.site.options,{label:"mySite"});t.criteria.value=[{name:o.userFullData.site.name,companyName:o.userFullData.company.name,region:o.userFullData.site.region,siteGroup:o.userFullData.site.siteGroup}],t.subLabel=o.userFullData.site.name;var a=_.find(e.siteGroup.options,{label:"mySiteGroup"});a.criteria.value=[{companyName:o.userFullData.company.name,region:o.userFullData.site.region,siteGroup:o.userFullData.site.siteGroup}],a.subLabel=o.userFullData.site.siteGroup;var n=_.find(e.region.options,{label:"myRegion"});n.criteria.value=[{companyName:o.userFullData.company.name,region:o.userFullData.site.region}],n.subLabel=o.userFullData.site.region}),r.getProductCategoriesByCompany=function(e){var t=o.userFullData.company,a="product",n={entityType:EntityVO.TYPE_ASSET,categoryType:a,searchText:e,criteria:{company:t}};return i.searchCategories(n).then(function(e){var t=_.find(s.categories,function(e){return e.name===a});return _.map(e.items,function(e){if(e.length){for(var n=_.compact(e).join(" > "),i={},o=0;o<t.listOfTiers.length;o++)i[t.listOfTiers[o].name]=e[o];return{value:n,attributeMap:{categorizations:[{name:a,tiers:i}]}}}})})}}r.model=e;var c="";r.$watch("model.relationshipTypesLoading",function(e){if(!e&&"list"===r.view){var t=_.keyBy(r.filters.config,"label");_.forEach(r.model.relationshipTypes,function(e){t.relationshipType.options.push({name:e.label,type:"dynamic",criteria:{name:"relationshipTypes",value:[e.relationshipClassName]}})})}}),r.$watch("model.filters.selected",function(){var e=s(r.model.filters.selected);e!==c&&(c=e,r.apply&&r.apply())},!0),l()}}}])}(),function(){angular.module("assetModule").directive("ciRelationTypeSelection",["systemAlertService","i18nService","ciExplorerModel",function(e,t,a){return{restrict:"E",templateUrl:"views/asset/ci-relation-type-selection.html",scope:{rootCi:"=",reset:"&"},link:function(n){function i(){var a=e.modal({title:t.getLocalizedString("common.notification.asset.explorer.title"),text:t.getLocalizedString("common.notification.asset.explorer.message"),buttons:[{text:t.getLocalizedString("common.labels.yes"),data:{proceed:!0}},{text:t.getLocalizedString("common.labels.no"),data:{proceed:!1}}]});return a.result}var o=null;n.model=a,n.$watch("model.relationshipTypesLoading",function(e){e||(o=a.relationshipType=_.head(_.filter(a.relationshipTypes,{value:"BMC_Impact"})),n.relationshipTypes=_.filter(a.relationshipTypes,function(e){return"BMC_BaseRelationship"!==e.value}))}),n.updateRelationshipType=function(e){n.rootCi.relationsLoaded||n.rootCi.parentsLoaded?i().then(function(t){t.proceed?(n.reset(),o=e):a.relationshipType=o}):o=e}}}}])}(),function(){angular.module("myitsmApp").directive("editAssetOwner",["createTicketModel","events","configurationModel","searchService","searchModel","$timeout",function(e,t,a,n,i,o){return{restrict:"EA",scope:{update:"&",asset:"="},templateUrl:"views/asset/edit-asset-owner.html",link:function(n){var i={relationshipType:"",type:"person",subType:"People",id:"",details:{isPrimaryContact:!0}};n.showMailstopOnPersoncard=a.showMailstopOnPersoncard,n.showPhoneNumOnPersonCard=a.showPhoneNumOnPersonCard,n.siteFoundation={siteOptions:{company:{visible:!1,attribute:"companyName"},region:{attribute:"region"},siteGroup:{attribute:"siteGroup"},site:{attribute:"name"}},selectedSite:{companyName:n.asset.company?n.asset.company.name:"",region:n.asset.site&&n.asset.site.region?n.asset.site.region:"",siteGroup:n.asset.site&&n.asset.site.siteGroup?n.asset.site.siteGroup:"",name:n.asset.site&&n.asset.site.name?n.asset.site.name:""}},n.person={},n.updateAssetSite={},n.state={},n.selections={},n.selected={},n.relationData=i,n.isFieldValid=function(){return!n.asset||n.asset.type!==EntityVO.TYPE_NETWORK},n.assetOwnerRoles=_.find(a.get("link")[EntityVO.TYPE_PERSON],{type:EntityVO.TYPE_PERSON}).relations,n.getList=function(t,a){return"person"===t?e.getList(t,a).then(function(e){return n.isTooltipOpenOwner=n.exceedsChunkSizeOwner=e.exceedsChunkSize,o(function(){n.isTooltipOpenOwner=!1},1e4),e.items}):e.getList(t,a)},n.onInputFocusBlur=function(){n.isTooltipOpenOwner=!1},n.clearPerson=function(){n.person.data="",i.id="",n.selectedOwner={}},n.updateAssetOwner=function(e){i.id=e.personId,n.selectedOwner=angular.copy(e)},n.save=function(){var e={relationData:i,siteData:n.updateAssetSite};n.update({data:e}),n.$emit(t.SAVE_CHANGES_COMPLETE)};var r=function(){console.log("handleSaveChanges in editAssetOwner"),n.updateAssetSite.name=n.siteFoundation.selectedSite.name||"",n.updateAssetSite.region=n.siteFoundation.selectedSite.region||"",n.updateAssetSite.siteGroup=n.siteFoundation.selectedSite.siteGroup||"",n.save()},s=function(){_.isEmpty(n.asset.owner)?n.relationData.relationshipType="ownedby":(n.person.data=angular.copy(n.asset.owner.realObject.fullName),n.relationData.relationshipType=angular.copy(n.asset.owner.relationshipType),n.relationData.id=angular.copy(n.asset.owner.displayId)),n.updateAssetSite=angular.copy(n.asset.site)};n.$on(t.TOGGLE_EDIT_MODE,s),n.$on(t.SAVE_CHANGES,r)}}}])}(),function(){angular.module("assetModule").directive("graphicalCi",["$timeout","$window","browser","ciExplorerModel","systemAlertService","i18nService","$filter","$modal","$state",function(e,t,a,n,i,o,r,s,l){return{restrict:"E",replace:!0,scope:{rootCi:"="},templateUrl:"views/asset/graphical-ci.html",link:function(t,c){function d(){var e=O(),t=[];return _.each(e,function(e){_.each(e.nodes,function(e){var a=e.data("ci");a&&t.push(a)})}),t}function u(e){for(var t;t=e.shift();){var a=$(t);if(a.length>0&&t.relationsLoaded){t.relationsLoaded=!1,a.data("ci",t),y(t).then(function(){u(e)});break}}}function p(e){if(!q(e))if(P(e))m(e);else if(L(e))f(e);else{var t=e.data("ci"),a=b(e);if(P(a))m(a),t.expanded=!0;else{if(!t.relationsLoaded)return void y(t);t.expanded?V(t):M(t),G(t),t.expanded=!t.expanded}}}function m(e){e.hide();var t=e.data("nodes");F(t,!0),t.show(),G()}function f(e){var t=e.data("totalCount");t>Se?g():0===t&&e.remove()}function g(){i.modal({title:o.getLocalizedString("common.notification.asset.explorer.title"),text:o.getLocalizedString("common.notification.asset.explorer.largeNode.message"),buttons:[{text:o.getLocalizedString("common.labels.ok")}]})}function h(){t.cy.add([U(t.rootCi)]),G(t.rootCi)}function y(e){return n.displayRelations(e).then(function(a){e.relationsLoaded=!0;var n=_.filter(a.relatedCis,{realObject:{isChild:!0}}),i=a.totalCount-(a.relatedCis.length-n.length);e.expanded=!0;var o=[],r=[],s=B(Q(e)),l=0===s.length||0!==i;if(i<=Se&&l)s.remove(),_.each(n,function(t){o.push(U(t));var a=X(e,t);a&&r.push(a),H(t)&&(a=X(t,e,!0),a&&r.push(a))});else{0===s.length&&(s=t.cy.add(K(e,i))),s.data("label",J(i)),s.data("totalCount",i);var c=ee($(e),s);c&&r.push(c)}t.cy.add(o),t.cy.add(r),C(),G(e)})}function E(e){return n.displayRelations(e).then(function(a){e.parentsLoaded=!0;var n=_.filter(a.relatedCis,{realObject:{isParent:!0}}),i=[],o=[];_.each(n,function(t){i.push(z(t));var a=X(t,e,!0);a&&o.push(a)}),t.cy.add(i),t.cy.add(o),C(),S(!0),G(e)})}function v(){Y(t.cy.nodes().roots()).hide(),S(!1),G()}function T(){Y(t.cy.nodes().roots()).show(),S(!0),G()}function S(e){t.rootCi.parentsLoaded&&(t.rootCi.parentsShown=e)}function C(){var e=O();if(!(e.length<=1))for(var a=function(e){s+=e.data("totalCount")},n=1;n<e.length;n++){var i=e[n].nodes,o=e[n].groupNodes;0===o.length&&(o=t.cy.add(j(n,i.length)),o.hide());var r=w(i),s=i.length-r.length;_.each(r,a),o.data("label",J(s)),o.data("nodes",i),N(e[n-1].allNodes,o),N(e[n-1].groupNodes,i)}}function O(){ce();for(var e=1,a=[],n={},i=$(t.rootCi),o=function(t){var a=t.data("id");t.data("level",e),n[a]||(s[a]=t,n[a]=t)},r=function(e){var t=e.data("id");return!!s[t]};0!=i.length;){var s={};_.each(i,o),s=i.filterFn(r),s.length>0&&a.push({allNodes:s,nodes:D(s),groupNodes:R(s)}),i=k(s.outgoers()),e++}return de(),a}function A(){return t.cy.elements().filter(":visible")}function I(e){return e.filter(":visible")}function b(e){return I(e.outgoers().filter("node"))}function k(e){return e.filter("node")}function D(e){return e.filter("node").filterFn(function(e){return!P(e)})}function R(e){return e.filter("node").filterFn(function(e){return P(e)})}function P(e){return e.hasClass("group-node")}function w(e){return e.filter("node").filterFn(function(e){return L(e)})}function L(e){return e.hasClass("large-node")}function N(e,a){_.each(e,function(e){_.each(a,function(a){var n=ee(e,a);n&&t.cy.add(n)})})}function M(e){ce();var t=$(e);D(t.outgoers()).show(),de()}function V(e){ce();var t=$(e);F(D(t.successors()),!1),k(t.successors()).hide(),de()}function F(e,t){_.each(e,function(e){e.data("ci").expanded=t})}function x(){t.cy.elements().remove(),Te=[]}function G(a){var n=A(),i=n.layout({name:"dagre",fit:!1,ready:function(){e(function(){if(a){var e=$(a);t.cy.center(e)}else t.cy.fit(n),t.cy.zoom()>ge&&t.cy.zoom(ge),t.cy.center(n)})}});i.run()}function $(e){return B(ae(e))}function B(e){return t.cy.$("#"+e)}function U(e){var t=ne(e);return{group:"nodes",data:{id:ae(e),ci:e,label:re(e),shortLabel:se(e),icon:t},classes:t}}function z(e){var t=U(e);return t.data.isParent=!0,t}function Y(e){return e.filter("node").filterFn(function(e){return q(e)})}function q(e){return e.data("isParent")&&0===e.incomers().length}function H(e){return!!e.realObject&&(e.realObject.isParent&&e.realObject.isChild)}function K(e,t){return{group:"nodes",data:{id:Q(e),ci:{},parentCi:e,label:J(t),totalCount:t},classes:"large-node collapsed-node"}}function j(e,t){return{group:"nodes",data:{id:W(e),label:J(t)},classes:"group-node collapsed-node"}}function W(e){return"groupNode__"+e}function Q(e){return ae(e)+"_large"}function J(e){return r("i18n")("asset.explorer.relatives.count",e)}function Z(e,t,a){var n=e+t;if(Te[n])return null;var i=2147483647,o=B(e),r=B(t),s=o.data("level")||i,l=r.data("level")||i;a=!!a,s>l&&(a=!0);var c={group:"edges",data:{source:e,target:t,isUpstream:a}};return Te[n]=c,c}function X(e,t,a){return Z(ae(e),ae(t),a)}function ee(e,t,a){return Z(e.data("id"),t.data("id"),a)}function te(e){return{assetId:e.reconciliationId||e.realObject.reconciliationId,assetClassId:e.classId||e.realObject.classId}}function ae(e){return e.instanceId||e.realObject&&e.realObject.instanceId}function ne(e){var t=ie(e.classId);if(t)return t.toLowerCase().replace(" ","");var a="other",n=e.assetType||e.realObject&&e.realObject.assetType||a;return n.toLowerCase().replace(" ","")}function ie(e){for(var t=0;t<me.length;t++)if(me[t].name===e)return me[t].label}function oe(e){return e+"-selected selected"}function re(e){return t.model.getAssetName(e)+le(e)}function se(e){return t.model.getAssetDisplayName(e)+le(e)}function le(e){return t.rootCi===e?" ["+r("i18n")("asset.explorer.root")+"]":""}function ce(){Ce||(Ce=t.cy.edges("edge[?isUpstream]"),Ce.remove())}function de(){Ce&&(Ce.restore(),Ce=null)}function ue(){var e=cytoscape.stylesheet().selector("node[?hover]").css({content:"data(label)"}).selector("node[!hover]").css({content:"data(shortLabel)"}).selector("node").css({"background-fit":"cover","font-size":8,shape:"rectangle","background-opacity":0,"text-valign":"bottom","text-wrap":"wrap","text-max-width":80}).selector("node.selected").css({"background-fit":"cover","font-size":8,shape:"rectangle","background-opacity":0,"text-valign":"bottom"}).selector(".big-node").css({width:35,height:35}).selector(".small-node").css({height:20,width:20,"background-fit":"cover",content:"data(label)","font-size":5,"background-opacity":0,"text-valign":"bottom"}).selector("edge").css({width:.3,"line-color":"#666666","target-arrow-shape":"triangle","curve-style":"straight"}).selector(".group-node").css({shape:"roundrectangle"}).selector(".collapsed-node").css({content:"data(label)",color:"#2bb5dc","background-color":"#2bb5dc","background-opacity":.5,"background-image":"none","border-width":.2,"font-size":10,"text-valign":"center","word-wrap":"break-word",height:40,width:100}).selector(".expanded-node").css({content:"","background-color":"#2bb5dc","background-opacity":.2,"background-image":"none","border-width":.2}).selector(".large-node").css({shape:"roundrectangle","background-color":"#89c341"}).selector(".hidden-node").css({visibility:"hidden"}).selector(".expand-button").css({height:"30px",width:"75px"});return a.isIE?e.selector("node").css({"background-image":"styles/img/ci-type-icons/generic_ci.png"}).selector("node.selected").css({"background-image":"styles/img/ci-type-icons/generic_ci_selected.png"}).selector(".businessservice").css({"background-image":"styles/img/ci-type-icons/service.png"}).selector(".businessservice-selected").css({"background-image":"styles/img/ci-type-icons/service_selected.png"}).selector(".collapsed-node").css({"background-image":"none"}).selector(".expanded-node").css({"background-image":"none"}).selector(".application").css({"background-image":"styles/img/ci-type-icons/application.png"}).selector(".application-selected").css({"background-image":"styles/img/ci-type-icons/application_selected.png"}).selector(".cluster").css({"background-image":"styles/img/ci-type-icons/cluster.png"}).selector(".cluster-selected").css({"background-image":"styles/img/ci-type-icons/cluster_selected.png"}).selector(".computersystem").css({"background-image":"styles/img/ci-type-icons/computer_system.png"}).selector(".computersystem-selected").css({"background-image":"styles/img/ci-type-icons/computer_system_selected.png"}).selector(".database").css({"background-image":"styles/img/ci-type-icons/database.png"}).selector(".database-selected").css({"background-image":"styles/img/ci-type-icons/database_selected.png"}).selector(".filesystem").css({"background-image":"styles/img/ci-type-icons/file_system.png"}).selector(".filesystem-selected").css({"background-image":"styles/img/ci-type-icons/file_system_selected.png"}).selector(".group").css({"background-image":"styles/img/ci-type-icons/group.png"}).selector(".group-selected").css({"background-image":"styles/img/ci-type-icons/group_selected.png"}).selector(".media").css({"background-image":"styles/img/ci-type-icons/media.png"}).selector(".media-selected").css({"background-image":"styles/img/ci-type-icons/media_selected.png"}).selector(".network").css({"background-image":"styles/img/ci-type-icons/network.png"}).selector(".network-selected").css({"background-image":"styles/img/ci-type-icons/network_selected.png"}).selector(".people").css({"background-image":"styles/img/ci-type-icons/people.png"}).selector(".people-selected").css({"background-image":"styles/img/ci-type-icons/people_selected.png"}).selector(".resource").css({"background-image":"styles/img/ci-type-icons/resource.png"}).selector(".resource-selected").css({"background-image":"styles/img/ci-type-icons/resource_selected.png"}).selector(".service").css({"background-image":"styles/img/ci-type-icons/service.png"}).selector(".service-selected").css({"background-image":"styles/img/ci-type-icons/service_selected.png"}).selector(".software").css({"background-image":"styles/img/ci-type-icons/software.png"}).selector(".software-selected").css({"background-image":"styles/img/ci-type-icons/software_selected.png"}).selector(".ups").css({"background-image":"styles/img/ci-type-icons/ups.png"}).selector(".ups-selected").css({"background-image":"styles/img/ci-type-icons/ups_selected.png"}).selector(".collapsed-node").css({"background-image":"none"}):e.selector("node").css({"background-image":"styles/img/ci-type-icons/generic_ci.svg"}).selector("node.selected").css({"background-image":"styles/img/ci-type-icons/generic_ci_selected.svg"}).selector(".businessservice").css({"background-image":"styles/img/ci-type-icons/service.png"}).selector(".businessservice-selected").css({"background-image":"styles/img/ci-type-icons/service_selected.png"}).selector(".collapsed-node").css({"background-image":"none"}).selector(".expanded-node").css({"background-image":"none"}).selector(".application").css({"background-image":"styles/img/ci-type-icons/application.svg"}).selector(".application-selected").css({"background-image":"styles/img/ci-type-icons/application_selected.svg"}).selector(".cluster").css({"background-image":"styles/img/ci-type-icons/cluster.svg"}).selector(".cluster-selected").css({"background-image":"styles/img/ci-type-icons/cluster_selected.svg"}).selector(".computersystem").css({"background-image":"styles/img/ci-type-icons/computer_system.svg"}).selector(".computersystem-selected").css({"background-image":"styles/img/ci-type-icons/computer_system_selected.svg"}).selector(".database").css({"background-image":"styles/img/ci-type-icons/database.svg"}).selector(".database-selected").css({"background-image":"styles/img/ci-type-icons/database_selected.svg"}).selector(".filesystem").css({"background-image":"styles/img/ci-type-icons/file_system.svg"}).selector(".filesystem-selected").css({"background-image":"styles/img/ci-type-icons/file_system_selected.svg"}).selector(".group").css({"background-image":"styles/img/ci-type-icons/group.svg"}).selector(".group-selected").css({"background-image":"styles/img/ci-type-icons/group_selected.svg"}).selector(".media").css({"background-image":"styles/img/ci-type-icons/media.svg"}).selector(".media-selected").css({"background-image":"styles/img/ci-type-icons/media_selected.svg"}).selector(".network").css({"background-image":"styles/img/ci-type-icons/network.svg"}).selector(".network-selected").css({"background-image":"styles/img/ci-type-icons/network_selected.svg"}).selector(".people").css({"background-image":"styles/img/ci-type-icons/people.svg"}).selector(".people-selected").css({"background-image":"styles/img/ci-type-icons/people_selected.svg"}).selector(".resource").css({"background-image":"styles/img/ci-type-icons/resource.svg"}).selector(".resource-selected").css({"background-image":"styles/img/ci-type-icons/resource_selected.svg"}).selector(".service").css({"background-image":"styles/img/ci-type-icons/service.svg"}).selector(".service-selected").css({"background-image":"styles/img/ci-type-icons/service_selected.svg"}).selector(".software").css({"background-image":"styles/img/ci-type-icons/software.svg"}).selector(".software-selected").css({"background-image":"styles/img/ci-type-icons/software_selected.svg"}).selector(".ups").css({"background-image":"styles/img/ci-type-icons/ups.svg"}).selector(".ups-selected").css({"background-image":"styles/img/ci-type-icons/ups_selected.svg"}),e}var pe,me=[{name:"BMC_PROTOCOLENDPOINT",label:"Protocol Endpoint"},{name:"BMC_NTDOMAIN",label:"NT Domain"},{name:"BMC_CONNECTIVITYGROUP",label:"Connectivity Collection"},{name:"BMC_CONNECTIVITYSEGMENT",label:"Connectivity Segment"},{name:"BMC_IPCONNECTIVITYSUBNET",label:"IP Connectivity Subnet"},{name:"BMC_IPXCONNECTIVITYNETWORK",label:"IPX Connectivity Network"},{name:"BMC_LNSGROUP",label:"LNs Collection"},{name:"BMC_NETWORKPORT",label:"Network Port"},{name:"BMC_LAN",label:"Local Area Network (LAN)"},{name:"BMC_WAN",label:"Wide Area Network (WAN)"},{name:"BMC_COMMUNICATIONENDPOINT",label:"Communication Endpoint"},{name:"BMC_IPENDPOINT",label:"IP Endpoint"},{name:"BMC_LANENDPOINT",label:"LAN Endpoint"},{name:"BMC_ADMINDOMAIN",label:"Admin Domain"},{name:"BMC_CLUSTER",label:"Cluster"},{name:"BMC_BUSINESSSERVICE",label:"Business Service"},{name:"BMC_APPLICATION",label:"Application"},{name:"BMC_OPERATINGSYSTEM",label:"Operating System"},{name:"BMC_APPLICATIONINFRASTRUCTURE",label:"Application Infrastructure"},{name:"BMC_DATABASE",label:"Database"},{name:"BMC_DISKPARTITION",label:"Disk Partition"},{name:"BMC_FILESYSTEM",label:"File System"},{name:"BMC_SHARE",label:"Share"},{name:"BMC.CORE:BMC_RASD",label:"Resource Allocation Setting Data"},{name:"BMC.CORE:BMC_VIRTUALSYSTEMSETTINGDATA",label:"Virtual System Setting Data"},{name:"BMC_PATCH",label:"Patch"},{name:"BMC_PRODUCT",label:"Product"},{name:"BMC_APPLICATIONSYSTEM",label:"Application System"},{name:"BMC_APPLICATIONSERVICE",label:"Application Service"},{name:"BMC_BIOS",label:"BIOS Element"},{name:"BMC_SOFTWARESERVER",label:"Software Server"},{name:"BMC_SYSTEMSOFTWARE",label:"System Software"},{name:"BMC_VIRTUALSYSTEMENABLER",label:"Virtual System Enabler"},{name:"BMC_PACKAGE",label:"Package"},{name:"BMC_DATABASESTORAGE",label:"Database Storage"},{name:"BMC_LOCALFILESYSTEM",label:"Local File System"},{name:"BMC_REMOTEFILESYSTEM",label:"Remote File System"},{name:"BMC_CARD",
label:"Card"},{name:"BMC_CHASSIS",label:"Chassis"},{name:"BMC_RACK",label:"Rack"},{name:"BMC_HARDWAREPACKAGE",label:"Hardware Package"},{name:"BMC_KEYBOARD",label:"Keyboard"},{name:"BMC_MEDIA",label:"Media"},{name:"BMC_MEMORY",label:"Memory"},{name:"BMC_MONITOR",label:"Monitor"},{name:"BMC_POINTINGDEVICE",label:"Pointing Device"},{name:"BMC_PROCESSOR",label:"Processor"},{name:"BMC_UPS",label:"UPS"},{name:"BMC_SYSTEMRESOURCE",label:"System Resource"},{name:"BMC.CORE:BMC_RESOURCEPOOL",label:"Resource Pool"},{name:"BMC_CDROMDRIVE",label:"CDROM Drive"},{name:"BMC_DISKDRIVE",label:"Disk Drive"},{name:"BMC_FLOPPYDRIVE",label:"Floppy Drive"},{name:"BMC_TAPEDRIVE",label:"Tape Drive"},{name:"BMC_HARDWARESYSTEMCOMPONENT",label:"Hardware System Component"},{name:"BMC.CORE:BMC_BUSINESSPROCESS",label:"Business Process"},{name:"BMC_TRANSACTION",label:"Transaction"},{name:"BMC_DOCUMENT",label:"Document"},{name:"BMC_ACCOUNT",label:"Account"},{name:"BMC_ACTIVITY",label:"Activity"},{name:"BMC_PHYSICALLOCATION",label:"Physical Location"},{name:"BMC_ROLE",label:"Role"},{name:"BMC.CORE:BMC_CONCRETECOLLECTION",label:"Concrete Collection"},{name:"BMC_LOGICALSYSTEMCOMPONENT",label:"Logical System Component"},{name:"BMC_SERVICEOFFERINGINSTANCE",label:"Service Offering Instance"}],fe=c.find(".pan-area"),ge=1.5,he=.1,ye=.2,Ee=null,ve=null,Te=[],Se=100,Ce=null;t.state={},t.model=n,n.reset(!0),t.$watch("rootCi",function(a){if(a&&ae(a)&&!t.initialized){var n=t.cy=cytoscape({container:fe[0],style:ue(),elements:{nodes:[U(a)]},layout:{name:"dagre",fit:!1},boxSelectionEnabled:!1,wheelSensitivity:.2,selectionType:"single",zoom:ge,ready:function(){e(function(){n.center()})}});t.initialized=!0,n.on("tap",function(t){var a=t.target;e(function(){Ee=null},300),Ee===a?(a.trigger("doubleTap"),Ee=null):Ee=a}),n.on("doubleTap",function(e){p(e.target)}),n.on("select","node",function(e){var t=e.target;if(!P(t)&&!L(t)){var a=t.data("icon");t.removeClass(a),t.addClass(oe(a)),ve=t}}),n.on("unselect","node",function(e){var t=e.target;if(!P(t)&&!L(t)){var a=t.data("icon");t.removeClass(oe(a)),t.addClass(a),ve=null}}),n.on("mouseover","node",function(e){var t=e.target;t.data("hover",!0)}),n.on("mouseout","node",function(e){var t=e.target;t.data("hover",!1)})}}),t.openAsset=function(e){l.go("asset",{assetId:e.reconciliationId,assetClassId:e.classId})},t.changeZoomLevel=function(e){var a=t.cy.zoom();"in"===e?a+=ye:"out"===e&&(a-=ye),a=Math.max(he,a),t.cy.zoom(a),t.cy.center(A())},t.resetCanvas=function(){G()},t.enableBoxSelection=function(){t.cy.boxSelectionEnabled(!0)},t.viewParents=function(){t.rootCi.parentsLoaded?t.rootCi.parentsShown?v():T():E(t.rootCi)},t.expandAll=function(){var e=D(t.cy.nodes());F(e,!0),e.show(),T(),R(t.cy.nodes()).hide(),G()},t.collapseAll=function(){D(t.cy.nodes()).hide(),R(t.cy.nodes()).show(),$(t.rootCi).show(),v(),G()},t.previewSelected=function(){ve&&(pe=s.open({templateUrl:"views/change/ci-relation-preview.html",windowClass:"action-blade",size:"lg",controller:["$scope",function(e){e.assetIdsObject=te(ve.data("ci"))}]}))},t.$on("$stateChangeStart",function(){pe&&pe.dismiss()}),t.$on("$destroy",function(){console.log("graphicalCi: unbind events"),t.cy.removeListener("tap"),t.cy.removeListener("doubletap"),t.cy.removeListener("select"),t.cy.removeListener("unselect"),t.cy.removeListener("mouseover"),t.cy.removeListener("mouseout")}),t.hardReset=function(){t.rootCi.relationsLoaded=!1,t.rootCi.parentsLoaded=!1,t.rootCi.parentsShown=!1,n.reset(),x(),h()},t.reloadAllRelationships=function(){if(t.cy){var e=t.rootCi.relationsLoaded,a=t.rootCi.parentsLoaded,n=d();t.hardReset(),t.rootCi.relationsLoaded=e,a?E(t.rootCi).then(function(){u(n)}):u(n)}}}}}])}(),function(){angular.module("assetModule").controller("AssetGraphicalCiExplorerController",["$scope","$state",function(e,t){e.init(t.params.assetId,t.params.assetClassId),e.state.isGraphicalCi=!0}])}(),angular.module("assetModule").directive("linkAsset",function(){return{restrict:"E",templateUrl:"views/asset/link-asset-action-blade.html",replace:!0,scope:{isConsoleMode:"=",modalInstance:"=",linkParams:"=",selected:"=?linkAssetData"},controller:"AssetLinkController"}}),function(){angular.module("assetModule").directive("listCi",["$state","$modal","$filter","ciExplorerModel",function(e,t,a,n){return{restrict:"E",replace:!0,templateUrl:"views/asset/list-ci.html",scope:{model:"="},link:function(e){function i(e){return{assetId:e.reconciliationId||e.realObject.reconciliationId,assetClassId:e.classId||e.realObject.classId}}var o;e.openAssetDetails=function(e){o=t.open({templateUrl:"views/change/ci-relation-preview.html",windowClass:"action-blade",size:"lg",controller:["$scope",function(t){t.assetIdsObject=i(e)}]})},e.$on("$stateChangeStart",function(){o&&o.dismiss()}),e.getRelationshipTypesLabel=function(e){var t=[];return e.relationshipClassId&&t.push(n.getRelationshipTypeLabel(e.relationshipClassId)),e.realObject.isChild&&t.push(a("i18n")("asset.relationship.child.short")),e.realObject.isParent&&t.push(a("i18n")("asset.relationship.parent.short")),e.realObject.isChild||e.realObject.isParent||t.push(a("i18n")("asset.explorer.relatives.non-directional")),t.join(", ")},e.getStatusLabel=function(e){var t=e&&e.realObject&&e.realObject.status&&e.realObject.status.value;return t?a("localizeLabel")(t,"status",EntityVO.TYPE_ASSET)||t:a("i18n")("asset.explorer.field.na")}}}}])}(),function(){angular.module("assetModule").controller("AssetListCiExplorerController",["$scope","$state","ciExplorerModel",function(e,t,a){e.init(t.params.assetId,t.params.assetClassId),e.state.isListCi=!0,e.ciExplorerModel=a,a.reset(!0),e.$watch("asset",function(){e.reloadRelations()}),e.$watch("ciExplorerModel.relationshipTypesLoading",function(){e.reloadRelations()}),e.reloadRelations=function(){e.asset&&!e.ciExplorerModel.relationshipTypesLoading&&a.displayRelations(e.asset).then(function(){e.asset.relationsLoaded=!0})},e.applySearchFilters=function(){a.displayRelations(a.currentCi)}}])}(),function(){angular.module("assetModule").directive("listCiNav",[function(){return{restrict:"E",replace:!0,templateUrl:"views/asset/list-ci-nav.html",scope:{model:"="}}}])}(),angular.module("assetModule").directive("outageResources",["relationModel","$filter","$timeout","$state","$modal","configurationModel","systemAlertService","relationService","metadataModel","$q",function(e,t,a,n,i,o,r,s,l,c){return{restrict:"E",replace:!0,scope:{context:"=",isDraft:"="},link:function(d){function u(){c.all([l.getMetadataByType(EntityVO.TYPE_OUTAGE),e.getRelations(h,d.context.ticketType)]).then(function(e){f=_.filter(e[1],{type:EntityVO.TYPE_OUTAGE}),m()})["finally"](function(){d.state.loadingOutageResources=!1})}function p(e){var t=e.criteria.name,a=e.criteria.value;e.selected?g[t]?g[t]=_.union(g[t],a):g[t]=a:(g[t]=_.difference(g[t],a),g[t].length||delete g[t])}function m(){_.isEmpty(g)?d.savedOutages=[]:d.savedOutages=_.filter(f,function(e){var t=!1;return _.forEach(g,function(a,n){"status"===n&&e.realObject&&e.realObject.status&&(t=_.includes(a,e.realObject.status.value))}),t}),d.$parent.$parent&&(d.$parent.$parent.numberOfRelatedOutages=d.savedOutages.length)}var f,g=o.get("outage.defaultFilter"),h=d.context.ticketType===EntityVO.TYPE_ASSET?d.context.reconciliationId:d.context.id;d.state={loadingOutageResources:!0},d.filterConfig=o.get("outage.filter"),u(),d.recordOutage=function(t){var n=i.open({templateUrl:"views/create/create-outage-action-blade.html",windowClass:"action-blade",controller:"CreateOutageController",backdrop:"static",keyboard:!1,resolve:{params:function(){return{context:d.context}}}});n.result.then(function(n){a(function(){n.outageResourceAvailable=1},50),delete e.cache[h],u(),t.currentTarget.focus()},function(){t.currentTarget.focus()})},d.showOutageDetails=function(e){n.go(EntityVO.TYPE_OUTAGE,{id:e})},d.applyFilter=function(e){e.selected=!e.selected,p(e),m()},d.deleteOutage=function(e){var a=r.modal({title:t("i18n")("common.notification.delete.title"),text:t("i18n")("common.notification.delete.message"),buttons:[{text:t("i18n")("controls.action.ok"),data:!0},{text:t("i18n")("controls.action.cancel"),data:!1}]});a.result.then(function(a){if(a){var n={parentType:EntityVO.TYPE_ASSET,parentId:e.realObject.affectedAsset.reconciliationId},i={type:EntityVO.TYPE_OUTAGE,id:e.id,relationshipType:"relatedto",parentId:n.parentId};d.state.dataIsLoading=!0,s.removeRelation(n,[i]).then(function(){f=_.reject(f,function(t){return t.id===e.id}),m(),r.success({text:t("i18n")("ticket.notification.delete.outage"),hide:1e4})})["finally"](function(){d.state.dataIsLoading=!1})}})}},templateUrl:"views/resource/outage-resources.html"}}]),function(){angular.module("assetModule").directive("previewAsset",["googleMapService","pwaModel","$sce",function(e,t,a){return{restrict:"A",templateUrl:"views/asset/asset-details.html",scope:{displayMenu:"=",hidePersonInfoCard:"=",hideRelationships:"=",isFullVersion:"="},controller:"AssetController",link:function(n,i,o){function r(){var e=localStorage.getItem("midtierUrl"),t=localStorage.getItem("homeServer"),i=angular.fromJson(o.previewAsset),r="Configuration Item",s="SV_View",l=window.location.origin,c=i.assetId+"|"+i.assetClassId,d="";if(e){var u="goto";t&&(u="forms/"+t),d=e+"/pwa/#/"+u+"/SHR:SV_TicketDisplay/SV_TicketDisplay?origin="+l+"&targetForm="+r+"&targetView="+s+"&targetId="+c+"&mode=GET&context=PREVIEW"}n.url=a.trustAsResourceUrl(d)}n.googleMapAvailable=e.isAvailable,n.pvFlag=t.isPwaEnabled(),n.isPwaEnabled=n.pvFlag&&i&&i.length&&!i[0].classList.contains("smart-recorder-confirmedItem_content"),n.isPwaEnabled&&r(),o.$observe("previewAsset",function(e){var t=angular.fromJson(e);n.init(t.assetId,t.assetClassId)})}}}])}(),function(){angular.module("assetModule").controller("RelateAssetController",["$scope","$modalInstance","linkParams","events",function(e,t,a,n){e.modalInstance=t,e.linkParams=a,e.$on(n.MODAL_BACKDROP_CLICK,function(){e.$broadcast(n.MODAL_BACKDROP_CLICK_PROPOGATE)})}])}(),function(){angular.module("assetModule").controller("RelatePeopleController",["$scope","$modalInstance","events",function(e,t,a){e.modalInstance=t,e.$on(a.MODAL_BACKDROP_CLICK,function(){e.$broadcast(a.MODAL_BACKDROP_CLICK_PROPOGATE)})}])}(),AssetConsoleItemVO.prototype=new BaseVO,AssetConsoleItemVO.prototype.constructor=AssetConsoleItemVO,AssetConsoleItemVO.prototype.getProps=function(){var e=Object.keys(new AssetConsoleItemVO);return BaseVO.prototype.getProps().concat(e)},function(){angular.module("consoleModule").factory("assetConsoleModel",["consoleService","configurationModel","metadataModel","userModel","$rootScope","$q","$filter","categoriesService","personModel","localStorageService",function(e,t,a,n,i,o,r,s,l,c){var d,u={},p='<div class="ngHeaderSortColumn {{col.headerClass}}" ng-style="{\'cursor\': col.cursor}" ng-class="{ \'ngSorted\': !noSortVisible }"><div ux-id="column-header" ng-click="col.sort($event)" ng-class="\'colt\' + col.index" class="ngHeaderText">{{\'console.column.\' + col.displayName | i18n}}</div>\t<div class="ngSortButtonUp" ng-show="col.showSortButtonDown()"></div>\t<div class="ngSortButtonDown" ng-show="col.showSortButtonUp()"></div>\t<div class="ngSortPriority">{{col.sortPriority}}</div>\t<div ng-class="{ ngPinnedIcon: col.pinned, ngUnPinnedIcon: !col.pinned }" ng-click="togglePin(col)" ng-show="col.pinnable"></div></div><div ng-show="col.resizable" class="ngHeaderGrip" ng-click="col.gripClick($event)" ng-mousedown="col.gripOnMouseDown($event)"></div>',m=140,f="CIFilter",g="assetConsoleColumns",h="",y=!0,E=function(){_.forEach(u.columnsConfig,function(e){angular.extend(e,{headerCellTemplate:p,minWidth:m,width:e.width||m})})},v=["cpu","operatingSystem","processor","rack"],T=null,S=c.get("user.userId");return u.filterPreferenceGroup=f,u.columnPreferenceGroup=g,u.ribbonConfig=t.get("assetConsole.ribbon"),u.filterConfig=t.get("assetConsole.filter"),u.statsConfig=t.get("assetConsole.stats"),window.isRtl&&u.statsConfig.reverse(),u.currentColumnsConfig={},u.assetTypeFilter=_.find(u.filterConfig,{name:"assetTypes"}),u.presetColumns=null,u.defaultChunkSize=75,u.exceedChunkSize=!1,u.criteria={filterCriteria:{},chunkInfo:{startIndex:0,chunkSize:u.defaultChunkSize},sortInfo:{},attributeNames:[]},u.itemList=[],u.selectedFilters=[],u.filterDict=_.keyBy(u.filterConfig,"name"),u.cpuRangeValues={},u.populateFilters=function(){return u.areFiltersPopulated?o.when(1):o.all([n.getFullCurrentUserData(),a.getMetadataByType(EntityVO.TYPE_ASSET),l.getPersonDetailsByID(S)]).then(function(e){var t=e[0],a=e[1],n=e[2],i=_.find(u.filterDict.approvedBy.options,{label:"me"}),o=_.find(u.filterDict.createdBy.options,{label:"me"}),r=_.find(u.filterDict.managedBy.options,{label:"me"}),s=_.find(u.filterDict.owners.options,{label:"me"}),l=_.find(u.filterDict.supportedBy.options,{label:"me"}),c=_.find(u.filterDict.usedBy.options,{label:"me"}),p=_.find(u.filterDict.sites.options,{label:"mySite"}),m=_.find(u.filterDict.region.options,{label:"myRegion"}),f=_.find(u.filterDict.siteGroup.options,{label:"mySiteGroup"});i.subLabel=o.subLabel=r.subLabel=s.subLabel=l.subLabel=c.subLabel=t.fullName,""===t.personId&&(t.personId=n.personId),i.criteria.value=o.criteria.value=r.criteria.value=s.criteria.value=l.criteria.value=c.criteria.value=[{id:t.personId}],p.subLabel=t.site.name,T={name:t.site.name,companyName:t.company.name,region:t.site.region,siteGroup:t.site.siteGroup},p.criteria.value=[T],f.subLabel=t.site.siteGroup,f.criteria.value=[{companyName:t.company.name,region:t.site.region,siteGroup:t.site.siteGroup}],m.subLabel=t.site.region,m.criteria.value=[{companyName:t.company.name,region:t.site.region}],d=a,_.forEach(a.statuses,function(e){u.filterDict.ticketSpecificStatuses.options.push({name:e.label,type:"dynamic",filterName:"ticketSpecificStatuses",criteria:{name:"ticketSpecificStatuses",value:[e.name]}})}),_.forEach(a.assetTypes,function(e){u.filterDict.assetTypes.options.push({name:e.label,type:"dynamic",filterName:"assetTypes",criteria:{name:"assetTypes",value:[e.name]},criteriaValue:e.name}),e.subType.forEach(function(t){u.filterDict.assetSubTypes.options.push({name:t.label,type:"dynamic",filterName:"assetSubTypes",onDisplay:!0,criteria:{name:"assetSubTypes",value:[t.name],typeName:e.name}})})})})},u.populateConfiguration=function(){return _.isEmpty(u.columnsConfig)?o.all([n.getUserPreferences(g),n.getUserPreferences(f),a.getMetadataByType(EntityVO.TYPE_ASSET)]).then(function(e){u.userSavedColumnPresets=e[0]||[];var a=_.find(u.userSavedColumnPresets,{name:"columns"})||{},n=a.value||{};u.currentColumnsConfig=n,h=a.id,u.columnsConfig=_.merge(_.cloneDeep(t.get("assetConsole.columns")),n),u.userSavedFilterPresets=e[1],u.userSavedFilterPresets.unshift({id:"allAssets",fixed:!0,name:"Hardware Managed by Me",label:r("i18n")("console.asset.preDefinedUserFilter.myManagedAssetsFilter"),systemgenerated:!0,defaultpreset:!1,value:[{filter:"managedBy",option:"me"},{filter:"ticketSpecificStatuses",option:"Deployed",type:"dynamic",realOption:{name:r("localizeLabel")("Deployed",EntityVO.TYPE_STATUS,EntityVO.TYPE_ASSET),criteria:{name:"ticketSpecificStatuses",value:["Deployed"]}}},{filter:"assetTypes",option:"Computer System",type:"dynamic",realOption:{name:r("localizeLabel")("Computer System","assetType",EntityVO.TYPE_ASSET),criteria:{name:"assetTypes",value:["Computer System"]}}},{filter:"assetTypes",option:"Hardware",type:"dynamic",realOption:{name:r("localizeLabel")("Hardware","assetType",EntityVO.TYPE_ASSET),criteria:{name:"assetTypes",value:["Hardware"]}}}]}),u.userSavedPresets=_.cloneDeep(u.userSavedFilterPresets),_.each(u.userSavedColumnPresets,function(e){if("columns"!==e.name){var t=_.find(u.userSavedPresets,{name:e.name});t?(t.columnId=e.id,t.columnValue=e.value):(e.columnId=e.id,e.columnValue=e.value,delete e.id,delete e.value,u.userSavedPresets.push(e))}}),E(),u.populateAttributeNames()}):o.when(1)},u.addUserSavedPresets=function(e){var t=_.find(u.userSavedFilterPresets,{name:e}),a=_.find(u.userSavedColumnPresets,{name:e}),n={};t?(n=t,a&&(n.columnId=a.id,n.columnValue=a.value)):a&&(n.columnId=a.id,n.columnValue=a.value,n.name=a.name),u.userSavedPresets.push(n)},u.updateUserSavedPresets=function(e){console.log("Preset name: "+e)},u.populateAttributeNames=function(){u.criteria.attributeNames=_.map(_.filter(u.columnsConfig,function(e){return e.visible}),"attributeName")},u.getItemList=function(){if(!u.criteria.attributeNames.length){var t=_.sortBy(_.filter(u.columnsConfig,{visible:!0}),"order");t.forEach(function(e){u.criteria.attributeNames.push(e.attributeName)})}return e.getAssetList(u.criteria).then(function(e){return u.itemList=u.criteria.chunkInfo.startIndex?u.itemList.concat(e.itemList):e.itemList,u.criteria.chunkInfo.chunkSize===e.itemList.length?e.totalCount=u.itemList.length+u.criteria.chunkInfo.chunkSize:e.totalCount=u.itemList.length,u.exceedChunkSize=e.exceedChunkSize,e.totalCount})},u.getRelatives=function(t){return e.getRelatives(t)},u.getRelationshipTypes=function(t){return e.getRelationshipTypes(t)},u.dropCriteriaStartIndex=function(){u.criteria.chunkInfo.startIndex=0},u.getTicketConsoleMetric=function(){},u.applyFilterSet=function(e){_.forEach(e,function(e){if(u.filterDict[e.filter]){var t=_.find(u.filterDict[e.filter].options,{name:e.option});if(!t&&"dynamic"===e.type)if(t=e.realOption,u.advancedFilterType(t))t.subtype="range",u.filterDict[e.filter].options[0]=t;else{var a=_.find(u.filterDict[e.filter].options,function(e){if(e.criteria&&t.criteria)return _.isEqual(e.criteria,t.criteria)});a?t=a:u.filterDict[e.filter].options.push(t)}angular.isObject(t)&&!t.active&&("dynamic"===e.type&&u.advancedFilterType(t)&&_.forEach(u.filterDict[e.filter].criteriaKeys,function(a){_.forEach(t.criteria.value,function(t){_.isUndefined(t[a.name])||(u.filterDict[e.filter].selectiveClearFilters=!0,a.active=!0,a.fromPreset=!0,a.searchText=t[a.name].value,a.selectedValue=t[a.name].value)})}),t.active=!0,u.applyFilter(t))}})},u.applyColumnSet=function(e){var t=_.filter(u.columnsConfig,{visible:!0});u.presetColumns=[],u.presetColumns=[],_.each(u.columnsConfig,function(t){var a,n=e[t.name];n&&(a=angular.copy(t),a.order=n.order,a.visible="undefined"==typeof n.visible||n.visible,u.presetColumns.push(a))}),!e.newColumnType&&t.length&&_.forEach(t,function(e){if(!_.find(u.presetColumns,{name:e.name})){var t=angular.copy(e);u.presetColumns.push(t)}}),u.presetColumns=_.sortBy(u.presetColumns,"order"),u.criteria.attributeNames=_.map(u.presetColumns,"attributeName")},u.applyFilter=function(e){var t=u.criteria.filterCriteria,a=e.criteria.name,n=_.isArray(e.criteria.value);if(u.advancedFilterType(e)&&(n=!1),e.active){var o=e.filterName||e.criteria.name,r=u.filterDict[o];if(r&&r.showLabelInPill&&(e.filterName=r.name,e.filterLabel=r.label),"date"===e.type&&(e.criteria.value=[{}],_.forEach(e.defaultValues,function(t,a){e.criteria.value[0][a]=i.$eval(t,{moment:moment})}),e.criteria.value[0].id=e.label,n=!1),"dynamic"===e.type&&"date"===e.criteria.type&&(n=!1),t[a]&&"sites"!==t[a])if(n)t[a]=_.union(t[a],e.criteria.value);else{var s=_.find(u.selectedFilters,{criteria:{name:e.criteria.name}});s.active=!1,u.applyFilter(s),t[a]=e.criteria.value}else"sites"===a||"region"===a||"siteGroup"===a?t.sites=_.union(t.sites,e.criteria.value):t[a]=e.criteria.value;t.assetTypes&&t.assetTypes.length>1&&u.removeAdvancedFilters(),"assetTypes"===a&&u.updateSubtypeFilters(),u.selectedFilters.unshift(e)}else{t[a]&&"sites"!==t[a]?t[a]=n?_.difference(t[a],e.criteria.value):"":t.sites=_.difference(t.sites,e.criteria.value),t[a]&&t[a].length||delete t[a],t.sites&&!t.sites.length&&delete t.sites;var l=_.findIndex(u.selectedFilters,function(t){return t.name===e.name&&t.criteria.name===e.criteria.name});u.selectedFilters.splice(l,1),"assetTypes"===a&&u.updateSubtypeFilters(),"Computer System"===e.name&&u.removeAdvancedFilters()}},u.saveFilterPreset=function(e){var t=_.cloneDeep(u.selectedFilters),a={name:e,value:_.map(t.reverse(),function(e){var t={filter:e.filterName||e.criteria.name,option:e.name};return"dynamic"===e.type&&(t.type="dynamic",t.realOption=angular.copy(e),delete t.realOption.active),t})};return o.all([n.updateUserPreferences(f,a)])},u.saveColumnPreset=function(e,t){return n.updateUserPreferences(g,{name:e,value:t})},u.removeUserFilterPreset=function(t){t.id&&(n.removeUserPreferences(f,t),e.removeFilterConfiguration(t.name,t.id)),t.columnId&&n.removeUserPreferences(g,{id:t.columnId}),_.remove(u.userSavedPresets,{name:t.name})},u.updateColumnConfig=function(e,t,a){return n.updateUserPreferences(g,{id:a?a:h,name:t?t:"columns",value:e},{updateColumns:!0}).then(function(e){var t=a?_.find(e,{id:a}):_.find(e,{name:"columns"});t&&(u.currentColumnsConfig=t.value,h=t.id)})},u.getProductNamesByCompany=function(e){return u.getProductCategoriesByCompany(e,!0)},u.getProductCategoriesByCompany=function(e,t){var a="product",i={entityType:EntityVO.TYPE_ASSET,categoryType:a,searchText:e,criteria:{company:n.userFullData.company}};return t&&(i.criteria.isEmpty=!1),s.searchCategories(i).then(function(e){var t=_.find(d.categories,function(e){return e.name===a});return _.map(e.items,function(e){if(e.length){for(var n=_.compact(e).join(" > "),i={},o=0;o<t.listOfTiers.length;o++)i[t.listOfTiers[o].name]=e[o];return{value:n,attributeMap:{categorizations:[{name:a,tiers:i}]}}}})})},u.advancedFilterType=function(e){return!(!e.criteria||"rack"===e.criteria.name)&&_.includes(v,e.criteria.name)},u.removeAdvancedFilters=function(){var e=u.criteria.filterCriteria;_.forEach(v,function(t){delete e[t]}),_.remove(u.selectedFilters,function(e){if(_.includes(v,e.criteria.name))return e.active=!1,!0})},u.updateSubtypeFilters=function(){var e=u.criteria.filterCriteria,t=[];e.assetTypes&&e.assetSubTypes&&(_.remove(u.selectedFilters,function(a){if("assetSubTypes"===a.criteria.name&&!_.includes(e.assetTypes,a.criteria.typeName))return t.push(a.criteria.value[0]),a.active=!1,!0}),_.remove(e.assetSubTypes,function(e){return _.includes(t,e)}))},u.clearCriteriaKeyValues=function(e,t){var a=_.find(u.filterConfig,{name:e}),n=t;a&&(n=a.criteriaKeys),_.forEach(n,function(e){e.active=!1,e.searchText=""})},u.clearSelectiveCriteriaKeyValues=function(e){var t=e.criteriaKeys;e.selectiveClearFilters&&delete e.selectiveClearFilters,_.forEach(t,function(e){e.active&&e.fromPreset?delete e.fromPreset:(e.active=!1,e.searchText="")})},u.isSearchEnabled=function(){return y},u.setSearchEnabled=function(e){y=!!e},u}])}(),function(){angular.module("calendarModule").controller("CalendarController",["$scope","permissionModel","metadataModel","$rootScope","AUTH_EVENTS","$window","authModel",function(e,t,a,n,i,o,r){function s(t){if("string"==typeof t.data&&e.checkIfJson(t.data)){var a=JSON.parse(t.data);if(a.hasOwnProperty("information")){var o="local"===a.information?"http://localhost:4200":window.location.origin,s=document.getElementsByClassName("app__calendar-iframe")[0].contentWindow,c={permissions:l,eventName:"calendarEvent"},d=sessionStorage.getItem("calendarFilterState"),u=sessionStorage.getItem("calendarFilterView"),p=sessionStorage.getItem("calendarFilterDate");d&&(c.calendarFilterState=d),u&&(c.calendarFilterView=u),p&&(c.calendarFilterDate=p),s.postMessage(JSON.stringify(c),o)}else if(a.hasOwnProperty("filterState")){var m=a.filterState;sessionStorage.setItem("calendarFilterState",angular.toJson(m))}else a.hasOwnProperty("filterView")?sessionStorage.setItem("calendarFilterView",a.filterView):a.hasOwnProperty("filterDate")?sessionStorage.setItem("calendarFilterDate",a.filterDate):a.hasOwnProperty("sessionExpired")?r.isSSOEnabled()?n.$broadcast(i.SESSION_EXPIRED):window.location.reload():a.hasOwnProperty("initialize-metadata-error")&&n.$broadcast(i.INITIALIZE_METADATA_ERROR,a);e.dataLoading=!1,e.$digest()}}var l=[];["change","release"].forEach(function(e){t.hasPermissionForCalendar(e)&&l.push(e)}),e.dataLoading=!0,e.ccsEnabledForCalendar=!0,a.getMetadataByType("global").then(function(t){e.ccsEnabledForCalendar=t&&t.configurationParameters&&"true"===t.configurationParameters.calendarFeatureEnabled})["catch"](function(t){t&&(e.ccsEnabledForCalendar=!1)}),e.checkIfJson=function(e){if(0==e.length)return!1;try{if(JSON.parse(e),!isNaN(e))return!1}catch(t){return!1}return!0},$(document).on("focusout",function(){setTimeout(function(){if(document.activeElement instanceof HTMLIFrameElement){var e=document.getElementsByClassName("open");if(e.length){var t=e[0].getElementsByClassName("dropdown-toggle");t.length&&(t=t[0],t.click())}else if(e=document.getElementsByClassName("search__close"),e.length){var a=e[0];a.click()}}},0)}),window.onmessage=s}])}(),function(){angular.module("myitsmApp").directive("alertCarousel",[function(){return{restrict:"E",replace:!0,templateUrl:"views/common/alert-carousel.html",scope:{basicData:"=",alertDetails:"=",collisions:"=",impactAnalysisStatus:"="},link:function(e){e.alertIndex=0,e.showAlerts=!1,e.$watch("alertDetails.alertItems",function(){for(;e.alertIndex>=e.alertDetails.alertItems.length;)e.alertIndex--}),e.nextAlert=function(){e.alertIndex<e.alertDetails.alertItems.length-1&&e.alertIndex++},e.prevAlert=function(){e.alertIndex>0&&e.alertIndex--}}}}])}(),function(){angular.module("myitsmApp").directive("assetTypeIcon",["i18nService",function(e){return{restrict:"E",replace:!0,template:"<img class='asset-type-icon' ng-src='{{iconUrl()}}' alt='{{iconLabel()}}' />",scope:{type:"="},link:function(t){var a={Group:"impactAnalysis.labels.group",Network:"impactAnalysis.labels.network",People:"impactAnalysis.labels.people",Service:"impactAnalysis.labels.service",Database:"impactAnalysis.labels.db",Application:"impactAnalysis.labels.app",Cluster:"impactAnalysis.labels.cluster","Computer System":"impactAnalysis.labels.compSystem",Media:"impactAnalysis.labels.media",Ups:"impactAnalysis.labels.ups","File system":"impactAnalysis.labels.fileSys",Resource:"impactAnalysis.labels.resource",Software:"impactAnalysis.labels.software",Hardware:"impactAnalysis.labels.hardware",Other:"impactAnalysis.labels.other","Business Service":"impactAnalysis.labels.businessService",Equipment:"impactAnalysis.labels.Equipment"},n={Group:"styles/img/ci-type-icons/group.svg",Network:"styles/img/ci-type-icons/network.svg",People:"styles/img/ci-type-icons/people.svg",Service:"styles/img/ci-type-icons/service.svg",Database:"styles/img/ci-type-icons/database.svg",Application:"styles/img/ci-type-icons/application.svg",Cluster:"styles/img/ci-type-icons/cluster.svg","Computer System":"styles/img/ci-type-icons/computer_system.svg",Media:"styles/img/ci-type-icons/media.svg",Ups:"styles/img/ci-type-icons/ups.svg","File system":"styles/img/ci-type-icons/file_system.svg",Resource:"styles/img/ci-type-icons/resource.svg",Software:"styles/img/ci-type-icons/software.svg",Hardware:"styles/img/ci-type-icons/generic_ci.svg",Other:"styles/img/ci-type-icons/generic_ci.svg","Business Service":"styles/img/ci-type-icons/generic_ci.svg",Equipment:"styles/img/ci-type-icons/generic_ci.svg"};t.iconLabel=function(){return e.getLocalizedString(a[t.type])},t.iconUrl=function(){return n[t.type]}}}}])}(),function(){angular.module("myitsmApp").directive("assigneeChooser",["ticketService","searchModel","userModel","$q","i18nService","events","$timeout","objectValueMapperService",function(e,t,a,n,i,o,r,s){return{restrict:"EA",scope:{ticket:"=",assignee:"=",role:"@",label:"=",assignToMe:"=?",isDraft:"="},templateUrl:"views/common/assignee-chooser-directive.html",link:function(l){function c(){if(l.role)v=l.role;else if(l.ticket.type===EntityVO.TYPE_WORKORDER)v="workorderassignee";else if(l.ticket.type===EntityVO.TYPE_RELEASE)v="releasecoordinator";else if(l.ticket.type===EntityVO.TYPE_KNOWLEDGE){var t=l.ticket.status?l.ticket.status.value:l.ticket.statusValue?l.ticket.statusValue.value:"";v="knowledgeassignee",t!==EntityVO.STATUS_CONTENT_REVIEW&&t!==EntityVO.STATUS_SME_REVIEW&&(l.conditions.showAssignToGroup=!1)}else l.ticket.type===EntityVO.TYPE_CHANGE&&(v="changecoordinator");l.ticket.accessMappings&&("changecoordinator"===l.role||"problemcoordinator"===l.role?l.conditions.showAssignToMe=l.ticket.accessMappings.coordinatorSelfAssignmentAllowed:"workordermanager"===l.role||"changemanager"===l.role?l.conditions.showAssignToMe=l.ticket.accessMappings.managerSelfAssignmentAllowed:"knowledgeassignee"===v?l.conditions.showAssignToMe=l.ticket.accessMappings["assignee-self-assignmentEditAllowed"]:l.role||(l.conditions.showAssignToMe=l.ticket.accessMappings.assigneeSelfAssignmentAllowed)),l.ticket.type!==EntityVO.TYPE_PROBLEM&&l.ticket.type!==EntityVO.TYPE_KNOWNERROR&&l.ticket.type!==EntityVO.TYPE_RELEASE||(l.conditions.showAssignToMe=a.userFullData.availableForAssignment),l.assignee.person&&l.assignee.person.loginId===a.userFullData.loginId&&l.ticket.type!==EntityVO.TYPE_ACTIVITY&&(l.assignToMe=!0),l.ticket.type===EntityVO.TYPE_CHANGE&&"changecoordinator"==l.role&&l.ticket.supportGroup&&l.ticket.supportGroup.id!==l.assignee.person.supportGroupId?(l.assignee.person.supportGroupId=l.ticket.supportGroup.id,l.assignee.person.supportGroup=l.ticket.supportGroup.name):l.ticket.type!==EntityVO.TYPE_PROBLEM&&l.ticket.type!==EntityVO.TYPE_KNOWNERROR||("problemcoordinator"===l.role&&l.ticket.coordinatorGroup&&l.ticket.coordinatorGroup.id!==(l.assignee.person.supportGroupId||l.assignee.group.id)?(l.assignee.person.supportGroupId=l.ticket.coordinatorGroup.id,l.assignee.person.supportGroup=l.ticket.coordinatorGroup.name):"problemcoordinator"!==l.role&&l.ticket.supportGroup&&l.ticket.supportGroup.id&&(l.ticket.supportGroup.id!==l.assignee.group.id||l.ticket.supportGroup.id!==l.assignee.person.supportGroupId)&&(l.assignee.person.supportGroupId=l.ticket.supportGroup.id,l.assignee.person.supportGroup=l.ticket.supportGroup.name)),m().then(function(){var t=null;if(l.assignee.group.id||l.assignToMe){var i=[],o=null,r=null,c=null,m=null;l.ticket.type!==EntityVO.TYPE_KNOWLEDGE?(t=d(),o=(l.ticket.type===EntityVO.TYPE_TASK||l.ticket.type===EntityVO.TYPE_CHANGE)&&l.ticket.id&&l.ticket.company?l.ticket.company.name:l.ticket instanceof TicketConsoleItemVO||l.ticket.type!==EntityVO.TYPE_INCIDENT&&l.ticket.type!==EntityVO.TYPE_WORKORDER?l.ticket.locationCompany?l.ticket.locationCompany.name:null:s.getExactValueByFieldName("locationCompany")):(m=f().name,r=l.ticket.owner&&l.ticket.owner.company?l.ticket.owner.company.name:"",c=l.ticket.author&&l.ticket.author.company?l.ticket.author.company.name:""),l.assigneeCompany=l.assignee.group.company||{},l.assigneeOrganization=l.assignee.group.organization?{name:l.assignee.group.organization}:C,l.assignToMe&&(l.assigneeCompany=S,l.assigneeOrganization=C,l.assignee.group=O,l.assignee.isGroup=!1,l.search.text=a.userFullData.fullName,l.assigneeLoginId=a.userFullData.loginId,l.conditions.showAssignToGroup=!1,l.ticket.type!==EntityVO.TYPE_TASK&&l.ticket.type!==EntityVO.TYPE_ACTIVITY||!_.isUndefined(t)||(t=l.ticket.company&&l.ticket.company.name)),i.push(p(l.assigneeCompany,v,t,o,r,m,c)),i.push(u(l.assigneeCompany,l.assigneeOrganization,v,t,o,r,m,c)),l.ticket.type!==EntityVO.TYPE_KNOWLEDGE?i.push(e.getAssigneeBySupportGroupId("All"===l.assignee.group.id?"":l.assignee.group.id,l.search.text,l.assigneeLoginId,t,v,null,!0,null,o,null,null,!0)):i.push(e.getAssigneeBySupportGroupId("All"===l.assignee.group.id?"":l.assignee.group.id,l.search.text,l.assigneeLoginId,t,v,null,!0,m,"",r,c,!0)),n.all(i).then(function(e){l.assignment.organizations=e[0],l.assignment.groups=e[1],T.tooManySupportPeople=e[2].exceedsChunkSize,e[2].results.length&&g(e[2].results)})["finally"](y)}else l.assigneeCompany={},t={},l.ticket.customer&&l.ticket.customer.company&&!_.isEmpty(l.ticket.customer.company)?t=l.ticket.customer.company:l.ticket.selectedCompany?t={name:l.ticket.selectedCompany}:l.ticket.author&&l.ticket.author.company?t=l.ticket.author.company:l.ticket.company&&(t=l.ticket.company),t.name&&l.companies.length&&_.some(l.companies,function(e){if(e.name===t.name)return l.assigneeCompany=e,!0}),l.selectCompany(l.assigneeCompany)})}function d(){var e=null;return l.ticket.type!==EntityVO.TYPE_KNOWLEDGE&&(e=l.ticket.type===EntityVO.TYPE_INCIDENT||l.ticket.type===EntityVO.TYPE_WORKORDER?s.getExactValueByFieldName("customerCompany"):l.ticket.customer?l.ticket.customer.company&&l.ticket.customer.company.name:l.ticket.company?l.ticket.company.name:l.ticket.selectedCompany),
e}function u(e,a,n,i,o,r,s,l){return t.getAssigneeSupportGroupsForCompanyAndOrg("All"===e.id?"":e.name,"All"===a.id?"":a.name,n,null,i,o,r,s,l,!0).then(function(e){e.supportGroups=_.uniqBy(e.supportGroups,function(e){return e.id}),e.supportGroups=_.sortBy(e.supportGroups,function(e){return e.name}),T.tooManySupportGroups=e.exceedsChunkSize,e.supportGroups.length&&"All"!==e.supportGroups[0].id&&(O.persons=[],e.supportGroups.unshift(O));var t=[];return _.forEach(e.supportGroups,function(a){if("All"!==a.id)if(t.indexOf(a.name)===-1)t.push(a.name);else{var n=_.filter(e.supportGroups,{name:a.name});_.forEach(n,function(e){e.duplicate=!0})}}),e.supportGroups})}function p(e,a,n,i,o,r,s){return t.getAssigneeSupportOrgByCompany("All"===e.id?"":e.name,null,a,n,i,o,r,s).then(function(e){T.tooManyOrganizations=e.exceedsChunkSize,e.organizations&&e.organizations.length&&"All"!==e.organizations[0].id&&e.organizations.unshift(C);var t=[];return _.forEach(e.organizations,function(a){if("All"!==a.id)if(t.indexOf(a.name)===-1)t.push(a.name);else{var n=_.filter(e.organizations,{name:a.name});_.forEach(n,function(e){e.duplicate=!0})}}),e.organizations})}function m(){var e,a={};if(l.ticket.type===EntityVO.TYPE_KNOWLEDGE){var n=f();a={ownerCompany:l.ticket.owner.company?l.ticket.owner.company.name:"",authorCompany:l.ticket.author.company?l.ticket.author.company.name:""},"All"!==n.name&&(a.primaryCompany=n.name)}else e=l.ticket instanceof TicketConsoleItemVO||l.ticket.type!==EntityVO.TYPE_INCIDENT&&l.ticket.type!==EntityVO.TYPE_WORKORDER?l.ticket.customer&&l.ticket.customer.company?l.ticket.customer.company.name:l.ticket.company?l.ticket.company.name:"":s.getExactValueByFieldName("customerCompany")||"",e||(e=l.ticket.selectedCompany),a={customerCompany:e},(l.ticket.type===EntityVO.TYPE_TASK||l.ticket.type===EntityVO.TYPE_CHANGE)&&l.ticket.id&&l.ticket.company?a.locationCompany=l.ticket.company.name:l.ticket instanceof TicketConsoleItemVO||l.ticket.type!==EntityVO.TYPE_INCIDENT&&l.ticket.type!==EntityVO.TYPE_WORKORDER?l.ticket.locationCompany&&l.ticket.locationCompany.name&&(a.locationCompany=l.ticket.locationCompany.name):a.locationCompany=s.getExactValueByFieldName("locationCompany");return v&&(a.role=v),l.ticket.type!==EntityVO.TYPE_TASK&&l.ticket.type!==EntityVO.TYPE_ACTIVITY||!_.isUndefined(a.customerCompany)||(a.customerCompany=l.ticket.company.name),t.getAssigneeSupportCompanies(a).then(function(e){T.tooManyCompanies=e.exceedsChunkSize,e.objects.length&&"All"!==e.objects[0].id&&e.objects.unshift(S),l.companies=_.cloneDeep(e.objects)})}function f(){return l.ticket.allCompanies?_.find(l.ticket.allCompanies,function(e){return e.primary}):l.ticket.company}function g(e){if(l.assignee.person&&l.assignee.person.loginId&&!l.assignToMe?l.assignee.group.persons=_.reject(e,function(e){return e.loginId===l.assignee.person.loginId}):l.assignee.group.persons=e,l.assignee.group.persons=_.sortBy(l.assignee.group.persons,function(e){return e.fullName.toLowerCase()}),"All"===l.assignee.group.id){for(var t=h(l.assignee.group.persons),a=[],n=0;n<t.length-1;n++)if(t[n].loginId===t[n+1].loginId){var i=_.cloneDeep(t[n]);i.type="parent",a.push(i),t[n].type="child",a.push(t[n]),n++;var o=1;do t[n].type="child",a.push(t[n]),o++,n++;while(n<t.length&&t[n-1].loginId===t[n].loginId);i.numOfChildren=o,n--}else a.push(t[n]);n<t.length&&a.push(t[n]),l.assignee.group.persons=_.sortBy(a,function(e){return e.fullName.toLowerCase()}),l.assignToMe&&l.assignee.group.persons.length>0&&l.assignToPerson(l.assignee.group.persons[0])}y()}function h(e){return(e||[]).reduce(function(e,t){var a=e.some(function(e){return e.supportGroupId===t.supportGroupId&&e.loginId===t.loginId});return a||e.push(t),e},[])}function y(){T.processing=!1}var E,v="",T={processing:!0,tooManyCompanies:!1,tooManyOrganizations:!1,tooManySupportGroups:!1,tooManySupportPeople:!1},S={name:i.getLocalizedString("assignBlade.company.all"),id:"All"},C={name:i.getLocalizedString("assignBlade.organization.all"),id:"All"},O={name:i.getLocalizedString("assignBlade.supportGroup.all"),id:"All"},A=2e3;l.assigneeCompany={},l.assigneeOrganization={},l.companies=[],l.assignment={organizations:[],groups:[]},l.organizations=[],l.groups=[],l.search={text:"",filterText:""},l.selectedParent={},l.conditions={showAssignToGroup:!0,showAssignToMe:!0},l.searchUser=function(e){var t=(l.search.filterText||"").toLowerCase();return e.fullName.toLowerCase().indexOf(t)!==-1||e.loginId.toLowerCase().indexOf(t)!==-1||e.email.toLowerCase().indexOf(t)!==-1||e.id.toLowerCase().indexOf(t)!==-1},l.selectAssignToMe=function(){if(l.assignToMe)l.assigneeCompany=S,l.assigneeOrganization=C,l.assignee.group=O,l.assignee.isGroup=!1,l.search.text=a.userFullData.fullName,l.assigneeLoginId=a.userFullData.loginId,l.conditions.showAssignToGroup=!1,l.onSearchTextChanged();else{if(l.search.text="",l.assigneeLoginId="",l.conditions.showAssignToGroup=!0,l.ticket.type===EntityVO.TYPE_KNOWLEDGE){var e=l.ticket.status?l.ticket.status.value:l.ticket.statusValue?l.ticket.statusValue.value:"";e!==EntityVO.STATUS_CONTENT_REVIEW&&e!==EntityVO.STATUS_SME_REVIEW&&(l.conditions.showAssignToGroup=!1)}l.selectedParent={},l.selectGroup(l.assignee.group)}},l.selectCompany=function(t){T.processing=!0,l.assigneeCompany=t||{},l.assignment.organizations=[],l.assigneeOrganization=C,l.assignment.groups=[],l.assignee.group={},l.assignee.group.persons=[],l.assignee.person={},l.assignee.isGroup=!1;var a=[],i=null,o=null,r=null,c=null,d=null;l.ticket.type===EntityVO.TYPE_KNOWLEDGE?(d=f().name,r=l.ticket.owner.company?l.ticket.owner.company.name:"",c=l.ticket.author.company?l.ticket.author.company.name:"","All"===d&&(d=null)):(i=l.ticket instanceof TicketConsoleItemVO||l.ticket.type!==EntityVO.TYPE_INCIDENT&&l.ticket.type!==EntityVO.TYPE_WORKORDER?l.ticket.customer&&l.ticket.customer.company&&!_.isEmpty(l.ticket.customer.company)?l.ticket.customer.company.name:l.ticket.company?l.ticket.company.name:"":s.getExactValueByFieldName("customerCompany")||"",o=(l.ticket.type===EntityVO.TYPE_TASK||l.ticket.type===EntityVO.TYPE_CHANGE)&&l.ticket.id&&l.ticket.company?l.ticket.company.name:l.ticket instanceof TicketConsoleItemVO||l.ticket.type!==EntityVO.TYPE_INCIDENT&&l.ticket.type!==EntityVO.TYPE_WORKORDER?l.ticket.locationCompany?l.ticket.locationCompany.name:null:s.getExactValueByFieldName("locationCompany")),l.assigneeCompany.name&&(a.push(p(l.assigneeCompany,v,i,o,r,d,c)),a.push(u(l.assigneeCompany,l.assigneeOrganization,v,i,o,r,d,c)),a.push(e.getAssigneeSupportGroupPersons("All"===l.assigneeCompany.id?"":l.assigneeCompany.name,"",l.search.text?l.search.text:"","",v,null,i,o,r,d,c,!0,!0))),n.all(a).then(function(e){l.assignment.organizations=e[0],l.assignment.groups=e[1],(l.assignment.groups&&l.assignment.groups.length||T.tooManySupportGroups)&&(O.persons=[],l.assignee.group=O),T.tooManySupportPeople=e[2]&&e[2].exceedsChunkSize,l.assignToMe?l.onSearchTextChanged():e[2].results.length&&g(e[2].results),y()})["catch"](y)},l.selectOrganization=function(t){T.processing=!0,l.assigneeOrganization=t,l.assignee.group={},l.assignee.group.persons=[],l.assignee.person={},l.assignee.isGroup=!1;var a=[],i=null,o=null,r=null,c=null,d=null;l.ticket.type===EntityVO.TYPE_KNOWLEDGE?(d=f().name,r=l.ticket.owner.company?l.ticket.owner.company.name:"",c=l.ticket.author.company?l.ticket.author.company.name:"","All"===d&&(d=null)):(i=l.ticket instanceof TicketConsoleItemVO||l.ticket.type!==EntityVO.TYPE_INCIDENT&&l.ticket.type!==EntityVO.TYPE_WORKORDER?l.ticket.customer&&l.ticket.customer.company&&!_.isEmpty(l.ticket.customer.company)?l.ticket.customer.company.name:l.ticket.company?l.ticket.company.name:"":s.getExactValueByFieldName("customerCompany")||"",o=(l.ticket.type===EntityVO.TYPE_TASK||l.ticket.type===EntityVO.TYPE_CHANGE)&&l.ticket.id&&l.ticket.company?l.ticket.company.name:l.ticket instanceof TicketConsoleItemVO||l.ticket.type!==EntityVO.TYPE_INCIDENT&&l.ticket.type!==EntityVO.TYPE_WORKORDER?l.ticket.locationCompany?l.ticket.locationCompany.name:null:s.getExactValueByFieldName("locationCompany")),a.push(u(l.assigneeCompany,l.assigneeOrganization,v,i,o,r,d,c)),a.push(e.getAssigneeSupportGroupPersons("All"===l.assigneeCompany.id?"":l.assigneeCompany.name,"All"===t.id?"":t.name,l.search.text?l.search.text:"","",v,null,i,o,r,d,c,!0,!0)),n.all(a).then(function(e){l.assignment.groups=e[0],(l.assignment.groups.length||T.tooManySupportGroups)&&(O.persons=[],l.assignee.group=O),T.tooManySupportPeople=e[1].exceedsChunkSize,l.assignToMe?l.onSearchTextChanged():e[1].results.length&&g(e[1].results),y()})["catch"](y)},l.selectGroup=function(a){T.processing=!0,l.assignee.group=a,l.assignee.group.persons=[],l.assignee.person={};var n=null,i=null,o=null,r=null,c=null;l.ticket.type===EntityVO.TYPE_KNOWLEDGE?(c=f().name,o=l.ticket.owner.company?l.ticket.owner.company.name:"",r=l.ticket.author.company?l.ticket.author.company.name:"","All"===c&&(c=null)):(n=l.ticket instanceof TicketConsoleItemVO||l.ticket.type!==EntityVO.TYPE_INCIDENT&&l.ticket.type!==EntityVO.TYPE_WORKORDER?l.ticket.customer&&l.ticket.customer.company&&!_.isEmpty(l.ticket.customer.company)?l.ticket.customer.company.name:l.ticket.company?l.ticket.company.name:"":s.getExactValueByFieldName("customerCompany")||"",i=(l.ticket.type===EntityVO.TYPE_TASK||l.ticket.type===EntityVO.TYPE_CHANGE)&&l.ticket.id&&l.ticket.company?l.ticket.company.name:l.ticket instanceof TicketConsoleItemVO||l.ticket.type!==EntityVO.TYPE_INCIDENT&&l.ticket.type!==EntityVO.TYPE_WORKORDER?l.ticket.locationCompany?l.ticket.locationCompany.name:null:s.getExactValueByFieldName("locationCompany")),"All"===a.id?(l.assignee.isGroup=!1,e.getAssigneeSupportGroupPersons("All"===l.assigneeCompany.id?"":l.assigneeCompany.name,"All"===l.assigneeOrganization.id?"":l.assigneeOrganization.name,l.search.text?l.search.text:"","",v,null,n,i,o,c,r,!0,!0).then(function(e){T.tooManySupportPeople=e.exceedsChunkSize,l.assignToMe?l.onSearchTextChanged():e.results.length&&g(e.results),y()})["catch"](y)):e.getAssigneeBySupportGroupId(l.assignee.group.id,l.search.text?l.search.text:"","",n,v,t.supportPersonChunkSize,!0,null,i,o,r,!0).then(function(e){T.tooManySupportPeople=e.exceedsChunkSize,l.assignToMe?l.onSearchTextChanged():e.results.length&&g(e.results),y()})["catch"](y)},l.assignToGroup=function(){l.assignee.isGroup=!0,l.assignee.person={},l.$emit(o.MODAL_FORM_IS_DIRTY)},l.assignToPerson=function(e){"parent"===e.type?l.selectedParent=l.selectedParent.id===e.id?{}:e:(l.assignee.isGroup=!1,l.assignee.person=e,l.$emit(o.MODAL_FORM_IS_DIRTY))},l.clearSearchText=function(){if(l.search.text="",l.assignToMe){if(l.assignToMe=!1,l.ticket.type===EntityVO.TYPE_KNOWLEDGE){var e=l.ticket.status?l.ticket.status.value:l.ticket.statusValue?l.ticket.statusValue.value:"";e!==EntityVO.STATUS_CONTENT_REVIEW&&e!==EntityVO.STATUS_SME_REVIEW?l.conditions.showAssignToGroup=!1:l.conditions.showAssignToGroup=!0}else l.conditions.showAssignToGroup=!0;l.selectGroup(l.assignee.group)}else l.onSearchTextChanged()},l.onSearchTextChanged=function(){var t=null,n=null;l.search.text!==a.userFullData.fullName&&(l.assigneeLoginId=""),T.tooManySupportPeople||l.assignToMe?(l.search.filterText="",l.assignee.person={},l.search.text.length>2||0===l.search.text.length?(r.cancel(E),E=r(function(){var a=l.search.text;T.processing=!0;var i,o=null,r=f();r=r?r.name:"",l.ticket.type!==EntityVO.TYPE_KNOWLEDGE?(i=l.ticket instanceof TicketConsoleItemVO||l.ticket.type!==EntityVO.TYPE_INCIDENT&&l.ticket.type!==EntityVO.TYPE_WORKORDER?l.ticket.customer&&l.ticket.customer.company?l.ticket.customer.company.name:l.ticket.company?l.ticket.company.name:"":s.getExactValueByFieldName("customerCompany")||"",o=(l.ticket.type===EntityVO.TYPE_TASK||l.ticket.type===EntityVO.TYPE_CHANGE)&&l.ticket.id&&l.ticket.company?l.ticket.company.name:l.ticket instanceof TicketConsoleItemVO||l.ticket.type!==EntityVO.TYPE_INCIDENT&&l.ticket.type!==EntityVO.TYPE_WORKORDER?l.ticket.locationCompany?l.ticket.locationCompany.name:null:s.getExactValueByFieldName("locationCompany")):(t=l.ticket.owner.company?l.ticket.owner.company.name:"",n=l.ticket.author.company?l.ticket.author.company.name:""),"All"===l.assignee.group.id?e.getAssigneeSupportGroupPersons("All"===l.assigneeCompany.id?"":l.assigneeCompany.name,"All"===l.assigneeOrganization.id?"":l.assigneeOrganization.name,l.search.text,l.assigneeLoginId,v,null,i,o,t,r,n,!0,!0).then(function(e){l.search.text===a&&g(e.results)})["finally"](function(){T.processing=!1}):e.getAssigneeBySupportGroupId(l.assignee.group.id,l.search.text,l.assigneeLoginId,null,v,null,!0,null,o,t,n,!0).then(function(e){l.search.text===a&&g(e.results)})["finally"](function(){T.processing=!1})},A)):l.assignee.group.persons=[]):l.search.filterText=l.search.text},l.setGroupToAll=function(){O.persons=[],l.selectGroup(O)},l.getSupportGroupsForCompanyAndOrgByName=function(e){var a=null,n=null,i=null,o=null,r=null;return l.ticket.type===EntityVO.TYPE_KNOWLEDGE?(r=f().name,i=l.ticket.owner.company?l.ticket.owner.company.name:"",o=l.ticket.author.company?l.ticket.author.company.name:"","All"===r&&(r=null)):(a=l.ticket instanceof TicketConsoleItemVO||l.ticket.type!==EntityVO.TYPE_INCIDENT&&l.ticket.type!==EntityVO.TYPE_WORKORDER?l.ticket.customer&&l.ticket.customer.company?l.ticket.customer.company.name:l.ticket.company?l.ticket.company.name:"":s.getExactValueByFieldName("customerCompany")||"",n=(l.ticket.type===EntityVO.TYPE_TASK||l.ticket.type===EntityVO.TYPE_CHANGE)&&l.ticket.id&&l.ticket.company?l.ticket.company.name:l.ticket instanceof TicketConsoleItemVO||l.ticket.type!==EntityVO.TYPE_INCIDENT&&l.ticket.type!==EntityVO.TYPE_WORKORDER?l.ticket.locationCompany?l.ticket.locationCompany.name:null:s.getExactValueByFieldName("locationCompany")),t.getAssigneeSupportGroupsForCompanyAndOrgByName("All"===l.assigneeCompany.id?"":l.assigneeCompany.name,"All"===l.assigneeOrganization.id?"":l.assigneeOrganization.name,e,null,a,n,i,r,o,v).then(function(e){return{list:e.supportGroups,exceedsChunkSize:e.exceedsChunkSize}})},l.getSupportOrganizationsByTextAndCompany=function(e){var a=null,n=null,i=null,o=null,r=null;return l.ticket.type===EntityVO.TYPE_KNOWLEDGE?(r=f().name,i=l.ticket.owner.company?l.ticket.owner.company.name:"",o=l.ticket.author.company?l.ticket.author.company.name:"","All"===r&&(r=null)):(a=l.ticket instanceof TicketConsoleItemVO||l.ticket.type!==EntityVO.TYPE_INCIDENT&&l.ticket.type!==EntityVO.TYPE_WORKORDER?l.ticket.customer&&l.ticket.customer.company?l.ticket.customer.company.name:l.ticket.company?l.ticket.company.name:"":s.getExactValueByFieldName("customerCompany")||"",n=(l.ticket.type===EntityVO.TYPE_TASK||l.ticket.type===EntityVO.TYPE_CHANGE)&&l.ticket.id&&l.ticket.company?l.ticket.company.name:l.ticket instanceof TicketConsoleItemVO||l.ticket.type!==EntityVO.TYPE_INCIDENT&&l.ticket.type!==EntityVO.TYPE_WORKORDER?l.ticket.locationCompany?l.ticket.locationCompany.name:null:s.getExactValueByFieldName("locationCompany")),t.getSupportOrganizationsByTextAndCompany(e,"All"===l.assigneeCompany.id?"":l.assigneeCompany.name,null,a,n,i,r,o).then(function(e){return{list:e.organizations,exceedsChunkSize:e.exceedsChunkSize}})},l.getCompaniesByName=function(e){var a,n={};return a=l.ticket instanceof TicketConsoleItemVO||l.ticket.type!==EntityVO.TYPE_INCIDENT&&l.ticket.type!==EntityVO.TYPE_WORKORDER?l.ticket.customer&&l.ticket.customer.company?l.ticket.customer.company.name:l.ticket.company?l.ticket.company.name:"":s.getExactValueByFieldName("customerCompany")||"",a||(a=l.ticket.selectedCompany),n.customerCompany=a,l.ticket.locationCompany&&l.ticket.locationCompany.name?n.locationCompany=l.ticket.locationCompany.name:l.ticket instanceof TicketConsoleItemVO||l.ticket.type!==EntityVO.TYPE_INCIDENT&&l.ticket.type!==EntityVO.TYPE_WORKORDER?(l.ticket.type===EntityVO.TYPE_TASK||l.ticket.type===EntityVO.TYPE_CHANGE)&&l.ticket.id&&l.ticket.company&&(n.locationCompany=l.ticket.company.name):n.locationCompany=s.getExactValueByFieldName("locationCompany"),t.getAssigneeSupportCompaniesByText(e,n).then(function(e){return l.companies=_.cloneDeep(e.objects),{list:e.objects,exceedsChunkSize:e.exceedsChunkSize}})},l.onValueChange=function(){l.$emit(o.WIDGET_VALUE_CHANGE,{fieldName:l.data.name})},l.$watch("data.setValueFlag",function(e){"#$#"!==e&&e&&(l.data.value=e,l.onValueChange(),l.data.setValueFlag="#$#")}),l.state=T,c()}}}])}(),function(){angular.module("myitsmApp").service("attachmentService",["$resource","$http","$timeout","systemAlertService","$q","$modal","objectValueMapperService","configurationModel","$filter",function(e,t,a,n,i,o,r,s,l){function c(e){var t=["jpg","jpeg","png","gif","bmp","tga","tif","tiff"],n=e.fileInput,i={pendingSave:!0};if(window.FileReader){var o;if(e.fileToPrepare)o=e.fileToPrepare;else{var r=angular.element(e.fileInput||"."+e.inputClass);o=r[0].files[0]}var s=new FileReader,l=new FileReader;i.name=o.name,i.size=o.size,i.file=o;var c=i.name.match(/\.([^\.]*)$/);return c&&(i.fileExt=c[1],t.indexOf(i.fileExt.toLowerCase())!==-1?(s.readAsDataURL(o),s.onload=function(e){a(function(){if(i.thumbnail=e.target.result,i.thumbnail){var t=i.thumbnail.match("data:(.*)?;");i.contentType=t&&t[1]||null}})}):a(function(){i.fileGenericIconClass=(new AttachmentVO).getFileGenericIconClass(i.name)})),l.readAsArrayBuffer(o),l.onload=function(e){a(function(){i.binaryData=e.target.result})},i}if(n.value){var d=n.value;return i.fileInput=angular.element(n),i.name=d.indexOf("/")>=0?d.split("/").pop():d.split("\\").pop(),i.fileGenericIconClass=(new AttachmentVO).getFileGenericIconClass(i.name),a(function(){i.fileInput.before(n.cloneNode()).hide()}),i}}function d(e,t,a,n){var i={url:"",files:"",iframe:!0,dataType:"text"};switch(e){case"thumbnail":i.url="/smartit/rest/"+t.type+"/"+t.id+"/thumbnail"+(t.query?"?"+t.query:"");break;case"attachments":i.url="/smartit/rest/attachment/file/"+t.type+"/"+t.id;break;case"worknoteCreate":i.url="/smartit/rest/attachment/file/"+t.type+"/"+t.id+"/"+(t.classId?t.classId+"/":"")+"worknote";break;case"worknoteCreateBulk":i.url="/smartit/rest/attachment/file/bulk/worknote";break;case"worknoteUpdate":i.url="/smartit/rest/attachment/file/worknote/"+t.type+"/"+t.id+(t.classId?"/"+t.classId:"")}var o;return _.isArray(a)?(o=[],_.each(a,function(e,t){e.fileInput.attr({name:"file[]",multiple:"true",id:"attachmentFile_"+t}),e.fileInput.prop("value","sdfasdfasdfasd"),e.fileInput.prop("disabled",null),o.push(e.fileInput[0])})):(o=a.fileInput,o.prop("disabled",null)),n&&(i.data=n,i.processData=!1),i.files=o,i}function u(e){return(e[0]?e[0].items||[]:e.attachmentInfos||[]).map(function(e){return(new AttachmentVO).build(e)})}function p(e){var t=new FormData;if(t.append("text",e.text),t.append("type",e.type),!_.isUndefined(e.access)&&t.append("access",e.access),!_.isUndefined(e.locked)&&t.append("locked",e.locked),e.attachmentInfos.length>0){t.append("attachmentInfos",JSON.stringify(e.attachmentInfos));for(var a=0,n=e.attachments.length;a<n;a++)t.append("file",e.attachments[a].file)}return t}var m=e("",{},{getAttachmentsInfo:{url:"/smartit/rest/attachment/info/:type/:id",method:"GET",isArray:!0},getPlansForChangeRequest:{url:"/smartit/rest/change/plans/:id",method:"GET",isArray:!0},getPlansForRelease:{url:"/smartit/rest/release/:id/plans",method:"GET",isArray:!0},uploadAttachment:{url:"/smartit/rest/attachment/file/:type/:id",method:"POST",isArray:!0,headers:{"Content-Type":void 0},transformRequest:function(e){var t=new FormData;return e.length>0?_.each(e,function(e){t.append("file[]",e.file)}):t.append("file",e.file),t}},uploadProfileThumbnail:{url:"/smartit/rest/:type/:id/thumbnail?:query",method:"PUT",isArray:!1,transformRequest:function(e){var t=new FormData;return t.append("file",e.file),t},transformResponse:function(e){return{thumbnail:e}},headers:{"Content-Type":void 0}},addWorknoteWithAttachment:{url:"/smartit/rest/attachment/file/:type/:id/worknote",method:"POST",isArray:!0,headers:{"Content-Type":void 0},transformRequest:function(e){var t=new FormData;if(t.append("text",e.noteText||e.worknote),!_.isUndefined(e.access)&&t.append("access",e.access),!_.isUndefined(e.locked)&&t.append("locked",e.locked),!_.isUndefined(e.brokerVendorName)&&t.append("brokerVendorName",e.brokerVendorName),e.shareWithVendor&&t.append("shareWithVendor",!0),!_.isUndefined(e.vendorTicketId)&&t.append("vendorTicketId",e.vendorTicketId),e.workInfoType&&t.append("type",e.workInfoType),e["Email.Subject"]&&(t.append("Email.Subject",e["Email.Subject"]),t.append("Email.Body",e["Email.Body"]),e["Email.From.Person"]&&t.append("Email.From.Person",JSON.stringify(e["Email.From.Person"])),e["Email.To.Person"]&&t.append("Email.To.Person",JSON.stringify(e["Email.To.Person"])),e["Email.To.InternetEmail"]&&t.append("Email.To.InternetEmail",e["Email.To.InternetEmail"])),e.attachments.length>0){var a="file[]";1===e.attachments.length&&(a="file");for(var n=0,i=e.attachments.length;n<i;n++)if(e.attachments[n].file&&e.attachments[n].file instanceof Blob){var o=e.attachments[n].name;null===o&&(o="blob"),t.append(a,e.attachments[n].file,o)}else t.append(a,e.attachments[n].file)}return t}},addWorknoteWithAttachmentURLs:{url:"/smartit/rest/attachment/fileurl/:type/:id/worknote",method:"POST",isArray:!0},addWorknoteWithAttachmentBulk:{url:"/smartit/rest/attachment/file/bulk/worknote",method:"POST",isArray:!0,headers:{"Content-Type":void 0},transformRequest:function(e){var t=new FormData;if(t.append("text",e.noteText||e.worknote),!_.isUndefined(e.access)&&t.append("access",e.access),!_.isUndefined(e.locked)&&t.append("locked",e.locked),e["Email.Subject"]&&(t.append("Email.Subject",e["Email.Subject"]),t.append("Email.Body",e["Email.Body"]),e["Email.From.Person"]&&t.append("Email.From.Person",JSON.stringify(e["Email.From.Person"])),e["Email.To.Person"]&&t.append("Email.To.Person",JSON.stringify(e["Email.To.Person"])),e["Email.To.InternetEmail"]&&t.append("Email.To.InternetEmail",e["Email.To.InternetEmail"])),e.attachments.length>0)if(1===e.attachments.length)t.append("file",e.attachments[0].file);else for(var a=0,n=e.attachments.length;a<n;a++)t.append("file[]",e.attachments[a].file);return e.ticketList&&t.append("ticketList",JSON.stringify(e.ticketList)),t}},addAttachmentToWorknote:{url:"/smartit/rest/attachment/file/worknote/:type/:id",method:"POST",isArray:!0,headers:{"Content-Type":void 0},transformRequest:function(e){var t=new FormData;return t.append("file",e.file),t}},createChangePlan:{url:"/smartit/rest/:type/:id/plans",method:"POST",isArray:!0,headers:{"Content-Type":void 0},transformRequest:function(e){return p(e)}},updateChangePlan:{url:"/smartit/rest/:type/:parentId/plans/:id",method:"PUT",isArray:!0,headers:{"Content-Type":void 0},transformRequest:function(e){return p(e)}},deletePlan:{url:"/smartit/rest/:type/:parentId/plans/:planId",method:"DELETE"}});this.getAttachmentsInfo=function(e,t){return t===EntityVO.TYPE_CHANGE?this.getPlansForChangeRequest(e):t===EntityVO.TYPE_RELEASE?this.getPlansForRelease(e):m.getAttachmentsInfo({id:e,type:t}).$promise.then(function(e){return e[0]?u(e):[]})},this.getPlansForRelease=function(e,t){var a=_.isArray(t)?t.join():t,n=a?{types:a}:{};return n.id=e,m.getPlansForRelease(n).$promise.then(function(e){if(!e[0]||!e[0].items||!e[0].items[0].objects)return[];var t=e[0].items[0].objects,a={},n=_.groupBy(t,function(e){return e.workNote.workNoteTypeId});return _.each(t,function(e){e.workNote.attachmentCount>0&&(e.attachmentInfos=u(e)),n[e.workNote.workNoteTypeId].length>1&&(a[e.workNote.workNoteTypeId]?a[e.workNote.workNoteTypeId]++:a[e.workNote.workNoteTypeId]=1,e.typeIndex=a[e.workNote.workNoteTypeId])}),t})},this.getPlansForChangeRequest=function(e,t){var a=_.isArray(t)?t.join():t,n=a?{types:a}:{};return n.id=e,m.getPlansForChangeRequest(n).$promise.then(function(e){if(!e[0]||!e[0].items||!e[0].items[0].objects)return[];var t=e[0].items[0].objects,a={},n=_.groupBy(t,function(e){return e.workNote.workNoteTypeId});return _.each(t,function(e){e.workNote.attachmentCount>0&&(e.attachmentInfos=u(e)),n[e.workNote.workNoteTypeId].length>1&&(a[e.workNote.workNoteTypeId]?a[e.workNote.workNoteTypeId]++:a[e.workNote.workNoteTypeId]=1,e.typeIndex=a[e.workNote.workNoteTypeId])}),t})},this.getAttachmentFile=function(e,n,o,r){n.loadingDetails=!0;var s;if(_.isEmpty(n.attachmentReference))if(n.id&&r)s={method:"GET",url:"/smartit/rest/attachment/social/file/download/"+n.id,responseType:"blob"};else{if(!n.id)return n.loadingDetails=!1,i.reject("attachment info missing");s={method:"GET",url:"/smartit/rest/attachment/file/"+e+"/get/"+n.id,responseType:"blob"}}else s={method:"POST",url:"/smartit/rest/attachment/file/"+e,data:n.attachmentReference,responseType:"blob"};if(window.FormData)return t(s).then(function(e){return o?e:void(window.navigator&&window.navigator.msSaveOrOpenBlob?(window.navigator.msSaveOrOpenBlob(e.data,n.name),n.loadingDetails=!1):a(function(){var t=document.createElement("a");document.body.appendChild(t),t.style.display="none";var a=URL.createObjectURL(e.data);n.loadingDetails=!1,t.href=a,t.download=n.name,t.click(),t.remove()},0))});var l="/smartit/rest/attachment/file/"+e+"?name="+n.name;return _.isEmpty(n.attachmentReference)?n.id&&(l="/smartit/rest/attachment/file/"+e+"/get/"+n.id):_.each(n.attachmentReference,function(e,t){l+="&"+t+"="+e}),window.location.href(l),n.loadingDetails=!1,i.when(1)},this.prepareFileToUpload=function(e){var t=c(e);return t&&!s.isFileExtensionAllowed(t.fileExt)&&(n.error({text:l("i18n")("attachment.fileExtension.error"),clear:!1}),t=null),t},this.dismissAttachment=function(e,t,a,n){var i=e.attachments.indexOf(a);if(i>=0){var o=e.attachments.splice(i,1);a.attachmentReference?n&&"detail"===n&&e.attachmentToDelete.push(o[0]):e.attachmentToUpload.splice(e.attachmentToUpload.indexOf(a),1);var s=r.getFieldByName("desc");s&&(s.value.attachmentToDelete=e.attachmentToDelete,s.value.attachmentToUpload=e.attachmentToUpload)}t.stopImmediatePropagation()},this.uploadAttachment=function(e,t,a){if(window.FileReader)return m.uploadAttachment({type:e,id:t},a).$promise.then(function(e){if(!e[0])return[];a.pendingSave=!1;var t=u(e);return _.each(t,function(e){var t=_.find(a,{name:e.name});t&&(t.binaryData=void 0,angular.extend(e,t)),e.pendingSave=!1}),t})["catch"](function(e){e&&n.error({text:e.data&&e.data.error||e,clear:!1,displayOnStateChange:!0})});var i=d("attachments",{type:e,id:t},a);return this.uploadUsingIframeTransport(i)},this.uploadUsingIframeTransport=function(e,t){var a=i.defer();return $.ajax(e).done(function(e){console.log(e);var n=e?JSON.parse(e):[],i=t?n:u(n);a.resolve(i)}),a.promise},this.deleteAttachment=function(e,a){return t({method:"DELETE",headers:{"Content-Type":"application/json"},url:"/smartit/rest/attachment/"+e,data:a})["catch"](function(e){return n.error({text:e.data.error,clear:!1}),i.reject(e)})},this.uploadProfileThumbnail=function(e,t,a,n){var o=this.prepareFileToUpload({fileInput:a});if(o){if(window.FileReader)return m.uploadProfileThumbnail({type:t,id:e,query:n},o).$promise;var r=d("thumbnail",{type:t,id:e,query:n},o),s=i.defer();return $.ajax(r).done(function(e){console.log(e),s.resolve({thumbnail:e})}),s.promise}return i.when({})},this.addWorknoteWithAttachment=function(e,t){if(window.FileReader)return m.addWorknoteWithAttachment(e,t).$promise;var a=[{name:"text",value:t.noteText},{name:"access",value:t.access},{name:"type",value:t.workInfoType}],n=d("worknoteCreate",{type:e.type,id:e.id,classId:e.classId},t.attachments,a);return this.uploadUsingIframeTransport(n,!0)},this.addWorknoteWithAttachmentURLs=function(e,t){return m.addWorknoteWithAttachmentURLs(e,t).$promise.then(function(){})["catch"](function(e){return n.error({text:e.data.error,clear:!1}),i.reject(e)})},this.addWorknoteWithAttachmentBulk=function(e){if(window.FileReader)return m.addWorknoteWithAttachmentBulk(e).$promise;var t=[{name:"text",value:e.noteText||e.worknote},{name:"access",value:e.access}];e.locked&&t.push({name:"locked",value:e.locked}),e["Email.Subject"]&&t.push({name:"Email.Subject",value:e["Email.Subject"]}),e["Email.Body"]&&t.push({name:"Email.Body",value:e["Email.Body"]}),e["Email.From.Person"]&&t.push({name:"Email.From.Person",value:JSON.stringify(e["Email.From.Person"])}),e["Email.To.Person"]&&t.push({name:"Email.To.Person",value:JSON.stringify(e["Email.To.Person"])}),e["Email.To.InternetEmail"]&&t.push({name:"Email.To.InternetEmail",value:e["Email.To.InternetEmail"]}),e.ticketList&&t.push({name:"ticketList",value:JSON.stringify(e.ticketList)});var a=d("worknoteCreateBulk",void 0,e.attachments,t);return this.uploadUsingIframeTransport(a,!0)},this.addAttachmentToWorknote=function(e,t,a,n){if(window.FileReader)return m.addAttachmentToWorknote({type:e,id:t},a).$promise;var i=d("worknoteUpdate",{type:e,id:t,classId:n},a);return this.uploadUsingIframeTransport(i)},this.createChangePlan=function(e,t,a){return m.createChangePlan({id:e,type:t},a).$promise.then(function(e){if(!e[0]||!e[0].items||!e[0].items[0])return[];var t=e[0].items;return _.each(t,function(e){e.workNote.attachmentCount>0&&(e.attachmentInfos=u(e))}),{data:t,action:"created"}})["catch"](function(e){e&&n.error({text:e.data&&e.data.error||e,clear:!1,displayOnStateChange:!0})})},this.updateChangePlan=function(e,t){return m.updateChangePlan(e,t).$promise.then(function(e){if(!e[0]||!e[0].items||!e[0].items[0])return[];var t=e[0].items;return _.each(t,function(e){e.workNote.attachmentCount>0&&(e.attachmentInfos=u(e))}),{data:t,action:"updated"}})["catch"](function(e){return n.error({text:e.data.error,clear:!1}),i.reject(e)})},this.deletePlan=function(e,t,a){return m.deletePlan({parentId:e,type:t,planId:a}).$promise.then(function(){return{data:[a],action:"deleted"}})},this.normalizeAttachments=function(e){return u(e)},this.showAttachmentPreviewDialog=function(e){return o.open({template:'<attachments-previewer plan="plan"></attachments-previewer>',windowClass:"attachments-previewer-modal",backdropClass:"attachments-previewer-backdrop",controller:["$scope",function(t){t.plan=e}]})}}])}(),function(){angular.module("myitsmApp").directive("attachmentsPreviewer",["attachmentService","$timeout",function(e,t){function a(e){this.container=e;var t=this,a=function(e){if(!window.navigator.msSaveOrOpenBlob){var a=document.createElement("object");a.setAttribute("data",e),t.container.appendChild(a)}},n=function(e){var a=document.createElement("img");a.setAttribute("src",e),a.setAttribute("class","img-responsive center-block"),t.container.appendChild(a)};this.render=function(e,t){if(!e||!t||!this.container)return!1;var i={pdf:a,jpg:n,png:n,gif:n},o=i[t.toLowerCase()];return!!o&&void o(e)},this.clearContainer=function(){this.container.innerHTML=""}}return{restrict:"E",replace:!0,scope:{plan:"="},templateUrl:"views/common/attachment-preview-popup.html",link:function(n){var i=["pdf","jpg","png","gif"],o=$(".attachments-previewer__container_body-holder")[0],r=new a(o),s=function(e){if(window.navigator&&window.navigator.msSaveOrOpenBlob){var a=new Blob([e.fileBlob]);window.navigator.msSaveOrOpenBlob(a,e.name)}else t(function(){var t=document.createElement("a");document.body.appendChild(t),t.style.display="none",t.href=e.url,t.download=e.name,t.click(),t.remove()})};n.plan=n.plan||{},n.workNote=n.plan.workNote||{},n.attachments=n.workNote.attachmentCount?n.plan.attachmentInfos:[],n.currentFile=n.workNote.attachmentCount?n.plan.attachmentInfos[0]:{},n.loading=!1,n.fileTypeNotSupported=!1,n.currentIndex=0,n.getAttachmentShowFile=function(t){e.getAttachmentFile(t,n.currentFile,1).then(function(e){n.loading=!1,n.currentFile.url=URL.createObjectURL(e.data),n.currentFile.fileBlob=e.data,r.render(n.currentFile.url,n.currentFile.contentType)})},n.getAttachmentDownloadFile=function(t){e.getAttachmentFile(t,n.currentFile,1).then(function(e){n.loading=!1,n.currentFile.url=URL.createObjectURL(e.data),n.currentFile.fileBlob=e.data,s(n.currentFile)})},n.showFile=function(e){return!n.loading&&(n.currentIndex=e,n.currentFile=n.attachments[n.currentIndex],r.clearContainer(),i.indexOf(n.currentFile.contentType.toLowerCase())===-1?(n.fileTypeNotSupported=!0,
!1):(n.fileTypeNotSupported=!1,n.currentFile.url?(r.render(n.currentFile.url,n.currentFile.contentType),!0):(n.loading=!0,void(location.hash.indexOf("release")!==-1?n.getAttachmentShowFile("release"):n.getAttachmentShowFile("change")))))},n.downloadFile=function(){return!n.loading&&(n.currentFile.url?(s(n.currentFile),!0):(n.loading=!0,void(location.hash.indexOf("release")!==-1?n.getAttachmentDownloadFile("release"):n.getAttachmentDownloadFile("change"))))},n.close=function(){n.$parent.$dismiss()},n.workNote.attachmentCount&&n.showFile(0)}}}])}(),function(){angular.module("myitsmApp").service("browser",["$window",function(e){var t=e.navigator.userAgent;this.isFirefox=t.indexOf("Firefox")!=-1,this.isOpera=t.indexOf("Opera")!=-1,this.isChrome=t.indexOf("Chrome")!=-1,this.isSafari=t.indexOf("Safari")!=-1&&!this.isChrome,this.isWebkit=t.indexOf("WebKit")!=-1,this.isIE=t.indexOf("Trident")>0||navigator.userAgent.indexOf("MSIE")>0,this.isIE9=t.indexOf("MSIE 9")>0,this.isIE10=t.indexOf("MSIE 10")>0,this.isIE11=t.indexOf("MSIE")==-1&&t.indexOf("Trident")>0,this.isEdge=t.indexOf("Edge")>-1,this.isMobile=/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent.toLowerCase())||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(t.toLowerCase().substr(0,4))}])}(),function(){angular.module("myitsmApp").directive("characterLimitMessage",function(){return{restrict:"E",templateUrl:"views/common/character-limit-message-directive.html",scope:{field:"="},link:function(e,t,a){e.$watch("field",function(){void 0==e.field&&(e.field="")}),e.limit=a.limit?parseInt(a.limit,10):""}}})}(),function(){angular.module("myitsmApp").directive("checkMultiline",["events",function(e){return{restrict:"A",scope:{multilineContent:"@",multilineMaxHeight:"@",isContentMultiline:"="},link:function(t,a,n,i){function o(){a.find("[data-ellipsis]").get(0).scrollHeight>=t.multilineMaxHeight?t.isContentMultiline=!0:t.isContentMultiline=!1,t.$emit(e.MULTILINE_CONTENT_CHANGED,{isContentMultiline:t.isContentMultiline})}t.$watch("multilineContent",function(e,t){setTimeout(o,0)}),o()}}}])}(),function(){angular.module("myitsmApp").directive("currencyInput",["$timeout","metadataModel",function(e,t){return{restrict:"E",templateUrl:"views/common/currency-input-directive.html",replace:!0,require:"?^form",scope:{fieldName:"@",model:"=",id:"@",title:"@",inputDisabled:"=",required:"="},link:function(a,n,i){function o(){t.getMetadataByType(EntityVO.TYPE_ASSET).then(function(t){if(a.metadata=t&&t.currencyFields&&t.currencyFields[a.fieldName],a.model){var n=a.model.currencycode||a.metadata&&a.metadata.currencycode||"USD";a.currencySelected(_.find(a.metadata.currencyOptions,{currencycode:n}))}a.$watch("model.currencycode",function(e){e&&a.currencySelected(_.find(a.metadata.currencyOptions,{currencycode:a.model.currencycode}))}),angular.isDefined(i.autofocus)&&e(function(){r.focus()},300)})}var r=n.find(".dropdown-toggle");a.state={isDropdownOpen:!1},a.currencySelected=function(t){a.selectedCurrency=t,a.model.currencycode=t.currencycode,a.step=Math.pow(10,-t.precision),e(function(){a.state.isDropdownOpen&&(a.state.isDropdownOpen=!1),r.focus()},0)},a.handleKeydown=function(t){27===t.keyCode&&(e(function(){r.trigger("click"),r.focus()},0),t.stopPropagation())},o()}}}])}(),function(){angular.module("myitsmApp").directive("displayTicketDates",function(){return{restrict:"E",templateUrl:"views/ticket/partials/display-ticket-dates.html",scope:{ticket:"="},link:function(e){e.isChange=function(){return e.ticket.type===EntityVO.TYPE_CHANGE},e.isRelease=function(){return e.ticket.type===EntityVO.TYPE_RELEASE}}}})}(),function(){angular.module("myitsmApp").directive("editActivityDates",["$rootScope","events","utilityFunctions","configurationModel","ticketModel","fieldValidationModel","editTicketDatesService",function(e,t,a,n,i,o,r){return{restrict:"E",templateUrl:"views/common/edit-activity-dates.html",replace:!0,scope:{ticketOriginal:"=ticket",dateForm:"=",isDraft:"=",updateIsHandledByParent:"=",onlyShowRequired:"=",ignoreAccessMapping:"=",makeScheduleDatesOptional:"=",makeActualDatesOptional:"="},link:function(s){function l(){return S.pendingTicketDatesChange?{scheduledStartDate:E(s.ticket.scheduledStartDate),scheduledEndDate:E(s.ticket.scheduledEndDate),actualStartDate:E(s.ticket.actualStartDate),actualEndDate:E(s.ticket.actualEndDate)}:{}}function c(){v=_.clone({scheduledStartDate:s.ticket.scheduledStartDate,scheduledEndDate:s.ticket.scheduledEndDate,actualStartDate:s.ticket.actualStartDate,actualEndDate:s.ticket.actualEndDate})}function d(){e.timezone&&(s.ticket.scheduledStartDate=a.convertToLocalTimezone(s.ticket.scheduledStartDate,e.timezone),s.ticket.scheduledEndDate=a.convertToLocalTimezone(s.ticket.scheduledEndDate,e.timezone),s.ticket.actualStartDate=a.convertToLocalTimezone(s.ticket.actualStartDate,e.timezone),s.ticket.actualEndDate=a.convertToLocalTimezone(s.ticket.actualEndDate,e.timezone))}function u(e){return i.update(s.ticket.id,s.ticket.type,e)}function p(){s.updateIsHandledByParent&&!s.isDraft||s.$emit(t.SAVE_CHANGES_COMPLETE),m()}function m(){S.pendingTicketDatesChange=!1}function f(){s.ticket.parentGuid||(s.ticket.parentGuid=T),m()}function g(){c()}function h(){console.log("handleSaveChanges in editTicketDates directive"),s.save()}function y(){s.cancel()}function E(t,n){return t=e.timezone?a.convertToUserPreferenceTimezone(t,e.timezone):t,n=n?moment(n):moment(t),1e3*moment(t).set("hours",n.get("hours")).set("minutes",n.get("minutes")).format("X")}s.ticket=_.cloneDeep(s.ticketOriginal);var v,T=s.ticket?s.ticket.parentGuid:"";s.ticket&&(c(),d()),s.$watch("ticketOriginal",function(e){s.ticket=_.cloneDeep(s.ticketOriginal),s.ticket&&d()});var S={pendingTicketDatesChange:!1};s.state=S,s.validator=r,s.datePickerOptions={startingDay:n.getWeekStartingDay(),"show-weeks":!1,"min-date":moment().year(1970).month(0).date(2),"max-date":moment().year(2038).month(0).date(18)},s.showMeridian=window.showMeridian,s.$watch("ticket.timing",function(){s.ticket&&s.ticket.timing&&(s.ticket.scheduledStartDate=s.isFieldDisabled("scheduledStartDate")?null:s.ticket.scheduledStartDate,s.ticket.scheduledEndDate=s.isFieldDisabled("scheduledEndDate")?null:s.ticket.scheduledEndDate)}),s.save=function(){var e=l(),a=s.isDraft,n=!s.updateIsHandledByParent;s.$emit(t.SAVE_CHANGES_REQUEST,e,n||a),_.size(e)?a?p():n&&u(e).then(function(){p()}):p()},s.cancel=function(){s.ticket.scheduledStartDate=v.scheduledStartDate,s.ticket.scheduledEndDate=v.scheduledEndDate,s.ticket.actualStartDate=v.actualStartDate,s.ticket.actualEndDate=v.actualEndDate,s.updateDateTime("actual"),s.updateDateTime("scheduled"),p()},s.updateDateTime=function(e){S.pendingTicketDatesChange=!0,r.updateDateTime(s.dateForm,s.ticket,e)},s.isFieldRequired=function(e){return s.ticket&&o.isFieldRequired(s.ticket.type,s.ticket.status.value,s.ticket.timing,e)},s.isFieldDisabled=function(e){return s.ticket&&o.isFieldDisabled(s.ticket.type,s.ticket.status.value,s.ticket.timing,e)},s.$on(t.SAVE_CHANGES,h),s.$on(t.TOGGLE_EDIT_MODE,g),s.$on(t.DISCARD_CHANGES,y),s.$on(t.SAVE_ALL_CHANGES_COMPLETE,f)}}}])}(),function(){angular.module("myitsmApp").directive("editAffectedAssets",["events",function(e){return{restrict:"E",templateUrl:"views/common/edit-affected-assets.html",replace:!0,scope:{ticket:"=",metaData:"=",isDraft:"=",updateIsHandledByParent:"="},controller:["$scope","$state","assetService","ticketModel","categoriesService","$timeout",function(t,a,n,i,o,r){function s(e){if(!_.isEmpty(e)){v.impactedService=e.impactedService&&e.impactedService.name?e.impactedService:{},v.causalCI=e.causalCI&&e.causalCI.name?e.causalCI:{},v.categorizations=angular.copy(e.categorizations);var t=v.categorizations;v.resCategorizations&&v.isClosed()?t=v.categorizations.concat(e.resCategorizations):v.type===EntityVO.TYPE_INCIDENT&&(v.categorizations.push(_.find(e.resCategorizations,{name:"resolutionProduct"})),v.categorizations.push(_.find(e.resCategorizations,{name:"resolution"})),t=v.categorizations),v.allCategories=o.populateCategories(t,T),v.noCategories=_.filter(v.allCategories,"valueToShow").length}}function l(a){_.isEmpty(a)||C.pendingAffectedServiceChange&&t.$emit(e.AFFECTED_SERVICE_UPDATE_SAVED)}function c(){var e={},a=S.selectedService;if(C.pendingAffectedServiceChange&&(angular.isObject(a)?(e.impactedService=a.name,e.impactedServiceReconId=a.reconciliationId):(e.impactedService="",e.impactedServiceReconId="")),t.type!==EntityVO.TYPE_WORKORDER&&C.pendingAffectedAssetChange){var n=S.selectedAsset;angular.isObject(n)?(e.causalCI=n.name,e.causalCIreconId=n.reconciliationId,!S.isAssetRetained&&S.oldAssetValue&&(e.previousCausalCI=S.oldAssetValue.name,e.previousCausalCIreconId=S.oldAssetValue.reconciliationId),S.oldAssetValue=n):(e.causalCI="",e.causalCIreconId="",S.oldAssetValue=null),S.isAssetRetained=!0}return e}function d(e){return i.update(v.id,v.type,e)}function u(){v=t.ticket,angular.isObject(S.selectedService)?v.impactedService=S.selectedService:""===S.selectedService&&(v.impactedService={}),angular.isObject(S.selectedAsset)?v.causalCI=S.selectedAsset:""===S.selectedAsset&&(v.causalCI={})}function p(){C.pendingAffectedAssetChange=!1,C.pendingAffectedServiceChange=!1}function m(){S.selectedService=v.impactedService&&v.impactedService.name||"",S.selectedAsset=!_.isEmpty(v.causalCI)&&v.causalCI||"",p()}function f(){t.save()}function g(){t.updateIsHandledByParent&&!t.isDraft||t.$emit(e.SAVE_CHANGES_COMPLETE),p()}function h(e,t){s(t),l(t),p()}function y(){t.cancel()}function E(e,t){v.company!==t?(S.selectedService="",S.selectedAsset="",C.pendingAffectedAssetChange=!0,C.pendingAffectedServiceChange=!0,v.company=t):m()}t.type=t.ticket.type;var v=t.ticket,T=t.metaData,S={};t.type!==EntityVO.TYPE_WORKORDER&&t.type!==EntityVO.TYPE_CHANGE&&t.type!==EntityVO.TYPE_RELEASE&&v.causalCI&&v.causalCI&&(S.selectedAsset=v.causalCI&&v.causalCI.name?v.causalCI:""),(t.type!==EntityVO.TYPE_CHANGE||t.type!==EntityVO.TYPE_RELEASE&&v.impactedService)&&v.impactedService&&(S.selectedService=v.impactedService.name),S.selectedAsset&&(S.oldAssetValue=S.selectedAsset,null!==S.oldAssetValue&&(S.isAssetRetained=!0));var C={pendingAffectedServiceChange:!1,pendingAffectedAssetChange:!1};t.state=C,t.onAffectedServiceChange=function(){C.pendingAffectedServiceChange=!0,t.state.isServiceTooltipOpen=!1},t.$watch("editedData.selectedService",function(){S&&_.isObject(S.selectedService)&&(t.onAffectedServiceChange(),t.ticket.type!==EntityVO.TYPE_PROBLEM&&t.ticket.type!==EntityVO.TYPE_KNOWNERROR||(v.oldImpactedService=v.impactedService,v.impactedService=S.selectedService),t.$emit(e.AFFECTED_SERVICE_UPDATED,S.selectedService))},!0),t.onAffectedAssetChange=function(){C.pendingAffectedAssetChange=!0,t.state.isAssetTooltipOpen=!1},t.$watch("editedData.selectedAsset",function(){if(S&&_.isObject(S.selectedAsset)){if(!S.selectedAsset.name)return void(S.selectedAsset="");t.onAffectedAssetChange(),t.$emit(e.AFFECTED_ASSET_UPDATED,S.selectedAsset)}}),t.editedData=S,t.save=function(){var a=c(),n=t.isDraft,i=!t.updateIsHandledByParent;t.$emit(e.SAVE_CHANGES_REQUEST,a,i||n),_.size(a)?n?(u(),g()):i&&d(a).then(function(e){s(e),g()}):g()},t.cancel=function(){t.type!==EntityVO.TYPE_WORKORDER&&t.type!==EntityVO.TYPE_CHANGE&&t.type!==EntityVO.TYPE_RELEASE&&v.causalCI&&(S.selectedAsset=!_.isEmpty(v.causalCI)&&v.causalCI||""),t.type!==EntityVO.TYPE_CHANGE&&v.impactedService&&(S.selectedService=v.impactedService.name||""),t.type!==EntityVO.TYPE_PROBLEM&&t.type!==EntityVO.TYPE_KNOWNERROR||!v.impactedService&&!v.oldImpactedService||(S.selectedService=v.oldImpactedService.name||v.impactedService.name||"",v.impactedService=v.oldImpactedService),p()},t.getListOfAffectedAssets=function(e){var a=[EntityVO.TYPE_CHANGE,EntityVO.TYPE_RELEASE,EntityVO.TYPE_PROBLEM,EntityVO.TYPE_KNOWNERROR].indexOf(v.type)>=0?v.company.name:v.customer.company.name;return t.affectedAssetDataLoading=!0,n.getListOfAssetsForCompany(e,a,v.type,v.customer&&v.customer.id).then(function(e){return t.state.exceedsAssetChunkSize=e[0].items[0].exceedsChunkSize,t.state.isAssetTooltipOpen=t.state.exceedsAssetChunkSize,r(function(){t.state.isAssetTooltipOpen=!1},1e4),e[0].items[0].objects})["finally"](function(){t.affectedAssetDataLoading=!1})},t.getListOfAffectedServices=function(e){var a=[EntityVO.TYPE_CHANGE,EntityVO.TYPE_RELEASE,t.getListOfAffec,EntityVO.TYPE_PROBLEM,EntityVO.TYPE_KNOWNERROR].indexOf(v.type)>=0?v.company.name:v.customer.company.name;return t.affectedServiceDataLoading=!0,n.getListOfAssetsByTypeForCompany(e,"Business Service",a,v.type,v.customer&&v.customer.id).then(function(e){return t.state.exceedsServiceChunkSize=e[0].items[0].exceedsChunkSize,t.state.isServiceTooltipOpen=t.state.exceedsServiceChunkSize,r(function(){t.state.isServiceTooltipOpen=!1},1e4),e[0].items[0].objects})["finally"](function(){t.affectedServiceDataLoading=!1})},t.clearSelectedService=function(){S.selectedService="",t.onAffectedServiceChange()},t.clearSelectedAsset=function(){S.selectedAsset="",t.onAffectedAssetChange()},t.$on(e.CLEAR_AFFECTED_SERVICE,E),t.$on(e.TOGGLE_EDIT_MODE,m),t.$on(e.SAVE_CHANGES,f),t.$on(e.SAVE_ALL_CHANGES_COMPLETE,h),t.$on(e.DISCARD_CHANGES,y)}]}}])}(),function(){angular.module("myitsmApp").directive("editReleaseDates",["$rootScope","events","utilityFunctions","configurationModel","ticketModel","fieldValidationModel","editTicketDatesService",function(e,t,a,n,i,o,r){return{restrict:"E",templateUrl:"views/common/edit-release-dates.html",replace:!0,scope:{ticketOriginal:"=ticket",dateForm:"=",isDraft:"=",updateIsHandledByParent:"=",onlyShowRequired:"=",ignoreAccessMapping:"=",makeScheduleDatesOptional:"=",makeActualDatesOptional:"="},link:function(s){function l(){e.timezone&&(s.ticket.scheduledStartDate=a.convertToLocalTimezone(s.ticket.scheduledStartDate,e.timezone),s.ticket.scheduledEndDate=a.convertToLocalTimezone(s.ticket.scheduledEndDate,e.timezone),s.ticket.actualStartDate=a.convertToLocalTimezone(s.ticket.actualStartDate,e.timezone),s.ticket.actualEndDate=a.convertToLocalTimezone(s.ticket.actualEndDate,e.timezone),s.ticket.targetDate=a.convertToLocalTimezone(s.ticket.targetDate,e.timezone),s.ticket.deploymentStartDate=a.convertToLocalTimezone(s.ticket.deploymentStartDate,e.timezone),s.ticket.deploymentEndDate=a.convertToLocalTimezone(s.ticket.deploymentEndDate,e.timezone))}function c(){return T.pendingTicketDatesChange?(void 0===s.ticket.deploymentStartDate&&(s.ticket.deploymentStartDate=null),void 0===s.ticket.deploymentEndDate&&(s.ticket.deploymentEndDate=null),{scheduledStartDate:E(s.ticket.scheduledStartDate),scheduledEndDate:E(s.ticket.scheduledEndDate),actualStartDate:E(s.ticket.actualStartDate),actualEndDate:E(s.ticket.actualEndDate),targetDate:E(s.ticket.targetDate),deploymentStartDate:E(s.ticket.deploymentStartDate),deploymentEndDate:E(s.ticket.deploymentEndDate)}):{}}function d(){v=_.clone({scheduledStartDate:s.ticket.scheduledStartDate,scheduledEndDate:s.ticket.scheduledEndDate,actualStartDate:s.ticket.actualStartDate,actualEndDate:s.ticket.actualEndDate,targetDate:s.ticket.targetDate,deploymentStartDate:s.ticket.deploymentStartDate,deploymentEndDate:s.ticket.deploymentEndDate})}function u(e){return i.update(s.ticket.id,s.ticket.type,e)}function p(){s.updateIsHandledByParent&&!s.isDraft||s.$emit(t.SAVE_CHANGES_COMPLETE),m()}function m(){T.pendingTicketDatesChange=!1}function f(){m()}function g(){d()}function h(){console.log("handleSaveChanges in editTicketDates directive"),s.save()}function y(){s.cancel()}function E(t,n){return t=e.timezone?a.convertToUserPreferenceTimezone(t,e.timezone):t,n=n?moment(n):moment(t),1e3*moment(t).set("hours",n.get("hours")).set("minutes",n.get("minutes")).format("X")}var v;s.ticket=_.cloneDeep(s.ticketOriginal),s.ticket&&(d(),l()),s.$watch("ticketOriginal",function(e){s.ticket=_.cloneDeep(s.ticketOriginal),s.ticket&&l()});var T={pendingTicketDatesChange:!1};s.state=T,s.validator=r,s.currentDate=new Date,s.datePickerOptions={startingDay:n.getWeekStartingDay(),"show-weeks":!1,minDate:moment().year(1970).month(0).date(2),maxDate:moment().year(2038).month(0).date(18)},s.showMeridian=window.showMeridian,s.$watch("ticket",function(e){e&&(s.targetDateEnabled=s.ticket.type===EntityVO.TYPE_RELEASE)}),s.$watch("ticket.timing",function(){s.ticket&&s.ticket.timing&&(s.ticket.scheduledStartDate=s.isFieldDisabled("scheduledStartDate")?null:s.ticket.scheduledStartDate,s.ticket.scheduledEndDate=s.isFieldDisabled("scheduledEndDate")?null:s.ticket.scheduledEndDate)}),s.$watch("ticket.scheduledStartDate",function(e,t){s.ticket.tempScheduledInit=e?angular.copy(new Date(e)):{}}),s.$watch("ticket.actualStartDate",function(e,t){s.ticket.tempActualInit=e?angular.copy(new Date(e)):{}}),s.$watch("ticket.deploymentStartDate",function(e,t){s.ticket.tempDeploymentInit=e?angular.copy(new Date(e)):{}}),s.save=function(){var e=c(),a=s.isDraft,n=!s.updateIsHandledByParent;s.$emit(t.SAVE_CHANGES_REQUEST,e,n||a),_.size(e)?a?p():n&&u(e).then(function(){p()}):p()},s.cancel=function(){s.ticket.scheduledStartDate=v.scheduledStartDate,s.ticket.scheduledEndDate=v.scheduledEndDate,s.ticket.actualStartDate=v.actualStartDate,s.ticket.actualEndDate=v.actualEndDate,s.ticket.targetDate=v.targetDate,s.ticket.deploymentStartDate=v.deploymentStartDate,s.ticket.deploymentEndDate=v.deploymentEndDate,s.updateDateTime("actual"),s.updateDateTime("scheduled"),s.updateDateTime("deployment"),s.updateTargetDate(),p()},s.updateDateTime=function(e){T.pendingTicketDatesChange=!0,r.updateDateTime(s.dateForm,s.ticket,e),"targetDate"===e&&s.updateTargetDate()},s.updateTargetDate=function(){T.pendingTicketDatesChange=!0,r.updateTargetDateTime(s.dateForm,s.ticket)},s.isFieldRequired=function(e){return s.ticket&&o.isFieldRequired(s.ticket.type,s.ticket.status.value,s.ticket.timing,e)},s.isFieldDisabled=function(e){return s.ticket&&o.isFieldDisabled(s.ticket.type,s.ticket.status.value,s.ticket.timing,e)},s.$on(t.SAVE_CHANGES,h),s.$on(t.TOGGLE_EDIT_MODE,g),s.$on(t.DISCARD_CHANGES,y),s.$on(t.SAVE_ALL_CHANGES_COMPLETE,f)}}}])}(),function(){angular.module("myitsmApp").directive("editServiceType",["events","systemAlertService","$filter",function(e,t,a){return{restrict:"E",templateUrl:"views/common/edit-service-type.html",replace:!0,scope:{ticket:"=",metaData:"=",isDraft:"=",updateIsHandledByParent:"=",clearCategories:"&",isCategoriesEmpty:"="},controller:["$scope","$state","ticketModel",function(n,i,o){function r(){n.ticket.serviceType&&(f.selectedServiceType=_.find(n.incidentMetadata.types,{name:n.ticket.serviceType}),f.lastSelectedServiceType=f.selectedServiceType.name)}function s(){n.save()}function l(){return n.ticket.serviceType&&f.selectedServiceType.name===n.ticket.serviceType?{}:{serviceType:f.selectedServiceType.name}}function c(){n.updateIsHandledByParent&&!n.isDraft||n.$emit(e.SAVE_CHANGES_COMPLETE)}function d(){angular.isObject(f.selectedServiceType)&&(n.ticket.serviceType=f.selectedServiceType.name)}function u(){var e=t.modal({type:"info",title:a("i18n")("common.notification.dirty.title"),text:a("i18n")("categorization.serviceTypeChange.warning"),buttons:[{text:a("i18n")("common.button.yes"),data:!0},{text:a("i18n")("common.button.no"),data:!1}]});return e.result}function p(e,t){_.isEmpty(t)||(n.ticket.serviceType=t.serviceType)}function m(){n.ticket.serviceType&&(f.selectedServiceType=_.find(n.incidentMetadata.types,{name:n.ticket.serviceType}))}var f={lastSelectedServiceType:"",selectedServiceType:{}};n.incidentMetadata={},n.editedData=f,angular.extend(n.incidentMetadata,n.metaData),n.updateCategories=function(){f.selectedServiceType.name!==f.lastSelectedServiceType&&(n.isCategoriesEmpty?(n.clearCategories({selectedServiceType:f.selectedServiceType.name}),f.lastSelectedServiceType=f.selectedServiceType.name):u().then(function(e){e?(n.clearCategories({selectedServiceType:f.selectedServiceType.name}),f.lastSelectedServiceType=f.selectedServiceType.name):f.selectedServiceType=_.find(n.incidentMetadata.types,{name:f.lastSelectedServiceType})}))},n.save=function(){var t=l(),a=!n.updateIsHandledByParent;n.$emit(e.SAVE_CHANGES_REQUEST,t,a||n.isDraft),_.size(t)?n.isDraft?(d(),c()):a&&o.update(n.ticket.id,n.ticket.type,t).then(function(e){n.ticket.serviceType=e.serviceType,c()},function(){n.$emit(e.DISCARD_CHANGES)}):c()},n.$on(e.TOGGLE_EDIT_MODE,r),n.$on(e.SAVE_CHANGES,s),n.$on(e.SAVE_ALL_CHANGES_COMPLETE,p),n.$on(e.DISCARD_CHANGES,m)}]}}])}(),function(){angular.module("myitsmApp").directive("editable",function(){return{require:"ngModel",link:function(e,t,a,n){function i(){e.$apply(function(){n.$setViewValue(t.text())})}t.on("keyup click",i),e.$on("$destroy",function(){console.log("editable: unbind events"),t.off("keyup",i),t.off("click",i)}),n.$render=function(){_.isUndefined(n.$viewValue)?t.text(""):t.text(n.$viewValue)}}}}).directive("editSummary",["events","$timeout","attachmentService","ticketModel","$q","systemAlertService","i18nService","$filter","$compile","objectValueMapperService","$rootScope",function(e,t,a,n,i,o,r,s,l,c,d){return{restrict:"E",templateUrl:"views/common/edit-summary-directive.html",replace:!0,scope:{ticket:"=",context:"=",metadata:"=",textAreaName:"@",textplaceholder:"=",isDescRequired:"=",updateIsHandledByParent:"=",dropable:"=",label:"@",editDisabled:"=",type:"=",editMode:"=?",data:"=?",isEditable:"=?",showAttachmentIcon:"=?",descLimit:"=?"},link:function(r,u,p){function m(){_.isBoolean(r.isEditable)||(r.isEditable=!0),_.isUndefined(r.ticket.attachments)&&(r.ticket.attachments=[]),_.isUndefined(r.ticket.desc)&&(r.ticket.desc=""),r.isDescRequired&&(A.prop("required",!0),A.attr("aria-required","true")),(r.ticket.workNote&&r.ticket.workNote.locked||!r.isEditable)&&(r.isLocked=!0),r.metadata&&r.metadata.configurationParameters&&(r.displayEncodedCharacters="true"===r.metadata.configurationParameters.displayEncodedCharacters),r.descCopy=r.ticket.desc,r.attachments=r.ticket.attachments,r.state={descriptionChanged:!1},r.showAttachment=r.ticket.type!==EntityVO.TYPE_CHANGE&&"true"===p.attachment,r.descLimit=p.descLimit?parseInt(p.descLimit,10):"",r.attachmentLimit=r.showAttachment&&p.attachmentLimit?parseInt(p.attachmentLimit,10):9999,r.ticket.type===EntityVO.TYPE_TASK&&(r.attachmentLimit=3),r.attachmentToUpload=[],r.attachmentToDelete=[],r.attachmentDropped=!1,r.textAreaIsFocused=!1,r.data&&_.each(r.data.members,function(e){e.required&&(r.data.isRequired=e.required)}),r.$on(e.AFTER_SAVED_CHANGES,C),r.$on(e.TOGGLE_EDIT_MODE,y),r.$on(e.SAVE_CHANGES,E),r.$on(e.SAVE_ALL_CHANGES_COMPLETE,v),r.$on(e.DISCARD_CHANGES,T),r.$on(e.DESC_CHANGED,function(){r.descCopy=r.ticket.desc}),r.$on(e.CLEAR_DESC,function(){r.descCopy="",r.ticket&&(r.ticket.desc="")});var t=d.$on(e.TICKET_TEMPLATE_UPDATED,function(t,a){r.ticket.ticketType===a.ticketType&&(r.descCopy=a.desc,r.data&&(r.data.value.desc=r.descCopy,r.$emit(e.WIDGET_VALUE_CHANGE,{fieldName:r.data.name})))});r.$watch("descCopy",function(){S()}),r.$on("$destroy",function(){t(),O=null,A=null})}function f(){return r.state.descriptionChanged?{desc:r.descCopy}:{}}function g(){return"draft"===r.context}function h(){r.editMode=!1,r.state.descriptionChanged=!1,r.updateIsHandledByParent&&!g()||r.$emit(e.SAVE_CHANGES_COMPLETE)}function y(){r.editMode||r.editDisabled||r.edit()}function E(){r.save()}function v(){r.ticket.desc=r.descCopy,r.updateIsHandledByParent&&!r.ticket.isDraft&&h()}function T(){r.cancel()}function S(){var e=14;t(function(){A&&A.height(A[0].scrollHeight-e)})}function C(){var e=c.getFieldByName("desc");!r.ticket.isDraft&&e&&(e.value.attachmentToUpload=[],e.value.attachmentToDelete=[],r.attachmentToDelete=[],r.attachmentToUpload=[],r.attachments=_.cloneDeep(r.ticket.attachments),I=_.cloneDeep(r.ticket.attachments)),h()}var O=u.find(".ticket-summary__content"),A=O.find("textarea.content"),I=_.cloneDeep(r.ticket.attachments);r.data&&r.$watch("data.setValueFlag",function(e){e&&"#$#"!==e&&(r.descCopy=e,r.onTicketDescriptionChange(),r.data.setValueFlag="#$#")}),r.handleFileChange=function(e){var n=a.prepareFileToUpload({fileInput:e});if(n&&n.size<=0)return void o.warning({text:s("i18n")("attachment.file_empty"),icon:"icon-exclamation_triangle",clear:!0,hide:5e3});if(n){e.value=null;var i=angular.element(e.cloneNode());l(i)(r),angular.element(e).before(i).remove(),t(function(){i.focus(),r.attachments.push(n),r.context&&"detail"===r.context&&r.attachmentToUpload.push(n);var e=c.getFieldByName("desc");e&&_.size(r.attachmentToUpload)&&(e.value.attachmentToUpload=r.attachmentToUpload)})}},r.dismissAttachment=function(e,t){a.dismissAttachment(r,e,t,r.context);var n=e.currentTarget;angular.element(n).parents("div.editable-summary").find("textarea").focus()},r.handleAttachmentClick=function(e){return"draft"!==r.context&&"create"!==r.context&&void a.getAttachmentFile(r.ticket.type?r.ticket.type:r.type,e)},r.edit=function(){r.data&&r.data.value?r.descCopy=r.data.value.desc:r.descCopy=_.clone(r.ticket.desc),r.editMode=!0,S()},r.save=function(){var t=[],s=g(),l=f(),c=!r.updateIsHandledByParent;return s||(_.size(l)&&c&&t.push(n.update(r.ticket.id,r.ticket.type,l)),_.size(r.attachmentToUpload)&&t.push(a.uploadAttachment(r.ticket.type,r.ticket.id,r.attachmentToUpload).then(function(e){var t=_.union(r.attachments,e);r.attachments=_.filter(t,function(e){return!e.pendingSave})})),_.size(r.attachmentToDelete)&&_.each(r.attachmentToDelete,function(e){t.push(a.deleteAttachment(r.ticket.type,{dataSourceId:e.attachmentReference.dataSourceId,attachmentId:e.attachmentReference.attachmentId}))})),i.all(t).then(function(){h(),r.ticket.attachments=r.attachments=_.without(r.attachments,r.attachmentToDelete),r.attachmentToUpload=[],r.attachmentToDelete=[],r.$emit(e.SAVE_CHANGES_REQUEST,l,c||s)})["catch"](function(e){r.cancel(),e&&o.error({text:e.data&&e.data.error||e,clear:!1})}),t},r.cancel=function(){r.attachmentToDelete=[],r.attachmentToUpload=[],r.descCopy=_.clone(r.ticket.desc),r.attachments=_.cloneDeep(I),r.ticket.attachments=_.cloneDeep(I),r.data&&(r.data.value.desc=r.descCopy,r.$emit(e.WIDGET_VALUE_CHANGE,{fieldName:r.data.name})),h()},r.onTicketDescriptionChange=function(){var t=u.find(".ticket-summary__content"),a=t.find("textarea.content"),n=angular.element.find(".editable-content-section__content"),i=a[0].offsetHeight,o=a[0].scrollHeight;a.css("height","auto"),o>0&&(a.css("height",o+"px"),n&&n.length&&jQuery(n).scrollTop(n[0].scrollTop+(o-i))),r.$emit(e.FIELD_FORM_IS_DIRTY),r.state.descriptionChanged=!0,"create"===r.context&&(r.ticket.desc=r.descCopy),r.descLimit&&r.ticket.desc&&r.ticket.desc.length>r.descLimit&&(r.ticket.desc=s("limitTo")(r.ticket.desc,r.descLimit)),r.data&&(r.descCopy||""===r.descCopy)&&r.data.value.desc!==r.descCopy&&(r.data.value.desc=r.descCopy,r.$emit(e.WIDGET_VALUE_CHANGE,{fieldName:r.data.name,memberName:r.data.name}))},r.descLimit>0&&u.find(".content").attr("maxlength",r.descLimit),r.viewSummaryExpandable=function(){var e=100,t=u.find(".ticket-summary__content"),a=t.find("div.content");return!r.editMode&&"create"!==r.context&&(a[0].scrollHeight>e||r.attachmentsCountOverLimit()>0)},r.summaryExpandable=function(){var e=100;return!r.editMode&&"create"!==r.context&&(A[0].scrollHeight>e||r.attachmentsCountOverLimit()>0)},r.attachmentsCountOverLimit=function(){var e=4;return(r.attachments||[]).length>e?r.attachments.length-e:0},r.summaryCollapsed=function(){return!r.summaryExpanded&&r.summaryExpandable()},r.viewSummaryCollapsed=function(){return!r.summaryExpanded&&r.viewSummaryExpandable()},r.showMoreVisible=function(){return!r.summaryExpanded&&r.viewSummaryExpandable()},r.showLessVisible=function(){return r.summaryExpanded&&r.viewSummaryExpandable()},r.toggleSummary=function(){r.summaryExpanded=!r.summaryExpanded,t(function(){A.scrollTop(0)})},r.filteredAttachments=function(){return r.summaryCollapsed()?r.attachments.slice(0,4):r.attachments},m()}}}])}(),function(){angular.module("myitsmApp").service("editTicketDatesService",["fieldValidationModel",function(e){function t(t,a){var n=!1;return t&&t.timing&&(n=e.isFieldDisabled(t.type?t.type:EntityVO.TYPE_CHANGE,t.status&&t.status.value?t.status.value:"Draft",t.timing.name?t.timing.name:t.timing,a)),n}this.updateDateTime=function(e,t,a){if(null==t[a+"StartDate"]&&null==t[a+"EndDate"]&&e[a+"EndDate"]&&e[a+"EndDate"].$setValidity("validScheduledEndDateTime",!0),!t[a+"StartDate"]&&t[a+"EndDate"]?e[a+"StartDate"]&&e[a+"StartDate"].$setValidity("validScheduledStartDateTime",!1):e[a+"StartDate"]&&e[a+"StartDate"].$setValidity("validScheduledStartDateTime",!0),t[a+"StartDate"]&&t[a+"EndDate"]){var n=t[a+"StartDate"],i=t[a+"EndDate"];i<n?e[a+"EndDate"]&&e[a+"EndDate"].$setValidity("validScheduledEndDateTime",!1):e[a+"EndDate"]&&e[a+"EndDate"].$setValidity("validScheduledEndDateTime",!0)}},this.updateTargetDateTime=function(t,a){t.targetDate&&null!==a.targetDate&&t.targetDate.$setValidity("validTargetDateTime",e.isFutureDateTime(new Date(a.targetDate)))},this.scheduledStartDateDisabled=function(e,a,n){return e=e||{},a?"change"===e.type&&(!e.accessMappings.scheduleddateEditAllowed||t(e,"scheduledStartDate"))&&!n&&e.isClosed():e.useTargetDate||t(e,"scheduledStartDate")||e.actualStartDate||e.actualEndDate},this.scheduledStartTimeDisabled=function(e,a,n){return e=e||{},a?!e.scheduledStartDate||"change"===e.type&&!n&&e.isClosed()&&(!e.accessMappings.scheduleddateEditAllowed||t(e,"scheduledStartDate")):!e.scheduledStartDate||e.useTargetDate||t(e,"scheduledStartDate")},this.scheduledEndDateDisabled=function(e,a,n){return e=e||{},a?"change"===e.type&&(!e.accessMappings.scheduleddateEditAllowed||t(e,"scheduledEndDate"))&&!n&&e.isClosed():e.useTargetDate||t(e,"scheduledEndDate")||e.actualStartDate||e.actualEndDate},this.scheduledEndTimeDisabled=function(e,a,n){return e=e||{},a?!e.scheduledEndDate||"change"===e.type&&!n&&e.isClosed()&&(!e.accessMappings.scheduleddateEditAllowed||t(e,"scheduledEndDate")):!e.scheduledEndDate||e.useTargetDate||t(e,"scheduledEndDate")},this.actualStartDateDisabled=function(e,t,a){return e=e||{},t?"change"===e.type&&!e.accessMappings.actualdateEditAllowed&&!a&&e.isClosed():e.useTargetDate||e.scheduledStartDate||e.scheduledEndDate},this.actualStartTimeDisabled=function(e,t,a){return e=e||{},t?!e.actualStartDate||"change"===e.type&&!a&&e.isClosed()&&!e.accessMappings.actualdateEditAllowed:!e.actualStartDate||e.useTargetDate;
},this.actualEndDateDisabled=function(e,t,a){return e=e||{},t?"change"===e.type&&!e.accessMappings.actualdateEditAllowed&&!a&&e.isClosed():e.useTargetDate||e.scheduledStartDate||e.scheduledEndDate},this.actualEndTimeDisabled=function(e,t,a){return e=e||{},t?!e.actualEndDate||"change"===e.type&&!a&&e.isClosed()&&!e.accessMappings.actualdateEditAllowed:!e.actualEndDate||e.useTargetDate},this.deploymentStartDateDisabled=function(e,a,n){return e=e||{},a?"release"===e.type&&(!e.accessMappings.deploymentdateEditAllowed||t(e,"deploymentStartDate"))&&!n&&e.isClosed():t(e,"deploymentStartDate")},this.deploymentStartTimeDisabled=function(e,a,n){return e=e||{},a?!e.deploymentStartDate||"release"===e.type&&!n&&e.isClosed()&&(!e.accessMappings.deploymentdateEditAllowed||t(e,"deploymentStartDate")):!e.deploymentStartDate||e.useTargetDate||t(e,"deploymentStartDate")},this.deploymentEndDateDisabled=function(e,a,n){return e=e||{},a?"release"===e.type&&(!e.accessMappings.deploymentdateEditAllowed||t(e,"deploymentEndDate"))&&!n&&e.isClosed():t(e,"deploymentEndDate")},this.deploymentEndTimeDisabled=function(e,a,n){return e=e||{},a?!e.deploymentEndDate||"release"===e.type&&!n&&e.isClosed()&&(!e.accessMappings.deploymentdateEditAllowed||t(e,"deploymentEndDate")):!e.deploymentEndDate||e.useTargetDate||t(e,"deploymentEndDate")},this.targetDateDisabled=function(e,a){return e=e||{},a?!e.accessMappings.targetdateEditAllowed||t(e,"targetDate"):!e.useTargetDate},this.targetTimeDisabled=function(e,a){return e=e||{},a?!e.targetDate||!e.accessMappings.targetdateEditAllowed||t(e,"targetDate"):!e.targetDate||!e.useTargetDate}}])}(),function(){angular.module("myitsmApp").directive("editTicketDates",["events","configurationModel","ticketModel","fieldValidationModel","editTicketDatesService",function(e,t,a,n,i){return{restrict:"E",templateUrl:"views/common/edit-ticket-dates.html",replace:!0,scope:{ticket:"=",dateForm:"=",isDraft:"=",updateIsHandledByParent:"=",onlyShowRequired:"=",ignoreAccessMapping:"=",makeScheduleDatesOptional:"=",makeActualDatesOptional:"="},link:function(o){function r(){return y.pendingTicketDatesChange?{scheduledStartDate:g(o.ticket.scheduledStartDate),scheduledEndDate:g(o.ticket.scheduledEndDate),actualStartDate:g(o.ticket.actualStartDate),actualEndDate:g(o.ticket.actualEndDate),targetDate:g(o.ticket.targetDate)}:{}}function s(){h=_.clone({scheduledStartDate:o.ticket.scheduledStartDate,scheduledEndDate:o.ticket.scheduledEndDate,actualStartDate:o.ticket.actualStartDate,actualEndDate:o.ticket.actualEndDate,targetDate:o.ticket.targetDate})}function l(e){return a.update(o.ticket.id,o.ticket.type,e)}function c(){o.updateIsHandledByParent&&!o.isDraft||o.$emit(e.SAVE_CHANGES_COMPLETE),d()}function d(){y.pendingTicketDatesChange=!1}function u(){d()}function p(){s()}function m(){console.log("handleSaveChanges in editTicketDates directive"),o.save()}function f(){o.cancel()}function g(e,t){return t=t?moment(t):moment(e),1e3*moment(e).set("hours",t.get("hours")).set("minutes",t.get("minutes")).format("X")}var h;o.ticket&&s();var y={pendingTicketDatesChange:!1};o.state=y,o.validator=i,o.datePickerOptions={startingDay:t.getWeekStartingDay(),"show-weeks":!1,minDate:moment().year(1970).month(0).date(2),maxDate:moment().year(2038).month(0).date(18)},o.showMeridian=window.showMeridian,o.$watch("ticket",function(e){e&&(o.targetDateEnabled=o.ticket.type===EntityVO.TYPE_CHANGE)}),o.$watch("ticket.timing",function(){o.ticket&&o.ticket.timing&&(o.ticket.scheduledStartDate=o.isFieldDisabled("scheduledStartDate")?null:o.ticket.scheduledStartDate,o.ticket.scheduledEndDate=o.isFieldDisabled("scheduledEndDate")?null:o.ticket.scheduledEndDate)}),o.save=function(){var t=r(),a=o.isDraft,n=!o.updateIsHandledByParent;o.$emit(e.SAVE_CHANGES_REQUEST,t,n||a),_.size(t)?a?c():n&&l(t).then(function(){c()}):c()},o.cancel=function(){o.ticket.scheduledStartDate=h.scheduledStartDate,o.ticket.scheduledEndDate=h.scheduledEndDate,o.ticket.actualStartDate=h.actualStartDate,o.ticket.actualEndDate=h.actualEndDate,o.ticket.targetDate=h.targetDate,o.updateDateTime("actual"),o.updateDateTime("scheduled"),o.updateTargetDate(),c()},o.updateDateTime=function(e){y.pendingTicketDatesChange=!0,i.updateDateTime(o.dateForm,o.ticket,e)},o.updateTargetDate=function(){y.pendingTicketDatesChange=!0,i.updateTargetDateTime(o.dateForm,o.ticket)},o.isFieldRequired=function(e){return o.ticket&&n.isFieldRequired(o.ticket.type,o.ticket.status.value,o.ticket.timing,e)},o.isFieldDisabled=function(e){return o.ticket&&n.isFieldDisabled(o.ticket.type,o.ticket.status.value,o.ticket.timing,e)},o.$on(e.SAVE_CHANGES,m),o.$on(e.TOGGLE_EDIT_MODE,p),o.$on(e.DISCARD_CHANGES,f),o.$on(e.SAVE_ALL_CHANGES_COMPLETE,u)}}}])}(),function(){angular.module("myitsmApp").directive("editableContentSection",function(){return{restrict:"E",replace:!0,transclude:!0,scope:{editModeAllowed:"=",hideEditButton:"=",ticket:"=",editButtonLabel:"="},templateUrl:"views/common/editable-content-section.html",controller:["$element","$transclude","$scope","$timeout","events","ticketModel","assetModel",function(e,t,a,n,i,o,r){function s(){e.find('input[type="text"]').first().focus()}function l(e,t,n,i){f(),I>0&&(t&&_.size(t)&&!n&&(t.customFields?A.customFields=angular.extend(A.customFields||{},t.customFields):angular.extend(A,t)),i||k++,b+=n?0:1,console.log("processed "+k+" events"),k===I&&(console.log("all editable block events processed"),_.size(A)?(console.log("combined changes object:"),console.log(A),A.isAssetUpdate?(delete A.isAssetUpdate,r.update(A).then(c,d)):o.update(a.ticket.id,a.ticket.type,A).then(function(e){e.data&&e.data.error?d(e):c(e)},d)):(console.log("nothing changed or child sections saved themselves, closing edit mode"),c({}))))}function c(e){S.$broadcast(i.SAVE_ALL_CHANGES_COMPLETE,e),u(b)}function d(e){S.$broadcast(i.SAVE_ALL_CHANGES_FAULT,e),p(b)}function u(e){e=angular.isNumber(e)?e:1,g(e)}function p(e){e=angular.isNumber(e)?e:1,g(e)}function m(e){e=angular.isNumber(e)?e:1,D+=e,D>=I&&(a.dataSaving=!1,h())}function f(){a.dataSaving=!0}function g(e){D+=e,D>=I&&(a.dataSaving=!1,h(),T())}function h(){A={},k=0,b=0,D=0}function y(){a.hasRequiredFields=E()}function E(){return e.find("div.editable-content-section__content .required").length}function v(){return e[0].id}function T(){a.editMode=!1,S.editMode=!1,a.dataSaving=!1,a.$emit(i.EDIT_COMPLETE,v())}var S,C,O=[],A={},I=0,b=0,k=0,D=0;a.editMode=!1,a.dataSaving=!1,a.editableContentInvalid=!1,t(function(t,n){S=n,S.handleExternalEditClick=function(){a.onEditButtonClick()},S.$on(i.SAVE_CHANGES_REQUEST,l),S.$on(i.SAVE_CHANGES_COMPLETE,u),S.$on(i.SAVE_CHANGES_FAULT,p),S.$on(i.SAVE_CHANGES_FAULT_CONTINUE,m);var o=e.find("div.editable-content-section__content");o.append(t);var r=o.find("form");r.length&&_.forEach(r,function(e){O.push(e.name)}),I=o.find(".editable-content-section-block").length,C=t}),a.$on(i.DISABLE_EDIT,function(e,t){a.isChildInContent=t}),a.onEditButtonClick=function(){var e=v();h(),S.$broadcast(i.TOGGLE_EDIT_MODE,e),S.$broadcast(i.TOGGLE_DYNAMIC_FIELD_EDIT_MODE,e),a.editMode=!a.editMode,S.editMode=!S.editMode,n(y),n(s,100),a.$emit(i.TOGGLE_EDIT_MODE,e),a.$emit(i.DISABLE_PARENT_EDITMODE,!0),a.$emit(i.DISABLE_CHILD_EDITMODE,!0)},a.onSaveClick=function(){var t=e.find("div.editable-content-section__content");I=t.find(".editable-content-section-block").length,S.$broadcast(i.SAVE_CHANGES),a.$emit(i.DISABLE_PARENT_EDITMODE,!1),a.$emit(i.DISABLE_CHILD_EDITMODE,!1)},a.onCancelClick=function(){S.$broadcast(i.DISCARD_CHANGES),a.$emit(i.DISABLE_PARENT_EDITMODE,!1),a.$emit(i.DISABLE_CHILD_EDITMODE,!1),T()},a.editableContentIsInvalid=function(){var e=!1;if(O&&O.length)try{_.forEach(O,function(t){var a=_.get(S,t)||S[t];e=e||a.$invalid})}catch(t){}return a.editableContentInvalid=e,e},a.$on("$destroy",function(){C.remove(),S.$destroy()}),a.$on(i.CLOSE_EDIT_MODE_ON_STATUS_CLOSED_FROM_BLADE,function(e,t){t&&!t.detailsEditAllowed&&a.onCancelClick()})}]}})}(),function(){angular.module("myitsmApp").factory("elementFocus",["$timeout","$window",function(e,t){return function(a){e(function(){var e=t.document.getElementById(a);e&&e.focus()})}}])}(),function(){angular.module("myitsmApp").directive("embeddedLocationMap",["$state","$timeout","googleMapService","$window",function(e,t,a,n){return{restrict:"AE",replace:!0,template:"<div></div>",scope:{userLocation:"=center",mapOptions:"@options",locationObjects:"="},link:function(e,t){var i=function(e){return Object.prototype.toString.call(e).slice(8,-1)};e.initLocationMap=function(i){i&&(e.mapOptions||(e.mapOptions={}),e.mapOptions.center=i);var o=a.initLocationMapWithUserMarker(t[0],e.mapOptions,i);o.then(function(t){e.locationMap=t.map,e.userMarker=t.marker,e.locationObjects=t,bmcMaps.event.addListener(e.locationMap,"click",function(){var t=a.getDirectionUrl(e.userLocation.address);n.open(t,"_blank")})})},e.geocodingFailed=function(){console.log("Geocoding failed!")},a.isAvailable&&e.$watch("userLocation",function(t){if(t&&!_.isEmpty(t)){var n="String"===i(e.userLocation.address);n?a.getLocationCoordinatesByAdress(e.userLocation.address,e.initLocationMap,e.geocodingFailed):e.initLocationMap()}},!0),e.$on("$destroy",function(){e.locationMap&&bmcMaps.event.clearInstanceListeners(e.locationMap)})}}}])}(),function(){angular.module("myitsmApp").service("favoriteService",["$resource",function(e){var t=e("/smartit/rest/bulkupdate/all",{},{addFavorite:{method:"POST",isArray:!0},removeFavorite:{method:"POST",isArray:!0}}),a=function(e){var t=_.isArray(e)?e:[e];return{ids:_.chain(t).map(function(e){return{uuid:e.id||e.uuid,type:e.type}}).filter(function(e){return e.uuid&&e.type}).value()}};this.addFavorite=function(e){return e=a(e),e.attributeValueMap={favouriteAction:"Add"},t.addFavorite(e).$promise},this.removeFavorite=function(e){return e=a(e),e.attributeValueMap={favouriteAction:"Remove"},t.removeFavorite(e).$promise}}])}(),function(){angular.module("myitsmApp").directive("fieldActionsDropdown",["$filter","screenConfigurationModel","screenConfigurationService","metadataModel","i18nService",function(e,t,a,n,i){return{restrict:"E",scope:{context:"=",action:"=",icon:"=",dropDownOptions:"=",bulkContext:"=",bulkContextType:"@",launchActionCallback:"&"},templateUrl:"views/common/field-action-directive.html",controller:"LaunchActionController",link:function(e){e.checkValidActions=!0,e.init=function(t){t&&t.actionList&&t.actionList.length&&(_.forEach(t.actionList,function(e){e.label=e.labels[i.language]||e.labels["default"]}),"alphabetical"===t.actionOrder?t.actionList=_.sortBy(t.actionList,"label"):t.actionList=_.sortBy(t.actionList,"sequenceNo"),e.actions=t)}}}}])}(),function(){angular.module("myitsmApp").service("fieldValidationModel",["configurationModel",function(e){function t(e){return 1e3*moment(e).format("X")}this.isFieldRequired=function(t,a,n,i){switch(t){case EntityVO.TYPE_CHANGE:var o=e.get("requiredFields.change")[n];return o&&o[a]&&o[a].indexOf(i)!==-1;case EntityVO.TYPE_RELEASE:case EntityVO.TYPE_TASK:case EntityVO.TYPE_INCIDENT:case EntityVO.TYPE_PROBLEM:var r=e.get("requiredFields."+t);return r&&r[a]&&r[a].indexOf(i)!==-1;default:return!1}},this.isFieldDisabled=function(t,a,n,i){switch(t){case EntityVO.TYPE_CHANGE:var o=e.get("disabledFields.change")[n];return o&&o[a]&&o[a].indexOf(i)!==-1;default:return!1}},this.isFutureDateTime=function(e){return!e||t(e)>(new Date).getTime()}}])}(),function(){angular.module("myitsmApp").directive("fileDropTarget",["$filter","$timeout","attachmentService","systemAlertService",function(e,t,a,n){return{restrict:"A",replace:!1,link:function(i,o,r){function s(e){var t=e.originalEvent;e.stopPropagation(),e.preventDefault(),t.dataTransfer.dropEffect="copy",o.addClass("drag-over")}function l(){o.removeClass("drag-over")}function c(r){r.stopPropagation(),r.preventDefault(),o.removeClass("drag-over");var s=r.originalEvent.dataTransfer.files;if(i.attachments&&i.attachments.length===u)return t(function(){d()}),!1;if(i.attachments&&i.attachments.length<u){var l=parseInt(u-i.attachments.length);if(s.length>l)return t(function(){d()}),!1;s&&s.length&&_.each(s,function(t){var o=a.prepareFileToUpload({fileToPrepare:t,droppedFile:!0});return o&&o.size<=0?void n.warning({text:e("i18n")("attachment.file_empty"),icon:"icon-exclamation_triangle",clear:!0,hide:5e3}):void(i.attachments?i.attachments.push(o):angular.noop())})}}function d(){var t=e("i18n")("timeline.note.max.attachments",u);n.error({text:t,clear:!1})}var u=3,p=r.$observe("maxFiles",function(e){e&&!isNaN(e)&&(u=Number(e))});o.on("dragover",s).on("dragleave dragend",l).on("drop",c),i.$on("$destroy",function(){console.log("fileDropTarget: unbind events"),o.off("dragover",s),o.off("dragleave",l),o.off("dragend",l),o.off("drop",c),o.off(),p()})}}}])}(),function(){angular.module("myitsmApp").directive("filterSelectAllControl",function(){return{restrict:"E",replace:!0,templateUrl:"views/common/filter-select-all-control.html",scope:{filtersConfigModel:"=",applyFilter:"&"},link:function(e){e.selectAll=function(t){_.forEach(e.filtersConfigModel,function(e){e.selected=t}),e.applyFilter({data:t})},e.getSelectedFiltersList=function(){return _.filter(e.filtersConfigModel,"selected")}}}})}(),function(){angular.module("myitsmApp").service("characterCalculatorService",function(){this.calculateHtmlInputLength=function(e,t){for(var a=/<(a)[^>]*>([^<]*)<\/\1>|<br\s*\/?>/gi,n="";null!==(n=a.exec(e))&&n.index<=t;)a.lastIndex>t&&(t=n.index);return t}}).filter("characters",["characterCalculatorService",function(e){return function(t,a,n,i){if(t+="",isNaN(a))return t;if(a<=0)return"";n=n||3;var o,r=t;if("workorder"!==i)try{var s=angular.element("<div/>").html(t);t=s.html()}catch(l){t=r}o=e.calculateHtmlInputLength(t,a);var c=t.split("<br>");if(""===_.last(c)&&c.pop(),c.length>n&&(t=c.splice(0,n).join("<br>")+"..."),t&&t.length&&$("<span />").html(t).text().length>a){t=t.substring(0,o);var d=t.lastIndexOf(" ");return d!==-1&&(t=t.substr(0,d)),t+"..."}return t}}]).filter("isTextTruncated",["characterCalculatorService",function(e){return function(e,t,a){var n,i=e.split("<br />"),o=$("<span />").html(e).text().length>(a||140);return t=t||3,""===_.last(i)&&i.pop(),n=i.length>t,o||n}}]).filter("words",function(){return function(e,t){if(isNaN(t))return e;if(t<=0)return"";if(e){var a=e.split(/\s+/);a.length>t&&(e=a.slice(0,t).join(" ")+"...")}return e}}).filter("fileSize",function(){return function(e){if(isNaN(e))return"";var t,a=1024,n=1048576,i=1073741824,o=parseInt(e);return t=o>i?(o/i).toFixed(1)+" GB":o>n?(o/n).toFixed(1)+" MB":o>a?Math.floor(o/a)+" KB":o+" B"}}).filter("humanizeDate",["$filter",function(e){return function(t){return t?e("date")(t,"mediumDate")+" "+e("date")(t,"shortTime"):e("i18n")("common.label.none")}}]).filter("dateFormat",["$filter","configurationModel",function(e,t){return function(t){return t||(t=new Date),e("date")(t,"mediumDate")}}]).filter("humanizedAbsoluteDateFormat",["$rootScope","$filter","configurationModel",function(e,t,a){return function(n){n||(n=new Date);var i;return e.timezone&&(i=moment(n).format("Z")),"relative"===a.dateTimeStyleProperty?moment(n).fromNow():t("date")(n,"mediumDate",i)+" "+t("date")(n,"shortTime",i)}}]).filter("datePreConfigTimezone",["$rootScope","$filter",function(e,t){return function(a,n){if(!a)return null;var i;return e.timezone&&(i=moment(a).format("Z")),t("date")(a,n,i)}}]).filter("milliToTime",["$filter",function(e){return function(t){if(_.isUndefined(t))return"";var a=t/1e3,n=Math.floor(a/3600),i=Math.floor(a%3600/60),o=new Date;return console.log("hours: "+n+", minutes: "+i),o.setHours(n),o.setMinutes(i),o.setSeconds(0),o.setMilliseconds(0),e("date")(o,"shortTime")}}]).filter("humanizeFromNowDate",function(){return function(e){return moment(e).fromNow()}}).filter("localizeLabel",["metadataModel","configurationModel",function(e,t){function a(a,n,i){var o=_.find(t.get("metadata.mapping"),function(e){return e.name===n}),r=o&&_.includes(EntityVO.ALL_METADATA_TYPES,i)?e.cache[i][o.label]:"";if(!_.isEmpty(r)){var s="";if(a){var l=null;l=_.find(r,function(e){return e.name===a}),!l&&e.cache[i]&&e.cache[i].consoleColumns&&(l="statusReason"===n?_.find(e.cache[i].consoleColumns.statusReason,function(e){return e.name===a}):_.find(e.cache[i].consoleColumns.status,function(e){return e.name===a})),l||("statusReason"===n?e.allStatusReasons.length&&(l=_.find(e.allStatusReasons,function(e){return e.name===a})):l=_.find(e.allStatuses,function(e){return e.name===a})),_.isUndefined(l)&&"statusReason"===n&&(l={name:a,label:a}),s=l&&l.label}return s}return"status"!==n?"":(l=_.find(e.allStatuses,function(e){return e.name===a}),!_.isUndefined(l)&&l&&l.label?s=l.label:void 0)}return function(t,n,i){return!e.cache[i]&&_.includes(EntityVO.ALL_METADATA_TYPES,i)?(e.getMetadataByType(i),""):a(t,n,i)}}]).filter("binaryCheck",function(){return function(e){return e?"True":"False"}}).filter("escape",function(){return window.encodeURIComponent}).filter("serializeCategory",function(){return function(e){return _.compact(_.map(e.listOfTiers,function(e){return e.selectedValue})).join(" > ")}}).filter("securelinky",function(){return function(e,t){var a,n;if(e){try{n=!t||t&&"_blank"===t.toLowerCase()?{newWindow:!0}:{newWindow:!1},n.stripPrefix={www:!1,scheme:!1},n.urls={schemeMatches:!0,tldMatches:!0,ipV4Matches:!1},n.sanitizeHtml=!0,n.stripTrailingSlash=!1,n.phone=!1,n.hashtag=!1,n.mention=!1,e=e.replace(/&(?![a-z]{2,6};|#[0-9]{2,6};)/g,"&amp;"),a=Autolinker.link(e,n)}catch(i){console.log(i),a=e}return a.replace("<a",'<a rel="nofollow noopener noreferrer"')}return""}}).filter("htmlencode",function(){return function(e){return e?angular.element("<div/>").text(e).html():""}}).filter("escapeEncodedCharacters",function(){return function(e,t){var a=/(?:&|&#)(\w{2,6});/g;return t?e.replace(a,function(e){var t=e.replace("&","&amp;");return t}):e}}).filter("labelByCount",["$filter","i18nService",function(e,t){return function(a,n){var i="";return isNaN(a)?i=e("i18n")(n+"1",0):(a=parseInt(a),i="pl"==t.language?0===a?e("i18n")(n+"For5To9And0",a):1===a?e("i18n")(n+"For1",a):a>=5&&a<=21?e("i18n")(n+"For5To9And0",a):[2,3,4].indexOf(a%10)!==-1?e("i18n")(n+"For2To4",a):e("i18n")(n+"For5To9And0",a):1===a?e("i18n")(n+"For1",a):e("i18n")(n+"For2To4",a)),i}}])}(),function(){angular.module("myitsmApp").service("followService",["$resource",function(e){var t=e("/smartit/rest/subscription/bulk",{},{follow:{method:"POST",isArray:!0},unfollow:{url:"/smartit/rest/subscription/bulk/delete",method:"POST",isArray:!0}}),a=function(e){var t=_.isArray(e)?e:[e];return _.chain(t).map(function(e){return{uuid:e.id||e.uuid,type:e.type}}).filter(function(e){return e.uuid&&e.type}).value()};this.follow=function(e){return t.follow(a(e)).$promise},this.unfollow=function(e){return t.unfollow(a(e)).$promise}}])}(),function(){angular.module("myitsmApp").directive("getDirections",["googleMapService",function(e){return{restrict:"E",template:'<button ux-id="get-directions" class="profile__get-directions-btn" ng-click="getDirections()">{{"common.button.getDirections" | i18n}}</button>',scope:{destination:"="},link:function(t){t.getDirections=function(){var a=e.getDirectionUrl(t.destination);window.open(a,"_blank")}}}}])}(),function(){angular.module("myitsmApp").factory("googleMapService",["$resource","$rootScope","$q",function(e,t,a){var n,i={isAvailable:angular.mapsAvailable},o=i.isAvailable?{zoom:15,minZoom:15,maxZoom:15,mapTypeId:bmcMaps.MapTypeId.ROADMAP,mapTypeControl:!1,disableDefaultUI:!0,panControl:!1,zoomControl:!1,draggable:!1}:{},r=i.isAvailable?{center:new bmcMaps.LatLng(78.74,(-65.18)),radius:360,zoom:10,draggable:!0,mapTypeId:"floormap",mapTypeControl:!1,disableDefaultUI:!0,panControl:!0,panControlOptions:{position:bmcMaps.ControlPosition.LEFT_BOTTOM},zoomControl:!0,zoomControlOptions:{style:bmcMaps.ZoomControlStyle.LARGE,position:bmcMaps.ControlPosition.LEFT_BOTTOM}}:{},s={};return i.initLocationMapWithUserMarker=function(e,t,n){var o=a.defer(),r=i.initLocationMap(e,t);return bmcMaps.event.addListenerOnce(r,"idle",function(){var e=i.addLocationMarker(r,n);o.resolve({map:r,marker:e})}),o.promise},i.getLocationCoordinatesByAdress=function(e,t,a){var n=e.replace(/(?:\r\n|\r|\n)/g,", ");bmcMaps.geocoder.geocode(n,t,a)},i.initLocationMap=function(e,t){var a=_.extend(o,t);return new bmcMaps.Map(e,a)},i.addLocationMarker=function(e,t){return e.addMarker(t,"styles/img/marker.png")},i.initFloorMap=function(e){return n=a.defer(),s={},s.floormap=new bmcMaps.Map(e.mapContainer,r),bmcMaps.event.addListenerOnce(s.floormap,"idle",function(){s.floormapBounds=i.generateFloorMapType(e.tiles,s.floormap,"","",e.scale)}),n.promise},i.generateFloorMapType=function(e,t,a,n,o){var r=function(){};r.prototype={tileSize:new bmcMaps.Size(LocationVO.GMAP_TILE_SIZE,LocationVO.GMAP_TILE_SIZE),maxZoom:a||LocationVO.GMAP_MAX_ZOOM,minZoom:n||LocationVO.GMAP_MIN_ZOOM,tileBounds:[],getTile:function(t,a,n){var i=parseInt(this.maxZoom-a),r=o?o:LocationVO.SCALE_LEVELS[i],s=e[r][t.x+"_"+t.y]||{},l=n.createElement("div");return l.style.width=this.tileSize.width+"px",l.style.height=this.tileSize.height+"px",l.style.fontSize="10",s.id&&(l.style.backgroundImage="url(data:image/png;base64,"+s.tile+")",l.style.backgroundRepeat="no-repeat"),l.style.backgroundColor="#FFFFFF",l},name:"floormap"};var l=new r;return t.mapTypes.set("floormap",l),s.mapType=l,i.calculateBounds(t,e)},i.calculateBounds=function(e,t,a){var o=e.getZoom(),r=e.mapTypes[e.mapTypeId].maxZoom||100,l=parseInt(r-o),c=a?a:LocationVO.SCALE_LEVELS[l],d=t[c],u=_.minBy(d,function(e){return e.column}).column||0,p=_.maxBy(d,function(e){return e.row}).row||0,m=_.maxBy(d,function(e){return e.column}).column||0,f=_.minBy(d,function(e){return e.row}).row||0,g=d[u+"_"+p],h=d[m+"_"+f],y=e.getProjection(),E=Math.pow(2,o),v=256/E,T=h.column*v+h.width/E,S=h.row*v,C=new bmcMaps.Point(T,S),O=y.fromPointToLatLng(C),A=g.column*v+(256!==g.width?g.width/E:0),I=g.row*v+g.height/E,b=new bmcMaps.Point(A,I),k=y.fromPointToLatLng(b),D=new bmcMaps.LatLngBounds;D.extend(k),D.extend(O);var R=D.getCenter();e.panToBounds(D),e.setCenter(R);var P={tileBounds:D};return s.floormapBounds=P,i.limitFloorMapBounds(e,P),n.resolve(s),P},i.limitFloorMapBounds=function(e,t){var a=e.getCenter(),n=t.tileBounds,i=e.getCenter();e.setCenter(a),bmcMaps.event.addListener(e,"center_changed",function(){var t=e.getCenter();return n.contains(t)?void(i=e.getCenter()):void e.panTo(i)}),e.panToBounds(t.tileBounds)},i.getCurrentScaleLevel=function(e){var t=e.getZoom(),a=e.mapTypes[e.mapTypeId].maxZoom,n=parseInt(a-t);return LocationVO.SCALE_LEVELS[n]||100},i.panAssetOnMap=function(e,t){var a=e.getProjection(),n=e.getZoom(),o=i.getCurrentScaleLevel(e),r=Math.pow(2,n),s=100!==o?parseFloat(t.xPos*o/100)/r:t.xPos/r,l=100!==o?parseFloat(t.yPos*o/100)/r:t.yPos/r,c=new bmcMaps.Point(s,l),d=a.fromPointToLatLng(c),u=$("<div class='poi-location__pin' ng-click='openInfoBubble($event)'/>")[0],p=i.addMarkerOnMap({position:d,map:e,draggable:!1,content:u,data:t,desc:t.desc,name:t.name},t,d);return t.marker=p,t},i.addMarkerOnMap=function(e){e.flat=!0;var t=new bmcMaps.RichMarker(e);return e.map.setCenter(e.position),t},i.fromPointToLatLng=function(e,t,a,n){var i=n.getProjection().fromContainerPixelToLatLng(new bmcMaps.Point(t,a));e.addMarker(i,"styles/img/marker.png")},i.createInfoBubble=function(e,t){var a=new bmcMaps.InfoBubble({content:t,position:e,shadowStyle:0,borderWidth:0,padding:0,backgroundColor:"#fff",borderRadius:4,arrowSize:10,hideCloseButton:!0,arrowPosition:50,minWidth:192,minHeight:52,arrowStyle:0});return a},i.getDirectionUrl=function(e){var t=e.replace(/(?:\r\n|\r|\n)/g,", ");return bmcMaps.getDirectionUrl(t)},i}])}(),function(){angular.module("myitsmApp").directive("preventClickEvent",function(){return function(e,t){function a(e){e.preventDefault(),e.stopPropagation()}function n(e){13===e.which&&(e.preventDefault(),e.stopPropagation())}t.on("click",a),t.on("keydown keypress",n),e.$on("$destroy",function(){console.log("preventClickEvent: unbind events"),t.off("click",a),t.off("keydown",n),t.off("keypress",n)})}}).directive("stopPropagationEvent",function(){return function(e,t){function a(e){e.stopPropagation()}function n(e){13===e.which&&e.stopPropagation()}t.on("click",a),t.on("keydown keypress",n),e.$on("$destroy",function(){console.log("preventClickEvent: unbind events"),t.off("click",a),t.off("keydown",n),t.off("keypress",n)})}}).directive("preventModalClose",function(){return function(e,t){function a(e){27===e.which&&(e.preventDefault(),e.stopPropagation())}t.on("keydown keypress",a),e.$on("$destroy",function(){console.log("preventModalClose: unbind events"),t.off("keydown",a),t.off("keypress",a)})}}).directive("modalPopupMenuClose",["$timeout",function(e){return function(t,a){function n(t){27===t.which&&(t.preventDefault(),t.stopPropagation(),e(function(){angular.element(a.children()[0]).trigger("click")},0,!1))}a.on("keydown keypress",n),t.$on("$destroy",function(){console.log("modalPopupMenuClose: unbind events"),a.off("keydown",n),a.off("keypress",n)})}}]).directive("preventConsoleFilterClose",["events",function(e){return function(t,a){function n(a){a.preventDefault(),a.stopPropagation(),t.$broadcast(e.ASSET_CONSOLE_FILTER_CLICK)}function i(a){13===a.which?(a.preventDefault(),a.stopPropagation(),t.$broadcast(e.ASSET_CONSOLE_FILTER_CLICK)):t.$broadcast(e.ASSET_CONSOLE_FILTER_CLICK,a)}a.on("click",n),a.on("keydown keypress",i),a.on("$destroy",function(){console.log("preventConsoleFilterClose element $destroy event"),a.off("click",n),a.off("keydown",i),a.off("keypress",i)}),t.$on("$destroy",function(){console.log("preventConsoleFilterClose scope $destroy event"),a.off("click",n),a.off("keydown",i),a.off("keypress",i)})}}]).directive("verticalScreenFit",["$window",function(e){return function(t,a,n){if(n.verticalScreenFit){var i=$(e),o="."+n.verticalScreenFit,r=n.verticalScreenOffset||30,s=function(){var e;if(a.is(":visible"))e=a.offset().top;else{var t=a.parents(":visible").first();e=t.offset().top+t.outerHeight()}a.css("max-height",i.outerHeight()-e-r+"px")};s(),i.on("resize"+o,s),a.on("$destroy",function(){i.off("resize"+o,s)}),t.$on("$destroy",function(){i.off("resize"+o,s)})}}}]).directive("formAutofillFix",["$timeout",function(e){return function(t,a,n){function i(e){e.preventDefault(),a.find("input, textarea, select").trigger("input").trigger("change").trigger("keydown").trigger("blur"),t.$apply(n.ngSubmit)}a.prop("method","POST"),n.ngSubmit&&e(function(){a.off("submit").on("submit",i)}),t.$on("$destroy",function(){a.off("submit",i)})}}]).directive("autoFocus",["$timeout",function(e){return{restrict:"A",link:function(t,a){e(function(){a[0].focus()},0)}}}]).directive("setFocus",function(){return{restrict:"A",link:function(e,t,a){e.$watch(a.setFocus,function(e){e===!0&&t[0].focus()})}}}).directive("modalContent",function(){return{restrict:"C",link:function(e,t){function a(e){9===e.which&&(s||l)&&e.preventDefault()}function n(e){9===e.which&&(i=t.find(":tabbable"),o=i[0],r=i[i.length-1],s=e.target===o&&e.shiftKey,l=e.target===r&&!e.shiftKey,s?(e.preventDefault(),r.focus()):l&&(e.preventDefault(),o.focus()))}var i,o,r,s,l;t.on("keyup",a),t.on("keydown",n),e.$on("$destroy",function(){console.log("modalContent: unbind events"),t.off("keyup",a),t.off("keydown",n)})}}}).directive("focusInputOnClear",function(){return{restrict:"A",link:function(e,t){function a(e){13===e.which&&i.focus()}function n(){i.focus()}var i=t.parent().find("input");t.on("keydown keypress",a),t.on("click",n),e.$on("$destroy",function(){console.log("focusInputOnClear: unbind events"),t.off("click",n),t.off("keydown",a),t.off("keypress",a)})}}}).directive("ieActivateByEnter",["$window",function(e){return{restrict:"A",link:function(t,a){function n(e){13===e.which&&a.click()}(e.navigator.userAgent.indexOf("MSIE")>-1||e.navigator.userAgent.indexOf("Trident/7.0")>-1)&&a.on("keydown",n),t.$on("$destroy",function(){console.log("ieActivateByEnter: unbind events"),a.off("keydown",n)})}}}]).directive("uploadFile",[function(){return{restrict:"A",link:function(e,t){function a(e){angular.element(e.target).siblings("#uploadAttachment").trigger("click")}t.bind("click",a),e.$on("$destroy",function(){t.off("click",a)})}}}]).directive("emitLastElement",["events","$timeout",function(e,t){return{restrict:"A",link:function(a){a.$last&&t(function(){a.$emit(e.LAST_REPEATER_ELEMENT)})}}}]).directive("iframeOnload",[function(){return{scope:{callBack:"&iframeOnload"},link:function(e,t,a){t.on("load",function(){return e.callBack()})}}}]).directive("ticketPriorityDisplay",[function(){return{restrict:"A",scope:{priorityValue:"@"},link:function(e,t){var a=["critical","high","medium","low"],n="custom";e.$watch("priorityValue",function(e,i){n=_.includes(a,e.toLowerCase())?e.toLowerCase():"custom",t.removeClass("ticket__priority-display-"+i.toLowerCase()),t.addClass("ticket__priority-display-"+n),"custom"!==n&&t.removeClass("ticket__priority-display-custom")})}}}])}(),function(){angular.module("myitsmApp").controller("HistoryController",["$scope","historyModel",function(e,t){e.historyModel=t,e.clearHistory=function(){t.clearHistory()}}])}(),function(){angular.module("myitsmApp").factory("historyModel",["localStorageService","metadataModel","configurationModel","pwaModel","i18nService",function(e,t,a,n,i){function o(e){var t=_.find(s.historyList,{id:e.id});t?angular.extend(t,e):s.historyList.push(e)}function r(){var e=_.groupBy(s.historyList,"type"),t=a.comaroundEnabled?[Array.prototype.concat(e[EntityVO.TYPE_TICKET]||[],e[EntityVO.TYPE_SBEREQUEST]||[])]:[Array.prototype.concat(e[EntityVO.TYPE_TICKET]||[],e[EntityVO.TYPE_SBEREQUEST]||[]),e[EntityVO.TYPE_KNOWLEDGE]];s.groupedHistoryList=t}var s={historyList:angular.fromJson(sessionStorage.getItem("historyItems"))||[],groupedHistoryList:{},userId:e.get("user.userId")},l=15;return s.historyList=_.filter(s.historyList,{userId:s.userId}),t.getMetadataByType("global").then(function(){r()}),r(),s.addToHistory=function(e,t){var c=(new HistoryVO).build(t);t.type==EntityVO.TYPE_KNOWLEDGE&&(c.isDecisionTree=t.isDecisionTree()),c.userId=s.userId,c.historyItemType=i.getLocalizedString("common.labels."+c.ticketType),n.isPwaEnabled()&&a.get("pwaEnabledTickets.tickets").indexOf(c.ticketType)>=0&&(c.ticketType=c.ticketType+"PV"),o(c),s.historyList.length>l&&s.historyList.shift(),sessionStorage.setItem("historyItems",angular.toJson(s.historyList)),r()},s.clearHistory=function(){s.historyList=[],sessionStorage.removeItem("historyItems")},s}])}(),function(){angular.module("myitsmApp").directive("iconPriorityIndicator",function(){return{restrict:"E",transclude:!0,template:'<div class="icon-priority-indicator"><div ng-transclude></div><div ng-if="priority" class="icon-priority-indicator__priority_{{priority}}"></div></div>',link:function(e,t,a){e.priority=a.priority?a.priority.toLowerCase():""}}})}(),function(){angular.module("myitsmApp").directive("imageToggle",["$compile","$filter",function(e,t){return{restrict:"A",scope:{},link:function(a,n){var i=function(e){e.preventDefault();var a=e.target;"none"!==a.nextSibling.style.display?(a.nextSibling.style.display="none",a.innerText=t("i18n")("knowledge.decisionTree.showImage.label")):(a.nextSibling.style.display="",a.innerText=t("i18n")("knowledge.decisionTree.hideImage.label"))},o=n.attr("src"),r=t("i18n")("knowledge.decisionTree.hideImage.label"),s="<div><a href='#'>"+r+"</a><img src='"+o+"' class='rx-image-toggle__image'/></div>";s=angular.element(s),n=n.replaceWith(s);var l=s.find("a");l.bind("click",i),l=e(l)(a),a.$on("$destroy",function(){l.off("click",i),s=null,l=null})}}}])}(),function(){angular.module("myitsmApp").directive("infinityScroll",function(){return{restrict:"A",replace:!0,scope:{scrollHandler:"&infinityScroll"},link:function(e,t){function a(){var a=navigator.platform.indexOf("Mac")>-1?0:10;t[0].scrollHeight<=t.scrollTop()+t.outerHeight()+a&&e.scrollHandler()}t.off("scroll").on("scroll",a),e.$on("$destroy",function(){t.off("scroll",a)})}}})}(),function(){angular.module("myitsmApp").constant("inputCounterConfig",{
inlineLayout:!1}).controller("inputCounterController",["$scope","$element","$attrs",function(e,t,a){function n(){i.$setViewValue(e.counterValue)}var i={$setViewValue:angular.noop};e.label=angular.isDefined(a.label)?a.label:void 0,e.labelHidden=angular.isDefined(a.labelHidden),e.minValue=angular.isDefined(a.min)?parseInt(a.min,10):void 0,e.maxValue=angular.isDefined(a.max)?parseInt(a.max,10):void 0,e.step=angular.isDefined(a.step)?parseInt(a.step,10):1,e.required=angular.isDefined(a.required),e.placeholder=angular.isDefined(a.placeholder)?a.placeholder:"",e.tabindex=angular.isDefined(a.tabindex)?a.tabindex:0,t.removeAttr("tabindex"),this.init=function(t,a){var o=a.eq(0);i=t,i.$formatters.unshift(function(t){return e.counterValue=t||null,t?t:null}),o.bind("keyup",function(){e.counterValue=parseInt(this.value,10),n()})},e.incrementCounter=function(){angular.isDefined(e.maxValue)?e.counterValue+e.step<=e.maxValue&&(e.counterValue+=e.step,n()):(e.counterValue+=e.step,n())},e.decrementCounter=function(){angular.isDefined(e.minValue)?e.counterValue-e.step>=e.minValue&&(e.counterValue-=e.step,n()):(e.counterValue-=e.step,n())}}]).directive("inputCounter",["inputCounterConfig",function(){return{restrict:"A",require:["inputCounter","?^ngModel"],controller:"inputCounterController",controllerAs:"counter",replace:!0,scope:{onEnter:"&"},templateUrl:"views/common/input-counter.html",link:function(e,t,a,n){var i=n[0],o=n[1];o&&i.init(o,t.find("input"))}}}])}(),function(){angular.module("myitsmApp").directive("timelineItemRenderer",function(){return{restrict:"E",replace:!0,scope:{item:"=",type:"=",parentContext:"=",isUnflagEditAllowed:"=",displayEncodedCharacters:"=",showContext:"&",expandItem:"&",handleLikeClick:"&",handleAttachmentClick:"&",saveNote:"&"},templateUrl:"views/feed/timeline-item-renderer.html",link:function(e){e.isActivityForKA=function(){return e.type===EntityVO.TYPE_KNOWLEDGE}}}}).directive("feedItemRenderer",["$sce",function(e){return{restrict:"E",replace:!0,scope:{item:"=",displayEncodedCharacters:"=",handleAttachmentClick:"&",handleUnpinClick:"&"},templateUrl:"views/feed/feed-item-renderer.html",link:function(t){t.titleRegExp=new RegExp(/.{1,5}/g),t.safeHtml=function(t){return e.trustAsHtml(t)}}}}]).directive("responseItemRenderer",function(){return{restrict:"E",replace:!0,scope:{item:"="},templateUrl:"views/feed/response-item-renderer.html"}}).directive("personTicketRenderer",["$state","events","$window",function(e,t,a){return{restrict:"E",replace:!0,scope:{data:"=",selectedChat:"=",setStyle:"="},templateUrl:"views/person/person-ticket-renderer.html",link:function(n){n.showRelateToChat=n.selectedChat&&"Assigned"===n.selectedChat.status&&(!n.selectedChat.ticket||n.selectedChat.ticket&&!n.selectedChat.ticket.ticketId)&&_.includes(n.selectedChat.allowedTicketTypes,n.data.type)&&(n.data.type===EntityVO.TYPE_INCIDENT||n.data.type===EntityVO.TYPE_WORKORDER),n.showUnRelateToChat=n.selectedChat&&"Assigned"===n.selectedChat.status&&n.selectedChat.ticket&&n.selectedChat.ticket.ticketDisplayId&&n.selectedChat.applicationData&&n.selectedChat.applicationData.ticketAssociationDetails&&n.selectedChat.applicationData.ticketAssociationDetails.displayId&&n.selectedChat.ticket.ticketDisplayId===n.data.displayId,n.showProfileDetails=function(t,i,o){if("href"in o.target)return void(n.selectedChat&&"javascript:void(0)"!==o.target.href&&(o.target.target="_blank"));switch(i){case EntityVO.TYPE_TICKET:if(n.selectedChat){var r=e.href(t.type,{id:t.id});a.open(r,"_blank")}else e.go(t.type,{id:t.id});break;case EntityVO.TYPE_ASSET:e.go(i,{assetId:t.reconciliationId,assetClassId:t.classId});break;case EntityVO.TYPE_KNOWLEDGE:e.go(i,{id:t.uuid})}},n.relateTicketToChat=function(e){n.$emit(t.RELATE_TICKET_TO_CHAT,{chat:n.selectedChat,ticket:e})},n.unrelateTicketToChat=function(e){n.$emit(t.UNRELATE_TICKET_TO_CHAT,{chat:n.selectedChat,ticket:e})}}}}]).directive("personAssetRenderer",["metadataModel",function(e){return{restrict:"E",replace:!0,scope:{data:"="},templateUrl:"views/person/person-asset-renderer.html",link:function(t){t.assetTypeLabel,e.getMetadataByType(EntityVO.TYPE_ASSET).then(function(e){var a=_.find(e.assetTypes,{name:t.data.assetType});t.assetTypeLabel=a.label})}}}]).directive("personSupportGroupRenderer",function(){return{restrict:"E",replace:!0,scope:{data:"="},templateUrl:"views/person/person-support-group-renderer.html"}}).directive("personKnowledgeRenderer",function(){return{restrict:"E",replace:!0,scope:{data:"="},templateUrl:"views/person/person-knowledge-renderer.html"}}).directive("personAssetWithCheckboxRenderer",function(){return{restrict:"E",replace:!0,scope:{data:"=",showItemDetails:"&",selectAssetItem:"&",savedTemplate:"="},templateUrl:"views/person/person-asset-with-checkbox-renderer.html"}}).directive("assetPersonRenderer",function(){return{restrict:"E",replace:!0,scope:{data:"=",isPeopleType:"&",removePeople:"&",showPersonDetails:"&",editModeAllowed:"@"},templateUrl:"views/asset/asset-person-renderer.html",link:function(e){e.displayValue,"supportgroup"===e.data.realObject.reqType?e.displayValue=e.data.realObject.supportGroupName:"organization"===e.data.realObject.reqType?e.displayValue=e.data.realObject.organizationName:"department"===e.data.realObject.reqType?e.displayValue=e.data.realObject.departmentName:"company"===e.data.realObject.reqType?e.displayValue=e.data.realObject.companyContactName:e.displayValue=e.data.realObject.fullName}}})}(),function(){angular.module("myitsmApp").directive("launchActionsDropdown",["$rootScope","$filter","events","screenConfigurationModel","screenConfigurationService","metadataModel","i18nService",function(e,t,a,n,i,o,r){return{restrict:"E",scope:{context:"=",dropDownOptions:"=",bulkContext:"=",bulkContextType:"@",launchActionCallback:"&",hideDropdown:"=?"},templateUrl:"views/common/launch-actions-dropdown.html",controller:"LaunchActionController",link:function(e){var t,a,i=!1;e.checkValidActions=!0,e.hideDropdown=!0;var s=function(t){t&&t.actionList&&t.actionList.length&&(_.forEach(t.actionList,function(e){e.label=e.labels[r.language]||e.labels["default"],e.mappedFields&&0===e.mappedFields.length&&(i=!0)}),"alphabetical"===t.actionOrder?t.actionList=_.sortBy(t.actionList,"label"):t.actionList=_.sortBy(t.actionList,"sequenceNo"),e.actions=t,e.context&&e.context.ticketType===EntityVO.TYPE_ASSET?l(!1):e.bulkContextType===EntityVO.TYPE_ASSET&&l(!0)),(i||e.dropDownOptions&&e.dropDownOptions.actions&&e.dropDownOptions.actions.length)&&(e.hideDropdown=!1)},l=function(t){var n,i,o,r;if(t&&e.bulkContext&&e.bulkContext.length)i=_.uniqBy(_.map(e.bulkContext,"type")),o=_.uniqBy(_.map(e.bulkContext,"classId"));else{if(!e.context||e.context.ticketType!==EntityVO.TYPE_ASSET)return;i=[e.context.type],o=[e.context.classId]}e.actions&&(_.forEach(e.actions.actionList,function(e){return t&&"launch"!==e.actionType?void(e.invalid=!0):(n=e.scope.assetClass.ALL)?void(e.invalid=!n):(n=_.some(i,function(t){return!_.includes(_.keys(e.scope.assetClass),t)}))?void(e.invalid=n):(r=[],_.forIn(e.scope.assetClass,function(t,n){r="ALL"===e.scope.assetClass[n][0]?r.concat(_.map(_.find(a.assetTypes,{name:n}).subType,"name")):r.concat(t)}),n=_.some(o,function(e){return!_.includes(r,e)}),void(e.invalid=n))}),e.checkValidActions=_.some(e.actions.actionList,function(e){return!e.invalid}))};angular.isDefined(e.context)&&(e.context.type||e.context.ticketType)?t=e.context.ticketType&&e.context.ticketType===EntityVO.TYPE_ASSET?e.context.ticketType:e.context.type:e.bulkContextType&&(t=e.bulkContextType),t&&o.getMetadataByType(t).then(function(i){a=i,t===EntityVO.TYPE_INCIDENT||t===EntityVO.TYPE_CHANGE||t===EntityVO.TYPE_WORKORDER||t===EntityVO.TYPE_TASK?n.loadActionsForRuntimeV2(t).then(function(){var a=n.runtimeActionsCache[t];a.actionList=_.reject(a.actionList,function(e){return!_.includes(e.supportedPlatforms,"web")}),_.forEach(a.actionList,function(a){a.invalid=!1,t===e.bulkContextType&&"launch"!==a.actionType&&(a.invalid=!0)}),s(a)}):n.loadActionsForRuntime(t).then(function(){var a=n.runtimeActionsCache[t];a.actionList=_.reject(a.actionList,function(e){return!_.includes(e.supportedPlatforms,"web")}),_.forEach(a.actionList,function(a){a.invalid=!1,t===e.bulkContextType&&"launch"!==a.actionType&&(a.invalid=!0)}),s(a)})}),e.$watch("bulkContext",function(){e.bulkContextType===EntityVO.TYPE_ASSET&&l(!0)},!0)}}}])}(),function(){angular.module("myitsmApp").directive("loadingSpinner",function(){return{restrict:"AE",replace:!0,templateUrl:"views/common/loading-spinner-directive.html",scope:{fixedFullScreen:"@",centered:"@",overlay:"@",inline:"@","if":"=",opaque:"@"}}})}(),function(){angular.module("myitsmApp").factory("metadataModel",["metadataService","$q",function(e,t){function a(e,t){_.forEach(e,function(e){e.statusReasons&&e.statusReasons.length&&n.allStatusReasons.push(e.statusReasons)}),n.cache[t]&&n.cache[t].consoleColumns&&n.cache[t].consoleColumns.statusReason&&n.cache[t].consoleColumns.statusReason.length&&n.allStatusReasons.push(n.cache[t].consoleColumns.statusReason),n.allStatusReasons=_.uniqBy(_.flattenDeep(n.allStatusReasons),"name")}var n={cache:{},allStatuses:[],allStatusReasons:[]};return n.getMetadataByType=function(i){if(n.cache[i]){var o=_.has(n.cache[i],"$$state.status");return t.when(o?n.cache[i]:angular.copy(n.cache[i])).then(function(e){return Array.isArray(e)?_.find(e,{metadatatype:i}):e})}return n.cache[i]=e.getMetadataByType(i).then(function(e){return n.cache[i]=e[0],e[0]&&e[0].statuses&&(a(e[0].statuses,i),n.allStatuses=_.uniqBy(n.allStatuses.concat(e[0].statuses),"name")),angular.copy(n.cache[i])}),n.cache[i]},n.getMetadataByTypes=function(i){var o=[],r=[],s=[];if(_.forEach(i,function(e){n.cache[e]?_.has(n.cache[e],"$$state.status")?r.push(n.cache[e]):s.push(angular.copy(n.cache[e])):o.push(e)}),!o.length&&!r.length)return t.when(s);if(o.length){var l=e.getMetadataByType(o);r.push(l),_.forEach(o,function(e){n.cache[e]=l})}return t.all(r).then(function(e){return _.forEach(e,function(e){function t(e){n.cache[e.metadatatype]=e,a(e.statuses,e.metadatatype),n.allStatuses=_.uniqBy(n.allStatuses.concat(e.statuses),"name")}Array.isArray(e)?_.forEach(e,t):t(e)}),s=[],_.forEach(i,function(e){s.push(n.cache[e])}),s})},n.getPersonMetadata=function(t){return n.cache[t]=e.getPersonMetadata().then(function(e){return n.cache[t]=e[0],angular.copy(n.cache[t])}),n.cache[t]},n}])}(),function(){angular.module("myitsmApp").service("metadataService",["$resource",function(e){var t=e("/smartit/rest/v2/metadata/",{},{getMetadataByType:{method:"GET",isArray:!0}}),a=e("/smartit/rest/v2/metadata/person",{},{getPersonMetadata:{method:"GET",isArray:!0}});this.getMetadataByType=function(e){return t.getMetadataByType({type:e}).$promise.then(function(e){return _.map(e[0].items[0],function(e){return(new MetadataVO).build(e)})})},this.getPersonMetadata=function(){return a.getPersonMetadata().$promise.then(function(e){return _.map(e[0].items,function(e){return(new MetadataVO).build(e)})})}}])}(),function(){angular.module("myitsmApp").service("mobileClientCheckerService",["$location","localStorageService","systemAlertService","$filter",function(e,t,a,n){this.checkForMobileDevice=function(){if(navigator.userAgent.match(/iPhone|iPad|iPod|Android/i)){var i="smart-it://"+e.path().substr(1);if(t.get("launchFromNative")&&(window.location=i),!t.get("userHasPickedlaunchFrom")){var o=a.modal({title:n("i18n")("common.notification.mobile.title"),text:n("i18n")("common.notification.mobile.message"),buttons:[{text:n("i18n")("common.labels.yes"),data:!0},{text:n("i18n")("common.labels.no"),data:!1}]});o.result.then(function(e){t.set("launchFromNative",e),e&&(window.location=i)})["finally"](function(){t.set("userHasPickedlaunchFrom",!0)})}}}}])}(),function(){angular.module("myitsmApp").directive("nestedDropdown",["events",function(e){return{restrict:"E",replace:!0,templateUrl:"views/common/nested-dropdown.html",scope:{dropdownOptions:"=",selectedOption:"="},link:function(t){t.isOpen=!1,t.toggleMode=!1,t.toggleDropdown=function(){t.toggleMode=!0,t.isOpen=!t.isOpen},t.selectOption=function(e){t.selectedOption=e,t.isOpen=!1},t.$on(e.ASSET_CONSOLE_FILTER_CLICK,function(e,a){a?t.isOpen&&(40===a.which?$(a.target).next()[0].focus():38===a.which&&$(a.target).prev()[0].focus()):t.toggleMode?t.toggleMode=!1:t.$apply(function(){t.isOpen=!1})})}}}])}(),function(){angular.module("myitsmApp").directive("ngEnter",function(){return function(e,t,a){function n(n){13!==n.which||t.prop("readonly")||(e.$apply(function(){e.$eval(a.ngEnter,{$event:n})}),n.preventDefault(),n.stopPropagation())}t.on("keydown",n),e.$on("$destroy",function(){console.log("ngEnter: unbind events"),t.off("keydown",n),t.off()})}})}(),function(){angular.module("myitsmApp").directive("ngMax",function(){return{restrict:"A",require:"ngModel",link:function(e,t,a,n){e.$watch(a.ngMax,function(){n.$setViewValue(n.$viewValue)});var i=function(t){var i=e.$eval(a.ngMax)||1/0;return!_.isEmpty(t)&&t>i?void n.$setValidity("ngMax",!1):(n.$setValidity("ngMax",!0),t)};n.$parsers.push(i),n.$formatters.push(i)}}})}(),function(){angular.module("myitsmApp").directive("ngMin",function(){return{restrict:"A",require:"ngModel",link:function(e,t,a,n){e.$watch(a.ngMin,function(){n.$setViewValue(n.$viewValue)});var i=function(t){var i=e.$eval(a.ngMin)||0;return!_.isEmpty(t)&&t<i?void n.$setValidity("ngMin",!1):(n.$setValidity("ngMin",!0),t)};n.$parsers.push(i),n.$formatters.push(i)}}})}(),function(){angular.module("myitsmApp").directive("ngRepeatLoaded",["$timeout",function(e){return{restrict:"A",link:function(t){t.filterConfig&&t.normalizedFilterConfig&&t.filterConfig[t.$index].name===t.normalizedFilterConfig[t.normalizedFilterConfig.length-1].name&&e(function(){t.state.processing=!1})}}}])}(),function(){angular.module("myitsmApp").service("openMailClientService",[function(){this.openMailClient=function(e,t,a){var n=(_.isArray(e)?e:[e]).join("; "),i={to:n,subject:t,body:a?a:""};_.forEach(i,function(e,t,a){a[t]=encodeURIComponent(e)});var o="mailto:"+i.to+"?subject="+i.subject+"&body="+i.body;window.location.href=o}}])}(),function(){angular.module("myitsmApp").directive("personMenu",["$http","$templateCache","$parse","$compile","$timeout","systemAlertService","chatModel","$state","ticketModel",function(e,t,a,n,i,o,r,s,l){return{restrict:"A",priority:99,replace:!1,link:function(c,d){function u(e){var t,a=angular.element(e.target||e.currentTarget),o=a.data("$isolateScope");if(o&&(t=o.userInfo),t&&!e.ctrlKey&&!e.shiftKey){e.preventDefault(),e.stopPropagation();var s=r.cachedProfiles[t.jid];s||(s=_.find(_.values(r.cachedProfiles),function(e){return e.id===t.id&&e.loginId===t.loginId}),t.jid=s?s.jid:t.jid),c.avatarMenu.menuContext=t,c.userIsOnline=!!t.jid&&(s&&s.available===EntityVO.CHAT_STATUS_ONLINE),c.avatarMenu.actionsList[1].disabledAction=!c.userIsOnline,c.avatarMenu.actionsList[1].hiddenAction=!r.connected,c.avatarMenu.isActive=!0,h||(h=n(f)(c)),i(function(){h.insertAfter(a),g=a[0]})}}function p(e){e.target!==g&&i(function(){c.avatarMenu.isActive=!1})}function m(){var e=s.current.name,t={};if(e===EntityVO.TYPE_PERSON){var a=c.person.jid,n=r.currentUser.loginId===(c.person.loginId||c.person.elementId);if(a&&!n)r.createChatRoom(a);else{var l=n?"self":c.person.fullName,d="Can't start conversation with "+l;i(function(){o.warning({text:d,icon:"icon-comments",clear:!0,hide:1e4})})}return!0}return t=e===EntityVO.TYPE_ASSET?{type:e,ticketType:e,id:s.params.assetId,reconciliationId:s.params.assetId,classId:s.params.assetClassId}:{type:e,id:s.params.id},r.createAssignedChatRoom(t),!0}var f,g,h;if(c.userIsOnline=!1,c.avatarMenu={isActive:!1,originalTemplate:f,actionsList:[{name:"viewProfile",label:"person.avatarMenu.viewProfile.label",disabledAction:!1,iconClass:"icon-user_o",hiddenAction:!1},{name:"startChat",label:"person.avatarMenu.startChat.label",disabledAction:!1,iconClass:"icon-comments",hiddenAction:!1,genericText:'fullName || (firstName+" "+lastName)'},{name:"sendEmail",label:"",disabledAction:!0,iconClass:"icon-envelope",hiddenAction:!0},{name:"makeCall",label:"",disabledAction:!0,iconClass:"icon-phone",hiddenAction:!0}]},!f){var y=t.get("views/person/person-avatar-menu.html");y?f=angular.element(y):e.get("views/person/person-avatar-menu.html").then(function(e){if(e&&e.data){var t=e.data;f=angular.element(t)}})["catch"](function(e){var a=t.get("views/person/person-avatar-menu.html");f=angular.element(a)})}c.checkUserStatus=function(){return!!c.avatarMenu.menuContext.available&&c.avatarMenu.menuContext.available===EntityVO.CHAT_STATUS_ONLINE},c.getGenericText=function(e){var t=a(e);return t(c.avatarMenu.menuContext)},c.performAction=function(e){if("startChat"===e.name){var t=l.cache[s.params.id];c.personMenuContext&&(t={type:c.personMenuContext.type,id:c.personMenuContext.id});var a=c.avatarMenu.menuContext.jid;r.createAssignedChatRoomWithUser(a,t)["catch"](function(e){throw e})}},d.on("click",".chat-availability__holder",u),d.on("click",".profile-action-bar__item-menu_start-chat",m),angular.element("body").on("click",p),c.$on("$destroy",function(){console.log("personAvatar: unbind events"),d.off("click",u),d.off("click",m),angular.element("body").off("click",p),g=null})}}}])}(),function(){angular.module("myitsmApp").directive("placeholder",["$compile",function(e){return{restrict:"A",link:function(t,a,n){function i(){a.focus(),a.click()}if(("input"===a[0].nodeName.toLowerCase()||"textarea"===a[0].nodeName.toLowerCase())&&!n.bsDatepicker&&!n.bsTimepicker&&n.ngModel&&_.isUndefined(a[0].placeholder)){var o=t.$new(!0,t);o.inputClass=n["class"],o.inputPlaceholder=n.placeholder,t.$watch(n.ngModel,function(e){o.inputNgModel="false"===n.typeaheadEditable?a[0].value:e}),t.$watch(n.ngHide,function(e){o.inputNgHide=e});var r=angular.element('<span prevent-click-event class="ie-placeholder {{inputClass}}">{{inputPlaceholder}}</span>');a[0].parentNode.insertBefore(r[0],a[0]),n.ngHide?r.attr("ng-hide","inputNgModel || inputNgHide"):r.attr("ng-show","!inputNgModel"),r.on("click",i),t.$on("$destroy",function(){console.log("placeholder: unbind events"),r.off("click",i),r=null}),e(r)(o)}}}}])}(),function(){angular.module("myitsmApp").directive("potentiallyRequiredField",["metadataModel","$timeout","$filter",function(e,t,a){return{restrict:"A",require:"?ngModel",link:function(n,i,o,r){if(angular.isDefined(n[o.entity])){var s,l,c=!1,d=i.prop("tagName");n[o.entity].ticketType===EntityVO.TYPE_ASSET?(s=EntityVO.TYPE_ASSET,n[o.entity].assetUpdateFields&&(l=o.fieldName.split(".")[2],c=n[o.entity].assetUpdateFields[l])):s=n[o.entity].type,_.includes([EntityVO.TYPE_INCIDENT,EntityVO.TYPE_CHANGE,EntityVO.TYPE_WORKORDER,EntityVO.TYPE_TASK],s)?o.itsmRequired&&"true"===o.itsmRequired&&("INPUT"===d||"TEXTAREA"===d?(i.prop("required",!0),i.attr("aria-required","true"),r.$isEmpty(r.$viewValue)?r.$setValidity("required",!1):r.$setValidity("required",!0),r.$parsers.unshift(function(e){return r.$setValidity("required",!!e),e}),r.$formatters.unshift(function(e){return t(function(){r.$setValidity("required",!!e)},0),e})):(i.attr("data-required",a("i18n")("common.label.required.bracketed")),i.addClass("required__label"))):e.getMetadataByType(s).then(function(e){if(s===EntityVO.TYPE_ASSET&&"site.name"===o.fieldName)var n=["site.name","site.siteGroup","site.region"],l=_.some(n,function(t){return _.includes(e&&e.requiredOOTBObjectName,t)});(_.includes(e&&e.requiredOOTBObjectName,o.fieldName)||c||l)&&("INPUT"===d||"TEXTAREA"===d?(i.prop("required",!0),i.attr("aria-required","true"),r.$isEmpty(r.$viewValue)?r.$setValidity("required",!1):r.$setValidity("required",!0),r.$parsers.unshift(function(e){return r.$setValidity("required",!!e),e}),r.$formatters.unshift(function(e){return t(function(){r.$setValidity("required",!!e)},0),e})):(i.attr("data-required",a("i18n")("common.label.required.bracketed")),i.addClass("required__label")))}),(n.data&&n.data.isRequired||n.summaryField&&n.summaryField.isRequired)&&(i.prop("required",!0),i.attr("aria-required","true"))}}}}])}(),function(){angular.module("myitsmApp").controller("PrintController",["$modalInstance","$scope","params","$state","assetModel","googleMapService","configurationModel","collisionModel","personModel","relationModel","relationService",function(e,t,a,n,i,o,r,s,l,c,d){function u(e){var t=[],a={};return _.forEach(e,function(e){var n=_.cloneDeep(e);return e.alternateApprover?void(a[n.signatureId]?a[n.signatureId].approvedFor.push(n.approver.fullName):(n.approvedFor=[n.approver.fullName],n.approver=n.alternateApprover,a[n.signatureId]=n)):void t.push(n)}),t.concat(_.values(a))}t.isFullVersion=!0,t.entity=angular.copy(a.entity),t.metadata=a.metadata,t.screenLayout=a.screenLayout,t.customFieldsAvailable=!!a.customFieldsAvailable&&a.customFieldsAvailable,t.type=a.entity.ticketType?a.entity.ticketType:a.entity.type,t.feed=angular.copy(a.feed),t.knowledgeAnchorParser=a.knowledgeAnchorParser,t.customFields=!_.isEmpty(t.entity.customFields),t.attachments=t.entity.attachments,t.relationCounters={};var p=c.cache;switch(t.relationCounters.tasks=d.getRelatedTasks(p[t.entity.id]).length,t.relationCounters.linkedItems=d.getRelatedLinkedItems(p[t.entity.id],t.entity,!1).length,t.relationCounters.CIs=d.getRelatedCIs(p[t.entity.id]).length,_.forEach(t.feed,function(e){e.expanded=!0}),t.assetFlattenRelations=i.flattenRelations,t.assetOwner=i.assetOwner,t.assetOwnerNoAccess=!_.isEmpty(t.assetOwner)&&!t.assetOwner.loginId,t.googleMapAvailable=o.isAvailable,t.asset=a.entity,t.assetPeopleRelations=i.assetPeopleRelations,t.kcsAssessMode=n.params.assessMode,t.profileType=n.current.name,t.type===EntityVO.TYPE_TASK&&(t.isParentAppEnabled=r.isServerApplicationEnabled(t.entity.parentName)),t.type===EntityVO.TYPE_CHANGE&&s.getListOfCollisionsById(t.entity,!1).then(function(e){e.totalUnaddressedCount>0?(t.collisions=e,t.hasCollisions=!0):t.hasCollisions=!1}),t.toggle=function(){t.visible=!t.visible},t.personOpenTickets=l.personOpenTickets.ticketList,t.personOpenTicketsTotalMatches=l.personOpenTickets.totalMatches,t.personAssignedTickets=l.personAssignedTickets.ticketList,t.personAssignedTicketsTotalMatches=l.personAssignedTickets.totalMatches,t.personOpenSBETickets=l.personOpenServiceBrokerTickets.ticketList,t.personOpenSBETicketsTotalMatches=l.personOpenServiceBrokerTickets.totalMatches,t.personAllTickets=l.personAllTickets.ticketList,t.personAllTicketsTotalMatches=l.personAllTickets.totalMatches,t.personAssetList=l.personAssets,t.personSupportGroups=l.personDetails.supportGroups,t.personKnowledgeArticles=l.personKnowledgeArticles,t.type===EntityVO.TYPE_SERVICEREQUEST&&(_.forEach(t.entity.approvalSummaries,function(e){e.status.name=e.status.value?e.status.value.split(" ").join("_").toLowerCase():""}),t.entity.approvalList&&(t.entity.approvalList.closed&&(t.entity.approvalList.closed=u(t.entity.approvalList.closed)),t.entity.approvalList.rejected&&(t.entity.approvalList.rejected=u(t.entity.approvalList.rejected)))),t.printItem=function(){e.close()},t.buildSiteTag=function(e){var t=e.siteGroup?" > "+e.siteGroup:"",a=e.name?" > "+e.name:"",n=e.region?e.region:"";return n+t+a},t.type){case EntityVO.TYPE_INCIDENT:t.ticketDetailsScreen="incidentDetailsScreen";break;case EntityVO.TYPE_WORKORDER:t.ticketDetailsScreen="workOrderDetailsScreen";break;case EntityVO.TYPE_TASK:t.ticketDetailsScreen="taskDetailsScreen";break;case EntityVO.TYPE_PERSON:t.ticketDetailsScreen="personDetailsScreen";break;case EntityVO.TYPE_CHANGE:t.ticketDetailsScreen="changeRequestScreen";break;case EntityVO.TYPE_PROBLEM:t.ticketDetailsScreen="problemScreen";break;case EntityVO.TYPE_KNOWNERROR:t.ticketDetailsScreen="knownErrorScreen";break;case EntityVO.TYPE_ASSET:t.ticketDetailsScreen="assetScreen"}}])}(),function(){angular.module("myitsmApp").directive("printElement",[function(){return{scope:{printElementId:"@",entity:"="},link:function(e,t){function a(e){if(r.append(e),s=u.html(),u.html(c),window.matchMedia){var t=window.matchMedia("print");t.addListener(n)}window.onbeforeprint=function(){$("body").css({height:0});var e=$("body").find(".modal");e&&e.css({height:0}),console.log("onbeforeprint fired")},window.print(),l.append(e),$("body").css({height:""}),t&&t.removeListener(n),u.html(s)}function n(e){if(e.matches){$("body").css({height:0});var t=$("body").find(".modal");t&&t.css({height:0})}}function i(){o=$(e.printElementId),l=o.parent(),o.length&&a(o)}var o,r,s,l,c="",d=".print-section",u=$("title");r=$(d),r.length||(r=$('<div class="print-section"></div>'),$("body").append(r)),e.entity.type===EntityVO.TYPE_KNOWLEDGE&&(c=e.entity.articleId),t.on("click",i),e.$on("$destroy",function(){console.log("printElement: unbind events"),t.off("click",i),t.off(),u=null,r=null,s=null})}}}])}(),function(){angular.module("myitsmApp").directive("priorityEditor",["metadataModel","ticketModel","events","systemAlertService","$filter",function(e,t,a,n,i){return{restrict:"E",replace:!0,templateUrl:"views/common/priority-editor.html",scope:{ticket:"=",updateIsHandledByParent:"@"},link:function(o){function r(e){e||n.error({text:i("i18n")("create.change.wizard.basicDetails.priority.warning"),hide:1e4})}function s(){o.editMode=!0,o.updatedInfo={priority:_.find(o.metadata.priorities,function(e){return e.name===o.ticket.priority})||{name:o.ticket.priority},impact:_.find(o.metadata.impacts,function(e){return e.name===o.ticket.impact}),urgency:_.find(o.metadata.urgencies,function(e){return e.name===o.ticket.urgency})}}function l(e,t){_.isEmpty(t)||(o.ticket.impact=t.impact,o.ticket.urgency=t.urgency,o.ticket.priority=t.priority),c()}function c(){o.state.isCalculating=!1,o.editMode=!1}function d(){if(o.updateIsHandledByParent){var e=u();o.$emit(a.SAVE_CHANGES_REQUEST,e)}}function u(){var e={};return o.ticket.impact!==o.updatedInfo.impact.name&&(e.impact=o.updatedInfo.impact.name),o.ticket.urgency!==o.updatedInfo.urgency.name&&(e.urgency=o.updatedInfo.urgency.name),o.ticket.priority!==o.updatedInfo.priority.name&&(e.priority=o.updatedInfo.priority.name),e}o.state={isCalculating:!1},e.getMetadataByType(o.ticket.type).then(function(e){o.metadata=e}),o.updatePriority=function(){o.state.isCalculating=!0,o.ticket.type===EntityVO.TYPE_CHANGE?t.getChangePriority(o.ticket.company.name,o.updatedInfo.impact.name,o.updatedInfo.urgency.name).then(function(e){o.updatedInfo.priority=_.find(o.metadata.priorities,{name:e}),o.state.isCalculating=!1,r(o.updatedInfo.priority)}):t.getPriority(o.ticket.company.name,o.updatedInfo.impact.name,o.updatedInfo.urgency.name,o.ticket.type).then(function(e){o.updatedInfo.priority=_.find(o.metadata.priorities,{name:e}),o.state.isCalculating=!1,r(o.updatedInfo.priority)})},o.$on(a.SAVE_CHANGES,d),o.$on(a.TOGGLE_EDIT_MODE,s),o.$on(a.SAVE_ALL_CHANGES_COMPLETE,l),o.$on(a.SAVE_CHANGES_COMPLETE,c),o.$on(a.DISCARD_CHANGES,c)}}}])}(),function(){angular.module("myitsmApp").directive("progressModal",function(){return{restrict:"AE",replace:!0,templateUrl:"views/common/progress-modal-directive.html",scope:{title:"@",text:"@",launchNew:"@","if":"="},controller:["$scope",function(e){e.launchNewWindow=function(){window.open("#/")}}]}})}(),function(){angular.module("myitsmApp").directive("questionsList",[function(){return{restrict:"E",scope:{list:"=",actionBtnClick:"=",listContext:"@",duplicateArticlesList:"="},templateUrl:"views/common/questions-list.html",link:function(e){e.setCurrentContext=function(t){var a={currentContext:t};e.actionBtnClick(t.actionType,a)},e.setAnswer=function(t,a){a.desirableAnswer=t,t||"CHECK_DUPLICATE"!==a.actionType||e.actionBtnClick("REMOVE_DUPLICATES")}}}}])}(),function(){angular.module("myitsmApp").directive("relatedItem",["configurationModel",function(e){return{restrict:"E",replace:!0,templateUrl:"views/common/related-item.html",scope:{item:"=",removeAllowed:"=",showDetails:"&",removeItem:"&"},link:function(t){t.isAppEnabled=e.isServerApplicationEnabled(t.item.type)}}}])}(),function(){angular.module("myitsmApp").directive("relatedItemList",["ticketModel","relationModel","relationService","$filter","configurationModel","$state","$modal","systemAlertService","events","roles","permissionModel","ciExplorerModel","metadataModel","pwaModel",function(e,t,a,n,i,o,r,s,l,c,d,u,p,m){return{restrict:"E",replace:!0,templateUrl:"views/common/related-item-list.html",scope:{dependency:"@",context:"=",isDraft:"=",relationCounters:"="},link:function(f){function g(e){o.go(e,{assetId:f.context.reconciliationId,assetClassId:f.context.classId})}function h(e,a){f.getContextType()===EntityVO.TYPE_CHANGE&&a&&a.event===l.AFFECTED_SERVICE_UPDATE_SAVED?"change-to-cis"===f.dependency&&(delete t.cache[f.context.reconciliationId],f.factory.refresh()):(delete t.cache[f.context.reconciliationId],f.factory.refresh())}var y,E,v="parent",T="child",S="impact",C=!1,O=p.getMetadataByType(EntityVO.TYPE_GLOBAL);f.relatedItems=[],f.ciExplorerModel=u,y=f.$watch("relatedItems",function(){f.relatedItems.length&&f.relatedItems.length>0?f.relatedItemGroups=e.groupRelatedItems(f.relatedItems):f.relatedItemGroups=[],f.relationCounters&&(f.relationCounters.linkedItems=f.relatedItems.length)}),f.state={loadingRelatedItems:!1},f.getContextType=function(){return f.context.ticketType||f.context.type},f.factory=function(){var o={addAllowed:f.context.accessMappings.relationsEditAllowed,removeAllowed:f.getContextType()===EntityVO.TYPE_INCIDENT?f.context.accessMappings.relationsDeleteAllowed:f.context.accessMappings.relationsEditAllowed,createRelationAllowed:f.context.accessMappings.relationsEditAllowed&&_.includes([EntityVO.TYPE_INCIDENT,EntityVO.TYPE_WORKORDER,EntityVO.TYPE_CHANGE,EntityVO.TYPE_PROBLEM,EntityVO.TYPE_KNOWNERROR,EntityVO.TYPE_ASSET],f.context.ticketType||f.context.type)},r=f.context.id,s=f.getContextType();switch(f.dependency){case"asset-to-tickets":f.filterConfig=n("filter")(i.get("asset.filter"),{type:"ticketTypes"}),f.filterTypes=_.map(f.filterConfig,"name");var c=f.context.reconciliationId;o.backdrop="custom",o.load=function(){f.state.loadingRelatedItems=!0,t.getRelations(c,s).then(function(e){f.relatedItems=_.chain(e).reject({type:EntityVO.TYPE_ASSET}).filter(function(e){return e.type===EntityVO.TYPE_TASK||e.tag===RelationItemVO.TAG_LINKEDITEM}).filter(function(e){return!f.filterTypes.length||_.includes(f.filterTypes,e.type)}).value()})["finally"](function(){f.state.loadingRelatedItems=!1})},o.refresh=function(){o.load()},o.remove=function(e){var a={parentType:f.getContextType(),parentId:c},n={id:e.id,type:e.type,tag:e.tag,relationshipType:e.relationshipType};return t.removeRelation(a,[n]).then(function(){f.relatedItems=_.reject(f.relatedItems,function(t){return t===e})})},o.applyFilter=function(e){e.selected=!e.selected,e.selected?f.filterTypes.push(e.name):f.filterTypes.splice(f.filterTypes.indexOf(e.name),1),delete t.cache[c],f.factory.load()},o.selectAllFilters=function(e,a){f.filterTypes=[],e&&(f.filterTypes=_.map(f.filterConfig,"name")),_.forEach(f.filterConfig,function(t){t.selected=e}),a||(delete t.cache[c],f.factory.load())},o.cleanUp=function(){};break;case"asset-to-assets":o.addAllowed=f.context.accessMappings.assetrelationsEditAllowed,o.removeAllowed=f.context.accessMappings.assetrelationsEditAllowed,o.createRelationAllowed=f.context.accessMappings.assetrelationsEditAllowed;var d=[];c=f.context.reconciliationId,f.filterConfig=n("filter")(i.get("asset.filter"),{type:"assetTypes"});var u=f.$on("new-relations",function(){delete t.cache[c],f.factory.refresh()});o.load=function(){f.state.loadingRelatedItems=!0,t.getRelations(c,s).then(function(e){f.relatedItems=_.chain(e).filter({type:EntityVO.TYPE_ASSET}).filter(function(e){if(d.length){var t=[];return e.realObject.isParent&&t.push(v),e.realObject.isChild&&t.push(T),e.realObject.hasImpact&&t.push(S),_.intersection(d,t).length>0}return!0}).value()})["finally"](function(){f.state.loadingRelatedItems=!1})},o.refresh=function(){o.load()},o.remove=function(e){var a={parentType:f.getContextType(),parentId:f.context.reconciliationId},n={type:e.type,desc:"COMPONENT",relationshipType:e.relationshipClassId,parentId:f.context.instanceId,
id:e.realObject.instanceId};return e.realObject.isParent&&(n.parentId=e.realObject.instanceId,n.id=f.context.instanceId,n.isParent=!0),t.removeRelation(a,[n]).then(function(){f.factory.refresh()})},o.applyFilter=function(e){e.selected=!e.selected,e.selected?d.push(e.name):d.splice(d.indexOf(e.name),1),f.factory.load()},o.selectAllFilters=function(e,t){d=e?[v,T,S]:[],_.forEach(f.filterConfig,function(t){t.selected=e}),t||f.factory.load()},o.cleanUp=function(){u()};break;case"change-to-cis":case"ticket-to-all":var p=angular.noop;f.relations=t.cache,o.load=function(){r&&!f.isDraft&&(f.state.loadingRelatedItems=!0,t.getRelations(r,s)["finally"](function(){f.state.loadingRelatedItems=!1}))},o.backdrop="custom",o.refresh=function(){return f.state.loadingRelatedItems=!0,t.refreshRelations(r,s)["finally"](function(){f.$emit(l.RELATIONS_UPDATE_COMPLETE,!1),f.state.loadingRelatedItems=!1})},o.remove=function(n){var o={parentType:f.context.type,parentId:f.context.id},c={id:n.id,type:n.type,relationshipType:n.relationshipType};return n.type===EntityVO.TYPE_OUTAGE&&(c.id=n.displayId),f.relations.relationsRefreshInProgress=!0,a.removeRelation(o,[c]).then(function(){f.relations[f.context.id].splice(_.findIndex(f.relations[f.context.id],{id:n.id}),1),n.relationshipType!==EntityVO.TYPE_ORIGINALOF||_.filter(f.relations[f.context.id],{relationshipType:EntityVO.TYPE_ORIGINALOF}).length||(f.context.accessMappings.duplicateActionAllowed=!0),"change-to-cis"===f.dependency&&f.$emit(l.LINKED_CI_SAVE_COMPLETE),t.refreshRelations(r,s)["finally"](function(){f.$emit(l.RELATIONS_UPDATE_COMPLETE,!1),i.showARMessageOnGetEntry&&n.type&&n.type===EntityVO.TYPE_ASSET&&e.getARMessageInformation(r,s),f.relations.relationsRefreshInProgress=!1})})},o.applyFilter=function(){},o.selectAllFilters=function(){},o.cleanUp=function(){p()},"change-to-cis"===f.dependency&&(o.addTemplateUrl="views/ticket/link-CI-action-blade.html",o.addController="LinkCIController",o.addClass="profile-relation__tab-ciRelations-modal",o.backdrop=!1,o.keyboard=!1,p=f.$watch("relations",function(){f.relatedItems=_.filter(angular.copy(f.relations[r]),{type:EntityVO.TYPE_ASSET})||[],O.then(function(e){e.configurationParameters&&e.configurationParameters.affectedServiceRelation&&"false"===e.configurationParameters.affectedServiceRelation&&(f.relatedItems=_.chain(f.relatedItems).reject(function(e){var t=f.context;return t&&_.includes([t.causalCI&&t.causalCI.reconciliationId,t.impactedService&&t.impactedService.reconciliationId],e.id)&&e.type===EntityVO.TYPE_ASSET}).value())})},!0)),"ticket-to-all"===f.dependency&&(o.addBladeSize="md",p=f.$watch("relations",function(e,t){e.relationsRefreshInProgress!==t.relationsRefreshInProgress&&(f.state.loadingRelatedItems=!!e.relationsRefreshInProgress),O.then(function(e){e.configurationParameters&&e.configurationParameters.affectedServiceRelation&&(C="true"===e.configurationParameters.affectedServiceRelation),f.relatedItems=a.getRelatedLinkedItems(angular.copy(f.relations[r]),f.context,C)})},!0))}return o}(),f.factory.selectAllFilters(!1,!0),f.factory.load(),f.showRelatedItemDetails=function(e,t){if(!("href"in t.target)){var a={};if(e.type===EntityVO.TYPE_ASSET)a.assetId=e.realObject&&e.realObject.reconciliationId,a.assetClassId=e.realObject&&e.realObject.classId;else{if(e.type!==EntityVO.TYPE_OUTAGE&&e.type!==EntityVO.TYPE_DLP&&!i.isServerApplicationEnabled(e.type))return s.alertStack.length&&s.dismissAllAlerts(),void s.warning({text:n("i18n")("person.preview.notification.disabled.application"),hide:1e4});a.id=e.id}o.go(e.type,a)}},f.openAddRelatedAssetBlade=function(){var e=r.open({templateUrl:"views/asset/relate-asset.html",windowClass:"action-blade",controller:"RelateAssetController",backdrop:"custom",size:"lg",resolve:{linkParams:function(){return{selectedItem:f.context}}}});e.result.then(function(){f.factory.refresh()})},f.addRelatedItem=function(t){e.linkCIsParent=f.context;var a=r.open({templateUrl:f.factory.addTemplateUrl||"views/ticket/link-item-action-blade.html",windowClass:f.factory.addClass||"action-blade",controller:f.factory.addController||"LinkController",size:f.factory.addBladeSize,backdrop:!!_.isUndefined(f.factory.backdrop)||f.factory.backdrop,resolve:{linkParams:function(){return{selectedItems:[f.context],selectedItem:f.context,isDraft:f.isDraft,linkFromTicketConsole:!1}}}});a.result.then(function(e){if("change-to-cis"===f.dependency){var a=e&&e.linkedItems&&e.linkedItems.linkedCIs?e.linkedItems.linkedCIs:[];if(e.relationPromise)f.$emit(l.SHOW_PROGRESS_MODAL_FOR_EDIT,{showModal:!0,title:n("i18n")("change.details.relatingCIs.title"),text:n("i18n")("change.details.relatingCIs.text")}),e.relationPromise["finally"](function(){f.$emit(l.SHOW_PROGRESS_MODAL_FOR_EDIT,{showModal:!1}),s.success({text:n("i18n")("ticket.notification.link.message",e.linkedCount),hide:1e4}),f.factory.refresh()});else{if(e.status&&"Failure"===e.status.type){var i=2001===e.status.number?e.status.message||n("i18n")("ticket.notification.link.message.error",e.linkedCount):n("i18n")("ticket.notification.link.message.error",e.linkedCount);s.error({text:i,hide:1e4})}else if(e.status&&"Success"===e.status.type){var o=e.status.message.match(/\d+/g);if(3===o.length){var r=o[0],c=o[2];c>0&&r>0&&s.success({text:n("i18n")("ticket.notification.link.message.mixed",[r,c]),hide:1e4})}else s.success({text:n("i18n")("ticket.notification.link.message",e.linkedCount),hide:1e4})}f.factory.refresh()}}else f.isDraft?f.$emit(l.DRAFT_TICKET_RESOURCE_RELATED,e):e.length>0&&(s.success({text:n("i18n")("ticket.notification.link.message",e.length),hide:1e4}),f.factory.refresh(e));var d=e[0]||a&&a[0];switch(d&&d.relationshipType){case EntityVO.TYPE_DUPLICATEOF:f.isDraft||(f.context.status.value="Pending"),f.context.accessMappings.detailsEditAllowed=!1,f.context.accessMappings.statusEditAllowed=!1,f.context.accessMappings.relationsEditAllowed=!1,f.$emit(l.REFRESH_TICKET_FROM_TITLE_BAR),s.warning({text:n("i18n")("ticket.notification.duplicate.message",e[0].displayId+": "+(e[0].title||e[0].realObject.title||e[0].desc)),hide:1e4});break;case EntityVO.TYPE_ORIGINALOF:f.context.accessMappings.duplicateActionAllowed=!1}t.currentTarget.focus()},function(){t.currentTarget.focus()})},f.removeRelatedItem=function(e,t){if(t.stopPropagation(),f.context&&f.context.impactedService&&f.context.impactedService.reconciliationId===e.id)return void s.error({text:n("i18n")("ticket.notification.unlink.notAllowed"),hide:1e4});if(f.context&&f.context.causalCI&&f.context.causalCI.reconciliationId===e.id)return void s.error({text:n("i18n")("ticket.notification.unlink.affectedasset.notAllowed"),hide:1e4});var a=s.modal({title:n("i18n")("common.notification.delete.title"),text:n("i18n")("common.notification.delete.message"),buttons:[{text:n("i18n")("common.notification.delete.button1"),data:!0},{text:n("i18n")("common.notification.delete.button2"),data:!1}]});a.result.then(function(t){t&&(f.isDraft?f.$emit(l.DRAFT_TICKET_RESOURCE_UNRELATED,e):f.factory.remove(e).then(function(){s.success({text:n("i18n")("ticket.notification.unlink.message",1),hide:1e4})}))})},f.createRelatedDraft=function(t,a){if(m.isPwaEnabled()&&i.get("pwaEnabledTickets.tickets").indexOf(t)>=0){m.createRelatedFromAsset=!0;var n={};switch(f.getContextType()){case EntityVO.TYPE_ASSET:n.isSrcAsset="true",n.crossLaunchContext="ASSET",m.createRelatedFromAssetData={fromType:f.getContextType(),fromContext:f.context};break;case EntityVO.TYPE_CHANGE:n.isSrcChange="true",n.crossLaunchContext="CHANGE",m.createRelatedFromChange={fromType:f.getContextType(),fromContext:f.context};break;case EntityVO.TYPE_KNOWNERROR:n.isSrcKnownError="true",n.crossLaunchContext="KNOWNERROR",m.createRelatedFromKnownError={fromType:f.getContextType(),fromContext:f.context};break;case EntityVO.TYPE_PROBLEM:n.isSrcProblem="true",n.crossLaunchContext="PROBLEM",m.createRelatedFromProblem={fromType:f.getContextType(),fromContext:f.context}}var r=new Map([["draftIncident","pwaDraftIncident"],["draftWorkorder","pwaDraftWorkorder"],["draftProblem","pwaDraftProblem"],["draftKnownerror","pwaDraftKnownerror"]]);a=r.get(a),o.go(a,n)}else e.cache.draft={type:t},e.cache.relatedDraft={type:t,fromType:f.getContextType(),id:f.context.id,fromContext:f.context},f.getContextType()===EntityVO.TYPE_ASSET&&(e.cache.relatedDraft.id=f.context.reconciliationId,e.cache.relatedDraft.relationship=RelationItemVO.TYPE_RELATEDTO),o.go(a)},f.createRelatedOutage=function(){var e=r.open({templateUrl:"views/create/create-outage-action-blade.html",controller:"CreateOutageController",windowClass:"action-blade",backdrop:"custom",size:"lg",resolve:{params:function(){return{context:f.context,relations:f.relations[f.context.id]}}}});e.result.then(function(e){e.createPromise?(f.$emit(l.SHOW_PROGRESS_MODAL_FOR_EDIT,{showModal:!0,title:n("i18n")("change.details.relatingOutages.text"),text:n("i18n")("change.details.relatingOutages.text")}),e.createPromise.then(function(t){return f.$emit(l.SHOW_PROGRESS_MODAL_FOR_EDIT,{showModal:!1}),t?void s.error({text:t,clear:!1}):void(f.isDraft||(s.success({text:n("i18n")("ticket.notification.link.message",e.ciList.length),hide:1e4}),f.factory.refresh(e.ciList)))})):f.isDraft||(s.success({text:n("i18n")("ticket.notification.link.message",e.ciList.length),hide:1e4}),f.factory.refresh(e.ciList))})},f.createRelatedArticle=function(){e.articleParent=f.context;var a=r.open({templateUrl:"views/create/create-ka.html",controller:"CreateKnowledgeArticleModalController",windowClass:"action-blade",backdrop:"custom",size:"full-page"});a.result.then(function(e){f.state.loadingRelatedItems=!0;var a=(new RelationItemVO).build({id:e.id,displayId:e.articleId,title:e.title,desc:e.title,type:e.type,additionalInformation:{modifiedDate:e.modifiedDate},tag:EntityVO.TYPE_RESOURCE,relationshipType:EntityVO.TYPE_RELATEDTO}),n={type:f.context.type,uuid:f.context.id},i={id:a.id,desc:a.desc,type:a.type,tag:EntityVO.TYPE_RESOURCE,relationshipType:EntityVO.TYPE_RELATEDTO};t.addRelation(n,[i]).then(function(){f.state.loadingRelatedItems=!1,f.$emit(l.SELECT_RESOURCE_TAB),i.type===EntityVO.TYPE_KNOWLEDGE&&delete t.cache[i.id],o.go(a.type,{id:a.id})})})},f.showCreateRelatedMenu=!1,f.validateCreatePermission=function(e){var t=!1;switch(e){case EntityVO.TYPE_WORKORDER:t=i.isServerApplicationEnabled(EntityVO.TYPE_WORKORDER)&&d.hasPermission(c.ITSM_AGENT_ROLE);break;case EntityVO.TYPE_CHANGE:t=i.isServerApplicationEnabled(EntityVO.TYPE_CHANGE)&&d.hasPermission(c.ITSM_CHANGE_USER_ROLE)&&f.getContextType()!==EntityVO.TYPE_CHANGE;break;case EntityVO.TYPE_OUTAGE:t=f.context.accessMappings.createoutageEditAllowed&&f.getContextType()===EntityVO.TYPE_CHANGE;break;case EntityVO.TYPE_INCIDENT:t=i.isServerApplicationEnabled(EntityVO.TYPE_INCIDENT)&&d.hasPermission(c.ITSM_AGENT_ROLE);break;case EntityVO.TYPE_PROBLEM:t=i.isServerApplicationEnabled(EntityVO.TYPE_PROBLEM)&&d.hasPermission(c.ITSM_PROBLEM_USER_ROLE);break;case EntityVO.TYPE_KNOWNERROR:t=i.isServerApplicationEnabled(EntityVO.TYPE_KNOWNERROR)&&d.hasPermission(c.ITSM_PROBLEM_USER_ROLE);break;case EntityVO.TYPE_ASSET:t=i.isServerApplicationEnabled(EntityVO.TYPE_ASSET);break;case EntityVO.TYPE_KNOWLEDGE:t=d.hasPermission(c.ITSM_KNOWLEDGE_USER_ROLE)&&_.includes([EntityVO.TYPE_INCIDENT,EntityVO.TYPE_WORKORDER,EntityVO.TYPE_PROBLEM,EntityVO.TYPE_KNOWNERROR],f.getContextType());break;case EntityVO.TYPE_RELEASE:t=i.isServerApplicationEnabled(EntityVO.TYPE_RELEASE)&&d.hasPermission(c.ITSM_RELEASE_USER_ROLE)}return f.showCreateRelatedMenu||(f.showCreateRelatedMenu=t),t},f.checkLinkPermission=function(){var e=i.get("link"),t=f.getContextType(),a=e[t];return t===EntityVO.TYPE_CHANGE&&(a=_.reject(a,{type:EntityVO.TYPE_ASSET})),i.isServerApplicationEnabled(EntityVO.TYPE_ASSET)||(a=_.reject(a,{type:EntityVO.TYPE_ASSET})),i.isServerApplicationEnabled(EntityVO.TYPE_WORKORDER)&&d.hasPermission(c.ITSM_AGENT_ROLE)||(a=_.reject(a,{type:EntityVO.TYPE_WORKORDER})),i.isServerApplicationEnabled(EntityVO.TYPE_CHANGE)&&d.hasPermission(c.ITSM_CHANGE_USER_ROLE)||(a=_.reject(a,{type:EntityVO.TYPE_CHANGE})),i.isServerApplicationEnabled(EntityVO.TYPE_INCIDENT)&&d.hasPermission(c.ITSM_AGENT_ROLE)||(a=_.reject(a,{type:EntityVO.TYPE_INCIDENT})),i.isServerApplicationEnabled(EntityVO.TYPE_PROBLEM)&&d.hasPermission(c.ITSM_PROBLEM_USER_ROLE)||(a=_.reject(a,{type:EntityVO.TYPE_PROBLEM})),i.isServerApplicationEnabled(EntityVO.TYPE_KNOWNERROR)&&d.hasPermission(c.ITSM_PROBLEM_USER_ROLE)||(a=_.reject(a,{type:EntityVO.TYPE_KNOWNERROR})),i.isServerApplicationEnabled(EntityVO.TYPE_RELEASE)||(a=_.reject(a,{type:EntityVO.TYPE_RELEASE})),!!a.length},f.goToGraphicalCi=function(){g("assetCiExplorer.graphical")},f.goToListCi=function(){g("assetCiExplorer.list")},E=f.$on(l.REFRESH_RELATED_ITEM_LIST,h),f.$on("$destroy",function(){y(),f.factory.cleanUp(),E()})}}}])}(),RelationItemVO.prototype=new BaseVO,RelationItemVO.prototype.constructor=RelationItemVO,RelationItemVO.TAG_RESOURCE="resource",RelationItemVO.TAG_LINKEDITEM="linkeditem",RelationItemVO.TAG_RELEASEPLAN="releaseplan",RelationItemVO.TYPE_RELATEDTO="relatedto",RelationItemVO.TYPE_DUPLICATEOF="duplicateof",RelationItemVO.TYPE_ORIGINALOF="originalof",RelationItemVO.TYPE_REFERENCES="references",RelationItemVO.TYPE_CAUSED="caused",RelationItemVO.TYPE_CAUSEDBY="causedby",RelationItemVO.TYPE_RESOLVED="resolved",RelationItemVO.TYPE_RESOLVEDBY="resolvedby",RelationItemVO.TYPE_IMPACTS="impacts",RelationItemVO.TYPE_IMPACTEDBY="impactedby",RelationItemVO.TYPE_RESTORES="restores",RelationItemVO.TYPE_RESTOREDBY="restoredby",RelationItemVO.TYPE_REOPENEDFROM="reopenedfrom",RelationItemVO.TYPE_REOPENEDBY="reopenedby",RelationItemVO.TYPE_USEDBY="usedby",RelationItemVO.TYPE_POI="POI",RelationItemVO.TYPE_CREATED="created",RelationItemVO.TYPE_CREATEDBY="createdby",RelationItemVO.TYPE_INITIATES="initiates",RelationItemVO.TYPE_INITIATEDBY="initiatedby",RelationItemVO.TYPE_CONSISTSOF="consistsof",RelationItemVO.TYPE_MEMBEROF="memberof",RelationItemVO.prototype.getProps=function(){return BaseVO.prototype.getProps().concat("desc","displayId","parentId","relationshipType","tag","type","templateName","realObject","relationshipClassId")},RelationItemVO.prototype.postBuild=function(){"Crowdsourced Asset"===this.type&&(this.type="asset"),this.isPoi=this.relationshipType===RelationItemVO.TYPE_POI,this.isAsset()&&(this.isPoi&&!this.realObject.reconciliationId&&this.realObject.poiId&&(this.realObject.reconciliationId=this.realObject.poiId),this.entityLink="#/"+this.type+"/"+this.realObject.reconciliationId+"/"+this.realObject.classId),this.subType=this.realObject.isAutomatic?"-auto":"",this.type===EntityVO.TYPE_CONTRACT&&(this.expirationDateHumanized=this.realObject.expirationDate?moment(this.realObject.expirationDate).format("lll"):null)},RelationItemVO.prototype.getRating=function(){return Math.round(this.realObject.useCount/(+this.realObject.useCount+ +this.realObject.notUsefulCount)*100)||0},RelationItemVO.prototype.getNumberOfViews=function(){return _.isUndefined(this.realObject.viewCount)||null===this.realObject.viewCount?-1:this.realObject.viewCount},RelationItemVO.prototype.getNumberOfLinkedItems=function(){return _.isUndefined(this.realObject.linkedItems)||null===this.realObject.linkedItems?-1:this.realObject.linkedItems},RelationItemVO.prototype.getLastModifyDate=function(){return this.realObject.modifiedDate},RelationItemVO.prototype.getStatus=function(){return this.realObject.status.value},RelationItemVO.prototype.getAssigneeFullName=function(){return this.realObject.assignee.fullName},RelationItemVO.prototype.isAsset=function(){return this.type===EntityVO.TYPE_ASSET},RelationItemVO.prototype.isDecisionTree=function(){return"Decision Tree"===this.templateName},RelationItemVO.prototype.isArticleActive=function(){var e=this.realObject||this.additionalInformation;return this.type!==EntityVO.TYPE_KNOWLEDGE||["Cancelled","Retire Approval","Retired","Closed Version"].indexOf(e&&e.status&&e.status.value)===-1},function(){angular.module("myitsmApp").directive("selection",["i18nService","$timeout","utilityFunctions",function(e,t,a){return{restrict:"E",templateUrl:"views/common/selection-directive.html",replace:!0,require:"?^form",scope:{selectionItems:"=",selectedItem:"=",name:"@selectedItem",selectionCallback:"&",titleText:"@",label:"@",value:"@",selectionFilter:"@",selectionFilterPlaceholderText:"@",tier:"@",i18nPrefix:"@",updateSelectedItem:"@",loadingFlag:"=",disabledSelection:"=",ariaRequired:"@",firstItemEmpty:"=",itemHeader:"@",placeholderText:"@",inputId:"@",typeaheadMode:"=",typeaheadDetails:"@",typeaheadGetList:"&",showChunkingTooltip:"=",required:"=",fieldName:"@",entity:"=",duplicateKey:"@",showClear:"@",clearCallback:"&"},compile:function(n,i){var o=n.find("[name='selectedItem']");return o&&o.attr("name",i.selectedItem),function(n,i,o,r){function s(){n.selectionFilter&&(n.selectionFilterPlaceholderText=n.selectionFilterPlaceholderText||""),n.placeholderText=n.placeholderText||"",n.selectedItemLabel=n.selectedItem?n.getLabel(n.selectedItem):n.placeholderText,n.selectedItemValue=n.getValue(n.selectedItem),n.$watch("selectedItem",function(e){n.selectedItemLabel=n.getLabel(e)?n.getLabel(e):n.placeholderText,n.selectedItemValue=n.getValue(e),n.tempFieldName&&r&&r[n.tempFieldName]&&r[n.tempFieldName].$setViewValue(n.getLabel(e)?n.getLabel(e):"")},!0),angular.isDefined(o.autofocus)&&t(function(){l.focus()},300),n.tempFieldName="dummyField_"+a.getUniqueId()}var l=i.find(".dropdown-toggle"),c=!1;n.state={isOpen:!1},n.search={searchFilterText:"",typeaheadText:""},n.searchFilterText="",n.tooltip={showTooltip:!1},n.handleKeyup=function(e){n.searchFilterText=e.target.value,""===n.searchFilterText&&n.oldSelectionItems&&(n.selectionItems=_.cloneDeep(n.oldSelectionItems)),e.stopPropagation()},n.handleKeydown=function(e){27===e.keyCode&&(t(function(){l.trigger("click"),l.focus()},0),e.stopPropagation())},n.itemSelected=function(e){n.updateSelectedItem&&"true"===n.updateSelectedItem&&(n.selectedItem=e,r&&r[n.name]&&r[n.name].$viewValue!=e&&r[n.name].$setViewValue(e)),t(function(){n.tier&&n.selectionCallback?n.selectionCallback({tier:parseInt(n.tier),item:e}):n.selectionCallback&&n.selectionCallback({item:e}),n.state.isOpen&&(n.state.isOpen=!1),0===n.selectionItems.length&&n.oldSelectionItems&&(n.searchFilterText="",n.selectionItems=_.cloneDeep(n.oldSelectionItems)),l.focus()},0)},n.getList=function(e){return n.tooltip.showTooltip=!1,c||(n.oldSelectionItems=_.cloneDeep(n.selectionItems),c=!0),n.selectionItems=[],n.showChunkingTooltip?n.typeaheadGetList({name:e}).then(function(e){return n.tooltip.showTooltip=e.exceedsChunkSize,e.list}):n.typeaheadGetList({name:e})};var d=n.$watch("state.isOpen",function(e,t){t&&t!==e&&(n.search.typeaheadText="",n.oldSelectionItems&&(n.selectionItems=_.cloneDeep(n.oldSelectionItems)))});n.getLabel=function(t){var a=t?n.label?t[n.label]:t:"";return n.i18nPrefix&&a&&(a=e.getLocalizedString(n.i18nPrefix+a)),a&&n.duplicateKey&&t.duplicate&&(a=a+" ("+t[n.duplicateKey]+")"),a},n.getValue=function(e){return e?n.value?e[n.value]:e:""},n.filterDropDown=function(e){return function(t){return _.includes(String(n.getLabel(t)).toLowerCase(),e.toLowerCase())}},n.clear=function(){n.oldSelectionItems&&(n.selectionItems=_.cloneDeep(n.oldSelectionItems)),n.selectedItem=null,n.clearCallback({item:n.selectedItem})},n.$on("$destroy",function(){d()}),s()}}}}])}(),function(){angular.module("myitsmApp").directive("showMoreLess",["events",function(e){return{restrict:"EA",scope:{limit:"=",size:"@",getMore:"&",totalSize:"@",chunkSize:"="},templateUrl:"views/common/show-more-less.html",link:function(t){t.initialSize=t.limit;var a=4;t.chunkSize&&(a=parseInt(t.chunkSize)),t.showMore=function(){t.size=parseInt(t.size),t.initialSize||(t.initialSize=t.limit),t.limit=t.limit+a>t.size?t.size:t.limit+a,t.limit===t.size&&t.totalSize>t.size&&t.getMore(),t.$emit(e.SHOW_MORE_RECORDS)},t.showLess=function(){t.limit=t.initialSize,t.$emit(e.SHOW_LESS_RECORDS)}}}}])}(),function(){angular.module("myitsmApp").service("slaCalculatorService",["$resource","$log","$filter","$timeout","$q",function(e,t,a,n,i){function o(e){return e.toDate&&(e=e.toDate()),a("datePreConfigTimezone")(e,"mediumDate")+" "+a("datePreConfigTimezone")(e,"shortTime")}var r=e("/smartit/rest/sla/:id",{},{getSLAById:{method:"GET",isArray:!0}});this.getAndCalculateSLA=function(e){var a=this;return r.getSLAById({id:e.id}).$promise.then(function(t){var n=t[0].items;_.isUndefined(n)||(_.isEmpty(n)&&e.status&&e.serviceTargets&&e.serviceTargets.length&&(n=e.serviceTargets),a.processServiceTarget(e,n))})["catch"](function(){t.error("Error getting sla information.")})},this.processServiceTarget=function(e,t){var n=this,i=t.map(function(e){return(new SLAVO).build(e)}),r=_.head(i),s=[{run:function(){e.SLA?e.SLA.items=i:e.SLA={items:i,slaRenderType:"full"},n.calculate(e)},condition:"sla"===r.slaType||_.isEmpty(r.slaType)},{run:function(){e.SLA={items:i,slaRenderType:"partial"},n.calculate(e)},condition:"targetdate"===r.slaType||"scheduleddate"===r.slaType},{run:function(){e.SLA={slaTextValid:!0,divClassType:"partial",reachTime:a("i18n")("sla.ticket.created.on")+" "+o(r.endTime)}},condition:"createdate"===r.slaType}];_.find(s,"condition").run()},this.calculate=function(e){n(function(){e.type!==EntityVO.TYPE_PROBLEM&&e.type!==EntityVO.TYPE_KNOWNERROR||"Cancelled"!==e.status.value?e.SLA.slaProgressBarValid=!0:e.SLA.slaProgressBarValid=!1},50),e.SLA.items=_.sortBy(e.SLA.items,["endTime","statusColor"]);var t,a=_.last(e.SLA.items),o=moment(),r=moment(_.head(e.SLA.items).startTime),d=moment(_.last(e.SLA.items).endTime);"full"===e.SLA.slaRenderType?(_.forEach(e.SLA.items,function(e){!t&&e.overallStopTime?t=moment(e.overallStopTime):t&&e.overallStopTime&&(t=moment(e.overallStopTime).isAfter(t)?moment(e.overallStopTime):t)}),t||(t=o)):t=e.completedDate?moment(e.completedDate):e.closedTime?e.closedTime:e.modifiedDate?moment(e.modifiedDate):o,e.isResolved()&&e.type===EntityVO.TYPE_CHANGE&&(t="partial"!==e.SLA.slaRenderType&&e.SLA.items&&e.SLA.items.length?moment(_.last(e.SLA.items).overallStopTime):e.actualEndDate?moment(e.actualEndDate):o);var u=s(e),p={tillNow:o.diff(r),tillSlaEnd:d.diff(r),tillClosedDate:t.diff(r),tillDownStartTime:u?u.diff(r):""},m=[{reachedPercent:Math.round(p.tillNow/p.tillSlaEnd*100),condition:"sla"!==a.slaType&&!e.isClosed(),timeToLimit:o.from(d,!0),isSlaPassed:o.isAfter(d),autoRefresh:!0},{reachedPercent:Math.round(p.tillNow/p.tillSlaEnd*100),condition:"sla"===a.slaType&&!e.SLA.allMet&&!e.SLA.allPaused,timeToLimit:o.from(d,!0),isSlaPassed:o.isAfter(d),autoRefresh:!0},{reachedPercent:Math.round(p.tillClosedDate/p.tillSlaEnd*100),condition:"sla"===a.slaType&&e.SLA.allMet,timeToLimit:t.from(d,!0),isSlaPassed:t.isAfter(d),autoRefresh:!0},{reachedPercent:p.tillDownStartTime?Math.round(p.tillDownStartTime/p.tillSlaEnd*100):Math.round(p.tillNow/p.tillSlaEnd*100),condition:"sla"===a.slaType&&e.SLA.allPaused,timeToLimit:u?u.from(d,!0):o.from(d,!0),isSlaPassed:u?u.isAfter(d):o.isAfter(d),autoRefresh:!1},{reachedPercent:Math.round(p.tillClosedDate/p.tillSlaEnd*100),condition:"sla"!==a.slaType&&e.isClosed(),timeToLimit:t.from(d,!0),isSlaPassed:t.isAfter(d),autoRefresh:!1}],f=_.find(m,"condition");return f&&(e.SLA.reachedPercent=f.reachedPercent,e.SLA.timeToLimit=f.timeToLimit,e.SLA.isSlaPassed=f.isSlaPassed,e.SLA.autoRefresh=f.autoRefresh,e.SLA.slaStartTime=r,e.SLA.slaEndTime=d,e.SLA.closedTime=t),l(e),c(e),i.when(e)};var s=function(e){if(e.SLA.allPaused=!1,"partial"===e.SLA.slaRenderType)return"";if(1===e.SLA.items.length)return e.SLA.items[0].measurementStatus===SLAVO.MEASUREMENT_STATUS_PENDING?e.SLA.allPaused=!0:e.SLA.items[0].measurementStatus!==SLAVO.MEASUREMENT_STATUS_MET&&e.SLA.items[0].measurementStatus!==SLAVO.MEASUREMENT_STATUS_MISSED||(e.SLA.allMet=!0),e.SLA.items[0].downStartTime?moment(e.SLA.items[0].downStartTime):"";var t=!1,a=!1,n=!0,i=!0;return _.forEach(e.SLA.items,function(e){e.measurementStatus===SLAVO.MEASUREMENT_STATUS_PENDING?(t=!0,i=!1):e.measurementStatus===SLAVO.MEASUREMENT_STATUS_MET||e.measurementStatus===SLAVO.MEASUREMENT_STATUS_MISSED?a=!0:(n=!1,i=!1)}),n=n&&t,i=i&&a,e.SLA.allMet=i,n&&!a?(e.SLA.allPaused=!0,moment(_.find(e.SLA.items,{measurementStatus:SLAVO.MEASUREMENT_STATUS_PENDING}).downStartTime)):n?(e.SLA.allPaused=!0,moment(_.find(e.SLA.items,{measurementStatus:SLAVO.MEASUREMENT_STATUS_PENDING}).downStartTime)):(_.each(e.SLA.items,function(e){e.measurementStatus===SLAVO.MEASUREMENT_STATUS_PENDING&&(e.iconClass="pause_circle_o")}),"")},l=function(e){var t,n=moment();t=e.isClosed()&&"full"!==e.SLA.slaRenderType?e.SLA.closedTime.isAfter(e.SLA.slaEndTime)?e.SLA.closedTime.diff(e.SLA.slaStartTime):e.SLA.slaEndTime.diff(e.SLA.slaStartTime):e.SLA.allPaused?e.SLA.slaEndTime.diff(e.SLA.slaStartTime):e.SLA.allMet?e.SLA.closedTime.isAfter(e.SLA.slaEndTime)?e.SLA.closedTime.diff(e.SLA.slaStartTime):e.SLA.slaEndTime.diff(e.SLA.slaStartTime):n.isAfter(e.SLA.slaEndTime)?n.diff(e.SLA.slaStartTime):e.SLA.slaEndTime.diff(e.SLA.slaStartTime),_.each(e.SLA.items,function(i){var r,s,l=90,c=moment(i.endTime),d=i.overallStopTime?moment(i.overallStopTime):"";if(i.position=c.diff(e.SLA.slaStartTime)/t,i.timeToLimit=i.measurementStatus===SLAVO.MEASUREMENT_STATUS_PENDING?moment(i.downStartTime).from(c,!0):n.from(c,!0),"sla"!==i.slaType&&(e.isResolved()?i.slaStatusClass=e.SLA.isSlaPassed?"sla-icon_color-red":"sla-icon_color-green":i.slaStatusClass=e.SLA.isSlaPassed?"sla-icon_color-red":e.SLA.reachedPercent<l?"sla-icon_color-green":"sla-icon_color-orange"),r=i.measurementStatus===SLAVO.MEASUREMENT_STATUS_MET||n.isAfter(c)?a("i18n")("sla.due")+" "+o(c):""===i.endTime||null===i.endTime||void 0===i.endTime?a("i18n")("sla.due.date")+" "+a("i18n")("common.labels.unknown"):a("i18n")("sla.due.in")+" "+i.timeToLimit+" ("+o(c)+")","full"===e.SLA.slaRenderType){var u=""===i.endTime||null===i.endTime||void 0===i.endTime?"":d?d.from(c,!0):"";switch(i.measurementStatus){case SLAVO.MEASUREMENT_STATUS_PENDING:i.iconClass="pause_circle_o";break;case SLAVO.MEASUREMENT_STATUS_MET:d&&(s=u?a("i18n")("sla.status.achieved",u)+" "+a("i18n")("sla.status.early",o(d)):"");break;case SLAVO.MEASUREMENT_STATUS_MISSED:d&&(i.metMissedAmount&&(u=moment().add(i.metMissedAmount,"seconds").from(moment(),!0)),s=u?a("i18n")("sla.status.achieved",u)+" "+a("i18n")("sla.status.late",o(d)):"")}}else i.tooltip="",i.iconClass="circle_o",e.isPaused()?s=a("i18n")("sla.now.paused"):e.isResolved()?e.SLA.isSlaPassed?(s=a("i18n")("sla.status.achieved",e.SLA.closedTime.from(c,!0))+" "+a("i18n")("sla.status.late",o(e.SLA.closedTime)),i.iconClass="cross_circle_o"):(s=a("i18n")("sla.status.achieved",e.SLA.closedTime.from(c,!0))+" "+a("i18n")("sla.status.early",o(e.SLA.closedTime)),i.iconClass="check_circle_o"):e.isCancelled()&&(e.SLA.isSlaPassed?i.iconClass="cross_circle_o":i.iconClass="circle_o");var p="";"cross_circle_o"===i.iconClass?(i.SLAStatus=a("i18n")("sla.passed"),p=' <i class="icon-'+i.iconClass+'"></i> <span class="sla-status-info" >'+i.SLAStatus+"</span>"):"check_circle_o"===i.iconClass?(i.SLAStatus=a("i18n")("sla.achieved"),p=' <i class="icon-'+i.iconClass+'"></i> <span class="sla-status-info">'+i.SLAStatus+"</span>"):"pause_circle_o"===i.iconClass&&(i.SLAStatus=a("i18n")("sla.now.paused"),p=' <i class="icon-'+i.iconClass+'"></i> <span class="sla-status-info">'+i.SLAStatus+"</span>"),i.tooltip='<p class="nowrap-line"><b>'+i.title+"</b></p><p>"+r+p+"</p>",i.tooltipText=i.title+" "+r,s&&(i.tooltip+="<p>"+s+"</p>",i.tooltipText=i.tooltipText+" "+s),i.SLADetailTooltipText={title:i.title,message:r},s&&(i.SLADetailTooltipText.message+=" "+s)});var i={};_.each(e.SLA.items,function(e){_.isUndefined(i[e.endTime])?i[e.endTime]={tooltipHtml:e.tooltip,tooltipCount:1}:(i[e.endTime].tooltipHtml+="<br/>"+e.tooltip,i[e.endTime].tooltipCount+=1)}),e.SLA.items.map(function(e){e.tooltipCount=i[e.endTime].tooltipCount,i[e.endTime].tooltipCount>2?e.tooltip=e.tooltip+"<br/> <p>"+a("i18n")("sla.tooltip.showMore",i[e.endTime].tooltipCount-1)+"</p> <p>  "+a("i18n")("sla.tooltip.clickToSeeDetails")+"  </p>":e.tooltip=i[e.endTime].tooltipHtml})},c=function(e){var t,n=moment(),i=90,o=e.SLA.slaEndTime.calendar({sameElse:"lll"});if(e.SLA.allPaused)e.SLA.reachTime=a("i18n")("sla.now.paused"),t=_.find(e.SLA.items,function(e){return e.measurementStatus===SLAVO.MEASUREMENT_STATUS_PENDING}),t?moment(t.downStartTime).isAfter(moment(t.endTime))?e.SLA.divClassType="danger":t.warningDate?e.SLA.divClassType=moment(t.downStartTime).isBefore(moment(t.warningDate))?"success":"warning":e.SLA.divClassType="success":e.SLA.divClassType="danger";else if("partial"===e.SLA.slaRenderType)e.SLA.reachTime=a("i18n")("sla.target.date.is")+" "+o,e.isResolved()?e.SLA.divClassType=e.SLA.isSlaPassed?"danger":"success":e.SLA.divClassType=e.SLA.isSlaPassed?"danger":e.SLA.reachedPercent<i?"success":"warning";else{if(t=_.find(e.SLA.items,function(e){return n.isBefore(moment(e.endTime))&&e.measurementStatus!=SLAVO.MEASUREMENT_STATUS_MET}))e.SLA.reachTime=a("i18n")("sla.next.sla.is")+" "+moment(t.endTime).calendar({sameElse:"lll"});else if(e.SLA.allMet)e.SLA.reachTime=a("i18n")("sla.achieved")+" "+moment(_.last(e.SLA.items).overallStopTime).calendar({sameElse:"lll"});else{var r=e.SLA.items.filter(function(e){return e.measurementStatus===SLAVO.MEASUREMENT_STATUS_MISSED_GOAL});r=r&&_.last(r)||_.last(e.SLA.items),e.SLA.reachTime=a("i18n")("sla.passed")+" "+moment(r.endTime).calendar({sameElse:"lll"})}t=_.find(e.SLA.items,function(e){return e.measurementStatus===SLAVO.MEASUREMENT_STATUS_MISSED||e.measurementStatus===SLAVO.MEASUREMENT_STATUS_MISSED_GOAL}),t?e.SLA.divClassType="danger":(t=_.find(e.SLA.items,function(e){return e.measurementStatus===SLAVO.MEASUREMENT_STATUS_PENDING&&moment(e.downStartTime).isAfter(moment(e.endTime))}),t?e.SLA.divClassType="danger":(t=_.find(e.SLA.items,function(e){return e.measurementStatus===SLAVO.MEASUREMENT_STATUS_PENDING&&moment(e.downStartTime).isAfter(moment(e.warningDate))||e.measurementStatus!==SLAVO.MEASUREMENT_STATUS_PENDING&&e.measurementStatus!==SLAVO.MEASUREMENT_STATUS_MET&&n.isAfter(e.warningDate)}),t?e.SLA.divClassType="warning":e.SLA.divClassType="success"))}}}])}(),function(){angular.module("myitsmApp").directive("slaProgressBar",["slaCalculatorService","$interval","$window","$timeout","userModel","$modal",function(e,t,a,n,i,o){return{restrict:"EA",replace:!1,scope:{ticket:"="},templateUrl:"views/common/sla-progress-bar.html",link:function(r){r.isAccessibleUser=i.isAccessibleUser,r.$watch(function(){return i.isAccessibleUser},function(){r.isAccessibleUser=i.isAccessibleUser}),r.isRtl=window.isRtl;var s,l=6e4,c=function(){_.each(r.ticket.SLA.items,function(e){e.left=Math.round(100*e.position<1?1:100*e.position)})},d=function(){"partial"===r.ticket.SLA.slaRenderType?e.calculate(r.ticket).then(c):e.getAndCalculateSLA(r.ticket).then(c)},u=function(){r.progressBar={length:r.ticket.SLA.reachedPercent>100?100:r.ticket.SLA.reachedPercent<1?1:r.ticket.SLA.reachedPercent,type:r.ticket.SLA.divClassType}},p=function(){s&&t.cancel(s)},m=function(){s=t(d,l)};n(c),r.$watch("ticket.SLA.reachedPercent",u),r.$watch("ticket.SLA.autoRefresh",function(e){e?(p(),m()):p()});var f=function(){c(),r.$apply()};angular.element(a).bind("resize",f),r.$on("$destroy",function(){p(),angular.element(a).off("resize",f)}),r.showSLA=function(e){console.log(e)},r.showDetails=function(){return o.open({templateUrl:"views/common/sla-tooltip-detail.html",windowClass:"action-blade-narrow",scope:r})}}}}])}(),function(){angular.module("myitsmApp").directive("slaReachTime",function(){return{restrict:"E",replace:!0,scope:{sla:"="},templateUrl:"views/ticket/partials/sla-reach-time.html"}})}(),function(){angular.module("myitsmApp").directive("textAreaExpand",["events","$timeout",function(e,t){return{restrict:"E",templateUrl:"views/common/text-area-expand-directive.html",replace:!0,scope:{ticket:"=",fieldName:"=",context:"=",metadata:"=",editMode:"=",updateIsHandledByParent:"=?",isRequired:"=?",isEditable:"=?",fieldValueChange:"&",limit:"=?"
},link:function(a,n){function i(){_.isUndefined(a.ticket[a.name])?(a.fieldData="",a.ticket[a.name]=""):a.fieldData=a.ticket[a.name],a.textFieldExpanded=!1,a.metadata&&a.metadata.configurationParameters&&(a.displayEncodedCharacters="true"===a.metadata.configurationParameters.displayEncodedCharacters),o()}function o(){var e=14;t(function(){u.height(u[0]&&u[0].scrollHeight-e)})}function r(){a.editMode=!0,c()}function s(){var t="custom"===a.fieldName;a.editMode=!1;var n={};if(a.fieldData!==a.ticket[a.name]){if("custom"===a.fieldName){var i={};i[a.ticket&&a.ticket.name]=a.fieldData,n.customFields=i}else n[a.fieldName]=a.fieldData;a.ticket[a.name]=a.fieldData}var r="draft"===a.context;a.updateIsHandledByParent||a.$emit(e.SAVE_CHANGES_REQUEST,n,r,t),r&&a.$emit(e.SAVE_CHANGES_COMPLETE),o()}function l(){a.editMode=!1,a.fieldData=_.clone(a.ticket[a.name]),o()}function c(){var e=14;t(function(){u.height(u[0].scrollHeight-e)})}var d=n.find(".ticket-summary-content__text"),u=d.find("textarea.content");a.name="custom"===a.fieldName?"value":a.fieldName,_.isBoolean(a.isRequired)||(a.isRequired=!1),_.isBoolean(a.isEditable)||(a.isEditable=!0),a.viewTextFieldExpandable=function(){var e=100,t=d.find("div.content");return!a.editMode&&"create"!==a.context&&t[0]&&t[0].scrollHeight>e},a.textFieldExpandable=function(){var e=100;return!a.editMode&&"create"!==a.context&&u[0]&&u[0].scrollHeight>e},a.textFieldCollapsed=function(){return!a.textFieldExpanded&&a.textFieldExpandable()},a.viewTextFieldCollapsed=function(){return!a.textFieldExpanded&&a.viewTextFieldExpandable()},a.showMoreVisible=function(){return!a.textFieldExpanded&&a.viewTextFieldExpandable()},a.showLessVisible=function(){return a.textFieldExpanded&&a.viewTextFieldExpandable()},a.toggleTextField=function(){a.textFieldExpanded=!a.textFieldExpanded,t(function(){u.scrollTop(0)})},a.$on(e.TOGGLE_EDIT_MODE,r),a.$on(e.DISCARD_CHANGES,l),a.$on(e.SAVE_CHANGES,s),a.setFieldData=function(){u.css("height","auto");var e=u[0].scrollHeight;e>0&&u.css("height",e+"px"),a.ticket[a.name]=a.fieldData,a.fieldValueChange()},a.$watch("ticket.value",function(e){_.isUndefined(e)||a.fieldData==e||(a.fieldData=e||"")}),i()}}}])}(),function(){angular.module("myitsmApp").directive("thumbnailImg",[function(){return{restrict:"A",replace:!0,priority:99,link:function(e,t,a){a.$observe("thumbnailImg",function(e){var t,n={user:"styles/img/user-thumbnail-placeholder.png",asset:"styles/img/asset-thumbnail-placeholder.png",attachment:"styles/img/attachment-generic.png"},i=angular.isDefined(a.imgplaceholder)?n[a.imgplaceholder]:a.imgplaceholder;e&&(t=(new AttachmentVO).normalizeThumbnail(e));var o=t?t:i;o&&a.$set("src",o)})}}}]).directive("userAvatar",[function(){return{restrict:"E",template:'<img class="app__person-avatar_{{size}}" alt="{{user.fullName}}" ng-src="/smartit/rest/v2/attachment/thumbnail/social/user/{{user.loginId}}/1?binary=true"/>',scope:{user:"=user",size:"@"},link:function(e,t){function a(){this.src="styles/img/user-thumbnail-placeholder.png"}var n="small";e.size||(e.size=n),t.find("img").on("error",a),e.$on("$destroy",function(){console.log("userAvatar: unbind events"),t.find("img").off("error",a)})}}}])}(),function(){angular.module("myitsmApp").directive("timeTicker",["$timeout","configurationModel","$filter",function(e,t,a){return{scope:{time:"=",refreshInterval:"="},link:function(n,i,o){function r(){c&&i.text(moment(Number(c)).fromNow())}function s(){l&&e.cancel(l),l=e(function(){r(),s()},d)}var l,c=n.time,d=n.refreshInterval,u=t.dateTimeStyleProperty?t.dateTimeStyleProperty:"relative";n.$watch("time",function(e){c=e,"relative"===u?(r(),s()):i.text(a("datePreConfigTimezone")(c,"mediumDate")+" "+a("datePreConfigTimezone")(c,"shortTime"))})}}}])}(),function(){angular.module("myitsmApp").directive("toggleItem",[function(){return{restrict:"A",scope:{toggleItem:"@"},link:function(e,t){function a(){t.parents("."+e.toggleItem).toggleClass("opened")}t.on("click",a),e.$on("$destroy",function(){console.log("toggleItem: unbind events"),t.off("click",a),t.off()})}}}])}(),function(){angular.module("myitsmApp").provider("topicLogger",[function(){var e=[];this.addTopic=function(t){e.indexOf(t)==-1&&e.push(t)},this.removeTopic=function(t){var a=e.indexOf(t);a>-1&&e.splice(a,1)},this.getTopics=function(){return e},this.includesTopic=function(t){return e.indexOf(t)>-1},this.$get=function(){}}])}(),function(){angular.module("myitsmApp").service("urlCreatorService",["$location",function(e){this.create=function(t){var a=e.absUrl().replace(e.url(),"/");return a+=t.ticketType===EntityVO.TYPE_ASSET?t.ticketType+"/"+t.reconciliationId+"/"+t.classId:t.type+"/"+t.id}}])}(),function(){angular.module("myitsmApp").directive("userAvailability",["personModel","chatModel","$timeout",function(e,t,a){return{restrict:"A",scope:{userInfo:"=userAvailability"},priority:99,replace:!0,template:"<div class=\"chat-availability__holder\" ng-class=\"'availability__'+(currentProfile.available ? currentProfile.available.toLowerCase() : 'offline')\"></div>",link:function(n,i,o){n.currentProfile={};var r=parseInt(i.css("height")),s=parseInt(i.css("width")),l=r>=s?r:s;i.height(l).width(l),o.$observe("src",function(e){e&&i.css({"background-image":"url("+o.src+")","background-size":"contain"})});var c=n.$watch(function(){return!!t.connected&&n.userInfo},function(i){if(i){var o=n.userInfo,r=o.jid,s=o.loginId||o.elementId,l=r||t.generateUserJID(s),c=!!s&&(t.currentUser.elementId===s||t.currentUser.loginId===s),d=!!r&&t.currentUser===r;if(c||d)return void(n.currentProfile=t.currentUser);if(r)return t.cachedProfiles[r]?angular.extend(t.cachedProfiles[r],o):t.cachedProfiles[r]=o,n.currentProfile=t.cachedProfiles[r],void t.checkUserAvailability(r);if(s){var u;if(t.cachedProfiles[l]?(o.jid=l,o.available=t.cachedProfiles[l].available,u=t.cachedProfiles[l],angular.extend(t.cachedProfiles[l],o)):u=_.find(t.cachedProfiles,function(e){return _.includes(e,s)}),u)return n.currentProfile=u,void t.checkUserAvailability(n.currentProfile.jid);var p=e.getPersonDetailsByID(s).then(function(i){r=i?i.jid:_.noop(),r?(i.available=i.available.toLowerCase(),t.cachedProfiles[r]?angular.extend(t.cachedProfiles[r],e.personDetails):t.cachedProfiles[r]=e.personDetails,a(function(){n.currentProfile=t.cachedProfiles[r],n.currentProfile.available||t.checkUserAvailability(n.currentProfile.jid)})):(t.cachedProfiles.notFound=i,n.currentProfile=i)});return void(t.pendingProfileRequests[s]=p)}}});n.$on("destroy",function(){c()})}}}])}(),function(){angular.module("changeModule").directive("basicDetails",["events","tabIds",function(e,t){return{restrict:"E",replace:!0,templateUrl:"views/change/basic-details-v2.html",link:function(a){a.isNew=!0,a.$watch(t.wizard.basics+".$invalid",function(n){"undefined"!=typeof n&&a.$emit(e.CHANGE_WIZARD_FORM_STATE,{name:t.wizard.basics,invalid:n})}),a.$watch(t.wizard.basics+".$dirty",function(n){"undefined"!=typeof n&&a.$emit(e.CHANGE_WIZARD_FORM_STATE,{name:t.wizard.basics,dirty:n})})}}}])}(),function(){angular.module("changeModule").directive("calendarBookView",["$timeout","$log","events","$rootScope","dateFilter","$locale","$state",function(e,t,a,n,i,o,r){return{restrict:"E",templateUrl:"views/change/calendar-book-view.html",require:"^calendar",scope:{},link:function(s,l,c,d){function u(){d.displayCollisions({calendar:s.changeBookView,resources:s.config.resources,outagesIndex:p(),businessEventsIndex:m(),changeCollisionCss:"bookview_event_collision",changeNonCollisionCss:"bookview_event_secondary",outageCollisionCss:"bookview_event_outage_collision",outageNonCollisionCss:"bookview_event_outage_secondary",businessEventCollisionCss:"bookview_event_business_event_collision",businessEventNonCollisionCss:"bookview_event_business_event_secondary",updateCalendar:function(){f(!0)}})}function p(){return(d.changeRequestFilterSelected()?d.visibleChangeRequests(s.changeBookView).length:0)+1}function m(){var e=p();return d.outageFilterSelected()?e+1:e}function f(e){var a=s.model.context.scheduledStartDate,n=s.model.context.scheduledEndDate,i=!(!a||!n);i?(t.log("update book view: start="+a+"("+a.getTime()+"), end="+n+"("+n.getTime()+")"),s.changeBookView.collisionStart=new DayPilot.Date(a,(!0)),s.changeBookView.collisionEnd=new DayPilot.Date(n,(!0))):(s.changeBookView.collisionStart=null,s.changeBookView.collisionEnd=null),(i||e)&&s.changeBookView.update()}function g(){var e=s.model.context.scheduledStartDate?s.model.context.scheduledStartDate:new Date;h(e)}function h(e){e instanceof Date&&(e=new DayPilot.Date(e,(!0))),e=e.addHours(-e.getHours()).addMinutes(-e.getMinutes()),s.changeBookView.scrollTo(e)}function y(){e(function(){E(s.model.context.scheduledStartDate,s.model.context.scheduledEndDate)})}function E(e,t){d.rescheduleChangeRequest(s.changeBookView,e,t)&&!v(e,t)&&f()}function v(e,a){if(!e||!a)return!1;e instanceof Date&&(e=new DayPilot.Date(e,(!0))),a instanceof Date&&(a=new DayPilot.Date(a,(!0)));var n=1,i=2,o=moment(I.toDateLocal()).startOf("day"),r=I.addDays(C),l=moment(r.toDateLocal()).startOf("day"),c=moment(e.toDateLocal()).startOf("day"),d=moment(a.toDateLocal()).startOf("day"),u=!1,p=c.diff(o,"days"),m=l.diff(d,"days");return(p<n||m<=n)&&(o=c.subtract(i,"days"),l=d.add(i+1,"days"),C=l.diff(o,"days"),C=Math.min(C,O),C=Math.max(C,b[_].minTimelineDays),I=new DayPilot.Date(o.toDate()),u=!0),u&&(t.log("book view timeline extended: start="+I+" days="+C),s.changeBookView.days=s.config.days=C,s.changeBookView.startDate=s.config.startDate=I,f(),g()),u}function T(e){e=e||10;for(var t=[{name:"",id:s.model.currentRequestResourceId}],a=1;a<e;a++)t.push({name:"",id:a.toString()});return t}function S(e){return _+=e,_<0||_>=b.length?void(_-=e):(s.model.zoomInDisabled=0===_,s.model.zoomOutDisabled=_===b.length-1,t.log("book view timeline zoomed to "+_+" level."),s.changeBookView.cellDuration=s.config.cellDuration=b[_].cellDuration,s.changeBookView.timeHeaders=s.config.timeHeaders=b[_].timeHeaders,s.changeBookView.days=s.config.days=Math.max(C,b[_].minTimelineDays),void f())}s.model=d.model;var C=5,_=3,O=20,A=Math.floor(C/2),I=s.model.context.scheduledStartDate?new DayPilot.Date(s.model.context.scheduledStartDate,(!0)).addDays(-A):new DayPilot.Date,b=[{cellDuration:15,timeHeaders:[{groupBy:"Day"},{groupBy:"Hour"},{groupBy:"Cell"}],minTimelineDays:5,formats:["dayAndDate","shortestTime"]},{cellDuration:30,timeHeaders:[{groupBy:"Day"},{groupBy:"Hour"},{groupBy:"Cell"}],minTimelineDays:5,formats:["dayAndDate","shortestTime"]},{cellDuration:60,timeHeaders:[{groupBy:"Day"},{groupBy:"Cell"}],minTimelineDays:5,formats:["dayAndDate","shortestTime"]},{cellDuration:120,timeHeaders:[{groupBy:"Day"},{groupBy:"Cell"}],minTimelineDays:5,formats:["dayAndDate","shortestTime"]},{cellDuration:240,timeHeaders:[{groupBy:"Day"},{groupBy:"Cell"}],minTimelineDays:10,formats:["dayAndDate","shortestTime"]},{cellDuration:360,timeHeaders:[{groupBy:"Day"},{groupBy:"Cell"}],minTimelineDays:14,formats:["dayAndDate","shortestTime"]},{cellDuration:480,timeHeaders:[{groupBy:"Day"},{groupBy:"Cell"}],minTimelineDays:18,formats:["dayAndDate","shortestTime"]}];s.isChangeCalendar=r.current.name&&r.current.name.indexOf("changeCalendar")!==-1,s.config={heightSpec:"Parent100Pct",days:C,startDate:I,scale:"CellDuration",cellDuration:b[_].cellDuration,timeHeaders:b[_].timeHeaders,theme:"bookview",cssClassPrefix:"bookview",resources:T(25),onIncludeTimeCell:function(e){var t=0,a=6;s.model.showWeekends||e.cell.start.getDayOfWeek()!==t&&e.cell.start.getDayOfWeek()!==a||(e.cell.visible=!1)},onBeforeTimeHeaderRender:function(e){var t=b[_].formats[e.header.level];if(0===e.header.level&&"en"===window.myitsmLocale&&"en-us"!==o.id.toLowerCase()&&(t="shortDate"),t){var a=i(e.header.start.toDateLocal(),t);0===e.header.level&&"en"===window.myitsmLocale&&"en-us"!==o.id.toLowerCase()&&(a="en-ca"===o.id.toLowerCase()?a.substring(a.indexOf("-")+1):"en-za"===o.id.toLowerCase()?a.substring(a.indexOf("/")+1):a.substring(0,a.lastIndexOf("/"))),e.header.html=a,e.header.toolTip=a}},onTimeRangeSelected:function(e){s.isChangeCalendar?e.preventDefault():(s.changeBookView.clearSelection(),e.resource===s.model.currentRequestResourceId&&(s.model.context.scheduledStartDate=e.start.toDateLocal(),s.model.context.scheduledEndDate=e.end.toDateLocal(),s.$apply()))},onEventMove:function(e){(s.isChangeCalendar||e.newResource!==s.model.currentRequestResourceId)&&e.preventDefault()},onEventMoved:function(e){e.newResource===s.model.currentRequestResourceId&&(s.model.context.scheduledStartDate=e.newStart.toDateLocal(),s.model.context.scheduledEndDate=e.newEnd.toDateLocal(),s.$apply())},onEventResize:function(e){(s.isChangeCalendar||e.e.resource()!==s.model.currentRequestResourceId)&&e.preventDefault()},onEventResized:function(e){e.e.resource()===s.model.currentRequestResourceId&&(s.model.context.scheduledStartDate=e.newStart.toDateLocal(),s.model.context.scheduledEndDate=e.newEnd.toDateLocal(),s.$apply())},onEventClicked:d.onEventClicked},s.$watch("model.showWeekends",function(){f()}),s.$watch("model.expanded",function(){s.model.expanded&&e(function(){f()},500)}),s.$watch("model.context.scheduledStartDate",function(){y()}),s.$watch("model.context.scheduledEndDate",function(){y()}),s.$watch("model.selectedCalendarView",function(){s.model.selectedCalendarView===s.model.calendarViews[0]&&e(function(){f(),g()})});var k=n.$on(a.CHANGE_COLLISION_STATUS_CHANGED,function(e,t){d.applyAddressedCollisions(t),u()});s.$on("$destroy",function(){k()}),s.$watch("model.context",function(){d.updateCalendarHandling(s.changeBookView)},!0),s.$watch("model.collisions",function(){u()},!0),s.$watch("model.calendarTypes",function(){u()},!0),s.$on(a.ZOOM_LEVEL_CHANGED,function(e,t){S(t)}),g()}}}])}(),function(){angular.module("changeModule").directive("calendar",["$log","events","$filter","editTicketDatesService","collisionModel","$compile","relationModel","$document","$state","$stateParams","configurationModel","categoriesService","metadataModel","$timeout","$rootScope",function(e,t,a,n,i,o,r,s,l,c,d,u,p,m,f){return{restrict:"E",templateUrl:"views/change/calendar.html",replace:!0,controller:["$scope",function(s){function c(e,t){e=e?e.valueOf():e,t=t?t.valueOf():t,s.$parent&&s.$parent.dates&&!s.$parent.dates.$dirty&&e!==t&&(s.$parent.dates.$dirty=!0)}function g(e){var t=e;return e instanceof DayPilot.Date&&(t=e.toDateLocal().getTime()),e instanceof Date&&(t=e.getTime()),t}function h(){var e=angular.copy(s.filters.selected),t={};return _.forEach(e,function(a){var n=a.criteria,i=_.isArray(n.value),o=n.name;t[o]?i?t[o]=_.union(t[o],n.value):(e.splice(_.findIndex(e,{name:a.name}),1),t[o]=n.value):t[o]=n.value}),t}function y(t){if(!s.model.loadingCollisions&&E(t))if(T()){var a=31,n=s.model.context,o=new Date(moment(n.scheduledStartDate).subtract(a,"days").valueOf()),r=new Date(moment(n.scheduledEndDate).add(a,"days").valueOf()),l=n.linkedCIs?_.cloneDeep(n.linkedCIs):[];if(e.log("Loading collisions: start="+o+"; end="+r+"; CIs="+_.map(n.linkedCIs,"id").join()),s.model.loadingCollisions=!0,n.impactedService&&n.impactedService.reconciliationId&&(_.find(l,{id:n.impactedService.reconciliationId})||l.push({id:n.impactedService.reconciliationId})),!l.length)return void(s.model.loadingCollisions=!1);if(!isNaN(d.autoTriggerChangeCollisionForCIsUpto)&&!_.isUndefined(d.autoTriggerChangeCollisionForCIsUpto)&&l.length>d.autoTriggerChangeCollisionForCIsUpto)return s.autoTriggerChangeCollision=!0,void(s.model.loadingCollisions=!1);i.getListOfCollisionsByDate(n.id,o,r,l,h()).then(function(e){s.model.loadingCollisions=!1,s.displayingCollisions=!1,s.model.collisions=e,s.model.collisions.scheduledStartDate=n.scheduledStartDate,s.model.collisions.scheduledEndDate=n.scheduledEndDate,s.model.collisions.linkedCIs=l})["catch"](function(){s.model.loadingCollisions=!1})}else s.model.collisions=null}function E(e){var t=s.model.context,a=s.model.collisions,n=t&&a&&t.scheduledStartDate&&t.scheduledEndDate&&t.linkedCIs&&t.linkedCIs.length&&a.scheduledStartDate&&a.scheduledEndDate&&a.linkedCIs&&a.linkedCIs.length,i=n&&t.scheduledStartDate.getTime()===a.scheduledStartDate.getTime()&&t.scheduledEndDate.getTime()===a.scheduledEndDate.getTime()&&v(t.linkedCIs,a.linkedCIs)&&!e;return!n||!i}function v(e,t){if(e.length!==t.length)return!1;var a=_.map(e,"id"),n=_.map(t,"id"),i=_.difference(_.sortBy(a),_.sortBy(n));return 0===i.length}function T(){var e=s.model.context;return e.scheduledStartDate&&e.scheduledEndDate&&e.scheduledEndDate.getTime()>e.scheduledStartDate.getTime()}function S(){if(s.model.editMode&&!s.model.isNew){var e=s.model.context.id;r.getRelations(e,EntityVO.TYPE_CHANGE)["finally"](function(){s.model.loadingCollisions=!1,s.model.context.linkedCIs=_.filter(angular.copy(r.cache[e]),{type:EntityVO.TYPE_ASSET})||[]})}}function C(e){b.removeEvents(e.calendar,function(e){return e.resource()!==s.model.currentRequestResourceId})}function O(e){if(b.changeRequestFilterSelected()){var t,a,n,i,o,r=e.resources;t=b.visibleChangeRequests(e.calendar);for(var l=0,c=1;l<t.length;l++,c++){a=t[l],n=null,r&&(c>=r.length?(n=c.toString(),r.push({name:"",id:n})):n=r[c].id);var u=!b.collidesWithCurrentCRQ(a)||d.disableCollisionManagement||b.model.addressedCollisions[a.id]?e.changeNonCollisionCss:e.changeCollisionCss;i={start:new DayPilot.Date(new Date(a.scheduledStartDate),(!0)),end:new DayPilot.Date(new Date(a.scheduledEndDate),(!0)),id:a.displayId,text:a.displayId,additionalClassName:u,sort:[s.model.collisionCrqSortWeight+l],changeRequest:_.cloneDeep(a)},n&&(i.resource=n),d.disableCollisionManagement||b.model.addressedCollisions[a.id]||(i.collisionCount=b.collisionCount(a)),o=new DayPilot.Event(i),e.calendar.events.add(o)}}}function A(e){if(b.outageFilterSelected()){var t,a,n,i,o,r=e.resources;a=b.visibleOutages(e.calendar),e.outagesIndex&&r&&(e.outagesIndex>=r.length?(t=e.outagesIndex.toString(),r.push({name:"",id:t})):t=r[e.outagesIndex].id);for(var l=0;l<a.length;l++){n=a[l];var c=b.collidesWithCurrentCRQ(n)&&!d.disableCollisionManagement?e.outageCollisionCss:e.outageNonCollisionCss;i={start:new DayPilot.Date(new Date(n.scheduledStartDate),(!0)),end:new DayPilot.Date(new Date(n.scheduledEndDate),(!0)),id:n.displayId,text:n.displayId,additionalClassName:c,sort:[s.model.collisionOutageSortWeight+l],outage:_.cloneDeep(n)},t&&(i.resource=t),o=new DayPilot.Event(i),e.calendar.events.add(o)}}}function I(e){if(b.businessEventsFilterSelected()){var t,a,n,i,o,r=e.resources;a=b.visibleBusinessEvents(e.calendar),e.businessEventsIndex&&r&&(e.businessEventsIndex>=r.length?(t=e.businessEventsIndex.toString(),r.push({name:"",id:t})):t=r[e.businessEventsIndex].id);for(var l=0;l<a.length;l++){n=a[l];var c=b.collidesWithCurrentCRQ(n)&&!d.disableCollisionManagement?e.businessEventCollisionCss:e.businessEventNonCollisionCss;i={start:new DayPilot.Date(new Date(n.scheduledStartDate),(!0)),end:new DayPilot.Date(new Date(n.scheduledEndDate),(!0)),id:n.id,text:n.title,toolTip:n.title,additionalClassName:c,sort:[s.model.collisionBusinessEventSortWeight+l],businessEvent:_.cloneDeep(n)},t&&(i.resource=t),o=new DayPilot.Event(i),e.calendar.events.add(o)}}}var b=this;s.model=this.model={expanded:!1,calendarViews:["book","day","week","month"],showWeekends:!0,calendarTypes:[{id:"changes",selected:!0},{id:"outages",selected:!0},{id:"businessEvents",selected:!0}],context:s.context,editMode:s.editMode,isNew:s.isNew,currentRequestResourceId:"CurrentCRQ",thisCrqSortWeight:1,collisionCrqSortWeight:10,collisionOutageSortWeight:60,collisionBusinessEventSortWeight:80,addressedCollisions:{},zoomInDisabled:!1,zoomOutDisabled:!1},s.filters={config:angular.copy(d.get("change.collisionFilter")),selected:[]};var k;p.getMetadataByType(EntityVO.TYPE_CHANGE).then(function(e){k=e;var t=_.keyBy(s.filters.config,"name");_.forEach(k.statuses,function(e){t.ticketSpecificStatuses.options.push({name:a("localizeLabel")(e.name,"status",EntityVO.TYPE_CHANGE),type:"constant",criteria:{name:"ticketSpecificStatuses",value:[e.name]}})}),_.forEach(k.priorities,function(e){t.priorities.options.push({name:a("localizeLabel")(e.name,"priority",EntityVO.TYPE_CHANGE),type:"constant",criteria:{name:"priorities",value:[e.name]}})})}),s.getProductCategoriesByCompany=function(e){var t="product",a={entityType:EntityVO.TYPE_CHANGE,categoryType:t,searchText:e,criteria:{company:{name:"%"}}};return u.searchCategories(a).then(function(e){var a=_.find(k.categories,function(e){return e.name===t});return _.map(e.items,function(e){if(e.length){for(var n=_.compact(e).join(" > "),i={},o=0;o<a.listOfTiers.length;o++)i[a.listOfTiers[o].name]=e[o];return{value:n,attributeMap:{categorizations:[{name:t,tiers:i}]}}}})})};var D={resize:{enabled:"Update",disabled:"Disabled"},move:{enabled:"Update",disabled:"Disabled"},select:{enabled:"Enabled",disabled:"Disabled"}};this.handling=D,s.model.selectedCalendarView=s.model.calendarViews[0],s.toggle=function(){s.model.expanded=!s.model.expanded,e.log("change calendar expanded: "+s.model.expanded),s.$emit(t.TOGGLE_CHANGE_CALENDAR,s.model.expanded)},s.isChangeCalendar=!(!l.current.name||l.current.name.indexOf("changeCalendar")===-1),s.$watch("model.selectedCalendarView",function(t){e.log("selected calendar view: "+t),t&&(s.isChangeCalendar?l.go("changeCalendar."+t):l.go("^."+t))}),s.$watch("filters.selected.length",function(){s.isChangeCalendar?s.handleFilterChange():y(!0)}),s.$watch("model.showWeekends",function(t){s.isChangeCalendar&&s.handleShowWeekend(t),e.log("show weekends: "+t)}),s.$watch("model.calendarTypes",function(t){e.log("selected calendar types: "+JSON.stringify(t))},!0),s.$watch("context",function(){s.model.context=s.context}),s.$watch("model.context.scheduledStartDate",function(e,t){s.isChangeCalendar?s.handleDateChangeOnCalendar(e,t,"start"):(y(!1),c(e,t))}),s.$watch("model.context.scheduledEndDate",function(e,t){s.isChangeCalendar?s.handleDateChangeOnCalendar(e,t,"end"):(y(!1),c(e,t))}),s.$watch("model.context.linkedCIs",function(){y(!1)}),s.$watch("model.showWeekends",function(){s.$emit(t.CHANGE_COLLISION_SHOW_WEEKENDS,{showWeekends:s.model.showWeekends})});var R=f.$on(t.CHANGE_COLLISION_STATUS_CHANGED,function(e,t){b.applyAddressedCollisions(t)});s.$on("$destroy",function(){R()}),s.zoom=function(a){e.log("zoom: "+a),s.$broadcast(t.ZOOM_LEVEL_CHANGED,a)},this.rescheduleChangeRequest=function(e,t,n){if(t instanceof Date&&(t=new DayPilot.Date(t,(!0))),n instanceof Date&&(n=new DayPilot.Date(n,(!0))),!(t&&n&&e.lastEventStartDate&&e.lastEventEndDate&&t.equals(e.lastEventStartDate)&&n.equals(e.lastEventEndDate))){var i,o=!1;return e.currentRequestEventId&&(i=e.events.find(e.currentRequestEventId))&&(o=!0,e.events.remove(i)),t&&n?(e.lastEventStartDate=t,e.lastEventEndDate=n,e.currentRequestEventId=DayPilot.guid(),o=!0,i=new DayPilot.Event({start:t,end:n,id:e.currentRequestEventId,sort:[s.model.thisCrqSortWeight],resource:s.model.currentRequestResourceId,text:a("i18n")("create.change.wizard.dates.thisCRQ",s.model.context.displayId?s.model.context.displayId:"").trim()}),e.events.add(i)):(e.lastEventStartDate=null,e.lastEventEndDate=null),o}},this.updateCalendarHandling=function(e){if(s.model.context){var t=n.scheduledStartDateDisabled(s.model.context,s.model.editMode);e.eventResizeHandling=t?D.resize.disabled:D.resize.enabled,e.eventMoveHandling=t?D.move.disabled:D.move.enabled,e.timeRangeSelectedHandling=t?D.select.disabled:D.select.enabled,e.update()}},this.removeEvents=function(e,t){for(var a=e.events.list?e.events.list.slice():[],n=0;n<a.length;n++){var i=e.events.find(a[n].id);t(i)&&e.events.remove(i)}},this.collidesWithCurrentCRQ=function(e){return this.intervalsOverlap({start:s.model.context.scheduledStartDate,end:s.model.context.scheduledEndDate},{start:e.scheduledStartDate,end:e.scheduledEndDate})},this.fitsInCalendarViewport=function(e,t){return this.intervalsOverlap({start:e.visibleStart(),end:e.visibleEnd()},{start:t.scheduledStartDate,end:t.scheduledEndDate})},this.intervalsOverlap=function(e,t){return!!(e.start&&e.end&&t.start&&t.end)&&(e.start=g(e.start),e.end=g(e.end),t.start=g(t.start),t.end=g(t.end),t.end>=e.start&&t.start<=e.end)},this.changeRequestFilterSelected=function(){return s.model.calendarTypes[0].selected},this.outageFilterSelected=function(){return s.model.calendarTypes[1].selected},this.businessEventsFilterSelected=function(){return s.model.calendarTypes[2].selected},this.onEventClicked=function(e){if(e.e.data.changeRequest||e.e.data.outage){var t=$(e.div);if(!e.div.hasTooltop){var a,n=s.$new();t.attr("title",null),e.e.data.changeRequest?(n.changeRequest=e.e.data.changeRequest,a=o('<div class="popover bottom"><div class="arrow"></div><h3 class="popover-title"><change-popover-title></change-popover-title></h3><div class="popover-content"><change-popover-content></change-popover-content></div></div>')(n)):e.e.data.outage&&(n.outage=e.e.data.outage,a=o('<div class="popover bottom"><div class="arrow"></div><h3 class="popover-title"><outage-popover-title></outage-popover-title></h3><div class="popover-content"><outage-popover-content></outage-popover-content></div></div>')(n)),s.$apply();var i=-197,r=3;t.qtip({content:a,show:{event:"click",solo:!0},hide:{event:"click unfocus"},position:{target:"mouse",adjust:{mouse:!1,x:i,y:r}}}),t.qtip("api").show(e.originalEvent),e.div.hasTooltop=!0}}},this.collisionCount=function(e){return this.collidesWithCurrentCRQ(e)?e.additionalInformation&&e.additionalInformation.collisionCount:0},this.displayCollisions=function(e){s.displayingCollisions||(s.displayingCollisions=!0,m(function(){C(e),s.model.collisions&&(O(e),A(e),I(e)),e.updateCalendar(),s.displayingCollisions=!1}))},this.visibleChangeRequests=function(e){return s.model.collisions?_.filter(s.model.collisions.changeRequests,function(t){return b.fitsInCalendarViewport(e,t)}):[]},this.visibleOutages=function(e){return s.model.collisions?_.filter(s.model.collisions.outages,function(t){return b.fitsInCalendarViewport(e,t)}):[]},this.visibleBusinessEvents=function(e){return s.model.collisions?_.filter(s.model.collisions.businessEvents,function(t){return b.fitsInCalendarViewport(e,t)}):[]},this.applyAddressedCollisions=function(e){b.model.addressedCollisions={},_.forEach(e,function(e){b.model.addressedCollisions[e.id]=!e.ciCount})},s.collisions&&s.collisions.changeList&&b.applyAddressedCollisions(s.collisions.changeList),S()}]}}])}(),function(){angular.module("changeModule").directive("calendarMonthView",["$timeout","$log","$locale","$rootScope","events","$state",function(e,t,a,n,i,o){return{restrict:"E",templateUrl:"views/change/calendar-month-view.html",require:"^calendar",scope:{id:"@",viewType:"@"},link:function(r,s,l,c){function d(){c.displayCollisions({calendar:f,resources:r.config.resources,changeCollisionCss:"monthview_event_collision",changeNonCollisionCss:"monthview_event_secondary",outageCollisionCss:"monthview_event_outage_collision",outageNonCollisionCss:"monthview_event_outage_secondary",businessEventCollisionCss:"monthview_event_business_event_collision",businessEventNonCollisionCss:"monthview_event_business_event_secondary",updateCalendar:m})}function u(){e(function(){p(r.model.context.scheduledStartDate,r.model.context.scheduledEndDate)})}function p(e,t){c.rescheduleChangeRequest(f,e,t)&&m()}function m(){var e=r.model.context.scheduledStartDate,a=r.model.context.scheduledEndDate;t.log("update month view: start="+e+", end="+a),e||(e=new Date),"de-de"!==r.config.locale&&"es-es"!==r.config.locale&&"fr-fr"!==r.config.locale||(r.config.weekStarts=1),f.startDate=new DayPilot.Date(e,(!0)),f.update()}var f=r[r.id],g=a.culture,h=a.id+"-"+a.id;g=DayPilot.Locale.find(g)?g:DayPilot.Locale.find(h)?h:"en-us",r.model=c.model,r.isChangeCalendar=o.current.name&&o.current.name.indexOf("changeCalendar")!==-1,r.config={heightSpec:"Full",theme:"monthview",cssClassPrefix:"monthview",weekStarts:0,viewType:r.viewType,weeks:1,sortDirections:["asc"],locale:g,showToolTip:!0,onBeforeHeaderRender:function(e){e.header.html=moment(e.header.dayOfWeek,"d").format("dddd")},onTimeRangeSelected:function(e){r.isChangeCalendar?e.preventDefault():f.timeRangeSelectedHandling!==c.handling.select.disabled&&(f.clearSelection(),r.model.context&&r.model.context.timing&&"Latent"!==r.model.context.timing.name&&(r.model.context.scheduledStartDate=e.start.toDateLocal(),r.model.context.scheduledEndDate=e.end.toDateLocal(),r.$apply()))},onEventMove:function(e){(r.isChangeCalendar||e.e.resource()!==r.model.currentRequestResourceId)&&e.preventDefault()},onEventMoved:function(e){r.model.context.scheduledStartDate=e.newStart.toDateLocal(),r.model.context.scheduledEndDate=e.newEnd.toDateLocal(),r.$apply()},onEventResize:function(e){(r.isChangeCalendar||e.e.resource()!==r.model.currentRequestResourceId)&&e.preventDefault()},onEventResized:function(e){r.model.context.scheduledStartDate=e.newStart.toDateLocal(),r.model.context.scheduledEndDate=e.newEnd.toDateLocal(),r.$apply()},onEventClicked:c.onEventClicked},r.$watch("model.showWeekends",function(){f.showWeekend=r.model.showWeekends,m()}),r.$watch("model.context.scheduledStartDate",function(){u()}),r.$watch("model.context.scheduledEndDate",function(){u()}),r.$watch("model.context",function(){c.updateCalendarHandling(f)},!0),r.$watch("model.collisions",function(){d()},!0),r.$watch("model.calendarTypes",function(){d()},!0);var y=n.$on(i.CHANGE_COLLISION_STATUS_CHANGED,function(e,t){c.applyAddressedCollisions(t),d()});r.$on("$destroy",function(){y()}),m()}}}])}(),function(){angular.module("changeModule").directive("calendarView",["$timeout","$log","dateFilter","$rootScope","events","$locale","$state",function(e,t,a,n,i,o,r){return{restrict:"E",templateUrl:"views/change/calendar-view.html",require:"^calendar",scope:{id:"@",viewType:"@"},link:function(s,l,c,d){function u(){d.displayCollisions({calendar:g,resources:s.config.resources,changeCollisionCss:"calendarview_event_collision",changeNonCollisionCss:"calendarview_event_secondary",outageCollisionCss:"calendarview_event_outage_collision",outageNonCollisionCss:"calendarview_event_outage_secondary",businessEventCollisionCss:"calendarview_event_business_event_collision",businessEventNonCollisionCss:"calendarview_event_business_event_secondary",updateCalendar:f})}function p(){e(function(){m(s.model.context.scheduledStartDate,s.model.context.scheduledEndDate)})}function m(e,t){d.rescheduleChangeRequest(g,e,t)&&f()}function f(){var e=s.model.context.scheduledStartDate,a=s.model.context.scheduledEndDate;t.log("update "+s.viewType+" view: start="+e+", end="+a),e||(e=new Date),g.startDate=new DayPilot.Date(e,(!0)),g.update()}var g=s[s.id];s.model=d.model,s.isChangeCalendar=r.current.name&&r.current.name.indexOf("changeCalendar")!==-1,s.config={heightSpec:"Full",viewType:s.viewType,theme:"calendarview",cssClassPrefix:"calendarview",weekStarts:0,sortDirections:["asc"],onBeforeHeaderRender:function(e){var t="dayAndDate";"en"===window.myitsmLocale&&"en-us"!==o.id.toLowerCase()&&(t="shortDate");var n=a(e.header.start.toDateLocal(),t);"en"===window.myitsmLocale&&"en-us"!==o.id.toLowerCase()&&(n="en-ca"===o.id.toLowerCase()?n.substring(n.indexOf("-")+1):"en-za"===o.id.toLowerCase()?n.substring(n.indexOf("/")+1):n.substring(0,n.lastIndexOf("/"))),e.header.html=n,e.header.toolTip=n},onTimeRangeSelected:function(e){s.isChangeCalendar?e.preventDefault():(g.clearSelection(),s.model.context.scheduledStartDate=e.start.toDateLocal(),s.model.context.scheduledEndDate=e.end.toDateLocal(),s.$apply())},onEventMove:function(e){(s.isChangeCalendar||e.e.resource()!==s.model.currentRequestResourceId)&&e.preventDefault()},onEventMoved:function(e){s.model.context.scheduledStartDate=e.newStart.toDateLocal(),s.model.context.scheduledEndDate=e.newEnd.toDateLocal(),s.$apply()},onEventResize:function(e){(s.isChangeCalendar||e.e.resource()!==s.model.currentRequestResourceId)&&e.preventDefault()},onEventResized:function(e){s.model.context.scheduledStartDate=e.newStart.toDateLocal(),s.model.context.scheduledEndDate=e.newEnd.toDateLocal(),s.$apply()},onEventClicked:d.onEventClicked,onBeforeTimeHeaderRender:function(e){
if(e.header.hasOwnProperty("hours")){var t=e.header.hours;e.header.html.indexOf("AM")!==-1&&12===t?t=0:e.header.html.indexOf("PM")!==-1&&12!==t&&(t+=12),e.header.html=a(moment().hour(t).minute(e.header.minutes).second(0).toDate(),"shortestTime")}}},s.$watch("model.showWeekends",function(){var e="Week",t="WorkWeek";s.viewType===e&&(g.viewType=s.model.showWeekends?e:t,f())}),s.$watch("model.context.scheduledStartDate",function(){p()}),s.$watch("model.context.scheduledEndDate",function(){p()}),s.$watch("model.context",function(){d.updateCalendarHandling(g)},!0),s.$watch("model.collisions",function(){u()},!0),s.$watch("model.calendarTypes",function(){u()},!0);var h=n.$on(i.CHANGE_COLLISION_STATUS_CHANGED,function(e,t){d.applyAddressedCollisions(t),u()});s.$on("$destroy",function(){h()}),f()}}}])}(),function(){angular.module("changeModule").directive("changeDetailsEditor",["events","createTicketService","fieldValidationModel","systemAlertService","i18nService",function(e,t,a,n,i){return{restrict:"E",replace:!0,templateUrl:"views/change/change-details-editor.html",scope:{ticket:"=",metadata:"=",form:"="},link:function(o){function r(){o.editMode=!0,o.ticketCopy=_.cloneDeep(o.ticket),o.updatedInfo={customer:o.ticket.customer,changeReason:o.ticket.changeReason?_.find(o.metadata.changeReasons,function(e){return e.name===o.ticket.changeReason}):"",location:o.ticket.location,timing:_.find(o.metadata.timings,function(e){return e.name===o.ticket.timing}),timingReason:_.find(o.metadata.timingReasons,function(e){return e.name===o.ticket.timingReason})},o.updatedInfo.location.companyName=o.ticket.company.name}function s(){var t=l();o.$emit(e.SAVE_CHANGES_REQUEST,t)}function l(){var e={};return o.updatedInfo.changeReason.name!==o.ticket.changeReason&&(e.changeReason=o.updatedInfo.changeReason.name),o.updatedInfo.customer.id!==o.ticket.customer.id&&(e.customer=o.updatedInfo.customer),o.updatedInfo.location!==o.ticket.location&&(e.location=o.updatedInfo.location),o.ticket.timing!==o.updatedInfo.timing.name&&(e.timing=o.updatedInfo.timing.name),o.updatedInfo.timingReason&&o.updatedInfo.timingReason.name!==o.ticket.timingReason&&(e.timingReason=o.updatedInfo.timingReason.name),e}function c(){o.editMode=!1,o.updatedInfo={}}function d(e,t){_.isEmpty(t)||(o.ticket.changeReason=t.changeReason,o.ticket.customer=t.customer,o.ticket.location=t.location,o.ticket.timing=t.timing,o.ticket.timingReason=t.timingReason,o.ticket.impactedAreas=t.impactedAreas),o.isDatesRequired()&&(o.ticket.scheduledStartDate=o.ticketCopy.scheduledStartDate,o.ticket.scheduledEndDate=o.ticketCopy.scheduledEndDate,o.ticket.actualStartDate=o.ticketCopy.actualStartDate,o.ticket.actualEndDate=o.ticketCopy.actualEndDate,o.ticket.targetDate=o.ticketCopy.targetDate),c()}function u(){o.$broadcast(e.SAVE_CHANGES_COMPLETE),c()}o.ticketCopy=_.cloneDeep(o.ticket),o.siteOptions={company:{visible:!1,attribute:"companyName"},region:{attribute:"region"},siteGroup:{attribute:"siteGroup"},site:{attribute:"name"}},o.clear=function(e){o.updatedInfo[e]=null},o.getListPersons=function(e,a){return o.searchingPersons=!0,t.getListOfPersonsByCompany(e,a).then(function(e){return o.searchingPersons=!1,e[0].items})},o.buildSiteTag=function(e){var t=e.siteGroup?" > "+e.siteGroup:"",a=e.name?" > "+e.name:"",n=e.region?e.region:"";return n+t+a},o.validateRequestedFor=function(){o.updatedInfo.customer.id||(o.updatedInfo.customer=""),o.searchingPersons=!1},o.setChangeLocation=function(){return n.modal({title:i.getLocalizedString("create.change.setRequestedForLocation.title"),text:i.getLocalizedString("create.change.setRequestedForLocation.text"),buttons:[{text:i.getLocalizedString("common.button.yes"),data:!0},{text:i.getLocalizedString("common.button.no"),data:!1}]}).result.then(function(e){if(e){var t=o.updatedInfo.customer.site;t.company=o.ticket.company.name,o.updatedInfo.location=t}})},o.isDatesRequired=function(){return(a.isFieldRequired(o.ticket.type,o.ticket.status.value,o.updatedInfo.timing.name,"scheduledStartDate")||a.isFieldRequired(o.ticket.type,o.ticket.status.value,o.updatedInfo.timing.name,"actualStartDate"))&&(o.ticket.accessMappings.actualdateEditAllowed||o.ticket.accessMappings.scheduleddateEditAllowed)},o.$watch("updatedInfo.timing",function(e){e&&(o.ticketCopy.timing=e.name)}),o.$on(e.SAVE_CHANGES,s),o.$on(e.TOGGLE_EDIT_MODE,r),o.$on(e.SAVE_ALL_CHANGES_COMPLETE,d),o.$on(e.SAVE_ALL_CHANGES_FAULT,u),o.$on(e.DISCARD_CHANGES,c)}}}])}(),function(){angular.module("changeModule").directive("changeImpactedAreas",[function(){return{restrict:"E",replace:!0,templateUrl:"views/change/change-impacted-areas.html",scope:{basicData:"=",parentEditMode:"=",isFullVersion:"="},link:function(e){e.isEditModeAllowed=e.isFullVersion&&e.basicData.accessMappings.impactEditAllowed}}}])}(),function(){angular.module("changeModule").directive("changePopoverContent",[function(){return{restrict:"E",replace:!0,templateUrl:"views/change/change-popover-content.html",link:function(e){e.info=e.changeRequest.additionalInformation,e.assignee=e.changeRequest.additionalInformation.assignee,e.manager=e.changeRequest.additionalInformation.manager,e.assignee.loginId=e.assignee.id,e.manager.loginId=e.manager.id}}}])}(),function(){angular.module("changeModule").directive("changePopoverTitle",[function(){return{restrict:"E",replace:!0,templateUrl:"views/change/change-popover-title.html"}}])}(),function(){angular.module("changeModule").directive("changeProfilePlans",["$q","attachmentService","events","systemAlertService",function(e,t,a,n){return{restrict:"E",replace:!0,templateUrl:"views/change/change-profile-plans.html",scope:{changeRequest:"=context",documentTypes:"=types",editModeAllowed:"=",fromCopyChange:"=?"},link:function(i){function o(){i.types=_.cloneDeep(i.documentTypes),s=_.cloneDeep(i.changeRequest.plans),l=_.keyBy(s,"id");var e=[],a=_.cloneDeep(i.changeRequest.plans);_.each(a,function(a){var n=_.find(i.types,{index:a.workNote.workNoteTypeId}),o=_.find(e,{index:n.index});return a.attachments=t.normalizeAttachments(a),a.desc=a.workNote.notes,a.label=n.label,_.each(a.attachments,function(e){e.pendingSave=!0}),o?o.plans.push(a):(n.active=!0,n.activePlanIndex=0,n.plans=[a],a.workNote&&a.workNote.locked&&(n.isLocked=!0),e.push(n)),a}),i.changeRequest.documents=e,i.state.hideControlButtons=!e.length}function r(e){var t={},a=_.groupBy(e,function(e){return e.workNote.workNoteTypeId});return _.each(e,function(e){a[e.workNote.workNoteTypeId].length>1?(t[e.workNote.workNoteTypeId]?t[e.workNote.workNoteTypeId]++:t[e.workNote.workNoteTypeId]=1,e.typeIndex=t[e.workNote.workNoteTypeId]):1===a[e.workNote.workNoteTypeId].length&&e.typeIndex&&(e.typeIndex=null)}),_.sortBy(e,function(e){return e.workNote.workNoteTypeId})}var s,l;i.state={processing:!1,hideControlButtons:!1},i.isChild=!1,i.editMode=!1,i.showDocumentViewer=function(e){i.$parent.ticketActions.showAttachmentPreviewer(e)},i.editPlans=function(){o(),i.editMode=!0,i.$emit(a.DISABLE_PARENT_EDITMODE,!0),i.$emit(a.DISABLE_EDITMODE,!0)},i.cancelEdit=function(){i.changeRequest.plans=s,i.editMode=!1,i.types=i.documentTypes,i.changeRequest.documents=[],i.$emit(a.DISABLE_PARENT_EDITMODE,!1),i.$emit(a.DISABLE_EDITMODE,!1)},i.$on(a.DISABLE_EDITCHILD,function(e,t){i.editModeAllowed=!0,i.isChild=t}),i.updatePlans=function(){var o=[];return i.state.processing=!0,_.each(i.changeRequest.documents,function(e){_.each(e.plans,function(a){if(a.desc||a.attachments.length){var n={text:a.desc,type:e.index,locked:!1,access:!0,attachments:[],attachmentInfos:[]};if(_.each(a.attachments,function(e){e.id||(n.attachments.push(e),n.attachmentInfos.push({name:e.name,action:"add"}))}),a.id){var r=l[a.id];_.each(r.attachmentInfos,function(e){var t=_.find(a.attachments,function(t){return!!t.attachmentReference&&t.attachmentReference.attachmentId===e.attachmentReference.attachmentId});t||n.attachmentInfos.push({name:e.name,attachmentId:e.attachmentReference.attachmentId,action:"delete"})}),(a.workNote.notes!==n.text||n.attachmentInfos.length>0)&&o.push(t.updateChangePlan({parentId:i.changeRequest.id,id:a.id,type:i.$parent.type},n))}else o.push(t.createChangePlan(i.changeRequest.id,i.$parent.type,n))}})}),_.each(s,function(e){var a,n=_.find(i.changeRequest.documents,{index:e.workNote.workNoteTypeId});n&&(a=_.find(n.plans,{id:e.id})),n&&a||(o.push(t.deletePlan(i.changeRequest.id,i.$parent.type,e.id)),_.remove(i.changeRequest.plans,{id:e.id}))}),e.all(o)["finally"](function(){i.state.processing=!1,i.editMode=!1,i.$emit(a.DISABLE_PARENT_EDITMODE,!0),i.$emit(a.DISABLE_EDITMODE,!1)}).then(function(e){_.each(e,function(e){var t=e&&e.data&&e.data[0];if(e&&"deleted"!==e.action){var a=_.find(i.documentTypes,{index:t.workNote.workNoteTypeId});if(t.workNote.documentType=a,"created"===e.action)i.changeRequest.plans.push(e.data[0]);else if("updated"===e.action){var n=_.find(i.changeRequest.plans,{id:e.data[0].id}),o=i.changeRequest.plans.indexOf(n);e.data[0].workNote.documentType=a,o>=0?i.changeRequest.plans[o]=e.data[0]:(_.remove(i.changeRequest.plans,{id:e.data[0].id}),i.changeRequest.plans.push(e.data[0]))}}}),i.changeRequest.plans=r(i.changeRequest.plans),i.$parent.refreshTicket()})["catch"](function(e){e&&n.error({text:e.data&&e.data.error||e,clear:!1})})},i.$on(a.CHANGE_REQUEST_PLANS_EDIT_STATUS,function(e,t){i.state.hideControlButtons=t.hideButtons,i.showSave=t.showSave})}}}])}(),function(){angular.module("changeModule").directive("changeTasks",["ticketModel","relationModel","userModel","$q","$filter","$modal","events","$timeout","$state","i18nService","systemAlertService","objectValueMapperService","pwaModel",function(e,t,a,n,i,o,r,s,l,c,d,u,p){return{restrict:"E",templateUrl:"views/change/change-tasks.html",scope:{ticket:"=",relationCounters:"=",tasksDisabled:"="},link:function(n,m){function f(e,t){"Assigned"===e.realObject.status.value&&t.push(e.realObject.mainSequence)}function g(e){var t=[];return _.forEach(e,function(e){e.length?_.forEach(e,function(e){f(e,t)}):f(e,t)}),t}function h(e){var t=!0;return _.forEach(e,function(e){e.length?t=h(e):"Staged"!==e.realObject.status.value&&"Cancelled"!==e.realObject.status.reason&&"Pending"!==e.realObject.status.value&&(t=!1)}),t}function y(e,t){e.realObject.childSequence=t+"."+e.realObject.sequence}function E(){n.$on("$stateChangeStart",function(e,t,a){if(n.dirty){e.preventDefault();var i=d.modal({title:c.getLocalizedString("common.notification.dirty.title"),text:c.getLocalizedString("common.notification.dirty.message"),buttons:[{text:c.getLocalizedString("common.notification.dirty.button1"),data:{stateName:t.name,stateParams:a}},{text:c.getLocalizedString("common.notification.dirty.button2")}]});i.result.then(function(e){_.isEmpty(e)||(n.dirty=!1,l.transitionTo(e.stateName,e.stateParams))})}})}function v(){p.taskFrom="Scratch",e.taskParent=n.ticket;var t=o.open({templateUrl:"views/create/create-taskPV-v2.html",controller:"PwaTicketController",windowClass:"ticket__open-modal",backdrop:!1,keyboard:!1});t.result.then(function(){b(),m.find("button.profile-relation__add-relation-button").focus(),n.$emit(r.TICKET_PROFILE_RESEND_EVENT,{eventName:r.REFRESH_ACTIVITY_FEED}),n.$emit(r.RELATIONS_UPDATE_COMPLETE,!0)},function(){m.find("button.profile-relation__add-relation-button").focus()});var a=n.$on(r.PWA_TASK_MODAL,function(e,n){n.taskCreated?t.close():t.dismiss(),a()})}function T(){e.taskParent=n.ticket,u.shelveAsParent(n.ticket.type);var t=o.open({templateUrl:"views/create/create-task-v2.html",controller:"CreateTaskV2Controller",windowClass:"ticket__open-modal",backdrop:!1,keyboard:!1});t.result.then(function(){u.unshelveParent(n.ticket.type),b(),m.find("button.profile-relation__add-relation-button").focus(),n.$emit(r.TICKET_PROFILE_RESEND_EVENT,{eventName:r.REFRESH_ACTIVITY_FEED}),n.$emit(r.RELATIONS_UPDATE_COMPLETE,!0)},function(){u.unshelveParent(n.ticket.type),m.find("button.profile-relation__add-relation-button").focus()})}function S(){p.taskFrom="Template",e.taskParent=n.ticket;var t=o.open({templateUrl:"views/create/create-taskPV-v2.html",windowClass:"action-blade",controller:"PwaTicketController",backdrop:"custom"});t.result.then(function(){b(),m.find("button.profile-relation__add-relation-button").focus(),n.$emit(r.TICKET_PROFILE_RESEND_EVENT,{eventName:r.REFRESH_ACTIVITY_FEED})},function(){m.find("button.profile-relation__add-relation-button").focus()});var a=n.$on(r.PWA_TASK_MODAL,function(e,n){n.taskCreated?t.close():t.dismiss(),a()})}function C(){e.taskParent=n.ticket;var t=o.open({templateUrl:"views/template/browse-task-template-action-blade.html",windowClass:"action-blade",controller:"BrowseTaskTemplateController",backdrop:"custom",resolve:{isFromBrowseTemplate:function(){return!1}}});t.result.then(function(){b(),m.find("button.profile-relation__add-relation-button").focus(),n.$emit(r.TICKET_PROFILE_RESEND_EVENT,{eventName:r.REFRESH_ACTIVITY_FEED})},function(){m.find("button.profile-relation__add-relation-button").focus()})}function O(e){return n.currentTaskPhase=e,e&&"All"===e.guid?(n.relatedTasks=_.cloneDeep(n.relatedTasksCopy),void I()):void(n.relatedTasks=_.filter(_.cloneDeep(n.relatedTasksCopy),function(e){return e.realObject&&e.realObject.phaseGuid===n.currentTaskPhase.guid||e[0]&&e[0].realObject.phaseGuid===n.currentTaskPhase.guid}))}function A(){e.getTaskPhases(n.ticket.company.name,!0).then(function(e){try{var t=_.find(n.allTaskPhases,{guid:"All"});t||e.unshift({name:i("i18n")("resourceSlice.task.phaseFilter.allTaskPhases.label"),guid:"All"})}catch(a){}n.showPhaseFilter=!0,n.allTaskPhases=_.uniqBy(e,"guid"),n.currentTaskPhase=_.find(n.allTaskPhases,{guid:n.ticket.taskPhaseId}),n.ticket.taskPhaseName=n.currentTaskPhase.name,n.filterTasksByPhase(n.currentTaskPhase)})}function I(){n.phaseTaskGroups=[],_.forEach(n.allTaskPhases,function(e){var t=_.filter(n.relatedTasks,function(t){return t.length?t[0].realObject.phaseGuid===e.guid:t.realObject.phaseGuid===e.guid});t.length&&(t.sort(function(e,t){return(e.length?e[0].realObject.mainSequence:e.realObject.mainSequence)-(t.length?t[0].realObject.mainSequence:t.realObject.mainSequence)}),n.phaseTaskGroups.push(t),R.phaseItemsLimit.push(_.clone(R.itemsLimit)))})}function b(){R.processing=!0,t.refreshRelations(k.id,k.type)["finally"](function(){R.processing=!1})}n.userModel=a;var k=n.ticket,D=[],R={loadingTaskResources:!k.isDraft,itemsLimit:4,phaseItemsLimit:[],processing:!1,showing:!1};n.showPhaseFilter=!1,n.relations=t.cache,E(),n.$watch("relations",function(){if(n.relatedTasks=_.sortBy(_.filter(_.cloneDeep(n.relations[k.id]),{type:EntityVO.TYPE_TASK}),function(e){return e.realObject.phaseGuid})||[],n.originalTasks=_.cloneDeep(n.relatedTasks),n.relatedTasks.length){var e=[],t=[];_.forEach(n.relatedTasks,function(a,n,i){if(a.editable=!(!k.accessMappings.relationsEditAllowed||k.accessMappings.tasksEditAllowed===!1||"Staged"!==a.realObject.status.value),a.realObject.taskGroupId){a.realObject.nestedTaskGroup&&(a.editable=!1),a.realObject.taskGroupType||(a.realObject.taskGroupType=a.realObject.sequence?"Sequencing":"Standard"),a.realObject.sequence=a.realObject.sequence?a.realObject.sequence:1,a.realObject.childSequence=a.realObject.mainSequence+"."+a.realObject.sequence;var o=_.find(t,function(e){return e.realObject.taskGroupId===a.realObject.taskGroupId});0===t.length||t.length&&o?t.push(a):(e.push(t),t=[],t.push(a)),n===i.length-1&&e.push(t)}else t.length&&(e.push(t),t=[]),e.push(a)}),n.relatedTasks=e,D=angular.copy(n.relatedTasks)}n.ticket.taskPhaseId&&(n.relatedTasksCopy=_.cloneDeep(n.relatedTasks),A()),n.relationCounters&&(n.relationCounters.tasks=n.relatedTasks.length)},!0),n.parentSortableOptions={placeholder:"profile-relation__item-task-container",connectWith:".profile-relation__task-container",cancel:":input,.locked,.profile-relation__group-title",update:function(e,t){R.showing=!1;var a=g(t.item.sortable.droptargetModel),o=t.item.sortable.droptargetModel[t.item.sortable.dropindex],r=1;r=o.length?o[0].realObject.mainSequence:o.realObject.mainSequence;var l=!0;_.forEach(a,function(e){if(r>=e)return l=!1,!1}),0===a.length&&(l=!1),0===a.length&&h(t.item.sortable.droptargetModel)&&(l=!1);var c=null;if(n.ticket.taskPhaseId){var u=t.item.sortable.model.length?t.item.sortable.model[0].realObject.phaseGuid:t.item.sortable.model.realObject.phaseGuid;c=_.find(t.item.sortable.droptargetModel,function(e){return e.length&&(e=e[0]),u!==e.realObject.phaseGuid})}!l&&!c||R.showing||(R.showing=!0,s(function(){n.draftNotificationInstance=d.warning({text:l?i("i18n")("ticket.relatedTasks.closed.label"):i("i18n")("ticket.relatedTasks.phaseChange.label"),hide:1e4}),n.draftNotificationInstance.result["finally"](function(){n.draftNotificationInstance=null,R.showing=!1})},500),t.item.sortable.cancel())},stop:function(e,t){if(!R.showing){var a=_.cloneDeep(t.item.sortable.sourceModel),i=_.find(a,function(e,a){return e.length&&(e=e[0]),t.item.sortable.dropindex<a&&t.item.sortable.model.id!==e.id&&"Assigned"===e.realObject.status.value});i&&i.length&&(i=i[0]);var o=1;_.forEach(a,function(e,n){var r=!1,s=null;n+1!==a.length&&(s=a[n+1].length?a[n+1][0]:a[n+1]),e.length?(s&&e[0].realObject.mainSequence===s.realObject.mainSequence&&(t.item.sortable.model.length?t.item.sortable.model[0].id:t.item.sortable.model.id)!==s.id&&(r=!0),_.forEach(e,function(a,r){t.item.sortable.model.id===a.id&&"Staged"!==a.realObject.status.value&&(a.realObject.status.value="Staged"),"Staged"===a.realObject.status.value&&(a.realObject.mainSequence=o,!i||n!==t.item.sortable.dropindex||0!==r&&a.realObject.sequence!==e[0].realObject.sequence||(a.realObject.mainSequence=i.realObject.mainSequence,a.realObject.status.value="Pending"),a.realObject.childSequence=a.realObject.mainSequence+"."+a.realObject.sequence)}),o=r?e[0].realObject.mainSequence:e[0].realObject.mainSequence+1):(s&&e.realObject.mainSequence===s.realObject.mainSequence&&(t.item.sortable.model.length?t.item.sortable.model[0].id:t.item.sortable.model.id)!==s.id&&(r=!0),t.item.sortable.model.id===e.id&&"Staged"!==e.realObject.status.value&&(e.realObject.status.value="Staged"),"Staged"===e.realObject.status.value&&(e.realObject.mainSequence=o,i&&n===t.item.sortable.dropindex&&(e.realObject.mainSequence=i.realObject.mainSequence,e.realObject.status.value="Pending")),o=r?e.realObject.mainSequence:e.realObject.mainSequence+1)}),n.ticket.taskPhaseId?("All"===n.currentTaskPhase.guid?_.forEach(n.relatedTasks,function(e,t){e.length&&(e=e[0]),_.forEach(a,function(a){e.id===(a.length?a[0].id:a.id)&&(n.relatedTasks[t]=a)})}):n.relatedTasks=a,I()):n.relatedTasks=a,n.dirty=!0}}},n.childSortableOptions={placeholder:"profile-relation__item-task-child",connectWith:".profile-relation__task-group-container",cancel:":input,.locked",update:function(e,t){var a=_.find(t.item.sortable.sourceModel,function(e,a){return t.item.sortable.dropindex<=a&&t.item.sortable.model.id!==e.id&&("Closed"===e.realObject.status.value||"Bypassed"===e.realObject.status.value)}),o=!1;t.item.sortable.model.realObject.taskGroupId!==t.item.sortable.droptargetModel[0].realObject.taskGroupId&&(o=!0),!a&&!o||R.showing||(R.showing=!0,s(function(){n.draftNotificationInstance=d.warning({text:a?i("i18n")("ticket.relatedTasks.closed.label"):i("i18n")("ticket.relatedTasks.groupChange.label"),hide:1e4}),n.draftNotificationInstance.result["finally"](function(){n.draftNotificationInstance=null,R.showing=!1})},500),t.item.sortable.cancel())},stop:function(e,t){if(!R.showing){var a,i=_.cloneDeep(t.item.sortable.sourceModel),o=_.find(i,function(e,a){return t.item.sortable.dropindex<a&&t.item.sortable.model.id!==e.id&&"Staged"!==e.realObject.status.value}),r=1;_.forEach(i,function(e,n){var s=!1,l=null;n+1!==i.length&&(l=i[n+1]),l&&e.realObject.sequence===l.realObject.sequence&&t.item.sortable.model.id!==l.id&&(s=!0),t.item.sortable.model.id===e.id&&(a=n,"Staged"!==e.realObject.status.value&&(e.realObject.status.value="Staged")),"Staged"===e.realObject.status.value&&(e.realObject.sequence=r,o&&n===t.item.sortable.dropindex&&(e.realObject.sequence=o.realObject.sequence,e.realObject.status.value="Pending"),e.realObject.childSequence=e.realObject.mainSequence+"."+e.realObject.sequence),r=s?e.realObject.sequence:e.realObject.sequence+1}),_.forEach(n.relatedTasks,function(e,o){e.length&&e[a]&&e[a].id===t.item.sortable.model.id&&(n.relatedTasks[o]=i)}),n.ticket.taskPhaseId&&I(),n.dirty=!0}}},n.updateTaskSequence=function(e){e.realObject.mainSequence<=0||isNaN(e.realObject.mainSequence)||_.isEmpty(e.realObject.mainSequence)?e.realObject.mainSequence=1:e.realObject.mainSequence=parseInt(e.realObject.mainSequence),"Staged"!==e.realObject.status.value&&(e.realObject.status.value="Staged");var t=angular.copy(n.relatedTasks),a=g(t);_.forEach(a,function(t){if(e.realObject.mainSequence<t)return e.realObject.mainSequence=t,!1});var i=_.find(t,function(t){return t.length&&(t=t[0]),e.realObject.mainSequence<=t.realObject.mainSequence&&"Closed"!==t.realObject.status.value&&"Bypassed"!==t.realObject.status.value&&"Staged"!==t.realObject.status.value});i&&(e.realObject.status.value="Pending",e.realObject.mainSequence=i.length?i[0].realObject.mainSequence:i.realObject.mainSequence);var o=_.findIndex(t,function(t){return t.length&&(t=t[0]),e.id===t.id});t[o]=e,t.sort(function(e,t){return(e.length?e[0].realObject.mainSequence:e.realObject.mainSequence)-(t.length?t[0].realObject.mainSequence:t.realObject.mainSequence)}),s(function(){n.relatedTasks=t,n.ticket.taskPhaseId&&I()},2e3),n.dirty=!0},n.updateParentSequence=function(e){e[0].realObject.mainSequence<=0||isNaN(e[0].realObject.mainSequence)||_.isEmpty(e[0].realObject.mainSequence)?e[0].realObject.mainSequence=1:e[0].realObject.mainSequence=parseInt(e[0].realObject.mainSequence),"Staged"!==e[0].realObject.status.value&&(e[0].realObject.status.value="Staged");var t=angular.copy(n.relatedTasks),a=e[0].realObject.mainSequence,i=g(t),o=!1;_.forEach(i,function(t){if(e[0].realObject.mainSequence<=t)return a=t,o=!0,!1});for(var r=0;r<e.length;)e[r].realObject.mainSequence=a,r++;i&&i.length&&o&&(e[0].realObject.status.value="Pending",e[0].realObject.mainSequence=i[0]);var l=e[0].realObject.mainSequence,c=l+"."+e[0].realObject.sequence,d=e[0].realObject.status.value,u=e[0].editable;_.forEach(e,function(e){e.realObject.mainSequence=l,e.realObject.childSequence=l+"."+e.realObject.sequence,c===e.realObject.childSequence&&(e.realObject.status.value=d,e.editable=u)});var p=_.findIndex(t,function(t){return t.length&&(t=t[0]),e[0].id===t.id});t[p]=e,t.sort(function(e,t){return(e.length?e[0].realObject.mainSequence:e.realObject.mainSequence)-(t.length?t[0].realObject.mainSequence:t.realObject.mainSequence)}),s(function(){n.relatedTasks=t,n.ticket.taskPhaseId&&I()},2e3),n.dirty=!0},n.updateChildSequence=function(e,t,a,i){function o(){s(function(){var e=m.find("#"+a);e[0].focus()})}var r=t.realObject.childSequence.split("."),l=r[0],c=r[1],d=(t.realObject.childSequence.match(/\./g)||[]).length;if(!l||1!==d)return void y(t,i);if(c&&1===d){t.realObject.mainSequence=i,t.realObject.sequence=isNaN(c)||_.isEmpty(c)||c<=0?t.realObject.sequence:parseInt(c),"Staged"!==t.realObject.status.value&&(t.realObject.status.value="Staged");var u=_.find(e,function(e){return t.realObject.sequence<=e.realObject.sequence&&("Closed"===e.realObject.status.value||"Bypassed"===e.realObject.status.value)});u&&(t.realObject.sequence=u.realObject.sequence+1);var p=_.find(e,function(e){return t.realObject.sequence<=e.realObject.sequence&&"Closed"!==e.realObject.status.value&&"Bypassed"!==e.realObject.status.value&&"Staged"!==e.realObject.status.value});p&&(t.realObject.status.value="Pending",t.realObject.sequence=p.realObject.sequence);var f=t.realObject.mainSequence,g=f+"."+t.realObject.sequence,h=t.realObject.status.value;_.forEach(e,function(e){e.realObject.mainSequence=f,e.realObject.childSequence=f+"."+e.realObject.sequence,g===e.realObject.childSequence&&(e.realObject.status.value=h)});var E=angular.copy(n.relatedTasks),v=_.findIndex(E,function(t){return t.length&&(t=t[0]),e[0].id===t.id});e=_.sortBy(angular.copy(e),"realObject.sequence"),E[v]=e,E.sort(function(e,t){return(e.length?e[0].realObject.mainSequence:e.realObject.mainSequence)-(t.length?t[0].realObject.mainSequence:t.realObject.mainSequence)}),s(function(){n.relatedTasks=E,o(),n.ticket.taskPhaseId&&I()},2e3),n.dirty=!0}else n.dirty=!1},n.setFocus=function(e){n.focusTarget=e.target,n.focusTarget.focus()},n.onSaveClick=function(){var e=[];_.forEach(n.relatedTasks,function(t){if(t.length)_.forEach(t,function(t){var a=_.find(n.originalTasks,function(e){return e.id===t.id});if(a.realObject.mainSequence!==t.realObject.mainSequence||a.realObject.sequence!==t.realObject.sequence){var i=null;"Sequencing"===t.realObject.taskGroupType&&a.realObject.sequence!==t.realObject.sequence&&(i=t.realObject.sequence);var o={parentId:t.parentId,parentType:t.realObject.parentType,parentName:t.realObject.parentName,parentDisplayId:t.realObject.parentDisplayId,company:t.realObject.company,taskGroupId:t.realObject.taskGroupId,mainSequence:t.realObject.mainSequence,sequence:i,id:t.id};e.push(o)}});else{var a=_.find(n.originalTasks,function(e){return e.id===t.id});if(a.realObject.mainSequence!==t.realObject.mainSequence){var i={parentId:t.parentId,parentType:t.realObject.parentType,parentName:t.realObject.parentName,parentDisplayId:t.realObject.parentDisplayId,company:t.realObject.company,mainSequence:t.realObject.mainSequence,sequence:t.realObject.mainSequence,id:t.id};e.push(i)}}}),e.length&&(R.processing=!0,t.updateTaskSequence(e).then(function(t){var a=angular.copy(_.flatten(n.relatedTasks));_.forEach(t,function(e){var t=_.find(a,{id:e.responseObject.id});"Success"===e.statusInfo.type&&e.responseObject.id===t.id&&(t.realObject.status.value=e.responseObject.status.value,t.realObject.sequence=e.responseObject.sequence,"Staged"!==t.realObject.status.value&&(t.editable=!1))}),n.originalTasks=e,n.showPhaseFilter&&I()})["catch"](function(e){d.error({text:e.data.error,clear:!1})})["finally"](function(){R.processing=!1,n.dirty=!1}))},n.onRevertClick=function(){n.ticket.taskPhaseId?(n.dirty=!1,n.filterTasksByPhase(n.currentTaskPhase),"All"!==n.currentTaskPhase.guid&&(n.phaseTaskGroups=n.relatedTasks)):(n.dirty=!1,n.relatedTasks=angular.copy(D))},k.isDraft||t.getRelations(k.id,k.type)["finally"](function(){R.loadingTaskResources=!1}),n.createBlankTask=function(){if(n.dirty){var e=d.modal({title:c.getLocalizedString("common.notification.dirty.title"),text:c.getLocalizedString("common.notification.dirty.message"),buttons:[{text:c.getLocalizedString("common.notification.dirty.button1"),data:!0},{text:c.getLocalizedString("common.notification.dirty.button2"),data:!1}]});e.result.then(function(e){e&&(n.dirty=!1,p.isPwaEnabled()?v():T())})}else p.isPwaEnabled()?v():T()},n.getURLforTaskFlow=function(){R.processing=!0;var t=k.id,a={rootRequestId:k.displayId,taskParentType:k.type,summary:k.summary};n.currentTaskPhase&&n.currentTaskPhase.guid&&n.currentTaskPhase.name&&"All"!==n.currentTaskPhase.guid&&angular.extend(a,{phaseName:n.currentTaskPhase.name,phaseGUID:n.currentTaskPhase.guid}),e.getURLforTaskFlow(t,a)["finally"](function(){R.processing=!1})},n.createTaskFromTemplate=function(){if(n.dirty){var e=d.modal({title:c.getLocalizedString("common.notification.dirty.title"),text:c.getLocalizedString("common.notification.dirty.message"),buttons:[{text:c.getLocalizedString("common.notification.dirty.button1"),data:!0},{text:c.getLocalizedString("common.notification.dirty.button2"),data:!1}]});e.result.then(function(e){e&&(n.dirty=!1,p.isPwaEnabled()?S():C())})}else p.isPwaEnabled()?S():C()},n.filterTasksByPhase=function(e){if(n.dirty){var t=d.modal({title:c.getLocalizedString("common.notification.dirty.title"),text:c.getLocalizedString("common.notification.dirty.message"),buttons:[{text:c.getLocalizedString("common.notification.dirty.button1"),data:{phase:e}},{text:c.getLocalizedString("common.notification.dirty.button2")}]});t.result.then(function(e){_.isEmpty(e)||(n.dirty=!1,O(e.phase))})}else O(e)},n.navigateToPerson=function(e,t){e.preventDefault(),e.stopPropagation(),l.go("person",{id:i("escape")(t)})},n.state=R}}}])}(),function(){angular.module("changeModule").directive("changeWizard",[function(){return{restrict:"E",replace:!0,templateUrl:"views/change/change-wizard.html"}}])}(),function(){angular.module("changeModule").directive("changeWizardTab",[function(){return{restrict:"E",replace:!0,scope:{tabid:"=",title:"@",icon:"@",selectedtab:"=",valid:"&"},templateUrl:"views/change/change-wizard-tab.html",controller:["$scope",function(e){e.logInvalidFields=function(){var e=$("form[name=basics]").find(".ng-invalid").toArray();console.log("Basic Form Invalid Fields "),e.forEach(function(e){console.log("Name: "+e.name+" ux-id: "+e.getAttribute("ux-id"))})}}]}}])}(),function(){angular.module("changeModule").directive("ciRelations",["assetService","categoriesService","configurationModel","userModel","$q","metadataModel","$filter","ciRelationsModel","events","systemAlertService","$timeout","$rootScope","assetConsoleModel","consoleService","relationModel",function(e,t,a,n,i,o,r,s,l,c,d,u,p,m,f){return{restrict:"E",replace:!0,templateUrl:"views/change/ci-relations.html",scope:{company:"=company",model:"=",displayLimit:"=displaylimit",parent:"@parent",context:"="},controller:["$scope","$modal",function(e,p){function g(t){var a=_.find(e.model.searches,function(e){return 0===e.selectedFilters.length&&0===e.searchKeywords.length});e.chunkInfos[t]={chunkInfo:{startIndex:0,chunkSize:100}},a||(e.model.searches.push({config:angular.copy(e.filterConfig),selectedFilters:[],searchKeywords:[],showResults:!1,selectedCount:0,linkedCount:null,isSearching:!1,sortInfo:{fields:[],directions:[],columns:[]},criteria:{sortInfo:[]},selectedItems:[],relationsMap:[],results:[],gridColumns:[],tableColumns:[{attributeName:"name",displayName:r("i18n")("asset.attributes.name"),visible:!0},{attributeName:"classId",displayName:r("i18n")("asset.attributes.classId"),visible:!0},{attributeName:"type",displayName:r("i18n")("asset.attributes.type"),visible:!0},{attributeName:"status.value",displayName:r("i18n")("asset.status"),visible:!0},{attributeName:"assetExtension.serialNumber",displayName:r("i18n")("asset.attributes.serialNumber"),visible:!0},{attributeName:"site.name",displayName:r("i18n")("asset.attributes.site"),visible:!0},{attributeName:"product.name",displayName:r("i18n")("asset.attributes.productName"),visible:!0}]}),e.model.searches[t].gridColumns=angular.copy(_.sortBy(_.filter(s.columnsConfig,"visible"),"order")),window.isRtl&&e.model.searches[t].gridColumns.reverse(),e.model.searches[t].gridOptions={data:"model.searches["+t+"].results",index:t,headerRowHeight:43,rowHeight:40,sortInfo:e.model.searches[t].sortInfo,useExternalSorting:!0,enableColumnResize:!0,showSelectionCheckbox:!0,virtualizationThreshold:100,selectWithCheckboxOnly:!0,checkboxHeaderTemplate:'<label class="ngSelectionHeaderLabel"><input class="ngSelectionHeader" type="checkbox" ng-show="multiSelect" ng-model="allSelected" ng-change="selectAllCIs(search,allSelected, \'grid\')"/></label>',selectedItems:e.model.searches[t].selectedItems,afterSelectionChange:function(a){a.length?_.forEach(a,function(a){e.selectCI(e.model.searches[t],a,"grid")}):e.selectCI(e.model.searches[t],a,"grid")},columnDefs:e.model.searches[t].gridColumns})}function h(e,t){var a,n,i={},o="sites",r=[],s={},l={},c={};return _.forEach(e,function(t){var d=t.criteria,u=_.isArray(d.value),p=d.name;i[p]?u?i[p]=_.union(i[p],d.value):(e.splice(_.findIndex(e,{name:t.name}),1),i[p]=d.value):"region"===d.name||"siteGroup"===d.name||"sites"===d.name?("region"===d.name?(a=d.name,s=d.value[0],s.id=a,r.push(s)):"siteGroup"===d.name?(n=d.name,l=d.value[0],l.id=n,r.push(l)):"sites"===d.name&&(c=d.value[0],r.push(c)),i[o]=r):i[p]=d.value}),t&&t.length>0&&(t=_.map(t.split(","),_.trim),i.keywords=t),i}e.currentRelatedCIs=[],e.currentRelatedCIsData=[],e.getTableStyle=function(){var t=43,a=40;return{height:e.currentRelatedCIs.length*t+a+"px","border-left":"1px solid #d4d4d4",
"border-right":"1px solid #d4d4d4",overflow:"hidden"}},e.context&&e.context.id&&(e.selectedItems=[],e.relatedCIgridOtions={headerRowHeight:43,rowHeight:40,showSelectionCheckbox:!0,selectWithCheckboxOnly:!0,selectedItems:e.selectedItems,enableColumnResize:!0,data:"currentRelatedCIsData",columnDefs:[{field:"name",displayName:r("i18n")("asset.attributes.name"),cellTemplate:'<div class="ngCellText ci-search-section__results_name_col" ng-class="col.colIndex()"><a href="" ng-click= "showPreview(row.entity);" class="ci-search-section__results_name_col"><span class="ngCellText ci-search-section__results_name_col">{{row.getProperty(col.field)}}</span></a></div>'},{field:"status.value",displayName:r("i18n")("asset.status")},{field:"assetType",displayName:r("i18n")("asset.attributes.type")},{field:"manufacturer",displayName:r("i18n")("asset.attributes.manufacturer")},{field:"model",displayName:r("i18n")("asset.attributes.model")},{field:"related",displayName:r("i18n")("asset.attributes.related")}]},f.getRelations(e.context.id,e.context.type).then(function(t){e.currentRelatedCIs=t,_.each(t,function(t){var a=t.realObject;a.relationshipType=t.relationshipType,a.related=r("i18n")("common.relationship.type."+t.relationshipType),a.ticketType=t.type,a.desc=t.desc,a.tag=t.tag,e.currentRelatedCIsData.push(a)}),e.model.templateRelatedCIsData=e.currentRelatedCIsData})),e.showCINameAsLink="changeWizard"===e.parent,e.chunkInfos=[],e.userModel=n,e.selections={relations:["relatedto","upgrades","repairs","impacts","installs","moves","changes","removes"]},e.searchTextCharLimit=0;var y,E,v;e.filterConfig=angular.copy(a.get("ciSearch.assetConsoleFilter")),E=_.keyBy(e.filterConfig,"label"),e.filterPreferenceGroup="CIFilter";var T=n.getUserPreferences(e.filterPreferenceGroup).then(function(t){e.userSavedSearchPresets=_.uniqBy(t,"name")||[];var a=_.findIndex(e.filterConfig,{name:"custom"});_.forEach(e.userSavedSearchPresets,function(t){if(!t.systemgenerated){var n={name:t.name,id:t.id,type:"custom",filters:_.map(t.value,function(e){var t,a,n,i;a=e.option,E[e.filter]?i=_.find(E[e.filter].options,{name:e.option}):"sites"===e.filter&&E.site&&(i=_.find(E.site.options,{name:e.option})),t=e.realOption&&e.realOption.criteria?e.realOption.criteria.value:i&&i.criteria?i.criteria.value:e;var o={active:!0,criteria:{name:e.filter,value:t},name:a,label:n,type:"keywords"!==e.filter?"dynamic":"keywords"};return o})};a!==-1&&"allAssets"!==n.id&&(e.filterConfig[a].expanded=!0,e.filterConfig[a].options.push(n))}})}),S=n.getFullCurrentUserData().then(function(){var e=n.userFullData,t=_.find(E.approvedBy.options,{label:"me"}),a=_.find(E.createdBy.options,{label:"me"}),i=_.find(E.managedBy.options,{label:"me"}),o=_.find(E.owner.options,{label:"me"}),r=_.find(E.supportedBy.options,{label:"me"}),s=_.find(E.usedBy.options,{label:"me"});t.subLabel=a.subLabel=i.subLabel=o.subLabel=r.subLabel=s.subLabel=e.fullName,t.criteria.value=a.criteria.value=i.criteria.value=o.criteria.value=r.criteria.value=s.criteria.value=[{id:e.personId}];var l=_.find(E.site.options,{label:"mySite"});l.criteria.value=[{name:n.userFullData.site.name,companyName:n.userFullData.company.name,region:n.userFullData.site.region,siteGroup:n.userFullData.site.siteGroup}],l.subLabel=n.userFullData.site.name;var c=_.find(E.siteGroup.options,{label:"mySiteGroup"});c.criteria.value=[{companyName:n.userFullData.company.name,region:n.userFullData.site.region,siteGroup:n.userFullData.site.siteGroup}],c.subLabel=n.userFullData.site.siteGroup;var d=_.find(E.region.options,{label:"myRegion"});d.criteria.value=[{companyName:n.userFullData.company.name,region:n.userFullData.site.region}],d.subLabel=n.userFullData.site.region});e.changeMetadata={},o.getMetadataByType(EntityVO.TYPE_CHANGE).then(function(t){angular.extend(e.changeMetadata,t)});var C=o.getMetadataByType(EntityVO.TYPE_ASSET).then(function(e){y=e,_.forEach(e.statuses,function(e){E.statuses.options.push({name:e.label,type:"dynamic",criteria:{name:"ticketSpecificStatuses",value:[e.name]}})}),_.forEach(e.assetTypes,function(e){E.ciType.options.push({name:e.label,type:"dynamic",criteria:{name:"assetTypes",value:[e.name]},criteriaValue:e.name}),e.subType.forEach(function(t){E.assetSubType.options.push({name:t.label,type:"dynamic",filterName:"assetSubTypes",isHidden:!1,criteria:{name:"assetSubTypes",value:[t.name],typeName:e.name}})})})});i.all([S,C,T]).then(function(){i.all([s.populateConfiguration()]).then(function(){g(0)})}),e.setGridWidth={},e.toggleResultsGrid=function(e){e.showResults=!e.showResults,e.showResults&&d(function(){$(window).resize()})},e.getProductCategoriesByCompany=function(a){var n="product",i={entityType:EntityVO.TYPE_ASSET,categoryType:n,searchText:a,criteria:{company:e.company}};return t.searchCategories(i).then(function(e){var t=_.find(y.categories,function(e){return e.name===n});return _.map(e.items,function(e){if(e.length){for(var a=_.compact(e).join(" > "),i={},o=0;o<t.listOfTiers.length;o++)i[t.listOfTiers[o].name]=e[o];return{value:a,attributeMap:{categorizations:[{name:n,tiers:i}]}}}})})},e.isWindowRtl=function(){return window.isRtl},e.searchCIs=function(t){t.isSearching=!0,t.showResults=!1,t.selectedCount=0,t.gridColumns=angular.copy(_.sortBy(_.filter(s.columnsConfig,"visible"),"order")),window.isRtl&&t.gridColumns.reverse(),t.gridOptions.columnDefs=t.gridColumns,t.gridOptions.sortInfo.directions[0]="ASC",e.chunkInfos[t.gridOptions.index]={chunkInfo:{startIndex:0,chunkSize:100}};var a={filterCriteria:h(t.selectedFilters,t.searchKeywords),chunkInfo:e.chunkInfos[t.gridOptions.index].chunkInfo,sortInfo:{sortFieldName:"name",sortFieldOrder:"ASC"},attributeNames:["name","desc","status","classId"]},n=100;t.lastUsedFilterCriteria=a,m.getAssetList(a,"cisearch").then(function(a){t.results=a.itemList,t.totalMatchCount=a.totalCount,t.isSearching=!1,t.linkedCount=0,e.$emit(l.LINKED_COUNT,e.model.searches),e.$emit(l.CI_SEARCH,e.model.searches),d(function(){$(window).resize()})})["finally"](function(){t.isSearching=!1}),_.forEach(t.gridColumns,function(e){n+=e.width}),e.setGridWidth={width:n+"px"}},e.showMoreCIs=function(t){t.isSearching=!0,t.dataLoading=!0,e.chunkInfos[t.gridOptions.index].chunkInfo.startIndex+=e.chunkInfos[t.gridOptions.index].chunkInfo.chunkSize;var a={filterCriteria:h(t.selectedFilters,t.searchKeywords),chunkInfo:e.chunkInfos[t.gridOptions.index].chunkInfo,sortInfo:{sortFieldName:"name",sortFieldOrder:"ASC"},attributeNames:["name","desc","status","classId"]};_.isArray(t.criteria.sortInfo)||(a.sortInfo=t.criteria.sortInfo),t.lastUsedFilterCriteria=a,m.getAssetList(a,"cisearch").then(function(a){a.itemList.forEach(function(a){a.status.value=r("localizeLabel")(a.status.value,EntityVO.TYPE_STATUS,EntityVO.TYPE_ASSET),a.type=r("localizeLabel")(a.type,"type",EntityVO.TYPE_ASSET),e.model.searches[t.gridOptions.index].results.push(a)}),(t.allQueryResultsSelected||t.allQueryItemsRelation&&t.allQueryItemsRelation.length>0)&&d(function(){t.allQueryResultsSelected&&e.selectAllCIs(t,!0,"grid"),t.allQueryItemsRelation&&t.allQueryItemsRelation.length>0&&_.forEach(t.allQueryItemsRelation,function(a){e.linkCIs(t,a.relationshipType,!0)})}),d(function(){$(window).resize()}),e.$emit(l.LINKED_COUNT,e.model.searches)})["finally"](function(){t.isSearching=!1,t.dataLoading=!1})},e.addAdditionalQuery=function(){var t=e.model.searches.length;g(t)},e.unlinkRelatedCIs=function(){var t={},a=[];t.parentType=e.context.type,t.parentId=e.context.id,_.each(e.selectedItems,function(t){var n={};n.id=t.reconciliationId,n.type=t.ticketType,n.details={parentDisplayId:e.context.displayId},n.relationshipType=t.relationshipType,a.push(n),e.currentRelatedCIsData=_.filter(e.currentRelatedCIsData,function(e){return e.instanceId!=t.instanceId})}),f.removeRelation(t,a).then(function(){e.selectedItems.splice(0,e.selectedItems.length),e.model.templateRelatedCIsData=e.currentRelatedCIsData,a=[]})},e.linkCIs=function(t,a,n){if(t.linked=!0,t.linkedCount=0,_.forEach(t.results,function(e){if((e.selected||n)&&(e.relations||(e.relations=[]),e.relations.indexOf(a)<0)){e.relations.push(a);var i=_.findIndex(t.relationsMap,{resultID:e.instanceId});if(i!==-1)t.relationsMap[i].type.push(a);else{var o={type:[a],resultID:e.instanceId};t.relationsMap.push(o)}}e.relations&&e.relations.length>0&&t.linkedCount++}),t.allQueryResultsSelected){var i={relationshipType:a,tag:EntityVO.TYPE_LINKEDITEM,type:EntityVO.TYPE_ASSET,searchCriteria:t.lastUsedFilterCriteria,matchesCount:t.totalMatchCount};t.allQueryItemsRelation?_.find(t.allQueryItemsRelation,{relationshipType:a})||t.allQueryItemsRelation.push(i):t.allQueryItemsRelation=[i]}t.allQueryItemsRelation&&t.allQueryItemsRelation.length>0&&(t.linkedCount=t.totalMatchCount),e.$emit(l.LINKED_COUNT,e.model.searches)},e.unlinkCIs=function(t){_.forEach(t.results,function(e){e.selected&&e.relations&&e.relations.length>0&&(e.relations=[],t.linkedCount--)}),t.relationsMap&&(t.relationsMap=[]),t.allQueryItemsRelation=[];var a=t.results;t.linkedCount=0;for(var n=0;n<a.length;n++)a[n].relations&&a[n].relations.length>0&&t.linkedCount++;e.$emit(l.LINKED_COUNT,e.model.searches)},e.removeLink=function(t,a,n){a.relations=_.reject(a.relations,function(e){return e===n}),0===a.relations.length&&t.linkedCount--;var i=_.findIndex(t.relationsMap,{resultID:a.instanceId});if(i!==-1&&(t.relationsMap[i].type=_.reject(t.relationsMap[i].type,function(e){return e===n})),t.allQueryItemsRelation=_.reject(t.allQueryItemsRelation,{relationshipType:n}),0===t.allQueryItemsRelation.length){var o=t.results;t.linkedCount=0;for(var r=0;r<o.length;r++)o[r].relations&&o[r].relations.length>0&&t.linkedCount++}e.$emit(l.LINKED_COUNT,e.model.searches)},e.selectCI=function(e,t,a){if(t.selected||!e.allQueryResultsSelected&&!e.allVisibleItemsSelected?t.selected?e.selectedCount++:e.selectedCount--:(e.allQueryResultsSelected=!1,e.allVisibleItemsSelected=!1),"grid"===a){e.selectedCount=0;for(var n=e.results,i=0;i<n.length;i++)n[i].instanceId===t.entity.instanceId&&(n[i].selected=t.selected),n[i].selected&&e.selectedCount++}},e.selectAllCIs=function(e,t,a){e.allVisibleItemsSelected=t;for(var n=e.results,i=0;i<n.length;i++)n[i].selected=t;if(e.allQueryResultsSelected||(e.selectedCount=t?i:0),"grid"===a&&e.gridOptions&&e.gridOptions.ngGrid&&e.gridOptions.ngGrid.filteredRows){var o=e.gridOptions.ngGrid.filteredRows;for(i=0;i<o.length;i++)o[i].selected=t,o[i].clone&&(o[i].clone.selected=t),t&&(_.find(e.selectedItems,{id:o[i].entity.id})||e.selectedItems.push(o[i].entity))}t||(e.allQueryResultsSelected=!1,e.selectedItems=[],e.selectedCount=0)},e.selectAllItemsInThisQuery=function(t,a){if(t.allQueryResultsSelected=a,a)t.selectedCount=t.totalMatchCount,d(function(){e.selectAllCIs(t,a,"grid")});else{t.selectedCount=0;for(var n=t.results,i=0;i<n.length;i++)n[i].selected&&t.selectedCount++;e.$emit(l.LINKED_COUNT,e.model.searches)}},e.$watch("userModel.isAccessibleUser",function(){_.forEach(e.model.searches,function(e){for(var t=e.results,a=0;a<t.length;a++)t[a].selected=!1;if(e.gridOptions&&e.gridOptions.ngGrid&&e.gridOptions.ngGrid.filteredRows){var n=e.gridOptions.ngGrid.filteredRows;for(a=0;a<n.length;a++)n[a].selected=!1,n[a].clone&&(n[a].clone.selected=!1);e.gridOptions.ngGrid.filteredRows=[]}e.gridOptions&&e.gridOptions.$gridScope&&e.gridOptions.$gridScope.selectedItems&&(e.gridOptions.$gridScope.selectedItems=[]),e.gridOptions&&e.gridOptions.selectedItems&&(e.gridOptions.selectedItems=[]),e.selectedItems&&e.selectedItems.length>0&&(e.selectedItems=[]),e.selectedCount=0})},!0),e.sortColumn=function(t,a){t.dataLoading=!0;var n={name:"name",assetId:"CIid","status.value":"status",serialNumber:"serialNumber","product.name":"productName","site.name":"siteName"};if(a.field)t.gridOptions.sortInfo.directions[0]?0===t.gridOptions.sortInfo.columns.length?t.gridOptions.sortInfo.directions[0]="DESC":t.gridOptions.sortInfo.columns[0].field!==a.field&&(t.gridOptions.sortInfo.directions[0]="DESC"):t.gridOptions.sortInfo.directions[0]="asc",t.criteria.sortInfo={sortFieldName:n[a.field],sortFieldOrder:t.gridOptions.sortInfo.directions[0].toUpperCase()};else if(a.attributeName){var i=_.findIndex(t.tableColumns,{attributeName:t.criteria.sortInfo.sortFieldName});t.criteria.sortInfo.sortFieldName===a.attributeName?t.tableColumns[i].sortOrder="ASC"===t.tableColumns[i].sortOrder?"DESC":"ASC":(i!==-1&&delete t.tableColumns[i].sortOrder,i=_.findIndex(t.tableColumns,{attributeName:a.attributeName}),t.tableColumns[i].sortOrder="ASC"),t.criteria.sortInfo={sortFieldName:n[a.attributeName],sortFieldOrder:t.tableColumns[i].sortOrder}}var o={filterCriteria:h(t.selectedFilters,t.searchKeywords),chunkInfo:{startIndex:0,chunkSize:e.chunkInfos[t.gridOptions.index].chunkInfo.startIndex+e.chunkInfos[t.gridOptions.index].chunkInfo.chunkSize},sortInfo:t.criteria.sortInfo,attributeNames:["name","desc","status","classId"]};t.lastUsedFilterCriteria=o,m.getAssetList(o,"cisearch").then(function(a){t.results=a.itemList,t.linkedCount=0,t.selectedCount=0,t.allQueryResultsSelected=!1,t.allVisibleItemsSelected=!1,t.dataLoading=!1,(t.allQueryResultsSelected||t.allQueryItemsRelation&&t.allQueryItemsRelation.length>0)&&d(function(){t.allQueryResultsSelected&&e.selectAllCIs(t,!0,"grid"),t.allQueryItemsRelation&&t.allQueryItemsRelation.length>0&&_.forEach(t.allQueryItemsRelation,function(a){e.linkCIs(t,a.relationshipType,!0)})}),_.forEach(t.relationsMap,function(e){var a=_.findIndex(t.results,{instanceId:e.resultID});a>=0&&(t.results[a].relations||(t.results[a].relations=[]),t.results[a].relations=e.type)}),e.$emit(l.LINKED_COUNT,e.model.searches)})},e.columnResizeonMouseDown=function(t,a,n){$(document).mouseup({filter:a,col:n},e.columnResizing)},e.columnResizing=function(t){var a=t.data.filter,n=t.data.col;$(document).off("mouseup",e.columnResizing),a.gridOptions.$gridScope.hasUserChangedGridColumnWidths=!1;var i={},o=100;_.forEach(a.gridOptions.$gridScope.columns,function(e){n.field===e.field&&e.width!==e.colDef.width&&(s.columnsConfig[e.colDef.name]&&(s.columnsConfig[e.colDef.name].width=e.width),i[e.colDef.name]={width:e.width},_.forEach(a.gridOptions.columnDefs,function(t){n.field===t.field&&t.width!==e.width&&(t.width=e.width)})),o+=e.width}),s.updateColumnConfig(i),e.setGridWidth={width:o+"px"}},e.showPreview=function(e){v=p.open({templateUrl:"views/change/ci-relation-preview.html",windowClass:"action-blade",size:"extra-lg",controller:["$scope","rowData",function(e,t){e.assetIdsObject={assetId:t.reconciliationId,assetClassId:t.classId}}],resolve:{rowData:function(){return e}}})},e.$on("$stateChangeStart",function(){v&&v.dismiss()}),e.savePresets=function(t,a){if(a===!1){var o=angular.element("#link-CI_action-blade-id").parent().parent();o.addClass("ci-search-section__relations_action_blade")}var s=p.open({templateUrl:"views/change/ci-relation-save-preset-action-blade.html",windowClass:"action-blade",size:"sm",controller:["$scope","filter","$modalInstance",function(e,t,o){e.selectedFilters=t.selectedFilters,e.searchKeywords=t.searchKeywords.length?_.map(t.searchKeywords.split(","),_.trim):t.searchKeywords,e.saveDisabled=!e.presetFilterName,e.$watch("presetFilterName",function(){e.saveDisabled=!e.presetFilterName}),e.submit=function(){e.savingFilterPreset=!0;for(var s=_.findIndex(t.config,{name:"custom"}),l=!1,d=0;d<t.config[s].options.length;d++){var u=t.config[s].options[d];if(e.presetFilterName&&u.name.toLowerCase()===e.presetFilterName.toLowerCase()){l=!0;break}}if(l)return e.savingFilterPreset=!1,void c.warning({text:r("i18n")("console.saveFilter.nameConflict"),hide:1e4});e.saveDisabled=!0;var p="CIFilter",f=_.cloneDeep(e.selectedFilters),g=_.cloneDeep(e.searchKeywords),h={name:e.presetFilterName,value:_.map(f.reverse(),function(e){var t={filter:e.filterName||e.criteria.name,option:e.name};return"dynamic"===e.type&&(t.type="dynamic",t.realOption=angular.copy(e),delete t.realOption.active),t})},y=_.map(g,function(e){return{filter:"keywords",option:e,type:"dynamic",realOption:{name:e,type:"dynamic",criteria:{name:"keywords",value:[e]}}}});h.value=_.union(h.value,y);var E={},v={keywords:g};_.forEach(f,function(e){E[e.criteria.name]||(E[e.criteria.name]=[]),E[e.criteria.name].push(e.criteria.value[0])});var T=_.extend(E,v);return i.all([n.updateUserPreferences(p,h),m.saveCIFilterConfiguration(e.presetFilterName,T)]).then(function(t){e.savingFilterPreset=!1;var n={name:e.presetFilterName,userProps:t};if(o.close(n),a===!1){var i=angular.element("#link-CI_action-blade-id").parent().parent();i.removeClass("ci-search-section__relations_action_blade")}})["catch"](function(){c.warning({text:r("i18n")("error.unknown"),hide:1e4})})},e.close=function(){if(o.dismiss(),a===!1){var e=angular.element("#link-CI_action-blade-id").parent().parent();e.removeClass("ci-search-section__relations_action_blade")}}}],resolve:{filter:function(){return t}}});s.result.then(function(a){function n(){var e=_.map(t.selectedFilters);if(this.id=o[r].id,this.name=i,this.type="custom",this.expanded=!0,this.selected=!1,this.setSelected=function(){this.selected=!0},t.searchKeywords.length){var a=_.map(t.searchKeywords.split(","),_.trim);_.forEach(a,function(t){var a,n=[];n.push(t),a={name:t,active:!0,criteria:{name:"keywords",value:n},type:"keywords"},e.push(a)})}this.filters=e}var i=a.name,o=a.userProps[0],r=_.findIndex(o,{name:i}),s=_.findIndex(t.config,{name:"custom"}),l=_.findIndex(e.filterConfig,{name:"custom"});_.forEach(t.config[s].options,function(e){e.name!==i&&(e.selected=!1)}),s!==-1&&_.forEach(e.model.searches,function(e){var t=_.findIndex(e.config,{name:"custom"});e.config[t].options.push(new n)}),_.forEach(t.config[s].options,function(e){e.name===i&&e.setSelected()}),l!==-1&&e.filterConfig[l].options.push(new n)})};var O=u.$on(l.CI_REMOVE_CUSTOM_FILTER,function(t,a){_.forEach(e.model.searches,function(e){var t=_.findIndex(e.config,{name:"custom"});t!==-1&&(e.config[t].options=_.reject(e.config[t].options,{name:a.name}))})});e.onSearchTextChange=function(t){e.searchTextCharLimit>0&&t.searchKeywords.length>e.searchTextCharLimit?(t.searchKeywords=t.searchKeywords.slice(0,e.searchTextCharLimit),t.isTooltipOpen=!0):t.isTooltipOpen=!1},e.$on("$destroy",function(){O()})}]}}])}(),function(){angular.module("changeModule").factory("ciRelationsModel",["consoleService","configurationModel","metadataModel","userModel","$rootScope","$q","$window",function(e,t,a,n,i,o,r){var s={},l='<div class="ngHeaderSortColumn {{col.headerClass}}" ng-style="{cursor: col.cursor}" ng-class="{ ngSorted: !noSortVisible }"><div ux-id="header-col_{{::col.displayName}}" ng-click="sortColumn(search, col ); col.sort($event)" ng-class="\'colt\' + col.index" class="ngHeaderText" title="{{\'asset.attributes.\' + col.displayName | i18n | uppercase}}">{{\'asset.attributes.\' + col.displayName | i18n | uppercase}}</div><div class="ngSortButtonUp" ng-show="col.showSortButtonDown()"></div><div class="ngSortButtonDown" ng-show="col.showSortButtonUp()"></div><div class="ngSortPriority">{{col.sortPriority}}</div></div><div ng-show="col.resizable" class="ngHeaderGrip" ng-click="col.gripClick($event)" ng-mousedown="col.gripOnMouseDown($event, search); columnResizeonMouseDown($event, search, col)"></div>',c='<div class="ngHeaderSortColumn {{col.headerClass}}" ng-class="{ ngSorted: !noSortVisible }"><div ux-id="header-col_{{::col.displayName}}" ng-class="\'colt\' + col.index" class="ngHeaderText" title="{{\'asset.attributes.\' + col.displayName | i18n | uppercase}}">{{\'asset.attributes.\' + col.displayName | i18n | uppercase}}</div></div><div ng-show="col.resizable" class="ngHeaderGrip" ng-click="col.gripClick($event)" ng-mousedown="col.gripOnMouseDown($event); columnResizeonMouseDown($event, search, col)"></div>',d='<div class="ngCellText ci-search-section__results_name_col" ng-class="col.colIndex()"><a href="" ng-click= "showPreview(row.entity);" class="ci-search-section__results_name_col"><span class="ngCellText ci-search-section__results_name_col">{{row.getProperty(col.field)}}</span></a></div>',u='<div class="ngCellText ci-search-section_linked_column" ng-class="col.colIndex()"><div class="tag_removable ci-search-section__related" ng-repeat="tag in row.entity.relations track by $index">{{\'common.relationship.type.\' + tag | i18n}}<i class="icon-cross tag__remove" ng-click="removeLink(search, row.entity, tag)" ng-enter="removeLink(search, row.entity, tag)"title="{{\'common.button.remove\' | i18n}}" aria-label="{{\'common.button.remove\' | i18n}} {{\'common.relationship.type.\' + tag | i18n}} {{\'resourceSlice.linkedItem.label\' | i18n}}" role="link" tabindex="0"></i></div></div>',p="CISearchColumns",m="",f=function(){_.forEach(s.columnsConfig,function(e){var t,a;if("name"===e.name||"classId"===e.name||"status"===e.name||"serialNumber"===e.name||"site"===e.name||"productName"===e.name?t=l:"type"!==e.name&&"related"!==e.name||(t=c),"name"===e.name&&(a=d),"related"===e.name){var n=270;a=u;var i=300}var o=r.innerWidth-640;e.width=e.width?e.width:o/7,angular.extend(e,{headerCellTemplate:t,cellTemplate:a,minWidth:n,maxWidth:i,width:n?n:e.width})})};return s.finalLinkedCount=0,s.populateConfiguration=function(){return _.isEmpty(s.columnsConfig)?o.all([n.getUserPreferences(p)]).then(function(e){if(e[0])var a=e[0],n=a.length?a[0].value:{};else a=[];return m=a.length?a[0].id:null,s.columnsConfig=_.merge(t.get("ciSearch.columns"),n),f(),s.columnsConfig}):o.when(1)},s.updateColumnConfig=function(e){n.updateUserPreferences(p,{id:m,name:"columns",value:e}).then(function(e){m||(m=e[0].id)})},s}])}(),function(){angular.module("changeModule").controller("CreateChangeV2Controller",["$scope","$state","$http","metadataModel","userModel","createTicketModel","feedModel","$q","ticketService","ticketTemplateModel","systemAlertService","ticketModel","localStorageService","ticketActionService","categoriesService","events","i18nService","screenConfigurationModel","fieldValidationModel","$filter","editTicketDatesService","tabIds","searchModel","relationModel","configurationModel","layoutConfigurationModel","objectValueMapperService","$log","$timeout",function(e,t,a,n,i,o,r,s,l,c,d,u,p,m,f,g,h,y,E,v,T,S,C,O,A,I,b,k,D){function R(){e.selectedMainTab=e.tabIds.main.template,e.state.selectedWizardTab=e.tabIds.wizard.basics,ne=null,e.data.searches=[],e.draftTicket.needsReloadingRiskQuestions=!0,e.linkedCount=0,e.template={search:"",list:[],selected:{},showSearchResults:!1,preview:null},e.datePickerOptions={startingDay:7,"show-weeks":!1,minDate:moment().year(1970).month(0).date(2),maxDate:moment().year(2038).month(0).date(18)},e.draftCreated=!1,e.draftTicket={type:EntityVO.TYPE_CHANGE,scheduledStartDatePicker:{open:!1},scheduledEndDatePicker:{open:!1},actualStartDatePicker:{open:!1},actualEndDatePicker:{open:!1},targetDatePicker:{open:!1},customFields:{},needsReloadingRiskQuestions:!0},L(i.userFullData),t.go("createChange.selector")}function P(){e.state={dataIsLoading:!0,templatesLoading:!1,tooManyCompanies:!1,lastUsedTemplatesLoading:!0,savingCIs:!1},e.editMode=!0,e.isNew=!0,b.clearMap(EntityVO.TYPE_CHANGE),Q();var t=p.get("change.lastUsedTemplates");e.lastUsedTemplates=t?t:[],e.changeMetadata={};var o=n.getMetadataByType(EntityVO.TYPE_CHANGE).then(function(t){e.type=t.metadatatype,angular.extend(e.changeMetadata,t),(!e.changeMetadata.documentTypes||e.changeMetadata.documentTypes&&0===e.changeMetadata.documentTypes.length)&&a.get("mocks/change-request-metadata-document-types.json").then(function(t){e.changeMetadata.documentTypes=t.documentTypes})}),r=i.getFullCurrentUserData().then(function(){C.getOperatingCompanies(null,-1).then(function(t){e.selections.companies=_.cloneDeep(t.companies),e.state.tooManyCompanies=t.exceedsChunkSize})}),l=I.loadScreenLayout(ScreenConfigurationVO.prototype.CREATE_CHANGE_SCREEN),c=y.loadScreenConfigurationAndCustomFieldLabels(ScreenConfigurationVO.prototype.CREATE_CHANGE_SCREEN,EntityVO.TYPE_CHANGE);s.all([o,r,l,c]).then(function(t){e.state.dataIsLoading=!1,e.screenLayout=t[2];var a=y.getEditableFieldsForScreen(ScreenConfigurationVO.prototype.CHANGE_REQUEST_SCREEN),n=angular.copy(a);e.basicsCustomFields=_.filter(n,{panelId:ScreenConfigurationVO.prototype.CHANGE_REQUEST_SCREEN+".basics"}),e.datesCustomFields=_.filter(e.screenLayout.panels,{name:"datesSection"}),e.risksCustomFields=_.filter(e.screenLayout.panels,{name:"riskSection"}),e.showMailstopOnPersoncard=A.showMailstopOnPersoncard,e.showPhoneNumOnPersonCard=A.showPhoneNumOnPersonCard,R()})}function w(t){e.state.lastUsedTemplatesLoading=!0,e.currentRecentlyUsedTemplates=[];var a=_.filter(e.lastUsedTemplates,{forCompany:t});a.length?u.getRecentlyUsedChangeTemplates(a,e.changeMetadata).then(function(t){e.state.lastUsedTemplatesLoading=!1,t&&(e.currentRecentlyUsedTemplates=t)})["catch"](function(){e.state.lastUsedTemplatesLoading=!1}):e.state.lastUsedTemplatesLoading=!1}function L(t){e.draftTicket.customer=(new PersonVO).build(t),e.setCompany(t.company),e.setLocation(t.site)}function N(){e.draftTicket.useTargetDate?(e.draftTicket.scheduledStartDate=null,e.draftTicket.scheduledEndDate=null,e.draftTicket.actualStartDate=null,e.draftTicket.actualEndDate=null):e.draftTicket.targetDate=null}function M(){t.go("createChange.wizard"),_.forEach(e.changeMetadata.riskLevels,function(e){le.push(e.name)}),u.getChangeRiskRules(e.draftTicket.company&&e.draftTicket.company.name).then(function(t){t&&t.workNoteRequiredForRisk&&(oe=!0,se=_.takeRight(le,le.length-le.indexOf(t.workNoteRequiredForRisk))),t&&t.changeReasonRequiredForRisk&&(oe=!0,re=_.takeRight(le,le.length-le.indexOf(t.changeReasonRequiredForRisk))),e.draftTicket.riskLevel&&(oe&&F({fieldName:EntityVO.FIELD_CHANGE_RISK,fieldValue:e.draftTicket.riskLevel}),oe&&V({fieldName:EntityVO.FIELD_CHANGE_RISK,fieldValue:e.draftTicket.riskLevel}))})}function V(t){e.changeReasonRequired=!1,re&&_.forEach(re,function(a){a===t.fieldValue&&(e.changeReasonRequired=!0)})}function F(t){e.isNoteRequired=!1,se&&_.forEach(se,function(a){a===t.fieldValue&&(e.isNoteRequired=!0)})}function x(t){return e.isRelatedCR?e.relatedDraftInfo.fromType===EntityVO.TYPE_ASSET?l.getRelatedDraftFromAsset(e.relatedDraftInfo.type,e.relatedDraftInfo.fromContext,t):l.getDraftForRelated(e.relatedDraftInfo.type,e.relatedDraftInfo.fromType,e.relatedDraftInfo.id,t):l.getDraft(EntityVO.TYPE_CHANGE,t)}function G(){return e.draftTicket.customer&&e.draftTicket.company.name===e.draftTicket.customer.company.name?e.draftTicket.customer.site:e.draftTicket.company.name===i.userFullData.company.name?i.userFullData.company.site:{}}function $(t,a,n){if(a?(t.company.name!==e.draftTicket.company.name||_.isEmpty(t.location)||(e.draftTicket.location=t.location),_.isEmpty(e.template.selected.templateObject.changeType)||(e.draftTicket.changeType=e.template.selected.templateObject.changeType),t.company=e.draftTicket.company,e.draftTicket=angular.extend(e.draftTicket,t),e.relatedDraftInfo?e.relatedDraftInfo.fromContext||(e.relatedDraftInfo.fromContext={}):e.relatedDraftInfo={fromContext:{}},e.draftTicket.desc=e.isRelatedCR?e.relatedDraftInfo.fromContext.desc&&e.template.selected.desc?e.template.selected.desc+" "+e.relatedDraftInfo.fromContext.desc:e.template.selected.desc||e.relatedDraftInfo.fromContext.desc:e.template.selected.desc,e.isRelatedCR&&!e.draftTicket.summary&&(e.draftTicket.summary=e.template.selected.summary||e.relatedDraftInfo.fromContext.summary)):(e.draftTicket=angular.extend(t,e.draftTicket),t.location=G(),!e.draftTicket.customer&&e.draftTicket.company&&e.draftTicket.company.name&&(e.draftTicket.customFields.company=e.draftTicket.company.name)),e.draftTicket.impactedService&&!e.draftTicket.impactedService.name&&(e.draftTicket.impactedService=null),o.currentTicket=e.draftTicket,e.draftTicket.impact=e.draftTicket.impact?_.head(_.filter(e.changeMetadata.impacts,{name:e.draftTicket.impact.name||e.draftTicket.impact})).name:_.last(e.changeMetadata.impacts).name,e.draftTicket.urgency=e.draftTicket.urgency?_.head(_.filter(e.changeMetadata.urgencies,{name:e.draftTicket.urgency.name||e.draftTicket.urgency})).name:_.last(e.changeMetadata.urgencies).name,e.draftTicket.timing=e.draftTicket.timing?_.head(_.filter(e.changeMetadata.timings,{name:e.draftTicket.timing.name||e.draftTicket.timing})):_.last(e.changeMetadata.timings),e.draftTicket.timing&&e.draftTicket.timing.timingReasons&&(e.draftTicket.timingReason=e.draftTicket.timingReason?_.head(_.filter(e.changeMetadata.timingReasons,{name:e.draftTicket.timingReason.name||e.draftTicket.timingReason})):"",e.draftTicket.timingReason=e.draftTicket.timingReason?e.draftTicket.timingReason.name:e.draftTicket.timingReason),e.draftTicket.riskLevel?e.draftTicket.riskLevelSelectionMode="manual":e.draftTicket.riskLevelSelectionMode="auto",e.draftTicket.supportGroup&&e.draftTicket.supportGroup.company&&e.draftTicket.supportGroup.company.name){var i=e.draftTicket.supportGroup.company;e.draftTicket.assignee&&e.draftTicket.assignee.company.name!=i.name&&e.updateCoordinatorGroupCompany(i)}B(n),e.draftTicket.documents=[],e.draftTicket.allCategories=_.cloneDeep(f.populateCategories(e.draftTicket.categorizations,e.changeMetadata)),e.draftTicket.location&&(e.draftTicket.location.companyName=e.draftTicket.company.name)}function B(t){if(e.draftTicket.priority)e.draftTicket.priority=_.head(_.filter(e.changeMetadata.priorities,{name:e.draftTicket.priority.name||e.draftTicket.priority})),e.priorityValid=!0;else{var a=_.last(e.changeMetadata.impacts),n=_.last(e.changeMetadata.urgencies);e.draftTicket.impact===a.name&&e.draftTicket.urgency===n.name?(e.draftTicket.priority=_.last(e.changeMetadata.priorities).name,e.priorityValid=!0):(e.isRelatedCR&&(e.draftTicket.isRelatedCR=e.isRelatedCR),e.updatePriority(t))}}function U(t){e.lastUsedTemplates.unshift(t),e.lastUsedTemplates=_.uniqBy(e.lastUsedTemplates,function(e){return e.id}).splice(0,50),p.set("change.lastUsedTemplates",e.lastUsedTemplates)}function z(){for(var t=0;t<e.data.searches.length;t++)if(e.data.searches[t].selectedCount>0&&!e.data.searches[t].linked)return!0;return!1}function Y(){return ae=K(),ae.bulkCIsLinked.length>0||e.linkedCount>=80?d.modal({type:"info",title:h.getLocalizedString("create.change.wizard.ci.confirmCIRelation.title"),text:h.getLocalizedString("create.change.wizard.ci.confirmCIRelation.text"),buttons:[{text:h.getLocalizedString("common.button.continue"),data:!0},{text:h.getLocalizedString("common.button.returnToScreen"),data:!1}]}).result.then(function(t){t&&(C.disableImpactAnalysis||!o.currentTicket.accessMappings||!o.currentTicket.accessMappings.impactEditAllowed||0===ae.bulkCIsLinked.length&&0===e.linkedCount&&!e.draftTicket.impactedService?H():!C.disableImpactAnalysis&&o.currentTicket.accessMappings&&o.currentTicket.accessMappings.impactEditAllowed&&(ae.bulkCIsLinked.length>0||e.linkedCount>0||e.draftTicket.impactedService)&&q())}):void(!C.disableImpactAnalysis&&o.currentTicket.accessMappings&&o.currentTicket.accessMappings.impactEditAllowed&&(0!==ae.bulkCIsLinked.length||0!==e.linkedCount||e.draftTicket.impactedService||e.data.templateRelatedCIsData&&e.data.templateRelatedCIsData.length>0)?!C.disableImpactAnalysis&&o.currentTicket.accessMappings&&o.currentTicket.accessMappings.impactEditAllowed&&(ae.bulkCIsLinked.length>0||e.linkedCount>0||e.draftTicket.impactedService||e.data.templateRelatedCIsData&&e.data.templateRelatedCIsData.length>0)&&q():H())}function q(){return d.modal({type:"info",title:h.getLocalizedString("create.change.wizard.confirmImpactAnalysis.title"),text:h.getLocalizedString("create.change.wizard.confirmImpactAnalysis.text"),details:h.getLocalizedString("create.change.wizard.confirmImpactAnalysis.text2"),additionalInfo:h.getLocalizedString("create.change.wizard.confirmImpactAnalysis.text3"),buttons:[{text:h.getLocalizedString("impact.analysis.button.submitWithImpactAnalysisWindow"),data:!0},{text:h.getLocalizedString("impact.analysis.button.submitWithoutImpactAnalysisWindow"),data:!1}]}).result.then(function(e){H(e)})}function H(a){e.$broadcast(g.SAVE_TICKET_DRAFT),e.state.savingCIs=!0;var n=b.getFieldByName("timing");n&&n.value&&n.value.name&&b.setValueByFieldName("timing",n.value.name);
var i=o.collectTicketChanges(e.changeMetadata);if(i.summary&&(i.summary=i.summary.replace(/\u00a0/g," ")),i.customer instanceof Object||(i.customer={fullName:i.customer}),i.riskLevel instanceof Object&&(i.riskLevel=i.riskLevel.name),o.currentTicket.questionResponses=i.questionResponses?i.questionResponses:"",delete i.questionDefinitions,delete i.questionResponses,i.changeType=e.draftTicket.changeType,i.scheduledStartDate=e.draftTicket.scheduledStartDate&&e.draftTicket.scheduledStartDate.valueOf()||i.scheduledStartDate,i.scheduledEndDate=e.draftTicket.scheduledEndDate&&e.draftTicket.scheduledEndDate.valueOf()||i.scheduledEndDate,i.actualStartDate=e.draftTicket.actualStartDate&&e.draftTicket.actualStartDate.valueOf()||i.actualStartDate,i.actualEndDate=e.draftTicket.actualEndDate&&e.draftTicket.actualEndDate.valueOf()||i.actualEndDate,i.targetDate=e.draftTicket.targetDate&&e.draftTicket.targetDate.valueOf()||i.targetDate,e.draftTicket.templateId&&(i.templateId=e.draftTicket.templateId,i.leadTime=e.draftTicket.leadTime),r.pendingWorkNote){var l={};l.worknote=r.pendingWorkNote.noteText,l.access=r.pendingWorkNote.access,l.workInfoType=r.pendingWorkNote.workInfoType,i.workInfo=l,r.pendingWorkNote.attachments&&r.pendingWorkNote.attachments.length&&(i.attachments=r.pendingWorkNote.attachments)}o.createChangeRequestV2(i).then(function(n){var r=[],l=n.impactedAreas.length>0?W(n.impactedAreas[0]):null;if(null!==l&&_.remove(o.currentTicket.impactedAreas,function(e){var t=W(e);return t===l}),r.push(o.saveImpactedAreas(o.currentTicket.id,EntityVO.TYPE_CHANGE,o.currentTicket.impactedAreas)),i.riskIsUserSpecified||r.push(o.saveRiskResponse(o.currentTicket)),r.push(o.saveDocuments(o.currentTicket)),r=_.flatten(r),e.isRelatedCR){var c={id:e.relatedDraftInfo.id,relationshipType:e.relatedDraftInfo.relationship?e.relatedDraftInfo.relationship:RelationItemVO.TYPE_CREATEDBY,tag:RelationItemVO.TAG_LINKEDITEM,type:e.relatedDraftInfo.fromType,desc:e.relatedDraftInfo.fromContext.summary};c.type===EntityVO.TYPE_RELEASE&&(c.milestone=e.relatedDraftInfo.fromContext.milestone,c.details={sequence:e.relatedDraftInfo.sequence},c.tag=RelationItemVO.TAG_LINKEDITEM,c.relationshipType=RelationItemVO.TYPE_MEMBEROF,c.desc=e.relatedDraftInfo.fromContext.desc,c.displayId=e.relatedDraftInfo.fromContext.displayId,c.parentDisplayId=n.displayId),ae.linkedItems.push(c)}if(ae.linkedItems.length||e.data.templateRelatedCIsData.length){_.forEach(e.data.templateRelatedCIsData,function(e){var t={};t.id=e.reconciliationId,t.desc=e.desc,t.relationshipType=e.relationshipType,t.tag=e.tag,t.type=e.ticketType,ae.linkedItems.push(t)});var p=O.addRelation({uuid:n.id,type:EntityVO.TYPE_CHANGE},ae.linkedItems);r.push(p)}ae.bulkCIsLinked.length>0&&_.forEach(ae.bulkCIsLinked,function(e){var t={id:n.id,type:EntityVO.TYPE_CHANGE};if(e.matchesCount>100){var a=e.searchCriteria;a.chunkInfo={startIndex:0,chunkSize:50};var i=O.relateBulkCI(t,e,a).then(function(){return j(t,e)});r.push(i)}}),ie&&ie(),r.length>0?s.all(r)["catch"](function(e){e&&d.error({text:e.data&&e.data.error||e,clear:!0,displayOnStateChange:!0})})["finally"](function(){o.onChangeCreateSuccess(n,a),delete O.cache[n.id],t.go(EntityVO.TYPE_CHANGE,{id:n.id})}):(o.onChangeCreateSuccess(n,a),delete O.cache[n.id],t.go(EntityVO.TYPE_CHANGE,{id:n.id})),_.isEmpty(u.cache.draft)||delete u.cache.draft})["catch"](function(t){e.state.savingCIs=!1,t=t.data.detailMessage||t.data.error||t,d.error({text:t,clear:!0})})}function K(){var t=[],a=[];return _.forEach(e.data.searches,function(e){e.allQueryItemsRelation&&e.allQueryItemsRelation.length>0&&(a=a.concat(e.allQueryItemsRelation)),_.forEach(e.results,function(a){_.forEach(a.relations,function(n){e.allQueryItemsRelation&&e.allQueryItemsRelation.length>0&&_.find(e.allQueryItemsRelation,{relationshipType:n})||t.push({relationshipType:n,tag:EntityVO.TYPE_LINKEDITEM,id:a.reconciliationId,type:EntityVO.TYPE_ASSET,desc:a.name})})})}),{linkedItems:t,bulkCIsLinked:a}}function j(e,t){var a=t.searchCriteria;return a.chunkInfo.startIndex+=a.chunkInfo.chunkSize,t.matchesCount>a.chunkInfo.startIndex?O.relateBulkCI(e,t,a).then(function(){return j(e,t)}):s.when(1)}function W(e){var t=_.filter([e.company.name,e.site?e.site.region:null,e.site?e.site.siteGroup:null,e.site?e.site.name:null,e.organization,e.department],function(e){return e}).join(" > ");return t}function Q(){ie=e.$on("$stateChangeStart",function(t,a,n,i,o){a.name.indexOf("createChange.wizard")===-1&&e.changeWizardDirty()&&(t.preventDefault(),e.dirtyPopupCount&&0!==e.dirtyPopupCount||(e.dirtyPopupCount=1,J(a,n)))})}function J(a,n){var i=d.modal({title:h.getLocalizedString("common.notification.dirty.title"),text:h.getLocalizedString("common.notification.dirty.message"),buttons:[{text:h.getLocalizedString("common.labels.yes"),data:{stateName:a.name,stateParams:n}},{text:h.getLocalizedString("common.labels.no")}]});i.result.then(function(a){if(e.dirtyPopupCount=0,!_.isEmpty(a)){for(var n in e.tabIds.wizard)e.$broadcast(g.DISCARD_DOCUMENTS),e.linkedCount=0,e[n]&&(e[n].$dirty=!1);"createChange.selector"===a.stateName?R():t.transitionTo(a.stateName,a.stateParams)}})}function Z(t){return _.forEach(t,function(t){if(t.results&&t.results.length>0){for(var a=t.results,n=0;n<a.length;n++)a[n].relations&&a[n].relations.length>0&&(t.allQueryItemsRelation&&t.allQueryItemsRelation.length>0||e.linkedCount++);t.allQueryItemsRelation&&t.allQueryItemsRelation.length>0&&(e.linkedCount+=t.totalMatchCount)}}),e.linkedCount}function X(t,a){var n=!1,i=a.originalEvent,o=!a.saveSelection;if(!a)return void k.warn("Could not open assignment blade. Required Event data is missing. ");var r=a.role;"manager"===r?r=e.type+r:"assignee"===r&&(r=e.type+"coordinator"),n=!!a.assignToMe,n?m.assignToMe(i,r,o,e.draftTicket,e):m.assign(i,o,e.draftTicket,e,r)}function ee(t){t.changeReasonNotRequired?e.changeReasonRequired=!1:oe&&V(t),t.workNoteNotRequired?e.isNoteRequired=!1:oe&&F(t),e.$broadcast(g.RISK_LEVEL_CHANGE,{isRequired:e.changeReasonRequired})}var te=!0;if(!A.isServerApplicationEnabled(EntityVO.TYPE_CHANGE))return void t.go("unauthorized");e.data={},e.linkedCount=0,e.showNoRelatedCIWarning=!1,e.tabIds=S,e.draftTicket={type:EntityVO.TYPE_CHANGE},e.changeReasonRequired=!1,e.isNoteRequired=!1,e.isRelatedCR=!_.isEmpty(u.cache.relatedDraft),e.relatedDraftInfo=e.isRelatedCR?u.cache.relatedDraft:null,e.loggedInUserId=i.userId,e.isRelatedCR&&delete u.cache.relatedDraft,e.data.searches=[],e.selections={companies:[]},e.siteOptions={company:{visible:!1,attribute:"companyName"},region:{attribute:"region"},siteGroup:{attribute:"siteGroup"},site:{attribute:"name"}};var ae,ne,ie,oe,re,se,le=[];e.setCoordinator=function(t){e.draftTicket.assignee=t},e.setCompany=function(t){e.draftTicket.company=t,t.name!==e.draftTicket.customer.company.name&&e.setLocation({}),w(t.name)},e.getCompaniesByName=function(e){return C.getCompaniesByText(e).then(function(e){return{list:e.companies,exceedsChunkSize:e.exceedsChunkSize}})},e.clearRequestedFor=function(){e.draftTicket.customer=null},e.validateRequestedFor=function(){e.draftTicket.customer&&!e.draftTicket.customer.id&&(e.draftTicket.customer=""),e.state.searchingPersons=!1},e.setChangeLocation=function(){return e.focusElement=!1,d.modal({title:h.getLocalizedString("create.change.setRequestedForLocation.title"),text:h.getLocalizedString("create.change.setRequestedForLocation.text"),buttons:[{text:h.getLocalizedString("common.button.yes"),data:!0},{text:h.getLocalizedString("common.button.no"),data:!1}]}).result.then(function(t){t&&e.setCompany(e.draftTicket.customer.company),e.focusElement=!0})},e.setCoordinatorGroup=function(t){e.draftTicket.supportGroup=t},e.updateCoordinatorGroupCompany=function(t){e.draftTicket.assignee.company=t},e.setLocation=function(t){e.draftTicket.location=t},e.selectMainTab=function(t){e.selectedMainTab=t},e.getList=function(e,t){return o.getList(e,t)},e.getTemplateList=function(t){return c.getChangeTemplateList(t,e.draftTicket.company.name,e.changeMetadata).then(function(t){return e.state.exceedsChunkSizeTemplates=t.exceedsChunkSize,e.state.isTooltipOpenTemplates=t.exceedsChunkSize,D(function(){e.state.isTooltipOpenTemplates=!1},1e4),_.uniq(_.map(t.items,"name"))})},e.getListPersons=function(t,a){return e.state.searchingPersons=!0,o.getList(t,a).then(function(t){return e.exceedsChunkSizeRequestedFor=t.exceedsChunkSize,e.isTooltipOpenRequestedFor=!0,D(function(){e.isTooltipOpenRequestedFor=!1},1e4),e.state.searchingPersons=!1,t.items})},e.onInputFocusBlur=function(){e.isTooltipOpenRequestedFor=!1,e.state.isTooltipOpenTemplates=!1,e.isTooltipOpenPerson=!1},e.getListPersonsByCompany=function(t){return e.state.searchingPersons=!0,o.getPersonsByCompany(t,e.draftTicket.company.name).then(function(t){return e.exceedsChunkSizePerson=t.exceedsChunkSize,e.isTooltipOpenPerson=!0,D(function(){e.isTooltipOpenPerson=!1},1e4),e.state.searchingPersons=!1,t.items})},e.clearImpactedService=function(){e.draftTicket.impactedService=""},e.updateTiming=function(){e.useTargetDateDisabled()&&(e.draftTicket.useTargetDate=!1,N())},e.getNextStepAriaLabel=function(){var t=v("i18n")("create.change.wizard.nextStep");switch(e.state.selectedWizardTab){case"basics":t+=" "+v("i18n")("create.change.wizard.tabs.ci");break;case"ci":t+=" "+v("i18n")("create.change.wizard.tabs.dates");break;case"dates":t+=" "+v("i18n")("create.change.wizard.tabs.risks");break;case"risks":t+=" "+v("i18n")("create.change.wizard.tabs.documents")}return t},e.$watch("draftTicket.timing",function(){e.draftTicket&&e.draftTicket.timing&&(e.draftTicket.scheduledStartDate=e.isFieldDisabled("scheduledStartDate")?null:e.draftTicket.scheduledStartDate,e.draftTicket.scheduledEndDate=e.isFieldDisabled("scheduledEndDate")?null:e.draftTicket.scheduledEndDate)}),e.useTargetDateDisabled=function(){return e.draftTicket.timing&&("Emergency"===e.draftTicket.timing.name||"Latent"===e.draftTicket.timing.name||"No Impact"===e.draftTicket.timing.name)},e.updatePriority=function(t){e.state.dataIsLoading=!0,u.getChangePriority(e.draftTicket.company.name,e.draftTicket.impact,e.draftTicket.urgency).then(function(a){_.isEmpty(a)?(e.draftTicket.priority="",d.error({text:v("i18n")("create.change.wizard.basicDetails.priority.warning"),hide:1e4}),e.priorityValid=!1):(e.draftTicket.priority=_.find(e.changeMetadata.priorities,{name:a}),e.priorityValid=!0),t||(e.state.dataIsLoading=!1)},function(t){d.warning({text:t.error,hide:1e4}),e.priorityValid=!1,e.state.dataIsLoading=!1})},e.validatePriority=function(){_.isEmpty(e.draftTicket.priority)||(e.priorityValid=!0)},e.nextStep=function(){var t=!1;_.forOwn(e.tabIds.wizard,function(a,n){return t?(t=!1,void(e.state.selectedWizardTab=n)):void(a===e.state.selectedWizardTab&&("ci"===e.state.selectedWizardTab&&e.showNoRelatedCIWarning===!0&&0===e.linkedCount?(d.warning({text:v("i18n")("create.change.wizard.ci.warning.part"),hide:1e4}),t=!1,e.showNoRelatedCIWarning=!1):t=!0))})},e.changeWizardValid=function(){return 0===e.invalidFormCount()&&e.priorityValid&&te},e.isDocumentTab=function(){return e.state.selectedWizardTab===e.tabIds.wizard.documents},e.invalidFormCount=function(){var t=0;return _.forOwn(e.tabIds.wizard,function(a,n){e.formValid(n)||t++}),t},e.changeWizardDirty=function(){return 0!==e.dirtyFormCount()||!_.isEmpty(e.draftTicket.documents)||0!==e.linkedCount},e.dirtyFormCount=function(){var t=0;for(var a in e.tabIds.wizard)e.formDirty(a)&&t++;return t},e.setChangeWizardPristine=function(){for(var t in e.tabIds.wizard)e[t]&&e[t].$setPristine()},e.formValid=function(t){return!e[t]||!e[t].$invalid},e.formDirty=function(t){return!!e[t]&&e[t].$dirty},e.$on(g.CHANGE_WIZARD_FORM_STATE,function(t,a){e[a.name]=e[a.name]||{},"undefined"!=typeof a.invalid&&(e[a.name].$invalid=a.invalid),"undefined"!=typeof a.dirty&&(e[a.name].$dirty=a.dirty)}),e.getRecommendedTemplates=function(){_.isEmpty(e.template.search)||(e.state.templatesLoading=!0,c.getChangeTemplateList(e.template.search,e.draftTicket.company.name,e.changeMetadata).then(function(t){e.template.list=t.items})["finally"](function(){e.state.templatesLoading=!1,e.template.showSearchResults=!0}))},e.handleKeyDown=function(t,a){32===t.keyCode&&(e.template.selected.id===a.id?e.template.selected="":e.template.selected=a,t.stopPropagation())},e.createDraftChange=function(){e.state.dataIsLoading=!0,x(e.template.selected.id).then(function(t){e.draftCreated=!0,e.template.selected.forCompany=e.draftTicket.company.name,U(e.template.selected),t.customer=e.draftTicket.customer,$(t,!0,!0),O.getRelations(t.id,t.type,t.displayId)["finally"](function(){e.state.dataIsLoading=!1,M()})})},e.createDraftChangeForClass=function(t){e.state.dataIsLoading=!0,x().then(function(a){e.state.dataIsLoading=!1,e.draftCreated=!0,e.draftTicket.timing=t,$(a,!1),M()})},e.createChangeRequest=function(){return z()?d.modal({type:"info",title:h.getLocalizedString("create.change.wizard.header"),text:h.getLocalizedString("create.change.wizard.ci.relateCIMessage"),buttons:[{text:h.getLocalizedString("common.button.continue"),data:!0},{text:h.getLocalizedString("common.button.cancel"),data:!1}]}).result.then(function(e){e&&Y()}):void Y()},e.clear=function(){e.changeWizardDirty()?t.go("createChange.selector"):R()},e.$watch("draftTicket.riskLevelSelectionMode",function(){"manual"===e.draftTicket.riskLevelSelectionMode&&(e.draftTicket.questionResponses=null,angular.forEach(e.draftTicket.questionDefinitions,function(e){e.selectedOption=null}))}),e.$watch("draftTicket.company",function(){e.draftTicket.company&&(e.draftTicket.needsReloadingRiskQuestions=!0,e.template={search:"",list:[],selected:{},showSearchResults:!1,preview:null})}),e.$watch("draftTicket.allCategories",function(t){t&&f.isDirtyValues(t)&&!e.draftTicket.needsReloadingRiskQuestions&&(e.draftTicket.needsReloadingRiskQuestions=!0,e.draftTicket.questionDefinitions&&e.draftTicket.questionResponses&&d.warning({text:v("i18n")("create.change.wizard.risks.riskQuestions.reloaded"),hide:1e4}))},!0),e.$watch("state.selectedWizardTab",function(){if(e.state.selectedWizardTab&&e.state.selectedWizardTab!==e.tabIds.wizard.basics&&e.draftTicket.needsReloadingRiskQuestions&&(e.draftTicket.categorizations=f.collectValues(e.draftTicket.allCategories,e.draftTicket,null,!0).categorizations,f.clearDirtyValues(e.draftTicket.allCategories),e.draftTicket.needsReloadingRiskQuestions=!1,e.draftTicket.reloadRiskQuestions=!0,e.draftTicket.riskLevel||(e.draftTicket.riskLevelSelectionMode="auto")),ne===e.tabIds.wizard.ci&&z())return d.modal({type:"info",title:h.getLocalizedString("create.change.wizard.header"),text:h.getLocalizedString("create.change.wizard.ci.relateCIMessage"),buttons:[{text:h.getLocalizedString("common.button.continue"),data:!0},{text:h.getLocalizedString("common.button.cancel"),data:!1}]}).result.then(function(t){t||(e.state.selectedWizardTab=e.tabIds.wizard.ci),ne=null});if(t.current.name.indexOf("wizard")!==-1){var a="createChange.wizard";e.state.selectedWizardTab===e.tabIds.wizard.dates&&(a+=".calendar.book"),t.go(a)}ne=e.state.selectedWizardTab}),e.isFieldRequired=function(t){var a=!1;return e.draftTicket.timing&&(a=E.isFieldRequired(EntityVO.TYPE_CHANGE,"Draft",e.draftTicket.timing.name,t)),a},e.isFieldDisabled=function(t){var a=!1;return e.draftTicket.timing&&(a=E.isFieldDisabled(EntityVO.TYPE_CHANGE,"Draft",e.draftTicket.timing.name,t)),a},e.$on(g.LINKED_COUNT,function(t,a){e.linkedCount=0,Z(a)}),e.$on(g.CI_SEARCH,function(t,a){e.linkedCount=0,e.showNoRelatedCIWarning=!0,Z(a)}),e.$watch("linkedCount",function(){e.draftTicket.linkedCIs=K().linkedItems}),e.$watch("draftTicket.impactedService",function(){e.draftTicket&&_.isObject(e.draftTicket.impactedService)&&e.$emit(g.AFFECTED_SERVICE_UPDATED,e.draftTicket.impactedService)}),e.$on(g.SHOW_ASSIGN_TICKET_BLADE,X),e.$on(g.WIDGET_VALUE_CHANGE,function(t,a){if(a.fieldName===EntityVO.FIELD_CHANGE_RISK&&ee(a),a.fieldName===EntityVO.FIELD_CHANGE_PRIORITY){var n=b.getFieldByName(EntityVO.FIELD_CHANGE_PRIORITY);n&&n.value&&n.value.priority.name&&(e.priorityValid=!0)}}),e.$on(g.CUSTOM_FIELD_VALUE_CHANGE,function(){e.$broadcast(g.REFRESH_FIELD_VALUES)}),e.$on(g.RISK_QUESTION_LOADED,function(){te=!0,ee({workNoteNotRequired:!0,changeReasonNotRequired:!0})}),e.$on(g.RISK_MODE_MANUAL,function(){te=!0}),e.$on(g.RELOAD_RISK_QUESTION,function(){b.getFieldByName(FieldVO.prototype.WIDET_NAMES.changeRisk)&&(te=!1)}),e.$on(g.FIELD_VALUE_CHANGE,function(e,t){t.name===EntityVO.FIELD_RISK_LEVEL&&ee({fieldName:t.name,fieldValue:t.value})}),P()}])}(),function(){angular.module("changeModule").directive("datesV2",["events","$filter","editTicketDatesService","fieldValidationModel","$modal","tabIds","metadataModel","collisionModel","systemAlertService","emailModel","ticketModel","searchModel","screenConfigurationModel","$rootScope","configurationModel","expressionEventManager","$timeout",function(e,t,a,n,i,o,r,s,l,c,d,u,p,m,f,g,h){return{restrict:"E",replace:!0,templateUrl:"views/change/dates-v2.html",scope:{collisions:"=",context:"=",editMode:"=",isNew:"=",datesCustomFields:"=",screenLayout:"=",metadata:"="},link:function(y,E){function v(e,t){var a=[];y.context.linkedCIs&&y.context.linkedCIs.length&&a.push.apply(a,y.context.linkedCIs),y.context.impactedService&&y.context.impactedService.reconciliationId&&(_.find(a,{id:y.context.impactedService.reconciliationId})||a.push({id:y.context.impactedService.reconciliationId})),e&&e!==t?!y.editMode||y.isNew?O?T():y.context.scheduledStartDate&&y.context.scheduledEndDate&&(a&&a.length&&!isNaN(y.autoTriggerChangeCollisionForCIsUpto)&&!_.isUndefined(y.autoTriggerChangeCollisionForCIsUpto)&&a.length>y.autoTriggerChangeCollisionForCIsUpto?(y.showRunCollisionDetectionMsg=!0,y.collisionsCopy={}):y.collisionStates.shouldRefreshCollisions=!0):y.editMode&&(y.collisionStates.saveDatesAndUpdate=!!(y.context.scheduledStartDate&&y.context.scheduledEndDate&&y.context.scheduledStartDate.getTime()<=y.context.scheduledEndDate.getTime())&&y[y.tabIds.wizard.dates].dateForm.$valid,y.collisionStates.editCollisionStatus=!1,C(a)):!y.editMode||y.isNew?(y.collisionStates.shouldRefreshCollisions=!1,y.collisionsCopy={}):y.editMode&&C(a)}function T(){var e=[];y.context.impactedService&&e.push({id:y.context.impactedService.reconciliationId}),y.context.linkedCIs&&y.context.linkedCIs.length&&e.push.apply(e,y.context.linkedCIs),y.context.scheduledStartDate&&y.context.scheduledEndDate&&e&&e.length&&(isNaN(y.autoTriggerChangeCollisionForCIsUpto)||_.isUndefined(y.autoTriggerChangeCollisionForCIsUpto)||e.length<=y.autoTriggerChangeCollisionForCIsUpto)?(y.showRunCollisionDetectionMsg=!1,y.state.loadingCollisions=!0,y.context.scheduledStartTime||(y.context.scheduledStartTime=y.context.scheduledStartDate),y.context.scheduledEndTime||(y.context.scheduledEndTime=y.context.scheduledEndDate),s.getListOfCollisionsAndCiByDate(y.context.scheduledStartDate,y.context.scheduledEndDate,e).then(function(e,t){e&&(y.collisionsCopy=e,y.collisionsCopy.changeList.filter(function(e){e.id===y.context.id&&y.collisionsCopy.changeList.splice(y.collisionsCopy.changeList.indexOf(e),1)}),y.state.loadingCollisions=!1),t&&l.error({text:t,clear:!0})})["finally"](function(){O=!1})):(y.collisionsCopy={},y.showRunCollisionDetectionMsg=!!(y.context.scheduledStartDate&&y.context.scheduledEndDate&&e&&!isNaN(f.autoTriggerChangeCollisionForCIsUpto)&&!_.isUndefined(f.autoTriggerChangeCollisionForCIsUpto)&&e.length&&e.length>y.autoTriggerChangeCollisionForCIsUpto))}function S(e,t){return t=t?moment(t):moment(e),1e3*moment(e).set("hours",t.get("hours")).set("minutes",t.get("minutes")).format("X")}function C(e){y.showRunCollisionDetectionMsg=!!(y.context.scheduledStartDate&&y.context.scheduledEndDate&&e&&e.length&&!isNaN(y.autoTriggerChangeCollisionForCIsUpto)&&!_.isUndefined(y.autoTriggerChangeCollisionForCIsUpto)&&e.length>y.autoTriggerChangeCollisionForCIsUpto)}y.$on(e.WIDGET_VALUE_CHANGE,function(t,a){m.$broadcast(e.WIDGET_VALUE_CHANGE_FROM_WIZARD,a)}),y.$on(e.FIELD_VALUE_CHANGE,function(t,a){m.$broadcast(e.FIELD_VALUE_CHANGE_FROM_WIZARD,a)}),y.showMeridian=window.showMeridian;var O=!y.editMode||y.isNew;y.collisionStates={shouldRefreshCollisions:!1,editCollisionStatus:!1},y.state={loadingCollisions:!1},y.changeFlag=!1,y.asc=!1,y.validator=a,y.tabIds=o,y.disableCollisionManagement=u.disableCollisionManagement,y.collisionsSelected=0,y.currentDate=new Date,y.autoTriggerChangeCollisionForCIsUpto=f.autoTriggerChangeCollisionForCIsUpto,y.isNew||(r.getMetadataByType(EntityVO.TYPE_CHANGE).then(function(e){y.collisionStatuses=e.collisionStatuses}),y.collisionStates.editCollisionStatus=y.context.accessMappings.collisionEditAllowed),y.datePickerOptions={startingDay:f.getWeekStartingDay(),"show-weeks":!1,minDate:moment().year(1970).month(0).date(2),maxDate:moment().year(2038).month(0).date(18)},y.$watch("collisions",function(){y.collisionsCopy=_.cloneDeep(y.collisions),y.collisions&&y.collisions.changeList&&(y.$emit(e.UPDATE_CHANGE_COLLISION_STATUS,y.collisions),y.$emit(e.CHANGE_COLLISION_STATUS_CHANGED,y.collisions.changeList))}),y.$on(e.TOGGLE_CHANGE_CALENDAR,function(e,t){y.expanded=t}),y.openDatePicker=function(e,t){e.open=!0,y.editMode&&t.stopPropagation()},y.updateDateTime=function(e){a.updateDateTime(y[y.tabIds.wizard.dates],y.context,e)},y.editDatesView=function(){T(),y.collisionStates.shouldRefreshCollisions=!1},y.$watch("context.targetDate",function(){y.updateTargetDateTime()}),y.$watch("context.scheduledStartDate",function(t,a){y.$broadcast(e.UPDATE_SCHEDULE_DATE,{name:"scheduledStartDate",value:t}),t=t?t.valueOf():t,a=a?a.valueOf():a,v(t,a)}),y.$watch("context.scheduledEndDate",function(t,a){y.$broadcast(e.UPDATE_SCHEDULE_DATE,{name:"scheduledEndDate",value:t}),t=t?t.valueOf():t,a=a?a.valueOf():a,v(t,a)}),y.$watch("context.linkedCIs",function(){y.editMode&&!y.isNew||(y.context.linkedCIs&&y.context.linkedCIs.length?T():y.collisionsCopy={},y.collisionStates.shouldRefreshCollisions=!1)});var A=m.$on(e.AFFECTED_SERVICE_VALUE_CHANGED,function(e,t){y.editMode&&!y.isNew||(y.context.impactedService=t,T())}),I=m.$on(e.CHANGE_CLASS_VALUE_CHANGED,function(e,t){y.editMode&&!y.isNew||(y.context.timing=t,y.context.useTargetDate=!1,y.clearDates())});y.$watch(o.wizard.dates+".$dirty",function(t){"undefined"!=typeof t&&y.$emit(e.CHANGE_WIZARD_FORM_STATE,{name:y.tabIds.wizard.dates,dirty:t})}),y.$watch(o.wizard.dates+".$invalid",function(t){"undefined"!=typeof t&&y.$emit(e.CHANGE_WIZARD_FORM_STATE,{name:y.tabIds.wizard.dates,invalid:t})}),y.$on(e.CHANGE_COLLISION_SHOW_WEEKENDS,function(e,t){y.showWeekends=t.showWeekends}),y.updateTargetDateTime=function(){y[y.tabIds.wizard.dates]&&a.updateTargetDateTime(y[y.tabIds.wizard.dates],y.context)},y.toggleUseTargetDate=function(){y.context.useTargetDate=!y.context.useTargetDate,y.showRunCollisionDetectionMsg=!1,y.clearDates()},y.useTargetDateCheckboxVisible=function(){return!y.editMode||y.isNew&&y.targetDateSection},y.targetDateErrorMessageVisible=function(){return(y.editMode||y.context.useTargetDate)&&y.dates.targetDate.$invalid},y.targetDateFieldVisible=function(){return y.isNew&&y.context.useTargetDate||!y.isNew&&y.editMode},y.clearDates=function(){y.context.useTargetDate?(y.context.scheduledStartDate=null,y.context.scheduledEndDate=null,y.context.actualStartDate=null,y.context.actualEndDate=null):y.context.targetDate=null,y.$broadcast(e.CLEAR_CHANGE_DATES,y.context.useTargetDate)},y.useTargetDateDisabled=function(){return y.context.timing&&"Latent"===y.context.timing.name},y.isFieldRequired=function(e){var t=!1;return y.context.timing&&(t=n.isFieldRequired(EntityVO.TYPE_CHANGE,"Draft",y.context.timing.name,e)),t},y.isFieldDisabled=function(e){var t=!1;return y.context.timing&&(t=n.isFieldDisabled(EntityVO.TYPE_CHANGE,"Draft",y.context.timing.name,e)),t},y.isFieldEditable=function(e){var t=y.context.accessMappings,a=t&&t.fieldMappings?t.fieldMappings[e]:null;return a?"write"===a:t.datesEditAllowed},y.saveDates=function(){var e={scheduledStartDate:S(y.context.scheduledStartDate),scheduledEndDate:S(y.context.scheduledEndDate),actualStartDate:S(y.context.actualStartDate),actualEndDate:S(y.context.actualEndDate),targetDate:S(y.context.targetDate)};y.state.loadingCollisions=!0;var t=d.update(y.context.id,y.context.type,e);t.then(function(e,t){e&&(_.extend(y.context,e),s.getListOfCollisionsById(y.context,!0).then(function(e){e.count>0&&(y.collisions=e,y.collisionsCopy=_.cloneDeep(y.collisions)),y.state.loadingCollisions=!1})),t&&l.error({text:t,clear:!0})})["finally"](function(){y.collisionStates.editCollisionStatus=y.context.accessMappings.collisionEditAllowed,y.collisionStates.saveDatesAndUpdate=!1})},y.markStatus=function(t){var a=0,n=i.open({templateUrl:"views/change/rationale.html",windowClass:"action-blade",controller:"RationaleController",resolve:{isRationalRequired:function(){return!("Resolved"!==t.name&&"Ignored"!==t.name)}}});n.result.then(function(n){y.collisionsCopy.changeList.filter(function(e){for(a=0;a<e.configurationItems.length;a++)e.configurationItems[a].selected&&e.configurationItems[a].status&&e.configurationItems[a].status.name!==t.name&&("Resolved"!==e.configurationItems[a].status.name&&"Ignored"!==e.configurationItems[a].status.name||(e.ciCount=e.ciCount+1),e.configurationItems[a].status=t,e.configurationItems[a].rationale=n,"Resolved"!==t.name&&"Ignored"!==t.name||(e.ciCount=e.ciCount-1),e.configurationItems[a].modified=!0)}),y.collisions.changeList=y.collisionsCopy.changeList,y.changeFlag=!1,y.selectAllToggle(!1),y.$emit(e.UPDATE_CHANGE_COLLISION_STATUS,y.collisions),y.$emit(e.CHANGE_COLLISION_STATUS_CHANGED,y.collisions.changeList)})},y.selectAllToggle=function(e){var t=0;if(y.collisionsCopy&&y.collisionsCopy.changeList){for(var a=0;a<y.collisionsCopy.changeList.length;a++){y.collisionsCopy.changeList[a].selected=e,t+=y.collisionsCopy.changeList[a].configurationItems.length;for(var n=0;n<y.collisionsCopy.changeList[a].configurationItems.length;n++)y.collisionsCopy.changeList[a].configurationItems[n].selected=e}e?y.collisionsSelected=t:y.collisionsSelected=0}},y.selectAllChanges=function(e){y.changeFlag=!e,y.selectAllToggle(y.changeFlag)},y.selectChange=function(e){e.selected=!e.selected,e.show=e.selected,e.selected||(y.collisionsSelected=y.collisionsSelected-e.configurationItems.length);for(var t=0;t<e.configurationItems.length;t++)e.selected&&!e.configurationItems[t].selected&&y.collisionsSelected++,e.configurationItems[t].selected=e.selected},y.selectCIs=function(e,t){e.selected=!e.selected,e.selected?y.collisionsSelected++:y.collisionsSelected--,e.selected||(t.selected=e.selected)},y.showEmailForm=function(){var e=[];return _.each(y.collisionsCopy.changeList,function(a){a.assignee.id&&(a.assignee.loginId=a.assignee.id,a.assignee.type=t("i18n")("change.detail.emailRecipients.allCollisionManagers"),e.push(a.assignee))}),e=_.uniqBy(e,"id"),c.createEmail([y.context],e)};var b;p.screensCacheByName[y.screenLayout.name]?(b=y.screenLayout&&p.screensCacheByName[y.screenLayout.name]?p.screensCacheByName[y.screenLayout.name].panels:[],y.scheduledDatesSection=_.find(b,{name:"scheduledDatesSection"}),y.actualDatesSection=_.find(b,{name:"actualDatesSection"}),y.targetDateSection=_.find(b,{name:"targetDateSection"})):p.loadScreenConfigurationByName(y.screenLayout.name).then(function(e){b=e.panels,y.scheduledDatesSection=_.find(b,{name:"scheduledDatesSection"}),y.actualDatesSection=_.find(b,{name:"actualDatesSection"}),y.targetDateSection=_.find(b,{name:"targetDateSection"})}),y.panelChildrenCount=function(t){if(t){var a=_.find(b,{name:t}),n=t.replace(/Section/g,""),i=_.find(a.fields,{name:n});if(a&&i)return 1;_.find(b,function(a){if(a.fields){var i,o=_.find(a.fields,{name:n});if(o)return y[t].fields.push(o),i={screenPanelSection:y[t],datesField:o},y.$emit(e.REMOVE_CHANGE_DATES_FROM_PANEL,i),1}})}return 0},y.editMode&&y.selectAllToggle(!1),y.$on(e.UPDATE_DATE_LABEL_VISIBILITY,function(e,t){switch(t.name){case"scheduledDates":y.scheduledDatesSection&&y.scheduledDatesSection.fields&&y.scheduledDatesSection.fields[0]&&y.scheduledDatesSection.fields[0].hasOwnProperty("isHidden")&&(y.scheduledDatesSection.fields[0].isHidden=t.isHidden);break;case"actualDates":y.actualDatesSection&&y.actualDatesSection.fields&&y.actualDatesSection.fields[0]&&y.actualDatesSection.fields[0].hasOwnProperty("isHidden")&&(y.actualDatesSection.fields[0].isHidden=t.isHidden);break;case"targetDate":y.targetDateSection&&y.targetDateSection.fields&&y.targetDateSection.fields[0]&&y.targetDateSection.fields[0].hasOwnProperty("isHidden")&&(y.targetDateSection.fields[0].isHidden=t.isHidden)}});var k,D=0;y.$on(e.FIELD_AREA_ATTACHED,function(e,t){k=k||E.find(".panel-field-area").length,D++,k===D&&(console.log("All custom-area directives are loaded!"),p.allFieldsLoaded.datesTab=!0,(p.allFieldsLoaded.basicTab||y.screenLayout.name===ScreenConfigurationVO.prototype.CHANGE_VIEW_SCREEN)&&h(function(){g.handleTicketLoad()}))}),y.$on("$destroy",function(){A(),I()})}}}])}(),function(){angular.module("changeModule").directive("documentsTab",["events","tabIds","ticketModel",function(e,t,a){return{restrict:"E",replace:!0,templateUrl:"views/change/documents-tab.html",scope:{isNoteRequired:"=",context:"=",docTypes:"=",editMode:"=",metadata:"=?"},link:function(a){function n(e,t){return"Array"!==Object.prototype.toString.call(e).slice(8,-1)?e:[].concat.apply([],e.map(function(a,n){return a.plans&&0!==a.plans.length||(a.plans=[{attachments:[],desc:""}]),a.activePlanIndex=0,n%t?[]:[e.slice(n,n+t)]}))}a.$watch(function(){return a.documents},function(e){e&&(a.$parent.$parent.documents=a.documents)}),a.attachmentLimit=3,a.state={documentsSelected:!1,allDocumentsSelected:!1},a.defaultDocumentTypes=_.cloneDeep(a.docTypes)||[],a.docTypesPicked=0,a.editMode?(a.selectedDocumentTypes=a.context.documents,a.docTypesPicked=a.context.documents.length||0,a.documentsChunked=n(a.selectedDocumentTypes,2),a.selectedDocumentTypes&&a.selectedDocumentTypes.length>0&&(a.state.documentsSelected=!0)):a.context.documents=a.selectedDocumentTypes,a.documentsTab={currentNote:{id:"note",attachments:[]},allUserNotes:[]},a.addNote={inputText:""},a.handleDocumentsControlButtonClick=function(t){!_.isUndefined(t)&&"docSelect"===t&&a.editMode&&a.markSelectedDocTypeInvisible(),a.state.documentsSelected=!a.state.documentsSelected,a.context.documents=a.selectedDocumentTypes,a.editMode&&a.$emit(e.CHANGE_REQUEST_PLANS_EDIT_STATUS,{hideButtons:!a.state.documentsSelected})},a.markSelectedDocTypeInvisible=function(){_.each(a.selectedDocumentTypes,function(e){_.each(a.defaultDocumentTypes,function(t){t.name===e.name&&(t.invisible=!0)})})},a.toggleDocumentBlock=function(t,i){t.active=!t.active,t.active?a.docTypesPicked++:a.docTypesPicked--&&(a.state.allDocumentsSelected=!1),t.active||(a.selectedDocumentTypes=_.without(a.selectedDocumentTypes,t)),0===a.selectedDocumentTypes&&(a.showSave=!0),0===a.docTypesPicked?(_.forEach(a.defaultDocumentTypes,function(e){e.active=!1,e.plans=[]}),a.selectedDocumentTypes=[],a.documentsChunked=[],a.state.documentsSelected=!1,a.$emit(e.CHANGE_REQUEST_PLANS_EDIT_STATUS,{hideButtons:!0,showSave:!0})):i||(a.selectedDocumentTypes=_.filter(a.defaultDocumentTypes,{active:!0}),a.documentsChunked=n(a.selectedDocumentTypes,2))},a.handleKeydown=function(e,t){32===e.keyCode&&(a.toggleDocumentBlock(t),e.stopPropagation())},a.selectAllDocuments=function(){a.state.allDocumentsSelected=!a.state.allDocumentsSelected,a.docTypesPicked=a.state.allDocumentsSelected?a.defaultDocumentTypes.length:0,_.each(a.defaultDocumentTypes,function(e){e.active=a.state.allDocumentsSelected}),a.selectedDocumentTypes=_.filter(a.defaultDocumentTypes,{active:!0}),a.documentsChunked=n(a.selectedDocumentTypes,2)},a.addSameTypePlan=function(e){e.activePlanIndex=parseInt(e.plans.push({attachments:[],desc:""})-1)},a.removeActivePlanTab=function(e){var t=e.activePlanIndex;e.plans[e.activePlanIndex].workNote&&e.plans[e.activePlanIndex].workNote.locked||(e.plans.splice(t,1),e.activePlanIndex=0,0===e.plans.length&&(a.toggleDocumentBlock(e,!0),a.documentsChunked=n(a.selectedDocumentTypes,2)),
e.invisible=!1);var i=_.findIndex(a.defaultDocumentTypes,function(t){return t.name===e.name});_.isUndefined(i)||i===-1||(a.defaultDocumentTypes[i]=e)},a.changeDocumentTab=function(e,t){var a=e.plans.indexOf(t);e.activePlanIndex=a,e.isLocked=t.workNote&&t.workNote.locked},a.$on(e.DISCARD_DOCUMENTS,function(){a.context.documents=[],a.state.documentsSelected=!1,a.state.allDocumentsSelected=!1,_.each(a.defaultDocumentTypes,function(e){e.active=a.state.allDocumentsSelected,e.plans=[],e.plans.push({attachments:[],desc:""}),e.activePlanIndex=0})}),a.$watch(t.wizard.documents+".$invalid",function(n){"undefined"!=typeof n&&(a.$emit(e.CHANGE_WIZARD_FORM_STATE,{name:t.wizard.documents,invalid:n}),a.$emit(e.RELEASE_WIZARD_FORM_STATE,{name:t.wizard.documents,invalid:n}))})}}}])}(),function(){angular.module("changeModule").controller("EditChangeRequestPlansController",["$scope","planEditParams",function(e,t){e.changeMetadata=t.metadata,e.basicData=t.ticket,e.editMode=!0,e.submit=function(){}}])}(),function(){angular.module("changeModule").controller("EditDatesController",["$scope","collisionModel","systemAlertService","events","ticketModel","$q","$state","$stateParams","tabIds","$timeout","screenConfigurationModel","layoutConfigurationModel","metadataModel","objectValueMapperService","relationModel","configurationModel",function(e,t,a,n,i,o,r,s,l,c,d,u,p,m,f,g){function h(){var t,a=[],n=[];if(e.collisions&&e.collisions.changeList&&e.collisions.changeList.forEach(function(e){for(var t=0;t<e.configurationItems.length;t++)e.configurationItems[t].modified&&e.configurationItems[t].status&&e.configurationItems[t].status.name&&a.push({status:{value:e.configurationItems[t].status.name,reason:e.configurationItems[t].rationale},configurationItem:{reconciliationId:e.configurationItems[t].reconciliationId,refTicketId:e.id,name:e.configurationItems[t].name}})}),a.length>0)for(var i=0;i<a.length;i++){t=!1;for(var o=0;o<n.length&&n.length>0;o++)if(n[o].status.value===a[i].status.value&&n[o].status.reason===a[i].status.reason){n[o].configurationItems.push(a[i].configurationItem),t=!0;break}t||(n.push({status:a[i].status}),n[n.length-1].configurationItems=[],n[n.length-1].configurationItems.push(a[i].configurationItem))}return n}function y(){var e=m.getFieldList(),t={customFields:{}};return _.forEach(e,function(e,a){!_.isEmpty(e.value)||_.isNumber(e.value)||_.isDate(e.value)?_.isObject(e.value)&&Object.keys(e.value).length>0?angular.extend(t,e.value):e.ootb?t[a]=e.value:e.ootb||e.dataType!==FieldVO.prototype.DATA_TYPE_DATE&&e.dataType!==FieldVO.prototype.DATA_TYPE_TIME&&e.dataType!==FieldVO.prototype.DATA_TYPE_DATE_TIME?t.customFields[a]=e.value:t.customFields[a]=e.getValue():e.ootb?t[a]=e.getValue():t.customFields[a]=e.getValue()}),{scheduledStartDate:E(t.scheduledStartDate),scheduledEndDate:E(t.scheduledEndDate),actualStartDate:E(t.actualStartDate),actualEndDate:E(t.actualEndDate),targetDate:E(t.targetDate),customFields:t.customFields}}function E(e,t){return t=t?moment(t):moment(e),1e3*moment(e).set("hours",t.get("hours")).set("minutes",t.get("minutes")).format("X")}m.clearMap(EntityVO.TYPE_CHANGE),e.editMode=!0,e.datesToBeRemovedFromPanel=[],e.state={resolvingCollisions:!1,formInit:!0,editDatesFormInvalid:!1,noPendingTicketDates:!0,noPendingCollisionsStatus:!0},p.getMetadataByType(EntityVO.TYPE_CHANGE).then(function(t){e.metadata=t}),o.all([i.getTicket(s.id,EntityVO.TYPE_CHANGE,!0),f.getRelations(s.id,EntityVO.TYPE_CHANGE)]).then(function(a){e.context=a[0],e.context.linkedCIs=a[1]&&a[1].length&&_.filter(a[1],{type:EntityVO.TYPE_ASSET}),e.context.scheduledStartDatePicker={open:!1},e.context.scheduledEndDatePicker={open:!1},e.context.actualStartDatePicker={open:!1},e.context.actualEndDatePicker={open:!1},e.context.targetDatePicker={open:!1},r.go(".calendar.book",{id:e.context.id});var n=[];e.context.linkedCIs&&e.context.linkedCIs.length&&n.push.apply(n,e.context.linkedCIs),e.context.impactedService&&e.context.impactedService.reconciliationId&&(_.find(n,{id:e.context.impactedService.reconciliationId})||n.push({id:e.context.impactedService.reconciliationId})),e.context.scheduledStartDate&&e.context.scheduledEndDate&&n&&n.length&&(isNaN(g.autoTriggerChangeCollisionForCIsUpto)||_.isUndefined(g.autoTriggerChangeCollisionForCIsUpto)||n.length<=g.autoTriggerChangeCollisionForCIsUpto)&&t.getListOfCollisionsById(e.context,!0).then(function(t){t.count>0&&(e.collisions=t)})});var v=d.getScreenNameByTicketType(EntityVO.TYPE_CHANGE);u.loadScreenLayout(v).then(function(t){e.screenLayout=t,e.datesCustomFields=_.filter(e.screenLayout.panels,{name:"datesSection"})}),e.cancel=function(){_.forEach(e.datesToBeRemovedFromPanel,function(e){e.screenPanelSection.fields&&_.remove(e.screenPanelSection.fields,{name:e.datesField.name})}),r.go("change",{id:s.id})},e.resolveCollisions=function(){var n,r=[];e.state.editDatesFormInvalid||(e.state.resolvingCollisions=!0,r.push(i.update(e.context.id,e.context.type,y())),n=h(),e.collisions&&n&&n.length&&r.push(t.addCollisionStatuses(n,e.context.id)),o.all(r).then(function(t){500!==t[0].status?(e.context=t[0],e.collisions=t[1],_.forEach(e.datesToBeRemovedFromPanel,function(e){e.screenPanelSection.fields&&_.remove(e.screenPanelSection.fields,{name:e.datesField.name})}),e.cancel()):a.error({text:t[0].data.error,clear:!0}),e.state.resolvingCollisions=!1}))},e.$on(n.CHANGE_WIZARD_FORM_STATE,function(t,a){a.name===l.wizard.dates&&(c(function(){e.state.formInit&&(e.state.formInit=!e.state.formInit)}),e.state.formInit||(e.state.noPendingTicketDates=a.invalid,e.state.editDatesFormInvalid=a.invalid))}),e.$on(n.UPDATE_CHANGE_COLLISION_STATUS,function(t,a){e.state.noPendingCollisionsStatus=!1,e.collisions=a}),e.$on(n.REMOVE_CHANGE_DATES_FROM_PANEL,function(t,a){a&&e.datesToBeRemovedFromPanel.push(a)})}])}(),function(){angular.module("changeModule").controller("ImpactAnalysisController",["$scope","ticketModel","relationModel","systemAlertService","$filter","i18nService","$stateParams","$state",function(e,t,a,n,i,o,r,s){function l(){e.state.isLoading=!0,e.displayId=r.displayId,t.getImpactAnalysisVisualisationData(r.type,r.id).then(function(t){m=t.impactedCIs;var a=t.impactAssociations,n=[],i=[];_.each(m,function(e){e.isService&&p.push(e);var t=e.subType.toLowerCase().replace(" ",""),a={group:"nodes",data:{id:e.reconciliationId,label:e.name,icon:t},classes:t};n.push(a)}),e.servicesCount=p.length,_.each(a,function(e){var t=e.impactingCI,a=e.impactedCI,n={group:"edges",data:{source:t.reconciliationId,target:a.reconciliationId}};i.push(n)}),e.edges=i,e.nodes=n,e.nodes.length>1e3&&(e.state.preparingGraph=!0,e.state.largeData=!0),e.state.isLoading=!1})}function c(){var a={command:"dismiss"};t.impactAnalysisAction(r.id,EntityVO.TYPE_CHANGE,a),e.close()}function d(e){var t={type:"info",title:o.getLocalizedString("impactAnalysis.relateAndComplete.title"),text:o.getLocalizedStringwithParams("impactAnalysis.relateAndComplete.question",[e.length]),details:o.getLocalizedString("impactAnalysis.relateAndComplete.details"),buttons:[{text:o.getLocalizedString("impactAnalysis.relateAndComplete.confirmation.yes"),data:!0},{text:o.getLocalizedString("impactAnalysis.relateAndComplete.confirmation.no"),data:!1}]};return e.length>=80&&(t.additionalInfo=o.getLocalizedString("create.change.wizard.ci.confirmCIRelation.text")),n.modal(t).result.then(function(t){if(t)return u(e)})}function u(t){e.showProgressModal=!0,a.addRelation({uuid:r.id,type:EntityVO.TYPE_CHANGE},t)["finally"](function(){e.showProgressModal=!1,n.success({text:i("i18n")("ticket.notification.link.message",t.length),hide:1e4}),c()})}var p=[],m=[];e.state={isLoading:!1,preparingGraph:!1,largeData:!1,isFixed:!1,isFullScreen:!1},e.edges=[],e.nodes=[],e.servicesCount=0,e.selections=[],e.$on("impactGraphInit",function(t,a){1===a.state?e.state.preparingGraph=!0:0===a.state&&(e.state.preparingGraph=!1)}),l(),e.relateServices=function(){var e=[];_.each(p,function(t){t.isRelated||e.push({id:t.reconciliationId,desc:t.name,tag:"linkeditem",relationshipType:"impacts",type:"asset"})}),d(e)},e.relateSelected=function(){var t=[];_.each(e.selections,function(e){t.push({id:e,tag:"linkeditem",relationshipType:"impacts",type:"asset"})}),d(t)},e.relateAll=function(){var e=[];_.each(m,function(t){t.isRelated||e.push({id:t.reconciliationId,desc:t.name,tag:"linkeditem",relationshipType:"impacts",type:"asset"})}),d(e)},e.close=function(){s.go("change",{id:r.id})},e.discard=function(){return n.modal({title:o.getLocalizedString("impact.analysis.dismiss.modal.title"),text:o.getLocalizedString("impact.analysis.dismiss.modal.text"),buttons:[{text:o.getLocalizedString("common.button.yes"),data:!0},{text:o.getLocalizedString("common.button.no"),data:!1}]}).result.then(function(e){e&&c()})}}])}(),function(){angular.module("changeModule").directive("impactedAreas",[function(){return{restrict:"E",templateUrl:"views/change/impacted-areas.html",scope:{ticket:"=",removable:"="},link:function(e){e.formatImpactedArea=function(e){var t=_.filter([e.company.name,e.site?e.site.region:null,e.site?e.site.siteGroup:null,e.site?e.site.name:null,e.organization,e.department],function(e){return e}).join(" > ");return t},e.removeImpactedArea=function(t){e.ticket.addedImpactedAreas=e.ticket.addedImpactedAreas||[],e.ticket.removedImpactedAreas=e.ticket.removedImpactedAreas||[];var a=e.ticket.impactedAreas[t];e.ticket.impactedAreas.splice(t,1),_.includes(e.ticket.addedImpactedAreas,a)?_.remove(e.ticket.addedImpactedAreas,a):e.ticket.removedImpactedAreas.push(a)}}}}])}(),function(){angular.module("changeModule").directive("impactedAreasEditor",["systemAlertService","$filter","searchModel",function(e,t,a){return{restrict:"E",templateUrl:"views/change/impacted-areas-editor.html",scope:{ticket:"="},controller:["$scope","userModel","createTicketModel","events","$q","ticketModel",function(n,i,o,r,s,l){function c(){f=_.clone(n.ticket.impactedAreas),m()}function d(){n.$emit(r.SAVE_CHANGES_REQUEST,{},!0),n.state.pendingTicketDatesChange?s.all([l.saveImpactedAreas(n.ticket.id,n.ticket.type,n.ticket.addedImpactedAreas),l.deleteImpactedAreas(n.ticket.id,n.ticket.type,n.ticket.removedImpactedAreas)]).then(function(){n.$emit(r.SAVE_CHANGES_COMPLETE),n.ticket.addedImpactedAreas=[],n.ticket.removedImpactedAreas=[],p()})["catch"](function(t){t.data&&t.data.defaultMessage&&e.error({text:t.data.defaultMessage,clear:!1}),n.$emit(r.SAVE_CHANGES_COMPLETE),n.ticket.addedImpactedAreas=[],n.ticket.removedImpactedAreas=[],p()}):n.$emit(r.SAVE_CHANGES_COMPLETE)}function u(){n.ticket.impactedAreas=f,n.ticket.addedImpactedAreas=[],m()}function p(){m()}function m(){n.state.pendingTicketDatesChange=!1}var f=_.clone(n.ticket.impactedAreas);n.state={},n.selections={},a.getOperatingCompanies().then(function(e){n.selections.companies=_.cloneDeep(e.companies),n.state.tooManyCompanies=e.exceedsChunkSize}),n.$watchCollection("ticket.impactedAreas",function(){n.state.pendingTicketDatesChange=!n.ticket.isDraft}),n.$watch("ticket.company",function(e){e&&(n.currentImpactedArea={company:e})}),n.$watch("currentImpactedArea.company",function(e){e&&(n.currentImpactedArea.region=null,n.currentImpactedArea.siteGroup=null,n.currentImpactedArea.site=null,n.loadOrganizations(),n.loadRegions(),n.loadSiteGroups(),n.loadSites())}),n.$watch("currentImpactedArea.organization",function(e){e&&n.loadDepartments()}),n.$watch("currentImpactedArea.region",function(e){e&&(n.currentImpactedArea.siteGroup&&n.currentImpactedArea.siteGroup.attributeMap.regionName!==e.name&&(n.currentImpactedArea.siteGroup=null),n.currentImpactedArea.site&&n.currentImpactedArea.site.attributeMap.regionName!==e.name&&(n.currentImpactedArea.site=null),n.loadSiteGroups(),n.loadSites())}),n.$watch("currentImpactedArea.siteGroup",function(e){e&&(n.currentImpactedArea.region={name:e.attributeMap.regionName},n.currentImpactedArea.site&&n.currentImpactedArea.site.attributeMap.siteGroupName!==e.name&&(n.currentImpactedArea.site=null))}),n.$watch("currentImpactedArea.site",function(e){e&&(n.currentImpactedArea.siteGroup={name:e.attributeMap.siteGroupName,attributeMap:{regionName:e.attributeMap.regionName}})}),n.getCompaniesByName=function(e){return a.getCompaniesByText(e).then(function(e){return{list:e.companies,exceedsChunkSize:e.exceedsChunkSize}})},n.loadOrganizations=function(){n.currentImpactedArea.organization=null,n.currentImpactedArea.department=null,n.selections.organizations=null,n.state.organizationsLoading=!0;var e={companyName:n.currentImpactedArea.company.name};o.getList(EntityVO.TYPE_ORGANIZATION,e).then(function(e){n.state.organizationsLoading=!1,n.selections.organizations=e.objects,n.state.tooManyOrganizations=e.exceedsChunkSize})},n.loadDepartments=function(){n.currentImpactedArea.department=null,n.selections.departments=null,n.state.departmentsLoading=!0;var e={companyName:n.currentImpactedArea.company.name,organizationName:n.currentImpactedArea.organization.name};o.getList(EntityVO.TYPE_DEPARTMENT,e).then(function(e){n.state.departmentsLoading=!1,n.selections.departments=e.objects,n.state.tooManyDepartments=e.exceedsChunkSize})},n.loadRegions=function(){n.selections.regions=null,n.state.regionsLoading=!0;var e={companyName:n.currentImpactedArea.company.name};o.getList(EntityVO.TYPE_REGION,e).then(function(e){n.state.regionsLoading=!1,n.selections.regions=e.objects,n.state.tooManyRegions=e.exceedsChunkSize})},n.loadSiteGroups=function(){n.selections.siteGroups=null,n.state.siteGroupsLoading=!0;var e={companyName:n.currentImpactedArea.company.name};n.currentImpactedArea.region&&(e.regionName=n.currentImpactedArea.region.name),o.getList(EntityVO.TYPE_SITE_GROUP,e).then(function(e){n.state.siteGroupsLoading=!1,n.selections.siteGroups=e.objects,n.state.tooManySiteGroups=e.exceedsChunkSize})},n.loadSites=function(){n.selections.sites=null,n.state.sitesLoading=!0;var e={companyName:n.currentImpactedArea.company.name};n.currentImpactedArea.region&&(e.regionName=n.currentImpactedArea.region.name),n.currentImpactedArea.siteGroup&&(e.siteGroupName=n.currentImpactedArea.siteGroup.name),o.getList(EntityVO.TYPE_SITE,e).then(function(e){n.state.sitesLoading=!1,n.selections.sites=e.objects,n.state.tooManySites=e.exceedsChunkSize})},n.loadRegionsByName=function(e){var t={companyName:n.currentImpactedArea.company.name};return o.getListOfRegionsByName(t,e).then(function(e){return n.state.regionsLoading=!1,{list:e.objects,exceedsChunkSize:e.exceedsChunkSize}})},n.loadSiteGroupsByName=function(e){var t={companyName:n.currentImpactedArea.company.name};return n.currentImpactedArea.region&&(t.regionName=n.currentImpactedArea.region.name),o.getListOfSiteGroupsByName(t,e).then(function(e){return n.state.siteGroupsLoading=!1,{list:e.objects,exceedsChunkSize:e.exceedsChunkSize}})},n.loadSitesByName=function(e){var t={companyName:n.currentImpactedArea.company.name};return n.currentImpactedArea.region&&(t.regionName=n.currentImpactedArea.region.name),n.currentImpactedArea.siteGroup&&(t.siteGroupName=n.currentImpactedArea.siteGroup.name),o.getListOfSitesByName(t,e).then(function(e){return n.state.sitesLoading=!1,{list:e.objects,exceedsChunkSize:e.exceedsChunkSize}})},n.loadOrganizationsByName=function(e){var t={companyName:n.currentImpactedArea.company.name};return o.getListOfOrganizationsByName(t,e).then(function(e){return n.state.organizationsLoading=!1,{list:e.objects,exceedsChunkSize:e.exceedsChunkSize}})},n.loadDepartmentsByName=function(e){var t={companyName:n.currentImpactedArea.company.name,organizationName:n.currentImpactedArea.organization.name};return o.getListOfDepartmentsByName(t,e).then(function(e){return n.state.departmentsLoading=!1,{list:e.objects,exceedsChunkSize:e.exceedsChunkSize}})},n.addImpactedArea=function(){var a={company:{name:n.currentImpactedArea.company.name}};n.currentImpactedArea.site&&(a.site=a.site||{},a.site.name=n.currentImpactedArea.site.name),n.currentImpactedArea.region&&(a.site=a.site||{},a.site.region=n.currentImpactedArea.region.name),n.currentImpactedArea.siteGroup&&(a.site=a.site||{},a.site.siteGroup=n.currentImpactedArea.siteGroup.name),n.currentImpactedArea.organization&&(a.organization=n.currentImpactedArea.organization.name),n.currentImpactedArea.department&&(a.department=n.currentImpactedArea.department.name),0===_.filter(n.ticket.impactedAreas,a).length?(n.ticket.impactedAreas=n.ticket.impactedAreas||[],n.ticket.impactedAreas.push(a),n.ticket.addedImpactedAreas=n.ticket.addedImpactedAreas||[],n.ticket.addedImpactedAreas.push(a)):e.error({text:t("i18n")("create.change.wizard.basicDetails.impactedAreas.duplicateError"),clear:!1}),n.currentImpactedArea={company:n.ticket.company}},n.$on(r.TOGGLE_EDIT_MODE,c),n.$on(r.SAVE_CHANGES,d),n.$on(r.DISCARD_CHANGES,u),n.$on(r.SAVE_ALL_CHANGES_COMPLETE,function(){})}]}}])}(),function(){angular.module("changeModule").directive("outagePopoverContent",[function(){return{restrict:"E",replace:!0,templateUrl:"views/change/outage-popover-content.html",link:function(e){e.info=e.outage.additionalInformation}}}])}(),function(){angular.module("changeModule").directive("outagePopoverTitle",[function(){return{restrict:"E",replace:!0,templateUrl:"views/change/outage-popover-title.html"}}])}(),function(){angular.module("changeModule").controller("RationaleController",["$scope","$modalInstance","isRationalRequired",function(e,t,a){e.textAreaIsFocused=!1,e.rationale="",e.isRationalRequired=a,e.done=function(){t.close(e.rationale)},e.cancel=function(){t.dismiss()},e.$on("$stateChangeStart",function(){e.cancel()})}])}(),function(){angular.module("changeModule").directive("riskLevelBadge",["metadataModel",function(e){return{restrict:"E",replace:!0,templateUrl:"views/change/risk-level-badge.html",scope:{riskLevel:"="},link:function(t){function a(){e.getMetadataByType(EntityVO.TYPE_CHANGE).then(function(e){angular.extend(t.metadata,e)})}t.metadata={},t.riskLevelCls=function(){var e=_.findIndex(t.metadata.riskLevels,function(e){return e.name===t.riskLevel});return"ticket__risk-level-"+(e+1)},a()}}}])}(),function(){angular.module("changeModule").directive("riskLevel",[function(){return{restrict:"E",templateUrl:"views/change/risk-level.html",scope:{ticket:"=",mode:"=",metadata:"="},controller:["$scope","events","ticketModel",function(e,t,a){function n(){e.mode="manual",e.ticket.riskLevel=e.ticket.riskLevel?_.head(_.filter(e.metadata.riskLevels,{name:e.ticket.riskLevel})):_.head(e.metadata.riskLevels),s(),e.ticket.riskLevelCopy=e.ticket.riskLevel.name}function i(){var n={};e.$emit(t.SAVE_CHANGES_REQUEST,{},!0),e.state.pendingRiskLevelChange&&"manual"===e.mode&&e.ticket.riskLevel.name!==e.ticket.riskLevelCopy||"release"===e.ticket.type&&"auto"===e.mode?(e.ticket.riskLevel.name&&(e.ticket.riskLevel=e.ticket.riskLevel.name),n.riskLevel=e.ticket.riskLevel,"release"===e.ticket.type&&"auto"===e.mode&&(n.isAutoCalcualteRisk=!0),a.update(e.ticket.id,e.ticket.type,n).then(function(){e.$emit(t.SAVE_CHANGES_COMPLETE),s()},function(){e.$emit(t.SAVE_CHANGES_FAULT_CONTINUE)})):(e.$emit(t.SAVE_CHANGES_COMPLETE),o())}function o(){e.ticket.riskLevelCopy&&(e.ticket.riskLevel=e.ticket.riskLevelCopy),s()}function r(){e.state.pendingRiskLevelChange=!0}function s(){e.mode="manual",e.state.pendingRiskLevelChange=!1}e.state={pendingRiskLevelChange:!1},e.$watch("mode",function(t){t&&"manual"===t&&e.metadata.riskLevels&&!e.ticket.riskLevel&&e.riskLevelChanged(_.head(e.metadata.riskLevels))}),e.overrideRiskLevelEnabled=function(){return e.mode&&"manual"===e.mode},e.riskLevelCls=function(t,a){var n="";if(e.ticket.riskLevel===t||e.ticket.riskLevel===t.name){var i=e.metadata.riskLevels.length-a;e.ticket.titleRiskLevelCls="risk-level-"+i,e.ticket.backgroundRiskLevelCls="ticket__risk-level-"+i,n="active "+e.ticket.backgroundRiskLevelCls}return n},e.riskLevelChanged=function(t){e.ticket.riskLevel=t,e.ticket.riskIsUserSpecified=!0,r()},e.$on(t.TOGGLE_EDIT_MODE,n),e.$on(t.SAVE_CHANGES,i),e.$on(t.DISCARD_CHANGES,o),e.$on(t.SAVE_ALL_CHANGES_COMPLETE,function(){})}]}}])}(),function(){angular.module("changeModule").directive("riskQuestions",[function(){return{restrict:"E",templateUrl:"views/change/risk-questions.html",scope:{ticket:"=",mode:"=",pendingReload:"=",reloadIf:"=",form:"=",editMode:"="},controller:["$scope","createTicketModel","events","$state","systemAlertService",function(e,t,a,n,i){function o(){e.ticket.questionResponses&&(e.responsesCopy=e.ticket.questionResponses),e.questionResponsesCopy=null,angular.forEach(e.responsesCopy,function(t){var a=_.head(_.filter(e.ticket.questionDefinitions,{id:t.questionId}));if(a){var n=_.head(_.filter(a.options,{id:t.optionId}));n&&e.selectQuestionOption(a,n),a.responseId=t.id}d()})}function r(){e.ticket.questionDefinitions=null,e.reloadIf=!0}function s(){e.$emit(a.SAVE_CHANGES_REQUEST,{},!0),e.ticket.questionResponses=e.questionResponsesCopy,e.state.pendingRiskQuestionsChange&&"auto"===e.mode?t.saveRiskResponse(e.ticket).then(function(){e.$emit(a.SAVE_CHANGES_COMPLETE),d(),n.go(n.current,{},{reload:!0})},function(t){i.error({text:t.data&&t.data.error,clear:!1}),e.mode="auto",e.$emit(a.SAVE_CHANGES_FAULT_CONTINUE)}):(e.$emit(a.SAVE_CHANGES_COMPLETE),l())}function l(){e.ticket.questionResponses=e.responsesCopy,d()}function c(){e.state.pendingRiskQuestionsChange=!0}function d(){e.state.pendingRiskQuestionsChange=!1}e.responsesCopy=e.ticket.questionResponses,e.state={},e.$watch("mode",function(t,a){t&&"auto"===t&&"manual"===a&&(e.ticket.riskIsUserSpecified=!1,_.forEach(e.ticket.questionDefinitions,function(t){t.selectedOption=e.questionResponsesCopy&&_.cloneDeep(e.questionResponsesCopy[t.id]),t.selectedOption&&(t.selectedOption.parentQuestion=null)}),e.ticket.questionResponses=e.questionResponsesCopy,c())}),e.riskQuestionsEnabled=function(){return e.mode&&"auto"===e.mode},e.questionOptionSelected=function(t,a){return e.questionResponsesCopy&&e.questionResponsesCopy[t.id]===a},e.selectQuestionOption=function(t,a){a.parentQuestion=_.cloneDeep(t),e.questionResponsesCopy=e.questionResponsesCopy||{};var n=e.questionResponsesCopy[t.id]&&e.questionResponsesCopy[t.id]===a?null:a;e.questionResponsesCopy[t.id]=n,t.selectedOption=_.cloneDeep(n),t.selectedOption.parentQuestion=null,e.ticket.questionResponses=e.questionResponsesCopy,c()},e.$watch("reloadIf",function(){e.reloadIf&&e.loadRiskQuestions()}),e.loadRiskQuestions=function(){e.ticket.company&&e.ticket.categorizations&&(e.ticket.questionDefinitions=null,e.ticket.questionResponses=null,e.state.questionsLoading=!0,t.getList(EntityVO.TYPE_RISKQUESTION,{companies:[e.ticket.company],categorizations:e.ticket.categorizations}).then(function(t){e.reloadIf=!1,e.state.questionsLoading=!1,e.ticket.questionDefinitions=t,"auto"===e.mode&&0===t.length&&(e.mode=""),e.editMode&&o()}))},e.$on(a.TOGGLE_EDIT_MODE,r),e.$on(a.SAVE_CHANGES,s),e.$on(a.DISCARD_CHANGES,l),e.$on(a.SAVE_ALL_CHANGES_COMPLETE,function(){})}]}}])}(),function(){angular.module("changeModule").directive("risks",["screenConfigurationModel","tabIds","events","$rootScope",function(e,t,a,n){return{restrict:"E",replace:!0,templateUrl:"views/change/risks.html",scope:{context:"=",risksCustomFields:"=",screenLayout:"=",metadata:"=",editMode:"=",isNew:"="},link:function(i){i.$on(a.WIDGET_VALUE_CHANGE,function(e,t){n.$broadcast(a.WIDGET_VALUE_CHANGE_FROM_WIZARD,t)}),i.$on(a.FIELD_VALUE_CHANGE,function(e,t){n.$broadcast(a.FIELD_VALUE_CHANGE_FROM_WIZARD,t)}),i.tabIds=t;var o=i.screenLayout&&e.screensCacheByName[i.screenLayout.name]?e.screensCacheByName[i.screenLayout.name].panels:[];i.riskSection=_.find(o,{name:"riskPanel"}),i.panelChildrenCount=function(e){var t=_.find(o,{name:e});return t&&t.fields?t.fields.length:0},i.$watch(t.wizard.risks+".$invalid",function(e){"undefined"!=typeof e&&i.$emit(a.CHANGE_WIZARD_FORM_STATE,{name:i.tabIds.wizard.risks,invalid:e})}),i.$watch(t.wizard.risks+".$dirty",function(e){"undefined"!=typeof e&&i.$emit(a.CHANGE_WIZARD_FORM_STATE,{name:i.tabIds.wizard.risks,dirty:e})})}}}])}(),function(){angular.module("changeModule").constant("tabIds",{main:{template:"template",scratch:"scratch"},wizard:{basics:"basics",ci:"ci",dates:"dates",risks:"risks",documents:"documents"}})}(),function(){angular.module("myitsmApp").controller("ChatHistoryController",["$scope","chatModel","userModel",function(e,t,a){function n(){t.getConversationsHistory().then(function(t){e.searchResults=t.arr,e.state.loadingUserHistory=!1})}function i(t){if(!_.isString(t)&&!_.isObject(t))return!1;var a=new RegExp(e.searchFor,"gi");if(_.isString(t))return a.test(t);for(var n in t)if(t.hasOwnProperty(n)&&n.indexOf("Name")>=0&&a.test(t[n])&&_.isString(t[n]))return!0;return!1}e.state={loadingUserHistory:!0,searchingConversations:!1,loadingConversation:!1},e.searchResults=[],e.selectedConv=null,e.currentUser=a.userFullData||a.userInfo,e.selectConversation=function(a){a.messages?e.selectedConv=a:(e.state.loadingConversation=!0,t.getArchivedConversationDetails(a).then(function(t){a.messages=t,e.selectedConv=a})["finally"](function(){e.state.loadingConversation=!1}))},e.chatModel=t,e.filterHistoryList=function(t){if(!e.searchFor||e.searchFor.length<2)return!0;var a=t.parent,n=t.roster,o=!!a&&!!i(a.displayId+"_"+(a.summary||"")+"_"+(a.desc||"")),r=!!n&&!!_.find(n,i);return o||r};var o=e.$watch("chatModel.connected",function(e){e&&(n(),o())})}])}(),ChatHistoryItemVO.prototype=new BaseVO,ChatHistoryItemVO.prototype.constructor=ChatHistoryItemVO,ChatHistoryItemVO.prototype.getProps=function(){return["id","mucJid","messagesCount","lastActivity","startDate","lastActivity","participants","connection"]},ChatHistoryItemVO.prototype.postBuild=function(){},ChatHistoryItemVO.prototype.listParticipants=function(){var e=[];return _.each(this.roster,function(t,a){t?e.push(t.fullName||t.displayName):e.push(a.split("_")[0])}),e.join(", ")},ChatHistoryItemVO.prototype.getStartDate=function(){return moment(this.startDate).calendar({sameElse:"lll"})},ChatHistoryItemVO.prototype.getEndDate=function(){return moment(this.lastActivity).calendar({sameElse:"lll"})},ChatHistoryItemVO.prototype.fillRoster=function(e){var t=this;if(_.each(this.participants,function(a){t.roster[a]=e[a],t.roster[a]&&t.roster[a].thumbnail&&(t.selectedUser=t.roster[a])}),!this.selectedUser){var a=this.participants[0];this.selectedUser=this.roster[a]}},ChatHistoryItemVO.prototype.generateRelatedItemTitle=function(){var e,t,a="";return this.parent&&(this.parent.ticketType&&this.parent.ticketType===EntityVO.TYPE_ASSET?(e=this.parent.name,t=EntityVO.TYPE_ASSET.toUpperCase()):(e=this.parent.summary,t=this.parent.displayId),a=_.compact([t,e]).join(": ")),a},function(){angular.module("myitsmApp").controller("ChatPopupWindowController",["$scope","chatModel",function(e,t){e.chatModel=t;var a=window.opener.popupDetails,n=e.$watch(function(){return t.connected&&t.Client},function(i){i&&(t.generateChatWindowByRoomId(a.roomId).then(function(t){e.chatWindow=t}),n())})}])}(),function(){angular.module("chartModule").controller("ChartController",["$scope","chartModel","userModel","$q","i18nService","$timeout","configurationModel","$filter","metadataModel","authService","roles","$window","searchModel",function(e,t,a,n,i,o,r,s,l,c,d,u,p){function m(){e.state={incidentDataIsLoading:!0,workorderDataIsLoading:!0,requestDataIsLoading:!0,changeDataIsLoading:!0,tooManyCompanies:!1},e.selections={companies:[]},e.incidentMultiBarChartData=[],e.workorderMultiBarChartData=[],e.servicerequestMultiBarChartData=[],e.incidentAreaLineChartData=[],e.workorderAreaLineChartData=[],e.requestAreaLineChartData=[],e.changePieChartData=[],e.changeBarChartData=[],e.supportGroups=[],e.myCompanySelected=!0,e.selectedCompanyItem={},e.myitsmLocale=window.myitsmLocale,e.perspectiveDropdown={data:[],selectedItem:{}},e.margin=function(){return{top:30,right:10,bottom:50,left:30}};var i=a.getFullCurrentUserData().then(function(){e.userData=a.userFullData});e.isITSMAgent=c.isAuthorized(d.ITSM_AGENT_ROLE),e.isSRMInstalled=r.isServerApplicationEnabled(EntityVO.TYPE_SERVICEREQUEST)&&c.isAuthorized(d.ITSM_AGENT_ROLE),e.isWOInstalled=r.isServerApplicationEnabled(EntityVO.TYPE_WORKORDER)&&c.isAuthorized(d.ITSM_AGENT_ROLE),e.isChangeInstalled=r.isServerApplicationEnabled(EntityVO.TYPE_CHANGE)&&c.isAuthorized(d.ITSM_CHANGE_USER_ROLE);var s=p.getOperatingCompanies(null,-1).then(function(t){e.selections.companies=_.cloneDeep(t.companies),e.state.tooManyCompanies=t.exceedsChunkSize});e.getCompaniesByName=function(e){return p.getCompaniesByText(e).then(function(e){return{list:e.companies,exceedsChunkSize:e.exceedsChunkSize}})},e.setCompany=function(t){e.selectedCompany={name:t.name},e.selectedCompanyItem=t,e.fetchDataByCompany(e.selectedCompany)};var u=a.getUserPreferences(y).then(function(e){e.length&&_.forEach(e,function(e){t[e.name]=e.value})}),m=l.getMetadataByTypes([EntityVO.TYPE_INCIDENT,EntityVO.TYPE_WORKORDER,EntityVO.TYPE_SERVICEREQUEST]);n.all([i,s,u,m]).then(function(){e.incidentRadioModel=t.incidentBacklogDateRange,e.workorderRadioModel=t.workorderBacklogDateRange,e.requestRadioModel=t.requestBacklogDateRange,e.selectedCompany=t.statsCompany?t.statsCompany:{name:e.userData.company.name},e.selectedCompany={name:e.selectedCompany.name},e.selectedCompanyItem=_.find(e.selections.companies,e.selectedCompany)||e.selectedCompany,f(e.selectedCompany),t.statsPerspective&&"myGroups"!==t.statsPerspective&&"allGroups"!==t.statsPerspective&&!_.filter(e.supportGroups,function(e){return e.name===t.statsPerspective}).length&&e.clearCache(),"myGroups"===t.statsPerspective||"allGroups"===t.statsPerspective?(o(function(){e.perspectiveDropdown.selectedItem=_.find(e.perspectiveDropdown.data,{name:t.statsPerspective})},500),"myGroups"===t.statsPerspective?e.filterGroups=e.supportGroups.map(function(e){return{name:e.name}}):e.filterGroups=[]):(e.perspectiveDropdown.selectedItem=_.find(e.perspectiveDropdown.data,{name:t.statsPerspective}),e.filterGroups=[{name:t.statsPerspective}]),e.fetchData()})}function f(t){e.supportGroups=[],e.perspectiveDropdown.data=[],e.myCompanySelected=!(t.name!==e.userData.company.name);var a={name:"myGroups","static":!0,id:"mygroups",label:s("i18n")("chart.perspective.myGroups")},n={name:"allGroups","static":!0,id:"allgroups",label:s("i18n")("chart.perspective.allGroups")};e.myCompanySelected?e.perspectiveDropdown.data.push(a,n):e.perspectiveDropdown.data.push(n),_.forEach(e.userData.supportGroups,function(a){a.company&&a.company.name===t.name&&(e.supportGroups.push({name:a.name}),e.perspectiveDropdown.data.push({name:a.name,label:a.name}))})}function g(e,t,a,n){var i=l.cache[e];return _.each(t,function(e){var t=_.find(i[a],{label:e.key});e.index=t&&t.index||0,_.each(e.values,function(e){var t=_.find(i[n],{label:e[0]});e.index=t&&t.index||0}),e.values=_.sortBy(e.values,"index")}),t=_.sortBy(t,"index")}var h,y="Dashboard";e.checkTooltipContent=function(e,t,a,n,o){return"<h3>"+e+"</h3><p>"+a+" "+i.getLocalizedString("chart.tooltip.preposition.on")+" "+t+"</p>"},e.refreshBacklogData=function(n,i){e[n+"RadioModel"]=i,t[n+"BacklogDateRange"]=i;var o=_.find(a.userConfig[y],{name:n+"BacklogDateRange"}),r=o?o.id:null;a.updateUserPreferences(y,{id:r,name:n+"BacklogDateRange",value:i}),e.state[n+"BacklogIsLoading"]=!0,t.fetchData(n,["area"],[e.selectedCompany],e.filterGroups,e[n+"RadioModel"]).then(function(){e[n+"AreaLineChartData"]=t[n+"StatsDataCache"][n+"AreaLineChartData"]})["finally"](function(){e.state[n+"BacklogIsLoading"]=!1})},e.colorFunction=function(){return function(e,t){var a=["#f83200","#EE8F43","#ECC35B","#89C341"];return a[t]}},e.xAreaLineChartFunction=function(){return function(e){return window.isRtl?s("date")(e," d MMM yyyy"):s("date")(e)}},e.yMultiBarChartFunction=function(){return function(e){return d3.round(e)}},e.xchangePieChartFunction=function(){return function(e){return e.label}},e.ychangePieChartFunction=function(){return function(e){return e.value}};var E=["#95DAED","#f83200","#95DAED","#95DAED","#95DAED","#95DAED"];e.changeBarColorFunction=function(){return function(e,t){return E[t]}};var v=["#f83200","#95DAED"];e.changePieColorFunction=function(){return function(e,t){
return v[t]}},e.clearCache=function(){t.clearCache(EntityVO.TYPE_INCIDENT),t.clearCache(EntityVO.TYPE_WORKORDER),t.clearCache(EntityVO.TYPE_SERVICEREQUEST)},e.fetchDataByCompany=function(n){var i={},o="",r="",s=!1;f(n),"allGroups"!==t.statsPerspective&&(e.perspectiveDropdown.selectedItem=_.find(e.perspectiveDropdown.data,{name:"allGroups"}),e.filterGroups=[],t.statsPerspective="allGroups",i=_.find(a.userConfig[y],{name:"statsPerspective"}),r=i?i.id:null,s=!0),i=_.find(a.userConfig[y],{name:"statsCompany"}),o=i?i.id:null,e.selectedCompany=t.statsCompany=angular.copy(n),a.updateUserPreferences(y,{id:o,name:"statsCompany",value:t.statsCompany})["finally"](function(){s&&a.updateUserPreferences(y,{id:r,name:"statsPerspective",value:t.statsPerspective})}),e.clearCache(),e.fetchData()},e.fetchDataByGroup=function(n){e.perspectiveDropdown.selectedItem=n,n&&n["static"]&&("myGroups"===n.name||"allGroups"===n.name)?(t.statsPerspective=n.name,"myGroups"===n.name?e.filterGroups=e.supportGroups.map(function(e){return{name:e.name}}):e.filterGroups=[]):(t.statsPerspective=n.name,e.filterGroups=[{name:n.name}]);var i=_.find(a.userConfig[y],{name:"statsPerspective"}),o=i?i.id:null;a.updateUserPreferences(y,{id:o,name:"statsPerspective",value:t.statsPerspective}),e.clearCache(),e.fetchData()},e.fetchData=function(){e.state.incidentDataIsLoading=!0;var a=t.getChartStatisticsData(EntityVO.TYPE_INCIDENT,["kpi","stack","area"],[e.selectedCompany],e.filterGroups,e.incidentRadioModel);if(a.then(function(){e.incidentKeyPerformanceData=t.incidentStatsDataCache.incidentKeyPerformanceData,e.incidentMultiBarChartData=g(EntityVO.TYPE_INCIDENT,t.incidentStatsDataCache.incidentMultiBarChartData,"urgencies","statuses"),e.incidentAreaLineChartData=t.incidentStatsDataCache.incidentAreaLineChartData})["finally"](function(){e.state.incidentDataIsLoading=!1}),e.isSRMInstalled){e.state.requestDataIsLoading=!0;var i=t.getChartStatisticsData(EntityVO.TYPE_SERVICEREQUEST,["kpi","stack","area"],[e.selectedCompany],e.filterGroups,e.requestRadioModel);i.then(function(){e.requestKeyPerformanceData=t.requestStatsDataCache.requestKeyPerformanceData,e.requestMultiBarChartData=g(EntityVO.TYPE_SERVICEREQUEST,t.requestStatsDataCache.requestMultiBarChartData,"urgencies","statuses"),e.requestAreaLineChartData=t.requestStatsDataCache.requestAreaLineChartData})["finally"](function(){e.state.requestDataIsLoading=!1})}if(e.isWOInstalled){e.state.workorderDataIsLoading=!0;var o=t.getChartStatisticsData(EntityVO.TYPE_WORKORDER,["kpi","stack","area"],[e.selectedCompany],e.filterGroups,e.workorderRadioModel);o.then(function(){e.workorderKeyPerformanceData=t.workorderStatsDataCache.workorderKeyPerformanceData,e.workorderMultiBarChartData=g(EntityVO.TYPE_WORKORDER,t.workorderStatsDataCache.workorderMultiBarChartData,"priorities","statuses"),e.workorderAreaLineChartData=t.workorderStatsDataCache.workorderAreaLineChartData})["finally"](function(){e.state.workorderDataIsLoading=!1})}if(e.isChangeInstalled){e.state.changeDataIsLoading=!0;var r=t.getChangeData([e.selectedCompany],e.filterGroups);r.then(function(){var a=[{key:"Change Stats",values:[]}],n=[],i=0,o=0;_.forEach(t.statsConfig,function(e){var t,r=[];r.push(s("i18n")("chart.change.label."+e.label)),r.push(e.value),a[0].values.push(r),"critical"===e.label&&(t={name:e.label,label:s("i18n")("chart.changeDonut.label."+e.label),value:e.value},i=e.value,n.push(t)),"all"===e.label&&(t={name:e.label,label:s("i18n")("chart.changeDonut.label."+e.label),value:e.value},o=e.value,n.push(t))}),e.changeBarChartData=a,_.forEach(n,function(e){"all"===e.name&&(e.value=parseInt(e.value)-i)}),e.changePieChartData=n,e.drawCustomPieChart(o)})["finally"](function(){e.state.changeDataIsLoading=!1})}n.all([a,i,o,r]).then(function(){setTimeout(function(){d3.selectAll("text").attr("tabindex",0)},500)},0),e.drawCustomPieChart=function(t){nv.addGraph(function(){function a(){var e=d3.select("#changeDashboardPieChart"),t=e&&e[0]&&e[0][0]&&e[0][0].clientWidth,a=160;"zh"!=window.myitsmLocale&&"ko"!=window.myitsmLocale&&"ja"!=window.myitsmLocale||(a=60);var n=t>440?100:a;d3.select("#changeDashboardPieChart .nv-pieChart").attr("transform","translate(-30, 30)"),d3.select("#changeDashboardPieChart .nv-pieChart .nv-legendWrap").attr("transform","de"==window.myitsmLocale?"translate(20, 80)":"translate(0, 80)");var i=d3.selectAll("#changeDashboardPieChart .nv-pieChart .nv-legendWrap .nv-series");i.each(function(e,t){var a=d3.select(this);a.attr("transform","translate("+n+", "+30*t+")"),a.select("text").attr("dx","12")});var o=d3.select("#changeDashboardPieChart .nv-pie .nv-pie"),s=o.selectAll(".donut-center-box"),l=s&&s[0]&&s[0].length;if(l)s.each(function(){var e=d3.select(this);e.select("text").text(r)});else{var c=o.append("g").attr("transform","translate(0,0)").attr("class","donut-center-box");c.append("text").attr("dy",".35em").attr("text-anchor","middle").attr("class","donut-center-text").text(r)}}function n(e){e.hasOwnProperty("disabled")||(e.disabled=!1),r=e.disabled?o:e.disabled||r!==e.value?o-e.value:o}function i(){if(s.legend.dispatch.on("legendClick",n),s.update){var e=s.update;s.update=function(){e(),i(),a()}}}var o=t,r=o,s=nv.models.pieChart().x(e.xchangePieChartFunction()).y(e.ychangePieChartFunction()).showLegend(!0).donut(!0).donutRatio(.42).showLabels(!1).tooltips(!1).color(e.changePieColorFunction());d3.select("#changeDashboardPieChart svg").datum(e.changePieChartData).transition().duration(500).call(s),i(),a(),h=s.update,angular.element(u).on("resize",h)})}},m(),e.$on("$destroy",function(){h&&angular.element(u).off("resize",h)})}])}(),function(){angular.module("chartModule").factory("chartModel",["chartService","configurationModel","$q","$filter",function(e,t,a,n){function i(e){for(var t={},a=0;a<e.length;a++)"First-Call Resolutions"===e[a].name?t.firstCallData={value:n("number")(e[a].value)+"%",status:o(e[a].value)}:"On-Time Completions"===e[a].name?t.onTimeData={value:n("number")(e[a].value)+"%",status:o(e[a].value)}:"Resolutions Accepted"===e[a].name||"Completion Accepted"===e[a].name?t.acceptedData={value:n("number")(e[a].value)+"%",status:o(e[a].value)}:"Scheduled Work Orders"===e[a].name&&(t.scheduledData={value:n("number")(e[a].value)+"%",status:o(e[a].value)});return t}function o(e){var t="";return e>=80?t="good":e>=60&&e<80?t="average":e<60&&(t="bad"),t}function r(e,t){for(var a=[],i=0;i<e.length;i++){var o={key:"",values:[]};o.key=n("localizeLabel")(e[i].name,t===EntityVO.TYPE_SERVICEREQUEST?EntityVO.TYPE_URGENCY:EntityVO.TYPE_PRIORITY,t);for(var r=0;r<e[i].value.length;r++){var s=[];s.push(n("localizeLabel")(e[i].value[r].name,EntityVO.TYPE_STATUS,t)||e[i].value[r].name),s.push(e[i].value[r].value),o.values.push(s)}a.push(o)}return a}function s(e,t,a){for(var i={key:n("i18n")("chart.area.backlog."+e),area:!0,color:t,values:[]},o=0;o<a.length;o++){var r=[];r.push(a[o].name),r.push(a[o].value),i.values.push(r)}return i}var l={incidentBacklogDateRange:"30",workorderBacklogDateRange:"30",requestBacklogDateRange:"30",statsCompany:"",statsPerspective:"myGroups",incidentStatsDataCache:{},workorderStatsDataCache:{},requestStatsDataCache:{},statsConfig:{}};return l.getChartStatisticsData=function(e,t,n,i,o){return _.isEmpty(l[e+"StatsDataCache"])?l[e+"StatsDataRetrieving"]?l[e+"StatsDataPromise"]:(l[e+"StatsDataRetrieving"]=!0,l[e+"StatsDataPromise"]=l.fetchData(e,t,n,i,o),l[e+"StatsDataPromise"]):a.when(l[e+"StatsDataCache"])},l.fetchData=function(t,a,n,o,c){return e.getChartStatisticsData(t,a,n,o,c).then(function(e){l[t+"StatsDataCache"][t+"AreaLineChartData"]=[];for(var a=0;a<e.objects.length;a++)e.objects[a].name===t+"-kpi"&&(l[t+"StatsDataCache"][t+"KeyPerformanceData"]=i(e.objects[a].statsMetrics)),e.objects[a].name===t+"-open"&&(l[t+"StatsDataCache"][t+"MultiBarChartData"]=r(e.objects[a].statsMetrics,t)),e.objects[a].name===t+"-backlog-all"&&l[t+"StatsDataCache"][t+"AreaLineChartData"].push(s("all","#66CCFF",e.objects[a].statsMetrics)),e.objects[a].name===t+"-backlog-critical"&&l[t+"StatsDataCache"][t+"AreaLineChartData"].push(s("critical","#FF4500",e.objects[a].statsMetrics))})["finally"](function(){l[t+"StatsDataRetrieving"]=!1})},l.getChangeData=function(e,a){l.statsConfig=t.get("change.dashboardStats");var n=_.map(l.statsConfig,function(e){return{name:e.name}});return l.fetchChangeData(e,a,n)},l.fetchChangeData=function(t,a,n){return e.getChangeData(t,a,n).then(function(e){_.forEach(l.statsConfig,function(t){var a=_.find(e,{name:t.name});t.value=a?a.value:0})})},l.clearCache=function(e){l[e+"StatsDataCache"]={}},l}])}(),function(){angular.module("chartModule").service("chartService",["$resource",function(e){var t=e("",{},{getChartStatisticsData:{url:"/smartit/rest/foundation/stats/get",method:"POST",isArray:!0},getChangeData:{url:"/smartit/rest/v2/foundation/mtcstats/get",method:"POST",isArray:!0}});this.getChartStatisticsData=function(e,a,n,i,o){var r={filterCriteria:{companies:n,assignedSupportGroups:i},stats:[]};return a.indexOf("kpi")!==-1&&r.stats.push({name:e+"-kpi",primaryGroupBy:"",secondaryGroupBy:""}),a.indexOf("stack")!==-1&&r.stats.push({name:e+"-open",primaryGroupBy:"priority",secondaryGroupBy:"ticketSpecificStatus",filterCriteria:{statusMappings:["open"]}}),a.indexOf("area")!==-1&&(r.stats.push({name:e+"-backlog-all",primaryGroupBy:"createDate",secondaryGroupBy:"",filterCriteria:{statusMappings:["open"],createDateRange:{start:1e3*moment().subtract(o,"days").unix(),end:(new Date).getTime()}}}),e===EntityVO.TYPE_INCIDENT&&r.stats.push({name:e+"-backlog-critical",primaryGroupBy:"createDate",secondaryGroupBy:"",filterCriteria:{statusMappings:["open"],priorities:["Critical"],createDateRange:{start:1e3*moment().subtract(o,"days").unix(),end:(new Date).getTime()}}})),t.getChartStatisticsData(r).$promise.then(function(e){return e[0].items[0]})},this.getChangeData=function(e,a,n){var i={companies:e,assignedSupportGroups:a,ticketTypes:["change"],isCustomDashboardStats:!0};return t.getChangeData({filterCriteria:i,stats:n}).$promise.then(function(e){return e[0].items[0].objects})}}])}(),function(){angular.module("changeModule").directive("collisionBanner",["collisionModel","$modal","emailModel","$filter","$state","configurationModel",function(e,t,a,n,i,o){return{restrict:"E",replace:!0,templateUrl:"views/collision/collision-banner.html",scope:{context:"=",collisions:"=",showCollisionDetection:"="},link:function(e){e.autoTriggerChangeCollisionForCIsUpto=o.autoTriggerChangeCollisionForCIsUpto,e.toggle=function(){e.visible=!e.visible},e.editMode=e.context.accessMappings.collisionEditAllowed,e.editDatesView=function(){i.go("changeEditCollisions",{id:e.context.id})},e.showEmailForm=function(){var t=[];return _.each(e.collisions.changeList,function(e){e.assignee.id&&(e.assignee.loginId=e.assignee.id,e.assignee.type=n("i18n")("change.detail.emailRecipients.allCollisionManagers"),t.push(e.assignee))}),t=_.uniqBy(t,"id"),a.createEmail([e.context],t)}}}}])}(),function(){angular.module("changeModule").factory("collisionModel",["collisionService","$q",function(e,t){function a(e){var t=[];return _.forEach(e,function(e){_.forEach(e.timings,function(a){var n=_.cloneDeep(e);n.scheduledStartDate=a.startDate,n.scheduledEndDate=a.endDate,n.title=n.additionalInformation.timeSegmentDesc||n.title,delete n.timings,t.push(n)})}),t}var n={};return n.getListOfCollisionsById=function(t,a){var n={id:t.id,includeCIDetails:a};return e.getListOfCollisionsById(n)},n.getListOfCollisionsAndCiByDate=function(t,a,n){var i={scheduledDateRange:{start:t.getTime(),end:a.getTime()},configurationItems:[]};return _.forEach(n,function(e){i.configurationItems.push({reconciliationId:e.id})}),e.getListOfCollisionsAndCiByDate(i)},n.changeCalendarCollisionGet=function(t,a,n,i){var o={scheduledDateRange:{start:t.getTime(),end:a.getTime()},changeId:n,mode:i};return e.getListOfCollisionsAndCiByDate(o)},n.changeCalendarGet=function(n,i,o,r,s){if(!i||!o)return t.when({changeRequests:[],outages:[]});var l,c={types:[EntityVO.TYPE_BUSINESS_EVENT,EntityVO.TYPE_CHANGE,EntityVO.TYPE_OUTAGE],scheduledDateRange:{start:i.getTime(),end:o.getTime()},changeId:n,mode:s};return l=_.extend(c,r),e.getListOfCollisionsByDate({filterCriteria:l}).then(function(e){var t=e[0]&&e[0].items&&e[0].items[0]&&e[0].items[0].objects,i={};return i.changeRequests=t?_.filter(t,{type:EntityVO.TYPE_CHANGE}):[],i.changeRequests=_.filter(i.changeRequests,function(e){return e.id!=n}),i.outages=t?_.filter(t,{type:EntityVO.TYPE_OUTAGE}):[],i.businessEvents=t?_.filter(t,{type:EntityVO.TYPE_BUSINESS_EVENT}):[],i.changeRequests=a(i.changeRequests),i.outages=a(i.outages),i.businessEvents=a(i.businessEvents),i})},n.getListOfCollisionsByDate=function(n,i,o,r,s){if(!i||!o)return t.when({changeRequests:[],outages:[]});var l={types:[EntityVO.TYPE_BUSINESS_EVENT],scheduledDateRange:{start:i.getTime(),end:o.getTime()},configurationItems:[]};r&&r.length&&(l.types.push(EntityVO.TYPE_CHANGE),l.types.push(EntityVO.TYPE_OUTAGE),_.forEach(r,function(e){l.configurationItems.push({reconciliationId:e.id})}));var c=_.extend(l,s);return e.getListOfCollisionsByDate({filterCriteria:c}).then(function(e){var t=e[0]&&e[0].items&&e[0].items[0]&&e[0].items[0].objects,i={};return i.changeRequests=t?_.filter(t,{type:EntityVO.TYPE_CHANGE}):[],i.changeRequests=_.filter(i.changeRequests,function(e){return e.id!=n}),i.outages=t?_.filter(t,{type:EntityVO.TYPE_OUTAGE}):[],i.businessEvents=t?_.filter(t,{type:EntityVO.TYPE_BUSINESS_EVENT}):[],i.changeRequests=a(i.changeRequests),i.outages=a(i.outages),i.businessEvents=a(i.businessEvents),i})},n.addCollisionStatuses=function(t,a){var n=t;return e.addCollisionStatuses(n,a)},n}])}(),function(){angular.module("changeModule").service("collisionService",["$resource","$q",function(e,t){function a(e,t){var a={count:e.items[0].totalMatches,changeList:[],totalUnaddressedCount:0};return a.changeList=e.items[0].objects,a.changeList.forEach(function(e){if(e.additionalInformation?0!==new Date(e.additionalInformation.scheduledStartDate).getDay()&&6!==new Date(e.additionalInformation.scheduledEndDate).getDay()||(e.fallsOnWeekend=!0):e.fallsOnWeekend=!1,t){e.ciCount=0;for(var n=0;n<e.configurationItems.length;n++)e.configurationItems[n].collisionStatus?(e.configurationItems[n].status={name:e.configurationItems[n].collisionStatus.value},e.configurationItems[n].rationale=e.configurationItems[n].collisionStatus.reason,"Resolved"!==e.configurationItems[n].collisionStatus.value&&"Ignored"!==e.configurationItems[n].collisionStatus.value&&(e.ciCount=e.ciCount+1)):e.ciCount+=1}else e.ciCount=e.hasActiveCollisions?1:0;a.totalUnaddressedCount+=e.ciCount}),a}var n=e("",{},{getCollision:{url:"/smartit/rest/change/collisions/get",method:"POST",isArray:!0},getListOfCollisionsAndCiByDate:{url:"/smartit/rest/change/collisions/get",method:"POST",isArray:!0},getListOfCalendarItems:{method:"POST",isArray:!0,url:"/smartit/rest/calendar/get"},addCollisionStatuses:{method:"PUT",isArray:!0,url:"/smartit/rest/change/:id/collisions"}});this.getListOfCollisionsById=function(e){var i;if(e.id)i={id:e.id,includeCIDetails:e.includeCIDetails};else{if(!e.parentId)return t.when({error:"Missing required parameter. Request cancelled"});i=e}return n.getCollision(i).$promise.then(function(t){return a(t[0],e.includeCIDetails)})},this.getListOfCollisionsAndCiByDate=function(e){return n.getListOfCollisionsAndCiByDate(e).$promise.then(function(e){return a(e[0],!0)})},this.getListOfCollisionsByDate=function(e){return n.getListOfCalendarItems(e).$promise},this.addCollisionStatuses=function(e,t){return n.addCollisionStatuses({id:t},e).$promise.then(function(e){return a(e[0],!0)})}}])}(),function(){var e,t;$.cookie.raw=!0,$.cookie("user_timezone")&&(e=$.cookie("user_timezone")),t="true"===localStorage.getItem("enableReleasePV");var a=[{name:"assetTypes",label:"ciType",options:[]},{name:"assetSubTypes",label:"assetSubType",options:[]},{name:"companies",label:"searchCompanies",options:[{label:"searchCompanies",type:"search",method:"searchModel.getListOfCompaniesByText",typeaheadTemplate:"views/console/general-typeahead-template.html",fields:{key:"name",value:"name"},valueFormat:"{name: value}"}]},{name:"keywords",label:"keywords",options:[{label:"searchKeywords",type:"search",subtype:"keyword"}]},{name:"manufacturer",label:"manufacturer",showLabelInPill:!0,options:[{label:"searchManufacturer",type:"search",method:"searchModel.getFoundationManufacturersByText",typeaheadTemplate:"views/search/search-typeahead-template.html",fields:{key:"name",value:"name"},valueFormat:"value"}]},{name:"model",label:"model",showLabelInPill:!0,options:[{label:"searchModel",type:"search",subtype:"keyword"}]},{name:"products",label:"product",showLabelInPill:!0,options:[{label:"searchProducts",type:"search",method:"parentScope.getProductCategoriesByCompany",typeaheadTemplate:"views/search/search-typeahead-template.html",fields:{key:"value",value:""},valueFormat:"{categorizations: categorizations}"}]},{name:"room",label:"room",showLabelInPill:!0,options:[{label:"searchRoom",type:"search",subtype:"keyword"}]},{name:"region",label:"region",showLabelInPill:!0,options:[{label:"myRegion",name:"myRegion",type:"constant",criteria:{name:"region"}},{label:"searchRegion",type:"search",method:"searchModel.getFoundationRegionsByText",typeaheadTemplate:"views/search/search-typeahead-template.html",fields:{key:"name",value:"name"},valueFormat:"{region: value, companyName: companyName}"}]},{name:"siteGroup",label:"siteGroup",showLabelInPill:!0,options:[{label:"mySiteGroup",name:"mySiteGroup",type:"constant",criteria:{name:"siteGroup"}},{label:"searchSiteGroup",type:"search",method:"searchModel.getFoundationSiteGroupsByText",typeaheadTemplate:"views/search/search-typeahead-template.html",fields:{key:"name",value:"name"},valueFormat:"{siteGroup: value, region: regionName, companyName: companyName}"}]},{name:"sites",label:"site",showLabelInPill:!0,options:[{label:"mySite",name:"mySite",type:"constant",criteria:{name:"sites"}},{label:"searchSite",type:"search",method:"searchModel.getFoundationSitesByText",typeaheadTemplate:"views/search/search-typeahead-template.html",fields:{key:"name",value:"name"},valueFormat:"{name: value, siteGroup: siteGroupName, region: regionName, companyName: companyName}"}]}],n=_.cloneDeep(a);n.unshift({name:"relationshipType",label:"relationshipType",options:[]}),angular.module("myitsmApp").constant("appConfiguration",{pwaEnabledTickets:{tickets:t?["workorder","incident","problem","task","knownerror","person","asset","change","release","activity"]:["workorder","incident","problem","task","knownerror","person","asset","change"]},pwaResultListFormAndView:"/CFG:SV_StandardConsole/SV_View",search:{filter:[{name:"searchCompanies",label:"searchCompanies",options:[{label:"searchCompanies",type:"search",method:"searchModel.getListOfCompaniesByText",fields:{key:"name",value:"name"},valueFormat:"{name: value}"}]},{name:"createDateRange",label:"createDate",options:[{name:"createDatePast24",label:"past24",type:"date",criteria:{name:"createDateRange",defaultValues:{startDate:'moment().subtract(1, "days").valueOf()',endDate:"moment().valueOf()"},value:{}}},{name:"createDatePast48",label:"past48",type:"date",criteria:{name:"createDateRange",defaultValues:{startDate:'moment().subtract(2, "days").valueOf()',endDate:"moment().valueOf()"},value:{}}},{name:"createDatePastWeek",label:"pastWeek",type:"date",criteria:{name:"createDateRange",defaultValues:{startDate:'moment().subtract(7, "days").valueOf()',endDate:"moment().valueOf()"},value:{}}},{name:"createDateCustomRange",label:"customRange",type:"timeStampRange",format:"mediumDate",startDatePicker:{date:new Date},endDatePicker:{date:new Date},criteria:{name:"createDateRange"}}]},{name:"modifiedDateRange",label:"lastModifiedDate",options:[{name:"modifiedDatePast24",label:"past24",type:"date",criteria:{name:"modifiedDateRange",defaultValues:{startDate:'moment().subtract(1, "days").valueOf()',endDate:"moment().valueOf()"},value:{}}},{name:"modifiedDatePast48",label:"past48",type:"date",criteria:{name:"modifiedDateRange",defaultValues:{startDate:'moment().subtract(2, "days").valueOf()',endDate:"moment().valueOf()"},value:{}}},{name:"modifiedDatePastWeek",label:"pastWeek",type:"date",criteria:{name:"modifiedDateRange",defaultValues:{startDate:'moment().subtract(7, "days").valueOf()',endDate:"moment().valueOf()"},value:{}}},{name:"modifiedDateCustomRange",label:"customRange",type:"timeStampRange",format:"mediumDate",startDatePicker:{date:new Date},endDatePicker:{date:new Date},criteria:{name:"modifiedDateRange"}}]},{name:"types",label:"types",options:[{name:"asset",label:"asset",type:"constant",category:"asset",targetAreas:["all"],criteria:{name:"types",value:["asset"]}},{name:"change",label:"change",type:"constant",category:"tickets",targetAreas:["ticketKnowledge","tickets","all"],criteria:{name:"types",value:["change"]}},{name:"release",label:"release",type:"constant",category:"tickets",targetAreas:["ticketKnowledge","tickets","all"],criteria:{name:"types",value:["release"]}},{name:"activity",label:"activity",type:"constant",category:"tickets",targetAreas:["ticketKnowledge","tickets","all"],criteria:{name:"types",value:["activity"]}},{name:"incident",label:"incident",type:"constant",category:"tickets",targetAreas:["ticketKnowledge","tickets","all"],criteria:{name:"types",value:["incident"]}},{name:"knowledge",label:"knowledge",type:"constant",category:"knowledge",targetAreas:["ticketKnowledge","all"],criteria:{name:"types",value:["knowledge"]}},{name:"knownerror",label:"knownerror",type:"constant",category:"knownerror",targetAreas:["ticketKnowledge","tickets","all"],criteria:{name:"types",value:["knownerror"]}},{name:"person",label:"person",type:"constant",category:"person",targetAreas:["all"],criteria:{name:"types",value:["person"]}},{name:"problem",label:"problem",type:"constant",category:"problem",targetAreas:["ticketKnowledge","tickets","all"],criteria:{name:"types",value:["problem"]}},{name:"request",label:"request",type:"constant",category:"tickets",targetAreas:["ticketKnowledge","tickets","all"],criteria:{name:"types",value:["request"]}},{name:"sberequest",label:"sberequest",type:"constant",category:"tickets",targetAreas:["ticketKnowledge","tickets","all"],criteria:{name:"types",value:["sberequest"]}},{name:"task",label:"task",type:"constant",category:"tickets",targetAreas:["ticketKnowledge","tickets","all"],criteria:{name:"types",value:["task"]}},{name:"workorder",label:"workOrder",type:"constant",category:"tickets",targetAreas:["ticketKnowledge","tickets","all"],criteria:{name:"types",value:["workorder"]}}]}],categories:{tickets:{name:"tickets",totalCount:0,types:["incident","workorder","task","request","change","release","knownerror","problem","activity"]},knowledge:{name:"knowledge",types:["knowledge"]},person:{name:"person",totalCount:0,types:["person"]},asset:{name:"asset",totalCount:0,types:["asset"]}},targetAreas:[{name:"tickets",label:"TargetAreas.tickets",types:["tickets"],selected:!1},{name:"knowledge",label:"TargetAreas.knowledge",types:["knowledge"],selected:!1},{name:"people",label:"TargetAreas.people",types:["person"],selected:!1},{name:"ticketKnowledge",label:"TargetAreas.ticketKnowledge",types:["tickets","knowledge"],selected:!0},{name:"asset",label:"TargetAreas.asset",types:["asset"],selected:!1},{name:"all",label:"TargetAreas.all",types:["all"],selected:!1}]},ticketConsole:{columns:{assignee:{displayName:"assignee",attributeName:"assigneeFullName",field:"assignee.fullName",visible:!0,order:6,name:"assignee"},assigneeGroup:{displayName:"assigneeGroup",attributeName:"supportGroup",field:"supportGroup.name",visible:!1,name:"assigneeGroup"},company:{displayName:"company",attributeName:"company",field:"company.name",visible:!1,name:"company"},customerCompany:{displayName:"customerCompany",attributeName:"customerCompany",field:"customer.company.name",visible:!1,name:"customerCompany"},customerName:{displayName:"customerName",attributeName:"customerFullName",field:"customer.fullName",visible:!0,order:5,name:"customerName"},customerEmail:{displayName:"customerEmail",attributeName:"customerEmail",field:"customer.email",visible:!1,name:"customerEmail"},customerSite:{displayName:"customerSite",attributeName:"customerSite",field:"customer.site.name",visible:!1,name:"customerSite"},customerOrganization:{displayName:"customerOrganization",attributeName:"customerOrganization",field:"customer.organization",visible:!1,name:"customerOrganization"},escalated:{displayName:"escalated",attributeName:"isEscalated",field:"isEscalated",visible:!1,name:"escalated",cellFilter:"tcCellEscalated"},id:{displayName:"id",attributeName:"displayId",field:"displayId",visible:!0,order:2,pinned:!0,name:"id",cellFilter:"tcCellHighlight:row.entity.highlight"},impact:{displayName:"impact",attributeName:"impact",field:"impact",visible:!1,name:"impact",cellFilter:'localizeLabel: "impact":row.entity.type'},lastModifiedDate:{displayName:"lastModifiedDate",attributeName:"modifiedDate",field:"modifiedDate",visible:!0,order:9,name:"lastModifiedDate",cellFilter:'date:"medium"'},parentRequestId:{displayName:"parentRequestId",attributeName:"parentDisplayId",field:"parentId",visible:!1,name:"parentRequestId"},priority:{displayName:"priority",attributeName:"priority",field:"priority",visible:!0,order:1,name:"priority",cellTemplate:'<div class="ngCenteredCellText" ng-class="col.colIndex()" ng-bind-html="COL_FIELD | tcCellPriority:row.entity.type"></div>',width:100},productName:{displayName:"productName",attributeName:"productName",field:"productName",visible:!1,name:"productName"},ticketType:{displayName:"ticketType",attributeName:"type",field:"type",visible:!1,name:"ticketType",cellFilter:"tcCellType"},scheduledStartDate:{displayName:"scheduledStartDate",attributeName:"scheduledStartDate",field:"scheduledStartDate",visible:!1,name:"scheduledStartDate",cellFilter:'date:"medium"'},service:{displayName:"service",attributeName:"impactedServiceName",field:"impactedService.name",visible:!1,name:"service"},slaStatus:{displayName:"slaStatus",attributeName:"slaStatus",field:"slaStatus",visible:!0,order:4,name:"slaStatus",cellFilter:"tcCellSlaStatus"},status:{displayName:"status",attributeName:"status",field:"status.value",visible:!0,order:8,name:"status",cellFilter:'localizeLabel: "status":row.entity.type'},statusReason:{displayName:"statusReason",attributeName:"statusReason",field:"status.reason",visible:!1,name:"statusReason"},submitDate:{displayName:"submitDate",attributeName:"submitDate",field:"submitDate",visible:!1,name:"submitDate",cellFilter:'date:"medium"'},summary:{displayName:"summary",attributeName:"summary",field:"summary",visible:!0,order:7,width:350,name:"summary",cellFilter:"tcCellHighlight:row.entity.highlight"},targetDate:{displayName:"targetDate",attributeName:"targetDate",field:"targetDate",visible:!0,order:3,name:"targetDate",cellTemplate:'<div class="ngCellText" ng-class="col.colIndex()"><span ng-cell-text class="{{(row.getProperty(col.field) | haveDatePassed)  ? \'ngCellDatePassed\' : \'\'}}">{{row.getProperty(col.field) | tcCellSLA}}</span></div>'},urgency:{displayName:"urgency",attributeName:"urgency",field:"urgency",visible:!1,name:"urgency",cellFilter:'localizeLabel: "urgency":row.entity.type'},assigneeCompany:{displayName:"assigneeCompany",attributeName:"assigneeCompany",field:"assignee.company.name",visible:!1,name:"assigneeCompany"},customerDepartment:{displayName:"customerDepartment",attributeName:"customerDepartment",field:"customer.department",visible:!1,name:"customerDepartment"},customerLastName:{displayName:"customerLastName",attributeName:"customerLastName",field:"customer.lastName",visible:!1,name:"customerLastName"},scheduledEndDate:{displayName:"scheduledEndDate",attributeName:"scheduledEndDate",field:"scheduledEndDate",visible:!1,name:"scheduledEndDate",cellFilter:'date:"medium"'},actualEndDate:{displayName:"actualEndDate",attributeName:"actualEndDate",field:"actualEndDate",visible:!1,name:"actualEndDate",cellFilter:'date:"medium"'},actualStartDate:{displayName:"actualStartDate",attributeName:"actualStartDate",field:"actualStartDate",visible:!1,name:"actualStartDate",cellFilter:'date:"medium"'},completedDate:{displayName:"completedDate",attributeName:"completedDate",field:"completedDate",visible:!1,name:"completedDate",cellFilter:'date:"medium"'},opCat1:{displayName:"opCat1",attributeName:"operationCategoryTier1",field:"categories.operationCategoryTier1",visible:!1,name:"opCat1"},opCat2:{displayName:"opCat2",attributeName:"operationCategoryTier2",field:"categories.operationCategoryTier2",visible:!1,name:"opCat2"},opCat3:{displayName:"opCat3",attributeName:"operationCategoryTier3",field:"categories.operationCategoryTier3",visible:!1,name:"opCat3"},productCat1:{displayName:"productCat1",attributeName:"productCategoryTier1",field:"categories.productCategoryTier1",visible:!1,name:"productCat1"},productCat2:{displayName:"productCat2",attributeName:"productCategoryTier2",field:"categories.productCategoryTier2",visible:!1,name:"productCat2"},productCat3:{displayName:"productCat3",attributeName:"productCategoryTier3",field:"categories.productCategoryTier3",visible:!1,name:"productCat3"},submittedBy:{displayName:"submittedBy",attributeName:"submittedBy",field:"submittedBy",visible:!1,name:"submittedBy"},vendorGroup:{displayName:"vendorGroup",attributeName:"vendorGroupName",field:"vendorGroup.name",visible:!1,name:"vendorGroup"},vendorTicketNumber:{displayName:"vendorTicketNumber",attributeName:"vendorTicketNumber",field:"vendorTicketNumber",visible:!1,name:"vendorTicketNumber"},contact:{displayName:"contact",attributeName:"contact",field:"contact.fullName",visible:!1,name:"contact"},resolvedDate:{displayName:"resolvedDate",attributeName:"resolvedDate",field:"resolvedDate",visible:!1,ticketType:["incident"],name:"resolvedDate",cellFilter:'date:"medium"'},requiredResolutionDate:{displayName:"requiredResolutionDate",attributeName:"requiredResolutionDate",field:"requiredResolutionDate",visible:!1,ticketType:["incident"],name:"requiredResolutionDate",cellFilter:'date:"medium"'},respondedDate:{displayName:"respondedDate",attributeName:"respondedDate",field:"respondedDate",visible:!1,ticketType:["incident"],name:"respondedDate",cellFilter:'date:"medium"'},incidentType:{displayName:"incidentType",attributeName:"incidentType",field:"incidentType",visible:!1,ticketType:["incident"],name:"incidentType",cellFilter:'localizeLabel: "serviceType":row.entity.type'},owner:{displayName:"owner",attributeName:"ownerName",field:"owner.fullName",visible:!1,ticketType:["incident"],name:"owner"},ownerCompany:{displayName:"ownerCompany",attributeName:"ownerCompany",field:"owner.company.name",visible:!1,ticketType:["incident"],name:"ownerCompany"},ownerGroup:{displayName:"ownerGroup",attributeName:"ownerGroup",field:"ownerGroup.name",visible:!1,ticketType:["incident"],name:"ownerGroup"},reportedSource:{displayName:"reportedSource",attributeName:"reportedSource",field:"reportedSource",visible:!1,ticketType:["incident"],name:"reportedSource",cellFilter:'localizeLabel: "reportedSource":row.entity.type'},taskType:{displayName:"taskType",attributeName:"taskType",field:"taskType",visible:!1,ticketType:["task"],name:"taskType"},requestManager:{displayName:"requestManager",attributeName:"requestManager",field:"requestManager.fullName",visible:!1,ticketType:["workorder"],name:"requestManager"},requestManagerCompany:{displayName:"requestManagerCompany",attributeName:"requestManagerCompany",field:"requestManager.company.name",visible:!1,ticketType:["workorder"],name:"requestManagerCompany"},requestManagerGroup:{displayName:"requestManagerGroup",attributeName:"requestManagerGroup",field:"requestManagerGroup.name ",visible:!1,ticketType:["workorder"],name:"requestManagerGroup"},workorderType:{displayName:"workorderType",attributeName:"workOrderType",field:"workOrderType",visible:!1,ticketType:["workorder"],name:"workorderType"},changeClass:{displayName:"changeClass",
attributeName:"changeClass",field:"changeClass",visible:!1,ticketType:["change"],name:"changeClass",cellFilter:'localizeLabel: "timing":row.entity.type'},changeManager:{displayName:"changeManager",attributeName:"changeManager",field:"changeManager.fullName",visible:!1,ticketType:["change"],name:"changeManager"},changeManagerCompany:{displayName:"changeManagerCompany",attributeName:"changeManagerCompany",field:"changeManager.company.name",visible:!1,ticketType:["change"],name:"changeManagerCompany"},changeManagerGroup:{displayName:"changeManagerGroup",attributeName:"changeManagerGroup",field:"changeManagerGroup.name",visible:!1,ticketType:["change"],name:"changeManagerGroup"},changeReason:{displayName:"changeReason",attributeName:"changeReason",field:"changeReason",visible:!1,ticketType:["change"],name:"changeReason",cellFilter:'localizeLabel: "changeReason":row.entity.type'},riskLevel:{displayName:"riskLevel",attributeName:"riskLevel",field:"riskLevel",visible:!1,ticketType:["change"],name:"riskLevel",cellFilter:'localizeLabel: "riskLevel":row.entity.type'},problemCoordinator:{displayName:"problemCoordinator",attributeName:"problemCoordinator",field:"problemCoordinator.fullName",visible:!1,ticketType:["problem","knownerror"],name:"problemCoordinator"},problemCoordinatorGroup:{displayName:"problemCoordinatorGroup",attributeName:"problemCoordinatorGroup",field:"problemCoordinatorGroup.name",visible:!1,ticketType:["problem","knownerror"],name:"problemCoordinatorGroup"},investigationDriver:{displayName:"investigationDriver",attributeName:"investigationDriver",field:"investigationDriver",visible:!1,ticketType:["problem"],name:"investigationDriver",cellFilter:'localizeLabel: "investigationDriver":row.entity.type'},businessJustification:{displayName:"businessJustification",attributeName:"businessJustification",field:"businessJustification",visible:!1,ticketType:["release"],name:"businessJustification",cellFilter:'localizeLabel: "businessJustification":row.entity.type'},releaseCoordinator:{displayName:"releaseCoordinator",attributeName:"releaseCoordinator",field:"releaseCoordinator.fullName",visible:!0,ticketType:["release"],name:"releaseCoordinator"},releaseCoordinatorGroup:{displayName:"releaseCoordinatorGroup",attributeName:"releaseCoordinatorGroup",field:"releaseCoordinatorGroup.name",visible:!0,ticketType:["release"],name:"releaseCoordinatorGroup"},deploymentStartDate:{displayName:"deploymentStartDate",attributeName:"deploymentStartDate",field:"deploymentStartDate",visible:!1,ticketType:["release"],name:"deploymentStartDate",cellFilter:'date:"medium"'},deploymentEndDate:{displayName:"deploymentEndDate",attributeName:"deploymentEndDate",field:"deploymentEndDate",visible:!1,ticketType:["release"],name:"deploymentEndDate",cellFilter:'date:"medium"'},milestone:{displayName:"milestone",attributeName:"milestone",field:"milestone",visible:!1,ticketType:["release"],name:"milestone",cellFilter:'localizeLabel: "milestone":row.entity.type'},releaseType:{displayName:"releaseType",attributeName:"releaseType",field:"releaseType",visible:!1,ticketType:["release"],name:"releaseType",cellFilter:'localizeLabel: "type":row.entity.type'},requestedAvailabilityDate:{displayName:"requestedAvailabilityDate",attributeName:"requestedAvailabilityDate",field:"requestedAvailabilityDate",visible:!1,ticketType:["release"],name:"requestedAvailabilityDate"}},filter:[{name:"ticketTypes",label:"ticketType",expanded:!0,options:[{name:"incident",label:"incident",type:"constant",criteria:{name:"ticketTypes",value:["incident"]}},{name:"request",label:"request",type:"constant",criteria:{name:"ticketTypes",value:["request"]}},{name:"task",label:"task",type:"constant",criteria:{name:"ticketTypes",value:["task"]}},{name:"workorder",label:"workOrder",type:"constant",criteria:{name:"ticketTypes",value:["workorder"]}},{name:"change",label:"change",type:"constant",criteria:{name:"ticketTypes",value:["change"]}},{name:"knownerror",label:"knownerror",type:"constant",criteria:{name:"ticketTypes",value:["knownerror"]}},{name:"problem",label:"problem",type:"constant",criteria:{name:"ticketTypes",value:["problem"]}},{name:"release",label:"release",type:"constant",criteria:{name:"ticketTypes",value:["release"]}}]},{name:"affectedBusinessServices",label:"affectedBusinessService",ticketType:["change","incident","workorder","release","knownerror","problem"],options:[{label:"searchBusinessService",type:"search",method:"searchModel.getAffectedBusinessService",typeaheadTemplate:"views/console/affected-service-typeahead-template.html",fields:{key:"name",value:"reconciliationId"},valueFormat:"{reconciliationId: value}"}]},{name:"approvalStatuses",label:"approvalStatus",ticketType:["change"],options:[{name:"changesWaitingForApproval",label:"changesWaitingForApproval",type:"constant",criteria:{name:"approvalStatuses",value:["inApproval"]}}]},{name:"approvedBy",label:"approvedBy",showLabelInPill:!0,ticketType:["change"],options:[{name:"me",label:"me",type:"constant",criteria:{name:"approvedBy"}},{label:"searchApprover",type:"search",method:"personModel.getListOfPersonsByText",typeaheadTemplate:"views/console/search-person-typeahead-template.html",fields:{key:"fullName",value:"loginId"},valueFormat:"{loginId: value}"}]},{name:"approvalAssignment",label:"toBeApproved",ticketType:["change"],showLabelInPill:!0,options:[{name:"me",label:"me",type:"constant",criteria:{name:"approvalAssignment"}},{label:"searchApprover",type:"search",method:"personModel.getListOfPersonsByText",typeaheadTemplate:"views/console/search-person-typeahead-template.html",fields:{key:"fullName",value:"loginId"},valueFormat:"{loginId: value}"},{name:"myGroup",label:"myGroup",type:"constant",filterName:"approvalAssignment",criteria:{name:"approvalAssignmentGroup"}}]},{name:"assignedSupportGroups",label:"assigneeGroup",showLabelInPill:!0,options:[{name:"myGroup",label:"myGroup",type:"constant",criteria:{name:"assignedSupportGroups"}},{label:"searchAssigneeGroup",type:"search",method:"searchModel.getListOfSupportGroupsByText",typeaheadTemplate:"views/console/support-group-typeahead-template.html",fields:{key:"name",value:"name"},valueFormat:"{name: value}"}]},{name:"assignees",label:"assignee",showLabelInPill:!0,options:[{name:"me",label:"me",type:"constant",criteria:{name:"assignees"}},{name:"unassigned",label:"unassigned",type:"constant",criteria:{name:"assignees",value:[{loginId:""}]}},{label:"searchAssignee",type:"search",method:"personModel.getListOfPersonsByText",typeaheadTemplate:"views/console/search-person-typeahead-template.html",fields:{key:"fullName",value:"loginId"},valueFormat:"{loginId: value}"}]},{name:"changeClass",label:"changeClass",ticketType:["change"],options:[]},{name:"majorIncident",label:"majorIncident",ticketType:["incident"],options:[]},{name:"changeManager",label:"changeManager",showLabelInPill:!0,ticketType:["change"],options:[{name:"changeManagerMe",label:"me",type:"constant",criteria:{name:"changeManager"}},{name:"changeManagerUnassigned",label:"unassigned",type:"constant",criteria:{name:"changeManager",value:[{loginId:""}]}},{label:"searchAssignee",type:"search",method:"personModel.getListOfChangeManagerByText",typeaheadTemplate:"views/console/search-person-typeahead-template.html",fields:{key:"fullName",value:"loginId"},valueFormat:"{loginId: value}"}]},{name:"changeManagerGroup",label:"changeManagerGroup",showLabelInPill:!0,ticketType:["change"],options:[{name:"myGroup",label:"myGroup",type:"constant",criteria:{name:"changeManagerGroup"}},{label:"searchAssigneeGroup",type:"search",method:"searchModel.getChangeManagerGroupsByText",typeaheadTemplate:"views/console/support-group-typeahead-template.html",fields:{key:"name",value:"name"},valueFormat:"{name: value}"}]},{name:"requestManagers",label:"requestManager",showLabelInPill:!0,ticketType:["workorder"],options:[{name:"requestManagerMe",label:"me",type:"constant",criteria:{name:"requestManagers"}},{name:"requestManagerUnassigned",label:"unassigned",type:"constant",criteria:{name:"requestManagers",value:[{loginId:""}]}},{label:"searchAssignee",type:"search",method:"personModel.getListOfRequestManagerByText",typeaheadTemplate:"views/console/search-person-typeahead-template.html",fields:{key:"fullName",value:"loginId"},valueFormat:"{loginId: value}"}]},{name:"requestManagerGroups",label:"requestManagerGroup",showLabelInPill:!0,ticketType:["workorder"],options:[{name:"myGroup",label:"myGroup",type:"constant",criteria:{name:"requestManagerGroups"}},{label:"searchAssigneeGroup",type:"search",method:"searchModel.getRequestManagerGroupsByText",typeaheadTemplate:"views/console/support-group-typeahead-template.html",fields:{key:"name",value:"name"},valueFormat:"{name: value}"}]},{name:"changeReason",label:"changeReason",ticketType:["change"],options:[]},{name:"companies",label:"company",options:[{label:"searchCompany",type:"search",method:"searchModel.getListOfCompaniesByText",typeaheadTemplate:"views/console/general-typeahead-template.html",fields:{key:"name",value:"name"},valueFormat:"{name: value}"}]},{name:"createDateRanges",label:"createDate",showLabelInPill:!0,options:[{name:"createDatePast24",label:"past24",type:"date",defaultValues:{start:'moment().subtract(1, "days").valueOf()',end:"moment().valueOf()"},criteria:{name:"createDateRanges"}},{name:"createDatePast48",label:"past48",type:"date",defaultValues:{start:'moment().subtract(2, "days").valueOf()',end:"moment().valueOf()"},criteria:{name:"createDateRanges"}},{name:"createDatePastWeek",label:"pastWeek",type:"date",defaultValues:{start:'moment().subtract(7, "days").valueOf()',end:"moment().valueOf()"},criteria:{name:"createDateRanges"}},{name:"createDateCustomRange",label:"customRange",type:"timeStampRange",format:"mediumDate",startDatePicker:{date:new Date},endDatePicker:{date:new Date},criteria:{name:"createDateRanges"}}]},{name:"deploymentStartDate",label:"deploymentStartDate",showLabelInPill:!0,ticketType:["release"],options:[{name:"deploymentStartDateNext24",label:"next24",type:"date",order:1,defaultValues:{start:"moment().valueOf()",end:'moment().add(1, "days").valueOf()'},criteria:{name:"deploymentStartDate"}},{name:"deploymentStartDateNextWeek",label:"nextWeek",type:"date",order:2,defaultValues:{start:"moment().valueOf()",end:'moment().add(7, "days").valueOf()'},criteria:{name:"deploymentStartDate"}},{name:"deploymentStartDateNextMonth",label:"nextMonth",type:"date",order:3,defaultValues:{start:"moment().valueOf()",end:'moment().add(30, "days").valueOf()'},criteria:{name:"deploymentStartDate"}},{name:"deploymentStartDateCustomRange",label:"customRange",type:"timeStampRange",format:"mediumDate",startDatePicker:{date:new Date},endDatePicker:{date:new Date},criteria:{name:"deploymentStartDate"}}]},{name:"deploymentEndDate",label:"deploymentEndDate",showLabelInPill:!0,ticketType:["release"],options:[{name:"deploymentEndDateNext24",label:"next24",type:"date",order:1,defaultValues:{start:"moment().valueOf()",end:'moment().add(1, "days").valueOf()'},criteria:{name:"deploymentEndDate"}},{name:"deploymentEndDateNextWeek",label:"nextWeek",type:"date",order:2,defaultValues:{start:"moment().valueOf()",end:'moment().add(7, "days").valueOf()'},criteria:{name:"deploymentEndDate"}},{name:"deploymentEndDateNextMonth",label:"nextMonth",type:"date",order:3,defaultValues:{start:"moment().valueOf()",end:'moment().add(30, "days").valueOf()'},criteria:{name:"deploymentEndDate"}},{name:"deploymentEndDateCustomRange",label:"customRange",type:"timeStampRange",format:"mediumDate",startDatePicker:{date:new Date},endDatePicker:{date:new Date},criteria:{name:"deploymentEndDate"}}]},{name:"investigationDrivers",label:"investigationDriver",showLabelInPill:!0,ticketType:["problem"],options:[]},{name:"incidentTypes",label:"incidentTypes",ticketType:["incident"],options:[]},{name:"keywords",label:"keywords",options:[{label:"searchKeywords",type:"search",subtype:"keyword"}]},{name:"modifiedDateRanges",label:"lastModifiedDate",showLabelInPill:!0,options:[{name:"modifiedDatePast24",label:"past24",type:"date",defaultValues:{start:'moment().subtract(1, "days").valueOf()',end:"moment().valueOf()"},criteria:{name:"modifiedDateRanges"}},{name:"modifiedDatePast48",label:"past48",type:"date",defaultValues:{start:'moment().subtract(2, "days").valueOf()',end:"moment().valueOf()"},criteria:{name:"modifiedDateRanges"}},{name:"modifiedDatePastWeek",label:"pastWeek",type:"date",defaultValues:{start:'moment().subtract(7, "days").valueOf()',end:"moment().valueOf()"},criteria:{name:"modifiedDateRanges"}},{name:"modifiedDateCustomRange",label:"customRange",type:"timeStampRange",format:"mediumDate",startDatePicker:{date:new Date},endDatePicker:{date:new Date},criteria:{name:"modifiedDateRanges"}}]},{name:"milestone",label:"milestones",ticketType:["release"],options:[]},{name:"needsAttention",label:"needsAttention",ticketType:["incident","workorder"],options:[{name:"flagged",label:"flagged",type:"constant",filterName:"needsAttention",criteria:{name:"needsAttention",value:"Yes"}}]},{name:"organizations",label:"organization",ticketType:["incident","request","task","workorder","change","knownerror","problem"],options:[{name:"myOrganization",label:"myOrganization",type:"constant",criteria:{name:"organizations"}},{label:"searchOrganization",type:"search",method:"searchModel.getOrganizationsByText",typeaheadTemplate:"views/console/general-typeahead-template.html",fields:{key:"name",value:"name"},valueFormat:"value"}]},{name:"priorities",label:"priority",options:[{name:"critical",label:"critical",type:"constant",order:10,criteria:{name:"priorities",value:["Critical"]}},{name:"high",label:"high",type:"constant",order:20,criteria:{name:"priorities",value:["High"]}},{name:"medium",label:"medium",type:"constant",order:30,criteria:{name:"priorities",value:["Medium"]}},{name:"low",label:"low",type:"constant",order:40,criteria:{name:"priorities",value:["Low"]}}]},{name:"problemCoordinators",label:"problemCoordinator",showLabelInPill:!0,ticketType:["problem","knownerror"],options:[{name:"me",label:"me",type:"constant",criteria:{name:"problemCoordinators"}},{name:"unassigned",label:"unassigned",type:"constant",criteria:{name:"problemCoordinators",value:[{loginId:""}]}},{label:"searchAssignee",type:"search",method:"personModel.getListOfProblemCoordinatorByText",typeaheadTemplate:"views/console/search-person-typeahead-template.html",fields:{key:"fullName",value:"loginId"},valueFormat:"{loginId: value}"}]},{name:"problemCoordinatorGroups",label:"problemCoordinatorGroup",showLabelInPill:!0,ticketType:["problem","knownerror"],options:[{name:"myGroup",label:"myGroup",type:"constant",criteria:{name:"problemCoordinatorGroups"}},{label:"searchAssigneeGroup",type:"search",method:"searchModel.getProblemCoordinatorGroupsByText",typeaheadTemplate:"views/console/support-group-typeahead-template.html",fields:{key:"name",value:"id"},valueFormat:"{id: value}"}]},{name:"releaseCoordinator",label:"releaseCoordinator",showLabelInPill:!0,ticketType:["release"],options:[{name:"me",label:"me",type:"constant",criteria:{name:"releaseCoordinator"}},{name:"unassigned",label:"unassigned",type:"constant",criteria:{name:"releaseCoordinator",value:[{loginId:""}]}},{label:"searchAssignee",type:"search",method:"personModel.getListOfReleaseCoordinatorByText",typeaheadTemplate:"views/console/search-person-typeahead-template.html",fields:{key:"fullName",value:"loginId"},valueFormat:"{loginId: value}"}]},{name:"releaseCoordinatorGroup",label:"releaseCoordinatorGroup",showLabelInPill:!0,ticketType:["release"],options:[{name:"myGroup",label:"myGroup",type:"constant",criteria:{name:"releaseCoordinatorGroup"}},{label:"searchAssigneeGroup",type:"search",method:"searchModel.getReleaseCoordinatorGroupsByText",typeaheadTemplate:"views/console/support-group-typeahead-template.html",fields:{key:"name",value:"id"},valueFormat:"{id: value}"}]},{name:"riskLevel",label:"riskLevel",ticketType:["change","release"],options:[]},{name:"scheduledStartDates",label:"scheduledStartDates",showLabelInPill:!0,ticketType:["change","task","workorder","release"],options:[{name:"changeStartNext24",label:"next24",type:"date",defaultValues:{start:"moment().valueOf()",end:'moment().add(1, "days").valueOf()'},criteria:{name:"scheduledStartDates"}},{name:"changeStartNext48",label:"next48",type:"date",defaultValues:{start:"moment().valueOf()",end:'moment().add(2, "days").valueOf()'},criteria:{name:"scheduledStartDates"}},{name:"changeStartNextWeek",label:"nextWeek",type:"date",defaultValues:{start:"moment().valueOf()",end:'moment().add(7, "days").valueOf()'},criteria:{name:"scheduledStartDates"}},{name:"changeStartCustomRange",label:"customRange",type:"timeStampRange",format:"mediumDate",startDatePicker:{date:null},endDatePicker:{date:null},criteria:{name:"scheduledStartDates"}}]},{name:"scheduledEndDates",label:"scheduledEndDates",showLabelInPill:!0,ticketType:["change","task","workorder","release"],options:[{name:"changeEndNext24",label:"next24",type:"date",defaultValues:{start:"moment().valueOf()",end:'moment().add(1, "days").valueOf()'},criteria:{name:"scheduledEndDates"}},{name:"changeEndNext48",label:"next48",type:"date",defaultValues:{start:"moment().valueOf()",end:'moment().add(2, "days").valueOf()'},criteria:{name:"scheduledEndDates"}},{name:"changeEndNextWeek",label:"nextWeek",type:"date",defaultValues:{start:"moment().valueOf()",end:'moment().add(7, "days").valueOf()'},criteria:{name:"scheduledEndDates"}},{name:"changeEndCustomRange",label:"customRange",type:"timeStampRange",format:"mediumDate",startDatePicker:{date:null},endDatePicker:{date:null},criteria:{name:"scheduledEndDates"}}]},{name:"sites",label:"site",options:[{name:"mySite",label:"mySite",type:"constant",criteria:{name:"sites"}},{label:"searchSite",type:"search",method:"searchModel.getSitesObjectByText",typeaheadTemplate:"views/console/general-typeahead-template.html",fields:{key:"name",value:"name"},valueFormat:"{name: value}"}]},{name:"slmStatusMappings",label:"slaStatus",ticketType:["change","incident","workorder"],options:[{name:"slaBreached",label:"slaBreached",type:"constant",criteria:{name:"slmStatusMappings",value:["breached"]}},{name:"withinSla",label:"withinSla",type:"constant",criteria:{name:"slmStatusMappings",value:["withinsla"]}},{name:"noSla",label:"noSla",type:"constant",criteria:{name:"slmStatusMappings",value:["nosla"]}}]},{name:"statuses",label:"status",options:[{name:"allOpen",label:"allOpen",type:"constant",filterName:"statuses",criteria:{name:"statusMappings",value:["open"],ticketTypes:["workorder","task","request","incident","change","problem","knownerror","release"]}},{name:"allClosed",label:"allClosed",type:"constant",filterName:"statuses",criteria:{name:"statusMappings",value:["close"],ticketTypes:["workorder","task","request","incident","change","problem","knownerror","release"]}}]},{name:"submittedBy",label:"submitter",showLabelInPill:!0,options:[{name:"me",label:"me",type:"constant",criteria:{name:"submittedBy"}},{label:"searchSubmitter",type:"search",method:"personModel.getListOfPersonsByText",typeaheadTemplate:"views/console/search-person-typeahead-template.html",fields:{key:"fullName",value:"loginId"},valueFormat:"{loginId: value}"}]},{name:"targetDate",label:"targetDate",showLabelInPill:!0,ticketType:["release"],options:[{name:"targetDatePast24",label:"next24",type:"date",order:1,defaultValues:{start:"moment().valueOf()",end:'moment().add(1, "days").valueOf()'},criteria:{name:"targetDate"}},{name:"targetDatePastWeek",label:"nextWeek",type:"date",order:2,defaultValues:{start:"moment().valueOf()",end:'moment().add(7, "days").valueOf()'},criteria:{name:"targetDate"}},{name:"targetDatePastMonth",label:"nextMonth",type:"date",order:3,defaultValues:{start:"moment().valueOf()",end:'moment().add(30, "days").valueOf()'},criteria:{name:"targetDate"}},{name:"targetDateCustomRange",label:"customRange",type:"timeStampRange",format:"mediumDate",startDatePicker:{date:new Date},endDatePicker:{date:new Date},criteria:{name:"targetDate"}}]}],ribbon:[{name:"bulk-assignment",type:"button",icon:"user_plus",active:"ribbonValidationService.isSameTypeSelected(selectedItems) && !ribbonValidationService.isServiceRequest(selectedItems) && ribbonValidationService.isSameCompanySelected(selectedItems) && !ribbonValidationService.isRelease(selectedItems)",action:"assign"},{name:"bulk-share",type:"button",icon:"share",active:"ribbonValidationService.validateShareButton(selectedItems) && selectedItems.length < 16",action:"share"},{name:"bulk-follow-unfollow",type:"button",icon:"star",active:"selectedItems.length > 0",actions:[{method:"follow",name:"follow"},{method:"unfollow",name:"unfollow"}]},{name:"bulk-relate",type:"button",icon:"link",active:"ribbonValidationService.isSameTypeSelected(selectedItems) && !ribbonValidationService.isServiceRequest(selectedItems)",action:"link"},{name:"bulk-launch",type:"button",icon:"pop_up",active:"selectedItems.length <= 10",action:"openInNewTab"},{name:"bulk-need-attention",type:"button",icon:"flag",active:"ribbonValidationService.isIncidentOrWordorder(selectedItems)",actions:[{method:"flag",name:"flag"},{method:"unflag",name:"unflag"}]},{name:"bulk-status-update",type:"button",text:"updateStatus",active:"ribbonValidationService.isSameTypeSelected(selectedItems) && !ribbonValidationService.isServiceRequest(selectedItems) && ribbonValidationService.isValidChangeStatusUpdate(selectedItems) && !ribbonValidationService.isRelease(selectedItems) && !ribbonValidationService.disableBulkUpdate(selectedItems) && !ribbonValidationService.anyBypassedTasks(selectedItems)",action:"changeStatus"}],stats:[{name:"mytickets",label:"my",filterSetup:[{filter:"assignees",option:"me",checkForLocale:!1}]},{name:"Critical",label:"critical",filterSetup:[{filter:"priorities",option:"Critical",checkForLocale:!0}]},{name:"needsAttention",label:"needsAttention",filterSetup:[{filter:"needsAttention",option:"flagged",checkForLocale:!1}]},{name:"new",label:"new",filterSetup:[{filter:"createDateRanges",option:"createDatePast24",checkForLocale:!1}]},{name:"open",label:"open",filterSetup:[{filter:"statuses",option:"allOpen",checkForLocale:!1}]},{name:"total",label:"all"},{name:"securitytickets",label:"security",filterSetup:[{filter:"incidentTypes",option:"Security Incident",checkForLocale:!0}]}],cellFilters:{releaseType:'localizeLabel: "type":row.entity.type',milestone:'localizeLabel: "milestone":row.entity.type',reportedSource:'localizeLabel: "reportedSource":row.entity.type',businessJustification:'localizeLabel: "businessJustification":row.entity.type',investigationDriver:'localizeLabel: "investigationDriver":row.entity.type',riskLevel:'localizeLabel: "riskLevel":row.entity.type',changeReason:'localizeLabel: "changeReason":row.entity.type',changeClass:'localizeLabel: "timing":row.entity.type',incidentType:'localizeLabel: "serviceType":row.entity.type',urgency:'localizeLabel: "urgency":row.entity.type',status:'localizeLabel: "status":row.entity.type',impact:'localizeLabel: "impact":row.entity.type',statusReason:'localizeLabel: "statusReason":row.entity.type',workOrderType:'localizeLabel: "workOrderType":row.entity.type',taskType:'localizeLabel: "taskType":row.entity.type',escalated:"tcCellEscalated",ticketType:"tcCellType",slaStatus:"tcCellSlaStatus",id:"tcCellHighlight: row.entity.highlight",summary:"tcCellHighlight: row.entity.highlight"},config:{quickSearchCharLimit:100,maxFilterPills:2}},knowledgeArticle:{visibilities:[{label:"create.knowledge.visibility.everyone",value:"everyone"},{label:"create.knowledge.visibility.my.company",value:"myCompany"},{label:"create.knowledge.visibility.last.set.of.groups",value:"lastGroupSet",onlyDraft:!0},{label:"create.knowledge.visibility.specific.groups",value:"specificGroup"}],categorySerializationMap:[{all:"allCompanies",primary:"company",additional:"additionalCategoriesCompanies"},{all:"allSites",primary:"site",additional:"additionalCategoriesSite"},{all:"allServices",primary:"businessService",additional:"additionalCategoriesBusinessService"},{all:"allOrganizations",primary:"organization",additional:"additionalCategoriesOrganization"},{all:"allCategories",primary:"categorizations",additional:"additionalCategorization"}],restrictionMap:{assigneeEditAllowed:["assignee"],companyEditAllowed:["company","additionalCategoriesCompanies"],visibilitygroupsEditAllowed:["articleVisibilityGroup"],detailsEditAllowed:["tags","categorizations","additionalCategoriesBusinessService","additionalCategoriesSite","additionalCategoriesOrganization","additionalCategorization","site","organization","businessService","language","nextReviewDate"],internaluseEditAllowed:["internalUse"]}},knowledgeConsole:{columns:{assignee:{displayName:"assignee",attributeName:"assignee",field:"assignee.fullName",visible:!0,order:4,name:"assignee"},assigneeGroup:{displayName:"assigneeGroup",attributeName:"assigneeGroup",field:"assignedGroup.name",visible:!1,name:"assigneeGroup"},author:{displayName:"author",attributeName:"author",field:"author.fullName",visible:!1,name:"author"},company:{displayName:"company",attributeName:"company",field:"company.name",visible:!1,name:"company"},createDate:{displayName:"createDate",attributeName:"createDate",field:"createDate",visible:!1,name:"createDate",cellFilter:'datePreConfigTimezone:"medium"'},flagged:{displayName:"flagged",attributeName:"flagged",field:"flagged",visible:!0,order:7,name:"flagged",cellFilter:"tcCellEscalated"},id:{displayName:"id",attributeName:"articleId",field:"articleId",visible:!0,order:1,pinned:!0,name:"id"},internal:{displayName:"internal",attributeName:"internal",field:"internal",visible:!1,name:"internal",cellFilter:"tcCellEscalated"},keywords:{displayName:"keywords",attributeName:"keywords",field:"tags",visible:!1,name:"keywords",sortable:!1},language:{displayName:"language",attributeName:"language",field:"language",visible:!1,name:"language",cellFilter:'localizeLabel: "language":row.entity.type'},lastModifiedDate:{displayName:"lastModifiedDate",attributeName:"modifiedDate",field:"modifiedDate",visible:!0,order:6,name:"lastModifiedDate",cellFilter:'datePreConfigTimezone:"medium"'},articleModifiedDate:{displayName:"articleModifiedDate",attributeName:"articleModifiedDate",field:"articleModifiedDate",visible:!1,name:"articleModifiedDate",cellFilter:'datePreConfigTimezone:"medium"'},organization:{displayName:"organization",attributeName:"organization",field:"organization",visible:!1,name:"organization"},service:{displayName:"service",attributeName:"service",field:"service",visible:!1,name:"service"},status:{displayName:"status",attributeName:"status",field:"statusValue.value",visible:!0,order:3,name:"status",cellFilter:'localizeLabel: "status":row.entity.type'},templateName:{displayName:"templateName",attributeName:"templateName",field:"templateName",visible:!0,order:5,name:"templateName",cellFilter:"kcTemplateType"},title:{displayName:"title",attributeName:"title",field:"title",visible:!0,order:2,name:"title"},version:{displayName:"version",attributeName:"version",field:"version",visible:!1,name:"version"}},filter:[{name:"approvalStatuses",label:"approvalStatus",options:[{name:"waitingForApproval",label:"waitingForApproval",type:"constant",criteria:{name:"approvalStatuses",value:["inApproval"]}}]},{name:"assignedSupportGroups",label:"assigneeGroup",showLabelInPill:!0,options:[{name:"myGroup",label:"myGroup",type:"constant",criteria:{name:"assignedSupportGroups"}},{label:"searchAssigneeGroup",type:"search",method:"searchModel.getListOfSupportGroupsByText",typeaheadTemplate:"views/console/support-group-typeahead-template.html",fields:{key:"name",value:"name"},valueFormat:"{name: value}"}]},{name:"assignees",label:"assignee",showLabelInPill:!0,expanded:!0,options:[{name:"me",label:"me",type:"constant",criteria:{name:"assignees"}},{name:"unassigned",label:"unassigned",type:"constant",criteria:{name:"assignees",value:[{loginId:""}]}},{label:"searchAssignee",type:"search",method:"personModel.getListOfPersonsByText",typeaheadTemplate:"views/console/search-person-typeahead-template.html",fields:{key:"fullName",value:"loginId"},valueFormat:"{loginId: value}"}]},{name:"authors",label:"author",showLabelInPill:!0,options:[{name:"me",label:"me",type:"constant",criteria:{name:"authors"}},{label:"searchAuthor",type:"search",method:"personModel.getListOfPersonsByText",typeaheadTemplate:"views/console/search-person-typeahead-template.html",fields:{key:"fullName",value:"loginId"},valueFormat:"{loginId: value}"}]},{name:"companies",label:"company",options:[{label:"searchCompany",type:"search",method:"searchModel.getListOfCompaniesByText",typeaheadTemplate:"views/console/general-typeahead-template.html",fields:{key:"name",value:"name"},valueFormat:"{name: value}"}]},{name:"createDateRanges",label:"createDate",showLabelInPill:!0,options:[{name:"createDatePast24",label:"past24",type:"date",order:1,defaultValues:{start:'moment().subtract(1, "days").valueOf()',end:"moment().valueOf()"},criteria:{name:"createDateRanges"}},{name:"createDatePastWeek",label:"pastWeek",type:"date",order:2,defaultValues:{start:'moment().subtract(7, "days").valueOf()',end:"moment().valueOf()"},criteria:{name:"createDateRanges"}},{name:"createDatePastMonth",label:"pastMonth",type:"date",order:3,defaultValues:{start:'moment().subtract(30, "days").valueOf()',end:"moment().valueOf()"},criteria:{name:"createDateRanges"}},{name:"createDateCustomRange",label:"customRange",type:"timeStampRange",format:"mediumDate",startDatePicker:{date:new Date},endDatePicker:{date:new Date},criteria:{name:"createDateRanges"}}]},{name:"keywords",label:"keywords",options:[{label:"searchKeywords",type:"search",subtype:"keyword"}]},{name:"modifiedDateRanges",label:"lastModifiedDate",showLabelInPill:!0,options:[{name:"modifiedDatePast24",label:"past24",type:"date",order:1,defaultValues:{start:'moment().subtract(1, "days").valueOf()',end:"moment().valueOf()"},criteria:{name:"modifiedDateRanges"}},{name:"modifiedDatePastWeek",label:"pastWeek",type:"date",order:2,defaultValues:{start:'moment().subtract(7, "days").valueOf()',end:"moment().valueOf()"},criteria:{name:"modifiedDateRanges"}},{name:"modifiedDatePastMonth",label:"pastMonth",type:"date",order:3,defaultValues:{start:'moment().subtract(30, "days").valueOf()',end:"moment().valueOf()"},criteria:{name:"modifiedDateRanges"}},{name:"modifiedDateCustomRange",label:"customRange",type:"timeStampRange",format:"mediumDate",startDatePicker:{date:new Date},endDatePicker:{date:new Date},criteria:{name:"modifiedDateRanges"}}]},{name:"languages",label:"language",options:[{name:"myLanguage",label:"myLanguage",type:"constant",criteria:{name:"languages"}}]},{name:"organizations",label:"organization",options:[{name:"myOrganization",label:"myOrganization",type:"constant",criteria:{name:"organizations"}},{label:"searchOrganization",type:"search",method:"searchModel.getOrganizationsByText",typeaheadTemplate:"views/console/general-typeahead-template.html",fields:{key:"name",value:"name"},valueFormat:"value"}]},{name:"settings",label:"settings",options:[{name:"favorite",label:"favorite",type:"constant",filterName:"settings",criteria:{name:"favorite",value:"true"}},{name:"flagged",label:"flagged",type:"constant",filterName:"settings",criteria:{name:"flagged",value:"true"}},{name:"internal",label:"internal",type:"constant",filterName:"settings",criteria:{name:"internal",value:"true"}}]},{name:"statusMappings",label:"status",options:[{name:"allOpen",label:"allOpen",type:"constant",filterName:"statusMappings",criteria:{name:"statusMappings",value:["open"]}}]},{name:"templateNames",label:"templateName",options:[]},{name:"approvalAssignment",label:"toBeApproved",showLabelInPill:!0,options:[{name:"me",label:"me",type:"constant",criteria:{name:"approvalAssignment"}},{label:"searchApprover",type:"search",method:"personModel.getListOfPersonsByText",typeaheadTemplate:"views/console/search-person-typeahead-template.html",fields:{key:"fullName",value:"loginId"},valueFormat:"{loginId: value}"}]}],languages:[{
locale:"en",name:"English",label:"English"},{locale:"en-ca",name:"English-Canadian",label:"English-Canadian"},{locale:"de",name:"German",label:"German"},{locale:"fr",name:"French",label:"French"},{locale:"fr-ca",name:"French-Canadian",label:"French-Canadian"},{locale:"he",name:"Hebrew",label:"Hebrew"},{locale:"it",name:"Italian",label:"Italian"},{locale:"ja",name:"Japanese",label:"Japanese"},{locale:"ko",name:"Korean",label:"Korean"},{locale:"ru",name:"Russian",label:"Russian"},{locale:"zh",name:"Chinese",label:"Chinese"},{locale:"es",name:"Spanish",label:"Spanish"},{locale:"pt",name:"Portuguese",label:"Portuguese"},{locale:"pl",name:"Polish",label:"Polish"}],ribbon:[{type:"button",icon:"user_plus",active:"ribbonValidationService.isSameTypeSelected(selectedItems) && !ribbonValidationService.isServiceRequest(selectedItems) && ribbonValidationService.primaryAndOwnerCompanyCheck(selectedItems) && ribbonValidationService.hasKnowledgeWritePermissions()",action:"assign"},{type:"button",icon:"share",active:"selectedItems.length > 0",action:"share"},{type:"button",icon:"star",active:"selectedItems.length > 0",actions:[{method:"follow",name:"follow"},{method:"unfollow",name:"unfollow"}]},{type:"button",text:"performAssessment",active:"selectedItems.length === 1",hidden:"ribbonValidationService.hasKCSCoachAccess()",action:"assess"}],stats:[{name:"myArticles",label:"my",filterSetup:[{filter:"assignees",option:"me"}]},{name:"newArticles",label:"new",filterSetup:[{filter:"createDateRanges",option:"createDatePastWeek"}]},{name:"publishedArticles",label:"open",filterSetup:[{filter:"statusMappings",option:"Published"}]},{name:"allArticles",label:"all"}]},assetConsole:{columns:{id:{displayName:"ciId",attributeName:"CIid",field:"assetId",visible:!0,order:1,pinned:!0,name:"id"},name:{displayName:"name",attributeName:"name",field:"name",visible:!0,order:2,pinned:!0,name:"name",width:200},assetType:{displayName:"assetType",attributeName:"type",field:"type",visible:!0,order:3,name:"assetType",sortable:!1,cellFilter:'localizeLabel: "assetType":row.entity.ticketType'},productName:{displayName:"productName",attributeName:"productName",field:"product.name",visible:!0,order:4,name:"productName"},status:{displayName:"status",attributeName:"status",field:"status.value",visible:!0,order:5,name:"status",cellFilter:'localizeLabel: "status":row.entity.ticketType'},serialNumber:{displayName:"serialNumber",attributeName:"serialNumber",field:"serialNumber",visible:!0,order:6,name:"serialNumber",width:250},floor:{displayName:"floor",attributeName:"floor",field:"floor",visible:!1,name:"floor"},manufacturer:{displayName:"manufacturer",attributeName:"manufacturer",field:"manufacturer",visible:!1,name:"manufacturer"},room:{displayName:"room",attributeName:"room",field:"room",visible:!1,name:"room"},region:{displayName:"region",attributeName:"siteRegion",field:"site.region",visible:!1,name:"region"},modelVersion:{displayName:"modelVersion",attributeName:"modelVersion",field:"product.model",visible:!1,name:"modelVersion"},systemRole:{displayName:"systemRole",attributeName:"systemRole",field:"systemRole",visible:!1,name:"systemRole"},site:{displayName:"site",attributeName:"siteName",field:"site.name",visible:!0,order:7,name:"site",width:200}},filter:[{name:"assetTypes",label:"assetType",expanded:!0,options:[]},{name:"approvedBy",label:"approvedBy",showLabelInPill:!0,searchModes:[{id:0,method:"personModel.getListOfPersonsByText",name:"common.labels.people",fields:{key:"fullName",value:"personId"}},{id:1,method:"searchModel.getListOfSupportGroupsByText",name:"common.labels.supportGroup",fields:{key:"name",value:"id"}},{id:2,method:"searchModel.getOrganizationsByText",name:"common.label.organization",fields:{key:"name",value:"attributeMap.id"}}],selectedSearchMode:{id:0,method:"personModel.getListOfPersonsByText",name:"common.labels.people",fields:{key:"fullName",value:"personId"}},options:[{name:"me",label:"me",type:"constant",criteria:{name:"approvedBy"}},{label:"searchApprover",type:"search",method:"personModel.getListOfPersonsByText",typeaheadTemplate:"views/console/search-person-typeahead-template.html",fields:{key:"fullName",value:"personId"},valueFormat:"{id: value}"}]},{name:"assetSubTypes",label:"assetSubType",showLabelInPill:!0,options:[]},{name:"companies",label:"company",showLabelInPill:!0,options:[{label:"searchCompany",type:"search",method:"searchModel.getListOfCompaniesByText",typeaheadTemplate:"views/console/general-typeahead-template.html",fields:{key:"name",value:"name"},valueFormat:"{name: value}"}]},{name:"cpu",label:"cpuCount",assetType:["Computer System"],showLabelInPill:!0,options:[{label:"cpuCountRange",type:"range",subtype:"range",criteria:{name:"cpu",value:[{min:1,max:1}]}}]},{name:"createdBy",label:"createdBy",showLabelInPill:!0,searchModes:[{id:0,method:"personModel.getListOfPersonsByText",name:"common.labels.people",fields:{key:"fullName",value:"personId"}},{id:1,method:"searchModel.getListOfSupportGroupsByText",name:"common.labels.supportGroup",fields:{key:"name",value:"id"}},{id:2,method:"searchModel.getOrganizationsByText",name:"common.label.organization",fields:{key:"name",value:"attributeMap.id"}}],selectedSearchMode:{id:0,method:"personModel.getListOfPersonsByText",name:"common.labels.people",fields:{key:"fullName",value:"personId"}},options:[{name:"me",label:"me",type:"constant",criteria:{name:"createdBy"}},{label:"searchCreator",type:"search",method:"personModel.getListOfPersonsByText",typeaheadTemplate:"views/console/search-person-typeahead-template.html",fields:{key:"fullName",value:"personId"},valueFormat:"{id: value}"}]},{name:"floor",label:"floor",showLabelInPill:!0,options:[{label:"searchFloor",type:"search",subtype:"keyword"}]},{name:"keywords",label:"keywords",options:[{label:"searchKeywords",type:"search",subtype:"keyword"}]},{name:"managedBy",label:"managedBy",showLabelInPill:!0,searchModes:[{id:0,method:"personModel.getListOfPersonsByText",name:"common.labels.people",fields:{key:"fullName",value:"personId"}},{id:1,method:"searchModel.getListOfSupportGroupsByText",name:"common.labels.supportGroup",fields:{key:"name",value:"id"}},{id:2,method:"searchModel.getOrganizationsByText",name:"common.label.organization",fields:{key:"name",value:"attributeMap.id"}}],selectedSearchMode:{id:0,method:"personModel.getListOfPersonsByText",name:"common.labels.people",fields:{key:"fullName",value:"personId"}},options:[{name:"me",label:"me",type:"constant",criteria:{name:"managedBy"}},{label:"searchManager",type:"search",method:"personModel.getListOfPersonsByText",typeaheadTemplate:"views/console/search-person-typeahead-template.html",fields:{key:"fullName",value:"personId"},valueFormat:"{id: value}"}]},{name:"manufacturer",label:"manufacturer",showLabelInPill:!0,options:[{label:"searchManufacturer",type:"search",method:"searchModel.getFoundationManufacturersByText",typeaheadTemplate:"views/search/search-typeahead-template.html",fields:{key:"name",value:"name"},valueFormat:"value"}]},{name:"model",label:"model",showLabelInPill:!0,options:[{label:"searchModel",type:"search",subtype:"keyword"}]},{name:"operatingSystem",label:"operatingSystem",showLabelInPill:!0,assetType:["Computer System"],criteriaKeys:[{name:"manufacturer",label:"console.filter.name.manufacturer",method:"searchModel.getFoundationManufacturersByText",valueFormat:"value",fields:{key:"name",value:"name"},operators:[{name:"console.filter.optionName.is",id:1}],selectedOperator:{name:"console.filter.optionName.is",id:1},typeaheadTemplate:"views/search/search-typeahead-template.html",type:"search"},{name:"productName",label:"console.column.productName",method:"consoleModel.getProductNamesByCompany",valueFormat:"{categorizations: categorizations}",fields:{key:"value",value:""},operators:[{name:"console.filter.optionName.is",id:1}],selectedOperator:{name:"console.filter.optionName.is",id:1},typeaheadTemplate:"views/search/search-typeahead-template.html",type:"search",menuPositionShift:!0},{name:"version",label:"console.column.version",placeholder:"console.filter.optionName.version",operators:[{name:"console.filter.optionName.is",id:1},{name:"console.filter.optionName.isnot",id:6},{name:"console.filter.optionName.like",id:7}],selectedOperator:{name:"console.filter.optionName.is",id:1},type:"keyword"}],options:[{label:"operatingSystem",type:"range",subtype:"range",criteria:{name:"operatingSystem"}}]},{name:"owners",label:"owner",showLabelInPill:!0,searchModes:[{id:0,method:"personModel.getListOfPersonsByText",name:"common.labels.people",fields:{key:"fullName",value:"personId"}},{id:1,method:"searchModel.getListOfSupportGroupsByText",name:"common.labels.supportGroup",fields:{key:"name",value:"id"}},{id:2,method:"searchModel.getOrganizationsByText",name:"common.label.organization",fields:{key:"name",value:"attributeMap.id"}}],selectedSearchMode:{id:0,method:"personModel.getListOfPersonsByText",name:"common.labels.people",fields:{key:"fullName",value:"personId"}},options:[{name:"me",label:"me",type:"constant",criteria:{name:"owners"}},{label:"searchOwner",type:"search",method:"personModel.getListOfPersonsByText",typeaheadTemplate:"views/console/search-person-typeahead-template.html",fields:{key:"fullName",value:"personId"},valueFormat:"{id: value}"}]},{name:"processor",label:"processor",showLabelInPill:!0,assetType:["Computer System"],criteriaKeys:[{name:"manufacturer",label:"console.filter.name.manufacturer",method:"searchModel.getFoundationManufacturersByText",valueFormat:"value",fields:{key:"name",value:"name"},operators:[{name:"console.filter.optionName.is",id:1}],selectedOperator:{name:"console.filter.optionName.is",id:1},typeaheadTemplate:"views/search/search-typeahead-template.html",type:"search"},{name:"productName",label:"console.column.productName",method:"consoleModel.getProductNamesByCompany",valueFormat:"{categorizations: categorizations}",fields:{key:"value",value:""},operators:[{name:"console.filter.optionName.is",id:1}],selectedOperator:{name:"console.filter.optionName.is",id:1},typeaheadTemplate:"views/search/search-typeahead-template.html",type:"search",menuPositionShift:!0},{name:"speed",label:"console.column.speed",placeholder:"console.filter.optionName.speed",operators:[{name:"=",id:1},{name:">=",id:3},{name:"<=",id:5}],selectedOperator:{name:"=",id:1},type:"keyword",valueIsNumber:!0}],options:[{label:"processor",type:"range",subtype:"range",criteria:{name:"processor"}}]},{name:"products",label:"product",showLabelInPill:!0,options:[{label:"searchProducts",type:"search",method:"consoleModel.getProductCategoriesByCompany",typeaheadTemplate:"views/search/search-typeahead-template.html",fields:{key:"value",value:""},valueFormat:"{categorizations: categorizations}"}]},{name:"region",label:"region",showLabelInPill:!0,options:[{label:"myRegion",name:"myRegion",type:"constant",criteria:{name:"region"}},{label:"searchRegion",type:"search",method:"searchModel.getFoundationRegionsByText",typeaheadTemplate:"views/console/general-typeahead-template.html",fields:{key:"name",value:"name"},valueFormat:"{region: value, companyName: companyName}"}]},{name:"rack",label:"rack",showLabelInPill:!0,assetType:["Computer System"],options:[{label:"searchRack",type:"search",subtype:"keyword"}]},{name:"room",label:"room",showLabelInPill:!0,options:[{label:"searchRoom",type:"search",subtype:"keyword"}]},{name:"sites",label:"site",showLabelInPill:!0,options:[{label:"mySite",name:"mySite",type:"constant",criteria:{name:"sites"}},{label:"searchSite",type:"search",method:"searchModel.getFoundationSitesByText",typeaheadTemplate:"views/console/site-typeahead-template.html",fields:{key:"name",value:"name"},valueFormat:"{name: value, siteGroup: siteGroupName, region: regionName, companyName: companyName}"}]},{name:"siteGroup",label:"siteGroup",showLabelInPill:!0,options:[{label:"mySiteGroup",name:"mySiteGroup",type:"constant",criteria:{name:"siteGroup"}},{label:"searchSiteGroup",type:"search",method:"searchModel.getFoundationSiteGroupsByText",typeaheadTemplate:"views/console/general-typeahead-template.html",fields:{key:"name",value:"name"},valueFormat:"{siteGroup: value, region: regionName, companyName: companyName}"}]},{name:"ticketSpecificStatuses",label:"status",options:[]},{name:"supplier",label:"supplier",showLabelInPill:!0,options:[{label:"searchSupplier",type:"search",method:"searchModel.getFoundationSuppliersByText",typeaheadTemplate:"views/search/search-typeahead-template.html",fields:{key:"name",value:"name"},valueFormat:"value"}]},{name:"supportedBy",label:"supportedBy",showLabelInPill:!0,searchModes:[{id:0,method:"personModel.getListOfPersonsByText",name:"common.labels.people",fields:{key:"fullName",value:"personId"}},{id:1,method:"searchModel.getListOfSupportGroupsByText",name:"common.labels.supportGroup",fields:{key:"name",value:"id"}},{id:2,method:"searchModel.getOrganizationsByText",name:"common.label.organization",fields:{key:"name",value:"attributeMap.id"}}],selectedSearchMode:{id:0,method:"personModel.getListOfPersonsByText",name:"common.labels.people",fields:{key:"fullName",value:"personId"}},options:[{name:"me",label:"me",type:"constant",criteria:{name:"supportedBy"}},{label:"searchSupporter",type:"search",method:"personModel.getListOfPersonsByText",typeaheadTemplate:"views/console/search-person-typeahead-template.html",fields:{key:"fullName",value:"personId"},valueFormat:"{id: value}"}]},{name:"usedBy",label:"usedBy",showLabelInPill:!0,searchModes:[{id:0,method:"personModel.getListOfPersonsByText",name:"common.labels.people",fields:{key:"fullName",value:"personId"}},{id:1,method:"searchModel.getListOfSupportGroupsByText",name:"common.labels.supportGroup",fields:{key:"name",value:"id"}},{id:2,method:"searchModel.getOrganizationsByText",name:"common.label.organization",fields:{key:"name",value:"attributeMap.id"}}],selectedSearchMode:{id:0,method:"personModel.getListOfPersonsByText",name:"common.labels.people",fields:{key:"fullName",value:"personId"}},options:[{name:"me",label:"me",type:"constant",criteria:{name:"usedBy"}},{label:"searchUser",type:"search",method:"personModel.getListOfPersonsByText",typeaheadTemplate:"views/console/search-person-typeahead-template.html",fields:{key:"fullName",value:"personId"},valueFormat:"{id: value}"}]}],ribbon:[],stats:[]},feed:{update:{filter:[{name:"bcmActions",label:"bcmActions",type:"showActivityTypes",criteria:[{name:"eventType",value:["asset-reboot","asset-wakeup","asset-shutdown","asset-ping","asset-audit"]},{name:"filterType",value:["system"]}]},{name:"ownershipChanges",label:"ownershipUpdates",type:"showActivityTypes",criteria:[{name:"eventType",value:["ownership-change"]},{name:"filterType",value:["system"]}]},{name:"assignment",label:"assignmentUpdates",type:"showActivityTypes",criteria:[{name:"eventType",value:["assignment-change"]},{name:"filterType",value:["system"]}]},{name:"broadcasts",label:"broadcasts",type:"showActivityTypes",criteria:[{name:"eventType",value:["broadcast-create","broadcast-met"]},{name:"filterType",value:["broadcast"]}]},{name:"outages",label:"outages",type:"showActivityTypes",criteria:[{name:"eventType",value:["outage-change","outage-met"]},{name:"filterType",value:["outage"]}]},{name:"note",label:"note",type:"showActivityTypes",criteria:[{name:"access",value:["false"]},{name:"filterType",value:["comment"]}],display:"isKnowledgeOnlyUser"},{name:"slaAlerts",label:"slaAlerts",type:"showActivityTypes",criteria:[{name:"eventType",value:["sla-change"]},{name:"filterType",value:["system"]}],display:"isSLMEnabled"},{name:"statusChanges",label:"statusUpdates",type:"showActivityTypes",criteria:[{name:"eventType",value:["status-change","inc-reopen"]},{name:"filterType",value:["system"]}]},{name:"approval",label:"approvalStatusUpdates",type:"showActivityTypes",criteria:[{name:"eventType",value:["approval-accept-event","approval-hold-event","approval-reject-event"]},{name:"filterType",value:["system"]}],display:"hasKnowledgeOrChangePermission"},{name:"priorityChanges",label:"priorityUpdates",type:"showActivityTypes",criteria:[{name:"eventType",value:["priority-change"]},{name:"filterType",value:["system"]}]},{name:"knowledgeArticleUpdates",label:"knowledgeArticleUpdates",type:"showActivityTypes",criteria:[{name:"eventType",value:["knowledge-updates"]},{name:"filterType",value:["system"]}]},{name:"taskUpdates",label:"taskUpdates",type:"showActivityTypes",criteria:[{name:"eventType",value:["task-relation"]},{name:"filterType",value:["system"]}]},{name:"relationshipChanges",label:"relationshipChanges",type:"showActivityTypes",criteria:[{name:"eventType",value:["related-change","unrelated-change"]},{name:"filterType",value:["system"]}]},{name:"locationChanges",label:"locationChanges",type:"showActivityTypes",criteria:[{name:"eventType",value:["region-change"]},{name:"filterType",value:["system"]}]},{name:"majorIncidents",label:"majorIncidents",type:"showActivityTypes",criteria:[{name:"eventType",value:["majorInc-updates"]},{name:"filterType",value:["system"]}]}]},activity:{incident:{filter:[{name:"privateNote",label:"privateNote",type:"showActivityTypes",criteria:[{name:"access",value:["true"]},{name:"filterType",value:["comment"]}]},{name:"publicNote",label:"publicNote",type:"showActivityTypes",criteria:[{name:"access",value:["false"]},{name:"filterType",value:["comment"]}]},{name:"vendorNote",label:"vendorNote",type:"showActivityTypes",criteria:[{name:"shareWithVendor",value:["true"]},{name:"filterType",value:["comment"]}]},{name:"assignment",label:"assignmentUpdates",type:"showActivityTypes",criteria:[{name:"eventType",value:["assignment-change"]},{name:"filterType",value:["system"]}]},{name:"statusChanges",label:"statusUpdates",type:"showActivityTypes",criteria:[{name:"eventType",value:["status-change"]},{name:"filterType",value:["system"]}]},{name:"slaAlerts",label:"slaAlerts",type:"showActivityTypes",criteria:[{name:"eventType",value:["sla-change"]},{name:"filterType",value:["system"]}]},{name:"taskActivities",label:"taskActivities",type:"showActivityTypes",criteria:[{name:"eventType",value:["task-relation"]},{name:"filterType",value:["system"]}]},{name:"versionChanges",label:"versionChanges",type:"showActivityTypes",criteria:[{name:"eventType",value:["incident-create"]},{name:"filterType",value:["system"]}]},{name:"priorityChanges",label:"priorityUpdates",type:"showActivityTypes",criteria:[{name:"eventType",value:["priority-change"]},{name:"filterType",value:["system"]}]}]},workorder:{filter:[{name:"privateNote",label:"privateNote",type:"showActivityTypes",criteria:[{name:"access",value:["true"]},{name:"filterType",value:["comment"]}]},{name:"publicNote",label:"publicNote",type:"showActivityTypes",criteria:[{name:"access",value:["false"]},{name:"filterType",value:["comment"]}]},{name:"vendorNote",label:"vendorNote",type:"showActivityTypes",criteria:[{name:"shareWithVendor",value:["true"]},{name:"filterType",value:["comment"]}]},{name:"assignment",label:"assignmentUpdates",type:"showActivityTypes",criteria:[{name:"eventType",value:["assignment-change"]},{name:"filterType",value:["system"]}]},{name:"statusChanges",label:"statusUpdates",type:"showActivityTypes",criteria:[{name:"eventType",value:["status-change"]},{name:"filterType",value:["system"]}]},{name:"slaAlerts",label:"slaAlerts",type:"showActivityTypes",criteria:[{name:"eventType",value:["sla-change"]},{name:"filterType",value:["system"]}]},{name:"taskActivities",label:"taskActivities",type:"showActivityTypes",criteria:[{name:"eventType",value:["task-relation"]},{name:"filterType",value:["system"]}]},{name:"priorityChanges",label:"priorityUpdates",type:"showActivityTypes",criteria:[{name:"eventType",value:["priority-change"]},{name:"filterType",value:["system"]}]}]},task:{filter:[{name:"privateNote",label:"privateNote",type:"showActivityTypes",criteria:[{name:"access",value:["true"]},{name:"filterType",value:["comment"]}]},{name:"publicNote",label:"publicNote",type:"showActivityTypes",criteria:[{name:"access",value:["false"]},{name:"filterType",value:["comment"]}]},{name:"assignment",label:"assignmentUpdates",type:"showActivityTypes",criteria:[{name:"eventType",value:["assignment-change"]},{name:"filterType",value:["system"]}]},{name:"statusChanges",label:"statusUpdates",type:"showActivityTypes",criteria:[{name:"eventType",value:["status-change"]},{name:"filterType",value:["system"]}]},{name:"slaAlerts",label:"slaAlerts",type:"showActivityTypes",criteria:[{name:"eventType",value:["sla-change"]},{name:"filterType",value:["system"]}]},{name:"priorityChanges",label:"priorityUpdates",type:"showActivityTypes",criteria:[{name:"eventType",value:["priority-change"]},{name:"filterType",value:["system"]}]}]},request:{filter:[{name:"statusChanges",label:"statusUpdates",type:"showActivityTypes",criteria:[{name:"eventType",value:["status-change"]},{name:"filterType",value:["system"]}]},{name:"assignment",label:"assignmentUpdates",type:"showActivityTypes",criteria:[{name:"eventType",value:["assignment-change"]},{name:"filterType",value:["system"]}]},{name:"slaAlerts",label:"slaAlerts",type:"showActivityTypes",criteria:[{name:"eventType",value:["sla-change"]},{name:"filterType",value:["system"]}]}]},asset:{filter:[{name:"locationChanges",label:"locationChanges",type:"showActivityTypes",criteria:[{name:"eventType",value:["region-change"]}]},{name:"ownershipChanges",label:"ownershipChanges",type:"showActivityTypes",criteria:[{name:"eventType",value:["ownership-change"]}]},{name:"privateNote",label:"privateNote",type:"showActivityTypes",criteria:[{name:"access",value:["true"]},{name:"filterType",value:["comment"]}]},{name:"publicNote",label:"publicNote",type:"showActivityTypes",criteria:[{name:"access",value:["false"]},{name:"filterType",value:["comment"]}]},{name:"relationshipChanges",label:"relationshipChanges",type:"showActivityTypes",criteria:[{name:"eventType",value:["related-change","unrelated-change"]},{name:"filterType",value:["system"]}]},{name:"statusChanges",label:"statusUpdates",type:"showActivityTypes",criteria:[{name:"eventType",value:["status-change"]},{name:"filterType",value:["system"]}]},{name:"outages",label:"outages",type:"showActivityTypes",criteria:[{name:"eventType",value:["outage-change"]},{name:"filterType",value:["outage"]}]},{name:"bcmActions",label:"bcmActions",type:"showActivityTypes",criteria:[{name:"eventType",value:["asset-reboot","asset-wakeup","asset-shutdown","asset-ping","asset-audit"]},{name:"filterType",value:["system"]}]}]},person:{filter:[{name:"privateNote",label:"privateNote",type:"showActivityTypes",criteria:[{name:"access",value:["true"]},{name:"filterType",value:["comment"]}]},{name:"publicNote",label:"publicNote",type:"showActivityTypes",criteria:[{name:"access",value:["false"]},{name:"filterType",value:["comment"]}]},{name:"assignment",label:"assignmentUpdates",type:"showActivityTypes",criteria:[{name:"eventType",value:["assignment-change"]},{name:"filterType",value:["system"]}]},{name:"statusChanges",label:"statusUpdates",type:"showActivityTypes",criteria:[{name:"eventType",value:["status-change"]},{name:"filterType",value:["system"]}]},{name:"priorityChanges",label:"priorityUpdates",type:"showActivityTypes",criteria:[{name:"eventType",value:["priority-change"]},{name:"filterType",value:["system"]}]}]},knowledge:{filter:[{name:"assignment",label:"assignmentUpdates",type:"showActivityTypes",criteria:[{name:"eventType",value:["assignment-change"]},{name:"filterType",value:["system"]}]},{name:"statusChanges",label:"statusUpdates",type:"showActivityTypes",criteria:[{name:"eventType",value:["status-change"]},{name:"filterType",value:["system"]}]},{name:"approvalAcceptUpdate",label:"approvalAcceptUpdate",type:"showActivityTypes",criteria:[{name:"eventType",value:["approval-accept-event"]},{name:"filterType",value:["system"]}]},{name:"approvalHoldUpdate",label:"approvalHoldUpdate",type:"showActivityTypes",criteria:[{name:"eventType",value:["approval-hold-event"]},{name:"filterType",value:["system"]}]},{name:"approvalRejectUpdate",label:"approvalRejectUpdate",type:"showActivityTypes",criteria:[{name:"eventType",value:["approval-reject-event"]},{name:"filterType",value:["system"]}]},{name:"flagUnflagChanges",label:"flagUnflagChanges",type:"showActivityTypes",criteria:[{name:"workNoteTypeId",value:["FLAG0001","UNFLAG0001"]},{name:"filterType",value:["comment"]}]},{name:"feedbackComments",label:"feedbackComments",type:"showActivityTypes",criteria:[{name:"workNoteTypeId",value:["1000"]},{name:"filterType",value:["comment"]}]},{name:"versionChanges",label:"versionChanges",type:"showActivityTypes",criteria:[{name:"eventType",value:["knowledge-create"]},{name:"filterType",value:["system"]}]}]},change:{filter:[{name:"privateNote",label:"privateNote",type:"showActivityTypes",criteria:[{name:"access",value:["true"]},{name:"filterType",value:["comment"]}]},{name:"publicNote",label:"publicNote",type:"showActivityTypes",criteria:[{name:"access",value:["false"]},{name:"filterType",value:["comment"]}]},{name:"vendorNote",label:"vendorNote",type:"showActivityTypes",criteria:[{name:"shareWithVendor",value:["true"]},{name:"filterType",value:["comment"]}]},{name:"assignment",label:"assignmentUpdates",type:"showActivityTypes",criteria:[{name:"eventType",value:["assignment-change"]},{name:"filterType",value:["system"]}]},{name:"statusChanges",label:"statusUpdates",type:"showActivityTypes",criteria:[{name:"eventType",value:["status-change"]},{name:"filterType",value:["system"]}]},{name:"slaAlerts",label:"slaAlerts",type:"showActivityTypes",criteria:[{name:"eventType",value:["sla-change"]},{name:"filterType",value:["system"]}]},{name:"taskActivities",label:"taskActivities",type:"showActivityTypes",criteria:[{name:"eventType",value:["task-relation"]},{name:"filterType",value:["system"]}]},{name:"priorityChanges",label:"priorityUpdates",type:"showActivityTypes",criteria:[{name:"eventType",value:["priority-change"]},{name:"filterType",value:["system"]}]}]},problem:{filter:[{name:"privateNote",label:"privateNote",type:"showActivityTypes",criteria:[{name:"access",value:["true"]},{name:"filterType",value:["comment"]}]},{name:"publicNote",label:"publicNote",type:"showActivityTypes",criteria:[{name:"access",value:["false"]},{name:"filterType",value:["comment"]}]},{name:"vendorNote",label:"vendorNote",type:"showActivityTypes",criteria:[{name:"shareWithVendor",value:["true"]},{name:"filterType",value:["comment"]}]},{name:"assignment",label:"assignmentUpdates",type:"showActivityTypes",criteria:[{name:"eventType",value:["assignment-change"]},{name:"filterType",value:["system"]}]},{name:"statusChanges",label:"statusUpdates",type:"showActivityTypes",criteria:[{name:"eventType",value:["status-change"]},{name:"filterType",value:["system"]}]},{name:"taskActivities",label:"taskActivities",type:"showActivityTypes",criteria:[{name:"eventType",value:["task-relation"]},{name:"filterType",value:["system"]}]},{name:"priorityChanges",label:"priorityUpdates",type:"showActivityTypes",criteria:[{name:"eventType",value:["priority-change"]},{name:"filterType",value:["system"]}]}]},knownerror:{filter:[{name:"privateNote",label:"privateNote",type:"showActivityTypes",criteria:[{name:"access",value:["true"]},{name:"filterType",value:["comment"]}]},{name:"publicNote",label:"publicNote",type:"showActivityTypes",criteria:[{name:"access",value:["false"]},{name:"filterType",value:["comment"]}]},{name:"assignment",label:"assignmentUpdates",type:"showActivityTypes",criteria:[{name:"eventType",value:["assignment-change"]},{name:"filterType",value:["system"]}]},{name:"statusChanges",label:"statusUpdates",type:"showActivityTypes",criteria:[{name:"eventType",value:["status-change"]},{name:"filterType",value:["system"]}]},{name:"taskActivities",label:"taskActivities",type:"showActivityTypes",criteria:[{name:"eventType",value:["task-relation"]},{name:"filterType",value:["system"]}]},{name:"priorityChanges",label:"priorityUpdates",type:"showActivityTypes",criteria:[{name:"eventType",value:["priority-change"]},{name:"filterType",value:["system"]}]}]},release:{filter:[{name:"privateNote",label:"privateNote",type:"showActivityTypes",criteria:[{name:"access",value:["true"]},{name:"filterType",value:["comment"]}]},{name:"publicNote",label:"publicNote",type:"showActivityTypes",criteria:[{name:"access",value:["false"]},{name:"filterType",value:["comment"]}]},{name:"assignment",label:"assignmentUpdates",type:"showActivityTypes",criteria:[{name:"eventType",value:["assignment-change"]},{name:"filterType",value:["system"]}]},{name:"statusChanges",label:"statusUpdates",type:"showActivityTypes",criteria:[{name:"eventType",value:["status-change"]},{name:"filterType",value:["system"]}]},{name:"priorityChanges",label:"priorityUpdates",type:"showActivityTypes",criteria:[{name:"eventType",value:["priority-change"]},{name:"filterType",value:["system"]}]}]},activity:{filter:[{name:"privateNote",label:"privateNote",type:"showActivityTypes",criteria:[{name:"access",value:["true"]},{name:"filterType",value:["comment"]}]},{name:"publicNote",label:"publicNote",type:"showActivityTypes",criteria:[{name:"access",value:["false"]},{name:"filterType",value:["comment"]}]},{name:"assignment",label:"assignmentUpdates",type:"showActivityTypes",criteria:[{name:"eventType",value:["assignment-change"]},{name:"filterType",value:["system"]}]},{name:"statusChanges",label:"statusUpdates",type:"showActivityTypes",criteria:[{name:"eventType",value:["status-change"]},{name:"filterType",value:["system"]}]},{name:"taskActivities",label:"taskActivities",type:"showActivityTypes",criteria:[{name:"eventType",value:["task-relation"]},{name:"filterType",value:["system"]}]},{name:"priorityChanges",label:"priorityUpdates",type:"showActivityTypes",criteria:[{name:"eventType",value:["priority-change"]},{name:"filterType",value:["system"]}]}]}}},resource:{filter:[{name:"recommendedDwpTemplates",label:"dwptemplates",selected:!0},{name:"recommendedTemplates",label:"templates",selected:!0},{name:"recommendedKnowledge",label:"knowledge",selected:!0},{name:"recommendedTickets",label:"tickets",selected:!0},{name:"recommendedOutages",label:"outages",selected:!0}]},moreActions:{asset:[{label:"putIntoInventory",method:"putIntoInventory"},{label:"takeOutOfInventory",method:"takeOutOfInventory"}],change:[{label:"initiateimpactanalysis",method:"runImpactAnalysis"}],knowledge:[{label:"performAssessment",method:"startAssessment"}]},link:{incident:[{type:"incident",relations:["duplicateof","originalof","caused","causedby","resolved","resolvedby"]},{type:"workorder",relations:["relatedto"]},{type:"asset",relations:["relatedto","impacts","restores"]},{type:"change",relations:["causedby","correctedby","relatedto"]},{type:"problem",relations:["investigatedby","relatedto","resolvedby"]},{type:"knownerror",relations:["relatedto","resolvedby"]},{type:"release",relations:["relatedto"]}],workorder:[{type:"incident",relations:["relatedto"]},{type:"workorder",relations:["relatedto"]},{type:"asset",relations:["relatedto"]},{type:"change",relations:["relatedto"]},{type:"problem",relations:["relatedto"]},{type:"knownerror",relations:["relatedto"]}],task:[{type:"asset",relations:["relatedto"]}],asset:[{type:"incident",relations:["relatedto","impactedby","restoredby"]},{type:"workorder",relations:["relatedto"]},{type:"change",relations:["changedby","impactedby","installedby","movedby","relatedto","removedby","repairedby","upgradedby"]},{type:"problem",relations:["relatedto","investigatedby","impactedby"]},{type:"knownerror",relations:["relatedto","impactedby"]},{type:"release",relations:["changedby","impactedby","installedby","movedby","relatedto","removedby","repairedby","upgradedby"]}],person:[{type:"person",relations:["usedby","approvedby","createdby","managedby","ownedby","supportedby"]},{type:"peopleType",relations:["people","company","organization","department","supportgroup"]}],knowledge:[{type:"knowledge",relations:["references"]}],change:[{type:"incident",relations:["caused","relatedto","corrects"]},{type:"workorder",relations:["relatedto"]},{type:"asset",
relations:["relatedto","upgrades","repairs","impacts","installs","moves","changes","removes"]},{type:"change",relations:["relatedto","dependent"]},{type:"outage",relations:["relatedto"]},{type:"problem",relations:["relatedto"]},{type:"knownerror",relations:["initiatedby","relatedto"]},{type:"release",relations:["relatedto","memberof"]}],release:[{type:"incident",relations:["caused","relatedto","corrects"]},{type:"asset",relations:["relatedto","upgrades","repairs","impacts","installs","moves","changes","removes"]},{type:"change",relations:["relatedto"]},{type:"outage",relations:["relatedto"]},{type:"problem",relations:["relatedto"]},{type:"knownerror",relations:["initiatedby","relatedto"]},{type:"release",relations:["relatedto"]}],problem:[{type:"incident",relations:["investigates","relatedto","resolved"]},{type:"asset",relations:["impacts","investigates","relatedto"]},{type:"change",relations:["relatedto"]},{type:"outage",relations:["relatedto"]},{type:"problem",relations:["investigatedby","investigates","relatedto"]},{type:"knownerror",relations:["identified","initiates","relatedto"]},{type:"workorder",relations:["relatedto"]},{type:"release",relations:["relatedto"]}],knownerror:[{type:"incident",relations:["relatedto","resolved"]},{type:"asset",relations:["impacts","relatedto"]},{type:"change",relations:["relatedto","initiates"]},{type:"outage",relations:["relatedto"]},{type:"problem",relations:["initiatedby","identifiedby","relatedto"]},{type:"knownerror",relations:["relatedto"]},{type:"workorder",relations:["relatedto"]},{type:"release",relations:["relatedto","initiates"]}]},asset:{filter:[{name:"parent",label:"parent",type:"assetTypes"},{name:"child",label:"child",type:"assetTypes"},{name:"impact",label:"impact",type:"assetTypes"},{name:"incident",label:"incident",type:"ticketTypes"},{name:"workorder",label:"workorder",type:"ticketTypes"},{name:"change",label:"change",type:"ticketTypes"},{name:"release",label:"release",type:"ticketTypes"},{name:"problem",label:"problem",type:"ticketTypes"},{name:"knownerror",label:"knownerror",type:"ticketTypes"},{name:"task",label:"task",type:"ticketTypes"}]},outage:{defaultFilter:{status:["Current Unavailability","Scheduled","Restored"]},filter:[{name:"current-unavailability",label:"current-unavailability",type:"outageStatuses",selected:!0,criteria:{name:"status",value:["Current Unavailability"]}},{name:"scheduled",label:"scheduled",type:"outageStatuses",selected:!0,criteria:{name:"status",value:["Scheduled"]}},{name:"restored",label:"restored",type:"outageStatuses",selected:!0,criteria:{name:"status",value:["Restored"]}}],searchFilter:[{name:"name",label:"ciName",expanded:!0,options:[{name:"relatedCI",label:"allRelatedCIs",type:"constant",criteria:{name:"relatedCI",value:!0},active:!0},{label:"search",type:"search",method:"parentScope.searchCIsByKeyword",typeaheadTemplate:"views/search/search-typeahead-template.html",fields:{key:"name",value:"name"},valueFormat:"value"}]},{name:"scheduledDate",label:"scheduledDate",options:[{name:"changeStartNext24",label:"next24",type:"date",defaultValues:{start:"moment().valueOf()",end:'moment().add(1, "days").valueOf()'},criteria:{name:"scheduledStartDates"}},{name:"changeStartNext48",label:"next48",type:"date",defaultValues:{start:"moment().valueOf()",end:'moment().add(2, "days").valueOf()'},criteria:{name:"scheduledStartDates"}},{name:"changeStartNextWeek",label:"nextWeek",type:"date",defaultValues:{start:"moment().valueOf()",end:'moment().add(7, "days").valueOf()'},criteria:{name:"scheduledStartDates"}},{name:"changeStartCustomRange",label:"customRange",type:"timeStampRange",format:"mediumDate",startDatePicker:{date:new Date},endDatePicker:{date:new Date},criteria:{name:"scheduledStartDates"}}]},{name:"statuses",label:"unavailabilityStatus",options:[]},{name:"types",label:"unavailabilityType",options:[]}]},metadata:{mapping:[{name:"priority",label:"priorities"},{name:"status",label:"statuses"},{name:"statusReason",label:"statuses"},{name:"type",label:"types"},{name:"category",label:"categories"},{name:"resCategory",label:"resCategories"},{name:"impact",label:"impacts"},{name:"urgency",label:"urgencies"},{name:"workinfoType",label:"workinfoTypes"},{name:"primaryCapability",label:"primaryCapabilities"},{name:"systemType",label:"systemType"},{name:"virtualSystemType",label:"virtualSystemType"},{name:"visibility",label:"visibilities"},{name:"timing",label:"timings"},{name:"timingReason",label:"timingReasons"},{name:"changeReason",label:"changeReasons"},{name:"riskLevel",label:"riskLevels"},{name:"investigationDriver",label:"investigationDrivers"},{name:"viewAccess",label:"viewAccesses"},{name:"collisionStatus",label:"collisionStatuses"},{name:"language",label:"languages"},{name:"assetType",label:"assetTypes"},{name:"serviceType",label:"types"},{name:"releaseType",label:"types"},{name:"milestone",label:"milestones"},{name:"businessJustification",label:"businessJustifications"},{name:"reportedSource",label:"reportedSources"},{name:"workOrderType",label:"types"},{name:"taskType",label:"types"}]},ciSearch:{columns:{classId:{field:"assetId",displayName:"classId",visible:!0,order:1,name:"classId"},name:{field:"name",displayName:"name",visible:!0,order:2,name:"name"},type:{field:"type",displayName:"type",visible:!0,order:3,name:"type",cellFilter:'localizeLabel: "assetType":row.entity.ticketType'},productName:{field:"product.name",displayName:"productName",visible:!0,order:4,name:"productName"},status:{field:"status.value",displayName:"status",visible:!0,order:5,name:"status",cellFilter:'localizeLabel: "status":row.entity.ticketType'},serialNumber:{field:"serialNumber",displayName:"serialNumber",visible:!0,order:6,name:"serialNumber"},site:{field:"site.name",displayName:"site",visible:!0,order:7,name:"site"},related:{field:"linked",displayName:"related",visible:!0,order:8,name:"related"}},assetConsoleFilter:[{name:"custom",label:"savedCISearches",options:[]},{name:"assetTypes",label:"ciType",options:[]},{name:"approvedBy",label:"approvedBy",showLabelInPill:!0,searchModes:[{id:0,method:"personModel.getListOfPersonsByText",name:"common.labels.people",fields:{key:"fullName",value:"personId"}},{id:1,method:"searchModel.getListOfSupportGroupsByText",name:"common.labels.supportGroup",fields:{key:"name",value:"id"}},{id:2,method:"searchModel.getOrganizationsByText",name:"common.label.organization",fields:{key:"name",value:"attributeMap.id"}}],selectedSearchMode:{id:0,method:"personModel.getListOfPersonsByText",name:"common.labels.people",fields:{key:"fullName",value:"personId"}},options:[{name:"me",label:"me",type:"constant",criteria:{name:"approvedBy"}},{label:"searchApprover",type:"search",method:"personModel.getListOfPersonsByText",typeaheadTemplate:"views/console/search-person-typeahead-template.html",fields:{key:"fullName",value:"personId"},valueFormat:"{id: value}"}]},{name:"assetSubTypes",label:"assetSubType",showLabelInPill:!0,options:[]},{name:"companies",label:"company",showLabelInPill:!0,options:[{label:"searchCompany",type:"search",method:"searchModel.getListOfCompaniesByText",typeaheadTemplate:"views/console/general-typeahead-template.html",fields:{key:"name",value:"name"},valueFormat:"{name: value}"}]},{name:"cpu",label:"cpuCount",assetType:["Computer System"],showLabelInPill:!0,options:[{label:"cpuCountRange",type:"range",subtype:"range",criteria:{name:"cpu",value:[{min:1,max:1}]}}]},{name:"createdBy",label:"createdBy",showLabelInPill:!0,searchModes:[{id:0,method:"personModel.getListOfPersonsByText",name:"common.labels.people",fields:{key:"fullName",value:"personId"}},{id:1,method:"searchModel.getListOfSupportGroupsByText",name:"common.labels.supportGroup",fields:{key:"name",value:"id"}},{id:2,method:"searchModel.getOrganizationsByText",name:"common.label.organization",fields:{key:"name",value:"attributeMap.id"}}],selectedSearchMode:{id:0,method:"personModel.getListOfPersonsByText",name:"common.labels.people",fields:{key:"fullName",value:"personId"}},options:[{name:"me",label:"me",type:"constant",criteria:{name:"createdBy"}},{label:"searchCreator",type:"search",method:"personModel.getListOfPersonsByText",typeaheadTemplate:"views/console/search-person-typeahead-template.html",fields:{key:"fullName",value:"personId"},valueFormat:"{id: value}"}]},{name:"floor",label:"floor",showLabelInPill:!0,options:[{label:"searchFloor",type:"search",subtype:"keyword"}]},{name:"managedBy",label:"managedBy",showLabelInPill:!0,searchModes:[{id:0,method:"personModel.getListOfPersonsByText",name:"common.labels.people",fields:{key:"fullName",value:"personId"}},{id:1,method:"searchModel.getListOfSupportGroupsByText",name:"common.labels.supportGroup",fields:{key:"name",value:"id"}},{id:2,method:"searchModel.getOrganizationsByText",name:"common.label.organization",fields:{key:"name",value:"attributeMap.id"}}],selectedSearchMode:{id:0,method:"personModel.getListOfPersonsByText",name:"common.labels.people",fields:{key:"fullName",value:"personId"}},options:[{name:"me",label:"me",type:"constant",criteria:{name:"managedBy"}},{label:"searchManager",type:"search",method:"personModel.getListOfPersonsByText",typeaheadTemplate:"views/console/search-person-typeahead-template.html",fields:{key:"fullName",value:"personId"},valueFormat:"{id: value}"}]},{name:"manufacturer",label:"manufacturer",showLabelInPill:!0,options:[{label:"searchManufacturer",type:"search",method:"searchModel.getFoundationManufacturersByText",typeaheadTemplate:"views/search/search-typeahead-template.html",fields:{key:"name",value:"name"},valueFormat:"value"}]},{name:"model",label:"model",showLabelInPill:!0,options:[{label:"searchModel",type:"search",subtype:"keyword"}]},{name:"operatingSystem",label:"operatingSystem",showLabelInPill:!0,assetType:["Computer System"],options:[{label:"operatingSystem",type:"range",subtype:"range",criteria:{name:"operatingSystem"},criteriaKeys:[{name:"manufacturer",label:"console.filter.name.manufacturer",method:"searchModel.getFoundationManufacturersByText",valueFormat:"value",fields:{key:"name",value:"name"},operators:[{name:"console.filter.optionName.is",id:1}],selectedOperator:{name:"console.filter.optionName.is",id:1},typeaheadTemplate:"views/search/search-typeahead-template.html",type:"search"},{name:"productName",label:"console.column.productName",method:"parentScope.getProductNamesByCompany",valueFormat:"{categorizations: categorizations}",fields:{key:"value",value:""},operators:[{name:"console.filter.optionName.is",id:1}],selectedOperator:{name:"console.filter.optionName.is",id:1},typeaheadTemplate:"views/search/search-typeahead-template.html",type:"search",menuPositionShift:!0},{name:"version",label:"console.column.version",placeholder:"console.filter.optionName.version",operators:[{name:"console.filter.optionName.is",id:1},{name:"console.filter.optionName.isnot",id:6},{name:"console.filter.optionName.like",id:7}],selectedOperator:{name:"console.filter.optionName.is",id:1},type:"keyword"}]}]},{name:"owners",label:"owner",showLabelInPill:!0,searchModes:[{id:0,method:"personModel.getListOfPersonsByText",name:"common.labels.people",fields:{key:"fullName",value:"personId"}},{id:1,method:"searchModel.getListOfSupportGroupsByText",name:"common.labels.supportGroup",fields:{key:"name",value:"id"}},{id:2,method:"searchModel.getOrganizationsByText",name:"common.label.organization",fields:{key:"name",value:"attributeMap.id"}}],selectedSearchMode:{id:0,method:"personModel.getListOfPersonsByText",name:"common.labels.people",fields:{key:"fullName",value:"personId"}},options:[{name:"me",label:"me",type:"constant",criteria:{name:"owners"}},{label:"searchOwner",type:"search",method:"personModel.getListOfPersonsByText",typeaheadTemplate:"views/console/search-person-typeahead-template.html",fields:{key:"fullName",value:"personId"},valueFormat:"{id: value}"}]},{name:"processor",label:"processor",showLabelInPill:!0,assetType:["Computer System"],options:[{label:"processor",type:"range",subtype:"range",criteria:{name:"processor"},criteriaKeys:[{name:"manufacturer",label:"console.filter.name.manufacturer",method:"searchModel.getFoundationManufacturersByText",valueFormat:"value",fields:{key:"name",value:"name"},operators:[{name:"console.filter.optionName.is",id:1}],selectedOperator:{name:"console.filter.optionName.is",id:1},typeaheadTemplate:"views/search/search-typeahead-template.html",type:"search"},{name:"productName",label:"console.column.productName",method:"parentScope.getProductNamesByCompany",valueFormat:"{categorizations: categorizations}",fields:{key:"value",value:""},operators:[{name:"console.filter.optionName.is",id:1}],selectedOperator:{name:"console.filter.optionName.is",id:1},typeaheadTemplate:"views/search/search-typeahead-template.html",type:"search",menuPositionShift:!0},{name:"speed",label:"console.column.speed",placeholder:"console.filter.optionName.speed",operators:[{name:"=",id:1},{name:">=",id:3},{name:"<=",id:5}],selectedOperator:{name:"=",id:1},type:"keyword",valueIsNumber:!0}]}]},{name:"products",label:"product",showLabelInPill:!0,options:[{label:"searchProducts",type:"search",method:"parentScope.getProductCategoriesByCompany",typeaheadTemplate:"views/search/search-typeahead-template.html",fields:{key:"value",value:""},valueFormat:"{categorizations: categorizations}"}]},{name:"region",label:"region",showLabelInPill:!0,options:[{label:"myRegion",name:"myRegion",type:"constant",criteria:{name:"region"}},{label:"searchRegion",type:"search",method:"searchModel.getFoundationRegionsByText",typeaheadTemplate:"views/search/search-typeahead-template.html",fields:{key:"name",value:"name"},valueFormat:"{region: value, companyName: companyName}"}]},{name:"room",label:"room",showLabelInPill:!0,options:[{label:"searchRoom",type:"search",subtype:"keyword"}]},{name:"siteGroup",label:"siteGroup",showLabelInPill:!0,options:[{label:"mySiteGroup",name:"mySiteGroup",type:"constant",criteria:{name:"siteGroup"}},{label:"searchSiteGroup",type:"search",method:"searchModel.getFoundationSiteGroupsByText",typeaheadTemplate:"views/search/search-typeahead-template.html",fields:{key:"name",value:"name"},valueFormat:"{siteGroup: value, region: regionName, companyName: companyName}"}]},{name:"sites",label:"site",showLabelInPill:!0,options:[{label:"mySite",name:"mySite",type:"constant",criteria:{name:"sites"}},{label:"searchSite",type:"search",method:"searchModel.getFoundationSitesByText",typeaheadTemplate:"views/console/site-typeahead-template.html",fields:{key:"name",value:"name"},valueFormat:"{name: value, siteGroup: siteGroupName, region: regionName, companyName: companyName}"}]},{name:"rack",label:"rack",showLabelInPill:!0,assetType:["Computer System"],options:[{label:"searchRack",type:"search",subtype:"keyword"}]},{name:"ticketSpecificStatuses",label:"statuses",options:[]},{name:"supportedBy",label:"supportedBy",showLabelInPill:!0,searchModes:[{id:0,method:"personModel.getListOfPersonsByText",name:"common.labels.people",fields:{key:"fullName",value:"personId"}},{id:1,method:"searchModel.getListOfSupportGroupsByText",name:"common.labels.supportGroup",fields:{key:"name",value:"id"}},{id:2,method:"searchModel.getOrganizationsByText",name:"common.label.organization",fields:{key:"name",value:"attributeMap.id"}}],selectedSearchMode:{id:0,method:"personModel.getListOfPersonsByText",name:"common.labels.people",fields:{key:"fullName",value:"personId"}},options:[{name:"me",label:"me",type:"constant",criteria:{name:"supportedBy"}},{label:"searchSupporter",type:"search",method:"personModel.getListOfPersonsByText",typeaheadTemplate:"views/console/search-person-typeahead-template.html",fields:{key:"fullName",value:"personId"},valueFormat:"{id: value}"}]},{name:"usedBy",label:"usedBy",showLabelInPill:!0,searchModes:[{id:0,method:"personModel.getListOfPersonsByText",name:"common.labels.people",fields:{key:"fullName",value:"personId"}},{id:1,method:"searchModel.getListOfSupportGroupsByText",name:"common.labels.supportGroup",fields:{key:"name",value:"id"}},{id:2,method:"searchModel.getOrganizationsByText",name:"common.label.organization",fields:{key:"name",value:"attributeMap.id"}}],selectedSearchMode:{id:0,method:"personModel.getListOfPersonsByText",name:"common.labels.people",fields:{key:"fullName",value:"personId"}},options:[{name:"me",label:"me",type:"constant",criteria:{name:"usedBy"}},{label:"searchUser",type:"search",method:"personModel.getListOfPersonsByText",typeaheadTemplate:"views/console/search-person-typeahead-template.html",fields:{key:"fullName",value:"personId"},valueFormat:"{id: value}"}]},{name:"supplier",label:"supplier",showLabelInPill:!0,options:[{label:"searchSupplier",type:"search",method:"searchModel.getFoundationSuppliersByText",typeaheadTemplate:"views/search/search-typeahead-template.html",fields:{key:"name",value:"name"},valueFormat:"value"}]}],assetGraphExplorerFilter:a,assetListExplorerFilter:n,filter:[{name:"custom",label:"savedCISearches",options:[]},{name:"assetTypes",label:"ciType",options:[]},{name:"companies",label:"searchCompanies",options:[{label:"searchCompanies",type:"search",method:"searchModel.getListOfCompaniesByText",typeaheadTemplate:"views/console/general-typeahead-template.html",fields:{key:"name",value:"name"},valueFormat:"{name: value}"}]},{name:"owners",label:"owner",options:[{label:"searchOwners",type:"search",method:"personModel.getListOfPersonNamesByText",typeaheadTemplate:"views/search/search-typeahead-template.html",fields:{key:"fullName",value:"loginId"},valueFormat:"{loginId: value}"}]},{name:"products",label:"product",options:[{label:"searchProducts",type:"search",method:"parentScope.getProductCategoriesByCompany",typeaheadTemplate:"views/search/search-typeahead-template.html",fields:{key:"value",value:""},valueFormat:"{categorizations: categorizations}"}]},{name:"region",label:"region",options:[{label:"myRegion",name:"myRegion",type:"constant",criteria:{name:"region"}},{label:"searchRegion",type:"search",method:"searchModel.getFoundationRegionsByText",typeaheadTemplate:"views/search/search-typeahead-template.html",fields:{key:"name",value:"name"},valueFormat:"{region: value, companyName: companyName}"}]},{name:"siteGroup",label:"siteGroup",options:[{label:"mySiteGroup",name:"mySiteGroup",type:"constant",criteria:{name:"siteGroup"}},{label:"searchSiteGroup",type:"search",method:"searchModel.getFoundationSiteGroupsByText",typeaheadTemplate:"views/search/search-typeahead-template.html",fields:{key:"name",value:"name"},valueFormat:"{siteGroup: value, region: regionName, companyName: companyName}"}]},{name:"sites",label:"site",options:[{label:"mySite",name:"mySite",type:"constant",criteria:{name:"sites"}},{label:"searchSite",type:"search",method:"searchModel.getFoundationSitesByText",typeaheadTemplate:"views/search/search-typeahead-template.html",fields:{key:"name",value:"name"},valueFormat:"{name: value, siteGroup: siteGroupName, region: regionName, companyName: companyName}"}]},{name:"ticketSpecificStatuses",label:"statuses",options:[]}],createOutageFilter:[{name:"assetTypes",label:"ciType",options:[]},{name:"products",label:"product",options:[{label:"searchProducts",type:"search",method:"parentScope.getProductCategoriesByCompany",fields:{key:"value",value:""},valueFormat:"{categorizations: categorizations}"}]},{name:"sites",label:"site",options:[{label:"mySite",name:"mySite",type:"constant",criteria:{name:"sites"}},{label:"searchSite",type:"search",method:"searchModel.getFoundationSitesByText",fields:{key:"name",value:"name"},valueFormat:"{name: value, siteGroup: siteGroupName, region: regionName, companyName: companyName}"}]},{name:"statuses",label:"statuses",options:[]}]},foundation:{company:{},site:{label:"site",fdFields:{company:{label:"company",name:"company",searchOptionName:"companyName",connected:null,visible:!0,required:!1,index:0},region:{label:"region",name:"region",searchOptionName:"regionName",connected:null,visible:!0,required:!1,index:1},siteGroup:{label:"siteGroup",name:"siteGroup",searchOptionName:"siteGroupName",connected:null,visible:!0,required:!1,index:2},site:{label:"site",name:"site",searchOptionName:"site",connected:null,visible:!0,required:!1,index:3}}},organization:{label:"organization",fdFields:{company:{label:"company",name:"company",searchOptionName:"companyName",connected:null,visible:!0,required:!1,index:0},organization:{label:"organization",name:"organization",searchOptionName:"organizationName",connected:null,visible:!0,required:!1,index:1},department:{label:"department",name:"department",searchOptionName:"department",connected:null,visible:!0,required:!1,index:2}}}},change:{dashboardStats:[{name:"mytickets",label:"my",filterSetup:[{filter:"assignees",option:"me"}]},{name:"Critical",label:"critical",filterSetup:[{filter:"priorities",option:"critical"}]},{name:"new",label:"new",filterSetup:[{filter:"createDateRanges",option:"createDatePast24"}]},{name:"open",label:"open",filterSetup:[{filter:"statuses",option:"allOpen"}]},{name:"total",label:"all"}],collisionFilter:[{name:"affectedBusinessServices",label:"affectedService",options:[{label:"search",type:"search",method:"searchModel.searchBusinessServiceByKeyword",typeaheadTemplate:"views/search/search-typeahead-template.html",fields:{key:"name",value:"reconciliationId"},valueFormat:"{reconciliationId: value}"}]},{name:"products",label:"product",options:[{label:"searchProducts",type:"search",method:"parentScope.getProductCategoriesByCompany",typeaheadTemplate:"views/search/search-typeahead-template.html",fields:{key:"value",value:""},valueFormat:"{categorizations: categorizations}"}]},{name:"organizations",label:"organization",options:[{label:"searchOrganization",type:"search",method:"searchModel.getOrganizationsByText",typeaheadTemplate:"views/console/general-typeahead-template.html",fields:{key:"name",value:"name"},valueFormat:"value"}]},{name:"companies",label:"searchCompanies",options:[{label:"searchCompanies",type:"search",method:"searchModel.getListOfCompaniesByText",typeaheadTemplate:"views/console/general-typeahead-template.html",fields:{key:"name",value:"name"},valueFormat:"{name: value}"}]},{name:"assignees",label:"changeCoordinator",showLabelInPill:!0,options:[{label:"searchAssignee",type:"search",method:"personModel.getListOfChangeCoordinatorByText",typeaheadTemplate:"views/console/search-person-typeahead-template.html",fields:{key:"fullName",value:"loginId"},valueFormat:"{loginId: value}"}]},{name:"assignedSupportGroups",label:"changeCoordinatorGroup",showLabelInPill:!0,options:[{label:"searchAssigneeGroup",type:"search",method:"searchModel.getChangeCoordinatorGroupsByText",typeaheadTemplate:"views/console/support-group-typeahead-template.html",fields:{key:"name",value:"name"},valueFormat:"{name: value}"}]},{name:"changeManager",label:"changeManager",showLabelInPill:!0,options:[{label:"searchAssignee",type:"search",method:"personModel.getListOfChangeManagerByText",typeaheadTemplate:"views/console/search-person-typeahead-template.html",fields:{key:"fullName",value:"loginId"},valueFormat:"{loginId: value}"}]},{name:"changeManagerGroup",label:"changeManagerGroup",showLabelInPill:!0,options:[{label:"searchAssigneeGroup",type:"search",method:"searchModel.getChangeManagerGroupsByText",typeaheadTemplate:"views/console/support-group-typeahead-template.html",fields:{key:"name",value:"name"},valueFormat:"{name: value}"}]},{name:"ticketSpecificStatuses",label:"statuses",options:[]},{name:"priorities",label:"priority",options:[]}]},requiredFields:{change:{Emergency:{Draft:[],"Request For Authorization":[],"Request For Change":[],"Planning In Progress":["managerGroup"],"Scheduled For Review":["scheduledStartDate","scheduledEndDate","managerGroup","manager"],"Scheduled For Approval":["scheduledStartDate","scheduledEndDate","managerGroup","manager"],Scheduled:["scheduledStartDate","scheduledEndDate","managerGroup","manager"],"Implementation In Progress":["scheduledStartDate","scheduledEndDate","managerGroup"],Pending:["statusReason"],Rejected:[],Completed:["scheduledStartDate","scheduledEndDate","actualStartDate","actualEndDate","managerGroup"],Closed:["scheduledStartDate","scheduledEndDate","actualStartDate","actualEndDate","managerGroup","statusReason"],Cancelled:[]},Expedited:{Draft:["timingReason"],"Request For Authorization":[],"Request For Change":[],"Planning In Progress":["managerGroup"],"Scheduled For Review":["scheduledStartDate","scheduledEndDate","managerGroup","manager"],"Scheduled For Approval":["scheduledStartDate","scheduledEndDate","managerGroup","manager"],Scheduled:["scheduledStartDate","scheduledEndDate","managerGroup","manager"],"Implementation In Progress":["scheduledStartDate","scheduledEndDate","managerGroup"],Pending:["statusReason"],Rejected:[],Completed:["scheduledStartDate","scheduledEndDate","actualStartDate","actualEndDate","managerGroup"],Closed:["scheduledStartDate","scheduledEndDate","actualStartDate","actualEndDate","managerGroup","statusReason"],Cancelled:[]},Latent:{Draft:["actualStartDate","actualEndDate"],"Request For Authorization":["actualStartDate","actualEndDate"],"Request For Change":["actualStartDate","actualEndDate"],"Planning In Progress":["actualStartDate","actualEndDate","managerGroup"],"Scheduled For Review":["actualStartDate","actualEndDate","managerGroup","manager"],"Scheduled For Approval":["actualStartDate","actualEndDate","managerGroup","manager"],Scheduled:["actualStartDate","actualEndDate","managerGroup","manager"],"Implementation In Progress":["actualStartDate","actualEndDate","managerGroup"],Pending:["statusReason"],Rejected:[],Completed:["actualStartDate","actualEndDate","managerGroup"],Closed:["actualStartDate","actualEndDate","managerGroup","statusReason"],Cancelled:[]},Normal:{Draft:[],"Request For Authorization":[],"Request For Change":[],"Planning In Progress":["managerGroup"],"Scheduled For Review":["scheduledStartDate","scheduledEndDate","managerGroup","manager"],"Scheduled For Approval":["scheduledStartDate","scheduledEndDate","managerGroup","manager"],Scheduled:["scheduledStartDate","scheduledEndDate","managerGroup","manager"],"Implementation In Progress":["scheduledStartDate","scheduledEndDate","managerGroup"],Pending:["statusReason"],Rejected:[],Completed:["scheduledStartDate","scheduledEndDate","actualStartDate","actualEndDate","managerGroup"],Closed:["scheduledStartDate","scheduledEndDate","actualStartDate","actualEndDate","managerGroup","statusReason"],Cancelled:[]},"No Impact":{Draft:[],"Request For Authorization":[],"Request For Change":["scheduledStartDate","scheduledEndDate"],"Planning In Progress":["scheduledStartDate","scheduledEndDate","managerGroup"],"Scheduled For Review":["scheduledStartDate","scheduledEndDate","managerGroup","manager"],"Scheduled For Approval":["scheduledStartDate","scheduledEndDate","managerGroup","manager"],Scheduled:["scheduledStartDate","scheduledEndDate","managerGroup","manager"],"Implementation In Progress":["scheduledStartDate","scheduledEndDate","managerGroup"],Pending:["statusReason"],Rejected:[],Completed:["scheduledStartDate","scheduledEndDate","actualStartDate","actualEndDate","managerGroup"],Closed:["scheduledStartDate","scheduledEndDate","actualStartDate","actualEndDate","managerGroup","statusReason"],Cancelled:[]},Standard:{Draft:[],"Request For Authorization":[],"Request For Change":[],"Planning In Progress":["managerGroup"],"Scheduled For Review":["scheduledStartDate","scheduledEndDate","managerGroup","manager"],"Scheduled For Approval":["scheduledStartDate","scheduledEndDate","managerGroup","manager"],Scheduled:["scheduledStartDate","scheduledEndDate","managerGroup","manager"],"Implementation In Progress":["scheduledStartDate","scheduledEndDate","managerGroup"],Pending:["statusReason"],Rejected:[],Completed:["scheduledStartDate","scheduledEndDate","actualStartDate","actualEndDate","managerGroup"],Closed:["scheduledStartDate","scheduledEndDate","actualStartDate","actualEndDate","managerGroup","statusReason"],Cancelled:[]}},problem:{Draft:[],"Under Review":["targetDate"],Assigned:["coordinator","targetDate","supportGroup"],"Under Investigation":["coordinator","targetDate","assignee"],Pending:["statusReason"],Completed:["coordinator","targetDate","assignee","statusReason"],Closed:["coordinator","targetDate","assignee"],Cancelled:["coordinator","supportGroup"]},incident:{New:[],Assigned:[],"In Progress":[],Pending:["statusReason"],Resolved:["statusReason"]},task:{Closed:["statusReason"]},release:{Pending:["statusReason"]}},disabledFields:{change:{Emergency:{Draft:["targetDate"],"Request For Authorization":["targetDate"],"Request For Change":["targetDate"],"Planning In Progress":["targetDate"],"Scheduled For Review":["targetDate"],"Scheduled For Approval":["targetDate"],Scheduled:["targetDate"],"Implementation In Progress":["targetDate"],Pending:["targetDate"],Rejected:["targetDate"],Completed:["targetDate"],Closed:["targetDate"],Cancelled:["targetDate"]},Latent:{Draft:["scheduledStartDate","scheduledEndDate","targetDate"],"Request For Authorization":["scheduledStartDate","scheduledEndDate","targetDate"],"Request For Change":["scheduledStartDate","scheduledEndDate","targetDate"],"Planning In Progress":["scheduledStartDate","scheduledEndDate","targetDate"],"Scheduled For Review":["scheduledStartDate","scheduledEndDate","targetDate"],"Scheduled For Approval":["scheduledStartDate","scheduledEndDate","targetDate"],Scheduled:["scheduledStartDate","scheduledEndDate","targetDate"],"Implementation In Progress":["scheduledStartDate","scheduledEndDate","targetDate"],Pending:["scheduledStartDate","scheduledEndDate","targetDate"],Rejected:["scheduledStartDate","scheduledEndDate","targetDate"],Completed:["scheduledStartDate","scheduledEndDate","targetDate"],Closed:["scheduledStartDate","scheduledEndDate","targetDate"],Cancelled:[]},"No Impact":{Draft:["targetDate"],"Request For Authorization":["targetDate"],"Request For Change":["targetDate"],"Planning In Progress":["targetDate"],"Scheduled For Review":["targetDate"],"Scheduled For Approval":["targetDate"],Scheduled:["targetDate"],"Implementation In Progress":["targetDate"],Pending:["targetDate"],Rejected:["targetDate"],Completed:["targetDate"],Closed:["targetDate"],Cancelled:["targetDate"]}}},ootbFieldValueMap:{incident:{templateId:{fieldName:"incidentTemplate",path:"templateId"},templateName:{fieldName:"incidentTemplate",path:"templateName"},priority:{fieldName:"priority",path:"priority.name"},impact:{fieldName:"priority",path:"impact.name"},urgency:{fieldName:"priority",path:"urgency.name"},locationCompany:{fieldName:"locationCompany",path:"locationCompany"},organization:{fieldName:"organization",path:"organization"},firstName:{fieldName:"customer",path:"firstName"},customerPersonId:{fieldName:"customer",path:"personId"},customerCompany:{fieldName:"customer",path:"company.name"},customerLoginId:{fieldName:"customer",path:"loginId"},lastName:{fieldName:"customer",path:"lastName"},customerVIPFlag:{fieldName:"customer",path:"isVIP"},internetEmail:{fieldName:"customerEmail",path:"internetEmail"},phoneNumber:{fieldName:"customerPhone",path:"phoneNumber"},contactCountry:{fieldName:"contact",path:"site.address.country"},contactEmail:{fieldName:"contactEmail",path:"contactEmail"},contactSite:{fieldName:"contact",path:"site.name"},contactLoginId:{fieldName:"contact",path:"loginId"},contactCity:{fieldName:"contact",path:"site.address.city"},contactLastName:{fieldName:"contact",path:"lastName"},contactPhoneNumber:{fieldName:"contactPhone",path:"contactPhoneNumber"},contactSiteGroup:{fieldName:"contact",path:"site.siteGroup"},contactCompany:{fieldName:"contact",path:"company.name"},contactFirstName:{fieldName:"contact",path:"firstName"},contactStreet:{fieldName:"contact",path:"site.address.street"},contactPersonId:{fieldName:"contact",path:"personId"},contactZip:{fieldName:"contact",path:"site.address.zip"},contactState:{fieldName:"contact",path:"site.address.state"},contactOrganization:{fieldName:"contact",path:"organization"},contactRegion:{fieldName:"contact",path:"site.region"},siteGroup:{fieldName:"site",
path:"siteGroup.name"},region:{fieldName:"site",path:"region.name"},site:{fieldName:"site",path:"site.name"},country:{fieldName:"site",path:"attributeMap.siteAddress.country"},state:{fieldName:"site",path:"attributeMap.siteAddress.state"},city:{fieldName:"site",path:"attributeMap.siteAddress.city"},zipPostalCode:{fieldName:"site",path:"attributeMap.siteAddress.zip"},street:{fieldName:"site",path:"attributeMap.siteAddress.street"},serviceCIReconId:{fieldName:"impactedService",path:"ci.reconciliationId"},impactedService:{fieldName:"impactedService",path:"ci.name"},CI_reconid:{fieldName:"causalCI",path:"ci.reconciliationId"},CI_reconciliationId:{fieldName:"causalCI",path:"ci.reconciliationId"},causalCI:{fieldName:"causalCI",path:"ci.name"},affectedCIClassId:{fieldName:"causalCI",path:"ci.classId"},serviceType:{fieldName:"serviceType",path:"serviceType"},assignee:{fieldName:"assignee",path:"fullName"},assigneeLoginId:{fieldName:"assignee",path:"loginId"},assigneeComp:{fieldName:"assignee",path:"company.name"},assigneeOrg:{fieldName:"assignee",path:"organization"},supportGroups:{fieldName:"assigneeSupportGroups",path:"supportGroups"},assignedGroup:{fieldName:"assigneeSupportGroups",path:"id"},assignedSupportCompany:{fieldName:"assigneeSupportGroups",path:"company.name"},assignedSupportOrganization:{fieldName:"assigneeSupportGroups",path:"organization"},desc:{fieldName:"desc",path:"desc"},status:{fieldName:"status",path:"value"},statusReason:{fieldName:"status",path:"reason"}},change:{priority:{fieldName:"priority",path:"priority.name"},impact:{fieldName:"priority",path:"impact.name"},urgency:{fieldName:"priority",path:"urgency.name"},locationCompany:{fieldName:"locationCompany",path:"locationCompany"},organization:{fieldName:"organization",path:"organization"},serviceCIReconId:{fieldName:"impactedService",path:"ci.reconciliationId"},impactedService:{fieldName:"impactedService",path:"ci.name"},CI_reconid:{fieldName:"causalCI",path:"ci.reconciliationId"},causalCI:{fieldName:"causalCI",path:"ci.name"},affectedCIClassId:{fieldName:"causalCI",path:"ci.classId"},serviceType:{fieldName:"serviceType",path:"serviceType"},desc:{fieldName:"desc",path:"desc"},status:{fieldName:"status",path:"value"},statusReason:{fieldName:"status",path:"reason"},timing:{fieldName:"changeClass",path:"timing"},timingReason:{fieldName:"changeClass",path:"timingReason"},siteRegion:{fieldName:"changeLocation",path:"region"},siteGroup:{fieldName:"changeLocation",path:"siteGroup"},siteName:{fieldName:"changeLocation",path:"name"},siteId:{fieldName:"changeLocation",path:"siteId"},assigneeName:{fieldName:"changeCoordinator",path:"fullName"},assigneeLoginId:{fieldName:"changeCoordinator",path:"loginId"},assigneeCompany:{fieldName:"changeCoordinator",path:"company.name"},assigneeOrganization:{fieldName:"changeCoordinator",path:"organization"},assigneeGroup:{fieldName:"changeCoordinatorSupportGroups",path:"name"},assigneeGroupId:{fieldName:"changeCoordinatorSupportGroups",path:"id"},managerName:{fieldName:"changeManager",path:"fullName"},managerLoginId:{fieldName:"changeManager",path:"loginId"},managerGroup:{fieldName:"changeManagerSupportGroups",path:"name"},managerGroupId:{fieldName:"changeManagerSupportGroups",path:"id"},managerCompany:{fieldName:"changeManagerSupportGroups",path:"company.name"},riskLevel:{fieldName:"changeRisk",path:"riskLevel"},scheduledStartDate:{fieldName:"scheduledDates",path:"scheduledStartDate"},scheduledEndDate:{fieldName:"scheduledDates",path:"scheduledEndDate"},actualStartDate:{fieldName:"actualDates",path:"actualStartDate"},actualEndDate:{fieldName:"actualDates",path:"actualEndDate"},targetDate:{fieldName:"targetDate",path:"targetDate"},customerFirstName:{fieldName:"requestedFor",path:"firstName"},customerLastName:{fieldName:"requestedFor",path:"lastName"},customerDepartment:{fieldName:"requestedFor",path:"department"},customerEmail:{fieldName:"customerEmail",path:"customerEmail"},customerPhone:{fieldName:"customerPhone",path:"customerPhone"}},workorder:{templateId:{fieldName:"workorderTemplate",path:"templateId"},templateName:{fieldName:"workorderTemplate",path:"templateName"},priority:{fieldName:"priority",path:"priority.name"},locationCompany:{fieldName:"locationCompany",path:"locationCompany"},organization:{fieldName:"organization",path:"organization"},customerFirstName:{fieldName:"customer",path:"firstName"},customerPersonId:{fieldName:"customer",path:"personId"},customerLoginId:{fieldName:"customer",path:"loginId"},customerLastName:{fieldName:"customer",path:"lastName"},customerCompany:{fieldName:"customer",path:"company.name"},customerVIPFlag:{fieldName:"customer",path:"isVIP"},customerInternetEmail:{fieldName:"customerEmail",path:"customerInternetEmail"},customerPhone:{fieldName:"customerPhone",path:"customerPhone"},contactInternetEmail:{fieldName:"contactEmail",path:"contactInternetEmail"},contactLoginId:{fieldName:"contact",path:"loginId"},contactLastName:{fieldName:"contact",path:"lastName"},contactPhone:{fieldName:"contactPhone",path:"contactPhone"},contactCompany:{fieldName:"contact",path:"company.name"},contactFirstName:{fieldName:"contact",path:"firstName"},contactPersonId:{fieldName:"contact",path:"personId"},contactOrg:{fieldName:"contact",path:"organization"},locationSiteGroup:{fieldName:"site",path:"siteGroup.name"},locationRegion:{fieldName:"site",path:"region.name"},locationSite:{fieldName:"site",path:"site.name"},serviceCIReconId:{fieldName:"impactedService",path:"ci.reconciliationId"},impactedService:{fieldName:"impactedService",path:"ci.name"},assigneeName:{fieldName:"assignee",path:"fullName"},assigneeLoginId:{fieldName:"assignee",path:"loginId"},assigneeCompany:{fieldName:"assignee",path:"company.name"},assigneeOrg:{fieldName:"assignee",path:"organization"},assigneeGroup:{fieldName:"assigneeSupportGroups",path:"supportGroups"},assigneeGroupId:{fieldName:"assigneeSupportGroups",path:"id"},managerName:{fieldName:"requestManager",path:"fullName"},managerLoginId:{fieldName:"requestManager",path:"loginId"},managerCompany:{fieldName:"requestManager",path:"company.name"},managerGroupId:{fieldName:"requestManagerSupportGroups",path:"id"},managerGroup:{fieldName:"requestManagerSupportGroups",path:"supportGroups"},desc:{fieldName:"desc",path:"desc"},status:{fieldName:"status",path:"value"},statusReason:{fieldName:"status",path:"reason"},scheduledStartDate:{fieldName:"scheduledDates",path:"scheduledStartDate"},scheduledEndDate:{fieldName:"scheduledDates",path:"scheduledEndDate"},actualStartDate:{fieldName:"actualDates",path:"actualStartDate"},actualEndDate:{fieldName:"actualDates",path:"actualEndDate"}},task:{templateId:{fieldName:"taskTemplate",path:"templateId"},templateName:{fieldName:"taskTemplate",path:"templateName"},priority:{fieldName:"priority",path:"priority.name"},assigneeName:{fieldName:"assignee",path:"fullName"},assigneeLoginId:{fieldName:"assignee",path:"loginId"},assigneeCompany:{fieldName:"assignee",path:"company.name"},assigneeOrg:{fieldName:"assignee",path:"organization"},assigneeGroup:{fieldName:"assigneeSupportGroups",path:"supportGroups"},assigneeGroupId:{fieldName:"assigneeSupportGroups",path:"id"},desc:{fieldName:"desc",path:"desc"},taskStatus:{fieldName:"status",path:"value"},taskStatusReason:{fieldName:"status",path:"reason"},scheduledStartDate:{fieldName:"scheduledDates",path:"scheduledStartDate"},scheduledEndDate:{fieldName:"scheduledDates",path:"scheduledEndDate"},actualStartDate:{fieldName:"actualDates",path:"actualStartDate"},actualEndDate:{fieldName:"actualDates",path:"actualEndDate"}}},widgetFieldMap:{contact:["contactFirstName","contactPersonId","contactLastName","contactPhoneNumber","contactLoginId","contactOrganization","contactEmail"],customer:["customerPersonId","firstName","phoneNumber","customerLoginId","lastName","customerVIPFlag","internetEmail","organization"],site:["country","state","region","city","zipPostalCode","street","site","locationSite","locationAddress","locationSiteGroup","locationRegion"],causalCI:["CI_reconid","causalCI","affectedCIClassId"],impactedService:["impactedService","serviceCIReconId"],assignee:["assigneeLoginId","assignee"],assigneeSupportGroups:["supportGroups","assignedSupportCompany","assignedGroup","assignedSupportOrganization"],status:["status","statusReason"],changeClass:["timing","timingReason"],changeLocation:["siteRegion","siteGroup","siteName","siteId"],changeCoordinator:["assigneeName","assigneeLoginId","assigneeCompany","assigneeOrganization"],changeCoordinatorSupportGroups:["assigneeGroup","assigneeGroupId"],changeManager:["managerName","managerLoginId"],changeManagerSupportGroups:["managerGroup","managerGroupId"],changeRisk:["riskLevel"],targetDate:["targetDate"],scheduledDates:["scheduledStartDate","scheduledEndDate"],actualDates:["actualStartDate","actualEndDate"]},adminConsoleConfig:{sideMenu:[{label:"Home",name:"home"},{label:"Configuration",name:"configuration"},{label:"Reports",name:"reports"}],settingsLabelMapping:{"host.name":"Hostname","host.port":"Port","system.user.password":"Application password","mid_tier.base.url":"Midtier URL","open.aif.new.window":"Open AIF in new window","bppm.url":"URL","check.password.expiration":"Check password expiration","exchange.url":"URL","exchange.login":"Username","exchange.pass":"Password","rkm.templates":"RKM templates","statistics.enabled":"Collect performance statistics","popular.catalog.item.threshold":"Usage threshold for popular items","connect.arsystem.hostName":"AR hostname","connect.arsystem.port":"AR port","connect.arsystem.password":"AR password"}}})}(),function(){angular.module("myitsmApp").factory("configurationModel",["appConfiguration","$rootScope","metadataModel","AUTH_EVENTS","utilityFunctions",function(e,t,a,n,i){function o(){a.getMetadataByType(EntityVO.TYPE_GLOBAL).then(function(e){if(e.configurationParameters){var t=e.configurationParameters;if(s.companyChunkSize=t.assignmentCompanyChunkSize?parseInt(t.assignmentCompanyChunkSize):80,s.organizationChunkSize=t.assignmentSupportOrganizationChunkSize?parseInt(t.assignmentSupportOrganizationChunkSize):80,s.supportGroupChunkSize=t.assignmentSupportGroupChunkSize?parseInt(t.assignmentSupportGroupChunkSize):80,s.supportPersonChunkSize=t.assignmentSupportPersonChunkSize?parseInt(t.assignmentSupportPersonChunkSize):80,s.locationSiteChunkSize=t.locationSiteChunkSize?parseInt(t.locationSiteChunkSize):80,s.personChunkSize=t.personChunkSize?parseInt(t.personChunkSize):20,s.MaxLimitRelationships=t.MaxLimitRelationships?parseInt(t.MaxLimitRelationships):500,s.restrictConsoleResultForNoOfDays=parseInt(t.restrictConsoleResultForNoOfDays)<=0?0:parseInt(t.restrictConsoleResultForNoOfDays),s.restrictPersonProfileResultForNoOfDays=t.restrictPersonProfileResultForNoOfDays&&parseInt(t.restrictPersonProfileResultForNoOfDays)>0?parseInt(t.restrictPersonProfileResultForNoOfDays):0,s.restrictDWPCTicketsForNoOfDays=t.restrictDWPCTicketsForNoOfDays&&parseInt(t.restrictDWPCTicketsForNoOfDays)>0?parseInt(t.restrictDWPCTicketsForNoOfDays):0,s.skipAssetSearchInSmartRecorder="string"==typeof t.skipAssetSearchInSmartRecorder&&"true"===t.skipAssetSearchInSmartRecorder,t.explicitStatsRefresh){var a=t.explicitStatsRefresh;s.explicitStatsRefresh="string"==typeof a?"true"===a:a}if(t.disableCollisionManagement){var n=t.disableCollisionManagement;s.disableCollisionManagement="string"==typeof n?"true"===n:n}if(s.autoTriggerChangeCollisionForCIsUpto=0===t.autoTriggerChangeCollisionForCIsUpto?t.autoTriggerChangeCollisionForCIsUpto:t.autoTriggerChangeCollisionForCIsUpto>-1?Math.abs(t.autoTriggerChangeCollisionForCIsUpto):void 0,t.disableImpactAnalysis){var o=t.disableImpactAnalysis;s.disableImpactAnalysis="string"==typeof o?"true"===o:o}if(t.showNameInSmartRecorderCreateTicket){var r=t.showNameInSmartRecorderCreateTicket;s.showNameInSmartRecorderCreateTicket="string"==typeof r?"true"===r:r}if(t.dateTimeStyleProperty&&(s.dateTimeStyleProperty=t.dateTimeStyleProperty),t.socialWorklogAccessSetting){var l=t.socialWorklogAccessSetting;s.socialWorklogAccessSetting="string"==typeof l?"true"===l:"boolean"==typeof l&&l}if(t.showFilterForRecommendedKnowledge){var c=t.showFilterForRecommendedKnowledge;s.showFilterForRecommendedKnowledge="string"==typeof c&&"true"===c}if(t.quickTicketCreateEnabled){var d=t.quickTicketCreateEnabled;s.quickTicketCreateEnabled="string"==typeof d&&"true"===d}if(t.enableESChatIntegration){var u=t.enableESChatIntegration;s.enableESChatIntegration="string"==typeof u&&"true"===u}if(t.productAliasBasedSearch){var p=t.productAliasBasedSearch;s.productAliasBasedSearch="string"==typeof p&&"true"===p}if(t.midTierURL&&(s.midTierURL=t.midTierURL),t.enableAdvanceSearchInConsole){var m=t.enableAdvanceSearchInConsole;s.enableAdvanceSearchInConsole="string"==typeof m&&"true"===m}if(t.showNeedsAttentionFlag){var f=t.showNeedsAttentionFlag;s.showNeedsAttentionFlag="string"==typeof f?"true"===f:"boolean"==typeof f&&f}t.showSecurityTickets?s.showSecurityTickets="string"==typeof t.showSecurityTickets&&"true"===t.showSecurityTickets:s.showSecurityTickets=!1,t.showMailstopOnPersoncard&&(s.showMailstopOnPersoncard="string"==typeof t.showMailstopOnPersoncard&&"true"===t.showMailstopOnPersoncard),t.showPhoneNumOnPersonCard&&(s.showPhoneNumOnPersonCard="string"==typeof t.showPhoneNumOnPersonCard&&"true"===t.showPhoneNumOnPersonCard),t.enableDWPWidgetIntegration&&(s.enableDWPWidgetIntegration="string"==typeof t.enableDWPWidgetIntegration&&"true"===t.enableDWPWidgetIntegration),t.copyPrimaryCategoriesOnResolve?s.copyPrimaryCategoriesOnResolve="string"==typeof t.copyPrimaryCategoriesOnResolve&&"true"===t.copyPrimaryCategoriesOnResolve:s.copyPrimaryCategoriesOnResolve=!1,s.isPWAEnabled=!(!t["Enable-Progressive-Views"]||"T"!==t["Enable-Progressive-Views"]&&"true"!==t["Enable-Progressive-Views"]),s.helixDashboardUrl=!(!t.helixDashboardUrl||!t.helixDashboardUrl.length)&&t.helixDashboardUrl;var g=t.smartRecorderSearchByCompany;s.smartRecorderSearchByCompany="string"==typeof g?"true"===g:g,t.showARMessageOnGetEntry&&(s.showARMessageOnGetEntry="string"==typeof t.showARMessageOnGetEntry?"true"===t.showARMessageOnGetEntry:"boolean"==typeof showARMessageOnGetEntry&&showARMessageOnGetEntry)}var h="T"!==localStorage.getItem("overridePV")&&s.isPWAEnabled;s.enableReleasePV=t.enableReleasePV,localStorage.setItem("enableReleasePV",s.enableReleasePV),s.comaroundEnabled=!(e.comaroundEnabled!==!0||!h||!localStorage.getItem("midtierUrl")),s.comaroundEnabled&&(i.isValidHttpUrl(e.comaroundHostUrl)?s.comaroundHostUrl=e.comaroundHostUrl:console.error("Provided Comaround URL is invalid"))})}var r,s={},l=e;return s.get=function(e){return t.$eval("config."+e,{config:l})||{}},s.set=function(t,a){"enabledServerApplications"===t&&(r=a),e[t]=a},s.getWeekStartingDay=function(){return window.isRtl?0:1},s.isServerApplicationEnabled=function(e){return _.includes(r,e)},s.isFileExtensionAllowed=function(e){var t=s.get("attachmentSecurityConfiguration");if(t){var a=_(t.fileExtensions).map(function(e){return e.toLowerCase()}).value();if("whiteListExtensions"===t.ruleType&&_.includes(a,e.toLowerCase()))return!0;if("blackListExtensions"===t.ruleType&&!_.includes(a,e.toLowerCase()))return!0;if("allowAll"===t.ruleType)return!0;if("allowNone"===t.ruleType)return!1}return!1},t.$on(n.LOGIN_SUCCESS,function(){o()}),t.$on(n.SESSION_ACTIVE,function(){o()}),s}])}(),function(){angular.module("consoleModule").directive("accessibleItemList",["$rootScope","knowledgeConsoleModel","ticketConsoleModel","assetConsoleModel","events","$filter","browser",function(e,t,a,n,i,o,r){return{restrict:"E",replace:!0,templateUrl:"views/console/accessible-item-list.html",scope:{consoleType:"=",itemList:"=",gridColumns:"=",totalItemsFound:"=",state:"=",criteria:"=",handleRowSelection:"&",showSelection:"=",exceedChunkSize:"="},link:function(e){function s(t){"knowledge"===e.consoleType&&"modifiedDate"===t&&(t="lastModifiedDate");var a=_.findIndex(p,function(e){return e.name===t});return a>-1}function l(e){return"incidentType"===e?e="serviceType":"changeClass"===e?e="timing":"releaseType"===e&&(e="type"),e}e.isMobile=r.isMobile,e.accessibilityGridColumns=angular.copy(e.gridColumns),e.showNextButton=!1,e.endTicketCount=0;var c,d=[];switch(e.accessibleItemList=[],e.rtlMode=window.isRtl,e.quickSearchColumns=a.quickSearchHighlightedColumn||[],e.consoleType){case"ticket":c=a;break;case"knowledge":c=t;break;case"asset":c=n}var u=c&&c.availableColConfig?c.availableColConfig:[],p=_.filter(u,function(e){return!(!e.cellFilter||e.cellFilter.indexOf("datePreConfigTimezone:")===-1)||("datetime"===e.field.dataType||"date"===e.field.dataType)});e.getColumnData=function(t,a,n){var i=angular.copy(t);a=a.split(".");for(var r=0;r<a.length;r++){if(!i.hasOwnProperty(a[r]))return;i=i[a[r]]}return[EntityVO.TYPE_STATUS,EntityVO.TYPE_STATUS_REASON,EntityVO.TYPE_PRIORITY,EntityVO.TYPE_IMPACT,EntityVO.TYPE_URGENCY,"incidentType","reportedSource","changeClass","changeReason","riskLevel","investigationDriver","businessJustification","milestone","releaseType","taskType","workOrderType"].indexOf(n)!==-1?i=o("localizeLabel")(i,l(n),e.consoleType===EntityVO.TYPE_ASSET?t.ticketType:t.type):"type"===n&&e.consoleType!==EntityVO.TYPE_ASSET?i=o("tcCellType")(i):"type"===n&&e.consoleType===EntityVO.TYPE_ASSET?i=o("localizeLabel")(i,"assetType",t.ticketType):"isEscalated"===n?i=o("tcCellEscalated")(i):s(n)?i&&(i=o("datePreConfigTimezone")(i,"mediumDate")+" "+o("datePreConfigTimezone")(i,"mediumTime")):"slaStatus"===n?i=o("tcCellSlaStatus")(i):"targetDate"===n?i=o("tcCellSLA")(i):"needsAttention"===n&&("Yes"===i?i=o("i18n")("common.labels.yes"):"No"===i&&(i=o("i18n")("common.labels.no"))),i},e.selectTicket=function(t){t.selected?d.push(t):_.remove(d,{id:t.id}),e.handleRowSelection({data:d})},e.selectAllTickets=function(t){for(var a=0;a<e.itemList.length;a++)e.itemList[a].selected=t;d=t?angular.copy(e.itemList):[],e.handleRowSelection({data:d})},e.$on(i.SELECT_ALL_TICKETS,function(t,a){e.selectAllTickets(a)});var m=function(){e.itemList&&e.endTicketCount===e.itemList.length?e.showNextButton=!1:e.showNextButton=!0};e.fetchMoreTickets=function(t){"next"===t?e.criteria.chunkInfo.startIndex+=c.defaultChunkSize:e.criteria.chunkInfo.startIndex-=c.defaultChunkSize,e.itemList[e.criteria.chunkInfo.startIndex]&&(e.endTicketCount=e.criteria.chunkInfo.startIndex+e.criteria.chunkInfo.chunkSize>e.itemList.length?e.itemList.length:e.criteria.chunkInfo.startIndex+e.criteria.chunkInfo.chunkSize,e.accessibleItemList=e.itemList.slice(e.criteria.chunkInfo.startIndex,e.endTicketCount),m())},e.sortColumn=function(t){var a=_.findIndex(e.accessibilityGridColumns,{attributeName:e.criteria.sortInfo.sortFieldName});e.criteria.sortInfo.sortFieldName===t?e.accessibilityGridColumns[a].sortOrder="ASC"===e.accessibilityGridColumns[a].sortOrder?"DESC":"ASC":(a!==-1&&delete e.accessibilityGridColumns[a].sortOrder,a=_.findIndex(e.accessibilityGridColumns,{attributeName:t}),e.accessibilityGridColumns[a].sortOrder="ASC"),e.criteria.sortInfo={sortFieldName:t,sortFieldOrder:e.accessibilityGridColumns[a].sortOrder}},e.$watch("itemList",function(){e.itemList&&e.itemList.length?(e.endTicketCount=e.criteria.chunkInfo.startIndex+e.criteria.chunkInfo.chunkSize>e.itemList.length?e.itemList.length:e.criteria.chunkInfo.startIndex+e.criteria.chunkInfo.chunkSize,e.accessibleItemList=e.itemList.slice(e.criteria.chunkInfo.startIndex,e.endTicketCount)):(e.accessibleItemList=[],e.endTicketCount=0),m()},!0),e.$watch("gridColumns",function(){e.accessibilityGridColumns=angular.copy(e.gridColumns),window.isRtl&&e.accessibilityGridColumns.reverse()})}}}])}(),function(){angular.module("consoleModule").controller("ConsoleColumnConfiguratorController",["$modalInstance","$scope","systemAlertService","knowledgeConsoleModel","ticketConsoleModel","assetConsoleModel","permissionModel","roles","userModel","$timeout","$filter","params",function(e,t,a,n,i,o,r,s,l,c,d,u){function p(){var e=_.map(_.filter(t.columnFilterOptions,{active:!0}),"name"),a=e.indexOf("general")!==-1;_.forEach(t.availiableColumns,function(t){angular.isUndefined(t.ticketType)&&a||_.intersection(t.ticketType,e).length>0?t.onDisplay=!0:t.onDisplay=!1}),_.forEach(t.selectedColumns,function(t){angular.isUndefined(t.ticketType)&&a||_.intersection(t.ticketType,e).length>0?t.onDisplay=!0:t.onDisplay=!1})}t.state={savingConfiguration:!1},t.userModel=l,t.userIsAdmin=r.hasRole(s.ITSM_ADMIN_ROLE)||!1,t.showMetadataReloadButton=!1,t.consoleType=u.consoleType;var m={};switch(u.consoleType){case"ticket":m=i;break;case"knowledge":m=n;break;case"asset":m=o}if(t.availiableColumns=_.sortBy(_.filter(m.columnsConfig,{visible:!1}),"displayName"),t.selectedColumns=_.sortBy(_.filter(m.columnsConfig,{visible:!0}),"order"),"ticket"===u.consoleType){t.userIsAdmin&&(t.showMetadataReloadButton=!0);var f=m.ticketTypeFilter;f&&f.options&&(t.columnFilterOptions=_.cloneDeep(f.options),0===_.filter(t.columnFilterOptions,{active:!0}).length&&_.forEach(t.columnFilterOptions,function(e){e.active=!0}),t.columnFilterOptions.unshift({name:"general",label:"general",order:1,active:!0})),p()}else _.forEach(t.availiableColumns,function(e){e.onDisplay=!0}),_.forEach(t.selectedColumns,function(e){e.onDisplay=!0});var g={placeholder:"column-configurator__column",connectWith:".column-configurator__container"},h={placeholder:"column-configurator__column",connectWith:".column-configurator__container",update:function(e,a){1===t.selectedColumns.length&&a.item.sortable.cancel()}};t.sortableOptionsList=[g,h],t.updateColumnFilter=function(e){e.active=!e.active,p()},t.submit=function(){var a={};t.state.savingConfiguration=!0,c(function(){_.forEach(t.availiableColumns,function(e){m.columnsConfig[e.name].visible&&(m.columnsConfig[e.name].visible=!1,delete m.columnsConfig[e.name].order,"ticket"!==u.consoleType&&(a[e.name]={visible:!1}))}),"ticket"===u.consoleType?_.forEach(t.selectedColumns,function(e,t){var n=++t,i=function(e,t,n){a[e]||(a[e]={}),a[e][t]=n};m.columnsConfig[e.name].order!==n&&(m.columnsConfig[e.name].order=n),i(e.name,"order",n),m.columnsConfig[e.name].visible||(m.columnsConfig[e.name].visible=!0),i(e.name,"visible",!0),m.columnsConfig[e.name].type&&i(e.name,"type",m.columnsConfig[e.name].type)}):_.forEach(t.selectedColumns,function(e,t){var n=++t,i=function(e,t,n){a[e]||(a[e]={}),a[e][t]=n};m.columnsConfig[e.name].visible||(m.columnsConfig[e.name].visible=!0,i(e.name,"visible",!0)),m.columnsConfig[e.name].order!==n&&(m.columnsConfig[e.name].order=n,i(e.name,"order",n))}),m.updateColumnConfig(a),e.close()},10)},t.updateColumn=function(e,n){if("available"===n)t.availiableColumns.splice(t.availiableColumns.indexOf(e),1),t.selectedColumns.push(e);else{if(1===t.selectedColumns.length)return a.error({text:d("i18n")("console.ticket.allColumnsRemove.warning"),clear:!0}),!1;t.selectedColumns.splice(t.selectedColumns.indexOf(e),1),t.availiableColumns.push(e)}},t.moveColumn=function(e,a){var n=t.selectedColumns[e];"up"===a&&t.selectedColumns[e-1]?(t.selectedColumns[e]=t.selectedColumns[e-1],t.selectedColumns[e-1]=n):"down"===a&&t.selectedColumns[e+1]&&(t.selectedColumns[e]=t.selectedColumns[e+1],t.selectedColumns[e+1]=n)},t.refreshMetadata=function(){t.showMetadataReloadButton&&e.close("refresh")}}])}(),function(){angular.module("myitsmApp").directive("columnPicker",["consolePresetModel","$timeout","events",function(e,t,a){return{restrict:"E",templateUrl:"views/console/column-picker.html",link:function(n,i){n.config=e.consoleColumns,n.selectedItems=e.gridColumns,n.handleAddRemove=function(e){e.visible=!e.visible,e.visible?(n.selectedItems.push(e),n.selectedItems.forEach(function(e,t){e.order=t+1})):(_.remove(n.selectedItems,function(t){return t.name===e.name}),n.selectedItems.length||t(function(){angular.element(i.children()[0]).trigger("click")},0,!1)),n.$emit(a.MODAL_FORM_IS_DIRTY)}}}}])}(),function(){angular.module("consoleModule").filter("tcCellType",["$filter",function(e){return function(t){return e("i18n")("common.labels."+t)}}]),angular.module("consoleModule").filter("tcCellEscalated",["$filter",function(e){return function(t){return e("i18n")("console.column.escalated."+(t?"yes":"no"))}}]),angular.module("consoleModule").filter("tcCellSlaStatus",["$filter",function(e){return function(t){return t?e("i18n")("console.ticket.column.slaStatus."+t):""}}]),angular.module("consoleModule").filter("tcCellHighlight",["$filter","$sce",function(e,t){function a(e){var t=new RegExp(/%|_|&|<|>|gt;|lt;|amp;/gi);return t.test(e)}function n(e){return e.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")}return function(i,o){return i=e("htmlencode")(i),o&&!a(o)&&(i=i.replace(new RegExp(n(o),"gi"),function(e){return'<span ux-id="console-filter-highlight-quicksearch" class="tc__quick-search-highlight">'+e+"</span>"})),i=t.trustAsHtml(i),i?i:""}}]),angular.module("consoleModule").filter("tcCellSLA",[function(){return function(e){return e?moment(e).fromNow():""}}]),angular.module("consoleModule").filter("tcCellDates",["$filter","configurationModel",function(e,t){return function(a){return a?"relative"===t.dateTimeStyleProperty?moment(a).fromNow():e("datePreConfigTimezone")(a,"mediumDate")+" "+e("datePreConfigTimezone")(a,"shortTime"):""}}]),angular.module("consoleModule").filter("tcCellPriority",["$filter",function(e){return function(t,a){var n=t?"tc__cell-priority_"+e("lowercase")(t):"tc__cell-priority",i=t?e("localizeLabel")(t,EntityVO.TYPE_PRIORITY,a):"",o=["Critical","High","Medium","Low"];return _.includes(o,t)?'<span ng-cell-text class="'+n+'" title="'+i+'"></span>':'<span ng-cell-text title="'+i+'">'+i+"</span>"}}]),angular.module("consoleModule").filter("tcMobilePriority",["$filter",function(e){return function(t,a){var n=t?"tc__cell-priority_"+e("lowercase")(t):"tc__cell-priority",i=t?e("localizeLabel")(t,EntityVO.TYPE_PRIORITY,a):"",o=["Critical","High","Medium","Low"];return _.includes(o,t)?'<span class="'+n+'">'+(i||t)+"</span>":'<span class="custom-priority">'+(i||t)+"</span>"}}]),angular.module("consoleModule").filter("tcCellNeedsAttention",["$filter",function(e){return function(t,a){var n="",i="",o="";return"incident"!==a.type&&"workorder"!==a.type||("Yes"===t?(n="icon-flag",i=e("i18n")("console.filter.optionName.flagged")):"No"===t&&(n="icon-flag_o",i=e("i18n")("console.filter.optionName.unflagged")),o='<i class="tc__cell-needs_attention '+n+'" title="'+i+'"></i>'),o}}]),angular.module("consoleModule").filter("haveDatePassed",[function(){return function(e){return moment(e).isBefore(moment())}}]),angular.module("consoleModule").filter("metricCount",[function(){return function(e){var t=9999;return angular.isDefined(e)?angular.isNumber(e)&&e>t?t+"+":e:""}}]),angular.module("consoleModule").filter("kcTemplateType",["knowledgeArticleModel",function(e){return function(t){var a=_.find(e.knowledgeArticleTemplates,function(e){return e.name===t});return a?a.templateObject.label:t}}])}(),function(){angular.module("consoleModule").factory("consoleColumnsModel",["consoleService","$q",function(e,t){var a={consoleColumnsList:null};return a.getTicketAvailableColumnsList=function(){return a.consoleColumnsList?t.when(a.consoleColumnsList):e.getTicketAvailableColumnsList().then(function(e){return a.consoleColumnsList=e,a.consoleColumnsList})},a.consoleRefreshMetadata=function(){return e.consoleRefreshMetadata().then(function(e){return a.consoleColumnsList=null,e})},a}])}(),function(){angular.module("consoleModule").controller("ConsoleController",["$scope","knowledgeConsoleModel","ticketConsoleModel","assetConsoleModel","ticketActionService","userModel","followService","ribbonValidationService","$state","$compile","$modal","systemAlertService","$filter","urlCreatorService","knowledgeArticleModel","events","emailModel","$q","screenConfigurationModel","$timeout","browser","$rootScope","utilityFunctions","$sce","pwaModel",function(e,t,a,n,i,o,r,s,l,c,d,u,p,m,f,g,h,y,E,v,T,S,C,O,A){function I(t){var a=d.open({templateUrl:"views/ticket-console/bulk-need-attention-modal.html",windowClass:"bmc-need-attention-modal",backdrop:"static",size:"lg",controller:["$scope",function(e){e.flag=t}]});a.result.then(function(a){_.isEmpty(a)||(V.processing=!0,a=(t?"Needs Attention Flagged: ":"Needs Attention Unflagged: ")+a,i.toggleNeedAttentionFlag(e.selectedItems,{needsAttention:t?"Yes":"No",worknote:a||""}).then(function(){var a=t?"console.ribbonAction.needAttention.flag.success":"console.ribbonAction.needAttention.unflag.success";u.success({text:p("i18n")(a,e.selectedItems.length),hide:1e4}),e.getNewItemList(),e.getMetrics()})["finally"](function(){V.processing=!1}))})}function b(t){return _.filter(t,function(t,a,n){return t.options.length&&t.onDisplay&&t!==e.ticketTypeFilter&&t!==e.assetTypeFilter})}function k(){e.advancedQualenabled||(e.itemList=_.map(e.itemList,function(e){return e.highlight=a.criteria.filterCriteria.quickSearchText,e}))}function D(t){e.quickSearch.isQuickSearchTriggerd=!0,a.applyQuickSearch(t),e.quickSearch.isTooltipOpen=!1}function R(){var t=["%","_"],a=C.trimFirstThreeWildCardCharacters(e.quickSearch.searchText.trim(),t);a.showTooltip&&(e.quickSearch.searchText=a.text,P("leading"))}function P(t){var a,n;switch(t){case"leading":a="console.filter.search.tooltip.leadingWildcard";break;case"minChar":a="console.filter.search.tooltip.minCharacter";break;default:a="common.labels.exceedsCharLimit",n=B.quickSearchMaxCharLimit}U&&v.cancel(U),e.tooltipMessage=p("i18n")(a,n),e.quickSearch.isTooltipOpen=!0,U=v(function(){e.quickSearch.isTooltipOpen=!1},1e4)}function w(){var t=e.quickSearch.searchText.trim();t.length>B.quickSearchMaxCharLimit&&(e.quickSearch.searchText=t,e.quickSearch.searchText=e.quickSearch.searchText.slice(0,B.quickSearchMaxCharLimit),P("exceed"))}var L,N,M,V={bootstraping:!0,processing:!1,loadingMoreTickets:!1,updatingMetric:!1},F=[],x={fields:[],directions:[],columns:[]},G={init:function(t,a){a.$viewport.append(c('<div class="ngLoadingMoreSpinnerContainer" ng-if="state.loadingMoreTickets"><div loading-spinner if="true" inline="true" centered="true"></div></div>')(e))}},B=null,U=null;switch(e.consoleType){case"ticket":B=a;break;case"knowledge":B=t;break;case"asset":B=n}e.advancedQualification={name:"advanceSearchQuery",value:""},e.isMobile=T.isMobile,B&&(e.ribbonConfig=B.ribbonConfig,e.criteria=B.criteria,e.selectedFilters=B.selectedFilters,e.advancedQualification.value=B.criteria&&B.criteria.filterCriteria&&B.criteria.filterCriteria.advanceSearchQuery?B.criteria.filterCriteria.advanceSearchQuery:""),e.userModel=o,e.ticketTypeSelected=[],e.searchDisabled=!1,e.searchValue="",e.quickSearch={searchText:a&&a.criteria.filterCriteria.quickSearchText?a.criteria.filterCriteria.quickSearchText:"",isQuickSearchTriggerd:!1},e.maxFilterPills=2,e.itemActions={assign:function(t){i.showBulkAssignDialog(e.selectedItems).result.then(function(a){var n=a.assignee.fullName?a.assignee.fullName:a.group.name;return u.success({text:e.selectedItems.length+" "+p("i18n")("console.ribbonAction.assign.success")+" "+n,hide:1e4}),t.currentTarget.focus(),e.getNewItemList()},function(){t.currentTarget.focus()})},share:function(t){e.selectedItems[0].type===EntityVO.TYPE_SERVICEREQUEST||e.selectedItems[0].type===EntityVO.TYPE_KNOWLEDGE?i.showShareDialog(e.selectedItems).result.then(function(){e.gridOptions.selectAll(!1),t.currentTarget.focus()},function(){t.currentTarget.focus()}):h.createEmail(e.selectedItems)},link:function(t){i.showLinkDialog(e.selectedItems,!1).result.then(function(){u.success({text:p("i18n")("console.ribbonAction.relation.success"),hide:1e4}),e.consoleItems.allSelected=!1,e.getNewItemList(),t.currentTarget.focus()},function(){t.currentTarget.focus()})},follow:function(){V.processing=!0,r.follow(e.selectedItems).then(function(){u.success({text:p("i18n")("console.ribbonAction.follow.success",e.selectedItems.length),hide:1e4}),"knowledge"===e.consoleType&&f.updateCachedArticles(_.map(e.selectedItems,"id"),{following:!0})})["catch"](function(e){e&&u.error({text:e.data.errorCode?p("i18n")("error.unknown"):e.data.error,clear:!1})})["finally"](function(){
V.processing=!1})},unfollow:function(){V.processing=!0,r.unfollow(e.selectedItems).then(function(){u.success({text:p("i18n")("console.ribbonAction.unfollow.success",e.selectedItems.length),hide:1e4}),"knowledge"===e.consoleType&&f.updateCachedArticles(_.map(e.selectedItems,"id"),{following:!1})})["catch"](function(e){e&&u.error({text:e.data.errorCode?p("i18n")("error.unknown"):e.data.error,clear:!1})})["finally"](function(){V.processing=!1})},flag:function(){I(!0)},unflag:function(){I(!1)},openInNewTab:function(){var e=F.map(function(e){return m.create(e)});_.forEach(e,function(e){v(function(){window.open(e)},1)})},changeStatus:function(t){i.showEditStatusDialog(e.selectedItems,!1).result.then(function(a){u.success({text:p("i18n")("console.ribbonAction.editStatus.success")+a.statuslabel,hide:1e4}),e.consoleItems.allSelected=!1,e.getNewItemList(),t.currentTarget.focus()},function(){t.currentTarget.focus()})},assess:function(){B.kcsFilters.assessmentMode=!0,l.go(EntityVO.TYPE_KNOWLEDGE,{id:e.selectedItems[0].id,assessMode:!0})}},e.checkDateFilterAdded=function(){return B.checkDateFilterAdded()},e.setDefaultPreset=function(t){_.each(e.userSavedFilterPresets,function(e){e.defaultpreset=!1,e.name===t.name&&(e.defaultpreset=!0)});var a=["myAllOpenTicketsFilter","myGroupOpenTicketsFilter","needsAttentionFilter","myAllOpenKnowledge","myGroupAllOpenKnowledge","favoriteKnowledge","recentKnowledge","flaggedKnowledge"];if(t.systemgenerated){var n=_.find(M,{name:t.name});n?t.id=n.id:a.includes(t.id)&&(t.id=null)}var i={name:t.name,id:t.id||null,defaultpreset:t.defaultpreset,systemgenerated:t.systemgenerated};o.updateUserPreferences(B.filterPreferenceGroup,i).then(function(t){_.each(t,function(e){if(e.createDate&&e.systemgenerated){if(e.systemgenerated){var t=_.findIndex(B.userSavedPresets,{name:e.name});t>-1&&(B.userSavedPresets[t].id=e.id)}}else{var t=_.findIndex(B.userSavedPresets,function(t){return t.id===e.id});t>-1&&(B.userSavedPresets[t].columnId&&(e.columnId=B.userSavedPresets[t].columnId,e.columnValue=angular.copy(B.userSavedPresets[t].columnValue)),B.userSavedPresets[t]=e)}}),e.userSavedFilterPresets=e.setDefaultPresetOnload()})["catch"](function(){u.warning({text:p("i18n")("error.unknown"),hide:1e4})})},e.setDefaultPresetOnload=function(){L=[],N=[],M=[],_.each(B.userSavedPresets,function(e){e.createDate||L.push(e),e.createDate&&e.systemgenerated&&M.push(e),e.systemgenerated||N.push(e)}),_.each(L,function(e){var t=_.find(M,{name:e.name,systemgenerated:!0});t&&(e.id=t.id,e.defaultpreset=t.defaultpreset)});var e=_.find(B.userSavedPresets,{defaultpreset:!0});return e||(B.userSavedPresets[0].defaultpreset=!0),B.userSavedPresets=L.concat(N)},e.isRestrictToDateSearchEnabled=function(){return"ticket"===e.consoleType&&B.restrictConsoleResultForNoOfDays},e.init=function(){e.columnsConfig=B.columnsConfig,e.userSavedFilterPresets=e.setDefaultPresetOnload(),e.ticketMetric=B.statsConfig,e.filterConfig=B.filterConfig,e.ticketTypeFilter=B.ticketTypeFilter,e.assetTypeFilter=B.assetTypeFilter;var t=_.findIndex(e.selectedFilters,function(e){return"ticketTypes"===e.criteria.name}),a=_.findIndex(e.selectedFilters,function(e){return"assetTypes"===e.criteria.name});return t!==-1?_.forEach(e.selectedFilters,function(t){"ticketTypes"===t.criteria.name&&e.updateFilterGrouping(t.name)}):a!==-1?(_.forEach(e.filterConfig,function(t){t.onDisplay=!0,"statuses"===t.name&&_.forEach(t.options,function(e){e.onDisplay=!0}),e.consoleType===EntityVO.TYPE_ASSET&&(t.onDisplay=!t.assetType)}),_.forEach(e.selectedFilters,function(t){"assetTypes"===t.criteria.name&&e.updateAssetFilterGrouping(t.name)})):_.forEach(e.filterConfig,function(e){e.onDisplay=!0,"statuses"!==e.name&&"priorities"!==e.name||_.forEach(e.options,function(e){e.onDisplay=!0})}),e.setColumnDefinition(),e.displayMetric&&e.getMetrics(),e.displayFilters=!(T.isIE&&"ticket"===e.consoleType),e.normalizedFilterConfig=b(e.filterConfig),e.getNewItemList(!1,!0)["finally"](function(){q(),V.bootstraping=!1,e.showNeedAttentionStat||(e.ticketMetric=_.reject(e.ticketMetric,{name:"needsAttention"})),e.showSecurityTickets||(e.ticketMetric=_.reject(e.ticketMetric,{name:"securitytickets"}))})},e.getNewItemList=function(t,a){if(t){var n=Object.keys(B.criteria.filterCriteria);n.forEach(function(e){var t=B.criteria.filterCriteria[e];if(B.filterDict[e]&&B.filterDict[e].options&&B.filterDict[e].options.length&&!_.isEmpty(t)){var a=_.find(B.filterDict[e].options,function(e){return function(t){return t.label===e}}(t[0].id));a&&"date"===a.type&&"customRange"!=a.label&&(t[0].start&&a.defaultValues.start&&(t[0].start=S.$eval(a.defaultValues.start,{moment:moment})),t[0].end&&a.defaultValues.end&&(t[0].end=S.$eval(a.defaultValues.end,{moment:moment})))}})}return B.dropCriteriaStartIndex(),B.isSearchEnabled()?(V.processing=!0,e.searchDisabled=!1,z()["catch"](function(e){e&&u.error({text:e.data.errorCode?p("i18n")("error.unknown"):e.data.error,clear:!1})})["finally"](function(){a&&T.isIE?V.processing=!1:V.processing=B.metaDataRefresh||!1,e.userModel.isAccessibleUser||e.isMobile?e.$broadcast(g.SELECT_ALL_TICKETS,!1):e.gridOptions.selectAll(!1)})):(e.searchDisabled=!0,e.itemList=[],e.totalItemsFound=0,y.when(1))},e.loadMoreTickets=function(){V.loadingMoreTickets=!0,z()["finally"](function(){V.loadingMoreTickets=!1,V.lastRecordFetch=new Date})};var z=function(){return B.getItemList().then(function(t){e.isPublishedClicked?(e.itemList=_.filter(B.itemList,function(e){return"Published"===e.statusValue.value}),e.totalItemsFound=t,e.isPublishedClicked=!1):(e.itemList=B.itemList,e.totalItemsFound=t),"ticket"===e.consoleType&&k(),e.exceedChunkSize=B.exceedChunkSize})};e.refreshToShowStats=function(){V.updatingMetric=!0,e.showStats=!0,B.getTicketConsoleMetric()["finally"](function(){V.updatingMetric=!1})},e.getMetrics=function(){"asset"===e.consoleType||e.searchDisabled||(e.showStats=_.cloneDeep(B.showStats),e.showStats&&(V.updatingMetric=!0,B.getTicketConsoleMetric()["finally"](function(){V.updatingMetric=!1})))},e.applySearch=function(){var t=_.find(e.filterConfig,{name:"keywords"}),a=_.find(t.options,{subtype:"keyword"});e.applyKeywordFilter(t,a,this.searchValue),e.applyFilter(),this.searchValue=""},e.setColumnDefinition=function(){e.columnsConfig=B.columnsConfig,e.gridColumns=angular.copy(_.sortBy(_.filter(e.columnsConfig,"visible"),"order")),B.presetColumns&&B.presetColumns.length&&(e.gridColumns=angular.copy(B.presetColumns)),window.isRtl&&e.gridColumns.reverse()},e.startColumnConfigurator=function(t){var a=d.open({templateUrl:"views/console/column-configurator-action-blade.html",controller:"ConsoleColumnConfiguratorController",windowClass:"action-blade",size:"lg",resolve:{params:function(){return{consoleType:e.consoleType}}}});a.result.then(function(t){"refresh"===t&&(e.applyUserFilterPreset(B.userSavedFilterPresets[0]),B.resetCache(function(){u.success({text:p("i18n")("screenConfiguration.metadataRefreshedSuccessfullyTicketConsole"),hide:1e4}),l.go("ticketConsole",{refreshMetadata:!0},{reload:!0})})),e.setColumnDefinition(),B.appliedPreset&&!B.appliedPreset.columnId&&B.populateAttributeNames()})["finally"](function(){t.currentTarget.focus()})},e.openColumnConfigModal=function(){l.params.refreshMetadata&&(B.metaDataRefresh=!1,e.startColumnConfigurator())},e.updateFilterGrouping=function(t){var a=_.remove(e.ticketTypeSelected,function(e){return t===e});0!==a.length||_.isUndefined(e.filterConfig)||e.ticketTypeSelected.push(t),_.forEach(e.filterConfig,function(t){angular.isUndefined(t.ticketType)||0===e.ticketTypeSelected.length||0!==_.intersection(t.ticketType,e.ticketTypeSelected).length?(t.onDisplay=!0,("statuses"===t.name||"priorities"===t.name||"custom"===t.type&&"staticSelectionField"===t.fieldType)&&_.forEach(t.options,function(t){0===e.ticketTypeSelected.length||0!==_.intersection(t.criteria.ticketTypes,e.ticketTypeSelected).length?t.onDisplay=!0:t.onDisplay=!1})):t.onDisplay=!1})},e.updateAssetFilterGrouping=function(){e.assetTypeFilter=B.assetTypeFilter,e.filterConfig=B.filterConfig;var t=_.map(_.filter(e.assetTypeFilter.options,{active:!0}),"criteriaValue");_.forEach(e.filterConfig,function(e){e.assetType&&(e.criteriaKeys&&(e.selectiveClearFilters?B.clearSelectiveCriteriaKeyValues(e):B.clearCriteriaKeyValues(null,e.criteriaKeys)),e.onDisplay=1===t.length&&t[0]===e.assetType[0]),"assetSubTypes"===e.name&&_.forEach(e.options,function(e){e.onDisplay=!t||!t.length||_.includes(t,e.criteria.typeName)})})},e.filterButtonClicked=function(){return!(!T.isIE||"ticket"!==e.consoleType)&&(e.displayFilters||(V.processing=!0),void v(function(){e.displayFilters=!0},1))},e.openLaunchActionBlade=function(t,a){var n=d.open({templateUrl:"views/asset/asset-launch-action-blade.html",controller:"AssetLaunchActionController",windowClass:"action-blade",size:"lg",resolve:{linkParams:function(){return{selectedItem:e.selectedItems,actionItem:t}}}});n.result.then(function(t){a.currentTarget.focus(),_.isEmpty(t)||e.getNewItemList()})};var Y=function(t,a){if(a&&a.shiftKey)return void v(function(){window.open(m.create(t))},1);var n=A.isPwaEnabled(),i="true"===localStorage.getItem("enableReleasePV");if("asset"===e.consoleType){var o=n?"assetPV":t.ticketType;return void l.go(o,{assetId:t.reconciliationId,assetClassId:t.classId})}var r={incident:n?"incidentPV":EntityVO.TYPE_INCIDENT,workorder:n?"workorderPV":EntityVO.TYPE_WORKORDER,task:n?"taskPV":EntityVO.TYPE_TASK,request:EntityVO.TYPE_SERVICEREQUEST,knowledge:EntityVO.TYPE_KNOWLEDGE,change:n?"changePV":EntityVO.TYPE_CHANGE,problem:n?"problemPV":EntityVO.TYPE_PROBLEM,knownerror:n?"knownerrorPV":EntityVO.TYPE_KNOWNERROR,asset:EntityVO.TYPE_ASSET,release:n&&i?"releasePV":EntityVO.TYPE_RELEASE};return r[t.type]?r[t.type]===EntityVO.TYPE_KNOWLEDGE?void l.go(r[t.type],{id:t.id,preventIncrement:!1}):void l.go(r[t.type],{id:t.id}):void 0},q=function(){e.ribbonConfig.forEach(function(t){t.isActive=!!t.active&&e.$eval(t.active,{ribbonValidationService:s}),t.isHidden=!!t.hidden&&e.$eval(t.hidden,{ribbonValidationService:s})})};e.consoleItems={allSelected:!1},e.gridOptions={data:"itemList",headerRowHeight:43,rowHeight:40,sortInfo:x,useExternalSorting:!0,enableColumnResize:!0,showSelectionCheckbox:!0,checkboxHeaderTemplate:'<label class="ngSelectionHeaderLabel"><input ux-id="select-all-checkbox" class="ngSelectionHeader" type="checkbox" ng-show="multiSelect" ng-model="consoleItems.allSelected" ng-change="toggleSelectAll(consoleItems.allSelected)"/></label>',selectedItems:F,beforeSelectionChange:function(e,t){var a;return!t||!t.target||$(t.target).hasClass("ngSelectionCheckbox")||$(t.target).hasClass("ngSelectionCell")?a=!0:(a=!1,Y(e.entity,t)),a},afterSelectionChange:function(){q()},plugins:[G],columnDefs:"gridColumns"},e.consoleType===EntityVO.TYPE_ASSET&&(e.gridOptions.showSelectionCheckbox=!1,E.loadActionsForRuntime(EntityVO.TYPE_ASSET).then(function(){var t=E.runtimeActionsCache[EntityVO.TYPE_ASSET];e.gridOptions.showSelectionCheckbox=_.some(t.actionList,function(e){return"launch"===e.actionType&&_.includes(e.supportedPlatforms,"web")})})),e.$on("ngGridEventScroll",function(t){var a=V.lastRecordFetch?((new Date).getTime()-V.lastRecordFetch.getTime())/1e3:1;return a<1?void console.log("Scroll function skipped"):(console.log("Scroll function initiated"),void((e.criteria.chunkInfo.startIndex+B.defaultChunkSize<e.totalItemsFound||B.exceedChunkSize)&&!V.loadingMoreTickets&&(e.criteria.chunkInfo.startIndex+=B.defaultChunkSize,B.itemList[e.criteria.chunkInfo.startIndex-1]||(e.criteria.chunkInfo.startIndex-=B.defaultChunkSize,console.warning("Scroll function increased start index, but backend call was not fired for last index. Reverting index back to original.")))))}),e.state=V,e.selectedItems=F,e.sortInfo=x,e.openEntityDetailPage=Y,e.$watch("sortInfo",function(t,a){angular.equals(t,a)||(e.criteria.sortInfo={sortFieldName:x.columns[0].colDef.attributeName,sortFieldOrder:x.directions[0].toUpperCase()})},!0),e.$watch("gridOptions.$gridScope.isColumnResizing",function(t,a){if(t===!1&&a===!0){e.gridOptions.$gridScope.hasUserChangedGridColumnWidths=!1;var n={},i=function(e,t,a){n[e]||(n[e]={}),n[e][t]=a};_.forEach(e.gridOptions.$gridScope.columns,function(e){if(e.colDef.name){if(e.width!==e.colDef.width){i(e.colDef.name,"width",e.width);var t=_.find(B.columnsConfig,{name:e.colDef.name});t&&(t.width=e.width)}i(e.colDef.name,"order",e.colDef.index+1),i(e.colDef.name,"visible",!0),B.columnsConfig[e.colDef.name].type&&i(e.colDef.name,"type",B.columnsConfig[e.colDef.name].type)}}),B.updateColumnConfig(n)}},!0),e.handleRowSelection=function(t){e.selectedItems=F=t,q()},e.$watch("userModel.isAccessibleUser",function(){if(F.length)for(var t=0;t<F.length;t++)F[t].selected=!1;e.selectedItems=F=[],e.userModel.isAccessibleUser||(e.gridOptions.selectedItems=F)},!0),e.$watch("totalItemsFound",function(){(e.userModel.isAccessibleUser||e.isMobile)&&(e.selectedItems=F=[])},!0),e.$on(g.UPDATE_GRID_COLUMNS,e.setColumnDefinition),e.isAllTypeChange=function(e){var t,a=!0;for(t=0;t<e.length;t++)if(e[t].type!==EntityVO.TYPE_CHANGE){a=!1;break}return a},e.showChangeWarning=function(e){var t,a=!0;for(t=0;t<e.length;t++)if(e[t].type!==EntityVO.TYPE_CHANGE||!e[t].allowBulkUpdateStatus){a=!1;break}return a},e.applyAdavancedQualSearch=function(){e.isApplyClicked=!0,B.applyFilter({advancedFilter:!0,criteria:e.advancedQualification})},e.clearQuickSearch=function(){"ticket"===e.consoleType&&(e.quickSearch.searchText="",""!==a.criteria.filterCriteria.quickSearchText&&D(e.quickSearch.searchText),e.focusQuickSearch())},e.applyQuickSearch=function(){var t=e.quickSearch.searchText.trim();e.quickSearch.searchText=t,t.length>2?a.criteria.filterCriteria.quickSearchText!==t&&D(t):P("minChar")},e.onSearchTextChange=function(){""==e.quickSearch.searchText&&this.clearQuickSearch(),e.quickSearch.isTooltipOpen=!1,R(),w()}}])}(),function(){angular.module("consoleModule").directive("console",["$window","$timeout","$rootScope","configurationModel","searchModel","personModel","knowledgeConsoleModel","ticketConsoleModel","assetConsoleModel","$modal","$q","$filter","systemAlertService","events","consoleService","consolePresetModel","metadataModel","utilityFunctions",function(e,t,a,n,i,o,r,s,l,c,d,u,p,m,f,g,h,y){return{restrict:"E",replace:!0,scope:{defaultFilters:"=",defaultCriteria:"=",consoleType:"@"},templateUrl:"views/console/console.html",controller:"ConsoleController",link:function(E,v,T){function S(e,t){return!(e<t)&&!E.itemList[e]}var C=!!angular.isDefined(T.displayMetric)&&E.$eval(T.displayMetric),O=!!angular.isDefined(T.displayFilter)&&E.$eval(T.displayFilter),A={},I=null;switch(E.maxFilterPills=n.get("ticketConsole.config.maxFilterPills"),E.showNeedAttentionStat=!1,E.showSecurityTickets=!1,E.consoleType){case"ticket":I=s;break;case"knowledge":I=r;break;case"asset":I=l}if(E.$watch("filter.isOpen",function(){E.filter.isOpen||E.cancelFilter()}),E.openSearch=function(){$('.tc__search_bar .tc__search_icon:not(".open_search")').toggle(),$(".tc__search_bar_input").toggle("slide")},E.defaultCriteria&&angular.extend(E.criteria,E.defaultCriteria),O){E.filter={isOpen:!1},E.appliedSelectedFilters=[],E.isApplyClicked=!1,E.isRemoveClicked=!1,E.filterCount=0;var b=function(e,t){if(angular.isObject(_.find(e.options,{name:t.name}))){if("affectedBusinessServices"!==t.criteria.name)return;var a=!1;if(_.forEach(e.options,function(e){e.criteria&&e.criteria.value[0].reconciliationId===t.criteria.value[0].reconciliationId&&(a=!0)}),a)return}e.options.push(t),E.updateFilterCriteria(_.last(e.options))},k=function(e){var t=!1;if(e.value.length===I.selectedFilters.length){t=!0;for(var a=0,n=e.value.length;a<n;a++){var i=e.value[a],o=_.find(I.selectedFilters,{name:i.option,filterName:i.filter});if(!o){t=!1;break}}}return t};E.expandFilterItem=function(e){return e.expanded?void(e.expanded=!1):(_.forEach(E.filterConfig,function(e){e.expanded=!1}),void(e.expanded=!0))},E.searchFilterOption=function(e,t,a){var n=a||{},r=!1,s=E.$eval(E.consoleType===EntityVO.TYPE_ASSET&&n.selectedSearchMode?n.selectedSearchMode.method:e.method,{searchModel:i,personModel:o,consoleModel:I}),l=function(e){return!(r&&e.name===d)},c=function(e,t){var a=E.consoleType===EntityVO.TYPE_ASSET&&n.selectedSearchMode?n.selectedSearchMode.fields.key:t.fields.key,i=E.consoleType===EntityVO.TYPE_ASSET&&n.selectedSearchMode?n.selectedSearchMode.fields.value:t.fields.value;if(e.length&&!_.isEmpty(e[0])){var o=[];return _.forEach(e,function(e){E.userModel.userFullData&&E.userModel.userFullData.loginId!==e.loginId&&l(e)&&o.push({key:e[a],value:E.$eval(t.valueFormat,_.merge({value:_.get(e,i)},e.attributeMap)),realObject:e})}),o}};if(a&&"organizations"===a.name){r=!0;var d=E.userModel.userFullData.organization}var u=E.consoleType===EntityVO.TYPE_ASSET;return u&&n.selectedSearchMode&&n.selectedSearchMode.method&&"searchModel.getOrganizationsByText"===n.selectedSearchMode.method?s(t,u).then(function(t){return c(t,e)}):s(t).then(function(t){return c(t,e)})},E.onFilterOptionSelect=function(e,t,a){var n,i=null;"assignedSupportGroups"===e.name||"changeManagerGroup"===e.name||"requestManagerGroups"===e.name?(i=_.cloneDeep(a.realObject),delete i.companyName,delete i.companyAndOrganization):i=a.value,n=_.has(a,"realObject.attributeMap.companyName")?a.key+": "+a.realObject.attributeMap.companyName:_.has(a,"realObject.companyName")?a.key+": "+a.realObject.companyName:_.has(a,"realObject.company.name")?a.key+": "+a.realObject.company.name:a.key,"assignedSupportGroups"!==e.name&&"changeManagerGroup"!==e.name&&"problemCoordinatorGroups"!==e.name&&"releaseCoordinatorGroup"!==e.name&&"requestManagerGroups"!==e.name||(_.has(a,"realObject.companyAndOrganization")?n=a.key+": "+a.realObject.companyAndOrganization:_.has(a,"realObject.attributeMap.companyAndOrganization")&&(n=a.key+": "+a.realObject.attributeMap.companyAndOrganization));var o={name:n,active:!0,type:"dynamic",criteria:{name:e.name,value:[i]}};t.searchText="",b(e,o)},E.applyAdvancedFilterOption=function(e,t,a){if(""!==t.searchText){t.active=!t.active;var n=_.some(e.criteriaKeys,function(e){return e.active});E.onFilterOptionKeySelect(e,t,a,n)}},E.onFilterOptionKeySelect=function(e,t,a,n){var i={active:n,type:"dynamic",criteria:{name:e.name}},o=[],r={};if(a&&(t.selectedValue=a.value,t.searchText=a.key,_.isEmpty(a.value.categorizations)||(t.selectedValue=t.searchText=a.value.categorizations[0].tiers.productName)),t.searchText||(t.active=!1),_.forEach(e.criteriaKeys,function(e){r[e.name]={operator:e.selectedOperator.id,value:"search"===e.type?e.selectedValue:e.searchText},r[e.name].value&&e.active?o.push(r[e.name].value):delete r[e.name]}),_.isEmpty(r)){var s=_.find(I.selectedFilters,{filterName:e.name});return void(s&&(s.active=!1,i.name=s.name,E.updateFilterCriteria(i)))}i.criteria.value=[r],i.name=o.join(", "),E.updateFilterCriteria(i)},E.resetRangeTypeFilter=function(){E.rangeValues={}},E.removeFilter=function(e,t){e.active=!1,"ticketTypes"===e.criteria.name?E.updateFilterGrouping(e.name):"assetTypes"===e.criteria.name?E.updateAssetFilterGrouping(e.name):"operatingSystem"===e.criteria.name||"processor"===e.criteria.name?I.clearCriteriaKeyValues(e.criteria.name):"cpu"===e.criteria.name&&E.resetRangeTypeFilter(),"customFilter"===e.filterType&&"range"===e.subtype&&(E.rangeValues={}),E.isRemoveClicked=!0,t||E.clearQuickSearch(),I.applyFilter(e)},E.handleKeydown=function(e,t){32===e.keyCode&&(E.addFilter(t),e.preventDefault(),e.stopPropagation())},E.addFilter=function(e){e.active=!e.active,"ticketTypes"===e.criteria.name?t(function(){E.updateFilterGrouping(e.name)}):"assetTypes"===e.criteria.name&&E.updateAssetFilterGrouping(e.name),"timeStampRange"!==e.type&&(E.currentFilter=e,E.updateFilterCriteria(e))},E.updateFilterCriteria=function(e){var t=!1,a=0;for(var n in E.appliedSelectedFilters){var i=E.appliedSelectedFilters[n];if(i.name==e.name&&i.criteria.name==e.criteria.name){e.active?E.filterCount+=1:E.filterCount-=1,E.appliedSelectedFilters.splice(a,1),t=!0;break}a++}t||(e.active?E.filterCount+=1:E.filterCount-=1,E.appliedSelectedFilters.push(e))},E.applyFilter=function(){var e=0;for(var t in E.appliedSelectedFilters){var a=E.appliedSelectedFilters[t];I.applyFilter(a),e++}e>0&&(E.isApplyClicked=!0,E.filter.isOpen=!1,E.clearQuickSearch()),E.appliedSelectedFilters=[],E.filterCount=0};var D=function(e){var t=_.findIndex(E.filterConfig,{name:e.criteria.name});if(t>-1&&!_.isUndefined(E.filterConfig[t].criteriaKeys)){var a=E.filterConfig[t].criteriaKeys;_.each(a,function(t){t.selectedValue!==e.name&&t.searchText!==e.name||(t.active=e.active)})}};E.cancelFilter=function(){E.filter.isOpen=!1,E.selectedFilters=I.selectedFilters;for(var e in E.appliedSelectedFilters)E.appliedSelectedFilters[e].active=!E.appliedSelectedFilters[e].active,D(E.appliedSelectedFilters[e]),E.appliedSelectedFilters[e].criteria&&"ticketTypes"===E.appliedSelectedFilters[e].criteria.name&&E.updateFilterGrouping(E.appliedSelectedFilters[e].name);E.resetRangeTypeFilter(),E.appliedSelectedFilters=[],E.filterCount=0},E.refreshConsole=function(){E.refreshing=!0,E.getNewItemList(!0).then(function(){E.refreshing=!1})["catch"](function(){E.refreshing=!1}),C&&E.getMetrics()},E.saveFilterPreset=function(){E.savePresetName="";var e=c.open({templateUrl:"views/console/console-save-filter-preset-action-blade.html",controller:["$scope","$modalInstance",function(e,t){e.advancedQualenabled=E.advancedQualenabled,e.consoleType=E.consoleType,e.advancedQualification=E.advancedQualenabled?E.advancedQualification:{},e.selectedFilters=I.selectedFilters,e.gridColumns=angular.copy(_.sortBy(_.filter(I.columnsConfig,"visible"),"order")),e.filterPresetName="",e.saveFitlerCheckbox=e.selectedFilters.length>0,e.saveColumnCheckbox=e.gridColumns.length>0,e.savePreset=function(a){if(E.savePresetName=a,"columns"===a)return void p.warning({text:u("i18n")("console.saveFilter.reservedName"),hide:1e4});if(_.find(I.userSavedFilterPresets,{name:a})||_.find(I.userSavedColumnPresets,{name:a})||_.find(I.userSavedPresets,{name:a}))return void p.warning({text:u("i18n")("console.saveFilter.nameConflict"),hide:1e4});e.savingFilterPreset=!0;var n,i,o,r=[];e.saveFitlerCheckbox&&I.saveFilterPreset(a).then(function(){n=f.saveCIFilterConfiguration(a,I.criteria.filterCriteria),r.push(n),e.saveColumnCheckbox&&I.saveColumnPreset&&(o={},_.forEach(e.gridColumns,function(e,t){var a=++t;o[e.name]={visible:!0,order:a}}),o.newColumnType=!0,i=I.saveColumnPreset(a,o),r.push(i)),d.all(r).then(function(){t.close()})["finally"](function(){e.savingFilterPreset=!1,E.init()})})["catch"](function(){p.warning({text:u("i18n")("error.unknown"),hide:1e4}),e.savingFilterPreset=!1})}}],windowClass:"action-blade"});e.result.then(function(){I.addUserSavedPresets(E.savePresetName),E.applyUserFilterPreset(_.find(I.userSavedPresets,{name:E.savePresetName})),E.clearQuickSearch()})},E.clearAllFilters=function(e){var t=E.selectedFilters.concat([]);_.forEach(t,function(t){E.removeFilter(t,e)}),E.advancedQualification&&E.advancedQualification.value&&(E.advancedQualification.value="",I.criteria.filterCriteria.advanceSearchQuery=""),e||E.clearQuickSearch()},E.datePickerOptions={formatYear:"yy",startingDay:n.getWeekStartingDay(),"show-weeks":!1,"format-day":"d",showMeridian:e.showMeridian,minDate:moment().year(1970).month(0).date(2),maxDate:moment().year(2038).month(0).date(18)},E.openDatePicker=function(e,t){e&&(e.preventDefault(),e.stopPropagation()),t.isOpen=!0},E.closeDatePickers=function(e){e.startDatePicker.isOpen=!1,e.endDatePicker.isOpen=!1},E.onDateRangeSubmit=function(e,t){function n(e){var t=e.getHours(),a=e.getMinutes();return 60*t*60*1e3+60*a*1e3}function i(){if(a.timezone){var e=60*moment.tz(a.timezone).utcOffset()*1e3;return e}return 6e4*(new Date).getTimezoneOffset()}var o=t.startDatePicker.date.getTime(),r=t.endDatePicker.date.getTime();if(a.timezone&&(o=y.convertToUserPreferenceTimezone(o,a.timezone).getTime(),r=y.convertToUserPreferenceTimezone(r,a.timezone).getTime()),"custom"===e.type)var s=n(t.startDatePicker.date),l=n(t.endDatePicker.date);var c=_.cloneDeep(t);t.active=!1,c={name:u("datePreConfigTimezone")(o,"mediumDate")+" "+u("datePreConfigTimezone")(o,"shortTime")+" - "+u("datePreConfigTimezone")(r,"mediumDate")+" "+u("datePreConfigTimezone")(r,"shortTime"),active:!0,type:"dynamic",criteria:{name:c.criteria.name,type:"date",value:[{start:o,end:r}]}},"custom"===e.type&&(c.filterType="customFilter",e.oldFields&&"time"==e.oldFields.dataType?(c.name=u("date")(o,"shortTime")+" - "+u("date")(r,"shortTime"),c.criteria.value=[{start:s,end:l}]):e.oldFields&&"date"==e.oldFields.dataType&&(c.criteria.value=[{start:o-i(),end:r-i()}])),b(e,c)},E.applyKeywordFilter=function(e,t,a){var n=a||t.searchText;if(n){var i={name:n,active:!0,type:"dynamic",criteria:{name:e.name,value:"rack"===e.name?[{id:n}]:[n]}};"custom"===e.type&&"customFilter"===t.filterType&&(i.filterType="customFilter"),b(e,i),t.searchText=""}},E.onNumberRangeSubmit=function(e){if(!(_.isEmpty(E.rangeValues)||isNaN(E.rangeValues.min)&&isNaN(E.rangeValues.max))){var t=E.rangeValues.min,a=E.rangeValues.max;E.rangeValues.min||0===E.rangeValues.min||(E.rangeValues.min=E.rangeValues.max,t=a),(!E.rangeValues.max&&0!==E.rangeValues.max||E.rangeValues.max<E.rangeValues.min)&&(E.rangeValues.max=E.rangeValues.min,a=t);var n={name:t+" - "+a,active:!0,type:"dynamic",range:{min:E.rangeValues.min,max:E.rangeValues.max},criteria:{name:e.name,value:[{min:E.rangeValues.min,max:E.rangeValues.max}]}};"custom"===e.type&&(n.filterType="customFilter",n.subtype="range"),b(e,n),E.rangeValues={}}},E.applyRangeFilter=function(e){if(!_.isEmpty(E.rangeValues)){var t=e.options[0].range?e.options[0].range:void 0;if(t&&(E.filterCount-=1,E.rangeValues.min===t.min&&E.rangeValues.max===t.max))return void(E.filterCount+=1);var a=E.rangeValues.min,n=E.rangeValues.max;(!E.rangeValues.min||E.rangeValues.max<0)&&(E.rangeValues.min=0,a=E.rangeValues.min),(!E.rangeValues.max||E.rangeValues.max<E.rangeValues.min)&&(E.rangeValues.max=E.rangeValues.min,n=a,0===E.rangeValues.max&&(E.rangeValues.max=1,n=1));var i={name:a+" - "+n,active:!0,type:"dynamic",range:{min:E.rangeValues.min,max:E.rangeValues.max},criteria:{name:e.name,value:[{min:E.rangeValues.min,max:E.rangeValues.max}]}};e.options[0]=i,E.updateFilterCriteria(i)}},E.advancedFilterType=function(e){return E.consoleType===EntityVO.TYPE_ASSET&&I.advancedFilterType(e)},E.checkForRangeFilter=function(e){return E.consoleType===EntityVO.TYPE_TICKET&&I.checkForRangeFilter(e)},E.validateRangeMinVal=function(e,t){e.range.min&&e.range.min>t&&(E.rangeValues.min=e.range.min)},E.validateRangeMaxVal=function(e,t){e.range.max&&e.range.max<t&&(E.rangeValues.max=e.range.max)},E.checkForTimeOnlyFilter=function(e){return E.consoleType!==EntityVO.TYPE_TICKET||"custom"!==e.type||!(e.oldFields&&"time"===e.oldFields.dataType)},E.checkForDateOnlyFilter=function(e){return E.consoleType!==EntityVO.TYPE_TICKET||"custom"!==e.type||!(e.oldFields&&"date"===e.oldFields.dataType)},E.showCustomRangeCheck=function(e,t){return"ticket"!==E.consoleType||"custom"!==t.type||!("custom"===t.type&&"timeStampRange"===e.type&&("date"===t.oldFields.dataType||"time"===t.oldFields.dataType))},E.rangeValues={}}E.applyFilterSet=function(e,t){E.isApplyClicked=!0,I.applyFilterSet(e,t)},E.applyUserFilterPreset=function(e,t){var a=!1;angular.isDefined(I.isKcsCoachPreset)&&(I.isKcsCoachPreset="myTeamKnowledge"===e.id),E.advancedQualification.value="",I.criteria&&I.criteria.filterCriteria&&I.criteria.filterCriteria.advanceSearchQuery&&(I.criteria.filterCriteria.advanceSearchQuery="",a=!0),_.isEmpty(e.columnValue)?(I.presetColumns=null,E.appliedUserFilter=e,I.appliedPreset=E.appliedUserFilter,I.populateAttributeNames(),E.$emit(m.UPDATE_GRID_COLUMNS)):(I.applyColumnSet(e.columnValue),E.$emit(m.UPDATE_GRID_COLUMNS),E.appliedUserFilter=e,I.appliedPreset=E.appliedUserFilter),e.value&&(!k(e)||a?(0===I.selectedFilters.length&&(E.isRemoveClicked=!0),E.gridOptions&&E.gridOptions.ngGrid&&E.gridOptions.ngGrid.$viewport&&E.gridOptions.ngGrid.$viewport.scrollTop(0),E.clearAllFilters(t),I.applyFilterSet(e.value),A=e,_.forEach(e.value,function(e){"ticketTypes"===e.filter?E.updateFilterGrouping(e.option):"assetTypes"===e.filter?E.updateAssetFilterGrouping(e.option):"advanceSearchQuery"===e.filter&&(E.advancedQualification.value=e.option)})):(E.appliedUserFilter=e,I.appliedPreset=E.appliedUserFilter)),E.consoleItems.allSelected=!1,t||E.clearQuickSearch()},E.removeUserFilterPreset=function(e){var t=p.modal({title:u("i18n")("common.notification.delete.title"),text:u("i18n")("search.filter.optionName.notification.delete.message"),buttons:[{text:u("i18n")("common.labels.yes"),data:!0},{text:u("i18n")("common.labels.no"),data:!1}]});t.result.then(function(t){t&&(E.appliedUserFilter&&E.appliedUserFilter.id===e.id&&E.appliedUserFilter.id&&E.clearAllFilters(),I.removeUserFilterPreset(e),_.remove(E.userSavedFilterPresets,{id:e.id}),E.applyUserFilterPreset(E.userSavedFilterPresets[0]))})},E.getDefaultFromList=function(){var e=[],t=[],a=[];return _.each(I.userSavedPresets,function(n){n.createDate||e.push(n),n.createDate&&n.systemgenerated&&a.push(n),n.systemgenerated||t.push(n)}),_.each(e,function(e){var t=_.find(a,{name:e.name,systemgenerated:!0});t&&(e.id=t.id,e.defaultpreset=t.defaultpreset)}),e.concat(t)},E.editUserFilterPreset=function(e){g.init(E.consoleType,e);var t=c.open({templateUrl:"views/console/console-edit-filter-preset-action-blade.html",controller:"ConsolePresetController",windowClass:"action-blade",keyboard:"custom",backdrop:"custom"});t.result.then(function(){E.applyUserFilterPreset(_.find(I.userSavedPresets,{name:e.name}))})};var R=function(){d.all([I.populateFilters(),I.populateConfiguration(),h.getMetadataByType(EntityVO.TYPE_GLOBAL)]).then(function(e){n.showNeedsAttentionFlag?E.showNeedAttentionStat=!0:E.ribbonConfig=_.reject(E.ribbonConfig,{name:"bulk-need-attention"}),n.showSecurityTickets&&(E.showSecurityTickets=!0),s.quickSearchHighlightedColumn=e[2]&&e[2].quickSearchHighlightedCols||[],s.removeDateRestriction=e[2]&&e[2].removeDateRestriction||[],E.quickSearchColumns=s.quickSearchHighlightedColumn,E.advancedQualenabled=n.enableAdvanceSearchInConsole;var t=E.getDefaultFromList(),a=_.find(t,{defaultpreset:!0});if(a&&(I.userSavedFilterPresets[0]=a),I.areFiltersPopulated)if(I.kcsFilters&&I.enableKcsFilters()){if(I.kcsFilters.assessmentMode){var i=I.selectedFilters.length&&"authors"===I.selectedFilters[0].filterName;E.clearAllFilters(!0),I.kcsFilters.teamMemberFilter=i,I.kcsFilters.coachFilter=!i}else E.clearAllFilters(!0);E.appliedUserFilter=I.kcsFilters.coachFilter?I.userSavedFilterPresets[0]:null,I.appliedPreset=E.appliedUserFilter,I.applyKcsFilter()}else if(I.appliedPreset&&I.appliedPreset.name)E.applyUserFilterPreset(I.appliedPreset,!0),I.areFiltersPopulated=!0,I.appliedPreset=E.appliedUserFilter;else{var o=_.cloneDeep(I.selectedFilters),r=_.map(o.reverse(),function(e){return{filter:e.filterName||e.criteria.name,option:e.name}});E.clearAllFilters(!0),I.applyFilterSet(r),I.criteria&&I.criteria.filterCriteria&&I.criteria.filterCriteria.advanceSearchQuery&&(E.advancedQualification.value=I.criteria.filterCriteria.advanceSearchQuery)}else E.applyUserFilterPreset(I.userSavedFilterPresets[0],!0),E.appliedUserFilter=A,A={},I.areFiltersPopulated=!0,I.appliedPreset=E.appliedUserFilter;return E.init()})["finally"](function(){E.$watch("criteria",function(e,t){var a=2;E.refreshing||(e.filterCriteria.statusMappings&&e.filterCriteria.ticketSpecificStatuses&&(a=3),e.filterCriteria.hasOwnProperty("advanceSearchQuery")&&a++,Object.keys(e.filterCriteria).length<a?I.setSearchEnabled(!1):I.setSearchEnabled(!0),e.filterCriteria.customColumnRemoved&&(delete e.filterCriteria.customColumnRemoved,E.getNewItemList()),angular.equals(e.filterCriteria,t.filterCriteria)?angular.equals(e.sortInfo,t.sortInfo)&&angular.equals(e.attributeNames,t.attributeNames)&&(E.consoleType!==EntityVO.TYPE_TICKET||angular.equals(e.customAttributeNames,t.customAttributeNames))?angular.equals(e.chunkInfo,t.chunkInfo)||S(e.chunkInfo.startIndex,t.chunkInfo.startIndex)&&E.loadMoreTickets():E.getNewItemList():((E.isApplyClicked||E.isRemoveClicked||E.quickSearch.isQuickSearchTriggerd)&&(E.getNewItemList(),
C&&E.getMetrics()),E.isApplyClicked=!1,E.isRemoveClicked=!1,E.quickSearch.isQuickSearchTriggerd=!1,E.appliedUserFilter=A.id?A:{},I.appliedPreset=E.appliedUserFilter,A={}))},!0),E.openColumnConfigModal()})};I&&"function"==typeof I.populateMetadataAndColumns?I.populateMetadataAndColumns().then(function(){R()}):R(),E.getFilterLabel=function(e){var t="",a="";return"customFilter"===e.filterType?(t=e.filterLabel?e.filterLabel+": ":"",a=e.label?e.label:e.name):e.criteria&&"date"===e.criteria.type&&e.criteria.value&&e.criteria.value.length?(a=u("datePreConfigTimezone")(e.criteria.value[0].start,"mediumDate")+" "+u("datePreConfigTimezone")(e.criteria.value[0].start,"shortTime")+" - "+u("datePreConfigTimezone")(e.criteria.value[0].end,"mediumDate")+" "+u("datePreConfigTimezone")(e.criteria.value[0].end,"shortTime"),t=e.filterLabel?u("i18n")("console.filter.name."+e.filterLabel)+": ":""):(a=e.label?u("i18n")("console.filter.optionName."+e.label):e.name,t=e.filterLabel?u("i18n")("console.filter.name."+e.filterLabel)+": ":""),t+a},E.getMoreSelectedFilterLabel=function(e){var t="",a="";return"customFilter"===e.filterType?(t=e.filterLabel?e.filterLabel+": ":"",a=e.label?e.label:e.name):(a=e.label?u("i18n")("console.filter.optionName."+e.label)+(e.subText?e.subText:""):e.name,t=e.filterLabel?u("i18n")("console.filter.name."+e.filterLabel)+": ":""),t+a},E.focusQuickSearch=function(){t(function(){angular.element("#console-filter-quicksearch-box").focus()})},E.displayMetric=C,E.displayFilter=O,E.$on("$stateChangeStart",function(e,t,a,n,i){E.filter.isOpen&&E.cancelFilter()})}}}])}(),function(){angular.module("consoleModule").controller("ConsolePresetController",["$scope","$modalInstance","$q","$filter","consoleService","configurationModel","userModel","systemAlertService","consolePresetModel","events","i18nService",function(e,t,a,n,i,o,r,s,l,c,d){function u(){var t=_.cloneDeep(e.selectedFilters),n={name:g.name,id:g.id,defaultpreset:g.defaultpreset,value:_.map(t.reverse(),function(e){var t={filter:e.filterName||e.criteria.name,option:e.name};return"dynamic"===e.type&&(t.type="dynamic",t.realOption=angular.copy(e),delete t.realOption.active),t})};return l.setFilterPresetData("value",n.value),e.advanceSerachQuery&&n.value.push(e.advanceSerachQuery),a.all([r.updateUserPreferences(l.filterPreferenceGroup,n)])}function p(t){var a={};return t||_.forEach(e.gridColumns,function(e,t){var n=++t;a[e.name]={visible:!0,order:n}}),l.setFilterPresetData("columnValue",a),a.newColumnType=!0,l.updateColumnConfig(a,g.name,g.columnId)}function m(){e.updatePresetForm.$dirty=!0}function f(){e.close()}var g=l.selectedPreset;e.filterPresetName=g.name,e.consoleType=l.consoleType,e.filterConfig=l.filterConfig,e.consoleColumns=l.consoleColumns,e.selectedFilters=l.selectedFilters,e.gridColumns=l.gridColumns,e.advanceSerachQuery=l.advanceSerachQuery?l.advanceSerachQuery[0]:null,e.isAccessibleUser=r.isAccessibleUser,e.sortableOptions=[{stop:function(){l.gridColumns.forEach(function(e,t){e.order=t+1})}}],e.saveFilterCheckbox=e.selectedFilters.length>0,e.saveColumnCheckbox=e.gridColumns.length>0,e.getFilterLabel=function(e){var t="",a="";return"customFilter"===e.filterType?(t=e.filterLabel?e.filterLabel+": ":"",a=e.label?e.label:e.name):(a=e.label?n("i18n")("console.filter.optionName."+e.label):e.name,e.filterLabel&&(t=n("i18n")("console.filter.name."+e.filterLabel)+": ")),t+a},e.removeFilter=function(t){e.$broadcast(c.PRESET_REMOVE_FILTER,{filterOption:e.selectedFilters[t]}),e.$emit(c.MODAL_FORM_IS_DIRTY)},e.removeColumn=function(t){var a=_.find(l.consoleColumns,function(e){return e.name===l.gridColumns[t].name});a.visible=!1,e.gridColumns.splice(t,1),e.$emit(c.MODAL_FORM_IS_DIRTY)},e.moveColumn=function(t,a){"up"===a&&e.gridColumns[t-1]?(e.gridColumns[t].order=t,e.gridColumns[t-1].order=t+1):"down"===a&&e.gridColumns[t+1]&&(e.gridColumns[t].order=t+1,e.gridColumns[t+1].order=t),e.gridColumns=_.sortBy(e.gridColumns,"order"),e.$emit(c.MODAL_FORM_IS_DIRTY)},e.savePreset=function(){var a=l.getUserSavedPreset(e.filterPresetName);if("columns"===e.filterPresetName)return void s.warning({text:n("i18n")("console.saveFilter.reservedName"),hide:1e4});if(a&&a.id!==g.id)return void s.warning({text:n("i18n")("console.saveFilter.nameConflict"),hide:1e4});if(e.consoleType===EntityVO.TYPE_TICKET)if(e.saveColumnCheckbox){var i=_.filter(e.gridColumns,{type:"custom"});e.selectedFilters=_.filter(e.selectedFilters,function(e){return!("customFilter"===e.filterType&&!_.find(i,{name:e.filterName}))})}else e.selectedFilters=_.reject(e.selectedFilters,{filterType:"customFilter"});e.savingFilterPreset=!0,g.name=e.filterPresetName,l.setFilterPresetData("name",e.filterPresetName),l.setColumnPresetData("name",e.filterPresetName),e.saveFilterCheckbox&&u().then(function(){e.saveColumnCheckbox?p().then(function(){t.close()})["finally"](function(){e.savingFilterPreset=!1}):p(!0).then(function(){t.close()})["finally"](function(){e.savingFilterPreset=!1})})["catch"](function(){s.warning({text:n("i18n")("error.unknown"),hide:1e4}),e.savingFilterPreset=!1})["finally"](function(){l.updateGridData()})},e.disableSubmit=function(){return!e.filterPresetName||!e.saveFilterCheckbox&&!e.saveColumnCheckbox||e.savingFilterPreset||e.selectedFilters.length<2},e.$watch("gridColumns",function(t){e.saveColumnCheckbox=t.length>0},!0),e.close=function(){if(e.updatePresetForm.$dirty){var a=s.modal({title:d.getLocalizedString("common.notification.dirty.title"),text:d.getLocalizedString("common.notification.dirty.message"),buttons:[{text:d.getLocalizedString("common.labels.yes"),data:!0},{text:d.getLocalizedString("common.labels.no"),data:!1}]});a.result.then(function(a){a&&(e.advanceSerachQuery&&g.value.push(e.advanceSerachQuery),t.dismiss())})}else e.advanceSerachQuery&&g.value.push(e.advanceSerachQuery),t.dismiss()},e.$on(c.MODAL_FORM_IS_DIRTY,m),e.$on(c.MODAL_BACKDROP_CLICK,f)}])}(),function(){angular.module("consoleModule").factory("consolePresetModel",["ticketConsoleModel","knowledgeConsoleModel","assetConsoleModel",function(e,t,a){function n(){i.filterConfig=_.reject(i.filterConfig,function(e){return e.expanded=!1,"custom"===e.type});var e=[];_.each(_.cloneDeep(r.customColumnsObjs),function(t){if(i.selectedPreset&&i.selectedPreset.columnValue&&i.selectedPreset.columnValue.hasOwnProperty(t.attributeName)){var a=t.options||t.oldFields.options;a&&(t=r.formatFilterOptionForCustomField(_.cloneDeep(a),t),_.isUndefined(_.find(i.filterConfig,{name:t.name}))&&(t.expanded=!1,e.push(t)))}}),i.filterConfig=_.sortBy(i.filterConfig.concat(e),"name")}var i={},o=["cpu","operatingSystem","processor","rack"],r=null;return i.consoleType="ticket",i.selectedPreset={},i.init=function(o,s){switch(i.selectedPreset=s,i.consoleType=o,o){case EntityVO.TYPE_TICKET:r=e;break;case EntityVO.TYPE_KNOWLEDGE:r=t;break;case EntityVO.TYPE_ASSET:r=a}if(i.filterConfig=_.cloneDeep(r.filterConfig),o===EntityVO.TYPE_TICKET&&n(),i.filterPreferenceGroup=r.filterPreferenceGroup,i.filterDict=_.keyBy(i.filterConfig,"name"),i.applyFilterSet(s.value),i.consoleColumns=angular.copy(_.sortBy(r.columnsConfig,"name")),o===EntityVO.TYPE_TICKET){var l=_.cloneDeep(r.ticketTypeFilter.options),c=_.map(l,"name");_.remove(i.consoleColumns,function(e){if(!angular.isUndefined(e.ticketType)&&0==_.intersection(e.ticketType,c).length)return!0})}i.advanceSerachQuery=_.remove(i.selectedPreset.value,function(e){return"advanceSearchQuery"===e.filter}),i.selectedFilters=_.map(i.selectedPreset.value,function(e){var t=_.find(i.filterDict[e.filter]&&i.filterDict[e.filter].options,{name:e.option});if(t||"dynamic"!==e.type){if(!t){var a=(obj.options||obj.oldFields.options,_.find(r.customColumnsObjs,{name:e.filter}));a&&(a=_.cloneDeep(a),a=r.formatFilterOptionForCustomField(_.cloneDeep(a.options||a.oldFields.options),a),_.isUndefined(_.find(i.filterConfig,{name:a.name}))&&(a.expanded=!1,i.filterConfig.push(a),i.filterConfig=_.sortBy(i.filterConfig,"name"),i.filterDict=_.keyBy(i.filterConfig,"name")),t=_.find(a.options,{name:e.option}))}}else t=e.realOption,i.filterDict[e.filter].options.push(e.realOption);t.active=!0;var n=t.filterName||t.criteria.name,o=i.filterDict[n];return t.filterName=o.name,t.filterLabel=o.label,t});var d=[],u=_.filter(r.columnsConfig,{visible:!0});d=angular.copy(_.filter(r.columnsConfig,function(e){if(i.selectedPreset.columnValue){var t=i.selectedPreset.columnValue[e.name];if(t)return e.order=t.order,e}})),i.selectedPreset.columnValue&&!i.selectedPreset.columnValue.newColumnType&&u.length&&_.forEach(u,function(e){if(!_.find(d,{name:e.name})){var t=angular.copy(e);d.push(t)}}),i.gridColumns=_.sortBy(d,"order"),_.forEach(i.consoleColumns,function(e){_.isObject(e)&&(e.visible=!!_.find(i.gridColumns,{name:e.name}))})},i.getUserSavedPreset=function(e){return _.find(r.userSavedFilterPresets,{name:e})||_.find(r.userSavedColumnPresets,{name:e})},i.setFilterPresetData=function(e,t){_.set(_.find(r.userSavedFilterPresets,{id:i.selectedPreset.id}),e,t),_.set(_.find(r.userSavedPresets,{id:i.selectedPreset.id}),e,t)},i.setColumnPresetData=function(e,t){_.set(_.find(r.userSavedColumnPresets,{id:i.selectedPreset.columnId}),e,t)},i.updateColumnConfig=function(e,t,a){return r.updateColumnConfig(e,t,a)},i.applyFilterSet=function(e){_.forEach(e,function(e){if(i.filterDict[e.filter]){var t=_.find(i.filterDict[e.filter].options,{name:e.option});if(!t&&"dynamic"===e.type)if(t=e.realOption,i.advancedFilterType(t))t.subtype="range",i.filterDict[e.filter].options[0]=t;else{var a=_.find(i.filterDict[e.filter].options,function(e){if(e.criteria&&t.criteria)return _.isEqual(e.criteria,t.criteria)});a?t=a:i.filterDict[e.filter].options.push(t)}angular.isObject(t)&&("dynamic"===e.type&&i.advancedFilterType(t)&&_.forEach(i.filterDict[e.filter].criteriaKeys,function(a){_.forEach(t.criteria.value,function(t){_.isUndefined(t[a.name])||(i.filterDict[e.filter].selectiveClearFilters=!0,a.active=!0,a.fromPreset=!0,a.searchText=t[a.name].value,a.selectedValue=t[a.name].value)})}),t.active=!0)}})},i.advancedFilterType=function(e){return!(!e.criteria||"rack"===e.criteria.name)&&_.includes(o,e.criteria.name)},i.updateGridData=function(){r.getItemList()},i}])}(),function(){angular.module("consoleModule").service("consoleService",["$resource",function(e){var t=e("/smartit/rest/v2/person/workitems/get",{},{getTicketList:{method:"POST",isArray:!0},getKnowledgeList:{url:"/smartit/rest/person/knowledge/get",method:"POST",isArray:!0},getTicketAvailableColumnsList:{url:"/smartit/rest/v2/foundation/consolecolumn/available/search",method:"GET",isArray:!0},consoleRefreshMetadata:{url:"/smartit/rest/v2/foundation/consolecolumn/metadata/refresh",method:"GET",isArray:!0},getTicketStats:{url:"/smartit/rest/v2/foundation/mtcstats/get",method:"POST",isArray:!0},getKnowledgeStats:{url:"/smartit/restapi/foundation/KAStats/get",method:"POST",isArray:!0},saveTicketFilterConfiguration:{url:"/smartit/rest/mtc/preference/:clientType/MTC_FILTER_GROUP",method:"PUT",isArray:!1,transformResponse:function(e){return{id:e}}},saveKnowledgeFilterConfiguration:{url:"/smartit/rest/mtc/preference/:clientType/KAC_FILTER_GROUP",method:"PUT",isArray:!1,transformResponse:function(e){return{id:e}}},saveCIFilterConfiguration:{url:"/smartit/rest/mtc/preference/:clientType/CI_FILTER_GROUP",method:"PUT",isArray:!1,transformResponse:function(e){return{id:e}}},removeFilterConfiguration:{url:"/smartit/rest/mtc/preference/",method:"DELETE",isArray:!1},getAssetList:{url:"/smartit/rest/asset/list/get",method:"POST",isArray:!0},getRelatives:{url:"/smartit/rest/asset/relations",method:"POST",isArray:!0},getRelationshipTypes:{url:"/smartit/rest/asset/relationshiptypes",method:"POST",isArray:!0}});this.getTicketList=function(e){return t.getTicketList(e).$promise.then(function(e){return{itemList:a(e),exceedChunkSize:e[0].items[0].exceedsChunkSize,totalCount:e[0].items[0].totalMatches}})},this.getKnowledgeList=function(e){return t.getKnowledgeList(e).$promise.then(function(e){return{itemList:n(e),exceedChunkSize:e[0].items[0].exceedsChunkSize,totalCount:e[0].items[0].totalMatches}})},this.getTicketAvailableColumnsList=function(){return t.getTicketAvailableColumnsList().$promise.then(function(e){return{itemList:e}})},this.consoleRefreshMetadata=function(){return t.consoleRefreshMetadata().$promise.then(function(e){return{itemList:e}})},this.getTicketStats=function(e,a){return t.getTicketStats({filterCriteria:e,stats:a}).$promise.then(function(e){return e[0].items[0].objects})},this.getKnowledgeStats=function(e,a){return t.getKnowledgeStats({filterCriteria:e,stats:a}).$promise.then(function(e){return e[0].items[0].objects})},this.saveTicketFilterConfiguration=function(e,a){var n={name:e,criteria:a};return t.saveTicketFilterConfiguration({clientType:"SHARED"},n).$promise},this.saveKnowledgeFilterConfiguration=function(e,a){var n={name:e,criteria:a};return t.saveKnowledgeFilterConfiguration({clientType:"SHARED"},n).$promise},this.saveCIFilterConfiguration=function(e,a){var n={name:e,criteria:a};return t.saveCIFilterConfiguration({clientType:"SHARED"},n).$promise},this.removeFilterConfiguration=function(e,a){return t.removeFilterConfiguration({name:e,id:a}).$promise},this.getAssetList=function(e,a){var n={};return a&&(n.source=a),t.getAssetList(n,e).$promise.then(function(e){return{itemList:i(e),exceedChunkSize:e[0].items[0].exceedsChunkSize,totalCount:e[0].items[0].totalMatches}})},this.getRelatives=function(e){return t.getRelatives(e).$promise.then(function(e){var t=o(e);return{relatives:t.relatives,totalCount:0===t.actualCount?0:e[0].items[0].totalMatches-(t.initialCount-t.actualCount)}})},this.getRelationshipTypes=function(e){return t.getRelationshipTypes(e).$promise.then(function(e){return r(e)})};var a=function(e){var t=e[0].items[0].objects||[];return t.map(function(e){return(new TicketConsoleItemVO).build(e)})},n=function(e){var t=e[0].items[0].objects||[];return t.map(function(e){return(new KnowledgeConsoleItemVO).build(e)})},i=function(e){var t=e[0].items[0].objects||[];return t.map(function(e){return(new AssetConsoleItemVO).build(e)})},o=function(e){var t=e[0]&&e[0].items[0]&&e[0].items[0].objects||[],a=t.length,n=_.map(t,function(e){return(new RelationItemVO).build(e)}),i=_.groupBy(n,"relationshipClassId"),o=[];return _.forEach(i,function(e){var t=_.groupBy(e,"realObject.instanceId");_.forEach(t,function(e){for(var t=e.length?e[0]:{},a=1;a<e.length;a++)t.realObject.hasImpact=t.realObject.hasImpact||e[a].realObject.hasImpact,t.realObject.isChild=t.realObject.isChild||e[a].realObject.isChild,t.realObject.isParent=t.realObject.isParent||e[a].realObject.isParent;o.push(t)})}),{initialCount:a,actualCount:o.length,relatives:o}},r=function(e){return _.sortBy(e,"label")}}])}(),function(){angular.module("consoleModule").directive("presetActions",function(){return{restrict:"E",templateUrl:"views/console/preset-actions.html",link:function(e){e.options=!1,e.isDefault=!1,e.setDefault=function(){e.isDefault=!0},e.showOptions=function(){e.options=!0},e.hideOptions=function(){e.options=!1}}}})}(),function(){angular.module("consoleModule").service("ribbonValidationService",["authService","roles","knowledgeConsoleModel","permissionModel",function(e,t,a,n){this.isSameTypeSelected=function(e){return e.length>0&&Object.keys(_.countBy(e,"type")).length<2},this.isSameCompanySelected=function(e){return!e[0].validateCompany||e.length>0&&Object.keys(_.countBy(e,"company.name")).length<2},this.primaryAndOwnerCompanyCheck=function(e){return!e[0].validateCompany||e.length>0&&Object.keys(_.countBy(e,"company.name")).length<2&&Object.keys(_.countBy(e,"author.company.name")).length<2},this.isServiceRequest=function(e){return e[0].type===EntityVO.TYPE_SERVICEREQUEST},this.isValidChangeStatusUpdate=function(e){var t,a,n,i=!0;if(e[0].type===EntityVO.TYPE_CHANGE)for(t=e[0].status.value,a=e[0].processFlowInstanceId,n=1;n<e.length;n++)if(e[n].status.value!==t||e[n].processFlowInstanceId!==a){i=!1;break}return i},this.validateShareButton=function(e){var t,a=!1;return e.length>0&&(this.isSameTypeSelected(e)?a=!0:(t=_.find(e,{type:EntityVO.TYPE_SERVICEREQUEST}),t||(a=!0))),a},this.hasKCSCoachAccess=function(){return!e.isAuthorized(t.ITSM_KCS_COACH_ROLE)||!a.enableAssessment()},this.isRelease=function(e){return e[0].type===EntityVO.TYPE_RELEASE},this.disableBulkUpdate=function(e){return _.find(e,{allowBulkUpdateStatus:!1})},this.anyBypassedTasks=function(e){var t=_.findIndex(e,function(e){return"task"===e.type&&"Bypassed"===e.status.value});return t>-1},this.hasKnowledgeWritePermissions=function(){return n.hasPermission(t.ITSM_KNOWLEDGE_USER_ROLE)},this.isIncidentOrWordorder=function(e){var t=!0;for(var a in e)if(e[a].type!==EntityVO.TYPE_INCIDENT&&e[a].type!==EntityVO.TYPE_WORKORDER||e[a].status&&("Rejected"===e[a].status.value||"Cancelled"===e[a].status.value||"Closed"===e[a].status.value)&&"Yes"!==e[a].needsAttention){t=!1;break}return t}}])}(),function(){angular.module("createTicketModule").controller("CreateActivityController",["$scope","$rootScope","$modal","$modalInstance","createTicketModel","ticketModel","metadataModel","userModel","ticketActionService","systemAlertService","configurationModel","$filter","utilityFunctions",function(e,t,a,n,i,o,r,s,l,c,d,u,p){function m(){e.state={dataIsLoading:!0,searchingPersons:!1},e.draftCreated=!1,e.formContainsInvalidFields=i.formContainsInvalidFields,e.draftTicket=E,e.activityMetadata=v,e.loggedInUserId=s.decodedUserId||s.userId,i.currentTicket=e.draftTicket,y=o.activityParent,y&&(e.draftTicket.summary=y.summary,e.draftTicket.desc=y.desc,e.draftTicket.parentId=y.displayId,e.draftTicket.parentGuid=y.id,e.draftTicket.company=y.company,e.draftTicket.location=y.location,_.isObject(y.milestone)?e.draftTicket.milestone=y.milestone:e.draftTicket.milestone={name:y.milestone},y.noOfRelatedItems[e.draftTicket.milestone.name]?e.draftTicket.sequence=y.noOfRelatedItems[e.draftTicket.milestone.name]+1:e.draftTicket.sequence=1),r.getMetadataByType(EntityVO.TYPE_ACTIVITY).then(function(t){angular.extend(v,t),e.draftTicket.selectedPriority=_.last(v.priorities),e.draftTicket.priority=y.priority?_.find(v.priorities,{name:angular.isObject(y.priority)?y.priority.name:y.priority}):{}})["finally"](function(){e.state.dataIsLoading=!1}),o.getDraft(EntityVO.TYPE_ACTIVITY).then(function(t){t.parentId=e.draftTicket.parentId,t.parentGuid=e.draftTicket.parentGuid,_.isObject(e.draftTicket.company)&&(e.draftTicket.location?e.draftTicket.location.companyName=e.draftTicket.company.name:e.draftTicket.location={companyName:e.draftTicket.company.name},t.location=e.draftTicket.location,t.company=e.draftTicket.company),e.draftTicket=angular.extend(e.draftTicket,t),e.draftCreated=!0})}function f(t,a){var n={supportGroup:e.draftTicket.supportGroup,assignee:e.draftTicket.assignee,company:e.draftTicket.company,locationCompany:e.draftTicket.company,type:EntityVO.TYPE_ACTIVITY};l.showAssignDialog(n,!0,a).result.then(function(e){h(e),t.currentTarget.focus()},function(){t.currentTarget.focus()})}function g(e){var t={};t.assignee={id:e.id,loginId:e.loginId,fullName:e.fullName},t.group={id:e.supportGroupId,name:e.supportGroup,organization:e.organization,company:e.company},h(t)}function h(t){t.autoAssign?(e.draftTicket.autoAssignAssignee=!0,e.draftTicket.assignee={},e.draftTicket.supportGroup={}):(e.draftTicket.autoAssignAssignee=!1,t.assignee&&(e.draftTicket.assignee=t.assignee),t.group&&(e.draftTicket.supportGroup=t.group))}var y,E={today:new Date,type:EntityVO.TYPE_ACTIVITY,autoAssignAssignee:!0,customFields:{},showDates:!1,scheduledStartDatePicker:{open:!1},actualStartDatePicker:{open:!1},scheduledEndDatePicker:{open:!1},actualEndDatePicker:{open:!1}},v={};e.siteOptions={company:{visible:!1,attribute:"companyName"},region:{attribute:"region"},siteGroup:{attribute:"siteGroup"},site:{attribute:"name"}},e.datePickerOptions={startingDay:d.getWeekStartingDay(),"show-weeks":!1,minDate:moment().year(1970).month(0).date(2),maxDate:moment().year(2038).month(0).date(18)},e.showMeridian=window.showMeridian,e.draftCreated=!1,e.getListPersons=function(t,a){return e.state.searchingPersons=!0,i.getList(t,a).then(function(t){return e.state.searchingPersons=!1,t})},e.openDatePicker=function(e,t){e.open=!0,t.stopPropagation()},e.updateDateTime=function(t){if((e.draftTicket[t+"StartDate"]&&!e.draftTicket[t+"StartTime"]||!e.draftTicket[t+"StartDate"]&&e.draftTicket[t+"StartTime"])&&(e.draftTicket[t+"StartTime"]=_.clone(e.draftTicket[t+"StartDate"])),(e.draftTicket[t+"EndDate"]&&!e.draftTicket[t+"EndTime"]||!e.draftTicket[t+"EndDate"]&&e.draftTicket[t+"EndTime"])&&(e.draftTicket[t+"EndTime"]=_.clone(e.draftTicket[t+"EndDate"])),e.draftTicket[t+"StartDate"]&&e.draftTicket[t+"EndDate"]){var a=moment(e.draftTicket[t+"StartTime"]),n=moment(e.draftTicket[t+"StartDate"]).set("hours",a.get("hours")).set("minutes",a.get("minutes")).format("X"),i=moment(e.draftTicket[t+"EndTime"]),o=moment(e.draftTicket[t+"EndDate"]).set("hours",i.get("hours")).set("minutes",i.get("minutes")).format("X");o<n?e.createActivityForm[t+"EndDate"].$setValidity("validScheduledEndDateTime",!1):e.createActivityForm[t+"EndDate"].$setValidity("validScheduledEndDateTime",!0)}!e.draftTicket[t+"StartDate"]&&e.draftTicket[t+"EndDate"]?e.createActivityForm[t+"StartDate"].$setValidity("validScheduledStartDateTime",!1):e.createActivityForm[t+"StartDate"].$setValidity("validScheduledStartDateTime",!0)},e.cancel=function(){n.dismiss()},e.assign=function(t){var a={supportGroup:e.draftTicket.supportGroup,assignee:e.draftTicket.assignee,company:e.draftTicket.company,locationCompany:e.draftTicket.company,type:EntityVO.TYPE_ACTIVITY};l.showAssignDialog(a,!0).result.then(function(a){a.autoAssign?(e.draftTicket.autoAssignAssignee=!0,e.draftTicket.assignee={},e.draftTicket.supportGroup={}):(e.draftTicket.autoAssignAssignee=!1,a.assignee&&(e.draftTicket.assignee=a.assignee),a.group&&(e.draftTicket.supportGroup=a.group)),t.currentTarget.focus()},function(){t.currentTarget.focus()})},e.assignToMe=function(t,a){var n,i="",r=e.draftTicket.supportGroup,s=null,l=e.draftTicket.company;l=l?l.name:"",n=e.draftTicket.customer&&e.draftTicket.customer.company?e.draftTicket.customer.company.name:e.draftTicket.company?e.draftTicket.company.name:"",s=e.draftTicket.location&&e.draftTicket.location.companyName?e.draftTicket.location.companyName:null,o.getTicketAssigneePersonsBySearchText(i,n,s,null,l,null).then(function(e){e=_.uniqBy(e.results,function(e){return e.loginId&&e.supportGroupId});var n=1===e.length?e[0]:_.find(e,{supportGroupId:r.id});n&&n.loginId?g(n):f(t,a)})},e.createActivity=function(){e.state.dataIsLoading=!0,t.timezone&&(e.draftTicket.scheduledStartDate=e.draftTicket.scheduledStartDate?p.convertToUserPreferenceTimezone(e.draftTicket.scheduledStartDate,t.timezone):e.draftTicket.scheduledStartDate,e.draftTicket.scheduledEndDate=e.draftTicket.scheduledEndDate?p.convertToUserPreferenceTimezone(e.draftTicket.scheduledEndDate,t.timezone):e.draftTicket.scheduledEndDate,e.draftTicket.actualStartDate=e.draftTicket.actualStartDate?p.convertToUserPreferenceTimezone(e.draftTicket.actualStartDate,t.timezone):e.draftTicket.actualStartDate,e.draftTicket.actualEndDate=e.draftTicket.actualEndDate?p.convertToUserPreferenceTimezone(e.draftTicket.actualEndDate,t.timezone):e.draftTicket.actualEndDate),i.createActivity().then(function(){n.close(y),e.state.dataIsLoading=!1})["catch"](function(t){e.state.dataIsLoading=!1,c.error({text:t.errorCode?u("i18n")("error.unknown"):t.data.error,clear:!1})})},m()}])}(),function(){angular.module("createTicketModule").controller("createAqiController",["$scope","$q","knowledgeArticleModel","metadataModel","searchModel","createTicketModel","i18nService","systemAlertService",function(e,t,a,n,i,o,r,s){function l(e){var t=_.remove(e,function(e){if(e["delete"])return e.sequenceNo=0,!0});e.forEach(function(e,t){e.sequenceNo=t+1}),Array.prototype.push.apply(e,t)}function c(){var t={"default":"Default",en:"(en) ",es:"(es) ",fr:"(fr) ",he:"(he) ",zh_CN:"(zh) ",it:"(it) ",ko:"(ko) ",de:"(de) ",ru:"(ru) ",ja:"(ja) ",pt_BR:"(pt) ",pl:"(pl)"};return _.forEach(e.knowledgeMetadata.languages,function(e){switch(e.name){case"English":t.en=t.en+e.label;break;case"English-Canadian":t.en_CA=t.en_CA+e.label;break;case"German":t.de=t.de+e.label;break;case"French":t.fr=t.fr+e.label;break;case"French-Canadian":t.fr_CA=t.fr_CA+e.label;break;case"Hebrew":t.he=t.he+e.label;break;case"Italian":t.it=t.it+e.label;break;case"Japanese":t.ja=t.ja+e.label;break;case"Korean":t.ko=t.ko+e.label;break;case"Russian":t.ru=t.ru+e.label;break;case"Chinese":t.zh_CN=t.zh_CN+e.label;break;case"Spanish":t.es=t.es+e.label;break;case"Portuguese":t.pt_BR=t.pt_BR+e.label;break;case"Polish":t.pl=t.pl+e.label}}),t}function d(){e.questionSet.knowledgeQuestionList=e.questionList;var t=_.cloneDeep(e.questionSet);delete t.questionSetId,e.questionSet.organization&&(t.organization={organization:e.questionSet.organization.name}),_.forEach(t.knowledgeQuestionList,function(e){delete e.text,delete e._persistence_shouldRefreshFetchGroup,delete e.isOpen,delete e["delete"],delete e.sequenceNo}),a.createQuestionSet(t).then(function(){e.state.isEditPage=!1,e.state.isClonePage=!1,e.state.isInitialPage=!0,g()})["catch"](function(t){e.state.dataLoading=!1,s.error({text:t.data.detailedMessage||t.data.error,clear:!1})})}function u(){e.questionSet.knowledgeQuestionList=e.questionList;var t=_.cloneDeep(e.questionSet);e.questionSet.organization&&(t.organization={organization:e.questionSet.organization.name}),_.remove(t.knowledgeQuestionList,function(e){if(e["delete"])return e["delete"];for(var t in e.originalTextMap)_.isUndefined(e.textMap[t])&&(e.textMap[t]="");delete e.originalTextMap,delete e.text,delete e._persistence_shouldRefreshFetchGroup,delete e.isOpen,delete e["delete"],delete e.sequenceNo}),_.forEach(t.knowledgeQuestionList,function(){}),a.updateQuestionSet(e.questionSet.questionSetId,t).then(function(){e.state.isEditPage=!1,e.state.isClonePage=!1,e.state.isInitialPage=!0,g()})["catch"](function(t){e.state.dataLoading=!1,s.error({text:t.data.detailedMessage||t.data.error,clear:!1})})}function p(i){var o=a.getQuestionSetById(i),r=n.getMetadataByType("knowledge");t.all([o,r]).then(function(t){e.questionList=t[0],_.forEach(e.questionList,function(e){e.originalTextMap=_.cloneDeep(e.textMap)}),l(e.questionList),e.knowledgeMetadata=t[1],e.supportedLocales=c(),e.state.dataLoading=!1})}function m(){i.getOperatingCompanies(null,-1).then(function(t){e.selections.companies=_.cloneDeep(t.companies),e.state.tooManyCompanies=t.exceedsChunkSize})}function f(t){m(),t.company&&e.loadOrganizations(t.company).then(function(){t.organization&&t.organization.organization&&_.some(e.selections.organizations,function(a){if(a.name===t.organization.organization)return e.questionSet.organization=a,!0})})}function g(){e.state.dataLoading=!0,e.questionList={},e.postValidate=!1;var n=a.getQuestionSetList();t.all([n]).then(function(t){e.questionSetList=t[0][0].items[0].objects,e.state.dataLoading=!1})}e.state={isInitialPage:!0,isEditPage:!1,isClonePage:!1,dataLoading:!1},e.questionSet={questionSetId:"",name:"",company:null,organization:{}},e.selections={},e.questionList={},e.questionSetList=[],e.sortableOptions={stop:function(){l(e.questionList)}},e.knowledgeMetadata={},e.openAction=function(e){e.isOpen=!e.isOpen},e.addNewQuestion=function(){var t=new AssessmentQuestionVO;t.textMap["default"]="",e.questionList||(e.questionList=[]),e.questionList.unshift(t),l(e.questionList),e.closeAllEditors(),e.openAction(t)},e.closeAllEditors=function(){_.forEach(e.questionList,function(e){e.closeItem()})},e.deleteAction=function(t,a){t.stopPropagation(),a.questionId?a.deleteItem():_.remove(e.questionList,function(e){return e.sequenceNo===a.sequenceNo}),l(e.questionList)},e.addLabel=function(t){for(var a in e.supportedLocales)if(!t.textMap.hasOwnProperty(a))return void(t.textMap[a]="")},e.removeLabel=function(e,t){e.removeLabel(t)},e.updateLabel=function(t,a,n){t.textMap[n]=t.textMap[a],e.removeLabel(t,a)},e.getCompaniesByName=function(e){return i.getCompaniesByText(e).then(function(e){return e.companies})},e.editQuestionSet=function(t){e.state.dataLoading=!0,e.state.isInitialPage=!1,e.state.isEditPage=!0,e.state.isClonePage=!1,e.questionSet.name=t.name,e.questionSet.company=t.company,e.questionSet.questionSetId=t.id,p(t.id),f(t)},e.cloneQuestionSet=function(t){e.state.dataLoading=!0,e.state.isInitialPage=!1,e.state.isEditPage=!1,e.state.isClonePage=!0,p(t),m()},e.deleteQuestionSet=function(n){var i=s.modal({title:r.getLocalizedString("common.notification.delete.aqi.title"),text:r.getLocalizedString("common.notification.delete.aqi.message"),buttons:[{text:r.getLocalizedString("common.labels.yes"),data:{questionSetId:n}},{text:r.getLocalizedString("common.labels.no")}]});i.result.then(function(i){if(!_.isEmpty(i)){e.state.dataLoading=!0;var o=a.deleteQuestionSetById(i.questionSetId);t.when(o).then(function(){_.remove(e.questionSetList,function(e){return e.id===n}),e.state.dataLoading=!1})["catch"](function(t){e.state.dataLoading=!1,s.error({text:t.data.detailedMessage||t.data.error,clear:!1})})}})},e.onSaveClick=function(){e.state.dataLoading=!0,e.state.isEditPage?u():e.state.isClonePage&&d()},e.onCancelClick=function(){e.state.dataLoading=!1,e.state.isEditPage=!1,e.state.isClonePage=!1,e.state.isInitialPage=!0,e.questionSet={},e.questionList={};var n=a.getQuestionSetList();t.all([n]).then(function(t){e.questionSetList=t[0][0].items[0].objects,e.state.dataLoading=!1})},e.openConfigureQuestionsPage=function(){var t="";_.findIndex(e.questionSetList,function(e){e.isDefault&&(t=e.id)}),e.cloneQuestionSet(t)},e.loadOrganizations=function(t){return o.getList(EntityVO.TYPE_ORGANIZATION,{companyName:t.name}).then(function(t){e.state.organizationsLoading=!1,e.selections.organizations=t.objects,e.questionSet.organization=null})},g()}])}(),function(){angular.module("createTicketModule").controller("CreateAssetController",["$scope","$modal","$state","$timeout","createTicketModel","screenConfigurationModel","ticketModel","i18nService","systemAlertService","categoriesService","$q","metadataModel","searchModel","assetModel","$filter","events","searchService","configurationModel",function(e,t,a,n,i,o,r,s,l,c,d,u,p,m,f,g,h,y){function E(){var t=u.getMetadataByType(EntityVO.TYPE_ASSET).then(function(t){angular.extend(R,t),D.selectedStatus=_.find(R.statuses,{name:"Deployed"}),e.updateStatusReason(),e.metadata=R,R.assetTypes=_.sortBy(R.assetTypes,"label"),_.forEach(R.assetTypes,function(e){e.subType=_.sortBy(e.subType,"label")}),D.selectedDepreciation=_.head(R.depreciated),p.getOperatingCompanies(null,-1).then(function(t){e.selections.companies=_.cloneDeep(t.companies),e.state.tooManyCompanies=t.exceedsChunkSize,e.setCompany(_.find(t.companies,{name:R.systemConfigurations.defaultCompany}))})}),a=o.loadScreenConfigurationAndCustomFieldLabels(ScreenConfigurationVO.prototype.ASSET_SCREEN,EntityVO.TYPE_ASSET);d.all([t,a]).then(function(){D.allCategories=_.cloneDeep(c.populateCategories([{name:"product",tiers:{}}],R));var t=o.getEditableFieldsForScreen(ScreenConfigurationVO.prototype.ASSET_SCREEN);e.customFields=angular.copy(t),e.genericCustomFields=[],e.typeSpecificCustomFields=[],_.forEach(e.customFields,function(t){"assetScreen.generic"===t.panelId?e.genericCustomFields.push(t):e.typeSpecificCustomFields.push(t)}),e.getPrimaryCapabilitiesByName("",!0).then(function(t){e.primaryCapabilities=t.list}),D.selectedType=_.find(R.assetTypes,{name:"Computer System"}),e.updateType()})["finally"](function(){e.state.dataIsLoading=!1})}function v(){e.state={dataIsLoading:!0,selectType:!0,tooManyCompanies:!1},e.selections={companies:[]},e.datePickerOptions={startingDay:y.getWeekStartingDay(),"show-weeks":!1,minDate:moment().year(1970).month(0).date(2),maxDate:moment().year(2038).month(0).date(18)},e.assetDate={availableDatePicker:{open:!1},installationDatePicker:{open:!1},returnDatePicker:{open:!1},receivedDatePicker:{open:!1},lastScanDatePicker:{open:!1},purchaseDatePicker:{
open:!1},disposalDatePicker:{open:!1}},e.formContainsInvalidFields=i.formContainsInvalidFields,i.currentTicket=D,e.asset=D,e.assetMetadata=R,e.isNew=!0,C(),b(),e.capabilityList=[],m.getCapabilityListByName("",2e3).then(function(t){e.capabilityList=t.items}),e.siteOptions={company:{visible:!1,attribute:"companyName"},region:{attribute:"region"},siteGroup:{attribute:"siteGroup"},site:{attribute:"name"}},e.siteSelected={companyName:e.asset.company?e.asset.company.name:""}}function T(){D.selectedSubtype.putIntoInventory?e.statuses=_.filter(R.statuses,function(e){return e.name!==EntityVO.STATUS_IN_INVENTORY}):e.statuses=_.cloneDeep(R.statuses)}function S(){return e.createAssetForm.$dirty}function C(){e.$on("$stateChangeStart",function(t,n,o){if(!P&&S()&&n.name!==EntityVO.TYPE_ASSET){t.preventDefault();var r=l.modal({title:s.getLocalizedString("common.notification.dirty.title"),text:s.getLocalizedString("common.notification.dirty.message"),buttons:[{text:s.getLocalizedString("common.labels.yes"),data:{stateName:n.name,stateParams:o}},{text:s.getLocalizedString("common.labels.no")}]});r.result.then(function(t){_.isEmpty(t)||(i.currentTicket=D={},e.createAssetForm.$setPristine(),a.transitionTo(t.stateName,t.stateParams))})}})}function O(e){var t=l.modal({title:"",text:s.getLocalizedStringwithParams("create.asset.success.reconciliationDelayBanner",[e]),buttons:[{text:s.getLocalizedString("controls.action.ok")}]});t.result.then(function(){P=!0,a.go("dashboard")})}function A(){D.allCategories&&_.forEach(D.allCategories[0].listOfTiers,function(e){e.selectedValue=""})}function I(){D.hostName="",D.primaryCapability=null,D.capabilityList="",D.selectedSystemType=null,D.selectedVirtualSystemType=null,w=[]}function b(){D={type:EntityVO.TYPE_ASSET,advancedType:"Computer System",classId:"",customFields:{},availableDate:{date:void 0,time:void 0},installationDate:{date:void 0,time:void 0},returnDate:{date:void 0,time:void 0},receivedDate:{date:void 0,time:void 0},lastScanDate:{date:void 0,time:void 0},purchaseDate:{date:void 0,time:void 0},disposalDate:{date:void 0,time:void 0},ticketType:EntityVO.TYPE_ASSET},I(),i.currentTicket=D,e.asset=D,E(),e.$broadcast(g.CLEAR_DESC),e.$broadcast(g.DISCARD_CHANGES),e.createAssetForm&&e.createAssetForm.$setPristine()}function k(){e.validTypeCustomFields=_.filter(e.typeSpecificCustomFields,function(e){return delete D.customFields[e.name],_.includes(_.map(e.extension,"classId"),D.selectedSubtype.name)})}if(!y.isServerApplicationEnabled(EntityVO.TYPE_ASSET))return void a.go("unauthorized");var D={type:EntityVO.TYPE_ASSET,advancedType:"Computer System",classId:"",customFields:{},availableDate:{date:void 0,time:void 0},installationDate:{date:void 0,time:void 0},returnDate:{date:void 0,time:void 0},receivedDate:{date:void 0,time:void 0},lastScanDate:{date:void 0,time:void 0},purchaseDate:{date:void 0,time:void 0},disposalDate:{date:void 0,time:void 0},ticketType:EntityVO.TYPE_ASSET},R={},P=!1,w=[];e.isCapabilityChecked=function(e){return w.indexOf(e.value)>-1},e.addCapability=function(t){var a=w.indexOf(t.value);a>-1?w.splice(a,1):w.push(t.value),D.capabilityList=e.getCapabilities()},e.getCapabilities=function(){return w.length?w.join("; "):f("i18n")("common.button.select")},e.getPrimaryCapabilitiesByName=function(t,a){return o.loadDynamicSelectionFieldLabels(EntityVO.TYPE_ASSET,"SHR:SDF:AST-Capabilities",t,null,null,null,null,!0).then(function(t){return a&&(e.state.tooManyPrimaryCapabilities=t.exceedsChunkSize),{list:t.items,exceedsChunkSize:t.exceedsChunkSize}})},e.openDatePicker=function(e){e.open=!0},e.updateDateTime=function(e){(D[e].date&&!D[e].time||!D[e].date&&D[e].time)&&(D[e].time=_.clone(D[e].date));var t=moment(D[e].time);D[e].value=moment(D[e].date).set("hours",t.get("hours")).set("minutes",t.get("minutes")).valueOf()},e.updateAssetField=function(e,t){return"depreciated"===e?void(D[e]=t.index):void(D[e]=t.name)},e.getSelectedTypeObject=function(e,t){return _.find(R[e],{name:t})},e.getCostCentersByCompany=function(t){return e.loadingCostCenters=!0,m.getCostCentersByCompanyName(t,D.company.name).then(function(t){return e.isTooltipOpenCostCenter=e.showTooManyResultsMessage=t.exceedsChunkSize,n(function(){e.isTooltipOpenCostCenter=!1},1e4),t.items})["finally"](function(){e.loadingCostCenters=!1})},e.hideTooManyResultsMessage=function(){e.isTooltipOpenCostCenter=!1,e.isTooltipOpenManufacturer=!1,e.isTooltipOpenSupplier=!1},e.updateCostCenter=function(e){m.costCenter=e.value},e.updateType=function(){D.selectedSubtype=D.selectedType.name===D.advancedType?_.find(D.selectedType.subType,{name:"BMC_COMPUTERSYSTEM"}):_.head(D.selectedType.subType),D.classId=D.selectedSubtype.name,A(),I(),k(),T()},e.updateSubtype=function(){D.classId=D.selectedSubtype.name,A(),I(),k(),T()},e.showAssetForm=function(t){e.state.selectType=!t,t||b()},e.setCompany=function(t){D.company=t,D.customer={company:t},e.siteSelected={companyName:t?t.name:""}},e.getList=function(e,t){return i.getList(e,t)},e.getCompaniesByName=function(e){return p.getCompaniesByText(e).then(function(e){return{list:e.companies,exceedsChunkSize:e.exceedsChunkSize}})},e.getCompaniesByType=function(t,a){return p.getCompaniesByText(t,-1,{companyType:a}).then(function(t){return"Supplier"===a?e.isTooltipOpenSupplier=e.exceedsChunkSizeSupplier=t.exceedsChunkSize:"Manufacturer"===a&&(e.isTooltipOpenManufacturer=e.exceedsChunkSizeManufacturer=t.exceedsChunkSize),n(function(){e.isTooltipOpenManufacturer=!1,e.isTooltipOpenSupplier=!1},1e4),t.companies})},e.setCompanyByType=function(e,t){D[t]=e},e.clearValuesByType=function(e){D[e]=null},e.createAsset=function(){e.state.dataIsLoading=!0,e.siteSelected.name&&(D.siteName=e.siteSelected.name),e.siteSelected.siteGroup&&(D.siteGroup=e.siteSelected.siteGroup),e.siteSelected.region&&(D.siteRegion=e.siteSelected.region),i.createAsset().then(function(t){t&&(t.error?(e.state.dataIsLoading=!1,l.error({text:t.error,clear:!0})):t.assetName&&O(t.assetName))})["finally"](function(){e.state.dataIsLoading=!1})},e.cancel=function(){a.go("dashboard")},e.updateStatusReason=function(){D.selectedStatusReason={}},e.$on(g.ASSET_UPDATE_PRODUCT_CATEGORY_MANUFACTURER,function(e,t){D.manufacturer=t.productManufacturer}),e.$watch("selected.region",function(t){t?(e.selected.siteGroup&&e.selected.siteGroup.attributeMap&&e.selected.siteGroup.attributeMap.regionName!==t.name&&(e.selected.siteGroup=null),e.selected.site&&e.selected.site.attributeMap&&e.selected.site.attributeMap.regionName!==t.name&&(e.selected.site=null),e.loadSiteGroups(),e.loadSites()):e.selected&&(e.selected.siteGroup="",e.selected.site="",e.loadSiteGroups(),e.loadSites())}),e.$watch("selected.siteGroup",function(t){t?(e.selected.region={name:t.attributeMap.regionName},e.selected.site&&e.selected.site.attributeMap&&e.selected.site.attributeMap.siteGroupName!==t.name&&(e.selected.site=null)):e.selected&&(e.selected.site="")}),e.$watch("selected.site",function(t){t&&(e.selected.siteGroup={name:t.attributeMap.siteGroupName,attributeMap:{regionName:t.attributeMap.regionName}},D.siteName=t.name,D.siteRegion=t.attributeMap.regionName,D.siteGroup=t.attributeMap.siteGroupName)}),e.$watch("siteSelected",function(t){t.region&&(e.asset.siteRegion=t.region),t.siteGroup&&(e.asset.siteGroup=t.siteGroup),t.name&&(e.asset.siteName=t.name),t.companyName&&(e.asset.companyName=t.companyName)}),e.loadRegions=function(){if(e.selections.regions=null,e.state.regionsLoading=!0,e.selected&&(e.selected.siteGroup="",e.selected.region="",e.selected.site=""),e.asset.company&&e.asset.company.name){var t={companyName:e.asset.company.name,chunkInfo:{startIndex:0,chunkSize:p.regionChunkSize}};i.getList(EntityVO.TYPE_REGION,t).then(function(t){e.state.regionsLoading=!1,e.selections.regions=t.objects,e.state.tooManyRegions=t.exceedsChunkSize})}},e.loadSiteGroups=function(){if(e.selections.siteGroups=null,e.state.siteGroupsLoading=!0,e.asset.company&&e.asset.company.name){var t={companyName:e.asset.company.name,chunkInfo:{startIndex:0,chunkSize:p.siteGroupChunkSize}};void 0!==e.selected&&e.selected.region?t.regionName=e.selected.region.name:t.regionName="",i.getList(EntityVO.TYPE_SITE_GROUP,t).then(function(t){e.state.siteGroupsLoading=!1,e.selections.siteGroups=t.objects,e.state.tooManySiteGroups=t.exceedsChunkSize})}},e.loadSites=function(){if(e.selections.sites=null,e.state.sitesLoading=!0,e.asset.company&&e.asset.company.name){var t={companyName:e.asset.company.name,chunkInfo:{startIndex:0,chunkSize:p.siteChunkSize}};void 0!==e.selected&&e.selected.region?t.regionName=e.selected.region.name:t.regionName="",void 0!==e.selected&&e.selected.siteGroup?t.siteGroupName=e.selected.siteGroup.name:t.siteGroupName="",i.getList(EntityVO.TYPE_SITE,t).then(function(t){e.state.sitesLoading=!1,e.selections.sites=t.objects,e.state.tooManySites=t.exceedsChunkSize})}},v()}])}(),function(){angular.module("createTicketModule").controller("CreateBroadcastController",["$scope","$state","configurationModel","createTicketModel","i18nService","systemAlertService","metadataModel","$timeout","$filter",function(e,t,a,n,i,o,r,s,l){function c(){e.state={dataIsLoading:!1},e.isNew=!0,e.formContainsInvalidFields=n.formContainsInvalidFields,n.currentTicket=m,e.broadcast=m,e.broadcastMetadata=u={},e.datePickerOptions={startingDay:a.getWeekStartingDay(),"show-weeks":!1,minDate:moment().year(1970).month(0).date(2),maxDate:moment().year(2038).month(0).date(18)},d(),r.getMetadataByType(EntityVO.TYPE_BROADCAST).then(function(e){angular.extend(u,e),m.priority=_.last(u.priorities),m.broadcastType=_.last(u.types),m.visibility=_.last(u.visibilities)})}function d(){e.$on("$stateChangeStart",function(a,r,s){if(!m.hasCreated&&f()&&r.name!==EntityVO.TYPE_BROADCAST){a.preventDefault();var l=o.modal({title:i.getLocalizedString("common.notification.dirty.title"),text:i.getLocalizedString("common.notification.dirty.message"),buttons:[{text:i.getLocalizedString("common.labels.yes"),data:{stateName:r.name,stateParams:s}},{text:i.getLocalizedString("common.labels.no")}]});l.result.then(function(a){_.isEmpty(a)||(n.currentTicket=m={},e.createBroadcastForm.$setPristine(),t.transitionTo(a.stateName,a.stateParams))})}})}var u,p=(new Date).getTime(),m={today:p,hasCreated:!1,broadcastStartDatePicker:{open:!1},broadcastEndDatePicker:{open:!1},type:EntityVO.TYPE_BROADCAST};e.getList=function(t,a){return n.getList(t,a).then(function(t){return e.state.exceedsAudienceChunkSize=t.exceedsChunkSize,e.state.isAudienceTooltipOpen=t.exceedsChunkSize,s(function(){e.state.isAudienceTooltipOpen=!1},1e4),t.list})},e.closeTooltip=function(){e.state.isAudienceTooltipOpen=!1},e.$watch("broadcast.audience",function(t){t&&_.isObject(t)?(t.attributeMap&&t.attributeMap.companyName?(m.siteName=t.name,m.companyName=t.attributeMap.companyName):(m.companyName=t.name,m.siteName=""),e.createBroadcastForm.audience.$setValidity("audience",!0)):e.createBroadcastForm.audience.$setValidity("audience",!1)}),e.clearAudience=function(){m.siteName?(m.siteName="",m.companyName=""):m.companyName&&(m.companyName=""),m.audience=""},e.updateDateTime=function(t){if(t&&(m[t+"Date"]&&!m[t+"Time"]||!m[t+"Date"]&&m[t+"Time"])&&(m[t+"Time"]=_.clone(m[t+"Date"])),m.broadcastStartDate&&m.broadcastEndDate){var a=moment(m.broadcastStartTime),n=moment(m.broadcastStartDate).set("hours",a.get("hours")).set("minutes",a.get("minutes")).format("X"),i=moment(m.broadcastEndTime),o=moment(m.broadcastEndDate).set("hours",i.get("hours")).set("minutes",i.get("minutes")).format("X");o<=n?e.createBroadcastForm.broadcastEndDate.$setValidity("validEndDateTime",!1):e.createBroadcastForm.broadcastEndDate.$setValidity("validEndDateTime",!0)}!m.broadcastStartDate&&m.broadcastEndDate?e.createBroadcastForm.broadcastStartDate.$setValidity("validStartDateTime",!1):e.createBroadcastForm.broadcastStartDate.$setValidity("validStartDateTime",!0)},e.createBroadcast=function(){e.state.dataIsLoading=!0,n.createBroadcast().then(function(){m.hasCreated=!0,s(function(){o.success({text:i.getLocalizedString("create.broadcast.created"),hide:1e4})}),t.go("dashboard")})["catch"](function(t){e.state.dataIsLoading=!1,o.error({text:t.errorCode?l("i18n")("error.unknown"):t.data.error,clear:!1})})},e.cancel=function(){t.go("dashboard")},e.openDatePicker=function(e){e.open=!0};var f=function(){return e.createBroadcastForm.$dirty||!_.isEmpty(m.attachments)};c()}])}(),function(){angular.module("createTicketModule").controller("CreateIncidentV2Controller",["$scope","$element","$modal","$state","$filter","$log","createTicketModel","screenConfigurationModel","ticketModel","i18nService","systemAlertService","categoriesService","$q","metadataModel","ticketActionService","events","fieldValidationModel","userModel","permissionModel","roles","layoutConfigurationModel","objectValueMapperService","$timeout",function(e,t,a,n,i,o,r,s,l,c,d,u,p,m,f,g,h,y,E,v,T,S,C){function O(){e.state={showSpinner:!0,dataIsLoading:!0},e.statusValue="",e.editMode=!0,e.isNew=!0,e.formContainsInvalidFields=r.formContainsInvalidFields,r.currentTicket=D,e.incident=D,e.incidentMetadata=R,e.loggedInUserId=y.userId,S.clearMap(D.type),I();var a=m.getMetadataByType(EntityVO.TYPE_INCIDENT).then(function(t){angular.extend(R,t),D.serviceType=_.head(R.types).name;var a=_.head(R.statuses);D.status={value:a.name},!_.isEmpty(a.statusReasons)&&e.isFieldRequired("statusReason")&&(D.status.statusReason=_.head(a.statusReasons).name),D.impact=_.last(R.impacts).name,D.urgency=_.last(R.urgencies).name,D.priority=_.last(R.priorities).name}),n=l.getDraft(EntityVO.TYPE_INCIDENT).then(function(e){D.id=e.id,D.displayId=e.displayId,D.accessMappings=e.accessMappings,D.categorizations=e.categorizations,D.resCategorizations=e.resCategorizations,D.categorizations.push(_.find(D.resCategorizations,{name:"resolutionProduct"})),D.categorizations.push(_.find(D.resCategorizations,{name:"resolution"}))}),i=ScreenConfigurationVO.prototype.CREATE_INCIDENT_SCREEN,o=T.loadScreenLayout(i),c=s.loadScreenConfigurationAndCustomFieldLabels(i,EntityVO.TYPE_INCIDENT);p.all([a,n,o,c]).then(function(a){e.state.dataIsLoading=!1,e.state.showSpinner=!1,D.allCategories=_.cloneDeep(u.populateCategories(D.categorizations,R)),D.resCategories=_.cloneDeep(u.populateCategories(D.resCategorizations,R)),e.screenLayout=a[2];var n=s.getEditableFieldsForScreen(i);e.customFields=angular.copy(n),C(function(){e.createIncidentForm.$setPristine(),e.$watch("createIncidentForm.$error.required.length",function(a){console.log("Create Incident Form Required Fields Pending: "+a||"0"),a&&e.createIncidentForm.$error.required.forEach(function(e){console.log("Field Name: "+e.$name)});var n=t.find("[ng-form=createIncidentForm] .ng-invalid").toArray();n&&n.length&&(console.log("Create Incident Form Invalid Fields: "),n.forEach(function(e){console.log("Name: "+e.name+" ux-id: "+e.getAttribute("ux-id"))}))})},0)})}function A(){return e.createIncidentForm.$dirty&&!e.createIncidentForm.$pristine||!_.isEmpty(D.attachments)}function I(){e.$on("$stateChangeStart",function(t,a,i){if(A()&&a.name!==EntityVO.TYPE_INCIDENT){t.preventDefault();var o=d.modal({title:c.getLocalizedString("common.notification.dirty.title"),text:c.getLocalizedString("common.notification.dirty.message"),buttons:[{text:c.getLocalizedString("common.labels.yes"),data:{stateName:a.name,stateParams:i}},{text:c.getLocalizedString("common.labels.no")}]});o.result.then(function(t){_.isEmpty(t)||(r.currentTicket=D={},e.createIncidentForm.$setPristine(),n.transitionTo(t.stateName,t.stateParams))})}})}function b(t,a){var n=!1,i=a.originalEvent,r=!a.saveSelection;if(!a)return void o.warn("Could not open assignment blade. Required Event data is missing. ");var s="ticketassignee";n=!!a.assignToMe,n?f.assignToMe(i,s,r,e.incident,e):f.assign(i,r,e.incident,e,s)}function k(t){e.incident.CIRequiredOnResolved&&"Resolved"==e.statusValue?e.$broadcast(g.SERVICECI_REQUIRED,{isRequired:!0,name:"causalCI"}):e.$broadcast(g.SERVICECI_REQUIRED,{isRequired:!1,name:"causalCI"}),e.incident.applyCognitiveForSupportGroup&&e.$broadcast(g.APPLY_COGNITIVE_SG,{applyCognitive:e.incident.applyCognitiveForSupportGroup})}var D={type:EntityVO.TYPE_INCIDENT,autoAssign:!0,customFields:{}},R={};e.createIncident=function(){e.state.showSpinner=!0;var t=r.collectTicketChanges(R);t.summary=t.summary&&t.summary.replace(/\u00a0/g," "),r.createIncidentV2(t)["catch"](function(e){e&&C(function(){d.error({text:e.data&&e.data.error||e,clear:!1,displayOnStateChange:!0})})})["finally"](function(){e.state.showSpinner=!1})},e.cancel=function(){n.go("dashboard")},e.isFieldRequired=function(e){return h.isFieldRequired(D.type,D.status.value,"",e)},m.getMetadataByType("global").then(function(e){var t="T"===e.configurationParameters["Enable-Progressive-Views"]||"true"===e.configurationParameters["Enable-Progressive-Views"];t="T"!==localStorage.getItem("overridePV")&&t,t&&localStorage.getItem("midtierUrl")?n.go(n.current.name+"PV"):O()})["catch"](function(e){e&&d.error({text:e.data.error,clear:!1})}),e.$on(g.WIDGET_VALUE_CHANGE,function(t,a){a.fieldName===EntityVO.TYPE_STATUS&&(e.statusValue=a.fieldValue,k(a))}),e.$on(g.COMPANY_VALUE_CHANGED,function(t,a){k(),e.incident.serviceCIRequired?e.$broadcast(g.SERVICECI_REQUIRED,{isRequired:!0,name:"impactedService"}):e.$broadcast(g.SERVICECI_REQUIRED,{isRequired:!1,name:"impactedService"})}),e.$on(g.SHOW_ASSIGN_TICKET_BLADE,b),e.$on(g.CUSTOM_FIELD_VALUE_CHANGE,function(){e.$broadcast(g.REFRESH_FIELD_VALUES)})}])}(),function(){angular.module("createTicketModule").controller("CreateKnowledgeArticleController",["$scope","localStorageService","$modal","searchService","relationModel","$state","$timeout","systemAlertService","attachmentService","metadataModel","categoriesService","knowledgeArticleModel","ticketModel","$q","$filter","configurationModel",function(e,t,a,n,i,o,r,s,l,c,d,u,p,m,f,g){function h(){F=angular.extend(F,{dataIsLoading:!1,isTemplateSelected:!1,isTemplateAccepted:!1,rememberTemplate:!1,showMetadata:!0,loadingMergeWindow:!1,showingMergeTool:!1,similarArticles:[],showSimilarArticles:!1,loadVisibility:!1,loadingSimilarArticles:!1,similarArticlePromise:null,allowStateChange:!1}),e.attachments=[],e.linkedItems=[],e.titleMaxLength=4e3}function y(){return F.dataIsLoading=!0,u.getKnowledgeArticleTemplates().then(function(t){return e.templates=angular.copy(t),_.remove(e.templates,{name:"Decision Tree"}),t})["finally"](function(){F.dataIsLoading=!1})}function E(){var t=c.getMetadataByType(EntityVO.TYPE_KNOWLEDGE),a=u.getDraft(e.selectedTemplate.id,e.articleContext),n=c.getMetadataByType(EntityVO.TYPE_GLOBAL);return F.dataIsLoading=!0,m.all([t,a,n]).then(function(t){N=t[0],angular.extend(V,t[1]),e.knowledgeAnchorParser=t[2].configurationParameters.knowledgeAnchorParser,e.article.categoriesControls=_.cloneDeep(d.populateCategories(e.article.defaultCategorization,N)),e.article.categoriesSet=_.cloneDeep(d.populateMultipleCategories(e.article.allCategories,N)),Y=_.cloneDeep(e.article),_.forEach(e.article.content,function(e){e.snippet&&(e.snippet=_.compact(e.snippet.split("\n")).join("<br>"))})})["finally"](function(){F.dataIsLoading=!1})}function v(e){F.rememberTemplate=!1,t.set(x,{templateId:e,user:G})}function T(){return O({input:e.article.content,output:_.cloneDeep(e.selectedTemplate.templateObject.sections),outputTitle:["create.knowledge.merge.change.output.title"],inputTitle:["create.knowledge.merge.change.input.title.first","create.knowledge.merge.change.input.title.second"]}).then(function(e){return e})}function S(e,t){F.allowStateChange=!0,o.go("knowledge",{id:e,content:t,editMode:!0})}function C(e){for(var t=0;t<e.length;t++){var a=e[t].snippet;if(a){var n=/ng-click="scrollToAnchor\(\$event, &quot;(.+?)&quot;\)"/g,i="ng-click=\"scrollToAnchor($event, '$1')\"";a=a.replace(n,i);var o=/<a href=".*?#(.+?)" ng-click="scrollToAnchor\(\$event, '(.+?)'\)"/g,r='<a href="#$1"';e[t].snippet=a.replace(o,r)}}return e}function O(t){var n=e;return a.open({templateUrl:"views/knowledge-article/article-merge-tool.html",controller:["$scope","$modalInstance","mergeParams",function(e,t,a){e.input={content:a.input},e.output={content:a.output,uuid:a.uuid},e.outputTitle=a.outputTitle||[],e.inputTitle=a.inputTitle||[],e.knowledgeAnchorParser=n.knowledgeAnchorParser,e.merge=function(){var a=C(e.output.content);t.close(a)},n.$on("$destroy",t.close)}],windowClass:"modal_article-merge-tool",backdrop:!1,keyboard:!1,resolve:{mergeParams:function(){return t}}}).result}function A(e){t.set(z,e)}function I(t){return i.addRelation({uuid:t.id,type:EntityVO.TYPE_KNOWLEDGE},_.map(e.linkedItems,function(e){return _.omit(e,["realObject","isPoi"])}))}function b(t){return l.uploadAttachment(t.type,t.id,e.attachments)}function k(){var e=s.modal({type:"info",title:f("i18n")("common.notification.dirty.title"),text:f("i18n")("common.notification.dirty.loseChanges"),buttons:[{text:f("i18n")("common.button.yes"),data:!0},{text:f("i18n")("common.button.no"),data:!1}]});return e.result}function D(){return P()||R()||w()}function R(){var e=L();return!angular.equals(Y.content,e)}function P(){return V.title&&V.title.trim()}function w(){var e=_.omit(V,["categoriesControls","content","title"]),t=_.omit(V,["categoriesControls","content","title"]);return!angular.equals(e,t)}function L(){var e=_.cloneDeep(V.content);return _.map(e,function(e){return e.snippet=$(e.snippet).text(),e})}if(!g.isServerApplicationEnabled(EntityVO.TYPE_KNOWLEDGE))return void o.go("unauthorized");e.editMode=!0;var N,M,V={},F={},x="DEFAULT_KA_TEMPLATE",G=t.get("user.userId"),B=t.get(x),U=B&&B.user===G?B.templateId:null,z="LAST_SET_OF_VISIBILITY_GROUPS",Y={};h(),y().then(function(){U&&(e.selectedTemplate=_.find(e.templates,{id:U}),E().then(function(){F.isTemplateSelected=!0,F.isTemplateAccepted=!0}))}),e.selectTemplate=function(t){F.isTemplateSelected=!0,e.selectedTemplate=_.cloneDeep(t)},e.backToTemplateSelection=function(){e.selectedTemplate=null,F.isTemplateSelected=!1,F.rememberTemplate=!1},e.acceptTemplate=function(){E().then(function(){v(F.rememberTemplate?e.selectedTemplate.id:null),F.isTemplateAccepted=!0})},e.mergeAndAcceptTemplate=function(){var t="",a=_.cloneDeep(V);T().then(function(a){return e.previousTemplate=null,t=a,F.dataIsLoading=!0,u.getDraft(e.selectedTemplate.id)}).then(function(n){angular.extend(V,u.mergeArticleMetaData(n,a,t)),v(F.rememberTemplate?e.selectedTemplate.id:null),F.isTemplateAccepted=!0})["finally"](function(){F.dataIsLoading=!1})},e.changeTemplate=function(){F.isTemplateSelected=!1,F.isTemplateAccepted=!1,e.previousTemplate=_.cloneDeep(e.selectedTemplate),v(null),y()},e.clearTitle=function(){e.article.title="",e.onKnowledgeTitleChange()},e.onKnowledgeTitleChange=function(e){F.similarArticles=[],F.loadingSimilarArticles=!1,M&&r.cancel(M),e&&e.length>=3&&(M=r(function(){F.loadingSimilarArticles=!0,F.similarArticlePromise&&F.similarArticlePromise["finally"](function(){F.loadingSimilarArticles=!0,F.similarArticles=[]}),F.similarArticlePromise=u.findArticleByText({search_text:e}).then(function(e){F.similarArticles=e,_.remove(F.similarArticles,{templateName:"Decision Tree"})})["finally"](function(){F.loadingSimilarArticles=!1})},1e3))},e.mergeSimilarArticle=function(t){F.dataIsLoading=!0,u.getKnowledgeArticleById(t).then(function(t){return F.dataIsLoading=!1,F.showingMergeTool=!0,O({uuid:e.article.articleGUID,input:t.content,output:_.cloneDeep(V.content),outputTitle:["create.knowledge.merge.output.title"],inputTitle:["create.knowledge.merge.input.title.first","create.knowledge.merge.input.title.second"]})}).then(function(e){V.content=e})["finally"](function(){F.showingMergeTool=!1})},e.updateSimilarArticle=function(e){F.dataIsLoading=!0,u.getKnowledgeArticleById(e).then(function(e){return F.dataIsLoading=!1,e.accessMappings.detailsEditAllowed?(F.showingMergeTool=!0,O({input:_.cloneDeep(V.content),output:_.cloneDeep(e.content),outputTitle:["create.knowledge.merge.instead.output.title"],inputTitle:["create.knowledge.merge.instead.input.title.first","create.knowledge.merge.instead.input.title.second"]})):(s.info({text:f("i18n")("create.knowledge.similar.edit.instead.deny")}),m.reject())}).then(function(t){S(e,t)})["finally"](function(){F.showingMergeTool=!1})},e.handleFileChange=function(t){var a=l.prepareFileToUpload({fileInput:t});return a&&a.size<=0?void s.warning({text:f("i18n")("attachment.file_empty"),icon:"icon-exclamation_triangle",clear:!0,hide:5e3}):void(a&&(e.attachments?e.attachments.push(a):e.attachments=[a]))},e.dismissAttachment=function(t,a){var n=e.attachments.indexOf(a);n>=0&&e.attachments.splice(n,1),t.stopImmediatePropagation()},e.addLinkedItem=function(t){var n=a.open({templateUrl:"views/ticket/link-item-action-blade.html",windowClass:"action-blade",controller:"LinkController",resolve:{linkParams:function(){return{selectedItems:[{id:null,type:EntityVO.TYPE_KNOWLEDGE}],isDraft:!0}}}});n.result.then(function(t){Array.prototype.push.apply(e.linkedItems,t)})["finally"](function(){t.currentTarget.focus()})},e.removeLinkedItem=function(t){_.pull(e.linkedItems,t)},e.createArticle=function(){var t;e.state.dataIsLoading=!0,e.article.allCategories=d.collectValues(e.article.categoriesSet,e.article),A(V.articleVisibilityGroup),V.title=V.title.replace(/\u00a0/g," "),V.content=C(V.content),V.parentTicketType=p.articleParent?p.articleParent.type:"",setTimeout(function(){u.createArticle(G,V).then(function(e){t=e,p.articleParent&&delete p.articleParent}).then(function(){var a=e.linkedItems.length?I(t):m.when(1),n=e.attachments.length?b(t):m.when(1);return u.getArticleRevisionsById(t.id,!0),m.all([a,n])})["catch"](function(e){s.error({text:e.data.defaultMessage||(e.data.errorCode?f("i18n")("error.unknown"):e.data.error),clear:!1,displayOnStateChange:!0})})["finally"](function(){e.state.dataIsLoading=!1,t&&e.onCreateArticleCompleted(t)})},200)},e.onCreateArticleCompleted=function(e){F.allowStateChange=!0,o.go("knowledge",{id:e.id})},e.cancel=function(){e.previousTemplate?(F.isTemplateSelected=!0,F.isTemplateAccepted=!0,e.selectedTemplate=_.cloneDeep(e.previousTemplate),e.previousTemplate=null):o.go("dashboard",{},{notify:!1}).then(function(){e.$emit("$stateChangeSuccess")})},e.discard=function(){k().then(function(t){t&&e.cancel()})},e.state=F,e.article=V,e.searchService=n,e.$on("$stateChangeStart",function(e,t,a){!F.allowStateChange&&F.isTemplateSelected&&F.isTemplateAccepted&&D()&&(e.preventDefault(),k().then(function(e){e&&(F.allowStateChange=!0,o.go(t.name,a))}))})}]).controller("CreateKnowledgeArticleModalController",["$scope","$controller","$modalInstance","ticketModel",function(e,t,a,n){function i(){n.articleParent.type!==EntityVO.TYPE_PROBLEM&&n.articleParent.type!==EntityVO.TYPE_KNOWNERROR&&n.articleParent.type!==EntityVO.TYPE_INCIDENT&&n.articleParent.type!==EntityVO.TYPE_WORKORDER||(e.articleContext={id:n.articleParent.id,type:n.articleParent.type})}i(),$.extend(this,t("CreateKnowledgeArticleController",{$scope:e})),e.onCreateArticleCompleted=function(e){a.close(e)},e.cancel=function(){a.dismiss()},e.$on("$stateChangeSuccess",a.dismiss)}])}(),function(){angular.module("createTicketModule").controller("CreateOutageController",["$scope","$modalInstance","createTicketModel","params","systemAlertService","$filter","metadataModel","configurationModel","userModel","events","categoriesService","searchModel","$timeout",function(e,t,a,n,i,o,r,s,l,c,d,u,p){function m(){e.state={dataIsLoading:!1,bannerDissmissed:!1},e.datePickerOptions={startingDay:s.getWeekStartingDay(),"show-weeks":!1,minDate:moment().year(1970).month(0).date(2),maxDate:moment().year(2038).month(0).date(18)},a.currentTicket=E,e.outage=E,e.outageMetadata=h={},e.type=E.parent.type,e.showMeridian=window.showMeridian,r.getMetadataByType(EntityVO.TYPE_OUTAGE).then(function(e){angular.extend(h,e),E.outageType=_.head(h.types),E.outageTypeName=E.outageType.name,E.status=_.head(h.statuses),f()}),E.parent.type===EntityVO.TYPE_CHANGE&&e.prepareGridConfigForAssetsList()}function f(){E.isScheduled="Scheduled Full"===E.outageTypeName||"Scheduled Partial"===E.outageTypeName,E.isScheduled||(E.scheduledStartDate="",E.scheduledStartTime="",E.scheduledEndDate="",E.scheduledEndTime="")}function g(){e.cancel(e.outage.createOutageForm.$dirty)}var h,y=(new Date).getTime(),E={type:EntityVO.TYPE_OUTAGE,parent:n.context,today:y,scheduledStartDatePicker:{open:!1},actualStartDatePicker:{open:!1},scheduledEndDatePicker:{open:!1},actualEndDatePicker:{open:!1}};e.data={isRequired:!0},e.isNew=!0,e.isAccessibleUser=l.isAccessibleUser,e.outageCreationEnabled=!0,e.parentCIs={data:{},gridOptions:"",selectedCiList:[],filters:[],sorting:{reverse:!1,orderBy:""}},e.initDates={scheduled:new Date,actual:new Date},e.updateType=function(e){E.createOutageForm.$setDirty(),E.outageType=e,E.outageTypeName=E.outageType.name,f()},e.createOutage=function(){if(e.state.dataIsLoading=!0,E.parent.type===EntityVO.TYPE_CHANGE){if(e.parentCIs.selectedCiList.length>=10){var n=a.createOutagesBulk(e.parentCIs.selectedCiList,!0);return void t.close({ciList:e.parentCIs.selectedCiList,createPromise:n})}return a.createOutagesBulk(e.parentCIs.selectedCiList,!0).then(function(a){a?(e.state.dataIsLoading=!1,i.error({text:a,clear:!0})):(E.parent.outageResourceAvailable=0,t.close({ciList:e.parentCIs.selectedCiList}))})}a.createOutage().then(function(a){a?(e.state.dataIsLoading=!1,i.error({text:a,clear:!0})):(E.parent.outageResourceAvailable=0,t.close(E.parent))})},e.cancel=function(e){if(e){var n=i.modal({title:o("i18n")("common.notification.dirty.title"),text:o("i18n")("common.notification.dirty.message"),buttons:[{text:o("i18n")("common.labels.yes"),data:!0},{text:o("i18n")("common.labels.no"),data:!1}]});n.result.then(function(e){e&&(a.currentTicket=E={},t.dismiss())})}else t.dismiss()},e.updateInitialDate=function(t){E.scheduledStartDate&&"scheduled"===t?e.initDates.scheduled=new Date(E.scheduledStartDate):E.actualStartDate&&"actual"===t&&(e.initDates.actual=new Date(E.actualStartDate))},e.updateDateTime=function(e){if((E[e+"StartDate"]&&!E[e+"StartTime"]||!E[e+"StartDate"]&&E[e+"StartTime"])&&(E[e+"StartTime"]=_.clone(E[e+"StartDate"])),(E[e+"EndDate"]&&!E[e+"EndTime"]||!E[e+"EndDate"]&&E[e+"EndTime"])&&(E[e+"EndTime"]=_.clone(E[e+"EndDate"])),E[e+"StartDate"]&&E[e+"EndDate"]){var t=moment(E[e+"StartTime"]),a=moment(E[e+"StartDate"]).set("hours",t.get("hours")).set("minutes",t.get("minutes")).format("X"),n=moment(E[e+"EndTime"]),i=moment(E[e+"EndDate"]).set("hours",n.get("hours")).set("minutes",n.get("minutes")).format("X");i<=a?E.createOutageForm[e+"EndDate"].$setValidity("validScheduledEndDateTime",!1):E.createOutageForm[e+"EndDate"].$setValidity("validScheduledEndDateTime",!0)}!E[e+"StartDate"]&&E[e+"EndDate"]?E.createOutageForm[e+"StartDate"].$setValidity("validScheduledStartDateTime",!1):E.createOutageForm[e+"StartDate"].$setValidity("validScheduledStartDateTime",!0)},e.openDatePicker=function(e){e.open=!0},e.getProductCategoriesByCompany=function(t){var a="product",n={entityType:EntityVO.TYPE_ASSET,categoryType:a,searchText:t,criteria:{company:e.company}};return d.searchCategories(n).then(function(e){var t=_.find(assetMetadata.categories,function(e){return e.name===a});return _.map(e.items,function(e){for(var n=_.compact(e).join(" > "),i={},o=0;o<t.listOfTiers.length;o++)i[t.listOfTiers[o].name]=e[o];return{value:n,attributeMap:{categorizations:[{name:a,tiers:i}]}}})})},e.prepareGridConfigForAssetsList=function(){var t=E.parent;e.parentCIs.relatedOutages=_.filter(n.relations,{type:EntityVO.TYPE_OUTAGE}),u.searchCIsRelatedToChangeRequestByCriteria(t,{relatedCI:!0}).then(function(t){_.forEach(t,function(t){var a=_.find(e.parentCIs.relatedOutages,{realObject:{affectedAsset:{reconciliationId:t.reconciliationId}}});return t.disableOutageCreation=!!a,t}),e.parentCIs.data=t;var a=_.filter(t,{disableOutageCreation:!0}).length;e.outageCreationEnabled=e.parentCIs.data&&e.parentCIs.data.length>0&&a<e.parentCIs.data.length}),e.parentCIs.gridOptions={data:"parentCIs.data",selectedItems:e.parentCIs.selectedCiList,multiSelect:!0,enableColumnResize:!0,enableSorting:!0,
showSelectionCheckbox:!0,selectWithCheckboxOnly:!0,selectionCheckboxColumnWidth:50,headerRowHeight:50,rowHeight:50,tabindex:0,columnDefs:[{field:"name",displayName:o("i18n")("asset.attributes.name").toUpperCase(),headerClass:"asset-name",cellTemplate:'<div class="ngCellText" ng-class="col.colIndex()"><span ng-cell-text>{{COL_FIELD}}</span> <span class="ci-with-existing-outage__label font-size-s" ng-if="row.entity.disableOutageCreation">{{\'change.details.existingOutage.label\' | i18n}}</span></div>'},{field:"assetId",displayName:o("i18n")("asset.attributes.classId").toUpperCase(),headerClass:"asset-class-id"},{field:"type",displayName:o("i18n")("asset.attributes.type").toUpperCase(),headerClass:"asset-type"},{field:"status.value",displayName:o("i18n")("asset.attributes.status").toUpperCase(),headerClass:"asset-status-value"},{field:"serialNumber",displayName:o("i18n")("asset.attributes.serialNumber").toUpperCase(),headerClass:"asset-instance-id"},{field:"site.name",displayName:o("i18n")("asset.attributes.site").toUpperCase(),headerClass:"asset-site-name"}],checkboxHeaderTemplate:'<label class="ngSelectionHeaderLabel"><input type="checkbox" ng-show="multiSelect" ng-model="parentCIs.selectAll" ng-change="selectAllItems(parentCIs.selectAll,\'grid\')"/></label>',checkboxCellTemplate:'<div class="ngSelectionCell" tooltip-placement="top" tooltip="{{row.entity.disableOutageCreation ? (\'change.details.relatingCIsDisabled.tooltip\' | i18n) : \'\'}}" tooltip-append-to-body="true"><input class="ngSelectionCheckbox" type="checkbox" ng-model="row.entity.selected" ng-change="selectItem(row.entity)" ng-checked="row.selected || row.entity.disableOutageCreation" ng-disabled="row.entity.disableOutageCreation" /></div>'},window.isRtl&&e.parentCIs.gridOptions.columnDefs.reverse();var a,i;a=angular.copy(s.get("ciSearch.createOutageFilter"));var c=_.keyBy(a,"label");l.getFullCurrentUserData().then(function(){var e=_.find(c.site.options,{label:"mySite"});e.criteria.value=[{name:l.userFullData.site.name,companyName:l.userFullData.company.name,region:l.userFullData.site.region,siteGroup:l.userFullData.site.siteGroup}],e.subLabel=l.userFullData.site.name}),r.getMetadataByType(EntityVO.TYPE_ASSET).then(function(e){i=e,_.forEach(e.statuses,function(e){c.statuses.options.push({name:e.label,type:"dynamic",criteria:{name:"ticketSpecificStatuses",value:[e.name]}})}),_.forEach(e.assetTypes,function(e){c.ciType.options.push({name:e.label,type:"dynamic",criteria:{name:"assetTypes",value:[e.name]}})})}),e.searchConfig=c,e.selectAllItems=function(t,a){if(E.createOutageForm.$setDirty(),e.parentCIs.selectedCiList=[],_.each(e.parentCIs.data,function(a){a.disableOutageCreation||(a.selected=!!t,t&&e.parentCIs.selectedCiList.push(a))}),"grid"===a&&e.parentCIs.gridOptions&&e.parentCIs.gridOptions.ngGrid&&e.parentCIs.gridOptions.ngGrid.filteredRows)for(var n=e.parentCIs.gridOptions.ngGrid.filteredRows,i=0;i<n.length;i++)n[i].selected=t,n[i].clone&&(n[i].clone.selected=t)},e.selectItem=function(t){E.createOutageForm.$setDirty(),!t.selected&&e.parentCIs.selectAll&&(e.parentCIs.selectAll=!1),t.selected?e.parentCIs.selectedCiList.push(t):e.parentCIs.selectedCiList=_.without(e.parentCIs.selectedCiList,t)},e.sortData=function(t){e.parentCIs.sorting.orderBy!==t.field?(e.parentCIs.sorting.orderBy=t.field,e.parentCIs.sorting.reverse=!1):e.parentCIs.sorting.reverse=!e.parentCIs.sorting.reverse},e.searchCiByCriteria=function(){var a={relatedCI:!0},n=_.filter(e.parentCIs.relatedOutages,{type:EntityVO.TYPE_OUTAGE});return e.state.loadingRelatedCis=!0,_.each(e.parentCIs.filters,function(e){var t=e.criteria||{};a[t.name]?a[t.name]=a[t.name].concat(t.value):a[t.name]=t.value}),u.searchCIsRelatedToChangeRequestByCriteria(t,a).then(function(t){p(function(){_.forEach(t,function(e){var t=_.find(n,{realObject:{affectedAsset:{reconciliationId:e.reconciliationId}}});return e.disableOutageCreation=!!t,e}),e.selectAllItems(!1,"grid"),e.parentCIs.data=t})})["finally"](function(){e.state.loadingRelatedCis=!1})},e.searchCiByCriteriaDebounced=_.debounce(e.searchCiByCriteria,1e3),e.getProductCategoriesByCompany=function(e){var t="product",a={entityType:EntityVO.TYPE_ASSET,categoryType:t,searchText:e,criteria:{company:E.parent.company}};return d.searchCategories(a).then(function(e){var a=_.find(i.categories,function(e){return e.name===t});return _.map(e.items,function(e){for(var n=_.compact(e).join(" > "),i={},o=0;o<a.listOfTiers.length;o++)i[a.listOfTiers[o].name]=e[o];return{value:n,attributeMap:{categorizations:[{name:t,tiers:i}]}}})})},e.$watch("parentCIs.filters",function(t){t&&e.searchCiByCriteriaDebounced()},!0)},m(),e.$on(c.MODAL_BACKDROP_CLICK,g)}])}(),function(){angular.module("createTicketModule").controller("CreateTaskV2Controller",["$scope","$modalInstance","$modal","$state","configurationModel","createTicketModel","ticketModel","userModel","i18nService","systemAlertService","screenConfigurationModel","$q","metadataModel","ticketActionService","categoriesService","$filter","events","layoutConfigurationModel","fieldValidationModel","objectValueMapperService","editTicketDatesService",function(e,t,a,n,i,o,r,s,l,c,d,u,p,m,f,g,h,y,E,v,T){function S(){e.showMeridian=window.showMeridian,e.state={showSpinner:!0,dataIsLoading:!0},e.editMode=!0,e.isNew=!0,e.formContainsInvalidFields=o.formContainsInvalidFields,o.currentTicket=b,e.task=b,e.taskMetadata=k,e.loggedInUserId=s.userId,A=r.taskParent,A?(b.parentName=A.type,b.parentId=A.id,b.parentDisplayId=A.displayId,A.type===EntityVO.TYPE_ACTIVITY&&(r.activityParent?b.parentReleaseDisplayId=r.activityParent.displayId:b.parentReleaseDisplayId=A.parentId),A.type!==EntityVO.TYPE_PROBLEM&&A.type!==EntityVO.TYPE_KNOWNERROR?(b.customer=A.customer,b.locationCompany=_.isEmpty(A.locationCompany)?A.company.name:A.locationCompany):b.customer={company:A.company},b.company=A.company?A.company:A.customer.company,A.type===EntityVO.TYPE_CHANGE&&(b.company.site=A.location?A.location:{siteId:"",region:"",name:"",siteGroup:""},A.scheduledStartDate&&(b.scheduledStartDate=A.scheduledStartDate))):n.go("dashboard"),e.datePickerOptions={startingDay:i.getWeekStartingDay(),"show-weeks":!1,minDate:moment().year(1970).month(0).date(2),maxDate:moment().year(2038).month(0).date(18)},v.clearMap(b.type),C();var t=p.getMetadataByType(EntityVO.TYPE_TASK).then(function(t){angular.extend(k,t);var a=_.head(k.statuses);b.status={value:a.name},!_.isEmpty(a.statusReasons)&&e.isFieldRequired("statusReason")&&(b.status.statusReason=_.head(a.statusReasons).name),b.priority=_.last(k.priorities).name}),a=r.getDraft(EntityVO.TYPE_TASK).then(function(t){e.state.showSpinner=!1,b.id=t.id,b.displayId=t.displayId,b.accessMappings=t.accessMappings}),l=ScreenConfigurationVO.prototype.CREATE_TASK_SCREEN,c=y.loadScreenLayout(l),m=d.loadScreenConfigurationAndCustomFieldLabels(l,EntityVO.TYPE_TASK),g=[t,a,c,m];if(A.taskPhaseId){b.showPhaseSelector=!0;var h=r.getFutureTaskPhases(A.company.name,A.taskPhaseId);g.push(h)}u.all(g).then(function(t){b.allCategories=f.populateCategories(b.categorizations,k),e.screenLayout=t[2],I=d.getEditableFieldsForScreen(l),e.customFields=angular.copy(I),t[4]&&(b.taskPhases=t[4],_.each(b.taskPhases,function(e){e.guid===A.taskPhaseId&&(b.selectedPhase=e)})),e.state.dataIsLoading=!1,e.state.showSpinner=!1}),e.clearSelectedGroup()}function C(){e.$on("$stateChangeStart",function(t,a,i){if(D()&&a.name!==A.type){t.preventDefault();var r=c.modal({title:l.getLocalizedString("common.notification.dirty.title"),text:l.getLocalizedString("common.notification.dirty.message"),buttons:[{text:l.getLocalizedString("common.labels.yes"),data:{stateName:a.name,stateParams:i}},{text:l.getLocalizedString("common.labels.no")}]});r.result.then(function(t){_.isEmpty(t)||(o.currentTicket=b={},e.createTaskForm.$setPristine(),e.cancel(),n.transitionTo(t.stateName,t.stateParams))})}else e.cancel()})}function O(t,a){var n=!1,i=a.originalEvent,o=!a.saveSelection;if(!a)return void $log.warn("Could not open assignment blade. Required Event data is missing. ");var r="ticketassignee";n=!!a.assignToMe,n?m.assignToMe(i,r,o,e.task,e):m.assign(i,o,e.task,e,r)}var A,I,b={today:new Date,type:EntityVO.TYPE_TASK,autoAssign:!0,customFields:{},showDates:!1,scheduledStartDatePicker:{open:!1},actualStartDatePicker:{open:!1},scheduledEndDatePicker:{open:!1},actualEndDatePicker:{open:!1},categorizations:[{name:"operational",tiers:{}},{name:"product",tiers:{}}]},k={};e.getList=function(e,t){return o.getList(e,t)},e.clearSelectedGroup=function(){b.selectedGroup={},e.clearSelectedAssignee(),b.autoAssign=!0},e.clearSelectedAssignee=function(){b.selectedAssignee={}},e.createTask=function(){e.state.showSpinner=!0;var a=o.collectTicketChanges(k);a.summary&&(a.summary=a.summary.replace(/\u00a0/g," "));var n=!1;angular.isDefined(e.task.selectedTemplate)&&(n=!0),o.createTaskV2(a,e.task.selectedTemplate,n).then(function(a){t.close(A),a&&"string"==typeof a&&(e.state.showSpinner=!1,c.error({text:a,clear:!1}))})["catch"](function(t){e.state.showSpinner=!1,c.error({text:t.errorCode?g("i18n")("error.unknown"):t.data.error,clear:!1})})},e.cancel=function(){t.dismiss()},e.isFieldRequired=function(e){return E.isFieldRequired(b.type,b.status.value,"",e)};var D=function(){return e.createTaskForm&&e.createTaskForm.$dirty||!_.isEmpty(b.attachments)};S(),e.$on(h.SHOW_ASSIGN_TICKET_BLADE,O),e.$on(h.CUSTOM_FIELD_VALUE_CHANGE,function(){e.$broadcast(h.REFRESH_FIELD_VALUES)}),e.$on(h.CHANGE_DATES_VALUE_CHANGED,function(t,a){"scheduled"!==a.type&&"actual"!==a.type||T.updateDateTime(e.createTaskForm,e.task,a.type)})}])}(),function(){angular.module("createTicketModule").factory("createTicketModel",["createTicketService","$state","filterFilter","ticketTemplateService","attachmentService","$q","ticketService","locationModel","searchModel","ticketModel","feedModel","userModel","systemAlertService","objectValueMapperService",function(e,t,a,n,i,o,r,s,l,c,d,u,p,m){function f(e,t,a){e.categorizations||(e.categorizations=[]);var n=_.find(a.allCategories,function(e){return _.findIndex(e.listOfTiers,function(e){return e.name===t.name})>-1}),i=_.find(e.categorizations,{name:n.name});i||(i={name:n.name,tiers:{}},n&&n.listOfTiers&&_.forEach(n.listOfTiers,function(e){i.tiers[e.name]=null}),e.categorizations.push(i)),i.tiers[t.name]=t.value}function g(e,t){return t=t?moment(t):moment(e),1e3*moment(e).set("hours",t.get("hours")).set("minutes",t.get("minutes")).format("X")}var h={};return h.currentTicket={},h.listCache={},h.getList=function(t,i,c,d,u){var p=[{run:function(){return e.getListOfPersons(i,u).then(function(e){return e[0]})},condition:"person"===t},{run:function(){var t=h.currentTicket.selectedCompany?h.currentTicket.selectedCompany.name:h.currentTicket.company.name;return e.getListOfAssets(i,t,c,d).then(function(e){return e[0].items[0]})},condition:"asset"===t},{run:function(){var t="Business Service",a=h.currentTicket.selectedCompany?h.currentTicket.selectedCompany.name:h.currentTicket.company.name;return e.getListOfAssetsByType(i,t,a,c,d).then(function(e){return e[0].items[0]})},condition:"service"===t},{run:function(){var e=h.currentTicket.selectedCompany;return n.getIncidentTemplateList(i,e).then(function(e){return{exceedsChunkSize:e.exceedsChunkSize,list:e.objects}})},condition:"incidentTemplate"===t},{run:function(){var e;return e=h.currentTicket.parentName===EntityVO.TYPE_CHANGE?h.currentTicket.company&&h.currentTicket.company.name:h.currentTicket.selectedCompany?h.currentTicket.selectedCompany.name:h.currentTicket.company.name,n.getTaskTemplateList(i,e).then(function(e){return i?{exceedsChunkSize:e[0].items[0].exceedsChunkSize,list:a(e[0].items[0].objects,{type:"Single Tasks"})}:e[0].items[0].objects})},condition:"taskTemplate"===t},{run:function(){var e=h.currentTicket.selectedCompany&&h.currentTicket.selectedCompany.name?h.currentTicket.selectedCompany.name:_.isString(h.currentTicket.selectedCompany)?h.currentTicket.selectedCompany:"";return n.getWorkorderTemplateList(i,e).then(function(e){return{exceedsChunkSize:e.exceedsChunkSize,list:e.objects}})},condition:"workorderTemplate"===t},{run:function(){var e=l.getCompaniesByText(i),t=l.getFoundationSitesObjectByText(i);return o.all([e,t]).then(function(e){return{exceedsChunkSize:e[0].exceedsChunkSize||e[1].exceedsChunkSize,list:e[0].companies.concat(e[1].foundationItems)}})},condition:"broadcastAudience"===t},{run:function(){var t="organization:"+i.companyName;return h.listCache[t]?o.when(h.listCache[t]):e.getListOfOrganizations(i).then(function(e){var a=e[0].items[0];return h.listCache[t]=a,a})},condition:"organization"===t},{run:function(){var t="department:"+i.companyName+":"+i.organizationName;return h.listCache[t]?o.when(h.listCache[t]):e.getListOfDepartments(i).then(function(e){var a=e[0].items[0];return h.listCache[t]=a,a})},condition:"department"===t},{run:function(){var t="region:"+i.companyName;return h.listCache[t]?o.when(h.listCache[t]):e.getListOfRegions(i).then(function(e){var a=e[0].items[0];return h.listCache[t]=a,a})},condition:"region"===t},{run:function(){var t="sitegroup:"+i.companyName+":"+i.regionName;return h.listCache[t]?o.when(h.listCache[t]):e.getListOfSiteGroups(i).then(function(e){var a=e[0].items[0];return h.listCache[t]=a,a})},condition:"sitegroup"===t},{run:function(){var t="site:"+i.companyName+":"+i.regionName;return i.siteGroupName&&(t+=":"+i.siteGroupName),h.listCache[t]?o.when(h.listCache[t]):e.getListOfSites(i).then(function(e){var a=e[0].items[0];return h.listCache[t]=a,a})},condition:"site"===t},{run:function(){return s.filterLocations(i).then(function(e){return e})},condition:"workorderLocation"===t},{run:function(){return s.filterLocationPOI(i.location,i.searchText).then(function(e){return e})},condition:"workorderPOI"===t},{run:function(){var e=h.currentTicket.selectedManagerGroup.id;return r.getGroupMembers(e,h.currentTicket.type===EntityVO.TYPE_WORKORDER?"role=workordermanager":"").then(function(e){return a(e,{fullName:i})})},condition:"workorderManager"===t},{run:function(){return e.getListOfRiskQuestions(i).then(function(e){return e[0].items[0].objects})},condition:"riskquestion"===t}];return _.find(p,"condition").run()},h.getPersonsByCompany=function(t,a){return e.getListOfPersonsByCompany(t,a).then(function(e){return e[0]})},h.getListOfRegionsByName=function(t,a){return e.getListOfRegionsByName(t,a).then(function(e){return e[0].items[0]})},h.getListOfSiteGroupsByName=function(t,a){return e.getListOfSiteGroupsByName(t,a).then(function(e){return e[0].items[0]})},h.getListOfSitesByName=function(t,a){return e.getListOfSitesByName(t,a).then(function(e){return e[0].items[0]})},h.getListOfOrganizationsByName=function(t,a){return e.getListOfOrganizationsByName(t,a).then(function(e){return e[0].items[0]})},h.getListOfDepartmentsByName=function(t,a){return e.getListOfDepartmentsByName(t,a).then(function(e){return e[0].items[0]})},h.getChangeClass=function(){var e=m.getValueByFieldName("changeClass");return e},h.collectTicketChanges=function(e){var t=h.currentTicket,a=m.getFieldList(),n={id:t.id,customer:_.cloneDeep(t.customer),displayId:t.displayId,status:{},categorizations:[],resCategorizations:[],customFields:{}};return _.forEach(a,function(i,o){if(!_.isEmpty(i.value)||_.isNumber(i.value)||_.isDate(i.value))if(i.type===FieldVO.prototype.PERSON_NAME){var r=i.name===FieldVO.prototype.WIDET_NAMES.requestedFor?FieldVO.prototype.WIDET_NAMES.customer:i.name;if(i.isAssigneeWidget())"assignee"===i.primaryKey&&null!==i.value.loginId?n[i.primaryKey]=i.value:"manager"===i.primaryKey&&null!==i.value.loginId?n[i.primaryKey]=i.value:"coordinator"===i.primaryKey&&null!==i.value.loginId&&(n[i.primaryKey]=i.value);else{if(!i.value)return void(n[r]={});i.value.loginId&&(n[r]=i.value)}}else if(i.type===FieldVO.prototype.AFFECTED_ASSET)i.value.ci&&null!==i.value.ci.reconciliationId&&(n[o]=i.value.ci);else if(i.type===FieldVO.prototype.CATEGORY_FIELD){var s=[],l={};_.forEach(i.value.listOfTiers,function(e){l[e.name]=e.selectedValue});var c={name:o,tiers:l};s.push(c),n.categorizations=n.categorizations.concat(s)}else if(i.type===FieldVO.prototype.PRIORITY){if(null!==i.value.priority){var d={impact:i.value.impact.name,urgency:i.value.urgency.name,priority:i.value.priority.name};angular.extend(n,d)}}else if(i.isSupportGroupWidget()&&i.value)"supportGroup"===i.primaryKey?n[i.primaryKey]=i.value:"managerGroup"===i.primaryKey?n[i.primaryKey]=i.value:"coordinatorGroup"===i.primaryKey&&(n[i.primaryKey]=i.value);else if(i.type===FieldVO.prototype.TICKET_CLASS)i.value.timing&&(n.timing=i.value.timing.name),i.value.timingReason&&(n.timingReason=i.value.timingReason);else if(i.type===FieldVO.prototype.CATEGORY_COMPANY||"locationCompany"===i.name)n.locationCompany=i.value?{name:i.value}:"";else if(i.type===FieldVO.prototype.TICKET_LOCATION)n.location=i.value;else if(i.type===FieldVO.prototype.POI_LOCATION)i.value&&i.value.poiId&&(n.location={poiId:i.value.poiId});else if(_.isObject(i.value)&&i.type!==FieldVO.prototype.IMPACTED_AREAS&&!_.isDate(i.value))"changeRisk"===o&&(i.riskIsUserSpecified&&"manual"===i.value.mode?n.riskIsUserSpecified=i.riskIsUserSpecified:n.riskIsUserSpecified=!1),angular.extend(n,i.value);else if("assignee"===i.name||"assigneeName"===i.name||"managerName"===i.name)i.value&&i.assigneeLoginId&&("assignee"===i.name||"assigneeName"===i.name?n.assignee={fullName:i.value,loginId:i.assigneeLoginId}:"managerName"===i.name&&(n.manager={loginId:i.assigneeLoginId,fullName:i.value}));else if(i.type!==FieldVO.prototype.IMPACTED_AREAS)if(i.ootb)if(i.name===FieldVO.prototype.STATUS)n.status.value=i.value;else if(i.name===FieldVO.prototype.STATUS_REASON)n.status.reason=i.value;else if("resolution"===i.name)n.resolution=i.value;else if(i.name.indexOf("CategoryTier")!==-1||"resProductName"===i.name||"productName"===i.name)f(n,i,t);else if("z1D_Phase"===i.name)t.taskPhases&&_.find(t.taskPhases,function(e){e.name===i.value&&(n.phaseGuid=e.guid,n.phaseName=e.name)});else if(i.dataType===FieldVO.prototype.DATA_TYPE_DATE||i.dataType===FieldVO.prototype.DATA_TYPE_TIME||i.dataType===FieldVO.prototype.DATA_TYPE_DATE_TIME)n[o]=i.value.valueOf();else{var u=e&&e.ootbMapping[i.name];u&&u.length?_.set(n,_.last(u),i.value):n[o]=i.value}else i.ootb||i.dataType!==FieldVO.prototype.DATA_TYPE_DATE_TIME?i.ootb||i.dataType!==FieldVO.prototype.DATA_TYPE_DATE&&i.dataType!==FieldVO.prototype.DATA_TYPE_TIME?n.customFields[o]=i.value:n.customFields[o]=i.getValue():n.customFields[o]=i.value.valueOf();if("changeReason"===o&&(u=e&&e.ootbMapping[i.name],u&&u.length&&_.set(n,_.last(u),null==i.value?"":i.value)),"reportedSource"===o&&i.value&&(n.customFields[o]=i.value),i.linkedFieldExist()&&!a[i.valueField]){var p=e&&e.ootbMapping[i.valueField];p&&p.length?_.set(n,_.last(p),i.getLinkedValue()):n.customFields[i.valueField]=i.getLinkedValue()}}),t.type===EntityVO.TYPE_WORKORDER&&delete n.company,n},h.createIncidentV2=function(a){return e.createIncident(a).then(function(e){var a=e.id,n=[];if(a){c.cache[a]=e;var r=m.getFieldByName("desc");if(r){var s=r.getValue();if(s&&!_.isEmpty(s.attachmentToUpload))return _.each(s.attachmentToUpload,function(e){var t=i.uploadAttachment(EntityVO.TYPE_INCIDENT,a,e);n.push(t)}),o.all(n).then(function(){t.go(EntityVO.TYPE_INCIDENT,{id:a})})["catch"](function(e){return a?(setTimeout(function(){p.error({text:e&&e.data&&e.data.error||e,clear:!1,displayOnStateChange:!0})}),void t.go(EntityVO.TYPE_INCIDENT,{id:a})):e});t.go(EntityVO.TYPE_INCIDENT,{id:a})}else t.go(EntityVO.TYPE_INCIDENT,{id:a})}})["catch"](function(e){throw e.data&&(e.data.detailMessage||e.data.error)||e})},h.createWorkOrderV2=function(a){var n=h.currentTicket;return n.dynamicFields&&n.dynamicFields.length&&(a.dynamicFields=[],_.forEach(n.dynamicFields,function(e){a.dynamicFields.push({name:e.name,value:e.value,dataType:e.dataType,label:e.label})})),a.scheduledStartDate&&(a.scheduledStartDate=g(a.scheduledStartDate)),a.scheduledEndDate&&(a.scheduledEndDate=g(a.scheduledEndDate)),a.actualStartDate&&(a.actualStartDate=g(a.actualStartDate)),a.actualEndDate&&(a.actualEndDate=g(a.actualEndDate)),e.createWorkOrder(a).then(function(e){var a=e.id,n=[];if(a){c.cache[a]=e;var r=m.getFieldByName("desc");if(r){var s=r.getValue();if(!_.isEmpty(s.attachmentToUpload))return _.each(s.attachmentToUpload,function(e){var t=i.uploadAttachment(EntityVO.TYPE_WORKORDER,a,e);n.push(t)}),o.all(n).then(function(){t.go(EntityVO.TYPE_WORKORDER,{id:a})})["catch"](function(e){return a?(setTimeout(function(){p.error({text:e&&e.data&&e.data.error||e,clear:!1,displayOnStateChange:!0})}),void t.go(EntityVO.TYPE_WORKORDER,{id:a})):e});t.go(EntityVO.TYPE_WORKORDER,{id:a})}else t.go(EntityVO.TYPE_WORKORDER,{id:a})}})["catch"](function(e){return e.data&&(e.data.detailMessage||e.data.error)||e})},h.createChangeRequestV2=function(t){var a=h.currentTicket;return a.company&&(t.company=a.company),!a.questionResponses&&a.riskLevel&&(t.riskIsUserSpecified=a.riskIsUserSpecified),e.createChangeRequest(t).then(function(e){return e[0].items[0]})},h.createTaskV2=function(t,a,n){var r,s=h.currentTicket;if(angular.isDefined(a)){var l={templateId:a.id,templateType:a.type};r=n?"browseTemplate":"template"}return t.company=s.company,h.currentTicket.type===EntityVO.TYPE_TASK&&h.currentTicket.parentName===EntityVO.TYPE_WORKORDER&&(t.company.site=s.customer.site),a&&a.templateObject&&"- Global -"!==a.company.name&&(a.templateObject.taskType||a.templateObject.taskGroupType)&&h.currentTicket.parentName===EntityVO.TYPE_WORKORDER&&(t.company=a.company),t.parentName=s.parentName,t.parentDisplayId=s.parentDisplayId,t.parentId=s.parentId,t.scheduledStartDate&&(t.scheduledStartDate=g(t.scheduledStartDate)),t.scheduledEndDate&&(t.scheduledEndDate=g(t.scheduledEndDate)),t.actualStartDate&&(t.actualStartDate=g(t.actualStartDate)),t.actualEndDate&&(t.actualEndDate=g(t.actualEndDate)),e.createTask(l,t).then(function(e){if("template"!==r){var a=t.id,n=[];if(a){var s=m.getFieldByName("desc");if(s){var l=s.getValue();if(!_.isEmpty(l.attachmentToUpload)){var c=i.uploadAttachment(EntityVO.TYPE_TASK,a,l.attachmentToUpload);return n.push(c),o.all(n).then()["catch"](function(e){a&&setTimeout(function(){p.error({text:error&&error.data&&error.data.error||error,clear:!1})})})}}}}})["catch"](function(e){throw e})},h.createIncident=function(){var a=h.currentTicket,n={id:a.id,displayId:a.displayId,customer:a.customer,summary:a.summary,desc:a.desc,impact:a.selectedImpact.name,urgency:a.selectedUrgency.name,templateId:a.templateId,status:{value:a.selectedStatus.name},categorizations:a.categorizations,resCategorizations:a.resCategorizations};return a.locationCompany&&a.locationCompany.name&&a.locationCompany.name!==a.customer.company.name&&(n.locationCompany=a.locationCompany),a.selectedStatusReason&&(n.status.reason=a.selectedStatusReason.name),a.selectedServiceType&&a.selectedServiceType.name&&(n.serviceType=a.selectedServiceType.name),a.resolution&&(n.resolution=a.resolution),a.selectedService&&(n.impactedService=_.isObject(a.selectedService)?a.selectedService:{}),a.selectedAsset&&(n.causalCI=_.isObject(a.selectedAsset)?a.selectedAsset:{}),a.contact&&(n.contact=_.isObject(a.contact)?a.contact:{}),a.autoAssign||(a.selectedGroup&&(n.supportGroup=_.isObject(a.selectedGroup)?a.selectedGroup:{}),a.selectedAssignee&&(n.assignee=_.isObject(a.selectedAssignee)?a.selectedAssignee:{})),_.size(a.customFields)&&(n.customFields=a.customFields),e.createIncident(n).then(function(e){var n=e.id,r=[];if(n){if(c.cache[n]=e,!_.isEmpty(a.attachments))return _.each(a.attachments,function(e){var t=i.uploadAttachment(EntityVO.TYPE_INCIDENT,n,e);r.push(t)}),o.all(r).then(function(){t.go(EntityVO.TYPE_INCIDENT,{id:n})})["catch"](function(e){return delete c.cache[n],e});t.go(EntityVO.TYPE_INCIDENT,{id:n})}})["catch"](function(e){return e.data.detailMessage||e.data.error||e})},h.createWorkOrder=function(){var a=h.currentTicket,n={id:a.id,displayId:a.displayId,summary:a.summary,customer:a.customer,desc:a.desc,priority:a.selectedPriority.name,status:{value:a.selectedStatus.name},categorizations:a.categorizations,dynamicFields:[]};return a.poi&&(n.location={poiId:a.poi.id}),a.locationCompany&&a.locationCompany.name&&a.locationCompany.name!==a.customer.company.name&&(n.locationCompany=a.locationCompany),a.selectedService&&(n.impactedService=_.isObject(a.selectedService)?a.selectedService:{}),a.selectedStatusReason&&(n.status.reason=a.selectedStatusReason.name),a.scheduledStartDate&&(n.scheduledStartDate=g(a.scheduledStartDate,a.scheduledStartTime)),a.scheduledEndDate&&(n.scheduledEndDate=g(a.scheduledEndDate,a.scheduledEndTime)),a.actualStartDate&&(n.actualStartDate=g(a.actualStartDate,a.actualStartTime)),a.actualEndDate&&(n.actualEndDate=g(a.actualEndDate,a.actualEndTime)),a.autoAssignAssignee||(a.selectedGroup&&(n.supportGroup=_.isObject(a.selectedGroup)?a.selectedGroup:{}),a.selectedAssignee&&(n.assignee=_.isObject(a.selectedAssignee)?a.selectedAssignee:{})),a.autoAssignManager||(a.selectedManagerGroup&&(n.managerGroup=_.isObject(a.selectedManagerGroup)?a.selectedManagerGroup:{}),a.selectedManager&&(n.manager=_.isObject(a.selectedManager)?a.selectedManager:{})),a.templateId&&(n.templateId=a.templateId),a.templateName&&(n.templateName=a.templateName),a.contact&&(n.contact=_.isObject(a.contact)?a.contact:{}),_.size(a.customFields)&&(n.customFields=a.customFields),a.dynamicFields.length&&_.forEach(a.dynamicFields,function(e){n.dynamicFields.push({name:e.name,value:e.value,dataType:e.dataType})}),e.createWorkOrder(n).then(function(e){var n=e.id,r=[];if(n){if(c.cache[n]=e,!_.isEmpty(a.attachments))return _.each(a.attachments,function(e){var t=i.uploadAttachment(EntityVO.TYPE_WORKORDER,n,e);r.push(t)}),o.all(r).then(function(){t.go(EntityVO.TYPE_WORKORDER,{id:n})})["catch"](function(e){return delete c.cache[n],e});t.go(EntityVO.TYPE_WORKORDER,{id:n})}})["catch"](function(e){return e.data.detailMessage||e.data.error||e})},h.createTask=function(t,a){var n=h.currentTicket,r={id:n.id,summary:n.summary,desc:n.desc,type:n.type,priority:n.selectedPriority.name,company:{name:n.company.name},categorizations:n.categorizations,parentName:n.parentName,parentDisplayId:n.parentDisplayId,parentId:n.parentId},s={};return n.name&&(r.name=n.name),n.selectedPhase&&(r.phaseGuid=n.selectedPhase.guid,r.phaseName=n.selectedPhase.name),n.customer&&(r.customer=_.cloneDeep(n.customer),r.customer.accessMappings&&delete r.customer.accessMappings),n.autoAssign||(n.selectedGroup&&(r.supportGroup=_.isObject(n.selectedGroup)?n.selectedGroup:{}),n.selectedAssignee&&(r.assignee=_.isObject(n.selectedAssignee)?n.selectedAssignee:{})),n.scheduledStartDate&&(r.scheduledStartDate=g(n.scheduledStartDate,n.scheduledStartTime)),n.scheduledEndDate&&(r.scheduledEndDate=g(n.scheduledEndDate,n.scheduledEndTime)),n.actualStartDate&&(r.actualStartDate=g(n.actualStartDate,n.actualStartTime)),n.actualEndDate&&(r.actualEndDate=g(n.actualEndDate,n.actualEndTime)),_.size(n.customFields)&&(r.customFields=n.customFields),angular.isDefined(a)&&(s={templateId:a.id,templateType:a.type}),e.createTask(s,r).then(function(){if("detail"===t||"draft"===t){var e=r.id,a=[];if(!_.isEmpty(n.attachments))return a.push(i.uploadAttachment(EntityVO.TYPE_TASK,e,n.attachments).then(function(){})),o.all(a)}})},h.createBroadcast=function(){var t=h.currentTicket,a={title:t.title,message:t.desc,targets:[{company:t.companyName,site:t.siteName}],type:t.broadcastType.name,priority:t.priority.name,visibility:t.visibility.name,originatedFrom:"GALILEO"};return t.broadcastStartDate&&(a.broadcastStartDate=g(t.broadcastStartDate,t.broadcastStartTime)),t.broadcastEndDate&&(a.broadcastEndDate=g(t.broadcastEndDate,t.broadcastEndTime)),e.createBroadcast(a).then(function(e){var a=e[0].id,n=[];if(!_.isEmpty(t.attachments))return _.each(t.attachments,function(e){var t=i.uploadAttachment(EntityVO.TYPE_BROADCAST,a,e);n.push(t)}),o.all(n)})},h.createOutage=function(){var t=h.currentTicket,a={type:t.outageType.name,status:{value:t.status.name},desc:t.desc,company:t.parent.company,affectedAsset:{name:t.parent.name,classId:t.parent.classId,reconciliationId:t.parent.reconciliationId,instanceId:t.parent.instanceId}};return t.scheduledStartDate&&(a.scheduledStartDate=g(t.scheduledStartDate,t.scheduledStartTime)),t.scheduledEndDate&&(a.scheduledEndDate=g(t.scheduledEndDate,t.scheduledEndTime)),t.actualStartDate&&(a.actualStartDate=g(t.actualStartDate,t.actualStartTime)),t.actualEndDate&&(a.actualEndDate=g(t.actualEndDate,t.actualEndTime)),e.createOutage(a).then(function(){})["catch"](function(e){return e.data.detailMessage||e.data.error||e})},h.createOutagesBulk=function(t,a){var n=h.currentTicket,i={type:n.outageType.name,status:{value:n.status.name},desc:n.desc,company:n.parent.company};n.scheduledStartDate&&(i.scheduledStartDate=g(n.scheduledStartDate,n.scheduledStartTime)),n.scheduledEndDate&&(i.scheduledEndDate=g(n.scheduledEndDate,n.scheduledEndTime)),n.actualStartDate&&(i.actualStartDate=g(n.actualStartDate,n.actualStartTime)),n.actualEndDate&&(i.actualEndDate=g(n.actualEndDate,n.actualEndTime));var o=_.map(t,function(e){return{name:e.name,classId:e.classId,reconciliationId:e.reconciliationId,instanceId:e.instanceId}}),r={outage:i,assets:o};return a&&(r.createRelation=!0,r.attributeMap={id:n.parent.id,ticketType:n.parent.type}),e.createOutageBulk(r).then(function(){})["catch"](function(e){return e.data.detailMessage||e.data.error||e})},h.createChangeRequest=function(){var t=h.currentTicket,a={id:t.id,displayId:t.displayId,company:t.company,summary:t.summary,desc:t.desc,assignee:t.assignee,supportGroup:t.supportGroup,impact:t.impact.name,urgency:t.urgency.name,priority:t.priority.name,timing:t.timing.name,categorizations:t.categorizations,customer:t.customer,location:t.location,templateId:t.templateId};return!t.questionResponses&&t.riskLevel&&(a.riskLevel=t.riskLevel.name,a.riskIsUserSpecified=t.riskIsUserSpecified),t.autoAssignManager||(t.manager&&(a.manager=t.manager),t.managerGroup&&(a.managerGroup={company:t.managerGroup.company,name:t.managerGroup.name,organization:t.managerGroup.organization})),t.impactedService&&(a.impactedService=_.isObject(t.impactedService)?t.impactedService:{}),t.changeReason&&(a.changeReason=t.changeReason.name),t.scheduledStartDate&&(a.scheduledStartDate=g(t.scheduledStartDate)),t.scheduledEndDate&&(a.scheduledEndDate=g(t.scheduledEndDate)),t.actualStartDate&&(a.actualStartDate=g(t.actualStartDate)),t.actualEndDate&&(a.actualEndDate=g(t.actualEndDate)),t.targetDate&&(a.targetDate=g(t.targetDate)),t.timingReason&&(a.timingReason=t.timingReason.name),_.size(t.customFields)&&(a.customFields=t.customFields),e.createChangeRequest(a).then(function(e){return e[0].items[0]})},h.createRelease=function(){var t=h.currentTicket,a={id:t.id,displayId:t.displayId,company:t.company,summary:t.summary,desc:t.desc,coordinator:t.coordinator,coordinatorGroup:t.coordinatorGroup,impact:t.impact.name,urgency:t.urgency.name,priority:t.priority.name,categorizations:t.categorizations,location:t.location,templateId:t.templateId,templateGuid:t.templateGuid,templateName:t.templateName,riskLevel:t.riskLevel.name};return t.impactedService&&(a.impactedService=_.isObject(t.impactedService)?t.impactedService:{}),t.businessJustification&&(a.businessJustification=_.isObject(t.businessJustification)?t.businessJustification.name:""),t.releaseType&&(a.releaseType=_.isObject(t.releaseType)?t.releaseType.name:""),"auto"===t.riskLevelSelectionMode&&(a.isAutoCalcualteRisk=!0),t.scheduledStartDate&&(a.scheduledStartDate=g(t.scheduledStartDate)),t.scheduledEndDate&&(a.scheduledEndDate=g(t.scheduledEndDate)),t.deploymentStartDate&&(a.deploymentStartDate=g(t.deploymentStartDate)),t.deploymentEndDate&&(a.deploymentEndDate=g(t.deploymentEndDate)),e.createRelease(a).then(function(e){return e[0].items[0]})},h.createActivity=function(t,a){var n;if(t)return n={templateGuid:a.id,parentId:a.parentId,parentGuid:a.parentGuid,sequence:a.sequence},a.milestone&&(n.milestone=_.isObject(a.milestone)?a.milestone.name:a.milestone),e.createActivity(n).then(function(e){
return e[0].items[0]});var i=h.currentTicket;return n={id:i.id,displayId:i.displayId,summary:i.summary,desc:i.desc,parentId:i.parentId,parentGuid:i.parentGuid,sequence:i.sequence,company:i.company,location:i.location,assignee:i.assignee,supportGroup:i.supportGroup},i.milestone&&(n.milestone=_.isObject(i.milestone)?i.milestone.name:""),i.priority&&(n.priority=_.isObject(i.priority)?i.priority.name:""),i.scheduledStartDate&&(n.scheduledStartDate=g(i.scheduledStartDate)),i.scheduledEndDate&&(n.scheduledEndDate=g(i.scheduledEndDate)),i.actualStartDate&&(n.actualStartDate=g(i.actualStartDate)),i.actualEndDate&&(n.actualEndDate=g(i.actualEndDate)),e.createActivity(n).then(function(e){return e[0].items[0]})},h.createProblem=function(){var a=h.currentTicket,n={id:a.id,displayId:a.displayId,summary:a.summary,desc:a.desc,impact:a.selectedImpact.name,urgency:a.selectedUrgency.name,templateId:a.templateId,status:{value:a.selectedStatus.name},categorizations:a.categorizations,investigationDriver:a.investigationDriver.name,targetDate:a.targetDate?g(a.targetDate):null,workaround:a.workaround,resolution:a.resolution,rootCause:a.rootCause?a.rootCause.name:void 0};return a.company&&(n.company=a.company),a.location&&(n.location=a.location),a.selectedStatusReason&&(n.status.reason=a.selectedStatusReason.name),a.selectedService&&(n.impactedService=_.isObject(a.selectedService)?a.selectedService:{}),a.selectedAsset&&(n.causalCI=_.isObject(a.selectedAsset)?a.selectedAsset:{}),a.contact&&(n.contact=_.isObject(a.contact)?a.contact:{}),a.autoAssign||(a.assignee&&(n.assignee=a.assignee),a.supportGroup&&(n.supportGroup=a.supportGroup)),a.coordinatorAutoAssign||(a.coordinator&&(n.coordinator=a.coordinator),a.coordinatorGroup&&(n.coordinatorGroup=a.coordinatorGroup)),_.size(a.customFields)&&(n.customFields=a.customFields),e.createProblem(n).then(function(e){var n=e.id,r=[];if(n){if(c.cache[n]=e,a.impactedAreas){var s=h.saveImpactedAreas(n,EntityVO.TYPE_PROBLEM,a.impactedAreas);r.push(s)}if(_.isEmpty(a.attachments)||_.each(a.attachments,function(e){var t=i.uploadAttachment(EntityVO.TYPE_PROBLEM,n,e);r.push(t)}),r.length)return o.all(r).then(function(){t.go(EntityVO.TYPE_PROBLEM,{id:n})})["catch"](function(e){return n?(setTimeout(function(){p.error({text:e&&e.data&&e.data.error||e,clear:!1,displayOnStateChange:!0})}),void t.go(EntityVO.TYPE_PROBLEM,{id:n})):e});t.go(EntityVO.TYPE_PROBLEM,{id:n})}})["catch"](function(e){return e.data.detailMessage||e.data.error||e})},h.createKE=function(){var a=h.currentTicket,n={id:a.id,displayId:a.displayId,summary:a.summary,impact:a.selectedImpact.name,urgency:a.selectedUrgency.name,desc:a.desc,targetDate:g(a.targetDate),status:{value:a.selectedStatus.name},categorizations:a.categorizations,workaround:a.workaround,resolution:a.resolution,rootCause:a.rootCause?a.rootCause.name:void 0};return a.company&&(n.company=a.company),a.selectedService&&(n.impactedService=_.isObject(a.selectedService)?a.selectedService:{}),a.selectedAsset&&(n.causalCI=_.isObject(a.selectedAsset)?a.selectedAsset:{}),a.selectedStatusReason&&(n.status.reason=a.selectedStatusReason.name),a.autoAssign||(a.assignee&&(n.assignee=_.isObject(a.assignee)?a.assignee:{}),a.supportGroup&&(n.supportGroup=_.isObject(a.supportGroup)?a.supportGroup:{})),a.coordinatorAutoAssign||(a.coordinator&&(n.coordinator=_.isObject(a.coordinator)?a.coordinator:{}),a.coordinatorGroup&&(n.coordinatorGroup=_.isObject(a.coordinatorGroup)?a.coordinatorGroup:{})),a.selectedViewAccess&&(n.viewAccess=a.selectedViewAccess.name),_.size(a.customFields)&&(n.customFields=a.customFields),e.createKnownError(n).then(function(e){var n=e.id,r=[];if(n){if(c.cache[n]=e,_.isEmpty(a.attachments)||_.each(a.attachments,function(e){var t=i.uploadAttachment(EntityVO.TYPE_KNOWNERROR,n,e);r.push(t)}),r.length)return o.all(r).then(function(){t.go(EntityVO.TYPE_KNOWNERROR,{id:n})})["catch"](function(e){return n?(setTimeout(function(){p.error({text:e&&e.data&&e.data.error||e,clear:!1,displayOnStateChange:!0})}),void t.go(EntityVO.TYPE_KNOWNERROR,{id:n})):e});t.go(EntityVO.TYPE_KNOWNERROR,{id:n})}})["catch"](function(e){return e.data.detailMessage||e.data.error||e})},h.createImpactAnalysis=function(t,a,n){if(t&&a)return e.createImpactAnalysis(t,a,n)["catch"](function(e){e&&p.error({text:e.data&&e.data.error||e,clear:!0})})},h.saveImpactedAreas=function(t,a,n){return n&&n.length>0?e.saveImpactedAreas(t,a,n):o.when()},h.deleteImpactedAreas=function(t,a){return a&&a.length>0?e.deleteImpactedAreas(t,a):o.when()},h.saveRiskResponse=function(t,a){var n=[];return t.questionResponses?(_.forOwn(t.questionResponses,function(e){var a={weight:e.parentQuestion.weight,company:t.company.name,questionnaireId:e.parentQuestion.questionnaireId,parentId:t.id,questionId:e.parentQuestion.id,questionText:e.parentQuestion.label,value:e.riskValue,order:e.parentQuestion.sortOrder,displayValue:e.label,format:e.parentQuestion.format};e.parentQuestion.responseId&&(a.id=e.parentQuestion.responseId),n.push(a)}),t.questionResponses=n,e.saveRiskResponse(t.id,n)["catch"](function(e){if(e){var t=e.data&&e.data.error||e;if(p.error({text:t,clear:!0}),a)return e}})):o.when()},h.saveDocuments=function(e){var t=[];return _.isEmpty(e.documents)||_.each(e.documents,function(a){_.each(a.plans,function(n){if(n.desc||!(n.attachments.length<1)){var o={text:n.desc,type:a.index,locked:!1,access:!0,attachments:[],attachmentInfos:[]};_.each(n.attachments,function(e){e.id||(o.attachments.push(e),o.attachmentInfos.push({name:e.name,action:"add"}))});var r=i.createChangePlan(e.id,e.type,o);t.push(r)}})}),o.all(t)["catch"](function(e){setTimeout(function(){p.error({text:e&&e.data&&e.data.error||e,clear:!1})})}),t},h.onChangeCreateSuccess=function(e,t){if(e.type||(e.type=EntityVO.TYPE_CHANGE),t){var a={command:"start"};h.createImpactAnalysis(e.id,EntityVO.TYPE_CHANGE,a)}d.pendingWorkNote=null,h.currentTicket=null},h.createAsset=function(){var a=h.currentTicket,n={classId:a.selectedSubtype.name,name:a.name,description:a.desc};return a.company&&a.company.name&&(n.companyName=a.company.name),_.forEach(a.allCategories[0].listOfTiers,function(e){e.selectedValue&&(n[e.name]=e.selectedValue)}),_.isEmpty(a.selectedStatus)||(n.status=a.selectedStatus.name),_.isEmpty(a.selectedStatusReason)||(n.statusReason=a.selectedStatusReason.name),_.isEmpty(a.tagNumber)||(n.tag=a.tagNumber),_.isEmpty(a.manufacturer)||(_.isEmpty(a.manufacturer.name)?n.manufacturer=a.manufacturer:n.manufacturer=a.manufacturer.name),_.isEmpty(a.supplier)||(n.supplier=a.supplier.name),_.isEmpty(a.impact)||(n.impact=a.impact),_.isEmpty(a.urgency)||(n.urgency=a.urgency),_.isEmpty(a.priority)||(n.priority=a.priority),_.isEmpty(a.systemRole)||(n.systemRole=a.systemRole),_.isEmpty(a.serialNumber)||(n.serialNumber=a.serialNumber),_.isEmpty(a.assetId)||(n.assetId=a.assetId),_.isEmpty(a.partNumber)||(n.partNumber=a.partNumber),a.receivedDate.value&&(n.receivedDate=a.receivedDate.value),a.availableDate.value&&(n.availableDate=a.availableDate.value),a.returnDate.value&&(n.returnDate=a.returnDate.value),a.installationDate.value&&(n.installationDate=a.installationDate.value),a.disposalDate.value&&(n.disposalDate=a.disposalDate.value),a.purchaseDate.value&&(n.purchaseDate=a.purchaseDate.value),a.lastScanDate.value&&(n.lastScanDate=a.lastScanDate.value),_.isEmpty(a.invoiceNumber)||(n.invoiceNumber=a.invoiceNumber),_.isEmpty(a.costCenter)||(n.costCenter=a.costCenter.value),_.isEmpty(a.budgetCode)||(n.budgetCode=a.budgetCode),_.isEmpty(a.projectNumber)||(n.projectNumber=a.projectNumber),_.isEmpty(a.floor)||(n.floor=a.floor),_.isEmpty(a.room)||(n.room=a.room),a.selectedType.name===a.advancedType&&(_.isEmpty(a.hostName)||(n.hostName=a.hostName),_.isEmpty(a.primaryCapability)||(n.primaryCapability=a.primaryCapability.name),_.isEmpty(a.capabilityList)||(n.capabilityList=a.capabilityList),_.isEmpty(a.selectedSystemType)||(n.systemType=a.selectedSystemType.name),_.isEmpty(a.selectedVirtualSystemType)||(n.virtualSystemType=a.selectedVirtualSystemType.name)),_.isEmpty(a.siteName)||(n.siteName=a.siteName),_.isEmpty(a.siteGroup)||(n.siteGroup=a.siteGroup),_.isEmpty(a.siteRegion)||(n.siteRegion=a.siteRegion),_.forOwn(a.customFields,function(e,t){""!==e&&null!==e&&angular.isDefined(e)||delete a.customFields[t]}),_.size(a.customFields)&&(n.customFields=a.customFields),e.createAsset(n).then(function(e){var n=e.responseObject;return n.needsReconciliation?{assetName:a.name}:void t.go(EntityVO.TYPE_ASSET,{assetId:n.reconciliationId,assetClassId:n.classId})})["catch"](function(e){return{error:e.data.detailMessage||e.data.error||e}})},h.formContainsInvalidFields=function(e){var t=_.omit(e.$error,"required");return!_.isEmpty(t)},h}])}(),function(){angular.module("createTicketModule").service("createTicketService",["$resource","$http","systemAlertService","$q",function(e,t,a,n){var i=e("/smartit/rest/person/search",{},{getListOfPersons:{method:"GET",isArray:!0},getListOfSites:{method:"GET",isArray:!0,url:"/smartit/rest/foundation/search/site"},getListOfItems:{method:"GET",isArray:!0,url:"/smartit/rest/foundation/items"},getListOfRiskQuestions:{method:"POST",isArray:!0,url:"/smartit/rest/change/riskquestions/get"}}),o=e("/smartit/rest/asset/search",{},{getListOfAssets:{method:"GET",isArray:!0}}),r=e("",{},{createIncident:{method:"POST",isArray:!0,url:"/smartit/rest/v2/incident"},createTask:{method:"POST",isArray:!1,url:"/smartit/rest/task"},createWorkOrder:{method:"POST",isArray:!0,url:"/smartit/rest/workorder"},createBroadcast:{method:"POST",isArray:!0,url:"/smartit/rest/broadcast"},createOutage:{method:"POST",isArray:!1,url:"/smartit/rest/outage"},createChangeRequest:{method:"POST",isArray:!0,url:"/smartit/rest/v2/change",headers:{"Content-Type":void 0},transformRequest:function(e){var t,a,n=new FormData;if(n.append("text",JSON.stringify(e)),e.attachments&&e.attachments.length>0)if(1===e.attachments.length)n.append("file",e.attachments[0].file);else for(t=0,a=e.attachments.length;t<a;t++)n.append("file[]",e.attachments[t].file);return n}},createRelease:{method:"POST",isArray:!0,url:"/smartit/rest/release"},createActivity:{method:"POST",isArray:!0,url:"/smartit/rest/activity"},createProblem:{method:"POST",isArray:!0,url:"/smartit/rest/problem"},createKnownError:{method:"POST",isArray:!0,url:"/smartit/rest/knownerror"},saveRiskResponse:{method:"POST",isArray:!1,url:"/smartit/rest/change/riskresponse/:id"},saveImpactedAreas:{method:"POST",isArray:!1,url:"/smartit/rest/impactedarea/:type/:id"},createOutageBulk:{method:"POST",isArray:!1,url:"/smartit/rest/outage/bulk"},createImpactAnalysis:{method:"POST",isArray:!0,url:"/smartit/rest/asset/impactjob/:type/:id"},createAsset:{method:"POST",isArray:!0,url:"/smartit/rest/asset"}});this.getListOfPersons=function(e,t){var a={name:e,thumbnail:!0};return t&&(a.hideBlankEmail=t),i.getListOfPersons(a).$promise},this.getListOfPersonsByCompany=function(e,t){return i.getListOfPersons({name:e,thumbnail:!0,companyName:t}).$promise},this.getListOfAssets=function(e,t,a,n){var i={searchParam:e,company:{name:t},thumbnail:!0};return a===EntityVO.TYPE_INCIDENT&&(i.customerId=n,i.ticket=a,i.affected=!0),a!==EntityVO.TYPE_PROBLEM&&a!==EntityVO.TYPE_KNOWNERROR||(i.affected=!0),o.getListOfAssets(i).$promise},this.getListOfAssetsByType=function(e,t,a,n,i){var r={searchParam:e,assetType:t,company:{name:a},thumbnail:!0};return n===EntityVO.TYPE_INCIDENT&&(r.customerId=i,r.ticket=n,r.affected=!0),o.getListOfAssets(r).$promise},this.createIncident=function(e){return r.createIncident(e).$promise.then(function(e){return(new IncidentVO).build(e[0].items[0])})},this.createTask=function(e,t){return r.createTask(e,t).$promise},this.createWorkOrder=function(e){return r.createWorkOrder(e).$promise.then(function(e){return(new WorkOrderVO).build(e[0].items[0])})},this.createBroadcast=function(e){return r.createBroadcast(e).$promise},this.createChangeRequest=function(e){return r.createChangeRequest(e).$promise},this.createRelease=function(e){return r.createRelease(e).$promise},this.createActivity=function(e){return r.createActivity(e).$promise},this.createProblem=function(e){return r.createProblem(e).$promise.then(function(e){return(new ProblemVO).build(e[0].items[0])})},this.createKnownError=function(e){return r.createKnownError(e).$promise.then(function(e){return(new KnownErrorVO).build(e[0].items[0])})},this.createImpactAnalysis=function(e,t,a){return r.createImpactAnalysis({id:e,type:t},a).$promise},this.saveRiskResponse=function(e,t){return r.saveRiskResponse({id:e},t).$promise},this.saveImpactedAreas=function(e,t,a){return r.saveImpactedAreas({id:e,type:t},a).$promise},this.deleteImpactedAreas=function(e,i){return t({method:"DELETE",headers:{"Content-Type":"application/json"},url:"/smartit/rest/change/impactedAreas/"+e,data:i})["catch"](function(e){return a.error({text:e.data.error,clear:!1}),n.reject(e)})},this.getListOfSites=function(e){return i.getListOfSites({searchText:e}).$promise},this.getListOfCompanies=function(e){var t={type:"company"};return e&&(t.term={searchText:e}),i.getListOfItems(t).$promise},this.getListOfOrganizations=function(e){var t={type:"organization",searchOptions:e};return e.chunkInfo&&(t.chunkInfo=e.chunkInfo),i.getListOfItems(t).$promise},this.getListOfDepartments=function(e){var t={type:"department",searchOptions:e};return e.chunkInfo&&(t.chunkInfo=e.chunkInfo),i.getListOfItems(t).$promise},this.getListOfRegions=function(e){var t={type:"region",searchOptions:e};return e.chunkInfo&&(t.chunkInfo=e.chunkInfo),i.getListOfItems(t).$promise},this.getListOfSiteGroups=function(e){var t={type:"siteGroup",searchOptions:e};return e.chunkInfo&&(t.chunkInfo=e.chunkInfo),i.getListOfItems(t).$promise},this.getListOfSites=function(e){var t={type:"site",searchOptions:e};return e.chunkInfo&&(t.chunkInfo=e.chunkInfo),i.getListOfItems(t).$promise},this.getListOfRegionsByName=function(e,t){var a={type:"region",searchOptions:e,searchText:t};return e.chunkInfo&&(a.chunkInfo=e.chunkInfo),i.getListOfItems(a).$promise},this.getListOfSiteGroupsByName=function(e,t){var a={type:"siteGroup",searchOptions:e,searchText:t};return e.chunkInfo&&(a.chunkInfo=e.chunkInfo),i.getListOfItems(a).$promise},this.getListOfSitesByName=function(e,t){var a={type:"site",searchOptions:e,searchText:t};return e.chunkInfo&&(a.chunkInfo=e.chunkInfo),i.getListOfItems(a).$promise},this.getListOfOrganizationsByName=function(e,t){var a={type:"organization",searchOptions:e,searchText:t};return e.chunkInfo&&(a.chunkInfo=e.chunkInfo),i.getListOfItems(a).$promise},this.getListOfDepartmentsByName=function(e,t){var a={type:"department",searchOptions:e,searchText:t};return e.chunkInfo&&(a.chunkInfo=e.chunkInfo),i.getListOfItems(a).$promise},this.getListOfRiskQuestions=function(e){return i.getListOfRiskQuestions(e).$promise},this.createOutage=function(e){return r.createOutage(e).$promise},this.createOutageBulk=function(e){return r.createOutageBulk(e).$promise},this.createAsset=function(e){return r.createAsset(e).$promise.then(function(e){return e[0].items[0]})}}])}(),function(){angular.module("createTicketModule").controller("CreateWorkOrderV2Controller",["$scope","$modal","$state","$filter","$log","createTicketModel","screenConfigurationModel","ticketModel","i18nService","systemAlertService","categoriesService","$q","metadataModel","ticketActionService","events","fieldValidationModel","userModel","permissionModel","roles","layoutConfigurationModel","objectValueMapperService","$timeout",function(e,t,a,n,i,o,r,s,l,c,d,u,p,m,f,g,h,y,E,v,T,S){function C(){e.state={showSpinner:!0,dataIsLoading:!0},e.editMode=!0,e.isNew=!0,e.formContainsInvalidFields=o.formContainsInvalidFields,o.currentTicket=k,e.workorder=k,e.workorderMetadata=D,e.loggedInUserId=h.userId,T.clearMap(k.type),A();var t=p.getMetadataByType(EntityVO.TYPE_WORKORDER).then(function(t){angular.extend(D,t),k.serviceType=_.head(D.types).name;var a=_.head(D.statuses);k.status={value:a.name},!_.isEmpty(a.statusReasons)&&e.isFieldRequired("statusReason")&&(k.status.statusReason=_.head(a.statusReasons).name),k.priority=_.last(D.priorities).name}),a=s.getDraft(EntityVO.TYPE_WORKORDER,null,null,null,!0).then(function(e){k.id=e.id,k.displayId=e.displayId,k.accessMappings=e.accessMappings,k.categorizations=e.categorizations}),n=ScreenConfigurationVO.prototype.CREATE_WORK_ORDER_SCREEN,i=v.loadScreenLayout(n),l=r.loadScreenConfigurationAndCustomFieldLabels(n,EntityVO.TYPE_WORKORDER);u.all([t,a,i,l]).then(function(t){e.state.dataIsLoading=!1,e.state.showSpinner=!1,k.allCategories=_.cloneDeep(d.populateCategories(k.categorizations,D)),e.screenLayout=t[2];var a=r.getEditableFieldsForScreen(n);e.customFields=angular.copy(a),S(function(){e.createWorkorderForm.$setPristine()},0)})}function O(){return e.createWorkorderForm.$dirty&&!e.createWorkorderForm.$pristine||!_.isEmpty(k.attachments)}function A(){e.$on("$stateChangeStart",function(t,n,i){if(O()&&n.name!==EntityVO.TYPE_WORKORDER){t.preventDefault();var r=c.modal({title:l.getLocalizedString("common.notification.dirty.title"),text:l.getLocalizedString("common.notification.dirty.message"),buttons:[{text:l.getLocalizedString("common.labels.yes"),data:{stateName:n.name,stateParams:i}},{text:l.getLocalizedString("common.labels.no")}]});r.result.then(function(t){_.isEmpty(t)||(o.currentTicket=k={},e.createWorkorderForm.$setPristine(),a.transitionTo(t.stateName,t.stateParams))})}})}function I(t,a){var n=!1,o=a.originalEvent,r=!a.saveSelection;if(!a)return void i.warn("Could not open assignment blade. Required Event data is missing. ");var s=a.role;"manager"===s?s="workordermanager":"assignee"===s&&(s="ticketassignee"),n=!!a.assignToMe,n?m.assignToMe(o,s,r,e.workorder,e):m.assign(o,r,e.workorder,e,s)}function b(t,a){k.dynamicFields=a.length?a:"",e.dynamicFields=a.length?angular.copy(a):""}var k={type:EntityVO.TYPE_WORKORDER,autoAssign:!0,customFields:{}},D={};e.createWorkOrder=function(){e.state.showSpinner=!0;var t=o.collectTicketChanges(D);t.summary=t.summary.replace(/\u00a0/g," "),o.createWorkOrderV2(t).then(function(t){t&&(e.state.showSpinner=!1,c.error({text:t,clear:!1}))})},e.cancel=function(){a.go("dashboard")},e.isFieldRequired=function(e){return g.isFieldRequired(k.type,k.status.value,"",e)},p.getMetadataByType("global").then(function(e){var t="T"===e.configurationParameters["Enable-Progressive-Views"]||"true"===e.configurationParameters["Enable-Progressive-Views"];t="T"!==localStorage.getItem("overridePV")&&t,t&&localStorage.getItem("midtierUrl")?a.go(a.current.name+"PV"):C()})["catch"](function(e){e&&c.error({text:e.data.error,clear:!1})}),e.$on(f.SHOW_ASSIGN_TICKET_BLADE,I),e.$on(f.SHOW_DYNAMIC_FIELDS_FROM_TEMPLATE,b),e.$on(f.CUSTOM_FIELD_VALUE_CHANGE,function(){e.$broadcast(f.REFRESH_FIELD_VALUES)})}])}(),function(){angular.module("customWidgetsModule").directive("affectedAsset",["customFieldLinkFunction","assetService","events","objectValueMapperService","$timeout",function(e,t,a,n,i){return{restrict:"E",replace:!0,scope:{data:"=",isEditable:"=",ticketType:"=?",ticket:"=?"},templateUrl:"views/custom-widgets/affected-asset.html",link:function(o){function r(){o.company=n.getExactValueByFieldName("company")||n.getExactValueByFieldName("customerCompany"),o.customer=n.getValueByFieldName("customer")||n.getValueByFieldName("customerLoginId")&&{id:n.getValueByFieldName("customerLoginId")}||{},!o.company&&o.customer&&o.customer.company&&o.customer.company.name&&(o.company=o.customer.company.name),o.company||(o.data.isReadOnly=!0),o.ticket.serviceCIRequired&&"impactedService"===o.data.name&&(o.data.isRequired=!0)}function s(){var e=o.data.value,t=!1;if(e.ci.product&&e.ci.product.categorizations&&e.ci.product.categorizations.length){var i=n.getFieldsByType("dynamicSelectionField");_.forEach(i,function(a){if("company"!==a.name){var i=e.ci.product.categorizations[0].tiers[a.name];if(i)return n.setByProperty(a.name,"value",i,!1),void(t=!0)}})}t&&o.$emit(a.CUSTOM_FIELD_VALUE_CHANGE)}function l(){o.data.value.oldDataValue=o.data.value.ci,null!==o.data.value.oldDataValue&&(o.data.value.isCheckedValue=!0)}e(o),o.data.value.oldDataValue=o.data.value.ci,null!==o.data.value.oldDataValue&&(o.data.value.isCheckedValue=!0),o.onValueChange=function(){s(),o.$emit(a.WIDGET_VALUE_CHANGE,{fieldName:o.data.name,memberName:o.data.name}),o.$emit(a.AFFECTED_SERVICE_VALUE_CHANGED,o.data.value.ci)},o.getList=function(e){o.dataLoading=!0,r();var a="causalCI"===o.data.name?t.getListOfAssetsForCompany(e,o.company,o.ticketType,o.customer.id):t.getListOfAssetsByTypeForCompany(e,"Business Service",o.company,o.ticketType,o.customer.id);return a.then(function(e){return o.exceedsChunkSize=e[0].items[0].exceedsChunkSize,o.isTooltipOpen=!0,i(function(){o.isTooltipOpen=!1},1e4),e[0].items[0].objects})["finally"](function(){o.dataLoading=!1})},o.onInputFocusBlur=function(){o.isTooltipOpen=!1},o.clearValue=function(){o.data.value.ci="",o.onValueChange()},o.$watch("data.setValueFlag",function(e){"#$#"!==e&&e&&(o.data.value=e,o.onValueChange(),o.data.setValueFlag="#$#")}),o.$on(a.SERVICECI_REQUIRED,function(e,t){var a=n.getFieldByName(t.name);(angular.isUndefined(a.originalRequired)||null===a.originalRequired||a.isRequired!==a.originalRequired)&&(a.originalRequired=a.isRequired),a.isRequired=a.originalRequired||t.isRequired}),o.$on(a.DISCARD_CHANGES,l),r()}}}])}(),function(){angular.module("customWidgetsModule").directive("assignWidget",["events","userModel",function(e,t){return{restrict:"E",replace:!0,scope:{data:"=",context:"=",isEditable:"=",isNew:"="},templateUrl:"views/custom-widgets/assign-widget.html",controller:["$scope","userModel","events",function(e,t,a){e.assignTicket=function(t,n){var i=_.isBoolean(e.$parent.editMode)?e.$parent.editMode:!!_.isBoolean(e.$parent.$parent.editMode)&&e.$parent.$parent.editMode,o={originalEvent:t,assignToMe:!!n,saveSelection:!i,role:e.data.primaryKey};e.$emit(a.SHOW_ASSIGN_TICKET_BLADE,o)},e.isAutoAssigned=function(){return e.data.value&&(e.data.value.autoAssign||e.data.value.managerAutoAssign||e.data.value.coordinatorAutoAssign)},e.showAssignToMe=function(){if(t.userFullData.availableForAssignment&&e.data.isAssigneeWidget()&&(!e.data.value||e.data.value&&t.decodedUserId!==e.data.value.id)&&e.context.accessMappings){if("coordinator"===e.data.primaryKey)return e.context.accessMappings.coordinatorSelfAssignmentAllowed;if("manager"===e.data.primaryKey)return e.context.accessMappings.managerSelfAssignmentAllowed;if("assignee"===e.data.primaryKey)return e.context.type===EntityVO.TYPE_CHANGE?e.context.accessMappings.coordinatorSelfAssignmentAllowed:e.context.accessMappings.assigneeSelfAssignmentAllowed}return!1}}]}}])}(),function(){angular.module("customWidgetsModule").directive("categoryCompany",["customFieldLinkFunction","createTicketModel","searchModel","systemAlertService","$filter","objectValueMapperService","events",function(e,t,a,n,i,o,r){return{restrict:"E",replace:!0,scope:{data:"=",context:"=",allowLocationCompanyEdit:"=",isEditable:"="},templateUrl:"views/custom-widgets/category-company.html",link:function(t){function s(){t.allowLocationCompanyEdit?t.locationCompany||(t.locationCompany=t.data.value?_.cloneDeep(t.context.locationCompany):{name:""}):t.locationCompany=null}function l(){a.getOperatingCompanies(null,-1).then(function(e){t.companies=_.cloneDeep(e.companies),u.tooManyCompanies=e.exceedsChunkSize})}function c(){return t.context.company&&t.context.company.name?t.context.company:t.context.customer&&t.context.customer.company?t.context.customer.company:{name:""}}function d(){var e=n.modal({type:"info",title:i("i18n")("common.notification.dirty.title"),text:i("i18n")("categorization.companyChange.warning"),buttons:[{text:i("i18n")("common.button.yes"),data:!0},{text:i("i18n")("common.button.no"),data:!1}]});return e.result}e(t);var u={loadingData:!1,tooManyCompanies:!1};t.state=u,t.allowLocationCompanyEdit&&(t.data.ticketCompany=c(),s(),t.useLocationCompany=t.locationCompany&&t.locationCompany.name&&t.locationCompany.name!==t.data.ticketCompany.name,l()),t.onUseLocationCompanyChange=function(e){var a=e.target;t.useLocationCompany=a.checked,t.useLocationCompany||t.onSelectCompany(t.data.ticketCompany)},t.onSelectCompany=function(e){t.data.locationCompanySelected=!0;var a=o.getFieldsByType("category"),n=[];_.forEach(a,function(e){e.value&&e.value.serializedValue&&n.push(e.value.serializedValue)});var i=[];t.data.members&&_.forEach(t.data.members,function(e){i.push(e.name)}),e&&t.locationCompany&&e.name!==t.locationCompany.name&&n.length?d().then(function(a){a&&(t.locationCompany=e,t.data.value=e.name,t.$emit(r.WIDGET_VALUE_CHANGE,{fieldName:t.data.name,memberName:i}))}):(t.locationCompany=e,t.data.value=e&&e.name,t.$emit(r.WIDGET_VALUE_CHANGE,{fieldName:t.data.name,memberName:i}))},t.isLocationCompanyLocked=function(){return t.context.type===EntityVO.TYPE_INCIDENT&&t.context.status&&~[EntityVO.STATUS_CLOSED,EntityVO.STATUS_RESOLVED].indexOf(t.context.status.value.toLowerCase())},t.getCompaniesByName=function(e){return a.getCompaniesByText(e).then(function(e){return e.companies})},t.$watch("data.setValueFlag",function(e){"#$#"!==e&&e&&(t.data.value=e,t.$emit(r.WIDGET_VALUE_CHANGE,{fieldName:t.data.name}),t.data.setValueFlag="#$#")}),t.$watch("data.ticketCompany",function(e,a){!e||!e.name||a&&a.name&&e.name===a.name||t.data.locationCompanySelected||(t.locationCompany=e,t.data.value=e.name)});var p={locationCompany:_.cloneDeep(t.locationCompany),useLocationCompany:t.useLocationCompany};t.$on(r.DISCARD_CHANGES,function(){t.locationCompany=_.cloneDeep(p.locationCompany),t.data.value=t.locationCompany&&t.locationCompany.name,t.useLocationCompany=t.locationCompany&&t.locationCompany.name&&t.locationCompany.name!==t.data.ticketCompany.name})}}}])}(),function(){angular.module("customWidgetsModule").controller("CategoryItemController",["$scope","$timeout","categoriesService","events","objectValueMapperService","metadataModel",function(e,t,a,n,i,o){function r(){e.category=e.data&&e.data.value,_.forEach(e.category.listOfTiers,function(e,t){e.index=t}),e.category.serializedValue=a.getDisplayValues(e.category),E=_.cloneDeep(e.data.value),e.data.isReadOnly=e.data.isReadOnly||_.isEmpty(s()),o.getMetadataByType("global").then(function(t){C=!("No"===t.applyCognitiveForCategorization),e.useCognitive=C,v=t.configurationParameters&&t.configurationParameters.categoryChunkSize?parseInt(t.configurationParameters.categoryChunkSize):80,e.productAliasBasedSearch=String(t.configurationParameters.productAliasBasedSearch)}),l()}function s(){var t="",a=i.getValueByFieldName("locationCompany"),n=a?a:i.getValueByFieldName("company")||i.getValueByFieldName("customerCompany");return n||(t=i.getValueByFieldName("customer"),n=t&&t.company?t.company.name:e.context.company&&e.context.company.name),n?{name:n}:null}function l(){e.membersMapByName=e.data.members.reduce(function(t,a){return t[a.name]=a,(a.isRequired||a.itsmRequired)&&(e.data.hasRequiredMember=!0),t},{})}function c(e){for(var t=1,a=e.listOfTiers.length;t<a;t++)e.listOfTiers[t].disabled=!e.listOfTiers[t-1].selectedValue}function d(e,t){for(var a=t+1,n=e.listOfTiers.length;a<n;a++)e.listOfTiers[a].selectedValue="",e.listOfTiers[a].availableValues=[]}function u(t){var a=A?{id:e.context.id}:{};return _.forEach(t.dependAttributes,function(t){var n=i.getFieldsByType("category");_.forEach(n,function(e){if(e&&e.value){var n=_.find(e.value.listOfTiers,{name:t});n&&n.selectedValue&&(a[n.name]=n.selectedValue)}});var o=i.getValueByFieldName(t);o&&(a[t]=o),e.dependentCategories&&e.dependentCategories.length&&_.forEach(e.dependentCategories,function(e){var n=_.find(e.listOfTiers,{name:t});n&&n.selectedValue&&(a[n.name]=n.selectedValue)}),_.forEach(e.context.customFields,function(e,n){n===t&&(a[n]=e)})}),a}function p(t,a){for(var n={company:s(),depends:{}};a.dependAttribute;){var o=_.find(t.listOfTiers,{name:a.dependAttribute});o&&(n.depends[o.name]=o.selectedValue,"productName"==o.name&&T&&(n.depends.manufacturerName=T),"resProductName"==o.name&&S&&(n.depends.manufacturerName=S),a=o)}if(!_.isEmpty(n.depends)&&e.multiple&&(n.company=t.company),n.depends.id=e.context.id,e.context.type===EntityVO.TYPE_INCIDENT&&e.serviceType&&("operationCategoryTier1"===a.name||"productCategoryTier1"===a.name||"resOperationCategoryTier1"===a.name||"resProductCategoryTier1"===a.name))if(t.serviceType)n.serviceType=t.serviceType;else{var r=i.getValueByFieldName("serviceType");e.serviceType=_.isObject(r)?r.serviceType:r,n.serviceType=e.serviceType}return _.forEach(t.dependAttributes,function(t){var a=i.getFieldsByType("category");_.forEach(a,function(e){if(e&&e.value){var a=_.find(e.value.listOfTiers,{name:t});a&&a.selectedValue&&(n.depends[a.name]=a.selectedValue)}});var o=i.getValueByFieldName(t);o&&(n.depends[t]=o),e.dependentCategories&&e.dependentCategories.length&&_.forEach(e.dependentCategories,function(e){var a=_.find(e.listOfTiers,{name:t});a&&a.selectedValue&&(n.depends[a.name]=a.selectedValue)}),_.forEach(e.context.customFields,function(e,a){a===t&&(n.depends[a]=e)})}),angular.toJson(n)}function m(t){var a=_.isArray(t)?{serializedValue:_.compact(t).join(" > "),tiers:t}:{serializedValue:_.compact(t.tiers).join(" > "),tiers:t.tiers,company:t.company};if(a&&a.tiers&&a.tiers.length>5&&""!==a.tiers[5]&&"true"===e.productAliasBasedSearch){var n=a.tiers.slice(0),i=n.pop();a.serializedValue=_.compact(n).join(" > ")+" ("+i+")"}return a}function f(e){var t=i.getFieldByName("productManufacturer");t&&(t.value=e),T=e}function g(e){var t=i.getFieldByName("resProductManufacturer");t&&(t.value=e),S=e}function h(){e.category.edit=!1,E=_.cloneDeep(e.data.value)}function y(){e.category=_.cloneDeep(E),e.category.edit=!1,e.data.value=e.category}e.isShowDefaultListAction=!1;var E,v,T,S,C=!1,O={loadingTierData:!1},A=e.context.type===EntityVO.TYPE_INCIDENT||e.context.type===EntityVO.TYPE_CHANGE||e.context.type===EntityVO.TYPE_RELEASE;e.recommendationMethod=null,e.isCognitiveRecommendation=!1,e.context.serviceType&&(e.serviceType=e.context.serviceType),e.showDefaultList=function(t,a){var n=$(a.target).parent().parent().find("input.category-widget__category-editor");e.isCategoryInputChange=!1,e.isTypeaheadListVisible(a)||e.getCategories("",t).then(function(a){C&&a&&a.length&&"COGNITIVE"===e.recommendationMethod?(e.updateCategory(a[0],t),e.isCognitiveRecommendation=!1,t.cognitiveFlag=!0):C&&(e.isCognitiveRecommendation=!0,setTimeout(function(){n.trigger("click").trigger("click")},0))})["finally"](function(){e.isShowDefaultListAction=!0,C||angular.element("#category-typeahead-"+t.name).focus()})},e.onFocus=function(a){e.isShowDefaultListAction&&(t(function(){$(a.target).click()}),e.isShowDefaultListAction=!1)},e.isCategoryInputChange=!1,e.onCategoryInputChange=function(){e.isCategoryInputChange=!0},e.validate=function(){e.category.dirty||(e.category.serializedValue="")},e.onInputFocusBlur=function(){e.category.isTooltipOpen=!1},e.getCategories=function(n,o){if(!_.isEmpty(s())){o.isDataLoading=!0,o.dirty=!1,o.recommendations=[];var r;if(n.length>0){if(r={restVersion:"true"!==e.productAliasBasedSearch||"product"!=o.name&&"resolutionProduct"!=o.name?"v4":"v5",entityType:e.context.type,categoryType:o.name,searchText:n,criteria:{company:s()},chunkInfo:{startIndex:0,chunkSize:v}},r.criteria.depends=u(o),e.context.type===EntityVO.TYPE_INCIDENT&&e.serviceType){var l=i.getValueByFieldName("serviceType");e.serviceType=_.isObject(l)?l.serviceType:l,r.criteria.serviceType=e.serviceType}return a.searchCategoriesV4WithChunkSize(r).then(function(a){return e.category.isTooltipOpen=e.category.exceedsChunkSize=a.exceedsChunkSize,t(function(){e.category.isTooltipOpen=!1},1e4),_.map(a.items,function(e){return m(e)})})["finally"](function(){o.isDataLoading=!1})}var c=i.getValueByFieldName("summary");if(r={restVersion:"EntityVO.TYPE_ASSET"===e.context.type?angular.noop():"v2",entityType:e.context.type,categoryType:o.name,searchData:{company:s(),summary:c},size:5},A&&(r.searchData.id=e.context.id),e.context.type===EntityVO.TYPE_INCIDENT&&e.serviceType){var d=i.getValueByFieldName("serviceType");
e.serviceType=_.isObject(d)?d.serviceType:d,r.searchData.serviceType=e.serviceType}return a.getRecommendedCategory(r).then(function(a){if(e.recommendationMethod=a.categorizationMethod,!o.serializedValue)return o.isTooltipOpen=o.exceedsChunkSize=a.exceedsChunkSize||!1,t(function(){o.isTooltipOpen=!1},1e4),o.recommendations=_.map(a.items,function(e){return m(e)})})["finally"](function(){o.isDataLoading=!1})}},e.onInputFocusBlur=function(t){t.isTooltipOpen=!1,e.isTooltipOpen=!1},e.onSearchInputBlur=function(e){t(function(){e.searchText=""},1e3)},e.loadDataForTier=function(t,n,i,o){if(!O.loadingTierData){O.loadingTierData=!0,n.tooManyItems=!1,o?n.isTypeaheadLoading=!0:n.populatingAvailableValues=!0;var r={restVersion:angular.noop(),entityType:e.context.type,categoryType:t.name,tierName:n.name,criteria:p(t,n),searchText:i};return"productName"!==n.name&&"resProductName"!==n.name||(r.restVersion="v3"),a.getCategoryTierData(r).then(function(e){return o?(n.tooManyItems=e.exceedsChunkSize,e.tiers):(n.availableValues=e.tiers,void(n.exceedsChunkSize=e.exceedsChunkSize))})["finally"](function(){O.loadingTierData=!1,o?n.isTypeaheadLoading=!1:n.populatingAvailableValues=!1})}},e.selectTierValue=function(t,i,o,r){var s=_.isObject(o)?o.tier:o;angular.equals(i.selectedValue,s)?"productName"===i.name?f(o.manufacturer):"resProductName"===i.name&&g(o.manufacturer):(i.selectedValue=s,t.dirty=!0,t.company=o.company,d(t,i.index),c(t),t.serializedValue=a.getDisplayValues(t),"productName"===i.name?f(o.manufacturer):"resProductName"===i.name&&g(o.manufacturer),e.$emit(n.WIDGET_VALUE_CHANGE,{fieldName:e.data.name,memberName:i.name}),e.onTierInputChange()),e.focusNextInputElement(r)},e.updateCategory=function(t,a){if(a.serializedValue&&a.serializedValue.tiers&&a.serializedValue.tiers.length>5&&0===a.recommendations.length&&"true"===e.productAliasBasedSearch){var i=a.serializedValue.tiers.slice(0);i.pop(),a.serializedValue.serializedValue=_.compact(i).join(" > ")}var o=[];a.serializedValue=t.serializedValue,a.company=t.company;for(var r=0;r<a.listOfTiers.length;r++)a.listOfTiers[r].selectedValue=t.tiers[r],o.push(a.listOfTiers[r].name);if(e.context.categorizations)for(var s=0;s<e.context.categorizations.length;s++)if(e.context.categorizations[s].name==a.name&&a.listOfTiers)for(var l=0;l<a.listOfTiers.length;l++){var c=a.listOfTiers[l].name;e.context.categorizations[s].tiers[c]=a.listOfTiers[l].selectedValue}a.dirty=!0,e.$emit(n.WIDGET_VALUE_CHANGE,{fieldName:e.data.name,memberName:o})},e.onSearchCategoriesClick=function(t,a){var n=e.getParentWrapper(a);t.edit=!1,e.focusInputElement(a,n)},e.onBrowseCategoriesClick=function(t,a){var n=e.getParentWrapper(a);t.edit=!0,c(t),e.focusFirstTierElement(a,n)},e.$on(n.AFTER_SAVED_CHANGES,h),e.onTierInputChange=function(){O.pendingChanges=!0},e.clear=function(t){var a=[];O.pendingChanges=!0,t.dirty=!0,t.serializedValue="",t.company=null,_.forEach(t.listOfTiers,function(e){e.selectedValue="",a.push(e.name)}),c(t),e.$emit(n.WIDGET_VALUE_CHANGE,{fieldName:e.data.name,memberName:a})},e.clearTier=function(t,i){i.selectedValue="",t.dirty=!0,d(t,i.index),c(t),t.serializedValue=a.getDisplayValues(t),e.$emit(n.WIDGET_VALUE_CHANGE,{fieldName:e.data.name,memberName:i.name}),e.onTierInputChange()},e.$watch("data.triggerClear",function(t){t&&(e.data.triggerClear=!1,e.clear(e.category))}),e.$on(n.DISCARD_CHANGES,y),r()}])}(),function(){angular.module("customWidgetsModule").directive("categoryItem",["$timeout","customFieldLinkFunction","widgetDependencyHandlerService","events",function(e,t,a,n){return{restrict:"E",replace:!0,scope:{data:"=",context:"=",dependentCategories:"=?",useLocationCompany:"=?",locationCompany:"=?",isEditable:"="},templateUrl:"views/custom-widgets/category-item.html",controller:"CategoryItemController",link:function(i){t(i),i.isTypeaheadListVisible=function(e){var t=$(e.currentTarget).closest("div.category-widget").find('ul.dropdown-menu[id^="typeahead"]');return $(t).is(":visible")},i.focusInputElement=function(t,a){e(function(){a.find('input[type="text"]').focus()},0)},i.getParentWrapper=function(e){return $(e.currentTarget).parents(".category-widget")},i.focusFirstTierElement=function(t,a){e(function(){a.find("div.dropdown-input__button").first().focus()},0)},i.focusNextInputElement=function(t){e(function(){var e=$(t.target).parents(".dropdown").next();e.hasClass("dropdown")?e.find(".dropdown-input__button").focus():$(t.target).parents(".dropdown-menu").next().find(".small-btn_secondary").focus()},0)},i.setTiers=function(e,t){i.data.value.listOfTiers=[],i.data.value.listOfTiersToShow=[];for(var a in t.tiers)i.data.value.listOfTiers.push({name:a,selectedValue:t.tiers[a],label:""}),i.data.value.listOfTiersToShow.push(a)},i.onValueChange=function(e){i.setTiers(i.data.value.name,e),a.handleCategoryChange(i.data.value,e.tiers),i.$emit(n.WIDGET_VALUE_CHANGE,{fieldName:i.data.name,memberName:e.changedTiers})},i.$watch("data.setValueFlag",function(e){if("#$#"!==e&&e){var t={};i.data.value.listOfTiers.forEach(function(a){t[a.name]=void 0!==e.tiers[a.name]?e.tiers[a.name]:a.selectedValue}),e.tiers=t,i.onValueChange(_.cloneDeep(e)),i.data.setValueFlag="#$#"}})}}}])}(),function(){angular.module("myitsmApp").directive("changeClass",["fieldValidationModel","events",function(e,t){return{restrict:"E",replace:!0,templateUrl:"views/custom-widgets/change-class-directive.html",scope:{data:"=",metadata:"=",isEditable:"=",isNew:"=?"},link:function(a,n){function i(){a.changeMetadata=a.metadata,a.draftTicket.timing=_.head(_.filter(a.changeMetadata.timings,{name:a.isNew?a.data.value.timing.name:a.data.value.timing})),a.draftTicket.timingReason=_.head(_.filter(a.changeMetadata.timingReasons,{name:a.data.value.timingReason})),a.updateTimingReasonsForSelectedChangeClass()}function o(){a.editMode=!0}function r(){a.editMode=!1}function s(){a.editMode=!1,i(),a.$emit(t.WIDGET_VALUE_CHANGE,{fieldName:a.data.name})}a.draftTicket={},a.$parent.isNew?a.fieldLengthForSm6=!0:n.closest(".layout-renderer__child-column")[0]&&(a.fieldLengthForSm6=_.includes(n.closest(".layout-renderer__child-column")[0].className,"col-sm-6"),a.fieldLengthForSm4=_.includes(n.closest(".layout-renderer__child-column")[0].className,"col-sm-4")),a.$watch("data.setValueFlag",function(e){if(e&&"#$#"!==e){var t=_.get(e,"timing",e);_.has(e,"timingReason")&&(a.draftTicket.timingReason=_.head(_.filter(a.changeMetadata.timingReasons,{name:_.get(e,"timingReason")})),_.has(e,"timing")&&(t=_.get(e,"timing"))),t&&(a.draftTicket.timing=_.head(_.filter(a.changeMetadata.timings,{name:t}))),a.updateTiming(),a.data.setValueFlag="#$#"}}),a.isFieldRequired=function(t){var n=!1;return a.draftTicket.timing&&(n=e.isFieldRequired(EntityVO.TYPE_CHANGE,"Draft",a.draftTicket.timing.name,t)),n},a.$on(t.TOGGLE_EDIT_MODE,o),a.$on(t.AFTER_SAVED_CHANGES,r),a.$on(t.DISCARD_CHANGES,s),a.updateTiming=function(){a.data.value.timing=a.isNew?a.draftTicket.timing:a.draftTicket.timing.name,a.data.value.timingReason="",a.draftTicket.timingReason=null,a.data.value&&a.data.value.timing&&a.updateTimingReasonsForSelectedChangeClass(),a.$emit(t.WIDGET_VALUE_CHANGE,{fieldName:a.data.name,memberName:"timing"}),a.$emit(t.CHANGE_CLASS_VALUE_CHANGED,a.data.value.timing)},a.updateTimingReason=function(){a.data.value.timingReason=a.draftTicket.timingReason.name,a.$emit(t.WIDGET_VALUE_CHANGE,{fieldName:a.data.name,memberName:"timingReason"})},a.updateTimingReasonsForSelectedChangeClass=function(){a.changeMetadata&&a.changeMetadata.timings&&a.changeMetadata.timings.forEach(function(e){a.draftTicket.timing&&a.draftTicket.timing.name&&e.name&&e.name==a.draftTicket.timing.name&&(a.changeMetadata.timingReasons=_.cloneDeep(e.timingReasons))})},i()}}}])}(),function(){angular.module("customWidgetsModule").directive("dateWidget",["customFieldLinkFunction","events","editTicketDatesService","$state","tabIds","$rootScope","objectValueMapperService","expressionEvaluatorService","configurationModel",function(e,t,a,n,i,o,r,s,l){return{restrict:"E",replace:!0,scope:{data:"=",isEditable:"=",isDatesPanel:"=",context:"=",editMode:"="},templateUrl:"views/custom-widgets/dates-widget.html",link:function(c){function d(e){var t;switch(e.name){case"scheduledDates":t="scheduled";break;case"actualDates":t="actual";break;case"targetDate":t="target"}if("scheduled"===t||"actual"===t)a.updateDateTime(c.dateForm,e.value,t);else if("target"===t){if(!c.dateForm)return;a.updateTargetDateTime(c.dateForm,c.context)}}c.isDatesPanel&&(c.data.requiredCondition&&(c.data.isRequired=s.evaluate(c.data.requiredCondition)),c.data.readOnlyCondition&&(c.data.isReadOnly=s.evaluate(c.data.readOnlyCondition))),c.tabIds=i,c.disabled=!1,c.datePickerOptions={"show-weeks":!1,startingDay:l.getWeekStartingDay(),minDate:moment().year(1970).month(0).date(2),maxDate:moment().year(2038).month(0).date(18)};var u=_.cloneDeep(c.data.value);c.targetDate="targetDate",e(c),c.context.timing&&("Latent"===c.context.timing||c.context.timing.name&&"Latent"===c.context.timing.name)&&("scheduledDates"===c.data.name&&(c.data.isReadOnly=!0),"actualDates"===c.data.name&&(c.data.isRequired=!0)),c.context.earliestStartDate&&(c.earliestStartDate=new Date(c.context.earliestStartDate)),c.status={openedStart:!1,openedEnd:!1,openedTimeStart:!1,openedTimeEnd:!1},c.openStart=function(e){e.preventDefault(),e.stopPropagation(),c.status.openedStart=!0,c.status.openedEnd=!1,c.status.openedTimeStart=!1,c.status.openedTimeEnd=!1},c.openEnd=function(e){e.preventDefault(),e.stopPropagation(),c.status.openedEnd=!0,c.status.openedStart=!1,c.status.openedTimeStart=!1,c.status.openedTimeEnd=!1},c.editDatesView=function(){n.go("changeEditDates",{id:n.params.id})},c.validator=function(e){return"scheduledStartDate"===e?a.scheduledStartDateDisabled(c.context,c.editMode):"scheduledEndDate"===e?a.scheduledEndDateDisabled(c.context,c.editMode):"actualStartDate"===e?a.actualStartDateDisabled(c.context,c.editMode):"actualEndDate"===e?a.actualEndDateDisabled(c.context,c.editMode):"targetDate"===e?c.context.timing&&"Latent"===c.context.timing:void 0},c.onFieldValueChange=function(e,a,n){_.forEach(e.members,function(t){c.context[t.name]=e.value[t.name]}),"start"===n&&(e.initDate=angular.copy(e.value[e.members[0].name])),d(e),o.$broadcast(t.WIDGET_VALUE_CHANGE,{fieldName:e.name,processed:!0,memberName:a})},c.targetDateErrorMessageVisible=function(){return(c.editMode||c.context.useTargetDate)&&c.dates&&c.dates.targetDate&&c.dates.targetDate.$invalid};var p=o.$on(t.WIDGET_VALUE_CHANGE,function(e,t){t&&"status"===t.fieldName&&(c.showEarliestDate="Scheduled For Review"===r.getValueByFieldName(t.fieldName))});c.$on("$destroy",function(){p()}),c.$on(t.AFTER_SAVED_CHANGES,function(){u=_.cloneDeep(c.data.value)}),c.$on(t.DISCARD_CHANGES,function(){c.data.value=_.cloneDeep(u),_.forEach(c.data.members,function(e){c.context[e.name]=c.data.value[e.name]})}),c.$on(t.CLEAR_CHANGE_DATES,function(e,t){"scheduledDates"===c.data.name?(c.data.value.scheduledEndDate=null,c.data.value.scheduledStartDate=null):"actualDates"===c.data.name?(c.data.value.actualStartDate=null,c.data.value.actualEndDate=null):"targetDate"===c.data.name&&(c.data.value.targetDate=null),c.disabled=t}),c.$on(t.UPDATE_SCHEDULE_DATE,function(e,t){var a,n;a=c.data.value[t.name]?c.data.value[t.name].valueOf():c.data.value[t.name],n=t.value?t.value.valueOf():t.value,a!==n&&(c.data.value[t.name]=t.value,d(c.data))}),c.$watch("data.setValueFlag",function(e){if("#$#"!==e&&e){var t={},a=_.omitBy(e,function(e){return _.isEmpty(e)&&!_.isNumber(e)||_.isNumber(e)&&e<0});_.forEach(a,function(e,a){t[a]=new Date(parseInt(e))}),c.data.value=t,c.data.setValueFlag="#$#"}}),c.$watch("data.isHidden",function(e,a){e!==a&&c.$emit(t.UPDATE_DATE_LABEL_VISIBILITY,{name:c.data.name,isHidden:e})})}}}])}(),function(){angular.module("customWidgetsModule").directive("emailField",["customFieldLinkFunction","events","objectValueMapperService",function(e,t,a){return{restrict:"E",replace:!0,scope:{data:"=",isEditable:"=",ticket:"="},templateUrl:"views/custom-widgets/email-field.html",link:function(n){e(n);var i=n.data.members.length?n.data.members[0].name:null;angular.isDefined(n.data.value)&&(n.data.ootbValue=n.data.value[i]),n.$watch("data.setValueFlag",function(e){e&&"#$#"!==e&&(_.isObject(e)&&e.hasOwnProperty(i)?n.data.ootbValue=e[i]:n.data.ootbValue=e,n.onFieldValueChange(),n.data.setValueFlag="#$#")}),n.getEmailSubject=function(){return encodeURIComponent(n.ticket.displayId+" : "+n.ticket.summary)},n.onFieldValueChange=function(){var e=a.getFieldByName(n.data.name);e.value[i]=n.data.ootbValue;var o=[];n.data.members&&_.forEach(n.data.members,function(e){o.push(e.name)}),n.$emit(t.WIDGET_VALUE_CHANGE,{fieldName:n.data.name,memberName:o})},n.$on(t.DISCARD_CHANGES,function(){n.data.ootbValue=n.data.value[i];var e=a.getFieldByName(n.data.name);e.value[i]=n.data.ootbValue})}}}])}(),function(){angular.module("customWidgetsModule").directive("impactedAreasWidget",["systemAlertService","$filter","searchModel",function(e,t,a){return{restrict:"E",templateUrl:"views/custom-widgets/impacted-areas-widget.html",scope:{data:"=",ticket:"=",isNew:"="},controller:["$scope","userModel","createTicketModel","events","$q","ticketModel","objectValueMapperService",function(n,i,o,r,s,l,c){function d(e,t){n.impactedAreas.length=0,_.forEach(t.impactedAreas,function(e){n.impactedAreas.push(e)}),p.impactedAreas=_.cloneDeep(n.impactedAreas)}function u(){n.customer=n.ticket.type===EntityVO.TYPE_CHANGE?c.getValueByFieldName(FieldVO.prototype.WIDET_NAMES.requestedFor):c.getValueByFieldName(FieldVO.prototype.WIDET_NAMES.customer)}n.state={},n.selections={};var p=_.cloneDeep(n.data.value);n.isEditable=n.data.isEditable(n.ticket.accessMappings),a.getOperatingCompanies(null,-1).then(function(e){n.selections.companies=_.cloneDeep(e.companies),n.state.tooManyCompanies=e.exceedsChunkSize}),n.isNew&&u(),n.data.value||(n.data.value={impactedAreas:[],addedImpactedAreas:[],removedImpactedAreas:[]}),n.impactedAreas=n.data.value.impactedAreas=n.data.value.impactedAreas||[],n.addedImpactedAreas=n.data.value.addedImpactedAreas=n.data.value.addedImpactedAreas||[],n.removedImpactedAreas=n.data.value.removedImpactedAreas=n.data.value.removedImpactedAreas||[],n.$watch("customer.company",function(e){e&&(n.currentImpactedArea={company:e})}),n.$watch("currentImpactedArea.company",function(e){e&&(n.currentImpactedArea.region=null,n.currentImpactedArea.siteGroup=null,n.currentImpactedArea.site=null,n.loadOrganizations(),n.loadRegions(),n.loadSiteGroups(),n.loadSites())}),n.$watch("currentImpactedArea.organization",function(e){e&&n.loadDepartments()}),n.$watch("currentImpactedArea.region",function(e){e?(n.currentImpactedArea.siteGroup&&n.currentImpactedArea.siteGroup.attributeMap.regionName!==e.name&&(n.currentImpactedArea.siteGroup=null),n.currentImpactedArea.site&&n.currentImpactedArea.site.attributeMap.regionName!==e.name&&(n.currentImpactedArea.site=null),n.loadSiteGroups(),n.loadSites()):(n.selections.siteGroups=null,n.selections.sites=null)}),n.$watch("currentImpactedArea.siteGroup",function(e){e&&(n.currentImpactedArea.region={name:e.attributeMap.regionName},n.currentImpactedArea.site&&n.currentImpactedArea.site.attributeMap.siteGroupName!==e.name&&(n.currentImpactedArea.site=null))}),n.$watch("currentImpactedArea.site",function(e){e&&(n.currentImpactedArea.siteGroup={name:e.attributeMap.siteGroupName,attributeMap:{regionName:e.attributeMap.regionName}})}),n.getCompaniesByName=function(e){return a.getCompaniesByText(e).then(function(e){return{list:e.companies,exceedsChunkSize:e.exceedsChunkSize}})},n.loadOrganizations=function(){n.currentImpactedArea.organization=null,n.currentImpactedArea.department=null,n.selections.organizations=null,n.state.organizationsLoading=!0;var e={companyName:n.currentImpactedArea.company.name};o.getList(EntityVO.TYPE_ORGANIZATION,e).then(function(e){n.state.organizationsLoading=!1,n.selections.organizations=e.objects,n.state.tooManyOrganizations=e.exceedsChunkSize})},n.loadDepartments=function(){n.currentImpactedArea.department=null,n.selections.departments=null,n.state.departmentsLoading=!0;var e={companyName:n.currentImpactedArea.company.name,organizationName:n.currentImpactedArea.organization.name};o.getList(EntityVO.TYPE_DEPARTMENT,e).then(function(e){n.state.departmentsLoading=!1,n.selections.departments=e.objects,n.state.tooManyDepartments=e.exceedsChunkSize})},n.loadRegions=function(){n.selections.regions=null,n.state.regionsLoading=!0;var e={companyName:n.currentImpactedArea.company.name};o.getList(EntityVO.TYPE_REGION,e).then(function(e){n.state.regionsLoading=!1,n.selections.regions=e.objects,n.state.tooManyRegions=e.exceedsChunkSize})},n.loadSiteGroups=function(){n.selections.siteGroups=null,n.state.siteGroupsLoading=!0;var e={companyName:n.currentImpactedArea.company.name};n.currentImpactedArea.region&&(e.regionName=n.currentImpactedArea.region.name),o.getList(EntityVO.TYPE_SITE_GROUP,e).then(function(e){n.state.siteGroupsLoading=!1,n.selections.siteGroups=e.objects,n.state.tooManySiteGroups=e.exceedsChunkSize})},n.loadSites=function(){n.selections.sites=null,n.state.sitesLoading=!0;var e={companyName:n.currentImpactedArea.company.name};n.currentImpactedArea.region&&(e.regionName=n.currentImpactedArea.region.name),n.currentImpactedArea.siteGroup&&(e.siteGroupName=n.currentImpactedArea.siteGroup.name),o.getList(EntityVO.TYPE_SITE,e).then(function(e){n.state.sitesLoading=!1,n.selections.sites=e.objects,n.state.tooManySites=e.exceedsChunkSize})},n.loadRegionsByName=function(e){var t={companyName:n.currentImpactedArea.company.name};return o.getListOfRegionsByName(t,e).then(function(e){return n.state.regionsLoading=!1,{list:e.objects,exceedsChunkSize:e.exceedsChunkSize}})},n.loadSiteGroupsByName=function(e){var t={companyName:n.currentImpactedArea.company.name};return n.currentImpactedArea.region&&(t.regionName=n.currentImpactedArea.region.name),o.getListOfSiteGroupsByName(t,e).then(function(e){return n.state.siteGroupsLoading=!1,{list:e.objects,exceedsChunkSize:e.exceedsChunkSize}})},n.loadSitesByName=function(e){var t={companyName:n.currentImpactedArea.company.name};return n.currentImpactedArea.region&&(t.regionName=n.currentImpactedArea.region.name),n.currentImpactedArea.siteGroup&&(t.siteGroupName=n.currentImpactedArea.siteGroup.name),o.getListOfSitesByName(t,e).then(function(e){return n.state.sitesLoading=!1,{list:e.objects,exceedsChunkSize:e.exceedsChunkSize}})},n.loadOrganizationsByName=function(e){var t={companyName:n.currentImpactedArea.company.name};return o.getListOfOrganizationsByName(t,e).then(function(e){return n.state.organizationsLoading=!1,{list:e.objects,exceedsChunkSize:e.exceedsChunkSize}})},n.loadDepartmentsByName=function(e){var t={companyName:n.currentImpactedArea.company.name,organizationName:n.currentImpactedArea.organization.name};return o.getListOfDepartmentsByName(t,e).then(function(e){return n.state.departmentsLoading=!1,{list:e.objects,exceedsChunkSize:e.exceedsChunkSize}})},n.addImpactedArea=function(){var a={company:{name:n.currentImpactedArea.company.name}};n.currentImpactedArea.site&&(a.site=a.site||{},a.site.name=n.currentImpactedArea.site.name),n.currentImpactedArea.region&&(a.site=a.site||{},a.site.region=n.currentImpactedArea.region.name),n.currentImpactedArea.siteGroup&&(a.site=a.site||{},a.site.siteGroup=n.currentImpactedArea.siteGroup.name),n.currentImpactedArea.organization&&(a.organization=n.currentImpactedArea.organization.name),n.currentImpactedArea.department&&(a.department=n.currentImpactedArea.department.name),0===_.filter(n.impactedAreas,a).length?(n.impactedAreas=n.impactedAreas||[],n.impactedAreas.push(a),n.addedImpactedAreas.push(a)):e.error({text:t("i18n")("create.change.wizard.basicDetails.impactedAreas.duplicateError"),clear:!1}),n.currentImpactedArea={company:n.customer.company}},n.formatImpactedArea=function(e){var t=_.filter([e.company.name,e.site?e.site.region:null,e.site?e.site.siteGroup:null,e.site?e.site.name:null,e.organization,e.department],function(e){return e}).join(" > ");return t},n.removeImpactedArea=function(e){n.impactedAreas=n.impactedAreas||[];var t=n.impactedAreas[e];n.impactedAreas.splice(e,1),_.includes(n.addedImpactedAreas,t)?_.remove(n.addedImpactedAreas,t):n.removedImpactedAreas.push(t)},n.$on(r.DISCARD_CHANGES,function(){n.data.value=_.cloneDeep(p),n.impactedAreas=n.data.value.impactedAreas=n.data.value.impactedAreas||[],n.addedImpactedAreas=n.data.value.addedImpactedAreas=n.data.value.addedImpactedAreas||[],n.removedImpactedAreas=n.data.value.removedImpactedAreas=n.data.value.removedImpactedAreas||[]}),n.$on(r.AFTER_SAVED_CHANGES,d),n.$on(r.TOGGLE_EDIT_MODE,u)}]}}])}(),function(){angular.module("customWidgetsModule").directive("locationCustomField",["events",function(e){return{restrict:"E",replace:!0,templateUrl:"views/custom-widgets/location-field.html",scope:{data:"=",context:"=",isEditable:"="},link:function(t){t.$watch("data.value",function(){t.init();var a={region:"siteRegion",site:"siteName",siteGroup:"siteGroup"};t.$emit(e.WIDGET_VALUE_CHANGE,{fieldName:t.data.name,memberName:a[t.data.value.fieldChanged]})},!0)},controller:["$scope",function(e){e.siteOptions={company:{visible:!1,attribute:"companyName"},region:{attribute:"region",specificFieldNotRequired:!0},siteGroup:{attribute:"siteGroup",specificFieldNotRequired:!0},site:{attribute:"name",specificFieldRequired:!0}},e.getDisplayValue=function(e){var t=[];return _.forOwn(e.value,function(e,a){e&&"siteId"!==a&&"companyName"!==a&&"fieldChanged"!==a&&t.push(e)}),t.join(" > ")},e.init=function(){e.data.value.companyName||(e.data.value.companyName=e.context.company&&e.context.company.name?e.context.company.name:""),e.changeLocation=e.getDisplayValue(e.data),e.context.location={id:e.data.value.siteId,name:e.data.value.name,region:e.data.value.region,siteGroup:e.data.value.siteGroup}},e.init()}]}}])}(),function(){angular.module("customWidgetsModule").directive("organizationField",["customFieldLinkFunction","events","searchModel","objectValueMapperService","$timeout",function(e,t,a,n,i){return{restrict:"E",replace:!0,scope:{data:"=",isEditable:"="},templateUrl:"views/custom-widgets/organization-field.html",link:function(o){e(o);var r=o.data.members.length?o.data.members[0].name:null;angular.isDefined(o.data.value)&&(o.data.ootbValue=o.data.value[r]),o.getList=function(e){var t,r=n.getValueByFieldName("customer")||{};if(t=_.isEmpty(r)?n.getValueByFieldName("company"):r.company.name)return o.dataLoading=!0,a.getOrganizationsByTextAndCompany(e,t).then(function(e){o.isTooltipOpenOrg=o.exceedsChunkSizeOrg=e.exceedsChunkSize,i(function(){o.isTooltipOpenOrg=!1},1e4);var t=[];return e.items.length&&_.forEach(e.items,function(e){t.push(e.name)}),t})["finally"](function(){o.dataLoading=!1})},o.onInputFocusBlur=function(){o.isTooltipOpenOrg=!1},o.$watch("data.setValueFlag",function(e){e&&"#$#"!==e&&(o.data.ootbValue=e,o.onFieldValueChange(),o.data.setValueFlag="#$#")}),o.onFieldValueChange=function(){var e=n.getFieldByName(o.data.name);e.value[r]=o.data.ootbValue,o.$emit(t.WIDGET_VALUE_CHANGE,{fieldName:o.data.name,memberName:o.data.name})},o.clearValue=function(){o.data.ootbValue="",o.onFieldValueChange()},o.$on(t.DISCARD_CHANGES,function(){o.data.ootbValue=o.data.value[r];var e=n.getFieldByName(o.data.name);e.value[r]=o.data.ootbValue})}}}])}(),function(){angular.module("customWidgetsModule").directive("personLocationMap",["customFieldLinkFunction","googleMapService",function(e,t){return{restrict:"E",replace:!0,scope:{data:"="},templateUrl:"views/custom-widgets/person-location-map.html",link:function(a){e(a),a.googleMapAvailable=t.isAvailable,a.$watch("data.setValueFlag",function(e){"#$#"!==e&&e&&(a.data.setValueFlag="#$#")})}}}])}(),function(){angular.module("customWidgetsModule").directive("personName",["customFieldLinkFunction","createTicketModel","events","objectValueMapperService","permissionModel","roles","$modal","$rootScope","systemAlertService","i18nService","$timeout","ticketModel","configurationModel",function(e,t,a,n,i,o,r,s,l,c,d,u,p){"ngInject";return{restrict:"E",replace:!0,require:"?ngModel",scope:{data:"=",context:"=",isEditable:"=",isNew:"="},templateUrl:"views/custom-widgets/person-name.html",controller:["$scope",function(e){e.options={typeaheadFocusFirst:!0},i.hasRole(o.ITSM_PEOPLE_USER_ROLE)&&(e.options.typeaheadFocusFirst=!1)}],link:function(m){function f(e){var t=m.data.value;if(e.isEmptyResult){T||(T=s.$new(),T.isContactCreateAction=E);var a=r.open({templateUrl:"views/person/create-person.html",controller:"createPersonController",windowClass:"modal_full-content",backdrop:!1,keyboard:!1,scope:T});a.result.then(function(e){_.isEmpty(e)||g(e)})}else g(t)}function g(e){m.data.value=e,m.data.previousValue=C.pop(),C.push(m.data.value),m.$emit(a.WIDGET_VALUE_CHANGE,{fieldName:m.data.name,memberName:v}),"customer"===m.data.name?m.data.value.company&&m.data.value.company.name&&(m.context.selectedCompany=m.data.value.company.name,"workorder"!==m.context.type&&h(),n.setValueByFieldName("company",m.data.value.company.name),m.$emit(a.FIELD_VALUE_CHANGE,{name:"company"}),m.$emit(a.FIELD_VALUE_CHANGE,{name:"customerCompany"}),n.getFieldByName("locationCompany")||(m.context.locationCompany={name:m.context.selectedCompany})):"requestedFor"===m.data.name&&(m.data.value.company&&m.data.value.company.name&&(m.context.company=_.cloneDeep(m.data.value.company)),"change"==m.context.type&&s.$broadcast(a.RELOAD_RISK_QUESTION))}function h(){m.customerCompany!==m.context.selectedCompany&&(m.customerCompany=m.context.selectedCompany,u.getIncidentRules(m.customerCompany).then(function(e){m.context.serviceCIRequired="true"==e.serviceCIRequired,m.context.CIRequiredOnResolved="true"==e.CIRequiredOnResolved,m.context.applyCognitiveForSupportGroup=e.applyCognitiveForSupportGroup,m.$emit(a.COMPANY_VALUE_CHANGED)}))}function y(){m.$emit(a.WIDGET_VALUE_CHANGE,{fieldName:m.data.name,action:"cancel"})}e(m),m.showMailstopOnPersoncard=p.showMailstopOnPersoncard,m.showPhoneNumOnPersonCard=p.showPhoneNumOnPersonCard,m.state={dataLoading:!1};var E="contact"===m.data.name;m.data.value&&!m.data.value.fullName&&m.data.value.firstName&&(m.data.value.fullName=m.data.value.firstName+" "+m.data.value.lastName);var v=[];m.data.members&&_.forEach(m.data.members,function(e){v.push(e.name)});var T,S=_.cloneDeep(m.data.value),C=[m.data.value];m.customerCompany="",m.validate=function(){"object"!=typeof m.data.value&&(m.data.value="")},m.update=function(e){return"requestedFor"===m.data.name?l.modal({title:c.getLocalizedString("create.change.setRequestedForLocation.title"),text:c.getLocalizedString("create.change.setRequestedForLocation.text"),buttons:[{text:c.getLocalizedString("common.button.yes"),data:!0},{text:c.getLocalizedString("common.button.no"),data:!1}]}).result.then(function(t){t&&f(e)}):void f(e)},m.$on(a.AFTER_SAVED_CHANGES,function(){S=_.cloneDeep(m.data.value)}),m.$on(a.DISCARD_CHANGES,function(){m.data.value=_.cloneDeep(S)}),m.clear=function(){m.data.value="","customer"===m.data.name&&(m.context.selectedCompany&&(m.context.selectedCompany=""),n.setValueByFieldName("company",""),m.$emit(a.FIELD_VALUE_CHANGE,{name:"company"}),n.setValueByFieldName("customerCompany",""),m.$emit(a.FIELD_VALUE_CHANGE,{name:"customerCompany"}),n.setByProperty(m.context.type+"Template","isReadOnly",!0)),m.data.previousValue=C.pop(),C.push(m.data.value),m.$emit(a.WIDGET_VALUE_CHANGE,{fieldName:m.data.name,memberName:v})},m.getListPersonsByCompany=function(e){m.state.dataLoading=!0;var a=null;return"contact"!==m.data.name&&(a=m.data.value&&m.data.value.company?m.data.value.company.name:"",a||(a=n.getValueByFieldName("company")||n.getValueByFieldName("customerCompany"))),t.getPersonsByCompany(e,a).then(function(e){var t=e.items;return m.exceedsChunkSizePerson=e.exceedsChunkSize,m.isTooltipOpenPerson=!0,d(function(){m.isTooltipOpenPerson=!1},1e4),i.hasRole(o.ITSM_PEOPLE_USER_ROLE)&&e.items.unshift({isEmptyResult:!0,isCreateContactAction:E}),t})["finally"](function(){m.state.dataLoading=!1})},m.onInputFocusBlur=function(){m.isTooltipOpenPerson=!1},m.onValueChange=function(){m.data.value.firstName&&m.data.value.lastName&&(m.data.value.fullName=m.data.value.firstName+" "+m.data.value.lastName),m.$emit(a.WIDGET_VALUE_CHANGE,{fieldName:m.data.name,memberName:v})},m.$watch("data.setValueFlag",function(e){"#$#"!==e&&e&&(!e.id&&e.loginId&&(e.id=e.loginId),m.data.value=e,m.onValueChange(),m.data.setValueFlag="#$#")}),m.$on(a.DISCARD_CHANGES,y),m.$on("$destroy",function(){T&&!T.$$destroyed&&T.$destroy()})}}}]).directive("setView",function(){return{require:"ngModel",scope:{setView:"@"},link:function(e,t,a,n){n.$formatters.push(function(e){return e&&e.fullName?e.fullName:e&&e.firstName&&e.lastName?e.firstName+" "+e.lastName:""}),e.onValueChange=function(t){e.data.value.firstName&&e.data.value.lastName&&(e.data.value.fullName=e.data.value.firstName+" "+e.data.value.lastName),e.$emit(t.WIDGET_VALUE_CHANGE,{fieldName:e.data.name})},e.$watch("data.setValueFlag",function(t){"#$#"!==t&&t&&(!t.id&&t.loginId&&(t.id=t.loginId),e.data.value=t,e.onValueChange(),e.data.setValueFlag="#$#")})}}})}(),function(){angular.module("customWidgetsModule").directive("personSite",["customFieldLinkFunction","createTicketModel","searchModel","events",function(e,t,a,n){return{restrict:"E",replace:!0,scope:{data:"=",isEditable:"="},templateUrl:"views/custom-widgets/person-site.html",link:function(a){function i(){a.selections.regions=null,a.state.regionsLoading=!0;var e={companyName:a.company.name};t.getList(EntityVO.TYPE_REGION,e).then(function(e){a.state.regionsLoading=!1,a.selections.regions=e.objects,a.state.tooManyRegions=e.exceedsChunkSize})}function o(){a.selections.siteGroups=null,a.state.siteGroupsLoading=!0;var e={companyName:a.company.name};a.selected.region&&(e.regionName=a.selected.region.name),t.getList(EntityVO.TYPE_SITE_GROUP,e).then(function(e){a.state.siteGroupsLoading=!1,a.selections.siteGroups=e.objects,a.state.tooManySiteGroups=e.exceedsChunkSize})}function r(){a.selections.sites=null,a.state.sitesLoading=!0;var e={companyName:a.company.name};a.selected.region&&(e.regionName=a.selected.region.name),a.selected.siteGroup&&(e.siteGroupName=a.selected.siteGroup.name),t.getList(EntityVO.TYPE_SITE,e).then(function(e){a.state.sitesLoading=!1,a.selections.sites=e.objects,a.state.tooManySites=e.exceedsChunkSize})}e(a),a.state={},a.selections={},a.company=a.data.value.company,a.selected=a.data.value,i(),a.$watch("selected.region",function(e,t){var i=a.selected.siteGroup;e?(a.selected.siteGroup&&a.selected.siteGroup.attributeMap.regionName!==e.name&&(a.selected.siteGroup=null),a.selected.site&&a.selected.site.attributeMap.regionName!==e.name&&(a.selected.site=null)):(a.selected.siteGroup=null,a.selected.site=null),o(),i||r(),_.isEqual(e,t)||a.$emit(n.WIDGET_VALUE_CHANGE,{fieldName:a.data.name,memberName:"region"})}),a.$watch("selected.siteGroup",function(e,t){e?(a.selected.region={name:e.attributeMap.regionName},a.selected.site&&a.selected.site.attributeMap.siteGroupName!==e.name&&(a.selected.site=null)):a.selected.site=null,r(),_.isEqual(e,t)||a.$emit(n.WIDGET_VALUE_CHANGE,{fieldName:a.data.name,memberName:"siteGroup"})}),a.$watch("selected.site",function(e,t){e&&(a.selected.siteGroup={name:e.attributeMap.siteGroupName,attributeMap:{regionName:e.attributeMap.regionName}}),_.isEqual(e,t)||a.$emit(n.WIDGET_VALUE_CHANGE,{fieldName:a.data.name,memberName:"site"})}),a.$watch("data.value",function(e,t){e!=t&&(a.selected=e)}),a.onValueChange=function(){a.$emit(n.WIDGET_VALUE_CHANGE,{fieldName:a.data.name})},a.$watch("data.setValueFlag",function(e){"#$#"!==e&&e&&(a.data.value=e,a.onValueChange(),a.data.setValueFlag="#$#")}),a.loadRegionsByName=function(e){var n={companyName:a.company.name};return t.getListOfRegionsByName(n,e).then(function(e){return a.state.regionsLoading=!1,{list:e.objects,exceedsChunkSize:e.exceedsChunkSize}})},a.loadSiteGroupsByName=function(e){var n={companyName:a.company.name};return a.selected&&a.selected.region&&(n.regionName=a.selected.region.name),
t.getListOfSiteGroupsByName(n,e).then(function(e){return a.state.siteGroupsLoading=!1,{list:e.objects,exceedsChunkSize:e.exceedsChunkSize}})},a.loadSitesByName=function(e){var n={companyName:a.company.name};return a.selected&&a.selected.region&&(n.regionName=a.selected.region.name),a.selected&&a.selected.siteGroup&&(n.siteGroupName=a.selected.siteGroup.name),t.getListOfSitesByName(n,e).then(function(e){return a.state.sitesLoading=!1,{list:e.objects,exceedsChunkSize:e.exceedsChunkSize}})}}}}])}(),function(){angular.module("customWidgetsModule").directive("phoneField",["customFieldLinkFunction","objectValueMapperService","events",function(e,t,a){return{restrict:"E",replace:!0,scope:{data:"=",isEditable:"="},templateUrl:"views/custom-widgets/phone-field.html",link:function(n){function i(){if("contactPhone"===n.data.name){var e=t.getValueByFieldName("contact");n.data.isReadOnly=!!_.isEmpty(e.company)||!!n.data.isReadOnly}}e(n);var o=n.data.members.length?n.data.members[0].name:null;angular.isDefined(n.data.value)&&(n.data.ootbValue=n.data.value[o]),i(),n.$watch("data.setValueFlag",function(e){e&&"#$#"!==e&&(_.isObject(e)&&e.hasOwnProperty(o)?n.data.ootbValue=e[o]:n.data.ootbValue=e,n.onFieldValueChange(),n.data.setValueFlag="#$#")}),n.onFieldValueChange=function(){var e=t.getFieldByName(n.data.name);e.value[o]=n.data.ootbValue;var i=[];n.data.members&&_.forEach(n.data.members,function(e){i.push(e.name)}),n.$emit(a.WIDGET_VALUE_CHANGE,{fieldName:n.data.name,memberName:i})},n.$on(a.DISCARD_CHANGES,function(){n.data.ootbValue=n.data.value[o];var e=t.getFieldByName(n.data.name);e.value[o]=n.data.ootbValue,i()})}}}])}(),function(){angular.module("customWidgetsModule").directive("poiLocation",["customFieldLinkFunction","ticketModel","locationModel","googleMapService","$state","$timeout","events",function(e,t,a,n,i,o,r){return{restrict:"E",replace:!0,scope:{data:"=",isEditable:"="},templateUrl:"views/custom-widgets/poi-location.html",link:function(t){function s(){t.initialData=_.cloneDeep(t.data.value),t.state={dataIsLoading:!0,loadingLocations:!1,loadingPOI:!1},t.viewData={location:null,poi:t.initialData?t.initialData.poiName:null},t.initialData&&t.initialData.poiId?a.getLocationByPoiId(t.initialData.poiId).then(function(e){if(t.state.dataIsLoading=!1,t.viewData.location=e,!t.viewData.poi){var n=a.poiByLocationCache[e.id]||[],i=_.find(n,{id:t.initialData.poiId});i&&o(function(){t.viewData.poi={name:i.name,id:i.id,floormap:{id:i.floorMapId}}})}a.getLocationsList()}):t.state.dataIsLoading=!1}function l(){t.data.value=_.cloneDeep(t.initialData)}e(t),t.$watch("data.setValueFlag",function(e){"#$#"!==e&&e&&(t.data.setValueFlag="#$#")}),t.clearField=function(e){e?(t.viewData.location=null,t.viewData.poi=null):t.viewData.poi=null,t.data.value=null},t.filterLocationsByCriteria=function(e){return a.filterLocations(e).then(function(e){return e})},t.filterPOIbyCriteria=function(e){if(t.viewData.location&&t.viewData.location.id)return t.state.loadingPOI=!0,a.filterLocationPOI(t.viewData.location.id,e).then(function(e){return e})["finally"](function(){t.state.loadingPOI=!1})},t.handleLocationChange=function(){t.viewData.poi=null,t.data.value=null},t.handlePOIChange=function(){t.viewData.poi&&t.viewData.poi.id&&(t.data.value={poiId:t.viewData.poi.id,poiName:t.viewData.poi.name,flooMapId:t.viewData.poi.floormap?t.viewData.poi.floormap.id:""})},t.showPOIMap=function(e){e&&e.poiId&&n.isAvailable&&i.go("location",{mapId:e.floorMapId,id:e.poiId})},s(),t.$on(r.DISCARD_CHANGES,l),t.$on(r.TOGGLE_EDIT_MODE,s)}}}])}(),function(){angular.module("myitsmApp").directive("priority",["metadataModel","ticketModel","events","systemAlertService","$filter","objectValueMapperService",function(e,t,a,n,i,o){return{restrict:"E",replace:!0,templateUrl:"views/custom-widgets/priority.html",scope:{ticket:"=",data:"=",updateIsHandledByParent:"@",isEditable:"="},link:function(r,s){function l(e){r.ticket.type===EntityVO.TYPE_CHANGE?t.getChangePriority(r.ticket.company.name,r.data.value.impact.name,r.data.value.urgency.name).then(function(t){_.isEmpty(t)?(r.state.isCalculating=!1,r.data.value.priority=null,d(!1)):(r.data.value.priority=_.find(r.metadata.priorities,{name:t}),r.state.isCalculating=!1,r.$emit(a.WIDGET_VALUE_CHANGE,{fieldName:r.data.name,memberName:[e,r.data.name]}),d(r.data.value.priority))}):r.ticket.type===EntityVO.TYPE_INCIDENT?t.getPriority(r.ticket.company.name,r.data.value.impact.name,r.data.value.urgency.name,r.ticket.type).then(function(t){_.isEmpty(t)||(r.data.value.priority=_.find(r.metadata.priorities,{name:t}),r.state.isCalculating=!1,r.$emit(a.WIDGET_VALUE_CHANGE,{fieldName:r.data.name,memberName:[e,r.data.name]}),d(r.data.value.priority))}):r.$emit(a.WIDGET_VALUE_CHANGE,{fieldName:r.data.name,memberName:[e,r.data.name]})}function c(e,t,a){var n=e||r.setValuePriority,i=t||_.get(r.ticket,"urgency.name",r.ticket.urgency),o=a||_.get(r.ticket,"impact.name",r.ticket.impact);if(n){var s=isNaN(n)?{name:n}:{index:n};r.data.value.priority=_.find(r.metadata.priorities,s)}else r.data.value.priority=_.find(r.metadata.priorities,function(e){return r.ticket.priority&&(e.name===r.ticket.priority||e.name===r.ticket.priority.name)})||{name:r.ticket.priority};r.data.value.impact=_.find(r.metadata.impacts,function(e){return e.name===o})||{name:o},r.data.value.urgency=_.find(r.metadata.urgencies,function(e){return e.name===i})||{name:i},r.data.members&&_.forEach(r.data.members,function(e){e.value={name:r.ticket[e.name],label:r.ticket[e.name]}}),!r.data.value.priority.name&&r.ticket.impact.name&&r.ticket.urgency.name&&l()}function d(e){e||n.error({text:i("i18n")("ticket.priority.warning"),hide:1e4})}function u(){if(!o.getValueByFieldName("customer")&&!o.getValueByFieldName("requestedFor")){var e=o.getFieldsByType("priority");e&&e[0]&&e[0].members&&(e[0].isReadOnly=!0,_.forEach(e[0].members,function(e){e.isReadOnly=!0}))}}function p(){r.editMode=!0,c(),r.ticket.type!==EntityVO.TYPE_TASK&&u()}function m(){r.data.value.priority=_.find(r.metadata.priorities,{name:r.oldPriority}),c(r.data.value.priority.name),r.state.isCalculating=!1,r.editMode=!1}if(r.setValuePriority="",r.oldPriority=angular.copy(r.data.value.priority),r.state={isCalculating:!1},r.ticket.accessMappings&&r.ticket.accessMappings.fieldMappings&&r.ticket.accessMappings.fieldMappings.hasOwnProperty("priority")?r.isPriorityEditable="write"===r.ticket.accessMappings.fieldMappings.priority:r.ticket.accessMappings&&r.ticket.accessMappings.hasOwnProperty("priorityEditAllowed")?r.isPriorityEditable=r.ticket.accessMappings.priorityEditAllowed:r.ticket.accessMappings&&r.ticket.accessMappings.hasOwnProperty("allEditAllowed")?r.isPriorityEditable=r.ticket.accessMappings.allEditAllowed:r.isPriorityEditable=!0,r.$parent.isNew)r.fieldLengthForSm6=!0,r.isNew=!0;else{var f=s.closest(".layout-renderer__child-column")[0]||s.closest(".layout-renderer__column")[0];f&&(r.fieldLengthForSm6=_.includes(f.className,"col-sm-6"),r.fieldLengthForSm4=_.includes(f.className,"col-sm-4"))}e.getMetadataByType(r.ticket.type).then(function(e){r.metadata=e,c(),r.$emit(a.WIDGET_VALUE_CHANGE,{fieldName:r.data.name,source:"fromTicketLoad"})}),r.$watch("ticket.priority",function(e){(r.ticket.isDraft||r.ticket.isRelatedCR)&&r.metadata&&(r.data.value.priority=_.find(r.metadata.priorities,{name:e&&e.name?e.name:e})),r.oldPriority=e}),r.$watch("data.setValueFlag",function(t){if("#$#"!==t&&void 0!==t&&null!==t){var a=_.has(t,"urgency"),n=_.has(t,"impact");if(a||n)c(r.data.value.priority.name,_.get(t,"urgency.name",r.data.value.urgency.name),_.get(t,"impact.name",r.data.value.impact.name)),r.updatePriority();else{if(r.metadata){var i=isNaN(t)?{name:t}:{index:t};r.data.value.priority=_.find(r.metadata.priorities,i)}else e.getMetadataByType(r.ticket.type).then(function(e){r.metadata=e,r.data.value.priority=_.find(r.metadata.priorities,{name:t})});r.setValuePriority=t,r.oldPriority!==t&&r.data&&!r.data.isFromTicketLoad&&r.changePriority(),r.oldPriority=t}r.data.setValueFlag="#$#"}r.data.isFromTicketLoad=!1}),r.changePriority=function(){r.$emit(a.WIDGET_VALUE_CHANGE,{fieldName:r.data.name,memberName:r.data.name})},r.updatePriority=function(e){if(r.state.isCalculating=!0,!r.ticket.company){var t=o.getValueByFieldName("company");r.ticket.company={},r.ticket.company.name=t}l(e)},r.$on(a.TOGGLE_EDIT_MODE,p),r.$on(a.DISCARD_CHANGES,m),r.$on(a.AFTER_SAVED_CHANGES,function(){var e=_.get(r.data.value.priority,"name")||r.data.value.priority;r.oldPriority=e})}}}])}(),function(){angular.module("customWidgetsModule").directive("supportGroupField",["customFieldLinkFunction","events","searchModel","objectValueMapperService","$filter",function(e,t,a,n,i){return{restrict:"E",replace:!0,scope:{data:"=",isEditable:"=",context:"=",isNew:"=?",editMode:"=?"},templateUrl:"views/custom-widgets/support-group-field.html",link:function(o){function r(e){!e||e!==EntityVO.COGNITIVE_SG_APPLY_AUTO&&e!==EntityVO.COGNITIVE_SG_SHOW_RECOMMENDATION||(o.state.showRecommendationLink=!0)}function s(e){e===d?o.state.messageToDisplay=i("i18n")("field.widget.supportgroup.noRecommendationFound"):e===u&&(o.state.messageToDisplay=i("i18n")("field.widget.supportgroup.noCompanySelected")),o.state.displayMessage=!0,setTimeout(function(){o.state.displayMessage=!1,o.$apply()},1e4)}e(o),o.state={displayMessage:!1,messageToDisplay:"",showRecommendationLink:!1,loadingRecommendation:!1},o.closeTooltip=function(){o.state.displayMessage=!1},o.onFieldValueChange=function(){o.$emit(t.WIDGET_VALUE_CHANGE,{fieldName:o.data.name})};var l="assignee",c=new RegExp("manager","ig");c.test(o.data.primaryKey)&&(l="manager");var d="noRecommendation",u="noCompany",p=_.cloneDeep(o.data.value);r(o.context.applyCognitiveForSupportGroup),o.$on(t.APPLY_COGNITIVE_SG,function(e,t){r(t.applyCognitive)}),o.fetchRecommendations=function(){o.state.loadingRecommendation=!0;var e=n.getValueByFieldName("summary"),i=n.getValueByFieldName("customer");if(!i||!i.company)return s(u),void(o.state.loadingRecommendation=!1);var r={name:i.company.name,site:i.site};delete r.site.address;var l=n.getValueByFieldName("locationCompany");l={name:l},a.getRecommendedSupportGroups(EntityVO.TYPE_INCIDENT,e,r,l).then(function(e){if(e.supportGroups&&e.supportGroups.length){var a=o.context.isDraft?o.context:_.cloneDeep(o.context);a.assignee={},a.supportGroup=e.supportGroups[0];var n="ticketassignee",i=!1;o.$emit(t.TICKET_ASSIGNEES_UPDATED,a,!1,n,i)}else s(d)})["finally"](function(){o.state.loadingRecommendation=!1})},o.$on(t.AFTER_SAVED_CHANGES,function(){p=_.cloneDeep(o.data.value)}),o.$on(t.DISCARD_CHANGES,function(){o.data.value=_.cloneDeep(p)}),o.openAssignBlade=function(e){var a=o.$parent.editMode,n={originalEvent:e,saveSelection:!a,role:l};o.$emit(t.SHOW_ASSIGN_TICKET_BLADE,n)},o.onValueChange=function(){o.$emit(t.WIDGET_VALUE_CHANGE,{fieldName:o.data.name})},o.$watch("data.setValueFlag",function(e){"#$#"!==e&&e&&(!e.name&&e.supportGroups&&(e.name=e.supportGroups),o.data.value=e,o.onValueChange(),o.data.setValueFlag="#$#")})}}}])}(),function(){angular.module("myitsmApp").directive("taskPhase",["fieldValidationModel","events",function(e,t){return{restrict:"E",replace:!0,templateUrl:"views/custom-widgets/task-phase-directive.html",scope:{data:"=",metadata:"=",isEditable:"=",isNew:"=?",ticket:"="},link:function(e,a){e.$parent.isNew?e.fieldLengthForSm6=!0:a.closest(".layout-renderer__child-column")[0]&&(e.fieldLengthForSm6=_.includes(a.closest(".layout-renderer__child-column")[0].className,"col-sm-6"),e.fieldLengthForSm4=_.includes(a.closest(".layout-renderer__child-column")[0].className,"col-sm-4")),e.$watch("data.setValueFlag",function(t){if(t&&"#$#"!==t){var a=_.get(t,"phaseName");a&&(e.ticket.selectedPhase=_.find(_.filter(e.ticket.taskPhases,{name:a}))),e.updatePhase(),e.data.setValueFlag="#$#"}}),e.updatePhase=function(){e.data.value.phaseGuid=e.ticket.selectedPhase.guid,e.data.value.phaseName=e.ticket.selectedPhase.name,e.$emit(t.WIDGET_VALUE_CHANGE,{fieldName:e.data.name})}}}}])}(),function(){angular.module("customWidgetsModule").directive("ticketRisk",["customFieldLinkFunction","events","createTicketModel","tabIds","objectValueMapperService",function(e,t,a,n,i){return{restrict:"E",replace:!0,scope:{data:"=",context:"=",metadata:"=",isEditable:"=",isNew:"="},templateUrl:"views/custom-widgets/ticket-risk.html",link:function(o){function r(){o.data.value.mode="manual",o.state.pendingRiskLevelChange=!1}function s(){var e=i.getFieldsByType("category"),t=[];_.forEach(e,function(e){var a={name:e.name,tiers:{}};_.each(e.value.listOfTiers,function(e){e.selectedValue&&(a.tiers[e.name]=e.selectedValue)}),t.push(a)});var a=_.filter(i.getFieldList(),function(e){return e.name.indexOf("operationCategory")!==-1});if(a.length>0){var n={name:"operational",tiers:{}};_.forEach(a,function(e){e.value&&(n.tiers[e.name]=e.value)}),t.push(n)}return t}function l(){o.$emit(t.RISK_MODE_AUTO,{fieldName:o.data.name,fieldValue:o.data.value.riskLevel}),o.data.value.questionResponses&&(o.responsesCopy=o.data.value.questionResponses),o.questionResponsesCopy=null,angular.forEach(o.responsesCopy,function(e){var t=_.head(_.filter(o.data.value.questionDefinitions,{id:e.questionId}));if(t){var a=_.head(_.filter(t.options,{id:e.optionId}));t.responseId=e.id,a&&o.selectQuestionOption(t,a)}})}function c(e,t){o.data.value.riskLevel=t.riskLevel,m=_.cloneDeep(o.data.value.riskLevel),o.showRiskQuestions=!1,o.data.value.questionResponses=_.cloneDeep(o.context.questionResponses)}function d(){o.context.riskIsUserSpecified=!1}function u(){o.data.value.questionResponses=o.responsesCopy,m&&(o.data.value.riskLevel=_.cloneDeep(m)),o.context.riskIsUserSpecified?r():(o.data.value.mode="auto",o.reloadCheck())}function p(e){"auto"===o.data.value.mode?(o.data.modeCheck=!0,o.loadRiskQuestions()):(e&&o.loadRiskQuestions(),o.data.riskIsUserSpecified=!0,o.$emit(t.RISK_MODE_MANUAL))}if(e(o),o.tabIds=n,o.data.modeCheck=!1,o.showRiskQuestions=!1,_.isEmpty(o.context.questionResponses)&&(o.context.riskIsUserSpecified=!0),o.data.value?o.isNew||o.context.fromCopyChange?o.data.value.mode=o.context.riskLevel?"manual":"auto":o.context.riskIsUserSpecified?o.data.value.mode="manual":o.data.value.mode="auto":o.data.value={mode:"auto"},o.data.value.riskLevel)var m=_.cloneDeep(o.data.value.riskLevel);else o.data.value.riskLevel=_.head(o.metadata.riskLevels).name,m=_.cloneDeep(o.data.value.riskLevel);o.data.value.riskLevelLabel=_.find(o.metadata.riskLevels,{name:o.data.value.riskLevel}).label,o.context.questionResponses&&(o.data.value.questionResponses=_.cloneDeep(o.context.questionResponses)),o.state={pendingRiskLevelChange:!1},o.overrideRiskLevelEnabled=function(){return o.data.value.mode&&"manual"===o.data.value.mode},o.riskLevelCls=function(e,t){var a="";if(o.data.value.riskLevel===e||o.data.value.riskLevel===e.name){var n=o.metadata.riskLevels.length-t;o.data.titleRiskLevelCls="risk-level-"+n,o.data.backgroundRiskLevelCls="ticket__risk-level-"+n,a="active "+o.data.backgroundRiskLevelCls}return a},o.riskLevelChanged=function(e){return!!o.isEditable&&(o.data.value.riskLevel=e.name,o.data.value.riskLevelLabel=e.label,o.data.riskIsUserSpecified=!0,void o.$emit(t.WIDGET_VALUE_CHANGE,{fieldName:o.data.name,fieldValue:e.name,memberName:"riskLevel"}))},o.responsesCopy=o.data.value.questionResponses,o.state={},o.riskQuestionsEnabled=function(){return o.data.value.mode&&"auto"===o.data.value.mode&&o.isEditable},o.questionOptionSelected=function(e,t){return o.questionResponsesCopy&&o.questionResponsesCopy[e.id]&&o.questionResponsesCopy[e.id]===t},o.selectQuestionOption=function(e,t){var a=angular.copy(e);t.parentQuestion=a,o.questionResponsesCopy=o.questionResponsesCopy||{};var n=o.questionResponsesCopy[e.id]&&o.questionResponsesCopy[e.id]===t?null:t;o.questionResponsesCopy[e.id]=n,e.selectedOption=n,o.data.value.questionResponses=o.questionResponsesCopy},o.$watch("reloadIf",function(){o.reloadIf&&o.loadRiskQuestions()}),o.loadRiskQuestions=function(){o.context.company&&o.context.categorizations&&(o.data.value.questionDefinitions=null,o.data.value.questionResponses=null,o.state.questionsLoading=!0,a.getList(EntityVO.TYPE_RISKQUESTION,{companies:[o.context.company],categorizations:s()}).then(function(e){o.isNew&&o.$emit(t.RISK_QUESTION_LOADED),o.reloadIf=!1,o.state.questionsLoading=!1,o.data.value.questionDefinitions=e,"auto"===o.data.value.mode&&0===e.length&&(o.data.value.mode="manual"),l()}))},o.reloadCheck=function(){o.reloadIf=!0,o.data.modeCheck=!0,o.data.riskIsUserSpecified=!1},o.modeCheck=function(){o.data.modeCheck=!1,o.data.riskIsUserSpecified=!0,o.$emit(t.WIDGET_VALUE_CHANGE,{fieldName:o.data.name,fieldValue:o.data.value.riskLevel,memberName:"riskLevel"})},o.toggleRiskQuestions=function(){o.showRiskQuestions=!o.showRiskQuestions},o.$on(t.AFTER_SAVED_CHANGES,c),o.$on(t.AFTER_RISK_UPDATE,d),o.$on(t.DISCARD_CHANGES,u),o.onValueChange=function(){o.$emit(t.WIDGET_VALUE_CHANGE,{fieldName:o.data.name,fieldValue:o.data.value.riskLevel})},o.riskLevel=function(){return o.data.value.riskLevelLabel?o.data.value.riskLevelLabel:""},o.overrideRiskLevelTitleEnabled=function(){return"auto"!==o.data.value.mode||!o.data.value.riskLevel},o.$watch("data.setValueFlag",function(e){"#$#"!==e&&e&&(_.has(e,"riskLevel")?Object.assign(o.data.value,e):o.data.value=e,o.onValueChange(),o.data.setValueFlag="#$#")}),"changeRisk"===o.data.name&&(o.$on(t.RELOAD_RISK_QUESTION,function(){p(!0)}),p())}}}])}(),function(){angular.module("customWidgetsModule").directive("ticketTemplate",["customFieldLinkFunction","events","$modal","objectValueMapperService","systemAlertService","categoriesService","ticketModel","fieldValidationModel","createTicketModel","$filter","permissionModel","roles","$timeout","expressionEventManager",function(e,t,a,n,i,o,r,s,l,c,d,u,p,m){return{restrict:"E",replace:!0,scope:{data:"=",context:"=",metadata:"=",isEditable:"="},templateUrl:"views/custom-widgets/ticket-template.html",link:function(f){function g(e){var t={label:e,name:e},a=n.getFieldByName("priority");a.value.priority=t,a.members&&_.forEach(a.members,function(e){"priority"===e.name&&e.setValue(t)})}function h(){f.$emit(t.CLEAR_ALL_CATEGORIES,f.context.selectedServiceType&&f.context.selectedServiceType.name)}function y(){n.setValueByFieldName("summary",f.context.summary),n.setValueByFieldName("resolution",f.context.resolution);var e=f.context.selectedGroup?f.context.selectedGroup.name:f.context.selectedGroup;if(e?f.context.selectedGroup.supportGroups=e:f.context.selectedGroup={supportGroups:e},f.context.type===EntityVO.TYPE_WORKORDER){var a=f.context.selectedManagerGroup?f.context.selectedManagerGroup.name:f.context.selectedManagerGroup;a?f.context.selectedManagerGroup.supportGroups=a:f.context.selectedManagerGroup={supportGroups:a},n.setValueByFieldName("supportGroups",f.context.selectedGroup),n.setValueByFieldName("assignee",f.context.selectedAssignee),n.setValueByFieldName("requestManagerSupportGroups",f.context.selectedManagerGroup),n.setValueByFieldName("requestManager",f.context.selectedManager)}else n.setValueByFieldName("assigneeSupportGroups",f.context.selectedGroup),n.setValueByFieldName("assignee",f.context.selectedAssignee);if(f.context.type!==EntityVO.TYPE_TASK){var i=n.getFieldByName("impactedService");if("widget"===i.dataType)n.setValueByFieldName("impactedService",{ci:f.context.selectedService});else if(f.context.selectedService){var o=!i.valueField&&f.context.selectedService.reconciliationId?f.context.selectedService.reconciliationId:f.context.selectedService.name;i.setValue(o),i.setLinkedFieldValue(f.context.selectedService.reconciliationId)}else i.clearValue(),i.clearLinkedFieldValue();n.setValueByFieldName("causalCI",{ci:f.context.selectedAsset}),n.setValueByFieldName("locationCompany",f.context.locationCompany)}var r=n.getFieldsByType("category");_.forEach(r,function(e){var t="resolutionOperational"===e.name?"resolution":e.name,a=_.find(f.context.allCategories,{name:t});if(a){var i=n.getValueByFieldName(e.name);_.forEach(i.listOfTiers,function(e,t){e.selectedValue=a.listOfTiers&&a.listOfTiers[t]&&a.listOfTiers[t].selectedValue}),i.serializedValue=a.serializedValue}});var s=n.getFieldsByType("dynamicSelectionField");_.forEach(s,function(e){"company"!==e.name&&_.forEach(f.context.allCategories,function(t){var a=_.find(t.listOfTiers,{name:e.name});if(a)return void n.setValueByFieldName(e.name,a.selectedValue)})});for(var l in f.context.customFields){var c=n.getFieldByName(l),d=f.context.customFields[l];c&&(c.value=d,c.setValueFlag=d)}f.$emit(t.TICKET_TEMPLATE_UPDATED,f.context),m.handleTicketLoad()}var E;f.state={},f.templateType=f.context.type+"Template",e(f),f.$watch("context.customer",function(e){e&&_.isObject(e)?(f.context.selectedCompany=f.context.customer.company,f.context.type!==EntityVO.TYPE_TASK&&f.updatePriority()):f.context.selectedCompany=""}),f.$watch("context.selectedTemplate",function(e){if(e&&_.isObject(e)){var a=f.context.selectedTemplate.id;f.data.value.templateId=a,f.data.value.templateName=f.context.selectedTemplate.name,f.$emit(t.WIDGET_VALUE_CHANGE,{fieldName:f.data.name}),E=l.collectTicketChanges(),_.find(E.categorizations,{name:"operational"})||E.categorizations.push({name:"operational",tiers:{}}),_.find(E.categorizations,{name:"product"})||E.categorizations.push({name:"product",tiers:{}}),_.find(E.categorizations,{name:"resolution"})||E.categorizations.push({name:"resolution",tiers:{}}),_.find(E.categorizations,{name:"resolutionProduct"})||E.categorizations.push({name:"resolutionProduct",tiers:{}}),f.context.selectedCompany=e.company&&e.company.name?e.company.name:f.context.selectedCompany;var i=n.getFieldByName("customer")&&n.getFieldByName("customer").value,s=n.getFieldByName("contact")&&n.getFieldByName("contact").value;r.getDraft(f.context.type,a,null,null,null,i,s).then(function(e){var a=n.getFieldByName(f.templateType);if(a.value.templateId=e.templateId,null!==e.woAutomationStatus&&void 0!==e.woAutomationStatus&&""!==e.woAutomationStatus&&(a.value.woAutomationStatus=e.woAutomationStatus),null!==e.vendorTicketNumber&&""!==e.vendorTicketNumber&&(a.value.vendorTicketNumber=e.vendorTicketNumber),n.addFields([f.data]),e.templateId&&(f.context.templateId=e.templateId),e.customFields&&(_.each(Object.keys(e.customFields),function(t){n.setByProperty(t,"value",e.customFields[t],!1)}),f.context.customFields=e.customFields),e.id&&(f.context.id=e.id),e.displayId&&(f.context.displayId=e.displayId),e.summary&&(f.context.summary=e.summary),e.company&&!_.isEmpty(e.company.site)&&f.context.company&&f.context.company.site&&(f.context.company.site.region=e.company.site.region,f.context.company.site.siteGroup=e.company.site.siteGroup,f.context.company.site.name=e.company.site.name),e.desc.trim()){var i=e.desc?e.desc+" ":"";f.context.desc=E.desc?i?E.desc+"\n"+i:E.desc:i?i:"",f.context.desc.trim()}else E.desc&&(f.context.desc=E.desc.trim());if(f.context.selectedImpact=e.impact?_.find(f.metadata.impacts,{name:e.impact}):_.last(f.metadata.impacts),f.context.selectedUrgency=e.urgency?_.find(f.metadata.urgencies,{name:e.urgency}):_.last(f.metadata.urgencies),f.context.selectedPriority=e.priority?_.find(f.metadata.priorities,{name:e.priority}):_.last(f.metadata.priorities),e.status.value)if(f.context.selectedStatus=_.find(f.metadata.statuses,{name:e.status.value}),e.status.reason){f.context.selectedStatusReason=_.find(f.context.selectedStatus.statusReasons,{name:e.status.reason});var r=n.getFieldByName(FieldVO.prototype.STATUS_REASON);r.value=f.context.selectedStatusReason&&f.context.selectedStatusReason.name?f.context.selectedStatusReason.name:""}else f.updateStatusReason();else f.context.selectedStatus=_.find(f.metadata.statuses,{name:f.context.status.value});if(e.serviceType?angular.isObject(f.context.selectedServiceType)&&f.context.selectedServiceType.name===e.serviceType||(f.context.selectedServiceType=_.find(f.metadata.types,{name:e.serviceType}),h()):e.serviceType||f.context.type!==EntityVO.TYPE_INCIDENT||(f.context.selectedServiceType=null,h()),e.resolution&&(f.context.resolution=e.resolution),e.supportGroup.name?(f.context.selectedGroup=e.supportGroup,e.assignee.loginId&&(f.context.selectedAssignee=e.assignee)):f.context.selectedGroup="",f.context.type===EntityVO.TYPE_WORKORDER&&(e.managerGroup.name?(f.context.selectedManagerGroup=e.managerGroup,e.manager.loginId&&(f.context.selectedManager=e.manager)):f.context.selectedManagerGroup=""),e.impactedService&&e.impactedService.name&&e.impactedService.reconciliationId&&(f.context.selectedService=e.impactedService),e.causalCI&&e.causalCI.name&&e.causalCI.reconciliationId&&(f.context.selectedAsset=e.causalCI),e.categorizations&&_.forEach(e.categorizations,function(e){var t=_.find(f.context.allCategories,{name:e.name});if(t){for(var a=0;a<t.listOfTiers.length;a++){var n=t.listOfTiers[a];n.selectedValue=e.tiers[n.name],n.disabled=!1}t.serializedValue=o.getDisplayValues(t),t.dirty=!0}}),e.resCategorizations&&_.forEach(e.resCategorizations,function(e){var t,a=_.find(f.context.allCategories,{name:e.name});if(a){for(t=0;t<a.listOfTiers.length;t++){var n=a.listOfTiers[t];n.selectedValue=e.tiers[n.name],n.disabled=!1}a.serializedValue=o.getDisplayValues(a),a.dirty=!0}var i=_.find(f.context.resCategories,{name:e.name});if(i){for(var r=0;r<i.listOfTiers.length;r++){var s=i.listOfTiers[r];s.selectedValue=e.tiers[s.name],s.disabled=!1}i.serializedValue=o.getDisplayValues(i),i.dirty=!0}}),_.isEmpty(e.locationCompany)?n.getExactValueByFieldName("locationCompany")&&(f.context.locationCompany=n.getExactValueByFieldName("locationCompany")):f.context.locationCompany=e.locationCompany.name,f.context.type===EntityVO.TYPE_INCIDENT&&f.updatePriority(),f.context.type===EntityVO.TYPE_TASK&&g(e.priority),e.dynamicFields){var s=e.dynamicFields;f.$emit(t.SHOW_DYNAMIC_FIELDS_FROM_TEMPLATE,s)}y()})["finally"](function(){f.state.dataIsLoading=!1})}else e||(f.data.value.templateId="",f.data.value.templateName="",f.$emit(t.WIDGET_VALUE_CHANGE,{fieldName:f.data.name}))}),f.browseTemplate=function(){var e=a.open({templateUrl:f.context.type===EntityVO.TYPE_TASK?"views/template/browse-task-template-action-blade.html":"views/template/browse-ticket-template-action-blade.html",windowClass:"action-blade",controller:f.context.type===EntityVO.TYPE_TASK?"BrowseTaskTemplateController":"BrowseTicketTemplateController",resolve:f.context.type===EntityVO.TYPE_TASK?{isFromBrowseTemplate:function(){return!0}}:{ticketType:function(){return f.context.type},metadata:function(){return f.metadata},company:function(){return f.context.selectedCompany}}});e.result.then(function(e){f.context.selectedTemplate=e})},f.clearSelectedTemplate=function(){if(f.context.selectedTemplate="",E){if(f.context.id=E.id,f.context.summary=E.summary,f.context.desc=E.desc,f.context.resolution=E.resolution,f.context.selectedGroup=E.selectedGroup?E.selectedGroup.name:"",f.context.selectedAssignee=E.assignee,f.context.supportGroup=E.supportGroup,f.context.type===EntityVO.TYPE_WORKORDER&&(f.context.selectedManagerGroup=E.selectedManagerGroup?E.selectedManagerGroup.name:"",f.context.selectedManager=E.manager,f.context.managerGroup=E.managerGroup),f.context.selectedService=E.impactedService,f.context.selectedAsset=E.causalCI,E.impact&&(f.context.selectedImpact=_.find(f.metadata.impacts,{name:E.impact})),E.urgency&&(f.context.selectedUrgency=_.find(f.metadata.urgencies,{name:E.urgency})),E.priority&&(f.context.selectedPriority=_.find(f.metadata.priorities,{name:E.priority}),f.context.type===EntityVO.TYPE_TASK&&g(E.priority)),E.status.value&&(f.context.selectedStatus=_.find(f.metadata.statuses,{name:E.status.value}),E.status.reason?f.context.selectedStatusReason=_.find(f.context.selectedStatus.statusReasons,{name:E.status.reason}):f.updateStatusReason()),E.serviceType?angular.isObject(f.context.selectedServiceType)&&f.context.selectedServiceType.name===E.serviceType||(f.context.selectedServiceType=_.find(f.metadata.types,{name:E.serviceType})):f.context.type===EntityVO.TYPE_INCIDENT&&(f.context.selectedServiceType=null,h()),E.categorizations.length?_.forEach(E.categorizations,function(e){var t="resolutionOperational"===e.name?"resolution":e.name,a=_.find(f.context.allCategories,{name:t});if(a){for(var n=0;n<a.listOfTiers.length;n++){var i=a.listOfTiers[n];i.selectedValue=e.tiers[i.name],i.disabled=!1}a.serializedValue=o.getDisplayValues(a),a.dirty=!0}}):_.forEach(f.context.allCategories,function(e){for(var t=0;t<e.listOfTiers.length;t++){var a=e.listOfTiers[t];a.selectedValue="",a.disabled=!0}e.serializedValue="",e.dirty=!0}),f.context.locationCompany=E.locationCompany&&E.locationCompany.name,f.context.customFields=E.customFields,f.context.type===EntityVO.TYPE_INCIDENT&&f.updatePriority(),f.context.dynamicFields){var e=E.dynamicFields?E.dynamicFields:"";f.$emit(t.SHOW_DYNAMIC_FIELDS_FROM_TEMPLATE,e)}y()}},f.updatePriority=function(){r.getPriority(f.context.selectedCompany,f.context.selectedImpact.name,f.context.selectedUrgency.name,f.context.type).then(function(e){f.context.calculatedPriority=_.find(f.metadata.priorities,{name:e});var t=n.getFieldByName("priority");t.value.impact=f.context.selectedImpact,t.value.urgency=f.context.selectedUrgency,t.value.priority=f.context.calculatedPriority,t.members&&_.forEach(t.members,function(e){"impact"===e.name?e.setValue(f.context.selectedImpact):"urgency"===e.name?e.setValue(f.context.selectedUrgency):"priority"===e.name&&e.setValue(f.context.calculatedPriority)}),f.context.calculatedPriority||i.error({text:c("i18n")("ticket.calculationError.calculatedPriority"),clear:!1})})},f.updateStatusReason=function(){!_.isEmpty(f.context.selectedStatus.statusReasons)&&f.isFieldRequired("statusReason")?f.context.selectedStatusReason=_.head(f.context.selectedStatus.statusReasons):f.context.selectedStatusReason={};var e=n.getFieldByName(FieldVO.prototype.STATUS_REASON);e.value=f.context.selectedStatusReason.name?f.context.selectedStatusReason.name:""},f.isFieldRequired=function(e){return s.isFieldRequired(f.context.type,f.context.selectedStatus.name,"",e)},f.getList=function(e,t){return l.getList(e,t).then(function(t){return f.state.exceedsChunkSize=t.exceedsChunkSize,f.state.isTooltipOpen=t.exceedsChunkSize,p(function(){f.state.isTooltipOpen=!1},1e4),e===EntityVO.TYPE_PERSON&&d.hasRole(u.ITSM_PEOPLE_USER_ROLE)&&t.list.unshift({isEmptyResult:!0}),t.list})},f.onInputFocusBlur=function(){f.state.isTooltipOpen=!1},f.$watch("data.setValueFlag",function(e){"#$#"!==e&&e&&(f.data.setValueFlag="#$#")})}}}])}(),function(){angular.module("customWidgetsModule").directive("ticketType",["customFieldLinkFunction","events","systemAlertService","$filter","objectValueMapperService","$rootScope",function(e,t,a,n,i,o){return{restrict:"E",replace:!0,scope:{data:"=",context:"=",metadata:"=",isEditable:"="},templateUrl:"views/custom-widgets/ticket-type.html",link:function(r){function s(){var e=!0,t=i.getFieldsByType("category");return _.each(t,function(t){t&&t.value&&t.value.serializedValue&&t.value.serializedValue.length&&(e=!1)}),e}function l(){var e=a.modal({type:"info",title:n("i18n")("common.notification.dirty.title"),text:n("i18n")("categorization.serviceTypeChange.warning"),additionalInfo:n("i18n")("categorization.serviceTypeChange.warning.note"),buttons:[{text:n("i18n")("common.button.yes"),data:!0},{text:n("i18n")("common.button.no"),data:!1}]});return e.result}e(r);var c={lastSelectedServiceType:"",selectedServiceType:{}};r.$parent.isNew&&(c.selectedServiceType=_.head(r.metadata.types),c.lastSelectedServiceType=c.selectedServiceType.name),r.data.value.serviceType&&(c.selectedServiceType=_.find(r.metadata.types,{name:r.data.value.serviceType}),c.lastSelectedServiceType=c.selectedServiceType.name),r.editedData=c,r.updateCategories=function(){if(c.selectedServiceType&&(r.data.value.serviceType=c.selectedServiceType.name),c.selectedServiceType.name!==c.lastSelectedServiceType){var e=[];r.data.members&&_.forEach(r.data.members,function(t){e.push(t.name)}),s()?(c.lastSelectedServiceType=c.selectedServiceType.name,r.data.value.serviceType=c.selectedServiceType.name,
r.$emit(t.WIDGET_VALUE_CHANGE,{fieldName:r.data.name,memberName:e})):l().then(function(a){a?(c.lastSelectedServiceType=c.selectedServiceType.name,r.data.value.serviceType=c.selectedServiceType.name,r.$emit(t.WIDGET_VALUE_CHANGE,{fieldName:r.data.name,memberName:e})):(r.data.value.serviceType=c.lastSelectedServiceType,c.selectedServiceType=_.find(r.metadata.types,{name:c.lastSelectedServiceType}))})}};var d=o.$on(t.TICKET_TEMPLATE_UPDATED,function(e,t){t.type!==EntityVO.TYPE_TASK&&(c.selectedServiceType=t.selectedServiceType,r.data.value.serviceType=t.selectedServiceType?t.selectedServiceType.name:null,c.lastSelectedServiceType=_.cloneDeep(r.data.value.serviceType))});r.$on(t.TOGGLE_EDIT_MODE,function(){r.data.value.serviceType&&(c.selectedServiceType=_.find(r.metadata.types,{name:r.data.value.serviceType}),c.lastSelectedServiceType=c.selectedServiceType.name)}),r.$watch("data.setValueFlag",function(e){if("#$#"!==e&&e){var t=_.get(e,"serviceType",e);c.selectedServiceType=_.find(r.metadata.types,function(e){return e.name===t||e.index===t}),r.updateCategories(),r.data.setValueFlag="#$#"}}),r.$on("$destroy",function(){d()})}}}])}(),function(){angular.module("customWidgetsModule").service("widgetDependencyHandlerService",["objectValueMapperService","categoriesService","systemAlertService","i18nService","expressionEvaluatorService","events","$rootScope",function(e,t,a,n,i,o,r){function s(e,t,a){"locationCompany"===e||"serviceType"===e?u(e):"impactedService"===e?p(e):"causalCI"===e?f(e):"customer"===e||"requestedFor"===e||"contact"===e?g(e,t):"changeClass"===e?d(e):"organization"===e?m(e):"site"===e?h():"operational"===e?v():"company"===e?l(a):"customerCompany"===e&&c()}function l(t){if(_.isEmpty(e.getFieldByName("customer"))&&e.getExactValueByFieldName("company")){var a=e.getFieldsByType("dynamicSelectionField");_.forEach(a,function(e){return e.readOnlyCondition?void(e.isReadOnly=i.evaluate(e.readOnlyCondition)):void(e.readOnly||(e.isReadOnly=!1))});var n=e.getFieldsByType("affectedAsset");_.forEach(n,function(e){return e.readOnlyCondition?void(e.isReadOnly=i.evaluate(e.readOnlyCondition)):void(e.readOnly||(e.isReadOnly=!1))});var o=e.getFieldsByType("priority");if(o&&o[0]&&o[0].members){if(o[0].readOnlyCondition){var r=i.evaluate(o[0].readOnlyCondition);return o[0].isReadOnly=r,void _.forEach(o[0].members,function(e){e.isReadOnly=r})}if(o[0].readOnly)return;o[0].isReadOnly=!1,_.forEach(o[0].members,function(e){e.isReadOnly=!1})}var s=e.getFieldsByType("category");_.forEach(s,function(e){return e.readOnlyCondition?void(e.isReadOnly=i.evaluate(e.readOnlyCondition)):("fromTicketLoad"!==t&&(e.triggerClear=!0),void(e.readOnly||(e.isReadOnly=!1)))})}}function c(){if(_.isEmpty(e.getFieldByName("customer"))&&e.getExactValueByFieldName("customerCompany")){var t=e.getFieldsByType("dynamicSelectionField");_.forEach(t,function(e){return e.readOnlyCondition?void(e.isReadOnly=i.evaluate(e.readOnlyCondition)):void(e.readOnly||(e.isReadOnly=!1))});var a=e.getFieldsByType("affectedAsset");_.forEach(a,function(e){return e.readOnlyCondition?void(e.isReadOnly=i.evaluate(e.readOnlyCondition)):void(e.readOnly||(e.isReadOnly=!1))});var n=e.getFieldsByType("category");_.forEach(n,function(e){return e.readOnlyCondition?void(e.isReadOnly=i.evaluate(e.readOnlyCondition)):void(e.readOnly||(e.isReadOnly=!1))})}}function d(t){var a=e.getValueByFieldName(t);a=a.timing.name?a.timing.name:a.timing;var n=e.getFieldByName("actualDates"),i=e.getFieldByName("scheduledDates");n&&("Latent"===a?n.isRequired=!0:n.isRequired=!1),i&&("Latent"===a?i.isReadOnly=!0:i.isReadOnly=!1)}function u(t){var a=e.getValueByFieldName(t),n=e.getFieldsByType("category");_.forEach(n,function(e){e.value&&("serviceType"===t?e.value.serviceType=a&&a.serviceType:e.value.locationCompany=a,e.triggerClear=!0)})}function p(t){var a=e.getValueByFieldName(t),n=e.getValueByFieldName("product");n&&a.ci&&a.ci.product&&a.ci.product.categorizations&&a.ci.product.categorizations.length&&(n.cognitiveFlag=!1,y(n,a.ci.product.categorizations[0].tiers))}function m(t){var a=e.getValueByFieldName(t),n=e.getFieldByName("customer")||e.getFieldByName("requestedFor");n.organization=a&&a.organization}function f(t){var a=e.getValueByFieldName(t),n=e.getValueByFieldName("resolutionProduct");n&&a.ci.product&&a.ci.product.categorizations&&a.ci.product.categorizations.length&&(n.cognitiveFlag=!1,y(n,a.ci.product.categorizations[0].tiers))}function g(t,a){if("customer"!==t&&"requestedFor"!==t||!e.getFieldByName(t)){if("contact"===t){var n,o,r=e.getValueByFieldName("contact");if(_.isEmpty(r))n=e.getFieldByName("contactPhone"),_.isEmpty(n)||(n.value.contactPhoneNumber=n.ootbValue="",n.isReadOnly=!0),o=e.getFieldByName("contactEmail"),_.isEmpty(o)||(o.value.contactEmail=o.ootbValue="");else if(o=e.getFieldByName("contactEmail"),o&&(o.value.contactEmail=o.ootbValue=r.email),n=e.getFieldByName("contactPhone")){if(n.value.contactPhoneNumber=n.ootbValue=r.phone,n.readOnlyCondition)return void(n.isReadOnly=i.evaluate(n.readOnlyCondition));if(n.readOnly)return;n.isReadOnly=!1}}}else{var s,l,c,d,u,p,m,f,g,h,y=_.cloneDeep(e.getFieldByName(t));if(s=y.previousValue,y=y.value,_.isEmpty(y)){d=e.getFieldByName("customerCompany"),d&&(d.value=""),l=e.getFieldByName("customerPhone"),_.isEmpty(l)||(l.value.phoneNumber=l.ootbValue=""),c=e.getFieldByName("customerEmail"),_.isEmpty(c)||(c.value.internetEmail=c.ootbValue=""),u=e.getFieldByName("organization"),!_.isEmpty(u)&&u.value&&(u.value.hasOwnProperty("customerOrg")?u.value.customerOrg=u.ootbValue="":u.value.organization=u.ootbValue="");var v=e.getFieldByName("site");_.isEmpty(v)||"widget"!==v.dataType||_.isEmpty(v)||v.setValue({site:{name:"",id:"",attributeMap:{companyName:"",siteAddress:"",regionName:"",siteGroupName:"",siteId:""}},siteGroup:{name:"",attributeMap:{regionName:""}},region:{name:""}}),h=e.getFieldByName("locationCompany"),h&&(h.ticketCompany=null,h.locationCompanySelected||(h.value=null)),h&&h.locationCompanySelected||(p=e.getFieldsByType("category"),_.forEach(p,function(e){e.isReadOnly=!0})),m=e.getFieldsByType("dynamicSelectionField"),_.forEach(m,function(e){if("company"===e.name||"customerCompany"===e.name){if(e.readOnlyCondition)return void(e.isReadOnly=i.evaluate(e.readOnlyCondition));if(e.readOnly)return}else["operationCategoryTier1","operationCategoryTier2","operationCategoryTier3","productCategoryTier1","productCategoryTier2","productCategoryTier3","productName","productModelVersion","resOperationCategoryTier1","resOperationCategoryTier2","resOperationCategoryTier3","resProductCategoryTier1","resProductCategoryTier2","resProductCategoryTier3","resProductName","resProductModelVersion","impactedService","causalCI"].indexOf(e.name)!==-1&&(e.isReadOnly=!0)}),f=e.getFieldsByType("affectedAsset"),_.forEach(f,function(e){e.isReadOnly=!0}),g=e.getFieldsByType("priority"),g&&g[0]&&g[0].members&&(g[0].isReadOnly=!0,_.forEach(g[0].members,function(e){e.isReadOnly=!0}))}else if(l=e.getFieldByName("customerPhone"),l&&(l.value.phoneNumber=l.ootbValue=y.phone),c=e.getFieldByName("customerEmail"),c&&(c.value.internetEmail=c.ootbValue=y.email),d=e.getFieldByName("customerCompany"),d&&(d.value=y.company.name),u=e.getFieldByName("organization"),u&&u.value&&(u.value.hasOwnProperty("customerOrg")?u.value.customerOrg=u.ootbValue=y.organization:u.value.hasOwnProperty("organization")&&(u.value.organization=u.ootbValue=y.organization)),"cancel"!==a&&E(y,t),h=e.getFieldByName("locationCompany"),h&&(h.ticketCompany=y.company),h&&h.locationCompanySelected||s&&s.company.name===y.company.name||(p=e.getFieldsByType("category"),_.forEach(p,function(e){return e.readOnlyCondition?void(e.isReadOnly=i.evaluate(e.readOnlyCondition)):void(e.readOnly||(e.isReadOnly=!1))})),m=e.getFieldsByType("dynamicSelectionField"),_.forEach(m,function(e){return e.readOnlyCondition?void(e.isReadOnly=i.evaluate(e.readOnlyCondition)):void(e.readOnly||(e.isReadOnly=!1))}),f=e.getFieldsByType("affectedAsset"),_.forEach(f,function(e){return e.readOnlyCondition?void(e.isReadOnly=i.evaluate(e.readOnlyCondition)):void(e.readOnly||(e.isReadOnly=!1))}),g=e.getFieldsByType("priority"),g&&g[0]&&g[0].members){if(g[0].readOnlyCondition){var T=i.evaluate(g[0].readOnlyCondition);return g[0].isReadOnly=T,void _.forEach(g[0].members,function(e){e.isReadOnly=T})}if(g[0].readOnly)return;g[0].isReadOnly=!1,_.forEach(g[0].members,function(e){e.isReadOnly=!1})}}}function h(){var t=_.cloneDeep(e.getFieldByName("site")),a=e.getFieldByName("customerLocationMap");_.isEmpty(a)||_.isEmpty(t)||_.isEmpty(t.value)||_.isEmpty(t.value.site)||e.setValueByFieldName("customerLocationMap",t.value.site.attributeMap.siteAddress);var n=e.getFieldByName("googleMap");_.isEmpty(n)||_.isEmpty(t)||_.isEmpty(t.value)||n.setValue(t.value.site.attributeMap.siteAddress)}function y(e,a){_.forEach(e.listOfTiers,function(t){var n=t.name;a.hasOwnProperty(t.name)||("resolutionProduct"===e.name?n="p"+t.name.slice(4):"resolution"===e.name&&(n="o"+t.name.slice(4))),t.selectedValue=a[n]}),e.serializedValue=t.getDisplayValues(e)}function E(t,a){var n;if("requestedFor"===a){n=e.getFieldByName("changeLocation"),_.isEmpty(n)||"widget"!==n.dataType||n.setValue({address:{address:t.site.address.address,city:t.site.address.city,country:t.site.address.country,street:t.site.address.street,state:t.site.address.state,zip:t.site.address.zip},companyName:t.company.name,name:t.site.name,siteGroup:t.site.siteGroup,siteId:t.site.siteId,region:t.site.region});var i=e.getFieldByName("company");_.isEmpty(i)||i.setValue(t.company.name)}else n=e.getFieldByName("site"),_.isEmpty(n)||"widget"!==n.dataType||(n.setValue({site:{name:t.site.name,id:t.site.siteId,attributeMap:{companyName:t.company.name,siteAddress:t.site.address,regionName:t.site.region,siteGroupName:t.site.siteGroup,siteId:t.site.siteId}},siteGroup:{name:t.site.siteGroup,attributeMap:{regionName:t.site.region}},region:{name:t.site.region},company:{name:t.company&&t.company.name}}),h())}function v(){e.getTicketType()===EntityVO.TYPE_CHANGE&&r.$broadcast(o.RELOAD_RISK_QUESTION)}return{handleValueChange:s,handleCategoryChange:y}}])}(),function(){angular.module("myitsmApp").directive("dwpWindow",["$sce","smartRecorderModel","$filter","$state","systemAlertService",function(e,t,a,n,i){return{restrict:"E",template:"<iframe tabindex='0' style='border: none;top: 60px;position: fixed;border: none;border: none;height: calc(100% - 60px);' ux-id='dwp-window' width='100%' src='{{loadurl}}'></iframe>",replace:!0,scope:{serviceId:"=",requestedFor:"=",requestedBy:"=",modalInstance:"="},link:function(o){function r(e){if(e.data&&"object"==typeof e.data){var r=e.data;r.action&&"checkout"===r.action&&("success"===r.status?(i.success({text:a("i18n")("ticket.dwp.submitted"),icon:"icon-check_circle",clear:!0,displayOnStateChange:!0,hide:1e4}),t.saveState=!1,n.go("sberequest",{id:r.requestId})):"failure"===r.status?(i.error({text:r.message,clear:!1}),o.modalInstance.dismiss()):"cancelRequest"===r.status&&o.modalInstance.dismiss())}}o.dwpurl=t.dwpUrl,o.smartiturl=t.smartitUrl,0!==o.dwpurl.indexOf("http://")&&0!==o.dwpurl.indexOf("https://")&&console.error("Invalid DWP url in ccs - it should contain either http:// or https:// :"+o.dwpurl),0!==o.smartiturl.indexOf("http://")&&0!==o.smartiturl.indexOf("https://")&&console.error("Invalid smartiturl url in ccs - it should contain either http:// or https:// :"+o.smartiturl);var s=o.dwpurl+"/dwp/rest/embed?allow-from-domain="+o.smartiturl+"&action=checkout&id="+o.serviceId+"&requestedForUserId="+o.requestedFor+"&requestedByUserId="+o.requestedBy;o.loadurl=e.trustAsResourceUrl(s),window.onmessage=r}}}])}(),function(){angular.module("i18nModule").directive("i18n",["i18nService",function(e){var t={restrict:"EAC",updateText:function(t,a){var n=a.split("|");if(n.length>=1){var i=e.getLocalizedString(n[0]);if(null!==i&&void 0!==i&&""!==i){if(n.length>1)for(var o=1;o<n.length;o++){var r="{"+(o-1)+"}";i=i.replace(r,n[o])}t.text(i)}}},link:function(e,a,n){e.$on("i18nResourcesUpdated",function(){t.updateText(a,n.i18n)}),n.$observe("i18n",function(){t.updateText(a,n.i18n)})}};return t}]).directive("i18nAttr",["i18nService",function(e){var t={restrict:"EAC",updateText:function(t,a){var n=a.split("|"),i=e.getLocalizedString(n[0]);if(null!==i&&void 0!==i&&""!==i){if(n.length>2)for(var o=2;o<n.length;o++){var r="{"+(o-2)+"}";i=i.replace(r,n[o])}t.attr(n[1],i)}},link:function(e,a,n){e.$on("i18nResourcesUpdated",function(){t.updateText(a,n.i18nAttr)}),n.$observe("i18nAttr",function(e){t.updateText(a,e)})}};return t}])}(),function(){angular.module("i18nModule").filter("i18n",["i18nService",function(e){return function(t,a){angular.isArray(a)||(a=[a]);var n=e.getLocalizedString(t);if(a&&n)for(var i=0,o=a.length;i<o;i++)n=n.replace("{"+i+"}",a[i]);return n}}])}(),function(){angular.module("i18nModule").factory("i18nService",["$http","$rootScope","$window",function(e,t,a){var n={language:window.myitsmLocale,dictionary:[],url:void 0,resourceFileLoaded:!1,successCallback:function(e){e.config&&e.data&&e.status?n.dictionary=e.data:n.dictionary=e,n.resourceFileLoaded=!0,t.$broadcast("i18nResourcesUpdated")},setLanguage:function(e){n.language=e,n.initLocalizedResources()},setUrl:function(e){n.url=e,n.initLocalizedResources()},buildUrl:function(){if(!n.language){var e,t;e=a.navigator&&a.navigator.userAgent&&(t=a.navigator.userAgent.match(/android.*\W(\w\w)-(\w\w)\W/i))?t[1]:a.navigator.userLanguage||a.navigator.language,n.language=e}return"scripts/app/i18n/resources-locale_"+n.language+".json"},initLocalizedResources:function(){if(window.appLocalilzation)return void n.successCallback(window.appLocalilzation);var t=n.url||n.buildUrl();e({method:"GET",url:t,cache:!1}).then(n.successCallback)["catch"](function(){var t="scripts/app/i18n/resources-locale_en.json";e({method:"GET",url:t,cache:!1}).then(n.successCallback)})},getLocalizedString:function(e){var t=e;return"undefined"!=typeof n.dictionary&&(t=n.dictionary[e]||e),t},getLocalizedStringwithParams:function(e,t){angular.isArray(t)||(t=[t]);var a=n.getLocalizedString(e);if(t)for(var i=0,o=t.length;i<o;i++)a=a.replace("{"+i+"}",t[i]);return a},getByteLength:function(e){return encodeURIComponent(e).replace(/%[A-F\d]{2}/g,"U").length}};return n.initLocalizedResources(),n}])}(),function(){angular.module("dashboardModule").controller("DashboardController",["$scope","dashboardService","$modal","systemAlertService",function(e,t,a,n){e.showModal=function(){var e=n.modal({title:"some title",text:"some text",buttons:[{text:"update",result:"update"}]});e.result.then(function(e){console.log(" error was submited with result"+e)},function(e){console.log(" error was dismissed with result"+e)})}}])}(),function(){angular.module("dashboardModule").factory("dashboardService",["$resource",function(e){var t=e("data/tickets.json",{},{getList:{method:"GET",isArray:!1}});return t}]).factory("dashboardFeedService",["$resource",function(e){var t=e("data/feeds.json",{},{getList:{method:"GET",isArray:!1}});return t}])}(),function(){angular.module("feedModule").controller("ActivityFeedController",["$scope","$filter","$interval","feedModel","configurationModel","attachmentService","events","userModel","personModel","metadataModel","$window","systemAlertService",function(e,t,a,n,i,o,r,s,l,c,d,u){var p={space:32},m=c.cache&&c.cache.global&&c.cache.global.configurationParameters&&c.cache.global.configurationParameters.timelineRefreshInterval?1e3*parseInt(c.cache.global.configurationParameters.timelineRefreshInterval):6e4,f=!0;e.feedModel=n,e.activityTypeFilters=[],e.workinfoTypeFilters=[],e.userModel={isAccessibleUser:s.isAccessibleUser},e.pendingFilterUpdate=!1,e.escapeEncodedCharacters=!!(c.cache&&c.cache.global&&c.cache.global.configurationParameters&&"true"===c.cache.global.configurationParameters.displayEncodedCharacters),e.type===EntityVO.TYPE_PERSON&&(e.personModel=l);var g="",h=[],y={},E={loadingFeeds:!e.isDraft,loadingMoreFeeds:!1,allFeedsLoaded:!1,filterReady:!1,filerExpanded:!1,isNotAuthorized:!1},v={first:{},last:{}},T=function(){g=moment().valueOf(),E.allFeedsLoaded=!1,h.length=0,v.first={}},S=function(e){return n.getActivityFeedItems(y,e||{}).then(function(e){e.isNotAuthorized?E.isNotAuthorized=!0:C(e)})},C=function(t){_.isEmpty(t)?E.allFeedsLoaded=!0:(Array.prototype.push.apply(h,t),v.last=_.last(t),_.isEmpty(v.first)&&(v.first=_.head(t)),e.parentContext&&(e.parentContext.feed=h))};if(angular.element(d).bind("focus",function(){f=!0}).bind("blur",function(){f=!1}),e.getActivityFeedItems=function(t){e.getActivityFeedItemsDebounced&&e.getActivityFeedItemsDebounced.cancel(),E.loadingFeeds=!0,T(),S()["finally"](function(){E.loadingFeeds=!1})},e.getNewActivityFeedItems=function(){E.loadingFeeds||E.savingNote||!f||n.getActivityFeedItems(y,{criteria:"gt,"+(v.first.createDate||g)}).then(function(e){_.isEmpty(e)||(v.first=_.head(e),_.forEach(e.reverse(),function(e){_.remove(h,function(t){return t.id===e.id}),h.unshift(e)}))})},e.loadMoreFeeds=function(){E.loadingMoreFeeds||E.allFeedsLoaded||E.loadingFeeds||(E.loadingMoreFeeds=!0,S({criteria:"lt,"+v.last.createDate})["finally"](function(){E.loadingMoreFeeds=!1}))},e.changeFilters=function(t){t&&(t.selected=!t.selected),e.pendingFilterUpdate=!0},e.keyPressOnFilterItem=function(t,a){t&&t.keyCode===p.space&&(e.applyFilter(a),t.preventDefault(),t.stopPropagation())},e.applyFilter=function(t){t&&(t.selected=!t.selected),n.buildFeedFilter(n.activityFeed,e.activityTypeFilters.concat(e.workinfoTypeFilters)),e.getActivityFeedItems()},e.clearSearchText=function(){n.activityFeed.params.searchQuery=""},e.handleAttachmentClick=function(e,t,a,n){E.loadingFeeds=!0,o.getAttachmentFile(e,t,a,n)["finally"](function(){E.loadingFeeds=!1})},e.saveNote=function(a){return E.savingNote=!0,n.saveNote(y,a).then(function(n){a.isNeedAttentionFlag||e.getActivityFeedItems(),a.addFlagNote&&(a.isNeedAttentionFlag&&n&&500!==n.status?(e.$emit(r.TICKET_PROFILE_RESEND_EVENT,{eventName:r.REFRESH_TICKET_FROM_TITLE_BAR}),u.success({text:a.flag?t("i18n")("console.filter.optionName.flagged"):t("i18n")("console.filter.optionName.unflagged"),hide:1e4})):e.$emit(r.TICKET_PROFILE_RESEND_EVENT,{eventName:r.REFRESH_KNOWLEDGE_ARTICLE}))})["finally"](function(){E.savingNote=!1})},e.showContext=function(t){if(t&&t.relatedObject)return t.relatedObject.id!==e.itemId},e.searchInputTitle=e.type===EntityVO.TYPE_KNOWLEDGE?t("i18n")("feed.filter.name.KnowledgeSearch"):t("i18n")("feed.filter.name.Search"),e.state=E,e.feed=h,e.showActivityTypeFilters="POI"!==e.assetClassId,e.showWorkinfoTypeFilters="POI"!==e.assetClassId,!e.isDraft){var O=e.$watch("feedModel.activityFeed.params.searchQuery",function(t,a){t?e.getActivityFeedItemsDebounced():a&&(n.activityFeed.params.searchQuery="",e.getActivityFeedItems())});e.getActivityFeedItemsDebounced=_.debounce(e.getActivityFeedItems,1e3);var A=a(e.getNewActivityFeedItems,m);e.$on("$destroy",function(){a.cancel(A),O(),n.activityFeed.params.searchQuery="",angular.element(d).unbind("focus blur")}),e.$watch("assetObject",function(t){t&&y&&y.type===EntityVO.TYPE_ASSET&&"POI"!==e.assetClassId&&e.assetObject&&(y.poiId=e.assetObject.poiId||"",e.applyFilter())}),e.$watch("itemId",function(a){if(a){y.type=e.type,y.id=e.itemId,y.poiId=null,"POI"===e.assetClassId&&(y.poiId=e.itemId);var o=i.get("feed.activity."+y.type+".filter");e.activityTypeFilters=_.isEmpty(o)?[]:o,i.isServerApplicationEnabled(EntityVO.TYPE_SLM)||(e.activityTypeFilters=_.reject(e.activityTypeFilters,{name:"slaAlerts"})),_.forEach(e.activityTypeFilters,function(e){e.selected=!1,e.localizedLabel=t("i18n")("feed.filter.optionName."+e.label)}),e.activityTypeFilters=_.sortBy(e.activityTypeFilters,"localizedLabel"),n.getWorkinfoTypeFilters(y.type).then(function(a){e.workinfoTypeFilters=a,e.workinfoTypeFilters.length&&(_.forEach(e.workinfoTypeFilters,function(e){e.localizedLabel=t("i18n")(e.label)}),e.workinfoTypeFilters=_.sortBy(e.workinfoTypeFilters,"localizedLabel")),E.filterReady=!0,e.assetClassId&&"POI"!==e.assetClassId||e.applyFilter()})}}),e.$watch("parentContext",function(){e.parentContext&&(e.parentContext.feed=h)}),e.$watch("personModel.personDetails",function(){e.personModel&&e.personModel.personDetails&&(e.parentContext=e.personModel.personDetails)}),e.$watch(function(){return s.isAccessibleUser},function(t){e.userModel.isAccessibleUser=t}),e.$on(r.REFRESH_ACTIVITY_FEED,function(){e.getActivityFeedItems()}),e.$on(r.ADD_NEW_ACTIVITY_FEED_TO_LIST,function(){e.getNewActivityFeedItems()})}}])}(),function(){angular.module("feedModule").directive("activityFeed",[function(){return{restrict:"E",replace:!0,templateUrl:"views/feed/activity-feed.html",scope:{type:"@",itemId:"=",parentContext:"=?",commentable:"=",assetClassId:"=",assetObject:"=",refresh:"=",isFullVersion:"=",isDraft:"=",isUnflagEditAllowed:"=",inputDisabled:"="},controller:"ActivityFeedController"}}])}(),CommentVO.prototype=new BaseVO,CommentVO.prototype.constructor=CommentVO,CommentVO.prototype.getProps=function(){return BaseVO.prototype.getProps().concat("message","author","attachmentCount","attachments")},CommentVO.prototype.hasAttachments=function(){return this.attachmentCount>0},CommentVO.prototype.postBuild=function(){this.author=(new UserVO).build(this.author),this.title=this.author.getFullName(),this.dateTitle=moment(this.createDate).calendar({sameElse:"lll"}),this.attachmentCount>0&&(this.attachments=this.attachments.map(function(e){return(new AttachmentVO).build(e)}))},function(){angular.module("feedModule").directive("entityProfileLink",["$filter","pwaModel","configurationModel",function(e,t,a){return{restrict:"A",scope:{entityData:"=entityProfileLink"},link:function(n,i){if(n.entityData){n.entityData.type&&"changerequest"===n.entityData.type&&(n.entityData.type="change");var o=n.entityData.entityLink,r=n.entityData.type;if(_.includes(n.entityData.entityLink,"/asset/")&&(r="asset"),t.isPwaEnabled()&&a.get("pwaEnabledTickets.tickets").indexOf(r)>=0&&(r+="PV"),_.includes(n.entityData.entityLink,"asset")&&!n.entityData.loginId){var s,l;n.entityData.reconciliationId||n.entityData.id?(s=e("escape")(n.entityData.reconciliationId||n.entityData.id),l=n.entityData.classId||n.entityData.realObject.classId,o="#/"+r+"/"+s+"/"+l):n.entityData.realObject.reconciliationId&&(s=e("escape")(n.entityData.realObject.reconciliationId),o="#/"+r+"/"+s+"/"+n.entityData.realObject.classId)}!n.entityData.entityLink&&n.entityData.id&&(o="#/"+r+"/"+encodeURIComponent(n.entityData.id.replace(/\\\\/g,"\\"))),i.attr("href")||(t.isPwaEnabled()&&(o=o.replace("/person/","/personPV/")),i.attr("href",o))}else console.log("No information about entity")}}}])}(),EventVO.prototype=Object.create(BaseVO.prototype),EventVO.prototype.constructor=EventVO,EventVO.prototype.INCIDENT_CREATE="incident-create",EventVO.prototype.PRIORITY_CHANGE="priority-change",EventVO.prototype.STATUS_CHANGE="status-change",EventVO.prototype.SLA_CHANGE="sla-change",EventVO.prototype.SLA_MET="sla-met",EventVO.prototype.OUTAGE_CHANGE="outage-change",EventVO.prototype.ASSIGNMENT_CHANGE="assignment-change",EventVO.prototype.GENERIC_UPDATE="generic-update",EventVO.prototype.EMAIL="email-worknote",EventVO.prototype.RICH_EMAIL="email-richText-worknote",EventVO.prototype.FLAG="ka-flagged",EventVO.prototype.UNFLAG="ka-unflagged",EventVO.prototype.NEEDS_ATTENTION_FLAG="needs-attention-flagged",EventVO.prototype.NEEDS_ATTENTION_UNFLAG="needs-attention-unflagged",EventVO.prototype.RELATED_CHANGE="related-change",EventVO.prototype.UNRELATED_CHANGE="unrelated-change",EventVO.prototype.LOCATION_CHANGE="region-change",EventVO.prototype.OWNERSHIP_CHANGE="ownership-change",EventVO.prototype.VENDOR_CREATE_ITSM_TICKET="vendor-create-itsm-ticket",EventVO.prototype.VENDOR_CREATE="vendor-create",EventVO.prototype.VENDOR_CREATE_V2="vendor-create-v2",EventVO.prototype.VENDOR_NOTE="vendor-note",EventVO.prototype.VENDOR_NOTE_V2="vendor-note-v2",EventVO.prototype.VENDOR_STATUS_CHANGE="vendor-status-change",EventVO.prototype.VENDOR_STATUS_CHANGE_V2="vendor-status-change-v2",EventVO.prototype.TASK_RELATION="task-relation",EventVO.prototype.TASK_MANUAL="Manual",EventVO.prototype.TASK_AUTOMATIC="Automatic",EventVO.prototype.SERVICE_HEALTH_STATUS="service-health-status",EventVO.prototype.getProps=function(){return BaseVO.prototype.getProps().concat("messageId","eventType","labelTemplate","title","priority","startDate","endDate","entities","recipients","summary","description","classId")},EventVO.prototype.postBuild=function(){this.entities=this.entities.map(function(e){return(new EntityVO).build(e)}),this.recipients=this.recipients.map(function(e){return(new EntityVO).build(e)}),this.startDate&&(this.startDate=new Date(1e3*this.startDate),this.startDateHumanized=moment(this.startDate).calendar({sameElse:"lll"})),this.endDate&&(this.endDate=new Date(1e3*this.endDate),this.endDateHumanized=moment(this.endDate).calendar({sameElse:"lll"}))},EventVO.prototype.isSlaChange=function(){return this.eventType===EventVO.prototype.SLA_CHANGE},EventVO.prototype.isSlaMet=function(){return this.eventType===EventVO.prototype.SLA_MET},EventVO.prototype.getEventSpecifier=function(){var e=this.eventType,t=this.entities.filter(function(t){return e.indexOf(t.type)>-1});return t.length&&(e+="-"+t[0].entityId),e},function(){angular.module("myitsmApp").directive("feedCommentThread",["$http","$templateCache","$compile","$window","events","attachmentService","$filter","smartRecorderModel","$timeout","metadataModel","systemAlertService","feedModel","userModel","i18nService","configurationModel","browser","utilityFunctions",function(e,t,a,n,i,o,r,s,l,c,d,u,p,m,f,g,h){return{restrict:"A",priority:99,template:angular.noop,replace:!1,scope:{nestingLevel:"@",runSaveNoteHandler:"&savenote",opened:"@",isClosed:"=",data:"@",parentContext:"=",type:"=",isDraft:"=",timelineItem:"=",attachmentDisabled:"=",isUnflagEditAllowed:"=",inputDisabled:"=",inputText:"=?",isRequired:"=?"},link:function(p,y){function E(){console.log("handling SAVE_DRAFT event in feed-comment-thread ");var e=A();(e.noteText||e.attachments&&e.attachments.length)&&(u.pendingWorkNote=e,console.log("initialized pending note"),p.type!==EntityVO.TYPE_CHANGE&&p.type!==EntityVO.TYPE_RELEASE&&(p.state.savingNote=!0))}function v(){p.selectedWorknoteType=_.find(p.worknoteTypes,{name:G})||{},p.addNoteForm(!0)}function T(){var e=x[0],t=_.filter(s.smartRecorderData.confirmedItems,{relationship:"mentioned"});if(t&&t.length){for(var a,n=0;n<t.length;n++)a=t[n],n>0&&(e.lastChild.data=", "),e.appendChild(document.createTextNode(a.originalName)),w(a.originalName,a.content,a.type,a.displayName,a.id);var i=1===t.length?m.getLocalizedString("createNew.ticket.mentionedPerson"):m.getLocalizedString("createNew.ticket.mentionedPersons");e.appendChild(document.createTextNode(i));var o=document.createRange(),r=window.getSelection(),l=e.lastChild;o.setStart(l,l.length),o.collapse(!0),r.removeAllRanges(),r.addRange(o),x.focus()}}function S(){p.isNeedAttentionFlag=!1,p.selectedWorknoteType=_.find(p.worknoteTypes,{name:G})||{},p.toggleNoteForm(),p.$apply()}function C(e){13===e.which&&(p.isNeedAttentionFlag=!1,p.selectedWorknoteType=_.find(p.worknoteTypes,{name:G})||{},p.toggleNoteForm(),p.$apply())}function O(e){return e.id&&e.vendorTicketUrl?"@["+e.id+"]|"+e.vendorTicketUrl+"|(url)":e.id||""}function A(){if(x){var e={noteText:H(x.clone(!0)),attachments:p.attachments,access:!p.state.access,workInfoType:p.selectedWorknoteType.index,addFlagNote:p.addFlagNote,flag:p.flag};return p.state.shareWithVendor&&p.parentContext&&p.parentContext.brokerVendorName&&(p.type===EntityVO.TYPE_INCIDENT?e.shareWithVendor=!0:_.isArray(p.shareableVendorTickets)&&(1===p.shareableVendorTickets.length?e.vendorTicketId=_.map(p.shareableVendorTickets,O).join()||"":p.shareableVendorTickets.length>1&&(e.vendorTicketId=_(p.shareableVendorTickets).filter({selected:!0}).map(O).join(", "))),e.brokerVendorName=p.parentContext.brokerVendorName),p.isFlagThread&&p.state.isThreadUnflagged?(e.addFlagNote=!0,e.flag=!1,e.isCommentOnly=!0,e.workNoteGuid=p.timelineItem.note.workNoteGuid):p.isFlagThread&&(e.addFlagNote=!0,e.flag=!p.state.unflagging,e.isCommentOnly=!p.state.unflagging,e.workNoteGuid=p.timelineItem.note.workNoteGuid),p.isNeedAttentionFlag&&(e.isNeedAttentionFlag=p.isNeedAttentionFlag),e}return{}}function I(e){var t,a;document.createRange?(t=document.createRange(),t.selectNodeContents(e),t.collapse(!1),a=window.getSelection(),a.removeAllRanges(),a.addRange(t)):document.selection&&(t=document.body.createTextRange(),t.moveToElementText(e),t.collapse(!1),t.select())}function b(e){var t;if(window.getSelection){if(t=window.getSelection(),t.rangeCount>0){for(var a=0;a<t.rangeCount;++a)if(!k(t.getRangeAt(a).commonAncestorContainer,e))return!1;return!0}}else if((t=document.selection)&&"Control"!==t.type)return k(t.createRange().parentElement(),e);return!1}function k(e,t){for(;e;){if(e===t)return!0;e=e.parentNode}return!1}function D(e,t){var a,n;if(window.getSelection)if(a=window.getSelection(),b(t))if(a.getRangeAt&&a.rangeCount){n=a.getRangeAt(0),n.deleteContents(),t=document.createElement("div"),t.innerHTML=e;for(var i,o,r=document.createDocumentFragment();i=t.firstChild;)o=r.appendChild(i);n.insertNode(r),o&&(n=n.cloneRange(),n.setStartAfter(o),n.collapse(!0),a.removeAllRanges(),a.addRange(n))}else document.selection&&"Control"!==document.selection.type&&document.selection.createRange().pasteHTML(e);else I(t),D(e,t)}function R(e){var t="";return $.each(e.childNodes,function(e,a){t+="br"===a.nodeName.toLowerCase()?"\n":a.innerText||a.textContent,ne&&"p"===a.nodeName.toLowerCase()&&(t+="\n")}),t.replace(/[\r\n]+$/,"")}function P(e,t){var n=x[0];$.each(n.childNodes,function(n,i){if("#text"===i.nodeName.toLowerCase()&&i.data.length>1){var o=i.data.indexOf(e);if(o>-1){var r=document.createRange();r.setStart(i,o),r.setEnd(i,o+e.length);var s=angular.element("<span>"+t+"</span>");s.addClass("smart-recorder-highlight"),s.attr("ng-click","handleSmartInputHighlightSelected($event)"),s.attr("contenteditable",ie);var l=a(s),c=l(p);r.deleteContents(),r.insertNode(c[0])}}})}function w(e,t,n,i,o){var r=x[0];r.normalize&&r.normalize(),$.each(r.childNodes,function(s,l){if("#text"===l.nodeName.toLowerCase()&&l.data.length>1){var c=l.data.indexOf(e);if(c>-1){var d=document.createRange();d.setStart(l,c),d.setEnd(l,c+e.length);var u=angular.element("<span>"+h.escapeHTML(i)+"</span>");u.addClass("smart-recorder-highlightPerfectMatch").attr("contenteditable",ie).attr("tabindex","-1").data({displayName:i,id:o+(n===EntityVO.TYPE_ASSET?"*"+t.classId:""),type:n===EntityVO.TYPE_ASSET?n:"user"});var m=a(u),f=m(p);d.deleteContents(),d.insertNode(f[0]),p.inputText=N(),p.inputTextHtml=x.html();var g=document.createRange(),y=window.getSelection(),E=r.lastChild;"br"===E.nodeName.toLowerCase()?(E=E.previousSibling,E.data=" "+E.data):"#text"===E.nodeName.toLowerCase()&&""===E.data?E.data="":"span"===E.nodeName.toLowerCase()&&(E=document.createTextNode(""),r.appendChild(E)),g.setStart(E,E.length),g.collapse(!0),y.removeAllRanges(),y.addRange(g),x.focus()}}})}function L(e,t,a,n,i){var o=$("<span>"+h.escapeHTML(n)+"</span>");o.addClass("smart-recorder-highlightPerfectMatch").attr("contenteditable",ie).data({displayName:n,id:i+(a===EntityVO.TYPE_ASSET?"*"+t.classId:""),type:a===EntityVO.TYPE_ASSET?a:"user"}),$(e).replaceWith(o),p.inputTextHtml=x.html()}function N(){var e=x[0],t="";return $.each(e.childNodes,function(e,a){t+="br"===a.nodeName.toLowerCase()?"\n":a.innerText||a.textContent,ne&&"p"===a.nodeName.toLowerCase()&&(t+="\n")}),t.replace(/[\r\n]+$/,"")}function M(e){var t=e.list;if((t.length>=Z&&p.actualTypeAheadText!==s.personSearchString||p.actualTypeAheadText.length<s.personSearchString.length)&&p.actualTypeAheadText.length>=3)W=p.actualTypeAheadText,p.typeAheadText=p.actualTypeAheadText,s.getListOfPersons(W,Z).then(M);else if(p.personProfileList=t,te=t.length+1,p.personProfileListFilteredLength=r("filter")(p.personProfileList,p.typeAheadText).length,p.typeAheadListPos=0,j=!1,p.personProfileList.length>0&&K)for(var a=p.actualTypeAheadText.length,n=p.typeAheadText.length;a>3||a>n;){
var i=p.actualTypeAheadText.substr(0,a),o=r("filter")(p.personProfileList,i).length;if(o>0){p.personProfileListFilteredLength=o,p.typeAheadText=i;break}a--}}function V(e){if((e.totalMatches>X&&p.actualTypeAheadText!==s.assetSearchString||p.actualTypeAheadText.length<s.assetSearchString.length)&&p.actualTypeAheadText.length>=3)W=p.actualTypeAheadText,p.typeAheadText=p.actualTypeAheadText,s.getListOfAssets(W,X).then(V);else if(p.assetProfileList=e.objects,ee=e.totalMatches,p.assetProfileListFilteredLength=r("filter")(p.assetProfileList,p.typeAheadText).length,p.typeAheadListPos=0,j=!1,p.assetProfileList.length>0&&K)for(var t=p.actualTypeAheadText.length,a=p.typeAheadText.length;t>3||t>a;){var n=p.actualTypeAheadText.substr(0,t),i=r("filter")(p.assetProfileList,n).length;if(i>0){p.assetProfileListFilteredLength=i,p.typeAheadText=n;break}t--}}function F(){p.state.savingNote=!1}var x,G="General Information",B=f.smartRecorderSearchByCompany,U=p.timelineItem&&p.timelineItem.isFlag()?r("i18n")("timeline.note.respondFlag.placeholder"):r("i18n")("timeline.note.addNote.placeholder");p.skipClientSideFiltering=!1,c.getMetadataByType(EntityVO.TYPE_GLOBAL).then(function(e){e.configurationParameters&&e.configurationParameters.enableSearchForAccentChar&&(p.skipClientSideFiltering="true"===e.configurationParameters.enableSearchForAccentChar)}),p.$on(i.SAVE_TICKET_DRAFT,E),p.$on(i.SAVE_COPY_CHANGE_ACTIVITY,E),p.$on(i.SET_TICKET_DRAFT_MENTIONED,v),p.state={isPublicEnabled:!_.includes([EntityVO.TYPE_KNOWLEDGE,EntityVO.TYPE_SERVICEREQUEST],p.type),isAttachEnabled:!p.attachmentDisabled,isPostButtonVisible:!p.isDraft,noteFormIsActive:!1,savingNote:!1,access:!1,shareWithVendor:!1,atLeastOneShareableVendorTickets:!1},p.timelineItem&&(p.state.isThreadUnflagged=p.timelineItem.hasUnflaggingResponse(),p.isFlagThread=p.timelineItem.isFlag()),p.$watch("parentContext.brokerVendorName",function(e){p.state.isVendorEnabled=!!e}),p.$watch("parentContext.vendorInfo",function(e){_.isArray(e)&&(p.shareableVendorTickets=_.filter(e,function(e){return e.vendor.doNotShareWorkLogToVendor!==!0}),p.state.atLeastOneShareableVendorTickets=_.isArray(p.shareableVendorTickets)&&p.shareableVendorTickets.length>0,p.state.isMultipleVendorTickets=_.isArray(p.shareableVendorTickets)&&p.shareableVendorTickets.length>1,p.updateShareWithVendorFlag())}),p.updateVendorTicketList=function(e){e.selected=!e.selected,p.updateShareWithVendorFlag()},p.updateShareWithVendorFlag=function(){p.state.shareWithVendor=_.some(p.shareableVendorTickets,{selected:!0})},p.commentFormNode=angular.element(""),p.attachments=[],p.selectedWorknoteType={},p.placeholderText=U,EntityVO.hasMetadata(p.type)&&c.getMetadataByType(p.type).then(function(e){p.worknoteTypes=e.workinfoTypes}),p.$on(i.SET_FOCUS_TO_ACTIVITY_INPUT,function(){p.selectedWorknoteType=_.find(p.worknoteTypes,{name:G})||{},p.addFlagNote=!1,p.placeholderText=U,p.addNoteForm()}),_.isUndefined(p.timelineItem)&&p.$on(i.ADD_FLAG_NOTE,function(e,t){p.isNeedAttentionFlag=!!t.isNeedAttentionFlag,p.selectedWorknoteType=_.find(p.worknoteTypes,{name:G})||{},p.attachments=[],p.addFlagNote=!0,p.flag=t.flag,p.isNeedAttentionFlag?p.placeholderText=t.flag?r("i18n")("ticket.needsAttention.flag.inputPlaceholder"):r("i18n")("ticket.needsAttention.unflag.inputPlaceholder"):p.placeholderText=t.flag?r("i18n")("timeline.note.flag.placeholder"):r("i18n")("timeline.note.removeFlag.placeholder"),p.addNoteForm()}),p.$on(i.DISMISS_NOTE_FORM,function(){p.dismissNoteForm()}),y.on("click focusin",S),y.on("keydown keypress",C),p.$on("$destroy",function(){console.log("feedCommentThread: unbind events"),y.off("click",S),y.off("focusin",S),y.off("keydown",C),y.off("keypress",C),y.off()}),p.handleKeydown=function(e,t){32===e.keyCode&&(p.selectWorknoteType(t),e.preventDefault(),e.stopPropagation())},p.handleKeydownOnUpdate=function(e,t){32===e.keyCode&&(p.updateVendorTicketList(t),e.preventDefault(),e.stopPropagation())},p.selectWorknoteType=function(e){p.selectedWorknoteType.index!==e.index&&(p.selectedWorknoteType=e)},p.expandWorknoteTypeSection=function(e,t){e&&(e.preventDefault(),e.stopPropagation()),t.expanded||(_.forEach(p.worknoteTypes,function(e){e.expanded=!1}),t.expanded=!0)},p.addNoteForm=function(n){e.get("views/feed/feed-add-note-form.html",{cache:t}).then(function(e){if(p.state.noteFormIsActive=!0,p.editMode=!0,p.state.unflagging=!1,p.type===EntityVO.TYPE_SERVICEREQUEST?p.state.access=!0:p.type!==EntityVO.TYPE_KNOWLEDGE&&f.socialWorklogAccessSetting?p.state.access=f.socialWorklogAccessSetting:p.state.access=!1,p.commentFormNode[0])return p.commentFormNode.show(),void(void 0!==x&&($(".resource-preview__body").scrollTop($(x).offset().top),x.focus()));var t,i=p.nestingLevel,o=y;for(e.data&&(t=angular.element(e.data),p.commentFormNode=a(t)(p));i--;)o=o.parent();o.after(p.commentFormNode),x=p.commentFormNode.find(".timeline-note__text"),x.focus(),n&&T()})},p.dismissNoteForm=function(e){p.attachments=[],K=!1,p.dismissPopup(),x&&x.empty(),p.commentFormNode.hide(),p.state.noteFormIsActive=!1,p.inputText="",p.state.shareWithVendor=!1,p.shareableVendorTickets&&_.isArray(p.shareableVendorTickets)&&_.forEach(p.shareableVendorTickets,function(e){e.selected=!1}),p.state.unflagging=!1,p.addFlagNote=!1,p.placeholderText=U,p.opened&&(p.isClosed=!1)},p.toggleNoteForm=function(){p.state.noteFormIsActive?p.dismissNoteForm():p.addNoteForm()},p.handleFileChange=function(e){var t=o.prepareFileToUpload({fileInput:e});return t&&t.size<=0?void d.warning({text:r("i18n")("attachment.file_empty"),icon:"icon-exclamation_triangle",clear:!0,hide:5e3}):void(t&&(p.attachments?p.attachments.push(t):p.attachments=[t],y.parent().find("#uploadAttachment").val("")))},p.dismissAttachment=function(e,t){var a=p.attachments.indexOf(t);a>=0&&p.attachments.splice(a,1),e.stopImmediatePropagation()},p.submitNote=function(e){return!(!x.text()&&!p.attachments.length)&&(p.state.savingNote=!0,p.noteData=A(),void p.runSaveNoteHandler({noteData:p.noteData}).then(function(){p.dismissNoteForm(e)})["finally"](function(){p.state.savingNote=!1}))};var z,Y,q=function(e){return e.replace(/\n/g,"&#10;").replace(/\s/g," ").replace(/&#10;/g,"\n").replace(/(\n{2})\n+/g,"$1")},H=function(e){e.find(".smart-recorder-highlightPerfectMatch").each(function(){var e=$(this),t="@["+h.escapeHTML(e.data("displayName"))+"]|"+e.data("id")+"|("+e.data("type")+")";this.previousSibling&&(t=" "+t),e.replaceWith(t)}),ne&&(e[0].innerHTML=e[0].innerHTML.replace(/<p>/g,"").replace(/<\/p>/g,"<br><br>")),e[0].innerHTML=e[0].innerHTML.replace(/<br>/g,"\n"),e[0].innerHTML=e[0].innerHTML.trimRight();var t;return t=g.isSafari?$("<div/>").html(e[0].innerHTML.replace(/<div>/gi,"\n").replace(/<\/div>/gi,"")).text():e.text(),q(t)},K=!1,j=!1,W="",Q=2e3,J=8,Z=f.personChunkSize,X=20,ee=0,te=0,ae=null,ne=n.navigator.userAgent.indexOf("MSIE")>-1||n.navigator.userAgent.indexOf("Edge")>-1||n.navigator.userAgent.indexOf("Trident/7.0")>-1,ie=ne?"true":"false",oe={enter:13,leftArrow:37,rightArrow:39,upArrow:38,downArrow:40};p.personProfileList=[],p.assetProfileList=[],p.smartResultItems=[],p.personProfileListFilteredLength=0,p.assetProfileListFilteredLength=0,p.popupType="",p.selectedText="",p.typeAheadListPos=0,p.typeAheadText="",p.actualTypeAheadText="",p.showPopup=!1,p.smartRecorderModel=s,p.showAssetCount=!0,p.showPopupHeader=!1,p.toggleMentioning=function(){var e=p.commentFormNode.find(".timeline-note__text");p.showPopup?p.dismissPopup():(D("@",e[0]),p.handleSmartInputChange($.Event("keyup")))},p.handleSmartInputKeyDown=function(e){if(e.keyCode!==oe.upArrow&&e.keyCode!==oe.downArrow&&e.keyCode!==oe.enter||p.showPopup!==!0){if(e.keyCode===oe.enter&&!p.showPopup&&window.getSelection){var t=window.getSelection(),a=t.getRangeAt(0),n=document.createElement("br");a.deleteContents(),a.insertNode(n),a.setStartAfter(n),a.setEndAfter(n),a.collapse(!1),t.removeAllRanges(),t.addRange(a),e.preventDefault()}}else e.preventDefault()},p.hidePopupHeader=function(){p.showPopupHeader=!1},p.handleSmartInputPaste=function(e){e.preventDefault();var t;if(e.originalEvent&&e.originalEvent.clipboardData)t=e.originalEvent.clipboardData.getData("text/plain");else{if(!n.clipboardData)return;t=n.clipboardData.getData("Text")}if(t)if(document.queryCommandSupported("insertHTML"))t=h.escapeHTML(t),t=t.replace(/(?:\r\n|\r|\n)/g,"<br>"),document.execCommand("insertHTML",!1,t),x.find("div").each(function(e,t){0===t.innerHTML.trim().length&&$(t).addClass("empty-div")});else{if(!document.queryCommandSupported("paste"))return;document.execCommand("paste",!1,t)}p.handleSmartInputChange(e)},p.getCaretPosition=function(e){var t=0,a=e.currentTarget.ownerDocument.defaultView,n=a.getSelection();if(n.rangeCount>0){var i=n.getRangeAt(0),o=i.cloneRange();o.selectNodeContents(e.currentTarget),o.setEnd(i.endContainer,i.endOffset);var r=$("<div/>");r.append(o.cloneContents()),t=R(r[0]).length}return t},p.handleSmartInputChange=function(e){var t,a,n=0,i=x[0];if(i.normalize&&i.normalize(),p.inputTextHtml=x.html(),p.inputText=N(),ne||i.lastChild&&"br"===i.lastChild.nodeName.toLowerCase()||i.appendChild(document.createElement("br")),e){if(e.ctrlKey===!0||17===e.keyCode||e.altKey===!0||18===e.keyCode)return;if(e.keyCode===oe.upArrow&&p.showPopup===!0)return void(p.typeAheadListPos>0&&p.typeAheadListPos--);if(e.keyCode===oe.downArrow&&p.showPopup===!0)return void(p.typeAheadListPos<p.personProfileListFilteredLength+p.assetProfileListFilteredLength-1&&p.typeAheadListPos++);if(e.keyCode===oe.enter)return void p.handleSmartInputEnter()}if(p.inputText.length>0?(t=p.inputText.lastIndexOf(" @"),t===-1&&(t=p.inputText.lastIndexOf("\n@")),t>-1?(t+=2,p.popupType="profile"):(t=p.inputText.indexOf(String.fromCharCode(160,64)),t>-1?(t+=2,p.popupType="profile"):"@"===p.inputText[0]&&(t=1,p.popupType="profile")),n=p.getCaretPosition(e),t>-1&&n>t?(p.fullTypeaheadText=p.inputText.substring(t),p.actualTypeAheadText=p.inputText.substring(t,n),p.actualTypeAheadText=p.actualTypeAheadText.trim().substring(0,128),p.actualTypeAheadText=p.actualTypeAheadText.split("\n",1)[0],p.actualTypeAheadText.split(" ").length>3&&(a=p.actualTypeAheadText.split(" "),p.actualTypeAheadText=a[0]+" "+a[1]+" "+a[2]),K===!1&&(K=!0,p.typeAheadListPos=0)):K===!0&&(K=!1,p.dismissPopup())):K===!0&&(K=!1,p.dismissPopup()),K===!0)if(p.actualTypeAheadText.length>=3&&p.actualTypeAheadText!==p.typeAheadText){var o=r("filter")(p.personProfileList,p.actualTypeAheadText).length,c=r("filter")(p.assetProfileList,p.actualTypeAheadText).length;if(p.showPopup=!0,p.showPopupHeader=!0,o+c>0||0===p.typeAheadText.length)p.typeAheadText=p.actualTypeAheadText,p.personProfileListFilteredLength=o,p.assetProfileListFilteredLength=c;else{var d=p.inputText.substring(t,n),u=d.split(" ");if(u.length>3&&""===u[u.length-1]&&u.pop(),u.length>3){var m=u[0]+" "+u[1];return o=r("filter")(p.personProfileList,m).length,o>0?P("@"+m,m):(m=u[0],o=r("filter")(p.personProfileList,m).length,o>0?P("@"+m,m):(c=r("filter")(p.assetProfileList,u[0]).length,c>0&&P("@"+u[0],u[0]))),K=!1,void p.dismissPopup()}}p.typeAheadListPos=0,l.cancel(Y),Y=l(function(){return 0===W.length||0!==p.actualTypeAheadText.indexOf(W)||p.skipClientSideFiltering?(W=p.actualTypeAheadText,p.typeAheadText=p.actualTypeAheadText,void(p.showPopup&&"profile"===p.popupType&&(B&&(s.companySelectedByAgent=!1),s.getListOfPersons(W,Z).then(M),f.skipAssetSearchInSmartRecorder||s.getListOfAssets(W,X).then(V)))):(te>Z&&(W=p.actualTypeAheadText,p.typeAheadText=p.actualTypeAheadText,p.showPopup&&"profile"===p.popupType&&(B&&(s.companySelectedByAgent=!1),s.getListOfPersons(W,Z).then(M))),void(ee>X&&(W=p.actualTypeAheadText,p.typeAheadText=p.actualTypeAheadText,p.showPopup&&"profile"===p.popupType&&s.getListOfAssets(W,X).then(V))))},500)}else p.actualTypeAheadText.length<3&&(p.personProfileList=[],p.assetProfileList=[],p.typeAheadListPos=0,p.personProfileListFilteredLength=0,p.assetProfileListFilteredLength=0,p.typeAheadText="",p.showPopupHeader=!1,p.actualTypeAheadText="",W="",ee=0,te=0);else if(0===p.inputText.length)p.dismissPopup();else if(p.customerName){l.cancel(z);var g=p.inputText.trim().replace(""," ").split(" ").length-p.customerName.split(" ").length;g>0&&(g%J===0?p.smartSearch():z=l(function(){K===!1&&p.smartSearch()},Q))}},p.handleSmartInputEnter=function(){if(p.showPopup===!0)if(p.typeAheadListPos<p.personProfileListFilteredLength&&p.personProfileListFilteredLength>0){var e=r("filter")(p.personProfileList,p.typeAheadText),t=e[p.typeAheadListPos];"profile"===p.popupType?p.profileSelected(t,"person",t.fullName,t.id,"customer","common.label.customer"):p.templateSelected(t,"incidentTemplate")}else if(p.typeAheadListPos>=p.personProfileListFilteredLength&&p.assetProfileListFilteredLength>0){var a=r("filter")(p.assetProfileList,p.typeAheadText),n=a[p.typeAheadListPos-p.personProfileListFilteredLength];"profile"===p.popupType?p.profileSelected(n,"asset",n.name,n.reconciliationId,"affectedasset","common.label.asset"):p.templateSelected(n,"servicerequestTemplate")}},p.handleSmartInputHighlightSelected=function(e){if(!K){j=!0,p.showPopup&&p.dismissPopup();var t=e.currentTarget.firstChild.data;ae=e.currentTarget,p.selectedText=t,p.personProfileList=[],p.assetProfileList=[],p.showPopup=!0,s.getListOfPersons(t).then(M),f.skipAssetSearchInSmartRecorder||s.getListOfAssets(t).then(V)}},p.profileSelected=function(e,t,a,n){K?(p.selectedText="@"+p.actualTypeAheadText,w(p.selectedText,e,t,a,n),K=!1):ae&&L(ae,e,t,a,n),p.dismissPopup()},p.dismissPopup=function(){j||K||(p.showPopup=!1,p.personProfileList=[],p.assetProfileList=[],p.typeAheadText="",p.typeAheadListPos=0,p.personProfileListFilteredLength=0,p.assetProfileListFilteredLength=0,p.showPopupHeader=!1,W="",ee=0,te=0)},p.personProfileMouseover=function(e){p.typeAheadListPos=e},p.assetProfileMouseover=function(e){p.typeAheadListPos=p.personProfileListFilteredLength+e},p.$on(i.HIDE_TICKET_DRAFT_LOADER,F)}}}])}(),function(){angular.module("feedModule").directive("feedItemEventMessageRenderer",["l10nModel","i18nService","metadataModel","$compile","$filter","approvalService","approvalModel","$sce","utilityFunctions","pwaModel","configurationModel",function(e,t,a,n,i,o,r,s,l,c,d){var u='<a ux-id href="{entityLink}">{displayValue}</a>',p="<span>{displayValue}</span>",m='<a aria-haspopup="true" target="_blank" href="{entityLink}">{displayValue}</a>',f='<a href="{entityLink}" tooltip-trigger="\'outsideClick\'" tooltip-placement="bottom" tooltip-append-to-body="true" tooltip-popup-delay="1" uib-tooltip-html="tooltipHtml">{displayValue}</a>',g=t.getLocalizedString("email.tooltip.headerText"),h='<a href="{entityLink}" aria-label="{displayValue} '+g+'"tooltip-trigger="\'outsideClick\'" tooltip-placement="bottom" tooltip-append-to-body="true" tooltip-popup-delay="1" uib-tooltip-html="tooltipHtml">{displayValue}</a>',y=function(e,a,n,o){switch(e.type){case EntityVO.TYPE_PERSON:case EntityVO.TYPE_INCIDENT:case EntityVO.TYPE_CHANGE:case EntityVO.TYPE_WORKORDER:case EntityVO.TYPE_SERVICEREQUEST:case EntityVO.TYPE_PROBLEM:case EntityVO.TYPE_KNOWNERROR:case EntityVO.TYPE_KNOWLEDGE:case EntityVO.TYPE_RELEASE:case EntityVO.TYPE_ACTIVITY:case EntityVO.TYPE_TASK:case EntityVO.TYPE_EMAIL_LINK:return o?p:u;case EntityVO.TYPE_ASSET:return u;case EntityVO.TYPE_URL:return m;case EntityVO.TYPE_INTEGER:return"change-collision"===a.eventType?(e.entityLink="#/"+n.type+"/"+n.id+"/collisions",u):a.eventType===EventVO.prototype.EMAIL?h:f;case EntityVO.TYPE_PRIORITY:case EntityVO.TYPE_STATUS:case EntityVO.TYPE_MILESTONE:case EntityVO.TYPE_STATUS_REASON:return e.type===EntityVO.TYPE_STATUS&&a.messageId<=51350&&a.messageId>=51300?'"'+(e.displayValue?e.displayValue.trim():"")+'"':'"'+i("localizeLabel")(e.displayValue,e.type,n.type)+'"';case EntityVO.TYPE_OUTAGE_TYPE:return t.getLocalizedString("create.outage.type."+e.displayValue.replace(/\s+/g,".").toLowerCase());case EntityVO.TYPE_TEXT:return e.displayValue&&(e.displayValue=l.escapeHTML(e.displayValue)),e.displayValue;case EntityVO.TYPE_TIME:return moment.duration(1e3*+e.displayValue-a.createDate.getTime()).humanize();case EntityVO.TYPE_TIMESTAMP:return moment(+e.displayValue).calendar({sameElse:"lll"});default:return e.displayValue}};return{restrict:"E",replace:!0,scope:{event:"=",relatedObject:"=",parentContext:"=",isUpdateFeed:"=",isAppEnabled:"=?"},template:'<div><div loading-spinner if="loadingApprovalDialog" overlay="true" inline="true"></div></div>',link:function(u,p){function m(){var a=EntityVO.prototype.getProps().concat("entityLink"),o=f.entities.map(function(e,t){var n=_.includes(f.eventType,"create")&&!E&&"person"!==e.type,i=y(e,f,h,n);return"person"==e.type&&e.displayValue&&(e.displayValue=l.escapeHTML(e.displayValue)),a.forEach(function(t){c.isPwaEnabled()&&d.get("pwaEnabledTickets.tickets").indexOf(e.type)>=0&&"entityLink"===t?(e[t]=e[t]&&e[t].replace(e.type,e.type+"PV"),i=i.toString().replace(new RegExp("{"+t+"}","g"),e[t])):i=i.toString().replace(new RegExp("{"+t+"}","g"),e[t])}),i=i.toString().replace(new RegExp("ux-id","g"),'ux-id="event-msg-profile-link_'+e.type+'"'),"person"==e.type?s.getTrustedHtml(i).replace(new RegExp("<a","g"),'<a ux-id="event-msg-profile-link_'+e.type+'"'):f.eventType===EventVO.prototype.VENDOR_NOTE_V2?"url"===e.type?s.getTrustedHtml(i):2===t?encodeURI(i).replace(/%20/g," "):i:i});if(f.recipients.length>0){var r=f.recipients.map(function(e){var t=y(e,f,h);return a.forEach(function(a){t=t.toString().replace(new RegExp("{"+a+"}","g"),e[a]),"displayValue"==a&&s.getTrustedHtml(t)}),t});u.tooltipHtml="<div>"+g+":</div><div>",_.forEach(r,function(e,t){u.tooltipHtml+=e+(t===r.length-1?"":", ")}),u.tooltipHtml+="</div>"}var m=e.getLocalizedMessage(f.messageId)?e.getLocalizedMessage(f.messageId).value:f.labelTemplate;f.messageId<=51350&&f.messageId>=51300&&(m=m.replaceAll("#newline#","\n"),o=o.map(Function.prototype.call,String.prototype.trim));var v=i("i18n")(m,o);if(f.isSlaChange()||f.isSlaMet()){var T=v.indexOf(":")+1,S=v.substr(0,T);v=v.replace(S,'<span class="system-event-message__'+f.eventType+'">'+S+"</span>")}var C;C=f.messageId<=65007&&f.messageId>=65002||f.messageId>=61002&&f.messageId<=61004||f.messageId>=66018&&f.messageId<=66020||f.messageId<=51350&&f.messageId>=51300?'<div class="feed__item-format">'+v+"</div>":"<div>"+v+"</div>",!(f.messageId<=65007&&f.messageId>=65002||f.messageId>=61002&&f.messageId<=61004)||u.isUpdateFeed||u.parentContext&&u.parentContext instanceof PersonProfileVO||(C+=65002==f.messageId?"<button class='btn_link' ng-click='showApprovers(true)'>":"<button class='btn_link' ng-click='showApprovers(false)'>",C+=t.getLocalizedString("approval.approversList.labels.showList")+"</div>"),p.append(n(C)(u))}var f=u.event,h=u.relatedObject,E=u.isAppEnabled;if(u.tooltipHtml="",u.loadingApprovalDialog=!1,u.showApprovers=function(e){u.loadingApprovalDialog=!0,r.getListOfApprovers(h).then(function(t){o.showApproversDialog(t.approvalList,u.parentContext,e)})["finally"](function(){u.loadingApprovalDialog=!1})},f){var v=_.findIndex(f.entities,function(e){return e.type===EntityVO.TYPE_PRIORITY||e.type===EntityVO.TYPE_STATUS});if(v!==-1){var T=[h.type];h.type!==EntityVO.TYPE_TASK&&T.push(EntityVO.TYPE_TASK),a.getMetadataByTypes(T).then(function(){m()})}else m()}else console.log("No information about system event.")}}}])}(),FeedItemVO.prototype=Object.create(BaseVO.prototype),FeedItemVO.prototype.constructor=FeedItemVO,FeedItemVO.prototype.TYPE_SYSTEM="system",FeedItemVO.prototype.TYPE_COMMENT="comment",FeedItemVO.prototype.TYPE_OUTAGE="outage",FeedItemVO.prototype.TYPE_BROADCAST="broadcast",FeedItemVO.WORK_INFO_TYPES={},FeedItemVO.WORK_INFO_TYPES[EntityVO.TYPE_INCIDENT]=16e3,FeedItemVO.WORK_INFO_TYPES[EntityVO.TYPE_TASK]=16e3,FeedItemVO.WORK_INFO_TYPES[EntityVO.TYPE_WORKORDER]=31e3,FeedItemVO.WORK_INFO_TYPES[EntityVO.TYPE_CHANGE]=31e3,FeedItemVO.WORK_INFO_TYPES[EntityVO.TYPE_RELEASE]=31e3,FeedItemVO.WORK_INFO_TYPES[EntityVO.TYPE_ACTIVITY]=31e3,FeedItemVO.prototype.getProps=function(){return BaseVO.prototype.getProps().concat("type","priority","isSystemGenerated","author","relatedObject","event","note","attachments","attachmentCount")},FeedItemVO.prototype.isSystemUpdate=function(){return this.type===FeedItemVO.prototype.TYPE_SYSTEM},FeedItemVO.prototype.isOutage=function(){return this.type===FeedItemVO.prototype.TYPE_OUTAGE},FeedItemVO.prototype.isBroadcast=function(){return this.type===FeedItemVO.prototype.TYPE_BROADCAST},FeedItemVO.prototype.isKnowledge=function(){return this.relatedObject&&this.relatedObject.type===EntityVO.TYPE_KNOWLEDGE},FeedItemVO.prototype.isComment=function(){return this.type===FeedItemVO.prototype.TYPE_COMMENT},FeedItemVO.prototype.isVendorComment=function(){return this.event.eventType===EventVO.prototype.VENDOR_NOTE||this.event.eventType===EventVO.prototype.VENDOR_NOTE_V2},FeedItemVO.prototype.isServiceHealthStatusActivity=function(){return this.event.eventType===EventVO.prototype.SERVICE_HEALTH_STATUS},FeedItemVO.prototype.isUnflaggingResponse=function(){return this.event.eventType===EventVO.prototype.UNFLAG},FeedItemVO.prototype.isMyITComment=function(){return this.type===FeedItemVO.prototype.TYPE_COMMENT&&this.note&&!!this.note.conversationRefId},FeedItemVO.prototype.isEmail=function(){return this.event.eventType===EventVO.prototype.EMAIL||this.event.eventType===EventVO.prototype.RICH_EMAIL},FeedItemVO.prototype.isFlag=function(){return this.event.eventType===EventVO.prototype.FLAG},FeedItemVO.prototype.isUnFlag=function(){return this.event.eventType===EventVO.prototype.UNFLAG},FeedItemVO.prototype.isNeedsAttentionFlag=function(){return this.event.eventType===EventVO.prototype.NEEDS_ATTENTION_FLAG},FeedItemVO.prototype.isNeedsAttentionUnFlag=function(){return this.event.eventType===EventVO.prototype.NEEDS_ATTENTION_UNFLAG},FeedItemVO.prototype.isSlaChange=function(){return this.isSystemUpdate()&&this.event.isSlaChange()},FeedItemVO.prototype.isApprovalReject=function(){return this.isSystemUpdate()&&"approval-reject-event"===this.event.eventType},FeedItemVO.prototype.isApprovalHold=function(){return this.isSystemUpdate()&&"approval-hold-event"===this.event.eventType},FeedItemVO.prototype.isApprovalAccept=function(){return this.isSystemUpdate()&&"approval-accept-event"===this.event.eventType},FeedItemVO.prototype.isRelationshipChange=function(){return this.event.eventType===EventVO.prototype.RELATED_CHANGE||this.event.eventType===EventVO.prototype.UNRELATED_CHANGE},FeedItemVO.prototype.isLocationChange=function(){return this.event.eventType===EventVO.prototype.LOCATION_CHANGE},FeedItemVO.prototype.isOwnerChange=function(){return this.event.eventType===EventVO.prototype.OWNERSHIP_CHANGE},FeedItemVO.prototype.isSharedWithVendor=function(){return this.note&&(this.note.shareWithVendor||_.isString(this.note.vendorTicketId)&&this.note.vendorTicketId.length>0)},FeedItemVO.prototype.iconFunction=function(){var e,t=this.relatedObject&&this.relatedObject.type||"";switch(t){case EntityVO.TYPE_INCIDENT:case EntityVO.TYPE_WORKORDER:case EntityVO.TYPE_PROBLEM:switch(e="icon-"+t,this.event.eventType){case EventVO.prototype.VENDOR_CREATE:case EventVO.prototype.VENDOR_CREATE_V2:case EventVO.prototype.VENDOR_CREATE_ITSM_TICKET:e+="-brokered";break;case EventVO.prototype.VENDOR_NOTE:case EventVO.prototype.VENDOR_NOTE_V2:case EventVO.prototype.VENDOR_STATUS_CHANGE:case EventVO.prototype.VENDOR_STATUS_CHANGE_V2:e="icon-cloud_user";break;case EventVO.prototype.TASK_RELATION:this.event.classId===EventVO.prototype.TASK_AUTOMATIC?e="icon-file_task_auto":this.event.classId===EventVO.prototype.TASK_MANUAL&&(e="icon-file_task_o")}"51248"===this.event.messageId&&(e="feed-item__cognitive-recommendation");break;case EntityVO.TYPE_CHANGE:if("Automation System"===this.event.classId)e="icon-files_change_auto";else if("Automatic"===this.event.classId)e="icon-file_task_auto";else if("Manual"===this.event.classId)e="icon-file_task_o";else switch(e="icon-"+t,this.event.eventType){case EventVO.prototype.VENDOR_CREATE:case EventVO.prototype.VENDOR_CREATE_V2:case EventVO.prototype.VENDOR_CREATE_ITSM_TICKET:e+="-brokered";break;case EventVO.prototype.VENDOR_NOTE:case EventVO.prototype.VENDOR_NOTE_V2:case EventVO.prototype.VENDOR_STATUS_CHANGE:case EventVO.prototype.VENDOR_STATUS_CHANGE_V2:e="icon-cloud_user"}break;case EntityVO.TYPE_TASK:e="Automatic"===this.event.classId?"icon-file_task_auto":"icon-task";break;case EntityVO.TYPE_KNOWLEDGE:e="RKM:DecisionTreeTemplate"===this.event.classId?"icon-decision-tree":"icon-knowledge";break;case EntityVO.TYPE_ASSET:case EntityVO.TYPE_SERVICEREQUEST:case EntityVO.TYPE_RELEASE:case EntityVO.TYPE_ACTIVITY:e="icon-"+t;break;case EntityVO.TYPE_KNOWNERROR:if(this.event.classId===EventVO.prototype.TASK_AUTOMATIC)e="icon-file_task_auto";else if(this.event.classId===EventVO.prototype.TASK_MANUAL)e="icon-file_task_o";else switch(e="icon-"+t,this.event.eventType){case EventVO.prototype.VENDOR_CREATE:case EventVO.prototype.VENDOR_CREATE_V2:case EventVO.prototype.VENDOR_CREATE_ITSM_TICKET:e+="-brokered";break;case EventVO.prototype.VENDOR_NOTE:case EventVO.prototype.VENDOR_NOTE_V2:case EventVO.prototype.VENDOR_STATUS_CHANGE:case EventVO.prototype.VENDOR_STATUS_CHANGE_V2:e="icon-cloud_user"}break;default:e=""}return this.isBroadcast()&&(e="icon-speaker"),this.isSlaChange()&&(e="icon-exclamation_triangle"),this.isApprovalHold()&&(e="icon-sandglass"),this.isApprovalReject()&&(e="icon-cross_square"),this.isApprovalAccept()&&(e="icon-check_shield"),this.isRelationshipChange()&&(e="icon-link"),this.isLocationChange()&&(e="icon-mapmarker"),e},FeedItemVO.prototype.hasAttachments=function(){return(this.isComment()||this.isVendorComment()||this.isBroadcast())&&this.note.attachmentCount>0},FeedItemVO.prototype.hasComments=function(){return this.isComment()&&this.note.commentCount>0},FeedItemVO.prototype.hasReplies=function(){return this.replies&&this.note.repliesCount>0},FeedItemVO.prototype.hasUnflaggingResponse=function(){for(var e in this.replies)if(this.replies[e].isUnflaggingResponse())return!0;return!1},FeedItemVO.prototype.toggle=function(){this.expanded=!this.expanded},FeedItemVO.prototype.toggleRepliesView=function(){this.repliesExpanded=!this.repliesExpanded},FeedItemVO.prototype.postBuild=function(){if(this.author=(new UserVO).build(this.author),this.relatedObject=(new RelatedObjectVO).build(this.relatedObject),this.event=(new EventVO).build(this.event),this.event.createDate=new Date(this.createDate),this.createDateLabel=moment(this.createDate).fromNow(),this.relatedObject.type===EntityVO.SOCIAL_PROFILE_USER&&(this.relatedObject.type=EntityVO.TYPE_PERSON),this.isOutage()&&(this.title=this.event.title,this.startDate=this.event.startDateHumanized,this.endDate=this.event.endDateHumanized),this.isBroadcast()&&(this.title=this.event.summary,this.summary=this.event.description,this.startDate=this.event.startDateHumanized,this.endDate=this.event.endDateHumanized,this.isBroadcastPriorityHigh="High"===this.event.priority,this.note={},this.note.attachmentCount=this.attachmentCount,this.note.attachments=this.attachments),(this.isComment()||this.isVendorComment())&&(this.title=this.author.getFullName(),this.message=this.note.message||""),this.relatedObject.isAsset()&&(this.relatedObject.id=this.relatedObject.displayId,this.relatedObject.showHeader=!1),this.isMyITComment()){var e=new RegExp("\\@\\[("+this.relatedObject.title+")\\]\\|("+this.relatedObject.id+")\\|\\((asset)\\)$","gi");this.message=this.message.replace(e,"");var t=/@\[(.*?)]\|(.*?)\|\(asset\)/gi;this.message=this.message.replace(t,function(e,t,a){return"@["+t+"]|"+a+"#POI|(asset)"}),this.note.myItLink="../myitapp/#/activity-item/"+this.note.conversationRefId,this.relatedObject=null}},function(){angular.module("feedModule").factory("feedModel",["feedService","$q","attachmentService","metadataModel","systemAlertService","$filter","ticketModel",function(e,t,a,n,i,o,r){var s,l={pendingWorkNote:null},c=!1,d={filters:{},params:{searchQuery:"",followCount:!0,limit:20}},u={filters:{},params:{searchQuery:"",limit:20}},p=function(e,t,a){var n={};return _.forEach(e.filters,function(e,t){n[t]=e.join(",")}),e.params.searchQuery||(e.params.searchQuery=void 0),a&&a.poiId?e.params.poiId=a.poiId:e.params.poiId=null,angular.extend({},n,t,e.params)};return l.updateFeed=d,l.activityFeed=u,l.workinfoTypeFilters={},l.getUpdateFeedItems=function(t){return c&&(d.filters={}),e.getUpdateFeedItems(p(d,t))},l.buildFeedFilter=function(e,t){var a=[];e.filters={},s=0,_.forEach(t,function(t){t.selected&&(s++,a=_.isArray(t.criteria)?t.criteria:[t.criteria],_.forEach(a,function(t){e.filters[t.name]?e.filters[t.name]=_.union(e.filters[t.name],t.value):e.filters[t.name]=t.value}))}),c=s===t.length},l.getActivityFeedItems=function(t,a){if(t.id&&t.type)return e.getActivityFeedItems(t,p(u,a,t))},l.saveNote=function(t,n){var s,l;if(n.addFlagNote){if(n.isNeedAttentionFlag)return s={needsAttention:n.flag?"Yes":"No",worknote:(n.flag?"Needs Attention Flagged: ":"Needs Attention Unflagged: ")+n.noteText},r.update(t.id,t.type,s);s={flagNote:n.noteText,flagged:n.flag,workInfoType:n.workInfoType},_.isUndefined(n.workNoteGuid)||(s.isCommentOnly=n.isCommentOnly,s.workNoteGuid=n.workNoteGuid)}else s=n.worknote?n:{worknote:n.noteText,access:n.access,workInfoType:n.workInfoType,chatSessionId:n.chatSessionId};return n.brokerVendorName&&(n.shareWithVendor&&(s.shareWithVendor=!0),n.vendorTicketId&&(s.vendorTicketId=n.vendorTicketId),s.brokerVendorName=n.brokerVendorName),n.addFlagNote?e.addActivityFeedWorknoteWithFlag(t,s):n.attachments&&n.attachments.length?(l=a.addWorknoteWithAttachment(t,n),l["catch"](function(e){i.error({text:e&&e.data&&(e.data.defaultMessage||e.data.detailMessage||e.data.error)||e,clear:!1})}),l):(l=e.addActivityFeedWorknote(t,s),l.then(function(e){n.articleId&&"pdf"===n.attachmentType&&i.success({text:e[0].items[0].statusInfo.message,clear:!0,hide:1e4})})["catch"](function(e){e&&i.error({text:e.data&&e.data.error||o("i18n")("error.unknown"),clear:!1})}),l)},l.saveNoteBulk=function(t){return t.attachments&&t.attachments.length?a.addWorknoteWithAttachmentBulk(t):e.addActivityFeedWorknoteBulk(t)},l.processPendingWorkNote=function(e){if(l.pendingWorkNote){console.log("saving pending note..");var t={type:e.type,id:e.id};return l.saveNote(t,l.pendingWorkNote).then(function(){console.log("pending note saved"),l.pendingWorkNote=null})["catch"](function(e){i.error({text:e.data.error,clear:!1,displayOnStateChange:!0})})}},l.getWorkinfoTypeFilters=function(e){return l.workinfoTypeFilters[e]||!EntityVO.hasMetadata(e)?t.when(l.workinfoTypeFilters[e]||[]):(l.workinfoTypeFilters[e]=[],n.getMetadataByType(e).then(function(t){var a=_.filter(t.workinfoTypes,{type:"option"});return _.forEach(a,function(t){l.workinfoTypeFilters[e].push({name:t.name,label:t.label,type:"showWorkinfoTypes",criteria:[{name:"workNoteTypeId",value:[t.index]},{name:"filterType",value:["comment"]}]})}),l.workinfoTypeFilters[e]||[]}))},l.unpinFeedItem=function(t){var a={type:t.type,id:t.id};return e.unpinFeedItem(a).then(function(){})["catch"](function(){i.error({text:o("i18n")("feed.unpin.error"),clear:!1})})},l}])}(),function(){angular.module("feedModule").service("feedService",["$resource","events",function(e,t){var a=e("",{},{getUpdateFeedItems:{url:"/smartit/rest/v2/following/stream",method:"GET",isArray:!0},getActivityFeedItems:{url:"/smartit/rest/timeline/:type/:id",method:"GET",isArray:!0},addActivityFeedWorknote:{url:"/smartit/rest/:type/worknote/:id",method:"PUT",isArray:!0},addActivityFeedWorknoteBulk:{url:"/smartit/rest/ticket/worknote/bulk",method:"POST",isArray:!0},addActivityFeedWorknoteWithFlag:{url:"/smartit/rest/:type/flagUpdate/:id",method:"PUT",isArray:!0},unpinFeedItem:{url:"/smartit/rest/subscription/unpin/:type/:id",method:"POST",isArray:!1}});this.getUpdateFeedItems=function(e){return a.getUpdateFeedItems(e).$promise.then(function(e){var a={};return a.items=e[0].items.map(function(e){var a=(new FeedItemVO).build(e);return a.hasAttachments()&&(a.attachments=a.note.attachments.map(function(e){
return(new AttachmentVO).build(e)})),a.isFlag()&&(a.note.repliesCount=e.note.repliesCount,a.note.multipleReplies=a.note.repliesCount>1,a.replies=e.replies),a.isFlag()&&a.hasReplies()&&(a.replies=a.replies.map(function(e){return e.createDateLabel=moment(e.createDate).fromNow(),e.event&&e.eventType===t.KA_UNFLAGGED&&(a.threadUnflagged=!0),(new FeedItemVO).build(e)})),a}),e[0].followCount&&(a.followCount=e[0].followCount),a.syncTime=e[0].syncTime,a})},this.getActivityFeedItems=function(e,n){return a.getActivityFeedItems(angular.extend({},e,n)).$promise.then(function(e){var a;return a=e[0].timeline&&"UNAUTHORIZED"===e[0].timeline?{isNotAuthorized:!0}:e[0].items.map(function(e){var a=(new FeedItemVO).build(e);return a.hasAttachments()&&(a.attachments=a.note.attachments.map(function(e){return(new AttachmentVO).build(e)})),a.isFlag()&&(a.note.repliesCount=e.note.repliesCount,a.note.multipleReplies=a.note.repliesCount>1,a.replies=e.replies),a.isFlag()&&a.hasReplies()&&(a.replies=a.replies.map(function(e){return e.createDateLabel=moment(e.createDate).fromNow(),e.event&&e.eventType===t.KA_UNFLAGGED&&(a.threadUnflagged=!0),(new FeedItemVO).build(e)})),a.hasComments()&&a.comments&&(a.comments=a.comments.map(function(e){return(new CommentVO).build(e)})),a}),a||[]})},this.addActivityFeedWorknote=function(e,t){return a.addActivityFeedWorknote(e,t).$promise},this.addActivityFeedWorknoteBulk=function(e){return a.addActivityFeedWorknoteBulk(e).$promise},this.addActivityFeedWorknoteWithFlag=function(e,t){return a.addActivityFeedWorknoteWithFlag(e,t).$promise},this.unpinFeedItem=function(e){return a.unpinFeedItem(e,{}).$promise}}])}(),function(){angular.module("myitsmApp").filter("mention",["$filter","$sce","utilityFunctions",function(e,t,a){return function(n,i){var o=/@\[(.*?)]\|(.*?)\|\((user|asset|url)\)/g,r=[];if(n&&n.length<2e3){n=n.replace(o,function(e){return r.push(e)," SMT_MENTION_["+(r.length-1)+"]"}).trimLeft(),i||(n=e("securelinky")(n,"_blank")),_.forEach(r,function(e,t){n=n.replace("SMT_MENTION_["+t+"]",e)});var s=0;n=n.replace(o,function(e,n,i,o){var r=[],l="";if(o="user"===o?EntityVO.TYPE_PERSON:o,o===EntityVO.TYPE_ASSET){var c=i.indexOf("*");r.push(i.substr(0,c)),r.push(i.substr(c+1))}else r.push(i);return l=o===EntityVO.TYPE_URL?'<a ux-id="mention_'+s+'" class="activity-item__text-link" aria-haspopup="true" target="_blank" href="'+i+'">'+t.getTrustedHtml(a.escapeHTML(n))+"</a>":'<a ux-id="mention_'+s+'" class="activity-item__text-link" href="#/'+o+"/"+encodeURIComponent(r.join("/"))+'">'+t.getTrustedHtml(a.escapeHTML(n))+"</a>"}),n=n.replace(/\n/g,"<br />")}else n=$("<div/>").text(n).html();return n}}])}(),RelatedObjectVO.prototype=Object.create(BaseVO.prototype),RelatedObjectVO.prototype.constructor=RelatedObjectVO,RelatedObjectVO.prototype.getProps=function(){return BaseVO.prototype.getProps().concat("displayId","type","title","classId","eventType")},RelatedObjectVO.prototype.isAsset=function(){return this.type===EntityVO.TYPE_ASSET},RelatedObjectVO.prototype.postBuild=function(){this.isAsset()&&(this.entityLink="#/"+this.type+"/"+this.displayId+"/"+this.classId)},function(){angular.module("feedModule").controller("UpdateFeedController",["$scope","$filter","feedModel","metadataModel","configurationModel","$interval","$window","attachmentService","userModel","updateFeedFiltersVisibilityValidatorService","events",function(e,t,a,n,i,o,r,s,l,c,d){function u(){p=n.cache&&n.cache.global&&n.cache.global.configurationParameters&&n.cache.global.configurationParameters.feedRefreshInterval?1e3*parseInt(n.cache.global.configurationParameters.feedRefreshInterval):6e5,m=o(e.getNewUpdateFeedItems,p)}var p,m,f={space:32},g=!0,h=[];e.feedModel=a,e.followCount=null,e.filters=_.filter(i.get("feed").update.filter,function(e){return!(!_.isUndefined(e.display)&&!c[e.display]())&&(e.localizedLabel=t("i18n")("feed.filter.optionName."+e.label),!0)}),e.filters=_.sortBy(e.filters,"localizedLabel"),n.getMetadataByType("global").then(function(t){i.comaroundEnabled&&_.remove(e.filters,{name:"knowledgeArticleUpdates"}),e.displayEncodedCharacters=!(!t||!t.configurationParameters||"true"!==t.configurationParameters.displayEncodedCharacters)}),e.pendingFilterUpdate=!1,e.userModel={isAccessibleUser:l.isAccessibleUser},e.filterMenuToggled=function(t){!t&&e.pendingFilterUpdate&&(_.each(e.filters,function(e){var t=_.find(h,{name:e.name});e.selected=!_.isUndefined(t)}),e.pendingFilterUpdate=!1)};var y="",E=[],v={loadingFeeds:!0,loadingMoreFeeds:!1,allFeedsLoaded:!1},T={last:{}},S=function(){v.allFeedsLoaded=!1,E.length=0},C=function(e){return a.getUpdateFeedItems(e||{}).then(function(e){O(e)})},O=function(t){_.isEmpty(t.items)?v.allFeedsLoaded=!0:(Array.prototype.push.apply(E,t.items),T.last=_.last(t.items),y||(y=t.syncTime)),t.followCount&&(e.followCount=t.followCount),_.forEach(E,function(e){e.relatedObject&&e.relatedObject.type&&e.relatedObject.type!==EntityVO.TYPE_BROADCAST&&e.relatedObject.type!==EntityVO.TYPE_OUTAGE&&(e.relatedObject.type===EntityVO.TYPE_PERSON?e.isAppEnabled=!0:e.isAppEnabled=i.isServerApplicationEnabled(e.relatedObject.type))})},A=function(){E.length<12&&e.$broadcast(d.ELLIPSIS_EVENT)};e.getUpdateFeedItems=function(){S(),v.loadingFeeds=!0,C()["finally"](function(){A(),v.loadingFeeds=!1})},e.getNewUpdateFeedItems=function(){!v.loadingFeeds&&g&&(v.loadingFeeds=!0,a.getUpdateFeedItems({criteria:"gt,"+y}).then(function(e){_.isEmpty(e.items)||(y=e.syncTime,_.forEach(e.items.reverse(),function(e){e.relatedObject.type===EntityVO.TYPE_PERSON?e.isAppEnabled=!0:e.isAppEnabled=i.isServerApplicationEnabled(e.relatedObject.type),E.unshift(e)}),A())})["finally"](function(){v.loadingFeeds=!1}))},n.cache.global.configurationParameters?u():n.cache.global.then(function(){u()}),angular.element(r).bind("focus",function(){g=!0}).bind("blur",function(){g=!1}),e.loadMoreFeeds=function(){if(!v.loadingMoreFeeds&&!v.allFeedsLoaded&&!v.loadingFeeds){v.loadingMoreFeeds=!0;var e={criteria:"lt,"+T.last.createDate,priority:T.last.priority};C(e)["finally"](function(){A(),v.loadingMoreFeeds=!1})}},e.keyPressOnFilterItem=function(t,a){t&&t.keyCode===f.space&&(e.updateFilters(t,a),t.preventDefault(),t.stopPropagation())},e.updateFilters=function(t,a){t.preventDefault(),t.stopPropagation(),a&&(a.selected=!a.selected),e.pendingFilterUpdate=!0},e.applyFilter=function(t){t&&(t.selected=!t.selected),a.buildFeedFilter(a.updateFeed,e.filters),h=_.filter(e.filters,{selected:!0}),e.pendingFilterUpdate=!1,e.getUpdateFeedItems()},e.clearSearchText=function(){a.updateFeed.params.searchQuery=""};var I=e.$watch("feedModel.updateFeed.params.searchQuery",function(t,n){t?e.getUpdateFeedItemsDebounced():!t&&n&&(a.updateFeed.params.searchQuery="",e.getUpdateFeedItems())});e.getUpdateFeedItemsDebounced=_.debounce(e.getUpdateFeedItems,1e3),e.$on("$destroy",function(){o.cancel(m),a.updateFeed.params.searchQuery="",I()}),e.$watch(function(){return l.isAccessibleUser},function(t){e.userModel.isAccessibleUser=t}),e.handleAttachmentClick=function(e,t){v.loadingFeeds=!0,s.getAttachmentFile(e,t)["finally"](function(){v.loadingFeeds=!1})},e.handleUnpinClick=function(e){a.unpinFeedItem(e).then(function(){}),e.priority=0;var t;if(_.remove(E,function(t){return t.id===e.id}),e.createDate>T.last.createDate&&0===T.last.priority||E.length<20){for(t=0;t<E.length;t++)if(0===E[t].priority){if(e.createDate<E[t].createDate)continue;break}E.splice(t,0,e),T.last=angular.copy(E[E.length-1])}},e.state=v,e.feed=E,e.applyFilter({data:!0})}])}(),function(){angular.module("feedModule").service("updateFeedFiltersVisibilityValidatorService",["configurationModel","permissionModel","roles",function(e,t,a){this.isSLMEnabled=function(){return e.isServerApplicationEnabled(EntityVO.TYPE_SLM)},this.isKnowledgeOnlyUser=function(){return t.hasKnowledgeOnlyRole()},this.isNotKnowledgeOnlyUser=function(){return!t.hasKnowledgeOnlyRole()},this.hasKnowledgeOrChangePermission=function(){return t.hasRole(a.ITSM_KNOWLEDGE_USER_ROLE)||t.hasRole(a.ITSM_CHANGE_USER_ROLE)}}])}(),function(){angular.module("myitsmApp").factory("customFieldAreaLinkFunction",function(){return function(e){e.getVisibleFields=function(){if(e.editMode)return _.reject(e.fields,"groupMember");var t=_.filter(e.fields,function(e){return e.isVisible()&&!e.isGroupMember()&&!e.isWidgetMember()&&(e.ootb||e.required||angular.isDefined(e.value))});return t},e.hasVisibleFields=function(){var t=e.getVisibleFields();return t&&t.length>0},e.getDependantCustomFieldValue=function(t){var a=angular.noop();return _.find(e.fields,function(e){return e.name===t?a=e.value:e.linkedFieldExist()&&e.valueField===t&&(a=e.getLinkedValue()),!_.isUndefined(a)}),_.isUndefined(a)&&!e.editMode?e.ticket.customFields[t]:a},e.getFieldsListToShow=function(t){var a=e.getVisibleFields();return a.length>t&&_.filter(a,function(e){e.isRequired&&(t=e.displayOrder+1)}),!_.isUndefined(t)&&t>=0&&(a=a.slice(0,t)),a},e.isEditable=function(t){var a=t.isEditable(e.ticket.accessMappings);return void 0!==a&&a},e.showField=function(t){return!("z1D_Phase"===t.name&&!e.ticket.showPhaseSelector)}}}).directive("customFieldArea",["events","screenConfigurationModel","ticketModel","personModel","$q","customFieldAreaLinkFunction","objectValueMapperService",function(e,t,a,n,i,o,r){return{restrict:"E",replace:!0,scope:{panelId:"@",ticket:"=",metadata:"=",stacked:"=?",editMode:"=?",isNew:"=?",isDatesPanel:"=?",updateIsHandledByParent:"=",isTitleBar:"="},templateUrl:"views/field-customization/custom-field-area.html",link:function(s,l,c){function d(){var e=t.collectChanges(s.fields,s.ticket.customFields,s.ticket);return _.size(e)?{customFields:e}:{}}function u(e,a){if(a&&a.panelId&&c.panelId&&c.panelId===a.panelId){var n=t.getPanelById(c.panelId);n&&t.initFieldValues(s.fields,a.ticket||s.ticket,s.metadata)}}function p(){s.editMode=!s.editMode,s.isCollapsed=!1,s.visibleFields=s.getFieldsListToShow()}function m(){var t=d(),o=s.ticket.isDraft,r=!s.updateIsHandledByParent;if(s.$emit(e.SAVE_CHANGES_REQUEST,t,r||o),_.size(t)){var l=i.when(1);s.ticket.type?!o&&r&&(l=a.update(s.ticket.id,s.ticket.type,t)):l=n.updatePersonInfo(s.ticket.id,t),(r||o)&&l.then(f)["finally"](y)}else y()}function f(){var e=d();t.updateTicketData(s.ticket,e.customFields),s.isCollapsed=!0}function g(){s.updateIsHandledByParent&&!s.ticket.isDraft&&y()}function h(){s.updateIsHandledByParent&&!s.ticket.isDraft&&(_.forEach(s.fields,function(e){e.value=s.ticket.customFields[e.name]}),s.$broadcast(e.REFRESH_FIELD_VALUES),y())}function y(){s.updateIsHandledByParent&&!s.ticket.isDraft||s.$emit(e.SAVE_CHANGES_COMPLETE),s.editMode=!1}function E(){y()}function v(){_.forEach(s.fields,function(e){e.clearValue()}),t.initFieldValues(s.fields,s.ticket,s.metadata),s.$broadcast(e.REFRESH_FIELD_VALUES),s.editMode=!1,s.visibleFields=s.getFieldsListToShow()}function T(){s.$emit(e.FIELD_FORM_IS_DIRTY)}function S(a,n,i,o,l){if(O){if(C(s.fields,o,l)&&(t.initFieldValues(s.fields,n,s.metadata,!0),_.each(s.fields,function(t){var a=[];_.each(t.members,function(e){a.push(e.name)}),s.$emit(e.WIDGET_VALUE_CHANGE,{fieldName:t.name,memberName:a})})),n.type===EntityVO.TYPE_INCIDENT||n.type===EntityVO.TYPE_TASK||n.type===EntityVO.TYPE_CHANGE||n.type===EntityVO.TYPE_WORKORDER){var c=[],d=n.type===EntityVO.TYPE_INCIDENT?r.getFieldByName("assignee"):r.getFieldByName("assigneeName");if(d&&C([d],o,l)&&c.push(d),n.type===EntityVO.TYPE_WORKORDER||n.type===EntityVO.TYPE_CHANGE){var u=r.getFieldByName("managerName");u&&C([u],o,l)&&c.push(u)}c.length>0&&t.initFieldValues(c,n,s.metadata)}i&&s.$broadcast(e.AFTER_SAVED_CHANGES)}}function C(e,t,a){var n=!0;return t&&(t=t.indexOf("coordinator")!==-1?"coordinator":t.indexOf("manager")!==-1?"manager":"assignee",_.each(e,function(e){(e.isAssigneeWidget()||e.isSupportGroupWidget())&&(a?"assignee"!==t||"supportGroups"!==e.name&&e.name.toLowerCase().indexOf("assigned")===-1?"coordinator"===t&&e.name.indexOf("assignee")!==-1?n=!0:e.name.toLowerCase().indexOf(t)===-1&&(n=!1):n=!0:"assignee"!==t||"supportGroups"!==e.name&&e.name.toLowerCase().indexOf("assigned")===-1?s.ticket.type===EntityVO.TYPE_PROBLEM&&"coordinator"===t&&e.name.indexOf("assignee")!==-1?n=!0:(s.ticket.type!==EntityVO.TYPE_WORKORDER||"assignee"!==t&&"manager"!==t||e.name.toLowerCase().indexOf("assignee")===-1&&e.name.toLowerCase().indexOf("manager")===-1&&"supportGroups"!==e.name)&&("coordinator"!==t&&"manager"!==t||e.name.toLowerCase().indexOf("coordinator")===-1&&e.name.toLowerCase().indexOf("manager")===-1)?e.name.toLowerCase().indexOf(t)===-1&&(n=!1):n=!0:n=!0)})),n}var O=!1;s.state={isDataLoading:!1},s.$watch("ticket",function(){if(c.panelId&&s.ticket){s.state.isDataLoading=!0,s.ticket.ticketType=s.ticket.ticketType?s.ticket.ticketType:s.ticket.type;var a=s.isNew?"create."+s.ticket.ticketType:s.ticket.ticketType,n=t.getScreenNameByTicketType(a);t.loadScreenConfigurationAndCustomFieldLabels(n,s.ticket.ticketType).then(function(){var a=t.getPanelById(c.panelId),n=angular.copy(a&&a.fields)||[];"assetScreen.Type Specific"===c.panelId&&(n=_.filter(n,function(e){return _.includes(_.map(e.extension,"classId"),s.ticket.classId)}),n.length&&s.$emit(e.TS_CUSTOM_FIELDS_AVAILABLE,{typeSpecific:!0})),console.log(s.panelId+" init!"),t.initFieldValues(n,s.ticket,s.metadata)["finally"](function(){s.$emit(e.FIELD_AREA_ATTACHED,c.panelId.split(".")[0]),console.log(s.panelId+" Loaded!")}),s.isAdditionalInfoPanel=a&&"additionalInfo"===a.shortId,s.panel=a,s.fields=n,r.addFields(s.fields),O=s.fields.some(function(e){return e.isAssigneeWidget()||e.isSupportGroupWidget()}),s.hideLabelInTitleBar=!(!s.panel||"titleBarPanel"!==s.panel.name),s.stacked=void 0===s.stacked||s.stacked,s.visibleFields=s.getFieldsListToShow(),s.fieldActionMapping=r.getFieldActionMapping(s.ticket.ticketType),s.fieldActionMapping||EntityVO.ENTITIES_WITH_NEW_CUSTOMIZATION.indexOf(s.ticket.ticketType)!==-1&&t.loadActionsNew(s.ticket.ticketType).then(function(){s.actionLists=t.actionList,s.fieldActionMapping={};for(var e in s.actionLists)if(s.actionLists[e].mappedFields&&s.actionLists[e].mappedFields.length>0){var a=s.actionLists[e].mappedFields,n=_.uniqBy(a,function(e){return e.fieldName});for(var i in n)s.fieldActionMapping[n[i].fieldName]={action:s.actionLists[e],iconName:n[i].iconName}}r.setFieldActionMapping(s.fieldActionMapping,s.ticket.ticketType)})})["finally"](function(){s.state.isDataLoading=!1})}else console.log("'panel-id' attribute is missing.")}),s.isCollapsed=!0,s.fieldsCountToShow=5,o(s),s.$watch("isCollapsed && stacked",function(){s.visibleFields=s.getFieldsListToShow()}),s.$on(e.REFRESH_FIELD_VALUES,u),s.$on(e.TOGGLE_EDIT_MODE,p),s.$on(e.AFTER_SAVED_CHANGES,E),s.$on(e.SAVE_CHANGES,m),s.$on(e.SAVE_ALL_CHANGES_COMPLETE,g),s.$on(e.SAVE_ALL_CHANGES_FAULT,h),s.$on(e.DISCARD_CHANGES,v),s.$on(e.FIELD_VALUE_CHANGE,T),s.$on(e.TICKET_ASSIGNEES_UPDATED,S)}}}])}(),function(){angular.module("myitsmApp").directive("customFieldContainer",["events","customFieldAreaLinkFunction","screenConfigurationModel",function(e,t,a){return{restrict:"E",replace:!0,scope:{fields:"=",ticket:"=",stacked:"=",isNew:"=?"},templateUrl:"views/field-customization/custom-field-area.html",link:function(n){function i(t,a){r(a.name,a.getValue()),a.valueField&&r(a.valueField,a.getLinkedValue()),n.$emit(e.FIELD_FORM_IS_DIRTY)}function o(){_.forEach(n.fields,function(e){e.clearValue()})}function r(e,t){n.ticket.customFields[e]=t}var s;n.editMode=!0,n.fieldsCountToShow=5,n.ticket.type===EntityVO.TYPE_ASSET&&(s=n.$watch("fields",function(){n.visibleFields=n.getFieldsListToShow()}),n.$on("$destroy",function(){s()})),t(n),n.visibleFields=n.getFieldsListToShow(),n.ticket.customFields&&_.forEach(n.fields,function(e){e.value=n.ticket.customFields[e.name]}),n.$watch("ticket.customFields",function(t){t&&_.isObject(t&&n.fields)&&(a.initFieldValues(n.fields,n.ticket),n.$broadcast(e.REFRESH_FIELD_VALUES))}),n.isEditable=function(e){return n.ticket.accessMappings?e.isEditable(n.ticket.accessMappings):!e.isReadOnly},n.$on(e.FIELD_VALUE_CHANGE,i),n.$on(e.DISCARD_CHANGES,o)}}}])}(),function(){$.widget("ui.numericSpinner",$.ui.spinner,{_format:function(e){return e.toFixed(this._precision())}}),angular.module("myitsmApp").factory("customFieldLinkFunction",["events",function(e){return function(t){t.showMeridian=window.showMeridian,t.onFieldValueChange=function(a){a=a||t.data,a.hasValue=!0,t.$parent.$emit(e.FIELD_VALUE_CHANGE,a)}}}]).filter("customFieldLabelI18n",["screenConfigurationModel",function(e){return function(t,a){var n;t.extension&&t.extension.length>0&&t.extension[0].classId&&(n=t.extension[0].classId);var i=e.getLocalizedFieldByNameForTicketType(t.name,a,n);return i&&i.label?i.label:t.label}}]).directive("customFieldLabel",function(){return{restrict:"E",replace:!0,template:'<label ux-id="field-label" id="{{data.name + \'Label\'}}" class="label__text label_control-wrap" ng-class="{\'required__label\': data.isRequired && ($parent.$parent.editMode || $parent.$parent.$parent.editMode)}" data-required="{{\'common.label.required.bracketed\' | i18n}}" ng-hide="hideLabel()" aria-label="{{ data | customFieldLabelI18n: typeOfTicket }}" title="{{ data | customFieldLabelI18n: typeOfTicket }}" for="{{data.name + \'InputBox\'}}">{{ data | customFieldLabelI18n: typeOfTicket }}</label>',link:function(e){e.typeOfTicket=e.context?e.context.type||e.context.ticketType:"",e.hideLabel=function(){var t;return!e.alwaysShowLabel&&(t=e.data.ootb||!!e.data.value||0===e.data.value,!e.isHideLabel||e.$parent.$parent.editMode&&e.$parent.$parent.$parent&&e.$parent.$parent.$parent.editMode?!(!e.data.hideLabel&&t||e.$parent.$parent.editMode||e.$parent.$parent.$parent&&e.$parent.$parent.$parent.editMode):e.isHideLabel)}}}}).directive("characterCustomField",["customFieldLinkFunction","$filter","events",function(e,t,a){return{restrict:"E",replace:!0,scope:{data:"=",isEditable:"=",charLimit:"=",isHideLabel:"=",typeOfTicket:"=?"},templateUrl:"views/field-customization/custom-fields/character-custom-field.html",link:function(n,i){e(n),n.status={isCollapsed:!0},"Task ID"===n.data.label&&(n.data.maxLength=15),n.$watch("data.setValueFlag",function(e){e&&"#$#"!==e&&(n.onFieldValueChange(),n.data.setValueFlag="#$#")}),n.isHideLabel&&(n.tooltipToShow=t("customFieldLabelI18n")(n.data)),n.data.maxLength>0&&i.find(".form-control").attr("maxlength",n.data.maxLength);var o=_.cloneDeep(n.data.value);n.$on(a.SAVE_CHANGES,function(){o=_.cloneDeep(n.data.value)}),n.$on(a.DISCARD_CHANGES,function(){n.data.value=_.cloneDeep(o)})}}}]).directive("textareaCustomField",["customFieldLinkFunction","$filter","events",function(e,t,a){return{restrict:"E",replace:!0,scope:{data:"=",isEditable:"=",isHideLabel:"=",charLimit:"=?",updateIsHandledByParent:"=?"},templateUrl:"views/field-customization/custom-fields/textarea-custom-field.html",link:function(n,i){e(n),n.status={isCollapsed:!0},n.$watch("data.setValueFlag",function(e){e&&"#$#"!==e&&(n.onFieldValueChange(),n.data.setValueFlag="#$#")}),n.isHideLabel&&(n.tooltipToShow=t("customFieldLabelI18n")(n.data)),n.data.maxLength>0&&i.find(".form-control").attr("maxlength",n.data.maxLength);var o=_.cloneDeep(n.data.value);n.$on(a.SAVE_CHANGES,function(){o=_.cloneDeep(n.data.value)}),n.$on(a.DISCARD_CHANGES,function(){n.data.value=_.cloneDeep(o)})}}}]).directive("staticSelectionCustomField",["customFieldLinkFunction","screenConfigurationModel","events","$filter","$rootScope",function(e,t,a,n,i){return{restrict:"E",replace:!0,scope:{data:"=",context:"=",isEditable:"=",isHideLabel:"="},templateUrl:"views/field-customization/custom-fields/static-selection-custom-field.html",link:function(o){function r(){var e=o.data.getValue();e&&"object"==typeof e&&(e=e.name),o.data.radioFieldVal=o.data.value,angular.isDefined(e)&&null!==e?o.data.ootb?(o.dropdownOptions.selectedOption=_.find(o.options,{name:e}),o.dropdownOptions.selectedOption||(o.dropdownOptions.selectedOption=_.find(o.options,{index:e}))):o.dropdownOptions.selectedOption=_.find(o.options,function(t){return t.index===e||t.name===e}):o.dropdownOptions.selectedOption=null}e(o);var s,l=o.data,c=t.fieldLabels||[];o.dropdownOptions={selectedOption:null},s=EntityVO.ENTITIES_WITH_NEW_CUSTOMIZATION.indexOf(o.context.type)!==-1?{options:l.options}:_.find(c,function(e){var t=e.name===o.data.name;return t&&o.context&&o.context.ticketType===EntityVO.TYPE_ASSET&&e.classIds&&e.classIds.length&&(t="ITSM AssetBase"===e.classIds[0]||e.classIds[0]===o.context.classId),t});var d=[{index:0,value:0,label:n("i18n")("customField.selection.label.yes")},{index:1,value:1,label:n("i18n")("customField.selection.label.no")}];o.handleRadioEnterKey=function(e){!o.data.isReadOnly&&o.isEditable&&(o.selectItem(e),o.data.radioFieldVal||(o.data.radioFieldVal=!o.data.radioFieldVal))},o.options=l.isSelectionField()?d:s&&s.options||[],o.selectItem=function(e){o.dropdownOptions.selectedOption=e,_.isEmpty(e)?l.clearValue():l.isRadioField()&&e.index===l.getValue()?(o.dropdownOptions.selectedOption=null,o.data.radioFieldVal=null,l.clearValue()):l.setValue(e.name?e.name:e.value),o.onFieldValueChange()},o.$watch("data.setValueFlag",function(e){"#$#"!==e&&(r(),o.onFieldValueChange(),l.setValueFlag="#$#")});var u=i.$on(a.TICKET_TEMPLATE_UPDATED,function(e,t){if("serviceType"===o.data.name&&t)if(t.selectedServiceType&&t.selectedServiceType.name){var a=_.find(o.options,{name:t.selectedServiceType.name});a&&o.selectItem(a)}else o.selectItem(null)});o.isHideLabel&&(o.tooltipToShow=n("customFieldLabelI18n")(o.data)),o.$on(a.RISK_LEVEL_CHANGE,function(e,t){"changeReason"===o.data.name&&((angular.isUndefined(o.data.originalRequired)||null===o.data.originalRequired)&&(o.data.originalRequired=o.data.isRequired),o.data.isRequired=o.data.originalRequired||t.isRequired)}),r(),o.$on(a.REFRESH_FIELD_VALUES,r),o.$on("$destroy",function(){u()})}}}]).directive("checkboxCustomField",["customFieldLinkFunction","screenConfigurationModel","$filter","events",function(e,t,a,n){return{restrict:"E",replace:!0,scope:{data:"=",isEditable:"=",isHideLabel:"=",typeOfTicket:"=?"},templateUrl:"views/field-customization/custom-fields/checkbox-custom-field.html",link:function(i){function o(e){return null===e?{index:0,label:a("i18n")("customField.checkbox.label.off")}:{index:0,label:a("i18n")("customField.checkbox.label.on")}}function r(){var e=c.getValue();l.isSelectionField()?(null===e||""===e||void 0===e?l.clearValue():l.setValue(i.cbOption.index),i.cbOption=o(l.value)):e===-1||null===e||void 0===e?(l.setValue(-1),i.cbOption={index:-1,label:"-"}):(i.cbOption=u&&u.options&&u.options.length?u.options[0]:{index:0,label:""},l.setValue(e))}function s(){c=angular.copy(i.data)}e(i),i.checkbox={value:i.data.value!==-1&&void 0!==i.data.value&&null!==i.data.value};var l=i.data,c=angular.copy(i.data),d=t.fieldLabels||[],u=_.find(d,{name:l.name})||l,p=o(l.value);i.editLabel=u&&u.options&&u.options.length?u.options[0].label:"",l.isSelectionField()?(i.cbOption=p,l.dynamicField&&(i.alwaysShowLabel=!0)):(i.cbOption=u&&u.options?u.options[0]:{index:-1,label:"-"},u&&u.options&&l.value!==u.options[0].index&&(l.setValue(-1),i.cbOption={index:-1,label:"-"})),i.$watch("data.setValueFlag",function(e){"#$#"!==e&&(l.isSelectionField()?(i.cbOption=o(e),e&&l.clearValue()):e!==-1?l.setValue(-1):l.setValue(u&&u.options&&u.options.length?u.options[0].index:0),i.selectItem(),l.setValueFlag="#$#")}),i.isHideLabel&&(i.tooltipToShow=a("customFieldLabelI18n")(i.data)),i.selectItem=function(){l.isSelectionField()?(null!==l.value&&""!==l.value&&void 0!==l.value?l.clearValue():l.setValue(i.cbOption.index),i.cbOption=o(l.value)):l.value!==-1&&null!==l.value&&void 0!==l.value?(l.setValue(-1),i.cbOption={index:-1,label:"-"}):(i.cbOption=u&&u.options&&u.options.length?u.options[0]:{index:0,label:""},l.setValue(u&&u.options&&u.options.length?u.options[0].index:0)),i.onFieldValueChange()},i.$on(n.RESET_DYNAMIC_FIELDS,r),i.$on(n.UPDATE_DYNAMIC_DATA,s)}}}]).directive("numberCustomField",["customFieldLinkFunction","$filter","events",function(e,t,a){return{restrict:"E",replace:!0,scope:{data:"=",isEditable:"=",isHideLabel:"=",typeOfTicket:"=?"},templateUrl:"views/field-customization/custom-fields/number-custom-field.html",link:function(n){n.data.step=Math.pow(10,-n.data.precision),n.$watch("data.setValueFlag",function(e){"#$#"!==e&&(n.onFieldValueChange(),n.data.setValueFlag="#$#")}),e(n),n.isHideLabel&&(n.tooltipToShow=t("customFieldLabelI18n")(n.data));var i=_.cloneDeep(n.data.value);n.$on(a.SAVE_CHANGES,function(){i=_.cloneDeep(n.data.value)}),n.$on(a.DISCARD_CHANGES,function(){n.data.value=_.cloneDeep(i)})}}}]).directive("dateTimeCustomField",["customFieldLinkFunction","$filter","events","configurationModel",function(e,t,a,n){return{restrict:"E",replace:!0,scope:{data:"=",isEditable:"=",isHideLabel:"=",typeOfTicket:"=?"},templateUrl:"views/field-customization/custom-fields/datetime-custom-field.html",link:function(i){e(i),i.status={opened:!1},i.datePickerOptions={startingDay:n.getWeekStartingDay(),"show-weeks":!1,minDate:moment().year(1970).month(0).date(2),maxDate:moment().year(2038).month(0).date(18)},i.$watch("data.setValueFlag",function(e){e&&"#$#"!==e&&(i.onFieldValueChange(),i.data.setValueFlag="#$#")}),i.isHideLabel&&(i.tooltipToShow=t("customFieldLabelI18n")(i.data)),i.open=function(e){e.preventDefault(),e.stopPropagation(),i.status.opened=!0};var o=_.cloneDeep(i.data.value);i.$on(a.SAVE_CHANGES,function(){o=_.cloneDeep(i.data.value)}),i.$on(a.DISCARD_CHANGES,function(){i.data.value=_.cloneDeep(o)})}}}]).directive("dateCustomField",["customFieldLinkFunction","$filter","configurationModel",function(e,t,a){return{restrict:"E",replace:!0,scope:{data:"=",isEditable:"=",isHideLabel:"="},templateUrl:"views/field-customization/custom-fields/date-custom-field.html",link:function(n){if(e(n),n.status={opened:!1},n.datePickerOptions={startingDay:a.getWeekStartingDay(),"show-weeks":!1,minDate:moment().year(1970).month(0).date(2)},!n.data.isDateTimeField()&&n.data.value){var i=new Date(n.data.value),o=i.valueOf()+6e4*i.getTimezoneOffset();o&&(n.data.value=o)}n.$watch("data.setValueFlag",function(e){e&&"#$#"!==e&&(n.onFieldValueChange(),n.data.setValueFlag="#$#")}),n.isHideLabel&&(n.tooltipToShow=t("customFieldLabelI18n")(n.data)),n.open=function(e){e.preventDefault(),e.stopPropagation(),n.status.opened=!0}}}}]).directive("timeCustomField",["customFieldLinkFunction","$filter","events",function(e,t,a){return{restrict:"E",replace:!0,scope:{data:"=",isEditable:"=",isHideLabel:"="},templateUrl:"views/field-customization/custom-fields/time-custom-field.html",link:function(n){n.$watch("data.setValueFlag",function(e){e&&"#$#"!==e&&(n.onFieldValueChange(),n.data.setValueFlag="#$#")}),e(n),n.isHideLabel&&(n.tooltipToShow=t("customFieldLabelI18n")(n.data));var i=_.cloneDeep(n.data.value);n.$on(a.SAVE_CHANGES,function(){i=_.cloneDeep(n.data.value)}),n.$on(a.DISCARD_CHANGES,function(){n.data.value=_.cloneDeep(i)})}}}]).directive("validNumber",["$timeout",function(e){return{restrict:"A",require:"ngModel",link:function(t,a,n,i){function o(t){var a=t?t.toString():"";if(!a||a.indexOf(".")===-1||!a.split(".")[1].length)return t;var o=parseInt(n.precision),r=a.split(".")[1].length,s=!0,l=t,c=0,d="";return o?o<r&&(s=!1,c=r-n.precision):(s=!1,c=r+1),s||(l=parseFloat(a.slice(0,0-c)),d=a.slice(0,0-c),e(function(){i.$setViewValue("integer"===n.numberType?parseInt(d):parseFloat(d)),i.$render()},0)),l}function r(e){if(!JSON.parse(n.numberRequired))return i.$setValidity("required",!0),e;if(i.$isEmpty(e))i.$setValidity("required",!1);else if(!isNaN(e))return i.$setValidity("required",!0),e}i.$parsers.push(o,r)}}}]).directive("numberInput",["i18nService",function(e){return{restrict:"A",require:"ngModel",scope:{min:"@",max:"@",precision:"@",numberType:"@"},link:function(t,a,n,i){var o=parseFloat(n.min),r=parseFloat(n.max),s=parseInt(n.precision);isNaN(s)&&(s=0);var l=Math.pow(10,-s),c=n.numberType;a.numericSpinner({step:l,spin:function(e,a){var n=a.value;n>r&&(n=r),n<o&&(n=o),i.$setViewValue(n),t.$apply()}}),i.$formatters.unshift(function(){var e=parseFloat(i.$modelValue);return isNaN(e)?i.$modelValue:e.toFixed(s)});var d=function(e,a){1===a.length&&""===a[0]&&(i.$setViewValue(""),t.$apply())},u="de"===e.language?",":".";switch(c){case"integer":a.inputmask("integer",{rightAlign:!1,onKeyUp:d});break;case"decimal":a.inputmask("decimal",{rightAlign:!1,skipRadixDance:!0,radixPoint:u,digits:s,onKeyUp:d});break;case"real":a.inputmask("real",{rightAlign:!1,skipRadixDance:!0,radixPoint:u,digits:s,onKeyUp:d})}}}}]).directive("menuCustomField",["customFieldLinkFunction","screenConfigurationModel","screenConfigurationService","metadataModel","objectValueMapperService","$filter","events","$timeout",function(e,t,a,n,i,o,r,s){return{restrict:"E",replace:!0,scope:{data:"=",context:"=",isEditable:"=",isNew:"=?",getFieldValue:"&",onSelectCb:"&",isHideLabel:"="},templateUrl:"views/field-customization/custom-fields/menu-custom-field.html",link:function(l){e(l);var c=l.data,d=l.context,u=d&&d.ticketType===EntityVO.TYPE_ASSET?d.ticketType:d.type,p=d&&d.ticketType===EntityVO.TYPE_ASSET?d.classId:null;l.getCustomFieldFieldValue=l.getFieldValue(),l.onSelectCb=l.onSelectCb()?l.onSelectCb():angular.noop,l.state={loading:!1};var m;"company"==c.name&&(c.isLocationCompany=!0),l.$watch("data.setValueFlag",function(e){"#$#"!==e&&(_.isEmpty(e)?(l.state.loading=!1,l.data.clearValue(),l.data.clearLinkedFieldValue()):(l.data.setValue(e),l.data.setLinkedFieldValue(e)),l.onFieldValueChange(),l.data.setValueFlag="#$#")}),l.isHideLabel&&(l.tooltipToShow=o("customFieldLabelI18n")(l.data)),n.getMetadataByType(EntityVO.TYPE_GLOBAL).then(function(e){e.configurationParameters.CustomizationTypeaheadLength?l.typeaheadMinLength=parseInt(e.configurationParameters.CustomizationTypeaheadLength):l.typeaheadMinLength=3}),l.loadDynamicSelectionValues=function(e){return n.getMetadataByType(u).then(function(n){var o={};if(u===EntityVO.TYPE_TASK||u===EntityVO.TYPE_WORKORDER)var r=d.locationCompany;_.includes(EntityVO.ENTITIES_WITH_NEW_CUSTOMIZATION,u)?_.forEach(c.dependency,function(e){var t=i.getFieldByName(e.name);o[e.name]=i.getExactValueByFieldName(e.name)||null,t||"locationCompany"!==e.name||(t=i.getFieldByName("company"),o[e.name]=i.getExactValueByFieldName("company"),""===o[e.name]&&(o[e.name]=r)),t&&"dropdown"===t.dataType?t.options&&t.options.length>0&&_.forEach(t.options,function(t){t.name===o[e.name]&&(o[e.name]=t.index)}):t&&"widget"===t.dataType&&t.members.length&&"dropdown"===t.members[0].dataType&&t.members[0].options&&t.members[0].options.length>0&&_.forEach(t.members[0].options,function(t){t.name===o[e.name]&&(o[e.name]=t.index)})}):_.forEach(c.dependency,function(e){if(o[e.name]=l.getCustomFieldFieldValue(e.name),_.isUndefined(o[e.name])&&"asset"!==u){var t=[EntityVO.TYPE_PRIORITY,EntityVO.TYPE_URGENCY,EntityVO.TYPE_IMPACT,EntityVO.TYPE_STATUS];if(o[e.name]=a.getContextPropertyByMetadataMapping(d,n,e.name,l.isNew)||null,null!==o[e.name]&&void 0!==o[e.name]&&(u===EntityVO.TYPE_KNOWNERROR||u===EntityVO.TYPE_PROBLEM)&&_.includes(t,e.name)){var i;switch(e.name){case EntityVO.TYPE_PRIORITY:i=n.priorities;break;case EntityVO.TYPE_URGENCY:i=n.urgencies;break;case EntityVO.TYPE_IMPACT:i=n.impacts;break;case EntityVO.TYPE_STATUS:i=n.statuses;break;default:i=[]}i.length&&(o[e.name]=_.result(_.find(i,{name:o[e.name]}),"index"))}}else if(_.isUndefined(o[e.name])&&"asset"===u){var r=n&&n.ootbMapping&&n.ootbMapping[e.name]&&n.ootbMapping[e.name][0];if(r&&r!==e.name){var s=a.getContextPropertyByMetadataMapping(d,n,e.name);s||"companyName"!==r?s||"siteGroup"!==r?s||"siteName"!==r?s||"siteRegion"!==r||(s=d&&d.site&&d.site.region?d.site.region:""):s=d&&d.site&&d.site.name?d.site.name:"":s=d&&d.site&&d.site.siteGroup?d.site.siteGroup:"":s=d&&d.company&&d.company.name?d.company.name:"",delete o[e.name],o[r]=s?s:null}else o[e.name]=a.getContextPropertyByMetadataMapping(d,n,e.name)}});var f=(!l.isNew||!_.includes([EntityVO.TYPE_PROBLEM,EntityVO.TYPE_KNOWNERROR],u))&&l.isNew;return t.loadDynamicSelectionFieldLabels(u,c.menu,e,o,p,c.name,f).then(function(e){
return m&&s.cancel(l.tooltipPromise),l.exceedsChunkSize=e.exceedsChunkSize,l.state.isTooltipOpen=e.exceedsChunkSize,m=s(function(){l.state.isTooltipOpen=!1},1e4),e.items})})["finally"](function(){l.state.loading=!1})},l.onInputFocusBlur=function(){l.state.isTooltipOpen=!1},l.selectItem=function(e){var t;_.isEmpty(e)?(c.clearValue(),c.clearLinkedFieldValue(),_.includes(EntityVO.ENTITIES_WITH_NEW_CUSTOMIZATION,u)&&c.valueField&&i.setByProperty(c.valueField,"value","")):("assignee"===c.name||"assigneeName"===c.name||"managerName"===c.name?(t=e.label,c.assigneeLoginId=e.value):t=!c.valueField&&e.value?e.value:e.label,c.setValue(t),c.setLinkedFieldValue(e.value),_.includes(EntityVO.ENTITIES_WITH_NEW_CUSTOMIZATION,u)&&c.valueField&&i.setByProperty(c.valueField,"value",e.value),l.$emit(r.CLEAR_DEPENDANT_FIELDS,c.name)),l.onFieldValueChange(),l.onSelectCb(),l.$emit(r.CUSTOM_FIELD_VALUE_CHANGE)}}}}]).directive("groupCustomField",["customFieldLinkFunction","events","screenConfigurationService","metadataModel","$filter","objectValueMapperService",function(e,t,a,n,i,o){return{restrict:"E",replace:!0,scope:{data:"=",context:"=",getFieldValue:"&",isNew:"=?",isHideLabel:"="},templateUrl:"views/field-customization/custom-fields/group-custom-field.html",controller:"LaunchActionController",link:function(a){var r=a.context,s=r&&r.ticketType===EntityVO.TYPE_ASSET?r.ticketType:r.type;e(a),a.$watch("$parent.editMode",function(e){a.editMode=e},!0),a.$watch("context",function(){a.checkEditable()},!0),a.getFieldValue=a.getFieldValue(),a.isEditable=function(e){return a.context.type===EntityVO.TYPE_ASSET?!e.isReadOnly:e.isEditable(a.context.accessMappings)},a.isHideLabel&&(a.tooltipToShow=i("customFieldLabelI18n")(a.data)),a.clearDependantFieldValues=function(e,t){_.forEach(a.data.members,function(e){return e.dependency&&e.dependency.length?void(_.findIndex(e.dependency,{name:t})>-1&&(e.clearValue(),e.clearLinkedFieldValue(),a.onFieldValueChange(e))):void(e.groupEditable=!0)})},a.checkEditable=function(){var e=!0;n.getMetadataByType(s).then(function(t){_.forEach(a.data.members,function(t){return t.dependency&&t.dependency.length?(_.forEach(t.dependency,function(t){if(!a.getFieldValue(t.name)){var n=o.getExactValueByFieldName(t.name);n||(e=!1)}}),void(e?t.groupEditable=!0:(t.groupEditable=!1,t.clearValue(),t.clearLinkedFieldValue(),a.onFieldValueChange(t)))):void(t.groupEditable=!0)})})},a.checkEditable(),a.$on(t.REFRESH_FIELD_VALUES,a.checkEditable),a.$on(t.CLEAR_DEPENDANT_FIELDS,a.clearDependantFieldValues)}}}])}(),function(){angular.module("myitsmApp").directive("dynamicFieldArea",["ticketModel","events","screenConfigurationModel","$q","customFieldAreaLinkFunction",function(e,t,a,n,i){return{restrict:"E",replace:!0,scope:{ticket:"=",panelId:"="},templateUrl:"views/field-customization/custom-field-area.html",link:function(a){function o(){a.editMode=!a.editMode,a.isCollapsed=!1}function r(){a.$emit(t.SAVE_CHANGES_COMPLETE),a.editMode=!1}function s(){u(y),a.$broadcast(t.RESET_DYNAMIC_FIELDS),a.editMode=!1}function l(){a.$emit(t.SAVE_CHANGES_REQUEST,null,!0);var i,o=f(a.fields,E),s={dynamicFields:o};o.length?(a.ticket.type&&(i=a.ticket.isDraft?n.when(1):e.update(a.ticket.id,a.ticket.type,s)),i&&i.then(function(){a.ticket.dynamicFields=g(a.ticket),h(a.ticket,o),d(o)})["finally"](r)):r()}function c(){a.$emit(t.FIELD_FORM_IS_DIRTY)}function d(e){_.forEach(e,function(e){E[e.name]=e.value})}function u(e){e.forEach(function(e){p(e.value)&&e.value.toString().length&&e.setValue(e.value)})}function p(e){return angular.isDefined(e)&&null!==e}function m(){_.forEach(y,function(e){E[e.name]=e.value})}function f(e,t){var a=[];return _.forEach(e,function(e){t[e.name]!==e.getValue()&&a.push({name:e.name,value:e.getValue(),dataType:e.dataType,label:e.label})}),a}function g(e){var t=[];return _.forEach(e.dynamicFields,function(e){t.push(e)}),t}function h(e,n){n.length&&(e.dynamicFields||(e.dynamicFields=[]),_.forEach(e.dynamicFields,function(e){_.forEach(n,function(t){e.name===t.name&&(e.value=t.value)})}),a.$broadcast(t.UPDATE_DYNAMIC_DATA),m())}var y=angular.copy(a.ticket.dynamicFields),E={};_.forEach(y,function(e){_.extend(e,{dynamicField:!0})}),m(),u(y),a.fields=y,a.editMode=!1,a.isCollapsed=!0,a.isDynamicArea=!0,a.fieldsCountToShow=10,i(a),a.visibleFields=a.getFieldsListToShow(),a.isEditable=function(e){return e.isEditable(a.ticket.accessMappings)},a.$on(t.TOGGLE_DYNAMIC_FIELD_EDIT_MODE,o),a.$on(t.SAVE_CHANGES,l),a.$on(t.DISCARD_CHANGES,s),a.$on(t.FIELD_VALUE_CHANGE,c)}}}])}(),function(){angular.module("myitsmApp").directive("dynamicFieldContainer",["events","customFieldAreaLinkFunction",function(e,t){return{restrict:"E",replace:!0,scope:{fields:"=",ticket:"=",panelId:"="},templateUrl:"views/field-customization/custom-field-area.html",link:function(a){function n(e){e.forEach(function(e){i(e.value)&&e.value.toString().length&&e.setValue(e.value)})}function i(e){return angular.isDefined(e)&&null!==e}function o(t,n){var i=n.getValue();r(n,i),a.$emit(e.FIELD_FORM_IS_DIRTY)}function r(e,t){_.find(a.ticket.dynamicFields,{name:e.name}).value=t}a.editMode=!0,a.isDynamicArea=!0,a.fieldsCountToShow=10,t(a),a.visibleFields=a.getFieldsListToShow(),a.$on(e.FIELD_VALUE_CHANGE,o),n(a.fields),a.isEditable=function(e){return e.isEditable(a.ticket.accessMappings)}}}}])}(),function(){angular.module("myitsmApp").directive("gainsight",["$window","metadataModel","gainsightModel","permissionModel","roles",function(e,t,a,n,i){return{restrict:"EA",link:function(o){t.getMetadataByType(EntityVO.TYPE_GLOBAL).then(function(t){t.enableGainsight&&a.getTelemetryConfiguration().then(function(o){o.settings.enableGainsight&&o.displayBanner&&a.showOptinConfig();var r=o.productTag,s=n.hasPermission("admin:screenConfiguration")?"Administrator":"";s||(n.hasPermission(i.ITSM_AGENT_ROLE)||n.hasPermission(i.ITSM_CHANGE_USER_ROLE)||n.hasPermission(i.ITSM_KNOWLEDGE_USER_ROLE)||n.hasPermission(i.ITSM_PROBLEM_USER_ROLE)||n.hasPermission(i.ITSM_ASSET_USER_ROLE)||n.hasPermission(i.ITSM_ASSET_ADMIN_ROLE)||n.hasPermission(i.ITSM_RELEASE_USER_ROLE)||n.hasPermission(i.ITSM_SBE_USER_ROLE)||n.hasPermission(i.ITSM_BROADCAST_USER_ROLE))&&(s="Agent");var l=_.find(o.viewMapping,{viewName:"/"}),c=JSON.parse(l.globalContext),d={application:{id:o.companyId&&!_.isEmpty(o.companyId)?o.companyId:o.company,name:o.company},user:{id:o.hashedUserId,globalId:o.hashedUserId,role:s,pwaRoles:s,functionalRoles:{}}},u="https://web-sdk.aptrinsic.com/api/aptrinsic.js";o.settings.loadGainsightFromBmcIt&&(u="https://documents.bmc.com/products/docs/gainsight/main/aptrinsic.js");var p={};t.configurationParameters.allowBlankSrc&&(p.allowBlankSrc=t.configurationParameters.allowBlankSrc),t.configurationParameters.iframeModeEnabled&&(p.iframeModeEnabled=t.configurationParameters.iframeModeEnabled),function(e,t,a,n,i){var o="aptrinsic";e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].p=n,e[o].c=i;var r=t.createElement("script");r.async=!0,r.src=a+"?a="+n;var s=t.getElementsByTagName("script")[0];s.parentNode.insertBefore(r,s)}(window,document,u,r,p),e.aptrinsic("identify",d.user,d.application),e.aptrinsic("set","globalContext",c)})})}}}])}(),function(){angular.module("myitsmApp").factory("gainsightModel",["gainsightService","$q","$modal",function(e,t,a){var n={cache:{}};return n.getTelemetryConfiguration=function(){if(n.cache.telemetryConfig){var a=_.has(n.cache.telemetryConfig,"$$state.status");return t.when(a?n.cache.telemetryConfig:angular.copy(n.cache.telemetryConfig))}return n.cache.telemetryConfig=e.getTelemetryConfiguration().then(function(e){return n.cache.telemetryConfig=e,e}),n.cache.telemetryConfig},n.getUserPreference=function(){return e.getUserPreference()},n.setUserPreference=function(t){return e.setUserPreference(t)},n.showOptinConfig=function(){var e=a.open({templateUrl:"views/gainsight/gainsight-user-preference.html",windowClass:"bmc-system-analytics-modal",size:"md",controller:["$scope","$filter","getData","gainsightModel","systemAlertService",function(t,a,n,i,o){t.data=n,t.data.label=a("i18n")("user.preference.dataCollection.enable.label"),t.dataLoading=!0,t.dataSaving=!1;var r;i.getUserPreference().then(function(e){t.data.value=null===e.trackUsage||e.trackUsage,r=e,t.dataLoading=!1}),t.saveOptin=function(){r.trackUsage=t.data.value,t.dataSaving=!0,i.setUserPreference(r).then(function(n){r=n.responseObject,t.dataSaving=!1,2e3===n.statusInfo.number?(o.success({text:a("i18n")("user.preference.dataCollection.successMessage"),clear:!0,hide:5e3}),e.close()):o.error({text:n.statusInfo&&n.statusInfo.message,clear:!1})})}}],resolve:{getData:function(){return{name:"optin",isRequired:!0,value:!1}}}});return e},n}])}(),function(){angular.module("myitsmApp").service("gainsightService",["$http","$modal",function(e,t){this.getTelemetryConfiguration=function(){return e.get("/smartit/rest/analytics/gainsight/configuration/ITSM").then(function(e){return e.data})},this.getUserPreference=function(){return e.get("/smartit/rest/analytics/gainsight/user/preferences").then(function(e){return e.data})},this.setUserPreference=function(t){return e.post("/smartit/rest/analytics/gainsight/user/preferences",t).then(function(e){return e.data})}}])}(),function(){angular.module("innovationStudio").controller("StudioController",["$scope","$state","$sce","$rootScope","$timeout","studioModel",function(e,t,a,n,i,o){function r(e){var t=document.getElementsByClassName("app__studio-iframe");console.info("Inside setStudioFrameUrl method - url : "+e),t&&0!==t.length?e&&(setTimeout(function(){t[0].contentWindow.location.replace(e)}),console.info("Inside setStudioFrameUrl method - location url changed")):console.error("Inside setStudioFrameUrl method : studio iframe not loaded")}var s="/helix/index.html#",l="",c="/com.bmc.dsm.itsm-applications/iview/com.bmc.dsm.itsm-applications:Calendar",d="/com.bmc.dsm.itsm-applications/iview/com.bmc.dsm.itsm-applications:IT%20Ticket%20Console%20SM",u="/com.bmc.dsm.itsm-applications/iview/com.bmc.dsm.itsm-applications:Global%20Search%20View",p="/com.bmc.dsm.itsm-applications/iview/com.bmc.dsm.itsm-applications:Asset%20Console%20SM";"calendarStudio"===t.current.name?o.ccsFetched?o.enableISCalendar&&o.baseUrlForIS?(l=o.baseUrlForIS,n.studioFrameUrl=a.trustAsResourceUrl(l+s+c+"?SmartIT_URL="+o.smartITUrl),r(n.studioFrameUrl)):t.go("calendar"):o.calendarEnabledPromise().then(function(e){l=o.baseUrlForIS,e&&l?(n.studioFrameUrl=a.trustAsResourceUrl(l+s+c+"?SmartIT_URL="+o.smartITUrl),r(n.studioFrameUrl)):t.go("calendar")}):"ticketConsoleStudio"===t.current.name?o.ccsFetched?o.enableSharedConsole&&o.baseUrlForIS?(l=o.baseUrlForIS,n.studioFrameUrl=a.trustAsResourceUrl(l+s+d+"?SmartIT_URL="+o.smartITUrl),r(n.studioFrameUrl)):t.go("ticketConsole"):o.sharedConsoleEnabledPromise().then(function(e){l=o.baseUrlForIS,e&&l?(n.studioFrameUrl=a.trustAsResourceUrl(l+s+d+"?SmartIT_URL="+o.smartITUrl),r(n.studioFrameUrl)):t.go("ticketConsole")}):"globalSearchStudio"===t.current.name?o.ccsFetched?o.enableHelixGPTGlobalChat&&o.baseUrlForIS?(l=o.baseUrlForIS,n.studioFrameUrl=a.trustAsResourceUrl(l+s+u+"?SmartIT_URL="+o.smartITUrl+"&helixgptGlobalSearchDefaultMode="+o.helixgptGlobalSearchDefaultMode),r(n.studioFrameUrl)):t.go("search"):o.helixGPTGlobalSearchEnabledPromise().then(function(e){l=o.baseUrlForIS,e&&l?(n.studioFrameUrl=a.trustAsResourceUrl(l+s+u+"?SmartIT_URL="+o.smartITUrl+"&helixgptGlobalSearchDefaultMode="+o.helixgptGlobalSearchDefaultMode),r(n.studioFrameUrl)):t.go("search")}):"assetConsoleStudio"===t.current.name&&(o.ccsFetched?o.enableISAssetConsole&&o.baseUrlForIS?(l=o.baseUrlForIS,n.studioFrameUrl=a.trustAsResourceUrl(l+s+p+"?SmartIT_URL="+o.smartITUrl),r(n.studioFrameUrl)):t.go("assetConsole"):o.assetConsoleEnabledPromise().then(function(e){l=o.baseUrlForIS,e&&l?(n.studioFrameUrl=a.trustAsResourceUrl(l+s+p+"?SmartIT_URL="+o.smartITUrl),r(n.studioFrameUrl)):t.go("assetConsole")})),$(document).on("focusout",function(){i(function(){var e;if(document.activeElement instanceof HTMLIFrameElement)if(e=document.getElementsByClassName("open"),e.length){var t=e[0].getElementsByClassName("dropdown-toggle");t.length&&(t=t[0],t.click())}else if(e=document.getElementsByClassName("search__close"),e.length){var a=e[0];a.click()}},0)})}])}(),function(){angular.module("innovationStudio").factory("studioModel",["authModel","session","$window","$q","$rootScope","AUTH_EVENTS","systemAlertService","$filter","metadataModel",function(e,t,a,n,i,o,r,s,l){function c(e){var t="T"===e.configurationParameters["Enable-Progressive-Views"]||"true"===e.configurationParameters["Enable-Progressive-Views"];t="T"!==localStorage.getItem("overridePV")&&t,d.ccsFetched=!0,d.baseUrlForIS=e.configurationParameters.innovationSuiteBaseURL,d.smartITUrl=e.configurationParameters["smartit.url"],d.enableISCalendar="true"===e.configurationParameters.enableISCalendar&&t,d.enableSharedConsole="true"===e.configurationParameters.enableSharedTicketConsole&&t,d.enableISAssetConsole="true"===e.configurationParameters.enableISAssetConsole&&t,d.helixgptGlobalSearchDefaultMode=e.configurationParameters.helixgptGlobalSearchDefaultMode||"search",d.enableHelixGPTGlobalChat="true"===e.configurationParameters.enableHelixGPTGlobalChat&&e.configurationParameters["HelixGPT-Assistant-Service-URL"]&&e.configurationParameters["HelixGPT-Assistant-Service-URL"].length>0&&t}var d={};return d.ccsFetched=!1,d.enableISCalendar=!1,d.enableSharedConsole=!1,d.enableHelixGPTGlobalChat=!1,d.helixgptGlobalSearchDefaultMode="search",d.baseUrlForIS="",d.enableISAssetConsole=!1,d.init=function(){return l.getMetadataByType(EntityVO.TYPE_GLOBAL).then(function(e){return c(e),d})},d.calendarEnabledPromise=function(){return d.ccsFetched?n.when(d.enableISCalendar):l.getMetadataByType(EntityVO.TYPE_GLOBAL).then(function(e){return c(e),d.enableISCalendar})},d.sharedConsoleEnabledPromise=function(){return d.ccsFetched?n.when(d.enableSharedConsole):l.getMetadataByType(EntityVO.TYPE_GLOBAL).then(function(e){return c(e),d.enableSharedConsole})},d.helixGPTGlobalSearchEnabledPromise=function(){return d.ccsFetched?n.when(d.enableHelixGPTGlobalChat):l.getMetadataByType(EntityVO.TYPE_GLOBAL).then(function(e){return c(e),d.enableHelixGPTGlobalChat})},d.assetConsoleEnabledPromise=function(){return d.ccsFetched?n.when(d.enableISAssetConsole):l.getMetadataByType(EntityVO.TYPE_GLOBAL).then(function(e){return c(e),d.enableISAssetConsole})},d}])}(),function(){angular.module("changeModule").directive("impactAnalysisBanner",["$state","i18nService","systemAlertService","ticketModel","relationModel","$filter","events",function(e,t,a,n,i,o,r){return{restrict:"E",replace:!0,templateUrl:"views/impact-analysis/impact-analysis-banner.html",scope:{context:"=",impactAnalysisStatus:"="},link:function(s){s.toggle=function(){s.visible=!s.visible},s.conductImpactAnalysis=function(){e.go("impactGraph",{id:s.context.id,type:EntityVO.TYPE_CHANGE,displayId:s.context.displayId})},s.relateAllCIs=function(){var e={type:"info",title:t.getLocalizedString("impactAnalysis.relateAndComplete.title"),text:t.getLocalizedString("impactAnalysis.relateAndComplete.question.allCIs"),details:t.getLocalizedString("impactAnalysis.relateAndComplete.details"),additionalInfo:t.getLocalizedString("create.change.wizard.ci.confirmCIRelation.text"),buttons:[{text:t.getLocalizedString("impactAnalysis.relateAndComplete.confirmation.yes"),data:!0},{text:t.getLocalizedString("impactAnalysis.relateAndComplete.confirmation.no"),data:!1}]};return a.modal(e).result.then(function(e){if(e){var t=[];s.$emit(r.SHOW_PROGRESS_MODAL_FOR_EDIT,{showModal:!0,title:o("i18n")("change.details.relatingCIs.title"),text:o("i18n")("change.details.relatingCIs.text")}),n.getImpactAnalysisVisualisationData(EntityVO.TYPE_CHANGE,s.context.id).then(function(e){_.each(e.impactedCIs,function(e){e.isRelated||t.push({id:e.reconciliationId,desc:e.name,tag:"linkeditem",relationshipType:"impacts",type:"asset"})}),i.addRelation({uuid:s.context.id,type:EntityVO.TYPE_CHANGE},t)["finally"](function(){n.impactAnalysisAction(s.context.id,EntityVO.TYPE_CHANGE,{command:"dismiss"}).then(function(){s.context.hasImpactAnalysis=!1,s.$emit(r.SHOW_PROGRESS_MODAL_FOR_EDIT,{showModal:!1}),a.success({text:o("i18n")("ticket.notification.link.message",t.length),hide:1e4})})})})}})},s.ignoreandDismiss=function(){return a.modal({title:t.getLocalizedString("impact.analysis.dismiss.modal.title"),text:t.getLocalizedString("impact.analysis.dismiss.modal.text"),buttons:[{text:t.getLocalizedString("common.button.yes"),data:!0},{text:t.getLocalizedString("common.button.no"),data:!1}]}).result.then(function(e){e&&s.dismiss()})},s.cancelImpactAnalysis=function(){return a.modal({title:t.getLocalizedString("impact.analysis.cancel.modal.title"),text:t.getLocalizedString("impact.analysis.cancel.modal.text"),buttons:[{text:t.getLocalizedString("common.button.yes"),data:!0},{text:t.getLocalizedString("common.button.no"),data:!1}]}).result.then(function(e){if(e){s.loading=!0;var t={command:"cancel"};n.impactAnalysisAction(s.context.id,EntityVO.TYPE_CHANGE,t).then(function(){s.context.hasImpactAnalysis=!1,s.loading=!1})}})},s.dismiss=function(){s.loading=!0;var e={command:"dismiss"};n.impactAnalysisAction(s.context.id,EntityVO.TYPE_CHANGE,e).then(function(){s.context.hasImpactAnalysis=!1,s.loading=!1})}}}}])}(),AssessmentQuestionVO.prototype=new BaseVO,AssessmentQuestionVO.prototype.constructor=AssessmentQuestionVO,AssessmentQuestionVO.prototype.getProps=function(){return BaseVO.prototype.getProps().concat("questionId","text","isDefault","desirableAnswer","weight","actionLabel","actionType","textMap","isVisible")},AssessmentQuestionVO.prototype.getAnswer=function(){return{questionId:this.id,answer:this.desirableAnswer}},AssessmentQuestionVO.prototype.deleteItem=function(){this["delete"]=!0},AssessmentQuestionVO.prototype.openItem=function(){this.isOpen=!0},AssessmentQuestionVO.prototype.closeItem=function(){this.isOpen=!1},AssessmentQuestionVO.prototype.removeLabel=function(e){delete this.textMap[e]},function(){angular.module("knowledgeArticleModule").directive("decisionTreeDescription",["$compile",function(e){return{restrict:"A",scope:{rxConfiguration:"="},link:function(e,t){e.$watch("rxConfiguration",function(){t.html(e.rxConfiguration&&e.rxConfiguration.description);var a,n=t.find("a");for(a=0;a<n.length;a++){var i=n.eq(a),o=i.next();o[0]&&"IMG"===o[0].nodeName&&i.remove()}for(var r=t.find("img"),s=0;s<r.length;s++){var l=r.eq(s);l.attr("image-toggle","")}})}}}])}(),function(){angular.module("knowledgeArticleModule").directive("decisionTreeView",function(){return{restrict:"E",templateUrl:"views/knowledge-article/decision-tree-view.html",scope:{rxConfiguration:"="},link:function(e){e.decisionTree=e.rxConfiguration.decisionTree,e.isRootView=!1,e.isChoiceView=!1,e.isChoiceListView=!0,e.isHistoryView=!1,e.isBackButton=!0,e.isForwardButton=!0,e.historyList=[];var t=0,a=!1,n=[],i=function(e,t,a,n){t||(t="id"),a||(a="0"),n||(n=[]);var o=Object.keys(e);return o.forEach(function(o){"object"==typeof e[o]?n=i(e[o],t,a,n):e[o]==a&&o==t&&n.push(e)}),n},o=function(t){e.isRootView=!1,e.isChoiceView=!0;var a=n[t];e.choiceQuestion=a,a.choice?(e.isChoiceListView=!0,e.choices=i(e.decisionTree,"id",a.id)[0].choice):e.isChoiceListView=!1};e.showResetData=function(){e.historyList=[],n=[],e.getRootData(),a=!1,t=0,e.isBackButton=!0,e.isForwardButton=!0},e.getRootData=function(){e.isRootView=!0,e.isChoiceView=!1,e.isChoiceListView=!0,e.rootQuestion=i(e.decisionTree,"id",0)[0],e.choices=i(e.decisionTree,"id",0)[0].choice},e.showHistoryForwardData=function(){t++,e.isBackButton=!1,t<n.length-1?o(t):(o(t),e.isForwardButton=!0)},e.showHistoryBackData=function(){t--,a=!0,e.isForwardButton=!1,t>=0?o(t):(e.isBackButton=!0,a=!0,e.getRootData(),t=-1)},e.getRootData(),e.getChoices=function(o){e.isRootView=!1,e.isChoiceView=!0,e.isBackButton=!1,e.historyList.length&&(e.historyList=_.take(e.historyList,t+1)),e.historyList.push(o);var r=_.find(n,o);r||(n.length&&(n=_.take(n,t+1)),n.push(o)),a&&(t===-1?(n=[],t=0,n[0]=o):n.splice(t+2),a=!1,e.isForwardButton=!0),t=n.length-1,e.choiceQuestion=o,o.gotoNode?(e.choiceGoto=o,e.choices=i(e.decisionTree,"id",o.gotoNode)[0].choice,e.choiceQuestion=i(e.decisionTree,"id",o.gotoNode)[0],e.historyList[t]=n[t]=e.choiceQuestion):o.choice?e.choices=i(e.decisionTree,"id",o.id)[0].choice:e.isChoiceListView=!1},e.toggleHistory=function(){e.isHistoryView=!e.isHistoryView}}}})}(),function(){angular.module("knowledgeArticleModule").directive("editKnowledgeArticle",["$window","$modal","configurationModel","$filter","systemAlertService",function(e,t,a,n,i){return{restrict:"E",templateUrl:"views/knowledge-article/edit-knowledge-article.html",scope:{article:"=",styles:"="},link:function(o,r,s){function l(e){e.editor.on("simpleuploads.startUpload",function(t){var a,n=!1;t&&t.data&&t.data.mode&&"base64paste"===t.data.mode.type&&"pastedFile"===u&&p?(a=(new Date).getTime()-p,u="",p=0,a<200&&(n=!0)):t&&t.data&&t.data.mode&&"pastedFile"===t.data.mode.type&&(u="pastedFile",p=(new Date).getTime()),n?t.cancel&&t.cancel():(g++,c(e.editor,t))}),e.editor.on("simpleuploads.endUpload",function(e){g--}),e.editor.on("simpleuploads.finishedUpload",function(e){e.editor.setData(e.editor.getData())})}function c(e,t){var a=e.config&&e.config.embeddedImageLimit;if(a){var o=document.createElement("div");o.innerHTML=e&&e.getData(!0);var r=o.querySelectorAll('img[src*="/smartit/rest/"]'),s=_.uniqBy(r,"src"),l=s.length;l+g>a&&(g--,i.error({text:n("i18n")("ka.ckeditor.imageLimitExceeded",[e.config.title||t.editor.title||"",a]),clear:!0}),t.cancel&&t.cancel())}}function d(e){var t=e.data.name,i=e.data.definition;"image"===t&&(e.editor.isFileExtensionAllowed=a.isFileExtensionAllowed,e.editor.uploadImageExtensionError=n("i18n")("attachment.fileExtension.error")),"link"===t&&i.getContents("info").get("protocol").items.splice(4,1)}var u,p,m=["PageBreak"],f=["chkResponsive","chkNoEmbed","chkRelated","chkOlderCode","chkPrivacy","chkAutoplay","txtStartAt","chkControls","txtEmbed"],g=0;a.get("ckEditorSource").enabled&&(m.push("Sourcedialog"),f.pop()),e.myitsmLocale="zh"===e.myitsmLocale?"zh-cn":e.myitsmLocale;var h={language:e.myitsmLocale,toolbar_full:[{name:"basicstyles",items:["Bold","Italic","Underline","Strike"]},{name:"editing",items:["JustifyLeft","JustifyCenter","JustifyRight","JustifyBlock"]},{name:"links",items:["Link","Unlink","Anchor","Kalink"]},{name:"paragraph",items:["BulletedList","NumberedList","Outdent","Indent","Blockquote"]},{name:"insert",items:["Image","Table","Youtube"]},"/",{name:"styles",items:["Format","FontSize","TextColor","PasteText","PasteFromWord","RemoveFormat"]},{name:"clipboard",items:["Undo","Redo"]},{name:"document",items:m},{name:"editing",items:["Find","Replace","-","SelectAll","-"]},{name:"c_maximize",items:["c_maximize"]}],toolbar_merge:[{name:"basicstyles",items:["Bold","Italic","Underline","Strike"]},{name:"editing",items:["JustifyLeft","JustifyCenter","JustifyRight","JustifyBlock"]},{name:"paragraph",items:["BulletedList","NumberedList","Outdent","Indent","Blockquote"]},{name:"styles",items:["Format","FontSize","TextColor"]}],toolbar:s.toolbar||"full",sharedSpaces:{top:"ckeditor-top-bar",bottom:"ckeditor-bottom-bar"},extraPlugins:"youtube,kalink,c_maximize,sourcedialog,simpleuploads",allowedContent:!0,removePlugins:"iframe",format_tags:"p;h1;h2;h3;h4;h5;h6;pre;address",contentsCss:"scripts/ckeditor/drop-down-override.css",simpleuploads_respectDialogUploads:!0,youtube_disabled_fields:f};if(s.readOnly&&(h.readOnly=o.$eval(s.readOnly)),o.styles){var y=_.reject(o.styles,"userStyle"),E=_.filter(o.styles,"userStyle"),v={},T=[];if(_.forEach(y,function(e){v["format_"+e.element]={element:e.element,attributes:{style:e.styles}}}),angular.extend(h,v),E.length){_.forEach(E,function(e){T.push({name:e.type,element:e.element,attributes:{style:e.styles}})}),h.stylesSet=T;var S=_.find(h.toolbar_full,{name:"styles"});S.items.splice(1,0,"Styles")}}o.editorOptions=h,o.openSearchArticleModal=function(e){var a=t.open({templateUrl:"views/knowledge-article/insert-link-article-search-modal.html",controller:["$scope","searchService",function(e,t){var a={searching:!1,searchText:"",selectedArticle:null};e.searchArticle=function(){a.searching=!0,a.selectedArticle=null;var n={search_text:a.searchText},i={types:["knowledge"]};return t.getGlobalSearchResults(n,i).then(function(t){e.searchResults=t.items[0].results})["finally"](function(){a.searching=!1})},e.state=a}],windowClass:"modal-ka-finder",backdropClass:"backdrop-ka-finder",keyboard:!1});a.result.then(function(t){$("#"+e).val(t.displayId)})},o.handleSectionLabelClick=function(e){$(e.target).next().find(".ka-ckeditor__section-content").focus()},CKEDITOR.on("instanceReady",l),CKEDITOR.on("dialogDefinition",d),o.$on("$destroy",function(){CKEDITOR.removeListener("instanceReady",l),CKEDITOR.removeListener("dialogDefinition",d)})}}}])}(),function(){angular.module("knowledgeArticleModule").directive("editKnowledgeArticleSection",["localStorageService",function(e){return{restrict:"E",template:'<div ux-id="edit-ka-section-snippet" ckeditor="editorOptions" ng-model="section.snippet" class="ka-ckeditor__section-content clearfix" ng-if="state.ready"></div>',scope:{options:"=",section:"=",articleUuid:"@"},link:function(t,a,n){if(t.state={ready:!1},n.ignoreSectionOptions&&t.$eval(n.ignoreSectionOptions))t.editorOptions=t.options;else{var i={title:t.section.label,embeddedImageLimit:t.section.embeddedImageLimit,filebrowserImageUploadUrl:"/smartit/rest/attachment/user/"+encodeURIComponent(e.get("user.userId"))+"/"+t.articleUuid+"?section="+encodeURIComponent(t.section.name)};t.editorOptions=angular.extend({},t.options,i)}t.state.ready=!0}}}])}(),function(){angular.module("knowledgeArticleModule").directive("fixCkeditorTopBar",["$timeout",function(e){return{restrict:"A",link:function(t,a){function n(){e(function(){var e=Math.floor(l-a.scrollTop()),t=a.scrollTop();e>0&&r.hasClass(d)?(console.log("making top bar normal"),r.removeClass(d).addClass(c).css("top","auto").width("auto"),r.next().css("margin-top",0),a.scrollTop(t)):e<=0&&r.hasClass(c)&&(console.log("making top bar fixed"),r.removeClass(c).addClass(d).css("top",u.top-p.top+"px").width(s.outerWidth()),r.next().css("margin-top",r.height()),a.scrollTop(t))},0)}function i(){if(r.hasClass(d)){var e=!0;r.removeClass(d).addClass(c)}l=r.offset().top+a.scrollTop()-u.top,e&&r.removeClass(c).addClass(d)}var o,r,s,l,c="ka-ckeditor__top-bar",d="ka-ckeditor__top-bar_fixed",u=a.offset(),p=a.parents(".modal-content").offset()||{top:0};a.css("overflow-y","hidden"),t.$on("ckeditor.ready",function(){o||(a.css("overflow-y","auto"),r=a.find("."+c),s=r.parent(),i())}),t.$watch("state.similarArticles",function(){r&&e(i,0)}),t.$watch("state.showSimilarArticles",function(){r&&e(i,0)}),a.on("scroll",n),t.$on("$destroy",function(){console.log("fixCkeditorTopBar: unbind events"),a.off("scroll",n),a.off()})}}}])}(),function(){angular.module("knowledgeArticleModule").directive("kaMetadataDirective",function(){return{restrict:"E",templateUrl:"views/knowledge-article/knowledge-article-metadata.html",scope:{article:"=",editMode:"="},controller:["$scope","$rootScope","knowledgeArticleModel","ticketActionService","searchService","events","metadataModel","categoriesService","$q","$timeout","userModel","systemAlertService","$filter","searchModel","ticketModel","utilityFunctions",function(e,t,a,n,i,o,r,s,l,c,d,u,p,m,f,g){function h(e){return e.allCompanies?_.find(e.allCompanies,function(e){return e.primary}):e.company}function y(t,a){var i=e.article,o=angular.extend({},{ghostEntity:!0},i);o.customer=i.author,n.showAssignDialog(o,!0,a).result.then(function(e){e.autoAssign?i.autoAssign=!0:(i.autoAssign=!1,e.assignee&&(i.assignee=e.assignee),e.group&&(i.assigneeGroup=e.group)),t.currentTarget.focus()},function(){t.currentTarget.focus()})}function E(t){e.article.assignee={id:t.id,loginId:t.loginId,fullName:t.fullName,thumbnailMime:t.thumbnailMime,thumbnail:t.thumbnail,organization:t.organization},e.article.assigneeGroup={id:t.supportGroupId,name:t.supportGroup,organization:t.organization,company:t.company}}function v(){_.forEach(R,function(t){_.forEach(e.article[t],function(e){e.primary=!1})})}function T(){O(),e.articleCopy=_.cloneDeep(e.article),t.timezone&&e.article.nextReviewDate&&(e.article.nextReviewDate=g.convertToLocalTimezone(e.article.nextReviewDate,t.timezone)),D.selectedLanguage=_.find(e.languages,{name:e.article.language}),e.$emit(o.TOGGLE_KNOWLEDGE_ARTICLE_EDIT_MODE),A()}function S(){angular.extend(e.article,e.articleCopy)}function C(){e.availiableCompanies=_.filter(k,function(e){return!_.find(b,{name:e.name})})}function O(){return b=e.article.allCompanies,e.userCompany=d.userFullData.company,m.getOperatingCompanies(null,-1).then(function(e){k=[{name:"All"}].concat(_.cloneDeep(e.companies)),D.tooManyCompanies=e.exceedsChunkSize,C()})}function A(){if(!e.article.isDraft){D.dataIsLoading=!0;var t={company:e.state.primaryCompany,site:_.reject(e.article.allSites,"companyName"),organization:_.reject(e.article.allOrganizations,"companyName"),categories:_.reject(s.collectValues(e.article.categoriesSet,e.article),function(e){return e.company&&"All"===e.company.name})};return t.site.length||t.organization.length||t.categories.length?void a.getPotentialPrimary(t).then(function(a){var n={site:a.site,organization:a.organization};_.forIn(n,function(e,a){_.forEach(e,function(e,n){e.isPrimary&&(t[a][n].companyName=t.company.name)})}),_.forEach(a.categories,function(a,n){a.isPrimary&&(e.article.categoriesSet[n].company={name:t.company.name})})})["finally"](function(){D.dataIsLoading=!1}):void(D.dataIsLoading=!1)}}var I,b,k,D={dataIsLoading:!0,loadSite:!1,loadOrganization:!1,loadService:!1,tooManyCompanies:!1,exceedsChunkSizeService:!1,isTooltipOpenService:!1,tag:"",site:"",organization:"",service:"",primaryCompany:e.article.company,selectedLanguage:{}},R=["allSites","allOrganizations","allServices","categoriesSet"];e.loggedInUserId=d.userId,e.reviewDate={opened:!1},e.currentDate=new Date,e.foundationOptions={site:{company:{visible:!1},region:{connected:"company"}},organization:{company:{visible:!1},organization:{connected:"company"}}},e.article.supportGroup&&(e.article.assigneeGroup=e.article.supportGroup),l.all([d.getUserDataForCurrentSession(),r.getMetadataByType(EntityVO.TYPE_KNOWLEDGE)]).then(function(t){return I=t[1],e.languages=I.languages,O()})["finally"](function(){D.dataIsLoading=!1}),e.selectLanguage=function(t){e.article.language=t.name},e.assign=function(e){y(e)},e.assignToMe=function(t,a){var n="",i=e.article.supportGroup,o=e.article.owner.company?e.article.owner.company.name:"",r=e.article.author.company?e.article.author.company.name:"",s=h(e.article);s=s?s.name:"",f.getTicketAssigneePersonsBySearchText(n,null,null,o,s,r).then(function(e){e=_.uniqBy(e.results,function(e){return e.loginId&&e.supportGroupId});var n=1===e.length?e[0]:_.find(e,{supportGroupId:i.id});n&&n.loginId?E(n):y(t,a)})},e.addTag=function(t,a){_.find(a,t)?console.warn("should not be 2 similar tags"):(a.push(t),t.product&&t.product.categorizations&&t.product.categorizations[0]&&!_.isEmpty(t.product.categorizations[0].tiers)&&e.article.accessMappings&&e.article.accessMappings.categorizationEditAllowed&&e.$emit(o.AFFECTED_SERVICE_UPDATED,t),1!==a.length||"All"!==t.company.name&&t.company.name!==e.state.primaryCompany.name||e.setPrimaryBusinessService(t))},e.addKeyword=function(){_.forEach(D.tag.split(","),function(t){t.trim()&&_.indexOf(e.article.tags,t.trim())===-1&&e.article.tags.push(t.trim())}),D.tag=""},e.removeTag=function(e,t){_.pull(t,e)},e.setPrimaryTag=function(t,a){if(t.company&&t.company.name===e.state.primaryCompany.name||t.companyName===e.state.primaryCompany.name){var n=_.find(a,"primary");t.primary=!0,n&&(n.primary=!n.primary)}},e.onServiceFocusBlur=function(){e.state.isTooltipOpenService=!1},e.setPrimaryBusinessService=function(t){_.forEach(e.article.allServices,function(e){e.primary=e.reconciliationId===t.reconciliationId;
})},e.$on(o.SAVE_CHANGES,function(){e.$emit(o.SAVE_CHANGES_REQUEST,null,!0),e.article.allCategories=s.collectValues(e.article.categoriesSet,e.article),s.clearDirtyValues(e.article.categoriesSet),t.timezone&&e.article.nextReviewDate&&(e.article.nextReviewDate=g.convertToUserPreferenceTimezone(e.article.nextReviewDate,t.timezone)),a.updateArticleMetadata(e.article,e.articleCopy).then(function(t){angular.extend(e.article,t),e.$emit(o.TICKET_PROFILE_RESEND_EVENT,{eventName:o.UPDATE_CONTEXT_ON_REFRESH,eventData:e.article}),r.getMetadataByType(EntityVO.TYPE_KNOWLEDGE).then(function(t){e.article.categoriesControls=_.cloneDeep(s.populateCategories(e.article.defaultCategorization,t)),e.article.categoriesSet=_.cloneDeep(s.populateMultipleCategories(e.article.allCategories,t))})})["catch"](function(e){u.error({text:e.data.defaultMessage||(e.data.errorCode?p("i18n")("error.unknown"):e.data.error)})})["finally"](function(){e.$emit(o.SAVE_CHANGES_COMPLETE)})}),e.$on(o.TOGGLE_EDIT_MODE,T),e.$on(o.DISCARD_CHANGES,S),!e.article.isDraft&&e.$on("$destroy",function(){e.editMode&&S()}),e.state=D,e.searchService=i,e.getCompaniesByName=function(e){return m.getCompaniesByText(e).then(function(e){var t;return t=_.filter(e.companies,function(e){return!_.find(b,{name:e.name})}),{list:t,exceedsChunkSize:e.exceedsChunkSize}})},e.getServicesByText=function(t,a){return i.getListObjOfServiceByText(t,a).then(function(t){return e.state.exceedsChunkSizeService=t.exceedsChunkSize,e.state.isTooltipOpenService=t.exceedsChunkSize,e.state.isTooltipOpenService&&c(function(){e.state.isTooltipOpenService=!1},1e4),t.list})},e.addCompany=function(e){b.push(e),C()},e.$on(o.FOUNDATION_ADD,function(t,a){(a.department||a.organization)&&1===e.article.allOrganizations.length?e.setPrimaryTag(a,e.article.allOrganizations):a.siteId&&1===e.article.allSites.length&&e.setPrimaryTag(a,e.article.allSites)}),e.removeCompany=function(e,t){_.remove(b,{name:e.name}),C(),t.stopPropagation()},e.setPrimaryCompany=function(t){_.forEach(b,function(e){e.primary=e.name===t.name}),e.state.primaryCompany.name!==t.name&&(e.state.primaryCompany=t,v(),A())},e.buildSiteTag=function(e){var t=e.siteGroup?" > "+e.siteGroup:"",a=e.name?" > "+e.name:"",n=e.region?e.region:"";return n+t+a},e.buildOrganizationTag=function(e){var t=e.department?" > "+e.department:"";return e.organization+t},e.prepareOrganization=function(e){return{organization:e.name}},e.openNextReviewDate=function(t){t.preventDefault(),t.stopPropagation(),e.reviewDate.opened=!0};var P=!1;e.$on(o.REFRESH_RESOURCE_FEED,function(){D.dataIsLoading=!0,P=!0}),e.$on(o.REFRESH_KA_META,function(t,a){P&&(P=!1,e.article=a.article,l.all([d.getUserDataForCurrentSession(),r.getMetadataByType(EntityVO.TYPE_KNOWLEDGE)]).then(function(t){return I=t[1],e.languages=I.languages,O()})["finally"](function(){D.dataIsLoading=!1}))})}]}})}(),function(){angular.module("knowledgeArticleModule").directive("kaVisibilityDirective",["knowledgeArticleModel","configurationModel","$timeout","$filter","userModel","localStorageService","searchModel",function(e,t,a,n,i,o,r){return{restrict:"E",templateUrl:"views/knowledge-article/knowledge-article-visibility.html",scope:{article:"=",company:"="},link:function(i,s){function l(){return o.get(m)}function c(){var e=t.get("knowledgeArticle.visibilities");if(!d.articleVisibilityGroup.length)return null;if(1===d.articleVisibilityGroup.length){var a=_.pick(d.articleVisibilityGroup[0],["visibilityGroupName","company"]);if(_.find(p.everyone(),a))return _.find(e,{value:"everyone"});if(_.find(p.myCompany(),a))return _.find(e,{value:"myCompany"})}return _.find(e,{value:"specificGroup"})}var d=i.article,u={loadVisibility:!1,visibilitySet:t.get("knowledgeArticle.visibilities"),selectedVisibilitySetItem:null,tooManyCompanies:!1,tooManyVisibilityGroups:!1,visibilityCompanies:[],selectedVisibilityCompany:null,visibilities:[],selectedVisibility:null,specificGroupCache:[]},p={everyone:function(){return[{visibilityGroupName:"ALL",company:"All",visibilityGroupId:"0"}]},myCompany:function(){return[{visibilityGroupName:"ALL",company:i.company.name,visibilityGroupId:"0"}]},lastGroupSet:function(){return l()},specificGroup:function(){return u.specificGroupCache}},m="LAST_SET_OF_VISIBILITY_GROUPS";r.getOperatingCompanies(null,-1).then(function(e){u.visibilityCompanies=angular.extend([],e.companies),u.tooManyCompanies=e.exceedsChunkSize,u.visibilityCompanies.forEach(function(e,t){e.label=e.name,u.visibilityCompanies[t]=e}),u.visibilityCompanies.unshift({name:"ALL",label:n("i18n")("ka.company.all")})}),_.find(u.visibilitySet,{value:"myCompany"}).subLabel=i.company.name,i.handleKeydown=function(e){if(27===e.keyCode){var t=s.find(".dropdown-toggle");a(function(){t.trigger("click"),t.focus()},0),e.stopPropagation()}},i.visibilitySelected=function(e){u.selectedVisibilitySetItem&&"specificGroup"===u.selectedVisibilitySetItem.value&&(u.specificGroupCache=_.cloneDeep(d.articleVisibilityGroup)),u.selectedVisibilitySetItem=e,a(function(){d.articleVisibilityGroup=p[u.selectedVisibilitySetItem.value](),i.state.isOpen&&(i.state.isOpen=!1);var e=s.find(".dropdown-toggle");e.focus()},0)},i.getCompaniesByName=function(e){return r.getCompaniesByText(e).then(function(e){return{list:e.companies,exceedsChunkSize:e.exceedsChunkSize}})},i.getVisibilityGroupsByName=function(t){return e.getVisibilityGroupsByText(u.selectedVisibilityCompany.name,t)},i.loadVisibilityByCompanyName=function(t){return u.visibilities=[],u.loadVisibility=!0,e.getVisibilityByCompanyName(t).then(function(e){u.visibilities=e,e.length>=r.supportGroupChunkSize?u.tooManyVisibilityGroups=!0:u.tooManyVisibilityGroups=!1})["finally"](function(){u.loadVisibility=!1})},i.addVisibility=function(){var e={company:u.selectedVisibilityCompany.name,visibilityGroupName:u.selectedVisibility.visibilityGroupName,visibilityGroupId:u.selectedVisibility.visibilityGroupId},t=d.articleVisibilityGroup;_.find(t,e)||t.push(e),u.selectedVisibility=null,u.selectedVisibilityCompany=null},i.isAddButtonDisabled=function(){return!u.selectedVisibility||_.filter(d.articleVisibilityGroup,{company:u.selectedVisibilityCompany.name,visibilityGroupName:u.selectedVisibility.visibilityGroupName}).length},i.removeVisibility=function(e){_.pull(d.articleVisibilityGroup,e)},i.focusAddButton=function(){u.selectedVisibilityCompany&&u.selectedVisibility&&a(function(){s.find(".ka-metadata-specific-section__button").focus()})},u.selectedVisibilitySetItem=c(),i.$watch("state.selectedVisibilityCompany",function(){u.selectedVisibility=null},!0),i.state=u}}}])}(),function(){angular.module("knowledgeArticleModule").controller("KnowledgeArticleAssessmentController",["$scope","userModel","knowledgeArticleModel","systemAlertService","events","$timeout",function(e,t,a,n,i,o){e.assessmentQuestionsList=[],e.dataIsLoading=!1,e.showMetadataPreview=!1,e.metadataQuestion=[],e.duplicateArticlesList=[],e.getAssessmentQuestions=function(){return e.dataIsLoading=!0,e.article.author.company||(e.article.author.company={name:null}),a.getAssessmentQuestions(e.article.author.company.name,e.article.author.organization).then(function(t){e.assessmentQuestionsList=t})["catch"](function(e){n.error({text:e.data.error,clear:!1})})["finally"](function(){e.dataIsLoading=!1})},e.submitAnswers=function(){e.dataIsLoading=!0;var t=[];_.each(e.assessmentQuestionsList,function(e){t.push(e.getAnswer())}),a.submitAssessment(e.articleId,t).then(function(t){e.dataIsLoading=!1,e.exitAssessmentMode(),o(function(){n.success({text:t.message,clear:!0,hide:1e4})},100)})["catch"](function(e){n.error({text:e.data.error,clear:!1})})["finally"](function(){e.dataIsLoading=!1})},e.toggleMetadataView=function(t,a){return e.showMetadataPreview=t,t?void e.metadataQuestion.push(a):void(e.metadataQuestion.length=0)},e.handleActionBtnClick=function(t,a){switch(t){case"CHECK_DUPLICATE":e.$emit(i.TOGGLE_CHECK_DUPLICATE_MODE,!0);break;case"CHECK_METADATA":e.toggleMetadataView(!0,a.currentContext);break;case"REMOVE_DUPLICATES":e.$broadcast(i.ASSESSMENT_REMOVE_DUPLICATES)}},e.$on(i.DUPLICATE_ARTICLE_FOUND,function(t,a){var n=_.find(e.assessmentQuestionsList,{actionType:"CHECK_DUPLICATE"});e.duplicateArticlesList=a,n.desirableAnswer=!_.isEmpty(a)}),e.getAssessmentQuestions()}])}(),function(){angular.module("knowledgeArticleModule").controller("KnowledgeArticleController",["$scope","knowledgeArticleModel","$stateParams","$state","followService","favoriteService","ticketActionService","events","metadataModel","categoriesService","$q","$interval","$filter","systemAlertService","$modal","$timeout","i18nService","configurationModel","knowledgeArticleService","$window","$rootScope",function(e,t,a,n,i,o,r,s,l,c,d,u,p,m,f,g,h,y,E,v,T){function S(){var t=y.get("moreActions.knowledge");e.dropDownOptions={actions:t,registeredCallbacks:e.moreDropDownActionsCallbackFuncns}}function C(){e.alertDetails={alertItems:[]};var t=[];e.article.flagged||e.isFullVersion&&e.article.isInApproval?(e.hasAlerts=!0,e.isFullVersion&&e.article.isInApproval&&(e.alertDetails.alertItems.push("approval_banner"),t.push(h.getLocalizedString("alert.heading.approvalBanner"))),e.article.flagged&&(e.alertDetails.alertItems.push("flagged_article"),t.push(h.getLocalizedString("alert.heading.flaggedArticle")))):e.hasAlerts=!1,e.alertDetails.alertHeading=t.join(", ")}function O(){var e=V.autoSavedContent[0].modifiedDate;return m.modal({type:"info",title:p("i18n")("knowledge.autoSaveCopy.modal.title"),text:p("i18n")("knowledge.autoSaveCopy.modal.text",[p("date")(e,"shortTime"),p("date")(e,"MMMM d")]),buttons:[{text:p("i18n")("knowledge.autoSaveCopy.modal.continue"),data:!0},{text:p("i18n")("knowledge.autoSaveCopy.modal.discard"),data:!1}]})}function A(a){var n=t.checkEditStatus(e.articleId),i=t.getKnowledgeArticleTemplates();return e.$emit(s.KNOWLEDGE_ARTICLE_GETTING_EDIT_STATUS,e.state.gettingEditStatus=!0),e.$emit(s.TOGGLE_KNOWLEDGE_ARTICLE_EDIT_MODE),d.all([n,i]).then(function(t){var n=t[0],i=t[1];V.styles=_.find(i,{name:e.article.templateName}).templateObject.styles,n.inEdit?(e.$emit(s.TOGGLE_KNOWLEDGE_ARTICLE_EDIT_MODE),m.info({title:p("i18n")("knowledge.edit.reject.modal.title"),text:p("i18n")("knowledge.edit.reject.modal.text",n.user.firstName+" "+n.user.lastName),hide:1e4})):I(a)})["catch"](function(){e.$emit(s.TOGGLE_KNOWLEDGE_ARTICLE_EDIT_MODE)})["finally"](function(){e.$emit(s.KNOWLEDGE_ARTICLE_GETTING_EDIT_STATUS,e.state.gettingEditStatus=!1),e.isFullVersion?e.$emit(s.KNOWLEDGE_ARTICLE_LOADED,{article:e.article,isEditMode:!0}):e.$emit(s.KNOWLEDGE_ARTICLE_PREVIEW_LOADED,{article:e.article})})}function I(t){e.editMode=!0,e.editArticle=_.cloneDeep(e.article),t&&_.merge(e.editArticle.content,V.autoSavedContent),n.params.content&&angular.extend(e.editArticle.content,n.params.content),b(),V.autoSavingInterval=u(b,6e4)}function b(){t.autoSave(e.editArticle).then(function(e){V.autoSavedContent=e})}function k(){return m.modal({type:"info",title:p("i18n")("knowledge.deleteAutoSaveCopy.modal.title"),text:p("i18n")("knowledge.deleteAutoSaveCopy.modal.text"),buttons:[{text:p("i18n")("common.button.yes"),data:!0},{text:p("i18n")("common.button.no"),data:!1}]}).result.then(function(e){e?b():R()})}function D(){return m.modal({type:"info",title:p("i18n")("knowledge.deleteAutoSaveCopy.modal.title"),text:p("i18n")("knowledge.updateCancelledVersion.modal.text"),buttons:[{text:p("i18n")("common.button.yes"),data:!0},{text:p("i18n")("common.button.no"),data:!1}]}).result.then(function(e){return!!e&&void P()})}function R(){t.removeAutoSavedCopy(e.article.uuid),V.autoSavedContent.length=0}function P(){M.dataIsLoading=!0,t.update(e.editArticle,V.isMinorEdit,e.article.revisions).then(function(t){e.editMode=!1,e.$emit(s.TOGGLE_KNOWLEDGE_ARTICLE_EDIT_MODE),V.isMinorEdit?t.content&&(e.article.content=t.content):n.go("knowledge",{id:t.uuid,editMode:!1})})["catch"](function(e){m.error({text:e.data.defaultMessage||(e.data.errorCode?p("i18n")("error.unknown"):e.data.error)})})["finally"](function(){M.dataIsLoading=!1,e.$emit(s.TICKET_PROFILE_RESEND_EVENT,{eventName:s.REFRESH_ACTIVITY_FEED})})}function w(){var t=e.articleId;E.getLatestVersionId(e.articleId).then(function(e){e&&e.id&&(t=e.id),n.go("knowledge",{id:t},{location:"replace"})})}function L(){e.state.dataIsLoading=!0}function N(){e.state.dataIsLoading=!1}"knowledgePreview"===n.current.name?(e.articleId=a.id,e.isFullVersion=!1,T.hasParent=!0,T.hideNavigationBar=!0):e.isFullVersion=!0,e.defaultArticle=a.articleId,e.rxDecisionTreeConfig={decisionTree:{}},e.editMode=!1,e.isUnflagEditAllowed=!1,e.article={},e.dropDownOptions={},e.errorMessage=p("i18n")("ka.notFound"),e.isTitleMultiline=!1,e.titleMaxLength=4e3,e.titleRegExp=new RegExp(/.{1,5}/g);var M={dataIsLoading:!1,currentRevision:null,gettingEditStatus:!1,updatingFollowingFlag:!1,updatingFavoriteFlag:!1},V={isMinorEdit:!0,autoSavedContent:[],autoSavingInterval:null,styles:[]};e.viewFullArticle=function(t){if(t.preventDefault(),e.$parent.$parent.newTab){var a=n.href("knowledge",{id:e.article.id,preventIncrement:!0});v.open(a,"_blank")}else if(T.hasParent){var a=n.href("knowledge",{id:e.article.id,preventIncrement:!0});v.open(a,"_top")}else n.go("knowledge",{id:e.article.id,preventIncrement:!0})},e.getArticle=function(a,i,o){if(a){if(e.getLatestVersion)return M.dataIsLoading=!0,void w();var r=t.getKnowledgeArticleById(a,i,o),u=t.getArticleRevisionsById(a,!0),m=_.isEmpty(V.autoSavedContent)?t.getAutoSavedCopy(a):d.when(V.autoSavedContent),f=l.getMetadataByType(EntityVO.TYPE_KNOWLEDGE),g=l.getMetadataByType(EntityVO.TYPE_GLOBAL);M.dataIsLoading=!0,d.all([r,u,m,f,g]).then(function(t){var a=t[3],i=t[4];return e.article=t[0],e.article.revisions=t[1],V.autoSavedContent=t[2],e.knowledgeAnchorParser=i.configurationParameters.knowledgeAnchorParser,M.currentRevision=_.find(e.article.revisions,{id:e.article.id}),e.article.categoriesControls=_.cloneDeep(c.populateCategories(e.article.defaultCategorization,a)),e.article.categoriesSet=_.cloneDeep(c.populateMultipleCategories(e.article.allCategories,a)),n.params.editMode?A():(e.article.perfAssessment&&S(),e.article.isDecisionTree()&&(e.rxDecisionTreeConfig.decisionTree=e.article.decisionTree),C(),e.isFullVersion?e.$emit(s.KNOWLEDGE_ARTICLE_LOADED,{article:e.article}):e.$emit(s.KNOWLEDGE_ARTICLE_PREVIEW_LOADED,{article:e.article}),void("knowledgePreview"===n.current.name&&$(document).ready(function(){$('a[target!="_blank"]').attr("target","_top")})))})["catch"](function(t){t&&t.data&&t.data.defaultMessage?e.errorMessage=t.data.defaultMessage:e.errorMessage=p("i18n")("ka.notFound")})["finally"](function(){M.dataIsLoading=!1})}},e.refreshTicket=function(){e.getArticle(e.article.id,!0,!0),e.$emit(s.REFRESH_TICKET,{isRefreshTicket:!0})},e.openArticleRevision=function(e){"knowledgePreview"===n.current.name?n.go("knowledgePreview",{id:e.id,editMode:!1}):n.go("knowledge",{id:e.id,editMode:!1})},e.share=function(t){r.showShareDialog(e.article).result["finally"](function(){t.currentTarget.focus()})},e.toggleFollowingFlag=function(){M.updatingFollowingFlag=!0;var t=e.article.following?i.unfollow:i.follow;t(e.article).then(function(){e.article.following=!e.article.following})["finally"](function(){M.updatingFollowingFlag=!1})},e.toggleFavoriteFlag=function(){M.updatingFavoriteFlag=!0;var t=e.article.favorite?o.removeFavorite:o.addFavorite;t(e.article).then(function(){e.article.favorite=!e.article.favorite})["finally"](function(){M.updatingFavoriteFlag=!1})},e.handleEditClick=function(){return e.article.accessMappings.detailsEditAllowed?void(e.article.isLastVersion||"Published"!==e.article.status.value?V.autoSavedContent.length?O().result.then(A):A():m.warning({title:p("i18n")("knowledge.edit.reject.modal.title"),text:p("i18n")("knowledge.edit.reject.modal.draft.text"),hide:1e4})):(m.warning({text:p("i18n")("knowledge.edit.reject.no.permission"),clear:!0,hide:1e4}),!1)},e.moreDropDownActionsCallbackFuncns={startAssessment:function(){e.setAssessFromFullArticle(!0),e.setKcsAssessMode(!0)}},e.editExistingDraft=function(){n.go("knowledge",{id:_.last(e.article.revisions).id,editMode:!0})},e.cancelEditing=function(){u.cancel(V.autoSavingInterval);var t=V.autoSavedContent.length?k():d.when(1);t["finally"](function(){e.editMode=!1,e.$emit(s.TOGGLE_KNOWLEDGE_ARTICLE_EDIT_MODE)})},e.update=function(){u.cancel(V.autoSavingInterval),V.autoSavedContent.length&&R(),e.editArticle.title=e.editArticle.title.replace(/\u00a0/g," ");var t=e.editArticle.revisions.reduce(function(e,t){return e.version>t.version?e:t});V.isMinorEdit===!1&&"Cancelled"===t.status?D():setTimeout(P(),200)},e.editStatus=function(a){r.showEditStatusDialog(e.article,!1,!1).result.then(function(n){return a.currentTarget.focus(),t.refreshStatus(e.article.id,n)}).then(function(){e.$emit(s.TICKET_PROFILE_RESEND_EVENT,{eventName:s.REFRESH_ACTIVITY_FEED}),e.getArticle(e.articleId,!0,!0)})["catch"](function(){a.currentTarget.focus()})},e.state=M,e.editState=V,e.$on("$destroy",function(){u.cancel(V.autoSavingInterval)}),e.$on(s.REFRESH_KNOWLEDGE_ARTICLE,function(){e.getArticle(e.articleId,!0,!0)}),e.$on(s.APPROVE_UPDATING_COMPLETE,function(){e.getArticle(e.articleId,!0,!0)}),e.getArticle(e.articleId,!1,e.preventIncrement),e.showPrintDialog=function(t){var a=f.open({templateUrl:"views/common/print-action-blade.html",controller:"PrintController",windowClass:"action-blade",size:"extra-lg",resolve:{params:function(){return{entity:e.article,feed:e.article.feed,knowledgeAnchorParser:e.knowledgeAnchorParser}}}});a.result["finally"](function(){t.currentTarget.focus()})},e.setFlag=function(t){(e.article.accessMappings.flagEditAllowed&&t||e.article.accessMappings.unflagEditAllowed&&!t)&&(e.$emit(s.SELECT_ACTIVITY_TAB),g(function(){e.$emit(s.TICKET_PROFILE_RESEND_EVENT,{eventName:s.ADD_FLAG_NOTE,eventData:{flag:t}})},0))},e.$on(s.TICKET_SHOW_LOADER,L),e.$on(s.TICKET_HIDE_LOADER,N)}])}(),function(){angular.module("knowledgeArticleModule").filter("parseVisibilityGroups",["userModel","$filter",function(e,t){return function(a){return"ALL"===a.visibilityGroupName.toUpperCase()&&"ALL"===a.company.toUpperCase()?t("i18n")("create.knowledge.visibility.everyone"):"ALL"===a.visibilityGroupName.toUpperCase()&&a.company===e.userFullData.company.name?t("i18n")("create.knowledge.visibility.my.company",a.company):a.company+" > "+a.visibilityGroupName}}])}(),function(){angular.module("knowledgeArticleModule").factory("knowledgeArticleModel",["knowledgeArticleService","$q","searchService","configurationModel","metadataModel","systemAlertService","$filter",function(e,t,a,n,i,o,r){function s(e){var t=[];return _.forIn(p,function(a,n){t=t.concat(e[n]?a:[])}),t}function l(e){var t=_.omit(e,["accessMappings","defaultCategorization"]);return t.tags=t.tags.join(","),_.forEach(u,function(e){t[e.primary]=_.isArray(t[e.primary])?_.filter(t[e.all],"primary"):_.find(t[e.all],"primary")||{},t[e.additional]=_.reject(t[e.all],"primary"),delete t[e.all]}),t}function c(e){d.knowledgeArticleTemplates&&(_.find(d.knowledgeArticleTemplates,{name:e.templateID}).templateObject.styles=e.styles)}var d={articles:{},articleRevisions:{},visibilities:{},visitedArticlesCache:{}},u=n.get("knowledgeArticle.categorySerializationMap"),p=n.get("knowledgeArticle.restrictionMap");return d.getKnowledgeArticleById=function(a,n,i){return d.articles[a]&&!n?(i||e.incrementViewCount(a,i),t.when(d.articles[a])):e.getArticleById(a,!!i).then(function(e){return d.articles[a]=e,e})},d.getArticleRevisionsById=function(a,n){return d.articleRevisions[a]&&!n||(d.articleRevisions[a]=e.getArticleRevisions(a).then(function(e){return d.articleRevisions[a]=e,e})),t.when(d.articleRevisions[a])},d.rateArticle=function(t,a){return d.articles[t].voted=a?"yes":"nope",a?d.articles[t].useCount++:d.articles[t].notUsefulCount++,d.articles[t].recalculateRating(),e.rateArticle(t,a)},d.getDraft=function(t,a){return a&&a.type===EntityVO.TYPE_PROBLEM?e.getProblemDraft(a.id,t):a&&a.type===EntityVO.TYPE_KNOWNERROR?e.getKnownErrorDraft(a.id,t):a&&a.type===EntityVO.TYPE_INCIDENT?e.getIncidentDraft(a.id,t):a&&a.type===EntityVO.TYPE_WORKORDER?e.getWorkorderDraft(a.id,t):e.getDraft(t)},d.getVisibilityByCompanyName=function(a,n){return d.visibilities[a]?t.when(d.visibilities[a]):e.getVisibility(a,n).then(function(e){return d.visibilities[a]=e,e})},d.getVisibilityGroupsByText=function(t,a,n){return e.getVisibilityByText(t,a,n).then(function(e){return e})},d.findArticleByText=function(e,t,n){var i={types:["knowledge"]};return n&&n.sortFieldName&&(e.sortFieldName=n.sortFieldName,e.sortFieldOrder=n.sortFieldOrder),_.isEmpty(t)||(i=_.merge(i,t)),a.getGlobalSearchResults(e,i).then(function(e){return e.items[0].results})},d.getHKMRecommendedKA=function(e,t){return e=e.chunk_size?{chunk_size:e.chunk_size}:{},a.getHKMRecommendedKA(e,t).then(function(e){return e.items[0].results})},d.createArticle=function(t,a){return e.createArticle(t,l(a)).then(function(e){return d.articles[e.id]=e,e})},d.update=function(t,a,n){var i=["title","content"],o=_.pick(t,i);return o.isMinorEdit=a,e.updateArticle(t.uuid,o).then(function(e){if(a){var o=d.articles[e.uuid]?d.articles[e.uuid]:d.articles[e.articleId];angular.extend(o,_.pick(e,i))}else n&&n.length>0?_.forEach(n,function(e){d.articleRevisions[e.id]=null}):d.articleRevisions[t.uuid]=null,d.articles[t.uuid]=null,d.articles[e.uuid]=e;return d.articles[e.uuid]})},d.updateArticleMetadata=function(t,a){var n=s(t.accessMappings);t=l(t);var i=_.pick(t,n);if(_.indexOf(n,"assignee")!==-1&&t.assigneeGroup&&(i.assigneeGroup=t.assigneeGroup.name,i.assigneeOrganization=t.assigneeGroup.organization,i.assigneeGroupId=t.assigneeGroup.id,i.assigneeCompany=t.assigneeGroup.company&&t.assigneeGroup.company.name),i.isMinorEdit=!0,t.autoAssign&&(i.isAutoAssign=t.autoAssign,delete i.assignee,delete i.assigneeGroup,delete i.assigneeGroupId,delete i.assigneeCompany,delete i.assigneeOrganization),n.indexOf("nextReviewDate")!==-1&&a&&(i.nextReviewDate||a.nextReviewDate)&&t.status&&"Published"===t.status.value&&Date.parse(i.nextReviewDate)!==Date.parse(a.nextReviewDate)){var c=new Date;c.setHours(0,0,0,0),void 0===i.nextReviewDate||null===i.nextReviewDate||i.nextReviewDate&&i.nextReviewDate<c?(o.error({text:r("i18n")("create.ticket.invalid.requiredDate")}),delete i.nextReviewDate):i.nextReviewDate&&Date.parse(i.nextReviewDate)!==Date.parse(a.nextReviewDate)&&(i.nextReviewDate=i.nextReviewDate.valueOf())}else delete i.nextReviewDate;return e.updateArticle(t.uuid,i).then(function(e){return angular.extend(d.articles[e.uuid],_.pick(e,n)),e})},d.getAutoSavedCopy=function(t){return e.getAutoSavedCopy(t)},d.autoSave=function(t){return e.autoSave(t)},d.removeAutoSavedCopy=function(t){return e.removeAutoSavedCopy(t)},d.checkEditStatus=function(t){return e.checkEditStatus(t)},d.mergeArticleMetaData=function(e,t,a){return e.visibility=t.visibility,e.author=t.author,e.selectedAssignee=t.selectedAssignee,e.tags=t.tags,e.allSites=t.allSites,e.allServices=t.allServices,e.allOrganizations=t.allOrganizations,e.linkedItems=t.linkedItems,e.title=t.title,e.content=a,e},d.refreshStatus=function(e,t){var a=d.articles[e],n=i.cache[EntityVO.TYPE_KNOWLEDGE];if(a.status.value=_.find(n.statuses,{name:t.status}).name,!_.isEmpty(t.updatedTickets)){var o=_.find(t.updatedTickets,function(t){return t.id===e});a.accessMappings=o.accessMappings}},d.getKnowledgeArticleTemplates=function(){return _.isUndefined(d.knowledgeArticleTemplates)?e.getKnowledgeArticleTemplates().then(function(e){return d.knowledgeArticleTemplates=e,e}):t.when(d.knowledgeArticleTemplates)},d.updateTemplateStyles=function(t,a){var n={};return n.templateID=t,n.styles=a,e.updateTemplateStyles(n).then(function(e){return c(e),e})},d.updateCachedArticles=function(e,t){_.forEach(e,function(e){d.articles[e]&&angular.extend(d.articles[e],t)})},d.getPotentialPrimary=function(t){return e.getPotentialPrimary(t)},d.markArticleVisited=function(e,t){d.visitedArticlesCache[t]?_.includes(d.visitedArticlesCache[t],e)||d.visitedArticlesCache[t].push(e):d.visitedArticlesCache[t]=[e]},d.getVisitedArticlesForTicket=function(e){return d.visitedArticlesCache[e]?d.visitedArticlesCache[e]:(d.visitedArticlesCache={},null)},d.clearVisitedArticlesForTicket=function(e){d.visitedArticlesCache[e]&&(d.visitedArticlesCache={})},d.getAssessmentQuestions=function(t,a){return e.getAssessmentQuestions(t,a)},d.submitAssessment=function(t,a){return e.submitAssessment(t,a)},d.getQuestionSetList=function(){return e.getQuestionSetList()},d.getQuestionSetById=function(t){return e.getQuestionSetById(t)},d.deleteQuestionSetById=function(t){return e.deleteQuestionSetById(t)},d.createQuestionSet=function(t){return e.createQuestionSet(t)},d.updateQuestionSet=function(t,a){return e.updateQuestionSet(t,a)},d}])}(),function(){angular.module("knowledgeArticleModule").controller("KnowledgeArticleProfileController",["$scope","$state","knowledgeArticleModel","events","historyModel",function(e,t,a,n,i){e.articleId=t.params.id,e.preventIncrement=t.params.preventIncrement,e.profileType=t.current.name,e.showRateTool=!0,e.hideEditButton=!1,e.kcsAssessMode=t.params.assessMode,e.kcsAssessDuplicateMode=!1,e.fromFullArticle=!1,e.getLatestVersion=t.params.version,e.knowledgeArticleModel=a,e.state={savingVote:!1,commentTabActive:!1},e.rateArticle=function(t){a.rateArticle(e.articleId,t)},e.setRatingVisibility=function(t){var a=!e.article||e.article.accessMappings.helpfulEditAllowed;e.state.commentTabActive=!t,e.showRateTool=t&&a},e.setKcsAssessMode=function(t){e.kcsAssessMode=t},e.setAssessFromFullArticle=function(){e.fromFullArticle=!0},e.$on(n.KNOWLEDGE_ARTICLE_LOADED,function(t,a){i.addToHistory(EntityVO.TYPE_KNOWLEDGE,a.article),e.article||(e.article=a.article),a.isEditMode||(e.hideEditButton=!1),e.article.assignee=a.article.assignee,e.article.supportGroup=a.article.supportGroup,e.article.assigneeGroup=a.article.assigneeGroup,e.article.accessMappings=a.article.accessMappings,e.$broadcast(n.REFRESH_KA_META,a),e.article.accessMappings.detailsEditAllowed||e.article.accessMappings.companyEditAllowed||e.article.accessMappings.assigneeEditAllowed||e.article.accessMappings.visibilitygroupsEditAllowed||(e.hideEditButton=!0),e.article.accessMappings.helpfulEditAllowed||(e.showRateTool=!1),e.kcsAssessMode&&(e.hideEditButton=!0)}),e.$on(n.TICKET_PROFILE_RESEND_EVENT,function(t,a){t.stopPropagation(),e.$broadcast(a.eventName,a.eventData)}),e.$on(n.SELECT_ACTIVITY_TAB,function(){e.state.commentTabActive=!0}),e.$on(n.TOGGLE_KNOWLEDGE_ARTICLE_EDIT_MODE,function(){e.hideEditButton=!e.hideEditButton}),e.$on(n.EDIT_COMPLETE,function(){e.hideEditButton=!1}),e.$on(n.TOGGLE_CHECK_DUPLICATE_MODE,function(t,a){e.toggleCheckDuplicateMode(a)}),e.toggleCheckDuplicateMode=function(t){e.kcsAssessDuplicateMode=t},e.exitAssessmentMode=function(){e.fromFullArticle?(e.setAssessFromFullArticle(!1),e.setKcsAssessMode(!1)):t.go("knowledgeConsole")},e.$on(n.REFRESH_TICKET,function(t,a){e.$broadcast(n.REFRESH_ACTIVITY_FEED),e.$broadcast(n.REFRESH_RESOURCE_FEED,a)})}])}(),function(){angular.module("knowledgeArticleModule").service("knowledgeArticleService",["$resource","$filter","configurationModel","systemAlertService","searchModel",function(e,t,a,n,i){function o(e){return _.forEach(c,function(t){var a=[];_.isEmpty(e[t.primary])||(a=_.isArray(e[t.primary])?_.map(e[t.primary],function(e){return e.primary=!0,e}):[angular.extend({primary:!0},e[t.primary])]),e[t.all]=a.concat(e[t.additional])}),e}function r(e){return _.forEach(e,function(e){e.label=t("i18n")("common.labels.version")+" "+e.version+" - "+t("datePreConfigTimezone")(e.createDate,"mediumDate")}),e}function s(e){var t=e[0].items[0].knowledgeQuestionList.map(function(e){return(new AssessmentQuestionVO).build(e)});return t}var l=e("/smartit/rest/knowledge/:id",{},{getArticleById:{method:"GET",isArray:!0},incrementViewCount:{method:"PUT",url:"/smartit/rest/knowledge/incrementViewCount/:id",isArray:!0},rateArticle:{method:"PUT",url:"/smartit/rest/knowledge/:operation/:id",isArray:!0},getArticleRevisions:{method:"GET",url:"/smartit/rest/knowledge/revisions/:id",isArray:!0},getDraft:{method:"GET",url:"/smartit/rest/knowledge/draft",isArray:!0},getProblemDraft:{method:"POST",url:"/smartit/rest/ticket/create/knowledge/from/problem/:id",isArray:!0},getKnownErrorDraft:{method:"POST",url:"/smartit/rest/ticket/create/knowledge/from/knownerror/:id",isArray:!0},getIncidentDraft:{method:"POST",url:"/smartit/rest/ticket/create/knowledge/from/incident/:id",isArray:!0},getWorkorderDraft:{method:"POST",url:"/smartit/rest/ticket/create/knowledge/from/workorder/:id",isArray:!0},getVisibility:{method:"GET",url:"/smartit/rest/knowledge/visibility",isArray:!0},createArticle:{method:"POST",url:"/smartit/rest/knowledge/createknowledge/user/:loginId",isArray:!0,transformRequest:function(e){return e.status=e.status.value,angular.toJson(e)}},updateArticle:{method:"PUT",url:"/smartit/rest/knowledge/all/:id",isArray:!0},getAutoSavedCopy:{url:"/smartit/rest/knowledge/save",method:"GET",isArray:!1},createAutoSavedCopy:{url:"/smartit/rest/knowledge/save",method:"POST",isArray:!1},removeAutoSavedCopy:{url:"/smartit/rest/knowledge/save",method:"DELETE",isArray:!0},checkEditStatus:{url:"/smartit/rest/knowledge/save/status",method:"GET",isArray:!1},getTemplates:{url:"/smartit/rest/knowledge/templates",method:"GET",isArray:!0},updateTemplateStyles:{method:"PUT",url:"/smartit/rest/knowledge/templatestyles/update",isArray:!1},getPotentialPrimary:{method:"POST",url:"/smartit/rest/foundation/primary",isArray:!0},getAssessmentQuestions:{method:"GET",url:"/smartit/rest/knowledge/assessment/questions",isArray:!0},submitAssessment:{method:"POST",url:"/smartit/rest/knowledge/assessment",isArray:!1},getQuestionSetList:{method:"GET",url:"/smartit/rest/knowledge/assessment/questionsetlist",isArray:!0},getQuestionSetById:{method:"GET",url:"/smartit/rest/knowledge/assessment/questionset/draft",isArray:!0},deleteQuestionSetById:{method:"DELETE",headers:{"Content-Type":"application/json"},data:"",url:"/smartit/rest/knowledge/assessment/deletequestionset"},createQuestionSet:{method:"POST",url:"/smartit/rest/knowledge/assessment/createquestionset",isArray:!0},updateQuestionSet:{method:"PUT",url:"/smartit/rest/knowledge/assessment/updateassessment/:id",isArray:!0},getLatestVersionId:{method:"GET",url:"/smartit/rest/knowledge/link/:id",isArray:!0}}),c=a.get("knowledgeArticle.categorySerializationMap");this.getArticleById=function(e,t){return l.getArticleById({id:e,preventIncrement:t}).$promise.then(function(e){return o((new KnowledgeArticleVO).build(e[0].items[0]))})},this.getLatestVersionId=function(e){return l.getLatestVersionId({id:e}).$promise.then(function(e){return e[0].items[0]})},this.incrementViewCount=function(e,t){return l.incrementViewCount({id:e},{incrementCount:1,source:t})},this.rateArticle=function(e,t){var a=t?"useCount":"notUsefulCount";return l.rateArticle({id:e,operation:a},{}).$promise},this.getArticleRevisions=function(e){return l.getArticleRevisions({id:e}).$promise.then(function(e){return r(e[0].items||[])})},this.getDraft=function(e){return l.getDraft({templateId:e}).$promise.then(function(e){return e[0].items[0].isDraft=!0,o((new KnowledgeArticleVO).build(e[0].items[0]))})},this.getProblemDraft=function(e,t){return l.getProblemDraft({id:e,templateId:t},{}).$promise.then(function(e){return e[0].items[0].isDraft=!0,o((new KnowledgeArticleVO).build(e[0].items[0]))})},this.getKnownErrorDraft=function(e,t){return l.getKnownErrorDraft({id:e,templateId:t},{}).$promise.then(function(e){return e[0].items[0].isDraft=!0,o((new KnowledgeArticleVO).build(e[0].items[0]))})},this.getIncidentDraft=function(e,t){return l.getIncidentDraft({id:e,templateId:t},{}).$promise.then(function(e){return e[0].items[0].isDraft=!0,o((new KnowledgeArticleVO).build(e[0].items[0]))})},this.getWorkorderDraft=function(e,t){return l.getWorkorderDraft({id:e,templateId:t},{}).$promise.then(function(e){return e[0].items[0].isDraft=!0,o((new KnowledgeArticleVO).build(e[0].items[0]))})},this.getVisibility=function(e,t){var a={companyName:e,chunkInfo:{
startIndex:0,chunkSize:t?t:i.supportGroupChunkSize}};return l.getVisibility(a).$promise.then(function(e){return e[0].items[0]})},this.getVisibilityByText=function(e,t,a){var n={companyName:e,visibilityGroup:t,chunkInfo:{startIndex:0,chunkSize:a?a:i.supportGroupChunkSize}};return l.getVisibility(n).$promise.then(function(e){return e[0].items[0]})},this.createArticle=function(e,t){return e=encodeURIComponent(e),l.createArticle({loginId:e},t).$promise.then(function(e){return o((new KnowledgeArticleVO).build(e[0].items[0]))})},this.updateArticle=function(e,a){return l.updateArticle({id:e},a).$promise.then(function(e){var a=e[0].items[0].statusInfo;return 3e3===a.number&&n.warning({title:t("i18n")("common.notification.dirty.title"),text:a.message,hide:1e4}),o((new KnowledgeArticleVO).build(e[0].items[0].responseObject))})},this.getAutoSavedCopy=function(e){return l.getAutoSavedCopy({knowledgeArticleId:e}).$promise.then(function(e){return e.content&&e.content.length?_.chain(e.content).sortBy("order").map(function(e){return _.pick(e,["name","snippet","createDate","modifiedDate"])}).value():[]})},this.autoSave=function(e){var t={knowledgeArticleId:e.uuid,content:_.map(e.content,function(e){return _.omit(e,["label","embeddedImageLimit"])})};return l.createAutoSavedCopy({},t).$promise.then(function(e){return e.content})},this.removeAutoSavedCopy=function(e){return l.removeAutoSavedCopy({knowledgeArticleId:e}).$promise},this.checkEditStatus=function(e){return l.checkEditStatus({knowledgeArticleId:e}).$promise.then(function(e){return e.content})},this.getKnowledgeArticleTemplates=function(){return l.getTemplates().$promise.then(function(e){return _.map(e[0].items[0].objects,function(e){return e.templateObject.sections=_.sortBy(e.templateObject.sections,"order"),e.label=e.templateObject.label||e.name,e})})},this.updateTemplateStyles=function(e){return l.updateTemplateStyles(e).$promise.then(function(e){return e})},this.getPotentialPrimary=function(e){return l.getPotentialPrimary(e).$promise.then(function(e){return _.omit(e[0].items[0],"company")})},this.getAssessmentQuestions=function(e,t){return l.getAssessmentQuestions({companyName:e,organization:t}).$promise.then(s)},this.submitAssessment=function(e,t){var a={articleId:e,answerList:t};return l.submitAssessment(a).$promise.then(function(e){return e})},this.getQuestionSetList=function(){return l.getQuestionSetList().$promise.then(function(e){return e})},this.getQuestionSetById=function(e){return l.getQuestionSetById({id:e}).$promise.then(function(e){var t=e[0].items[0].objects.map(function(e){return(new AssessmentQuestionVO).build(e)});return t})},this.deleteQuestionSetById=function(e){return l.deleteQuestionSetById({id:e}).$promise.then(function(e){return e})},this.createQuestionSet=function(e){return l.createQuestionSet(e).$promise.then(function(e){return e})},this.updateQuestionSet=function(e,t){return l.updateQuestionSet({id:e},t).$promise.then(function(e){return e})}}])}(),KnowledgeArticleVO.prototype=new BaseVO,KnowledgeArticleVO.prototype.constructor=KnowledgeArticleVO,KnowledgeArticleVO.prototype.getProps=function(){var e=Object.keys(new KnowledgeArticleVO);return BaseVO.prototype.getProps().concat(e)},KnowledgeArticleVO.prototype.postBuild=function(){if(this.recalculateRating(),_.isEmpty(this.accessMappings))this.accessMappings={assigneeEditAllowed:!0,attachmentsEditAllowed:!0,companyEditAllowed:!0,detailsEditAllowed:!0,relationsEditAllowed:!0,statusEditAllowed:!0,summaryEditAllowed:!0,timelineEditAllowed:!0,visibilitygroupsEditAllowed:!0,helpfulEditAllowed:!0,internaluseEditAllowed:!0};else{for(var e={},t=0;t<this.accessMappings.length;t++){var a=this.accessMappings[t].id.indexOf("action")!==-1?this.accessMappings[t].id.replace(/\-/g,"").replace("action","")+"ActionAllowed":this.accessMappings[t].id+"EditAllowed";e[a]="write"===this.accessMappings[t].permission}this.accessMappings=e}this.status={value:this.status},this.content=_.sortBy(this.content,"order"),this.entityLink="#/"+this.type+"/"+this.uuid,this.tags=this.tags?this.tags.split(","):[],this.supportGroup&&(this.assigneeGroup=this.supportGroup),this.assignee&&(this.autoAssign=!1),"Decision Tree"===this.templateName&&angular.isObject(this.content[0])&&(this.decisionTree=JSON.parse(this.content[0].snippet)),this.defaultCategorization=[{name:"operational",tiers:{}},{name:"product",tiers:{}}],this.categorizations=_.filter(this.categorizations,function(e){return!_.isEmpty(e.tiers)}),_.forEach(this.categorizations,_.bind(function(e){e.company={name:this.company.name}},this)),_.forEach(this.additionalCategorization,_.bind(function(e){e.company={name:this.company.name}},this)),this.nextReviewDate=this.nextReviewDate?new Date(this.nextReviewDate):null},KnowledgeArticleVO.prototype.getAuthorFullName=function(){return this.author&&this.author.getFullName()||""},KnowledgeArticleVO.prototype.getAuthorThumbnail=function(){return this.author.thumbnailMime&&this.author.thumbnail?"data:"+this.author.thumbnailMime+";base64,"+this.author.thumbnail:""},KnowledgeArticleVO.prototype.isDecisionTree=function(){return"Decision Tree"===this.templateName},KnowledgeArticleVO.prototype.recalculateRating=function(){this.viewCount=+this.useCount+ +this.notUsefulCount,this.rating=Math.round(this.useCount/this.viewCount*100)},function(){angular.module("knowledgeArticleModule").controller("KnowledgeNewTabController",["$state",function(e){e.go("knowledge",{id:e.params.id,preventIncrement:e.params.preventIncrement})}])}(),function(){angular.module("knowledgeArticleModule").directive("previewKnowledgeArticle",["events","configurationModel","utilityFunctions",function(e,t,a){return{restrict:"A",templateUrl:"views/knowledge-article/knowledge-article-details.html",controller:"KnowledgeArticleController",scope:{selectedItem:"="},link:function(n,i,o){function r(){n.handleEditClick()}n.isFullVersion=!1,n.noPreviewAvailable=!1,n.previewId,i.on(e.CHANGE_TO_EDIT_MODE,r),n.$on(e.REFRESH_KNOWLEDGE_ARTICLE,function(){n.getArticle(n.article.id,!0)}),n.$on("$destroy",function(){(n.editMode||n.state.gettingEditStatus)&&(n.editMode=!1,n.$emit(e.TOGGLE_KNOWLEDGE_ARTICLE_EDIT_MODE)),i.off(e.CHANGE_TO_EDIT_MODE,r)}),n.openArticleRevision=function(t){n.$emit(e.SET_PREVIEW_ITEM,{id:t.id,type:EntityVO.TYPE_KNOWLEDGE,status:t.status})},n.openHKM=function(){n.selectedItem&&n.selectedItem.additionalInformation&&n.selectedItem.additionalInformation.comaroundGetUrl&&a.isValidHttpUrl(n.selectedItem.additionalInformation.comaroundGetUrl)?(n.$broadcast(e.CLOSE_TICKET_PREVIEW),window.open(n.selectedItem.additionalInformation.comaroundGetUrl,"_blank")):console.error("Provided Comaround URL is invalid")},o.$observe("previewKnowledgeArticle",function(a){return t.comaroundEnabled&&"true"!==o.isFromLivechat?(n.noPreviewAvailable=!0,void(n.previewId=a)):(n.editMode&&(n.editMode=!1,n.$emit(e.CANCEL_EDIT_MODE)),n.articleId=a,void n.getArticle(a,!1,!1))})}}}])}(),function(){angular.module("knowledgeArticleModule").directive("processKaContent",["$location","$anchorScroll","$compile",function(e,t,a){return{restrict:"A",link:function(n,i,o){var r=o.processKaContent,s=$("<div>").append($.parseHTML(r)),l=s.find("a"),c=/^#[^-[\]{}()<>*+?.,\\\/^$|#]+$/;if(o.anchorParser&&"skip"!==o.anchorParser)try{c="^#[^"+o.anchorParser+"]+$",c=new RegExp(c)}catch(d){console.error("Error in Regex sent through ccs"),c=/^#[^-[\]{}()<>*+?.,\\\/^$|#]+$/}else"skip"===o.anchorParser&&(c=/^#[\w\d]/);n.scrollToAnchor=function(a,n){e.hash(n),t(),a.preventDefault(),a.stopPropagation()},l.length&&$.each(l,function(e,t){var i=$(t),o=i.attr("href");c.test(o)&&o.indexOf("#/knowledge/latest/")===-1&&(o=o.replace(/\\/g,"\\\\").replace(/\"/g,'\\"'),i.attr("ng-click",'scrollToAnchor($event, "'+o.replace(/^#/,"")+'")'),a(i)(n))}),i.append(s)}}}])}(),function(){angular.module("knowledgeArticleModule").directive("toggleKnowledgeArticlePreview",[function(){return{restrict:"A",scope:{article:"=toggleKnowledgeArticlePreview"},link:function(e,t){var a="ka-preview-opened";e.$watch("article",function(e){e?t.addClass(a):t.removeClass(a)})}}}])}(),KnowledgeConsoleItemVO.prototype=new BaseVO,KnowledgeConsoleItemVO.prototype.constructor=KnowledgeConsoleItemVO,KnowledgeConsoleItemVO.prototype.getProps=function(){var e=Object.keys(new KnowledgeConsoleItemVO);return BaseVO.prototype.getProps().concat(e)},KnowledgeConsoleItemVO.prototype.postBuild=function(){this.supportGroup=this.assignedGroup},function(){angular.module("consoleModule").factory("knowledgeConsoleModel",["consoleService","authService","consoleColumnsModel","configurationModel","metadataModel","userModel","knowledgeArticleModel","$rootScope","$q","$filter","roles","i18nService",function(e,t,a,n,i,o,r,s,l,c,d,u){var p,m={},f='<div class="ngHeaderSortColumn {{col.headerClass}}" ng-style="{\'cursor\': col.cursor}" ng-class="{ \'ngSorted\': !noSortVisible }"><div ux-id="column-header" ng-click="col.sort($event)" ng-class="\'colt\' + col.index" class="ngHeaderText">{{\'console.column.\' + col.displayName | i18n}}</div>\t<div class="ngSortButtonUp" ng-show="col.showSortButtonDown()"></div>\t<div class="ngSortButtonDown" ng-show="col.showSortButtonUp()"></div>\t<div class="ngSortPriority">{{col.sortPriority}}</div>\t<div ng-class="{ ngPinnedIcon: col.pinned, ngUnPinnedIcon: !col.pinned }" ng-click="togglePin(col)" ng-show="col.pinnable"></div></div><div ng-show="col.resizable" class="ngHeaderGrip" ng-click="col.gripClick($event)" ng-mousedown="col.gripOnMouseDown($event)"></div>',g=140,h="knowledgeConsoleFilter",y="knowledgeConsoleColumns",E="",v=!0,T=function(){_.forEach(m.columnsConfig,function(e){angular.extend(e,{headerCellTemplate:f,minWidth:g,width:e.width||g})})};return m.filterPreferenceGroup=h,m.columnPreferenceGroup=y,m.ribbonConfig=n.get("knowledgeConsole.ribbon"),m.filterConfig=n.get("knowledgeConsole.filter"),m.statsConfig=n.get("knowledgeConsole.stats"),m.languages=n.get("knowledgeConsole.languages"),window.isRtl&&m.statsConfig.reverse(),m.currentColumnsConfig={},p=_.map(m.statsConfig,function(e){return{name:e.name}}),m.presetColumns=null,m.defaultChunkSize=75,m.exceedChunkSize=!1,m.criteria={filterCriteria:{},chunkInfo:{startIndex:0,chunkSize:m.defaultChunkSize},sortInfo:{},attributeNames:[]},m.itemList=[],m.selectedFilters=[],m.filterDict=_.keyBy(m.filterConfig,"name"),m.isKcsCoachPreset=!1,m.kcsFilters={coachFilter:!1,teamMemberFilter:!1,authorName:"",authorFilter:"",assessmentMode:!1},m.populateFilters=function(){return m.areFiltersPopulated?l.when(1):l.all([o.getFullCurrentUserData(),i.getMetadataByType(EntityVO.TYPE_KNOWLEDGE),r.getKnowledgeArticleTemplates()]).then(function(e){m.showStats=!n.explicitStatsRefresh;var t=u.language,a=e[0],i=e[1],o=e[2],r=_.find(m.filterDict.authors.options,{label:"me"}),s=_.find(m.filterDict.assignees.options,{label:"me"}),l=_.find(m.filterDict.languages.options,{label:"myLanguage"}),c=_.find(m.filterDict.assignedSupportGroups.options,{label:"myGroup"}),d=_.find(m.filterDict.organizations.options,{label:"myOrganization"}),p=_.find(m.filterDict.approvalAssignment.options,{label:"me"});r.subLabel=a.fullName,r.criteria.value=[{loginId:a.loginId}],s.subLabel=a.fullName,s.criteria.value=[{loginId:a.loginId}],p.subLabel=a.fullName,p.criteria.value=[{loginId:a.loginId}],l.criteria.value=_.result(_.find(m.languages,{locale:t}),"label"),l.criteria.value=l.criteria.value?[l.criteria.value]:["English"],c.criteria.value=a.supportGroups,d.subLabel=a.organization,d.criteria.value=[a.organization],_.forEach(i.statuses,function(e){m.filterDict.statusMappings.options.push({name:e.label,type:"dynamic",filterName:"statusMappings",criteria:{name:"statusMappings",value:[e.name]}})}),_.forEach(i.languages,function(e){m.filterDict.languages.options.push({name:e.label,type:"dynamic",filterName:"languages",criteria:{name:"languages",value:[e.name]}})}),m.filterDict.templateNames.options=_.map(o,function(e){return{name:e.templateObject.label,type:"dynamic",criteria:{name:"templateNames",value:[e.name]}}})})},m.populateConfiguration=function(){return _.isEmpty(m.columnsConfig)?l.all([o.getUserPreferences(y),o.getUserPreferences(h)]).then(function(e){m.userSavedColumnPresets=e[0]||[];var a=_.find(m.userSavedColumnPresets,{name:"columns"})||{},i=a.value||{};m.currentColumnsConfig=i,E=a.id,m.columnsConfig=_.merge(_.cloneDeep(n.get("knowledgeConsole.columns")),i),m.availableColConfig=m.columnsConfig,m.userSavedFilterPresets=e[1],m.userSavedFilterPresets.unshift({id:"myAllOpenKnowledge",fixed:!0,name:"My Assigned Articles",label:c("i18n")("console.knowledge.preDefinedUserFilter.myAllOpenKnowledge"),systemgenerated:!0,defaultpreset:!1,restcall:!0,value:[{filter:"assignees",option:"me"},{filter:"statusMappings",option:"allOpen"}]},{id:"myGroupAllOpenKnowledge",fixed:!0,name:"My Groups' Assigned Articles",label:c("i18n")("console.knowledge.preDefinedUserFilter.myGroupAllOpenKnowledge"),systemgenerated:!0,defaultpreset:!1,value:[{filter:"assignedSupportGroups",option:"myGroup"},{filter:"statusMappings",option:"allOpen"}]},{id:"favoriteKnowledge",fixed:!0,name:"My Favorites",label:c("i18n")("console.knowledge.preDefinedUserFilter.favoriteKnowledge"),systemgenerated:!0,defaultpreset:!1,value:[{filter:"settings",option:"favorite"},{filter:"statusMappings",option:"allOpen"}]},{id:"recentKnowledge",fixed:!0,name:"Recent Articles",label:c("i18n")("console.knowledge.preDefinedUserFilter.recentKnowledge"),systemgenerated:!0,defaultpreset:!1,value:[{filter:"createDateRanges",option:"createDatePastWeek"},{filter:"statusMappings",option:"allOpen"}]},{id:"flaggedKnowledge",fixed:!0,name:"Flagged Articles",label:c("i18n")("console.knowledge.preDefinedUserFilter.flaggedKnowledge"),systemgenerated:!0,defaultpreset:!1,value:[{filter:"settings",option:"flagged"},{filter:"statusMappings",option:"allOpen"}]}),t.isAuthorized(d.ITSM_KCS_COACH_ROLE)&&m.userSavedFilterPresets.unshift({id:"myTeamKnowledge",fixed:!0,name:"My Team's Articles",label:c("i18n")("console.knowledge.preDefinedUserFilter.myTeamKnowledge"),systemgenerated:!0,defaultpreset:!1,value:[{filter:"statusMappings",option:"allOpen"}]}),m.userSavedPresets=_.cloneDeep(m.userSavedFilterPresets),_.each(m.userSavedColumnPresets,function(e){if("columns"!==e.name){var t=_.find(m.userSavedPresets,{name:e.name});t?(t.columnId=e.id,t.columnValue=e.value):(e.columnId=e.id,e.columnValue=e.value,delete e.id,delete e.value,m.userSavedPresets.push(e))}}),T(),m.populateAttributeNames()}):l.when(1)},m.addUserSavedPresets=function(e){var t=_.find(m.userSavedFilterPresets,{name:e}),a=_.find(m.userSavedColumnPresets,{name:e}),n={};t?(n=t,a&&(n.columnId=a.id,n.columnValue=a.value)):a&&(n.columnId=a.id,n.columnValue=a.value,n.name=a.name),m.userSavedPresets.push(n)},m.populateAttributeNames=function(){m.criteria.attributeNames=_.map(_.filter(m.columnsConfig,function(e){return e.visible}),"attributeName")},m.getItemList=function(){if(!m.criteria.attributeNames.length){var t=_.sortBy(_.filter(m.columnsConfig,{visible:!0}),"order");t.forEach(function(e){m.criteria.attributeNames.push(e.attributeName)})}return e.getKnowledgeList(m.criteria).then(function(e){return m.itemList=m.criteria.chunkInfo.startIndex?m.itemList.concat(e.itemList):e.itemList,m.exceedChunkSize=e.exceedChunkSize,e.totalCount})},m.dropCriteriaStartIndex=function(){m.criteria.chunkInfo.startIndex=0},m.getTicketConsoleMetric=function(){return e.getKnowledgeStats(m.criteria.filterCriteria,p).then(function(e){_.forEach(m.statsConfig,function(t){var a=_.find(e,{name:t.name});t.value=a?a.value:0})})},m.applyFilterSet=function(e,t){_.forEach(e,function(e){if(m.filterDict[e.filter]){var a=_.find(m.filterDict[e.filter].options,{name:e.option});if(a||"dynamic"!==e.type||(a=e.realOption,m.filterDict[e.filter].options.push(e.realOption)),angular.isObject(a)&&!a.active){if(a.active=!0,t&&"Published"===a.name){var n=_.find(m.selectedFilters,{name:"allOpen"});n&&(n.active=!1,m.applyFilter(n))}m.applyFilter(a)}}})},m.applyColumnSet=function(e){var t=_.filter(m.columnsConfig,{visible:!0});m.presetColumns=[],_.each(m.columnsConfig,function(t){var a,n=e[t.name];n&&(a=angular.copy(t),a.order=n.order,a.visible="undefined"==typeof n.visible||n.visible,m.presetColumns.push(a))}),!e.newColumnType&&t.length&&_.forEach(t,function(e){if(!_.find(m.presetColumns,{name:e.name})){var t=angular.copy(e);m.presetColumns.push(t)}}),m.presetColumns=_.sortBy(m.presetColumns,"order"),m.criteria.attributeNames=_.map(m.presetColumns,"attributeName")},m.applyFilter=function(e){var t=m.criteria.filterCriteria,a=e.criteria.name,n=_.isArray(e.criteria.value);if(m.isKcsCoachPreset?t.kcsCoach="true":delete t.kcsCoach,e.active){var i=e.filterName||e.criteria.name,o=m.filterDict[i];if(o&&o.showLabelInPill&&(e.filterName=o.name,e.filterLabel=o.label),"date"===e.type&&(e.criteria.value=[{}],_.forEach(e.defaultValues,function(t,a){e.criteria.value[0][a]=s.$eval(t,{moment:moment})}),e.criteria.value[0].id=e.label,n=!1),"dynamic"===e.type&&"date"===e.criteria.type&&(n=!1),t[a])if(n)t[a]=_.union(t[a],e.criteria.value);else{var r=_.find(m.selectedFilters,{criteria:{name:e.criteria.name}});r.active=!1,m.applyFilter(r),t[a]=e.criteria.value}else t[a]=e.criteria.value;m.selectedFilters.unshift(e),m.setKcsFilters()}else{t[a]=n?_.difference(t[a],e.criteria.value):"",t[a].length||delete t[a];var l=_.findIndex(m.selectedFilters,function(t){return t.name===e.name&&t.criteria.name===e.criteria.name});l!==-1&&m.selectedFilters.splice(l,1),!m.selectedFilters.length&&m.isKcsCoachPreset&&delete t.kcsCoach}},m.saveFilterPreset=function(t){var a=_.cloneDeep(m.selectedFilters),n={name:t,value:_.map(a.reverse(),function(e){var t={filter:e.filterName||e.criteria.name,option:e.name};return"dynamic"===e.type&&(t.type="dynamic",t.realOption=angular.copy(e),delete t.realOption.active),t})};return l.all([o.updateUserPreferences(h,n),e.saveKnowledgeFilterConfiguration(t,m.criteria.filterCriteria)])},m.saveColumnPreset=function(e,t){return o.updateUserPreferences(y,{name:e,value:t})},m.removeUserFilterPreset=function(t){t.id&&(o.removeUserPreferences(h,t),e.removeFilterConfiguration(t.name,t.id)),t.columnId&&o.removeUserPreferences(y,{id:t.columnId}),_.remove(m.userSavedPresets,{name:t.name})},m.updateColumnConfig=function(e,t,a){return o.updateUserPreferences(y,{id:a?a:E,name:t?t:"columns",value:e},{updateColumns:!0}).then(function(e){var t=a?_.find(e,{id:a}):_.find(e,{name:"columns"});t&&(m.currentColumnsConfig=t.value,E=t.id)})},m.setKcsFilters=function(){m.kcsFilters.coachFilter=m.kcsFilters.teamMemberFilter=m.kcsFilters.assessmentMode=m.isKcsCoachPreset=!1},m.applyKcsFilter=function(){m.kcsFilters.teamMemberFilter?(m.isKcsCoachPreset=!1,m.kcsFilters.authorFilter.active=!0,m.applyFilter(m.kcsFilters.authorFilter),m.applyFilterSet([{filter:"statusMappings",option:"allOpen"}])):m.kcsFilters.coachFilter&&(m.isKcsCoachPreset=!0,m.applyFilterSet([{filter:"statusMappings",option:"allOpen"}]))},m.enableAssessment=function(){return _.has(m.criteria.filterCriteria,"kcsCoach")||!_.isEmpty(_.find(m.selectedFilters,{filterName:"authors",name:m.kcsFilters.authorName}))},m.enableKcsFilters=function(){return m.kcsFilters.assessmentMode||m.kcsFilters.coachFilter||m.kcsFilters.teamMemberFilter},m.isSearchEnabled=function(){return v||m.criteria.filterCriteria.kcsCoach},m.setSearchEnabled=function(e){v=!!e},m.setKcsFilters(),m}])}(),function(){angular.module("knowledgeTeamModule").controller("KnowledgeManageTeamController",["$scope","$q","$modalInstance","knowledgeTeamModel","userModel","configurationModel",function(e,t,a,n,i,o){function r(){e.dataLoading=!1,e.teamList=angular.copy(n.coachTeamList)||[],e.state.loadingCompanies=!0;var a=i.getFullCurrentUserData(),o=i.getOperatingCompanies();t.all([a,o]).then(function(t){e.userData=i.userFullData,e.companies=t[1].companies,e.state.tooManyCompanies=t[1].exceedsChunkSize,e.searchCompany=_.find(e.companies,function(t){return e.userData.company.name===t.name}),e.state.loadingCompanies=!1})}e.showsearch=!1,e.deletedCoacheeList=[],e.addedCoacheeList=[],e.dataLoading=!0,e.teamList=[],e.companies=[],e.searchCompany={},e.showMailstopOnPersoncard=o.showMailstopOnPersoncard,e.showPhoneNumOnPersonCard=o.showPhoneNumOnPersonCard,e.state={loadingCompanies:!1,tooManyCompanies:!1},e.close=function(){a.close(n.coachTeamList)},e.selectCompany=function(t){e.searchCompany=t},e.save=function(){e.dataLoading=!0;var i=[];e.deletedCoacheeList.length&&i.push(n.removeCoachee(e.deletedCoacheeList)),e.addedCoacheeList.length&&i.push(n.addCoachee(e.addedCoacheeList)),t.all(i).then(function(){e.dataLoading=!1,a.close(e.teamList)})},e.getJobRole=function(e){var t=_.findIndex(e,function(e){return e.isDefault===!0});return e[t].name},e.searchPerson=function(){e.showsearch=!0},e.addCoachee=function(t){var a=_.findIndex(e.deletedCoacheeList,function(e){return e.id===t.id});a>-1?e.deletedCoacheeList.splice(e.deletedCoacheeList.indexOf(t),1):e.addedCoacheeList.push(t),e.teamList.push(t)},e.removeCoachee=function(t){var a=_.findIndex(e.addedCoacheeList,function(e){return e.id===t.id});a>-1?e.addedCoacheeList.splice(a,1):e.deletedCoacheeList.push(t);var n=e.teamList.indexOf(t);n>-1&&e.teamList.splice(n,1)},e.getList=function(t){return n.getLists(t,e.searchCompany).then(function(t){if(e.teamList)for(var a=0;a<e.teamList.length;a++)_.remove(t,{id:e.teamList[a].id});return t})},e.getCompaniesByName=function(e){var t=i.getOperatingCompaniesByText(e);return t.then(function(e){return{list:e.companies,exceedsChunkSize:e.exceedsChunkSize}})},r()}])}(),function(){angular.module("knowledgeTeamModule").controller("KnowledgeTeamController",["$scope","$q","$modal","$state","$window","knowledgeTeamModel","knowledgeTeamService","knowledgeConsoleModel","chatModel","openMailClientService","configurationModel",function(e,t,a,n,i,o,r,s,l,c,d){function u(){e.dataLoading=!0,o.getReportsList().then(function(t){e.reportingItemlist=t}),o.getKnowledgeTeamList().then(function(t){e.coacheeList=t})["finally"](function(){e.dataLoading=!1})}e.reportsEnabled=d.isServerApplicationEnabled(EntityVO.TYPE_REPORTS),e.openManageTeamModal=function(){var t=a.open({templateUrl:"views/knowledge-team/knowledge-manage-team.html",windowClass:"action-blade",controller:"KnowledgeManageTeamController",resolve:{}});t.result.then(function(t){e.coacheeList=t,o.coachTeamList=t})},e.viewTeamArticles=function(){s.areFiltersPopulated=!0,s.kcsFilters.coachFilter=!0,s.kcsFilters.teamMemberFilter=!1,n.go("knowledgeConsole")},e.showAQIAssessment=function(){n.go("createAqiQuestions")},e.getJobRole=function(e){var t=_.result(_.find(e,{isDefault:!0}),name);return t||e.length?e[0].name:""},e.showPersonArticles=function(e){s.areFiltersPopulated=!0,s.kcsFilters.coachFilter=!1,s.kcsFilters.teamMemberFilter=!0,s.kcsFilters.authorName=e.fullName;var t={name:e.fullName,active:!0,type:"dynamic",filterLabel:"author",filterName:"authors",criteria:{name:"authors",value:[{loginId:e.loginId}]}};s.kcsFilters.authorFilter=t,s.filterDict[t.filterName].options.push(t),n.go("knowledgeConsole")},e.inviteForChat=function(e){if("offline"!==e.available)return l.createChatRoom(e.loginId).then(function(t){l.inviteUserToChat(e,t)})},e.openEmail=function(e){c.openMailClient(e.email,"KCS Team Communication","")},e.launchReport=function(e,t){return r.getReportURL(e).then(function(e){i.open(e.url,t?"_blank":"_self")})},u()}])}(),function(){angular.module("knowledgeTeamModule").factory("knowledgeTeamModel",["knowledgeTeamService",function(e){var t={coachTeamList:[],coachCompanyName:""};return t.getKnowledgeTeamList=function(){return e.getKnowledgeTeamList().then(function(e){return t.coachTeamList=e[0].items[0].objects,t.coachTeamList})},t.getLists=function(t,a){return e.getListOfPersons(t,a.name).then(function(e){return e[0].items[0].objects})},t.addCoachee=function(t){return e.addCoachee(t).then(function(e){return e[0]})},t.removeCoachee=function(t){return e.removeCoachee(t).then(function(e){return e[0]})},t.getReportsList=function(){return e.getReportsList().then(function(e){return e[0].items[0].objects})},t}])}(),function(){angular.module("knowledgeTeamModule").service("knowledgeTeamService",["$resource",function(e){var t=e("/smartit/rest/person/:id",{},{getKnowledgeTeamList:{method:"GET",url:"/smartit/rest/kcsliveview/team",isArray:!0},getPerson:{method:"GET",url:"mocks/knowledge-team.json",isArray:!0},getKnowledgeCandidates:{method:"GET",url:"/smartit/rest/person/supportgrouppersons",isArray:!0},addCoachee:{url:"/smartit/rest/kcsliveview/add/coachee",method:"POST",isArray:!0},removeCoachee:{url:"/smartit/rest/kcsliveview/delete/coachee",method:"POST",isArray:!0},getReportsList:{url:"/smartit/rest/reporting/kcsreports",method:"GET",isArray:!0},getReportURL:{url:"/smartit/rest/reporting/kcsreport/:id",method:"GET",isArray:!1}});this.getKnowledgeTeamList=function(){return t.getKnowledgeTeamList().$promise.then(function(e){return e})},this.getListOfPersons=function(e,a){var n={personText:e,chunkInfo:{startIndex:0,chunkSize:20},thumbnail:!0,role:"kcsmember",companyName:a};return t.getKnowledgeCandidates(n).$promise},this.addCoachee=function(e){return t.addCoachee({},e).$promise},this.removeCoachee=function(e){return t.removeCoachee({},e).$promise},this.getReportsList=function(){return t.getReportsList().$promise.then(function(e){return e})},this.getReportURL=function(e){return t.getReportURL({id:e}).$promise.then(function(e){return e})}}])}(),function(){angular.module("l10nModule").factory("l10nModel",["l10nService","$log","$q",function(e,t,a){function n(e){var a=e[0].items||[];a.length||t.warn("Localized messages data returned from server is empty or malformed"),o.localizedMessages=a.map(i),o.localizedMessagesDictionary=_.keyBy(o.localizedMessages,"messageId"),o.messagesLoaded=!0}function i(e){return(new LocalizedMessageVO).build(e)}var o={localizedMessagesDictionary:{},messagesLoaded:!1,messageLoadPending:!1};return o.getLocalizedMessage=function(e){return o.localizedMessagesDictionary[e]},o.loadSystemMessages=function(){if(o.messagesLoaded||o.messageLoadPending)return a.when(1);o.messageLoadPending||(o.messageLoadPending=!0);var e={messageType:LocalizedMessageVO.prototype.SOCIAL_MESSAGE,locale:window.myitsmLocale};return o.loadMessages(e)},o.loadMessages=function(a){a&&"he"===a.locale&&(a.locale="iw");var i=e.getMessages(a).$promise;return i.then(n)["catch"](function(){t.error("Error getting localized messages.")}),i},o}])}(),function(){angular.module("l10nModule").service("l10nService",["$resource",function(e){return e("/smartit/rest/localization/message",{},{getMessages:{url:"/smartit/rest/localization/message/get",method:"GET",isArray:!0},updateMessage:{url:"/smartit/rest/localization/message/update",method:"POST"}})}])}(),LocalizedMessageVO.prototype=Object.create(BaseVO.prototype),LocalizedMessageVO.prototype.constructor=LocalizedMessageVO,LocalizedMessageVO.prototype.ERROR_MESSAGE="ERROR_MESSAGE",LocalizedMessageVO.prototype.SOCIAL_MESSAGE="SOCIAL_MESSAGE",LocalizedMessageVO.prototype.getProps=function(){return["id","messageType","messageId","locale","name","value"]},function(){angular.module("createTicketModule").controller("CreateKnownErrorController",["$scope","$modal","$state","$q","$filter","userModel","searchModel","events","createTicketModel","ticketModel","systemAlertService","metadataModel","ticketActionService","categoriesService","screenConfigurationModel","configurationModel","$timeout",function(e,t,a,n,i,o,r,s,l,c,d,u,p,m,f,g,h){function y(){e.state={dataIsLoading:!0,tooManyCompanies:!1,assigneeLoading:!0,initialLoading:!0},e.datePickerOptions={startingDay:g.getWeekStartingDay(),"show-weeks":!1,minDate:moment().year(1970).month(0).date(2),maxDate:moment().year(2038).month(0).date(18)},e.selections={},e.siteOptions={company:{visible:!1,attribute:"companyName"},region:{attribute:"region"},siteGroup:{attribute:"siteGroup"},site:{attribute:"name"}},e.formContainsInvalidFields=l.formContainsInvalidFields,l.currentTicket=I,e.ke=I,e.keMetadata=b,e.loggedInUserId=o.decodedUserId||o.userId,e.isNew=!0,e.company={},o.userFullData.availableForAssignment?e.availableForAssignment=o.userFullData.availableForAssignment:o.getFullCurrentUserData().then(function(){e.availableForAssignment=o.userFullData.availableForAssignment}),O();var t=u.getMetadataByType(EntityVO.TYPE_KNOWNERROR),a=c.getDraft(EntityVO.TYPE_KNOWNERROR);n.all([t,a]).then(function(t){var a=t[1];angular.extend(b,t[0]),I.selectedStatus=_.head(b.statuses),e.updateStatusReason(),I.selectedImpact=_.last(b.impacts),I.selectedUrgency=_.last(b.urgencies),I.selectedViewAccess=_.last(b.viewAccesses),I.id=a.id,I.displayId=a.displayId,I.categorizations=a.categorizations,I.accessMappings=a.accessMappings,I.company=a.company,I.supportGroup=a.supportGroup?a.supportGroup:{},I.coordinatorGroup=a.coordinatorGroup?a.coordinatorGroup:{},I.type=a.type,I.location=a.location?a.location:{},a.coordinator?(I.coordinator=a.coordinator,e.ke.coordinatorAutoAssign=!1):I.coordinator={},a.assignee?(I.assignee=a.assignee,e.ke.autoAssign=!1):I.assignee={},e.state.assigneeLoading=!1})["finally"](function(){e.state.dataIsLoading=!1,e.state.initialLoading=!1});var i=o.getFullCurrentUserData().then(function(){e.setCompany(o.userFullData)}),s=r.getOperatingCompanies(null,-1).then(function(t){e.selections.companies=_.cloneDeep(t.companies),e.state.tooManyCompanies=t.exceedsChunkSize}),d=f.loadScreenConfigurationAndCustomFieldLabels(ScreenConfigurationVO.prototype.KNOWN_ERROR_DETAILS_SCREEN,EntityVO.TYPE_KNOWNERROR);n.all([t,a,i,d,s]).then(function(){I.allCategories=_.cloneDeep(m.populateCategories(I.categorizations,b));var t=f.getEditableFieldsForScreen(ScreenConfigurationVO.prototype.KNOWN_ERROR_DETAILS_SCREEN);e.customFields=angular.copy(t),A(null,I.categorizations)})}function E(){var e=d.modal({type:"info",title:i("i18n")("common.notification.dirty.title"),text:i("i18n")("create.knownerror.companyChange.warning"),buttons:[{text:i("i18n")("common.button.yes"),data:!0},{text:i("i18n")("common.button.no"),data:!1}]});return e.result}function v(e,t){I.ghostEntity=!0,p.showAssignDialog(I,!0,t).result.then(function(t){S(t),e.currentTarget.focus()},function(){e.currentTarget.focus()})}function T(e,t){var a={};"problemcoordinator"===t?(a.manager={id:e.id,loginId:e.loginId,fullName:e.fullName,thumbnailMime:e.thumbnailMime,thumbnail:e.thumbnail},a.managerGroup={id:e.supportGroupId,name:e.supportGroup,organization:e.organization,company:e.company}):(a.assignee={id:e.id,loginId:e.loginId,fullName:e.fullName,thumbnailMime:e.thumbnailMime,thumbnail:e.thumbnail},a.group={id:e.supportGroupId,name:e.supportGroup,organization:e.organization,company:e.company}),S(a)}function S(t){t.autoAssign?e.clearAssignment():t.group&&(e.ke.autoAssign=!1,e.ke.assignee=t.assignee,e.ke.supportGroup=t.group),t.coordinatorAutoAssign?e.clearCoordinator():t.managerGroup&&(e.ke.coordinatorAutoAssign=!1,e.ke.coordinator=t.manager,e.ke.coordinatorGroup=t.managerGroup)}function C(){return e.createKnownerrorForm.$dirty||!_.isEmpty(I.attachments)}function O(){e.$on("$stateChangeStart",function(t,n,o){if(C()&&n.name!==EntityVO.TYPE_KNOWNERROR){t.preventDefault();var r=d.modal({title:i("i18n")("common.notification.dirty.title"),text:i("i18n")("common.notification.dirty.message"),buttons:[{text:i("i18n")("common.labels.yes"),data:{stateName:n.name,stateParams:o}},{text:i("i18n")("common.labels.no")}]});r.result.then(function(t){_.isEmpty(t)||(l.currentTicket=I={},e.createKnownerrorForm.$setPristine(),a.transitionTo(t.stateName,t.stateParams))})}})}function A(t,a){var n={},i={name:e.ke.company.name};n.depends=m.buildCategoriesForRootCause(a,e.keMetadata.allCategories),n.depends.productManufacturer=null,c.getRootCause(n,i).then(function(t){t&&(e.selections.rootCause=t)})}if(!g.isServerApplicationEnabled(EntityVO.TYPE_KNOWNERROR))return void a.go("unauthorized");e.currentDate=new Date;var I={type:EntityVO.TYPE_KNOWNERROR,autoAssign:!0,coordinatorAutoAssign:!0,customFields:{},targetDateDatePicker:{open:!1}},b={};e.getList=function(t,a){return"service"===t||"asset"===t?l.getList(t,a,EntityVO.TYPE_KNOWNERROR).then(function(a){
return"service"===t?(e.exceedsChunkSizeService=a.exceedsChunkSize,e.isTooltipOpenService=!0):"asset"===t&&(e.exceedsChunkSizeAsset=a.exceedsChunkSize,e.isTooltipOpenAsset=!0),h(function(){e.isTooltipOpenService=!1,e.isTooltipOpenAsset=!1},1e4),a.objects}):l.getList(t,a)},e.onInputFocusBlur=function(){e.isTooltipOpenService=!1,e.isTooltipOpenAsset=!1},e.setCompany=function(t){e.ke.company=t.company,e.ke.location={},e.ke.location.companyName=e.ke.company.name,e.company=_.cloneDeep(e.ke.company)},e.updateCompany=function(){E().then(function(t){t?(e.ke.company=_.cloneDeep(e.company),e.$broadcast(s.CLEAR_FOUNDATION_SERVICE,e.ke.company),e.$broadcast(s.CLEAR_CATEGORY_DETAILS,e.ke.company),e.ke.location.companyName=e.ke.company.name,I.selectedService="",I.selectedAsset="",I.rootCause=null,e.ke.coordinatorAutoAssign||(I.coordinator={}),I.autoAssign||(I.assignee={})):e.company=e.ke.company})},e.getCompaniesByName=function(e){return r.getCompaniesByText(e).then(function(e){return{list:e.companies,exceedsChunkSize:e.exceedsChunkSize}})},e.$watch("ke.company",function(){e.updatePriority()}),e.updatePriority=function(){I.company&&I.selectedImpact&&I.selectedUrgency&&c.getPriority(I.company.name,I.selectedImpact.name,I.selectedUrgency.name,EntityVO.TYPE_KNOWNERROR).then(function(e){I.calculatedPriority=_.find(b.priorities,{name:e}),I.calculatedPriority||d.error({text:i("i18n")("ticket.calculationError.calculatedPriority"),clear:!1})})},e.clearAssignment=function(){I.autoAssign=!0,I.assignee={},I.supportGroup={}},e.clearCoordinator=function(){I.coordinatorAutoAssign=!0,I.coordinator={},I.coordinatorGroup={}},e.clearSelectedService=function(){I.selectedService=""},e.clearSelectedAsset=function(){I.selectedAsset=""},e.assign=function(e){v(e)},e.assignToMe=function(e,t){var a=t,n=I.supportGroup;"ticketassignee"===t?a="":"problemcoordinator"===t&&(n=I.coordinatorGroup);var i,o=null,r=I.company;r=r?r.name:"",i=I.customer&&I.customer.company?I.customer.company.name:I.company?I.company.name:"",o=I.locationCompany?I.locationCompany.name:null,c.getTicketAssigneePersonsBySearchText(a,i,o,null,r,null).then(function(i){i=_.uniqBy(i.results,function(e){return e.loginId&&e.supportGroupId});var o=1===i.length?i[0]:_.find(i,{supportGroupId:n.id});o&&o.loginId?T(o,a):v(e,t)})},e.createKE=function(){e.state.dataIsLoading=!0,I.summary=I.summary.replace(/\u00a0/g," ");var t=_.cloneDeep(I.categorizations);I.categorizations=m.collectValues(I.allCategories,e.ke).categorizations,l.createKE().then(function(a){a&&(e.state.dataIsLoading=!1,I.categorizations=_.cloneDeep(t),d.error({text:a,clear:!0}))})},e.cancel=function(){a.go("dashboard")},e.needResolutionNote=function(){return~[EntityVO.STATUS_CLOSED,EntityVO.STATUS_RESOLVED].indexOf(I.selectedStatus.name.toLowerCase())},e.updateStatusReason=function(){_.isEmpty(I.selectedStatus.statusReasons)||(I.selectedStatusReason=_.head(I.selectedStatus.statusReasons))},e.openDatePicker=function(e){e.open=!0},e.updateDateTime=function(e){},e.$watch("ke.selectedService",function(){e.ke&&_.isObject(e.ke.selectedService)&&(e.ke.impactedService=e.ke.selectedService,e.$emit(s.AFFECTED_SERVICE_UPDATED,e.ke.selectedService))}),e.$on(s.TICKET_UPDATE_ROOTCAUSE,A),y()}])}(),function(){angular.module("ticketModule").directive("knownerrorDetailsEditor",["events","userModel","systemAlertService","$filter","categoriesService","ticketModel","searchModel",function(e,t,a,n,i,o,r){return{restrict:"E",replace:!0,templateUrl:"views/known-error/known-error-details-editor.html",scope:{ticket:"=",metadata:"="},link:function(t){function s(){var e=a.modal({type:"info",title:n("i18n")("common.notification.dirty.title"),text:n("i18n")("edit.knownerror.companyChange.warning"),buttons:[{text:n("i18n")("common.button.yes"),data:!0},{text:n("i18n")("common.button.no"),data:!1}]});return e.result}function l(){t.editMode=!0,c()}function c(){t.updatedInfo={company:t.ticket.company,workaround:t.ticket.workaround,resolution:t.ticket.resolution,viewAccess:_.head(_.filter(t.metadata.viewAccesses,{name:t.ticket.viewAccess})),rootCause:t.ticket.rootCause?{name:t.ticket.rootCause}:null}}function d(){var a=u();t.$emit(e.SAVE_CHANGES_REQUEST,a,t.ticket.isDraft)}function u(){var e={};return t.updatedInfo.company.name!==E.company.name&&(e.location={companyName:t.updatedInfo.company.name}),t.updatedInfo.workaround!==E.workaround&&(e.workaround=t.updatedInfo.workaround),t.updatedInfo.resolution!==E.resolution&&(e.resolution=t.updatedInfo.resolution),t.updatedInfo.viewAccess.name!==E.viewAccess&&(e.viewAccess=t.updatedInfo.viewAccess.name),e.rootCause=t.updatedInfo.rootCause?t.updatedInfo.rootCause.name:null,e}function p(){t.editMode=!1,c()}function m(){t.ticket=_.cloneDeep(E),t.editMode=!1}function f(a,n){_.isEmpty(n)||(t.ticket.company=n.company?n.company:t.ticket.company,t.ticket.workaround=n.workaround?n.workaround:"",t.ticket.resolution=n.resolution?n.resolution:"",t.ticket.viewAccess=n.viewAccess?n.viewAccess:t.ticket.viewAccess,t.ticket.rootCause=n.rootCause?n.rootCause:""),t.ticket.isDraft&&(g(),t.$emit(e.SAVE_CHANGES_COMPLETE)),p()}function g(){t.ticket.company=t.updatedInfo.company.name!==t.ticket.company.name?t.updatedInfo.company.name:t.ticket.company,t.ticket.viewAccess=t.updatedInfo.viewAccess.name!==t.ticket.viewAccess?t.updatedInfo.viewAccess.name:t.ticket.viewAccess,t.ticket.location=t.updatedInfo.location!==t.ticket.location?t.updatedInfo.location:t.ticket.location,t.ticket.rootCause=t.updatedInfo.rootCause?t.updatedInfo.rootCause.name:"",t.ticket.workaround=t.updatedInfo.workaround!==t.ticket.workaround?t.updatedInfo.workaround:t.ticket.workaround,t.ticket.resolution=t.updatedInfo.resolution!==t.ticket.resolution?t.updatedInfo.resolution:t.ticket.resolution}function h(){t.$broadcast(e.SAVE_CHANGES_COMPLETE),p()}function y(e,a){var n={};n.depends=i.buildCategoriesForRootCause(a,t.metadata.allCategories),n.depends.productManufacturer=null,o.getRootCause(n,t.ticket.company).then(function(e){e&&(t.selections.rootCause=e)})}t.state={tooManyCompanies:!1},t.siteOptions={company:{visible:!1,attribute:"companyName"},region:{attribute:"region"},siteGroup:{attribute:"siteGroup"},site:{attribute:"name"}};var E=_.cloneDeep(t.ticket);t.selections={companies:[],rootCause:[]},t.getCompaniesByName=function(e){return r.getCompaniesByText(e).then(function(e){return{list:e.companies,exceedsChunkSize:e.exceedsChunkSize}})},r.getOperatingCompanies(null,-1).then(function(e){t.selections.companies=_.cloneDeep(e.companies),t.state.tooManyCompanies=e.exceedsChunkSize}),t.updatedInfo={},y(null,t.ticket.categorizations),t.updateCompany=function(){s().then(function(a){a?(t.$broadcast(e.CLEAR_AFFECTED_SERVICE,t.updatedInfo.company),t.$broadcast(e.CLEAR_CATEGORY_DETAILS,t.updatedInfo.company),t.updatedInfo.rootCause=null):t.updatedInfo.company=t.ticket.company})},t.clear=function(e){t.updatedInfo[e]=null},c(),t.$on(e.TICKET_UPDATE_ROOTCAUSE,y),t.$on(e.SAVE_CHANGES,d),t.$on(e.TOGGLE_EDIT_MODE,l),t.$on(e.SAVE_ALL_CHANGES_COMPLETE,f),t.$on(e.SAVE_ALL_CHANGES_FAULT,h),t.$on(e.DISCARD_CHANGES,m)}}}])}(),function(){angular.module("layoutConfigModule").factory("layoutConfigurationModel",["$log","$q","layoutConfigurationService","screenConfigurationModel",function(e,t,a,n){function i(e){return e.panels.reduce(function(e,t){return e.push(t),t.panels&&(e=e.concat(i(t))),e},[])}var o={layoutsByScreenName:{}};return o.getLayoutFromCacheByScreenName=function(e){return angular.copy(o.layoutsByScreenName[e])},o.loadLayout=function(t){var n={};return arguments.length&&(n={screen:t}),a.loadLayout(n).then(function(e){return(e||[]).forEach(function(e){e.name&&(o.layoutsByScreenName[e.name]=e)}),angular.copy(e)})["catch"](function(t){throw e.error("Could not load screen configurations! ",t),t})},o.loadScreenLayout=function(e,a){var i,r=a?angular.noop():o.layoutsByScreenName[e];return i=r?t.when(r):n.isV2CompatibleScreen(e)?o.loadLayout(e):t.when({}),i.then(function(){return angular.copy(o.layoutsByScreenName[e])})},o.applyCustomizationChangesToScreenLayout=function(e){var t=o.layoutsByScreenName[e.parentScreenName],a=t.getRawLayout(),n=i(a),r=_.find(n,{id:e.id});return r.children=e.fields.map(function(e){return _.pick(e,["name","id","type","dataType"])}),r.name=e.name,o.updateScreenLayout(a,e.parentScreenName)},o.updateScreenLayout=function(e,t){return a.updateScreenLayout(t,e)},o}])}(),function(){angular.module("layoutConfigModule").service("layoutConfigurationService",["$resource","$http","$q",function(e,t,a){var n=e("/smartit/rest/customization",{},{loadLayout:{url:"/smartit/rest/v2/customization/screenlayout",method:"GET",transformResponse:[t.defaults.transformResponse[0],function(e){return[].concat(e)}],isArray:!0},updateLayout:{url:"/smartit/rest/customization/save/layout",method:"POST"}});this.loadLayout=function(e){return n.loadLayout(e).$promise.then(function(e){var t=e;return t.map(function(e){var t=(new LayoutConfigurationVO).build(e),a=_.find(t.panels,{name:"additionalInfo"});if(a){var n=_.findIndex(a.panels,{name:"additionalData"}),i=_.findIndex(a.panels,{name:"additionalData2"}),o=_.findIndex(a.panels,{name:"additionalData3"}),r=_.findIndex(a.panels,{name:"additionalData4"});n!==-1&&a.panels[n].children&&0!==a.panels[n].children.length||i!==-1&&a.panels[i].children&&0!==a.panels[i].children.length||o!==-1&&a.panels[o].children&&0!==a.panels[o].children.length||r!==-1&&a.panels[r].children&&0!==a.panels[r].children.length||(a.emptyPanel=!0)}return t})})},this.updateScreenLayout=function(e,t){return n.updateLayout({screen:e},t).$promise}}])}();var notConfigurablePanels=["statusSection","changeBannerSection","summarySection"],notExpandableSections=["titleSection"];LayoutConfigurationVO.prototype=Object.create(BaseVO.prototype),LayoutConfigurationVO.prototype.constructor=LayoutConfigurationVO,LayoutConfigurationVO.prototype.getProps=function(){return["id","name","layout","panels"]},LayoutConfigurationVO.prototype.postBuild=function(){markNotConfigurablePanels(this.panels),markNotExpandablePanels(this.panels)},LayoutConfigurationVO.prototype.getRawLayout=function(){var e=_.cloneDeep(this);return e.panels.forEach(function(e){angular.isUndefined(e.notConfigurable)||delete e.notConfigurable,angular.isUndefined(e.notExpandable)||delete e.notExpandable,angular.isUndefined(e.emptyPanel)||delete e.emptyPanel}),e},LayoutConfigurationVO.prototype.specialHandlingSections=[].concat(notExpandableSections),LayoutConfigurationVO.prototype.isCreateChangeLayout=function(){return this.name===ScreenConfigurationVO.prototype.CREATE_CHANGE_SCREEN},function(){angular.module("liveChatModule").constant("LIVE_CHAT_EVENTS",{sac_files_uploaded:"sac_files_uploaded",sac_on_request_chat_ticket_data:"sac_on_request_chat_ticket_data",sac_agent_chats:"sac_agent_chats",sac_login_completed:"sac_login_completed",sac_login_expired:"sac_login_expired",sac_open_confirmation_modal:"sac_open_confirmation_modal",sac_session_context_change:"sac_session_context_change",sac_session_released:"sac_session_released",sac_session_transferred:"sac_session_transferred",sac_session_abandoned:"sac_session_abandoned",sac_session_closed:"sac_session_closed",sac_session_cancelled:"sac_session_cancelled",sac_session_accepted:"sac_session_accepted",sac_questionnaire_user_response:"sac_questionnaire_user_response",sac_end_questionnaire:"sac_end_questionnaire",sac_notify_on_change:"sac_notify_on_change",sac_notify_on_error:"sac_notify_on_error",sac_launch_live_chat:"sac_launch_live_chat",sac_gpt_summary:"sac_gpt_summary"}).constant("LIVE_CHAT_APP_EVENTS",{app_event_confirm_release_session:"app_event_confirm_release_session",app_event_confirm_close_session:"app_event_confirm_close_session",app_event_confirm_abandon_session:"app_event_confirm_abandon_session",app_send_message_to_chat:"app_send_message_to_chat",app_relate_ticket_to_chat:"app_relate_ticket_to_chat",app_request_chat_ticket_data:"app_request_chat_ticket_data",app_unrelate_ticket:"app_unrelate_ticket",app_save_appData:"app_save_appData",app_display_chat:"app_display_chat",app_gpt_summary:"app_gpt_summary"})}(),function(){angular.module("liveChatModule").controller("LiveChatController",["$scope","$rootScope","$http","$sce","i18nService","localStorageService","systemAlertService","$window","configurationModel","authService","roles","userModel","events","metadataModel","ticketModel","relationModel","$q","$filter","$state","utilityFunctions","smartRecorderModel","searchService","feedModel","attachmentService","personModel","$timeout","authModel","liveChatService","LIVE_CHAT_EVENTS","LIVE_CHAT_APP_EVENTS","permissionModel","knowledgeArticleModel",function(e,t,a,n,i,o,r,s,l,c,d,u,p,m,f,g,h,y,E,v,T,S,C,O,A,I,b,k,D,R,P,w){function L(){var e=angular.element("#live__agent-customer-tab");e.find("a").click()}function N(t){var a=window.frames.liveChatFrame;void 0!==a&&null!==a&&(a.postMessage(t,e.eschatServerUrl),console.log("Message Sent To Frame:"+JSON.stringify(t)))}function M(t,a){if(a.sessionid===e.selectedChat.sessionid)e.selectedChat.ticket&&e.selectedChat.ticket.ticketId&&z(e.selectedChat.ticket.ticketId,e.selectedChat.ticket.ticketType,{text:i.getLocalizedString("live.chat.attachment.worknote"),attachments:t});else{var n=_.findIndex(e.agentChats,{sid:a.sessionid});if(e.agentChats[n]&&e.agentChats[n].selectedChatContext&&e.agentChats[n].selectedChatContext.ticket)z(e.agentChats[n].selectedChatContext.ticket.ticketId,e.agentChats[n].selectedChatContext.ticket.ticketType,{text:i.getLocalizedString("live.chat.attachment.worknote"),attachments:t});else if(a&&a.metadata&&a.metadata.ticketid){var o,r={search_text:a.metadata.ticketid},s={types:["tickets"]};S.getGlobalSearchResults(r,s).then(function(e){!_.isEmpty(e.items)&&e.items[0]&&e.items[0].results&&e.items[0].results.length&&(o=_.find(e.items[0].results,{displayId:a.metadata.ticketid}),o&&z(o.ticketId,o.ticketType,{text:i.getLocalizedString("live.chat.attachment.worknote"),attachments:t}))})}}}function V(e,t,a){if(q(e.type,e,t,"createTicket",a),a){var n={};n.desc=e.summary,n.displayId=e.displayId,n.id=a.id,n.parentDisplayId=a.displayId,n.tag=e.type===EntityVO.TYPE_INCIDENT?EntityVO.TYPE_RESOURCE:EntityVO.TYPE_LINKEDITEM,n.relationshipType=EntityVO.TYPE_RELATEDTO,n.type=e.type,B(e.id,e.type,[n])}}function F(e){var t,a=[];return e&&e.chatLog&&(_.forEach(e.chatLog,function(e){var t,n,i=document.createElement("div");i.innerHTML=e.TEXT;var o=i.innerText;n=o.replace(/(<([^>]+)>)/gi,""),t=e.NAME+" ("+y("date")(e.UTCEPOCHTIMESTAMP,"short")+"): "+n+"\n\n",a.push(t)}),a=a.join(" "),a=i.getLocalizedString("live.chat.transcript.worknote")+"\n\n"+a),e&&e.chatNotes&&(t=i.getLocalizedString("live.chat.inline.notes.worknote")+"\n\n"+e.chatNotes),{chatLog:a,chatInlineNotes:t}}function x(){var e=!0;try{window.Notification||(console.info("Notification API not supported on this platform"),e=!1)}catch(t){e=!1}return e&&"denied"===window.Notification.permission&&(console.info("Notification API permission denied."),e=!1),e&&"granted"!==window.Notification.permission&&window.Notification.requestPermission().then(function(e){var t=!0;switch(e){case"granted":t=!1;break;case"denied":t=!0}console.info("Notification API permission status= "+window.Notification.permission+",needsPermission= "+t)}),e}function G(){var a=l.get("eschatConfiguration"),i=a.enableESChatIntegration||l.enableESChatIntegration;if(!l.isServerApplicationEnabled(EntityVO.TYPE_LIVE_CHAT)||!i)return console.info("LiveChat.init() either Eschat application or ESChatIntegration is disabled. Navigating to dashboard."),void E.go("dashboard");if(!a.eschatServerUrl)return e.showUnableToLoadMsg=!0,void(e.state.loadingLiveChat=!1);if(e.showUnableToLoadMsg=!1,"dashboard"===E.current.data.path&&(e.hideForDashboard=!0),a.eschatServerUrl){o.set("eschatServerUrl",a.eschatServerUrl),e.eschatServerUrl=a.eschatServerUrl,e.smartITURL=window.location&&window.location.origin;var r=E.current.data.path,s="";t.locale&&(s=s+"&locale="+t.locale),t.timezone&&(s=s+"&timezone="+t.timezone);var c=(new Date).getTime(),d="?"+c,u=a.eschatServerUrl+"/"+d,f=u+"#?uid="+encodeURIComponent(e.userid)+s+"&embedded=smartit&path="+r;e.crossLaunchLiveChatURL=n.trustAsResourceUrl(f)}e.assignTicketToLiveAgent=a.assignTicketToLiveAgent,e.allowedWindowEvents=[p.TICKET_CREATED_FROM_DRAFT,p.LIVECHAT_CREATEINCIDENT_SUCCESS,p.LIVECHAT_CREATEWORKORDER_SUCCESS,p.DRAFT_TICKET_CLOSED],be(),L(),Ee(),m.getMetadataByType(EntityVO.TYPE_GLOBAL).then(function(t){e.createCallLogEnabled=t&&t.configurationParameters&&"true"===t.configurationParameters.enableSmartRecorderCallLog})}function $(t,a){var n,i,o,s=m.getMetadataByType(e.ticketType);if(a&&(a.templateGuid||a.templateId))o=a.templateGuid||a.templateId;else if(!a){var l=e.selectedChatTicketConfig[e.ticketType].defaultTemplate;e.selectedTemplate?o=e.selectedTemplate.id:l&&(o=l.id)}_.isEmpty(f.cache.draft)||delete f.cache.draft;var c=f.getDraft(e.ticketType,o);h.all([s,c]).then(function(s){if(n=s[0],i=s[1],!s[1]||!s[1].id)return e.state.creatingTicket=!1,void r.error({text:y("i18n")("error.unknown"),clear:!1});o&&(i.templateGuid=o),i.chatSessionId=e.selectedChat.sessionid,a&&(a.templateGuid||a.templateId)?i.summary=a.summary:i.summary=e.selectedChat.metadata.title.substring(0,_e),a&&_.isEmpty(i.desc)&&(i.desc=a.detailedDescription),a&&_.isEmpty(i.priority)&&(i.priority=a.priority);var l=_.find(i.categorizations,{name:"operational"}),c=_.find(i.categorizations,{name:"product"});if((Object.keys(l.tiers).length<1||Object.keys(c.tiers).length<1)&&a&&a.categorizations){var d=_.find(a.categorizations,{name:"operational"}),u=_.find(a.categorizations,{name:"product"});i.categorizations=[],i.categorizations.push(d),i.categorizations.push(u)}a&&a.reportedSource?i.reportedSource=a.reportedSource:i.reportedSource="Chat",e.selectedChat.customer&&(i.customer=e.selectedChat.customer),e.ticketType!==EntityVO.TYPE_INCIDENT||i.priority||(i.impact||(i.impact=_.last(n.impacts).name),i.urgency||(i.urgency=_.last(n.urgencies).name)),!o&&e.assignTicketToLiveAgent?k.assignToMe("ticketassignee",i,t,e):J("e",{ticket:i,chatSession:t})})}function B(e,t,a){g.addRelation({uuid:e,type:t},a)}function U(e,t){var a={chatLog:e.chatlog,chatNotes:e.chatnotes,attachments:e.attachments},n=F(a);if(n.chatLog&&z(t.ticketId,t.ticketType,{text:n.chatLog},e.sessionid),n.chatInlineNotes&&z(t.ticketId,t.ticketType,{text:n.chatInlineNotes},e.sessionid),e.attachments&&e.attachments.length){var i=e.attachments;if(i.length>3)for(var o=3,r=void 0,s=0,l=i.length;s<l;s+=o)r=i.slice(s,s+o),M(r,e);else M(i,e)}}function z(e,t,a,n){var i,o={type:t,id:e};return a.attachments?(i={noteText:a.text,access:!0,type:35e3,attachments:a.attachments},O.addWorknoteWithAttachment(o,i)):(i={noteText:a.text,access:!0,workInfoType:35e3,chatSessionId:n},C.saveNote(o,i))}function Y(t,a){return e.createCallLogEnabled?(a||(e.state.creatingCallLog=!0),void m.getMetadataByType(EntityVO.TYPE_SMART_RECORDER).then(function(n){if(t){n&&(e.eventTypes=n.callLogEventTypes);var o={persons:[]},s={};t.customer&&(s.personId=t.customer.personId,s.fullName=t.customer.fullName,s.personType="customer",o.persons.push(s)),o.description=t.metadata.title,t.customerCompany&&(o.company=t.customerCompany.name);var l=e.eventTypes.findIndex(function(e){return"Chat"===e.value});o.callLogEventType=l!==-1?e.eventTypes[l]:{label:"Chat",value:"Chat"},o.chatSessionId=t.sessionid,T.postCallLog(o).then(function(){a||(r.success({text:i.getLocalizedString("live.chat.createCallLog.success"),clear:!0,hide:1e4}),e.state.creatingCallLog=!1)},function(t){a||(r.error({text:t&&t.data&&t.data.error||t,clear:!0,hide:1e4}),e.state.creatingCallLog=!1)}),a||(e.selectedChat=null),a&&a===t.sessionid&&(e.selectedChat=null,a=null),t=null}else console.error("Could not create a call log"),e.state.creatingCallLog=!1})):(t=null,void r.success({text:i.getLocalizedString("live.chat.createCallLog.success"),clear:!0,hide:1e4}))}function q(t,a,n,i,o){var s,l=_.findIndex(e.agentChats,{sid:n.sessionid});n.selectedResources&&(s=n.selectedResources);var c=he(s,n.sessionid);de(c,a,a.id,t||e.ticketType);var d={ticketType:t,ticketDisplayId:a.displayId,ticketId:a.id};e.selectedChat.sessionid===n.sessionid&&(e.selectedChat.ticket=d),l!==-1&&e.agentChats[l].selectedChatContext&&(e.agentChats[l].selectedChatContext.ticket=d);var u;"createTicket"===i?o&&o.status&&("Resolved"===o.status.value||"Closed"===o.status.value||"Completed"===o.status.value||"Cancelled"===o.status.value)?(u=y("i18n")("live.chat.closed.ticket.relate.success",[v.getTicketCreatedSuccessMessageWithLink(a.id,a.displayId,t,!0)]),K(n.sessionid,d,o)):o&&o.chatSessionId?(u=y("i18n")("live.chat.associated.ticket.relate.success",[v.getTicketCreatedSuccessMessageWithLink(a.id,a.displayId,t,!0)]),K(n.sessionid,d,o)):(u=y("i18n")("smartrecorder.quickTicketCreate.success",[v.getTicketCreatedSuccessMessageWithLink(a.id,a.displayId,t,!0)]),K(n.sessionid,null,null,null,null,a)):"updateTicket"===i&&(u=y("i18n")("live.chat.ticket.update.success",[v.getTicketCreatedSuccessMessageWithLink(a.id,a.displayId,t,!0)]),K(n.sessionid,d)),r.success({text:u,clear:!0,hide:1e4,isHTML:!0}),n&&(U(n,d),H(t,a.id,a.displayId,n.sessionid)),e.$broadcast("personDataUpdated",!0),e.relatedTicketData=null}function H(t,a,n,i,o){S.getRequestForRelatedTicket(a).then(function(r){var s={data:{chatSessionId:i,ticketId:n,ticketType:t},event:o?R.app_unrelate_ticket:R.app_relate_ticket_to_chat},l=t,c=n;if(r&&r.appInstanceId===a&&r.srDisplayId&&r.srDisplayId.length>0&&(l=EntityVO.TYPE_SERVICEREQUEST,c=r.srDisplayId),o){s.data.endUserTicketType=l,s.data.endUserTicketId=c,K(i,null,null,o);var d=y("i18n")("ticket.type."+l)+" "+c+" "+y("i18n")("live.chat.ticket.unrelate.message");s.data.unRelateMessage=d,N(s),e.state.creatingTicket=!1}else{var u={type:l,ticketId:c};r&&r.srDisplayId&&(s.data.endUserTicketType=EntityVO.TYPE_SERVICEREQUEST,s.data.endUserTicketId=r.srDisplayId),N(s);var d=y("i18n")("ticket.type."+l)+" "+c+" "+y("i18n")("live.chat.ticket.message");u.messageToSend=d,I(function(){se(null,u,i),e.state.creatingTicket=!1,e.createTicketInProgressForChatSessionSet["delete"](i)},1e3)}})}function K(t,a,n,i,o,r){var s,c,d,u=[];if(o){if(o.selectedKnowledge){var p;_.forEach(o.selectedKnowledge,function(e){p={id:e.id,displayId:e.displayId,type:EntityVO.TYPE_KNOWLEDGE},l.comaroundEnabled&&(p.title=e.title),u.push(p)})}c=o.summaryText||o.summary}else u=e.selectedChat.applicationData&&e.selectedChat.applicationData.pinnedArticles,c=e.selectedChat.applicationData&&e.selectedChat.applicationData.searchText;s=a?{parentId:n&&n.id?n.id:"",parentDisplayId:n&&n.displayId?n.displayId:"",parentType:n&&n.type?n.type:"",id:a.ticketId,displayId:a.ticketDisplayId,type:a.ticketType,associationType:n?"create":"update"}:e.selectedChat.applicationData&&e.selectedChat.applicationData.ticketAssociationDetails,i&&(e.selectedChat.applicationData.ticketAssociationDetails={},s={},u=e.selectedChat.applicationData&&e.selectedChat.applicationData.pinnedArticles,c=e.selectedChat.applicationData&&e.selectedChat.applicationData.searchText),d=r?{ticketId:r.id,ticketDisplayId:r.displayId,ticketType:r.type}:e.selectedChat.applicationData&&e.selectedChat.applicationData.newTicketDetails,e.selectedChat.applicationData={ticketAssociationDetails:s,pinnedArticles:u,searchText:c,newTicketDetails:d};var m=JSON.stringify(e.selectedChat.applicationData),f={data:{chatSessionId:t,appData:m},event:R.app_save_appData};console.log("Saving app data:"+JSON.stringify(f)),N(f)}function j(t,a,n){if(e.noOfDraftScreensOpen=++e.noOfDraftScreensOpen,e.selectedChat&&e.selectedChat.applicationData&&e.selectedChat.applicationData.pinnedArticles&&(n.selectedResources=e.selectedChat.applicationData.pinnedArticles),e.chatTicketDataForCreateMap.set(n.sessionid,n),e.createTicketInProgressForChatSessionSet["delete"](n.sessionid),e.state.creatingTicket=!1,o.set("draft.ticket",f.cache.draft),o.set("draft.ticket.error",a&&a.data&&a.data.error||a),!a||!a.data||a&&a.data&&a.data.error.indexOf("ERROR (382)")===-1){var i=E.href("liveChatDraft",{draftType:t});s.open(i,"_blank")}}function W(t,a){r.modal({type:"info",title:y("i18n")("live.chat.notification.title"),text:y("i18n")("live.chat.ticket.relate.confirmation.message"),buttons:[{text:y("i18n")("common.button.yes"),data:!0},{text:y("i18n")("common.button.no"),data:!1}]}).result.then(function(t){if(t){e.relatedTicketData=a.ticket;var n=e.selectedChatTicketConfig[a.ticket.type].allowTicketToAssociateWithDifferentChat||!1;if(a.ticket&&(a.ticket.chatSessionId&&!n||a.ticket.status&&("Resolved"===a.ticket.status.value||"Closed"===a.ticket.status.value||"Completed"===a.ticket.status.value||"Cancelled"===a.ticket.status.value)))e.createTicket(a.ticket.type);else{e.state.creatingTicket=!0,e.relateTicketToChatInProgress=!0;var i={event:R.app_request_chat_ticket_data,data:{chatSessionId:a.chat&&a.chat.sessionid}};N(i),e.state.createTicketRequestPendingFromLC=!0,I(function(){e.state.creatingTicket===!0&&e.state.createTicketRequestPendingFromLC===!0&&(e.state.creatingTicket=!1,console.log("No response from live chat on saving ticket to chat"),r.error({text:y("i18n")("error.unknown"),clear:!1}))},Ce)}}})}function Q(t,a){r.modal({type:"info",title:y("i18n")("live.chat.notification.title"),text:y("i18n")("live.chat.ticket.unrelate.confirmation.message"),buttons:[{text:y("i18n")("common.button.yes"),data:!0},{text:y("i18n")("common.button.no"),data:!1}]}).result.then(function(t){if(t){e.state.creatingTicket=!0;var n={chatSessionId:""};a.ticket.id?f.update(a.ticket.id,a.ticket.type,n).then(function(t){if(t&&t.data&&t.data.error)return r.error({text:t.data.error,clear:!0,hide:1e4}),void(e.state.creatingTicket=!1);var n=y("i18n")("live.chat.ticket.unrelate.success",[v.getTicketCreatedSuccessMessageWithLink(a.ticket.id,a.ticket.displayId,a.ticket.type,!0)]);r.success({text:n,clear:!0,hide:1e4,isHTML:!0}),e.$broadcast("personDataUpdated",!0),e.selectedChat.sessionid&&H(a.ticket.type,a.ticket.id,a.ticket.displayId,e.selectedChat.sessionid,!0);var i=y("i18n")("live.chat.ticket.unrelate.worknote",[e.user.fullName]);if(z(a.ticket.id,a.ticket.type,{text:i}),e.selectedChat.applicationData&&e.selectedChat.applicationData.ticketAssociationDetails&&"create"===e.selectedChat.applicationData.ticketAssociationDetails.associationType){var o={},s=[];o.parentType=e.selectedChat.applicationData.ticketAssociationDetails.parentType,o.parentId=e.selectedChat.applicationData.ticketAssociationDetails.parentId;var l={};l.id=e.selectedChat.applicationData.ticketAssociationDetails.id,l.type=e.selectedChat.applicationData.ticketAssociationDetails.type,l.details={parentDisplayId:e.selectedChat.applicationData.ticketAssociationDetails.parentDisplayId},l.relationshipType=EntityVO.TYPE_RELATEDTO,s.push(l),g.removeRelation(o,s);var c={confirmationEvent:R.app_unrelate_ticket};pe(e.selectedChat.ticket,c,null,null,null,!0)}var d=_.findIndex(e.agentChats,{sid:e.selectedChat.sessionid});d!==-1&&e.agentChats[d].selectedChatContext&&e.agentChats[d].selectedChatContext.ticket&&(e.agentChats[d].selectedChatContext.ticket=null),e.selectedChat.ticket=null}):e.state.creatingTicket=!1}})}function J(t,a){var n=a.ticket,i=a.chatSession,o=e.relatedTicketData,r=_.cloneDeep(n);r=ye(r,e.ticketType);var s=e.selectedChatTicketConfig[e.ticketType].openDraftModeByDefault;s===!0&&e.isAutoCreateTicketEnabled===!1?(f.cache.draft=n,j(e.draftType,null,i)):f.saveQuickTicketDraft(e.ticketType,r).then(function(){V(r,i,o)})["catch"](function(t){f.cache.draft=n,j(e.draftType,t,i)})}function Z(t,a){e.relateTicketToChatInProgress=!1;var n={chatSessionId:a&&a.sessionid};t.id&&f.update(t.id,t.type,n).then(function(n){return n&&n.data&&n.data.error?(r.error({text:n.data.error,clear:!0,hide:1e4}),void(e.state.creatingTicket=!1)):void q(t.type,t,a,"updateTicket")})}function X(){if(e.selectedChatTicketConfig={incident:{defaultTemplate:{type:"incidentTemplate",id:""},openDraftModeByDefault:!1,allowTicketToAssociateWithDifferentChat:!1},workorder:{defaultTemplate:{type:"workorderTemplate",id:""},openDraftModeByDefault:!1,allowTicketToAssociateWithDifferentChat:!1}},"Assigned"===e.selectedChat.status){if(!e.ticketCreationConfigCompanyMap)return e.isIncidentCreateAllowed=!0,e.isWOCreateAllowed=!0,void(e.selectedChat.allowedTicketTypes=[EntityVO.TYPE_INCIDENT,EntityVO.TYPE_WORKORDER]);var t=e.context.company?e.context.company.toLowerCase():"global",a=e.ticketCreationConfigCompanyMap[t];if(a||(a=e.ticketCreationConfigCompanyMap.global),e.selectedChat.ticket){var n=e.selectedChat.ticket.ticketType;a[n].openTicketOnClose&&("view"!==a[n].openTicketOnCloseMode&&"forceEdit"!==a[n].openTicketOnCloseMode&&(a[n].openTicketOnCloseMode="view"),e.selectedChatTicketConfig[n].openTicketOnClose=a[n].openTicketOnClose,e.selectedChatTicketConfig[n].openTicketOnCloseMode=a[n].openTicketOnCloseMode,e.selectedChatTicketConfig[n].allowTicketToAssociateWithDifferentChat=a[n].allowTicketToAssociateWithDifferentChat)}else{if(e.isAutoCreateTicketEnabled=a.autoCreate||!1,e.isAutoCreateTicketEnabled?e.autoCreateDefaultTicket=e.selectedChat.autoCreateTicketType:(e.selectedChat.autoCreateTicketType=void 0,e.selectedChat.autoCreateTemplateId=void 0),e.autoCreateDefaultTicket!==EntityVO.TYPE_INCIDENT&&e.autoCreateDefaultTicket!==EntityVO.TYPE_WORKORDER&&(e.autoCreateDefaultTicket=null,e.selectedChat.autoCreateTemplateId=void 0),null!==e.autoCreateDefaultTicket||a.autoCreateDefaultTicket!==EntityVO.TYPE_INCIDENT&&a.autoCreateDefaultTicket!==EntityVO.TYPE_WORKORDER||(e.autoCreateDefaultTicket=a.autoCreateDefaultTicket),a&&a.hasOwnProperty(EntityVO.TYPE_INCIDENT)){var i=a[EntityVO.TYPE_INCIDENT];e.isIncidentCreateAllowed=i.hideCreateOption!==!0,e.selectedChatTicketConfig.incident.openDraftModeByDefault=i.openDraftModeByDefault||!1,e.selectedChatTicketConfig.incident.allowTicketToAssociateWithDifferentChat=i.allowTicketToAssociateWithDifferentChat||!1;var o=e.selectedChat.autoCreateTemplateId||i.defaultTemplateId;(e.isIncidentCreateAllowed===!0||e.isAutoCreateTicketEnabled&&e.autoCreateDefaultTicket===EntityVO.TYPE_INCIDENT)&&o&&(e.selectedChatTicketConfig.incident.defaultTemplate.id=o)}else e.isIncidentCreateAllowed=!0;if(e.isWOInstalled&&a&&a.hasOwnProperty(EntityVO.TYPE_WORKORDER)){var r=a[EntityVO.TYPE_WORKORDER];e.isWOCreateAllowed=r.hideCreateOption!==!0,e.selectedChatTicketConfig.workorder.openDraftModeByDefault=r.openDraftModeByDefault||!1,e.selectedChatTicketConfig.workorder.allowTicketToAssociateWithDifferentChat=r.allowTicketToAssociateWithDifferentChat||!1;var o=e.selectedChat.autoCreateTemplateId||r.defaultTemplateId;(e.isWOCreateAllowed===!0||e.isAutoCreateTicketEnabled&&e.autoCreateDefaultTicket===EntityVO.TYPE_WORKORDER)&&o&&(e.selectedChatTicketConfig.workorder.defaultTemplate.id=o)}else e.isWOInstalled?e.isWOCreateAllowed=!0:e.isWOCreateAllowed=!1;if(e.isAutoCreateTicketEnabled&&e.autoCreateDefaultTicket)e.createTicket(e.autoCreateDefaultTicket);else if(!e.isAutoCreateTicketEnabled){var s=[];if(e.isIncidentCreateAllowed&&s.push(EntityVO.TYPE_INCIDENT),e.isWOInstalled&&e.isWOCreateAllowed&&s.push(EntityVO.TYPE_WORKORDER),0===s.length&&s.push("none"),e.context.searchTicketTypes=s,e.selectedChat.allowedTicketTypes=s,1===s.length){var l=!1,c=_.findIndex(e.agentChats,{sid:e.selectedChat.sessionid});c!==-1&&e.agentChats[c].selectedChatContext&&e.agentChats[c].selectedChatContext.selectedTemplate&&(l=!0),l||(ae({},e.selectedChatTicketConfig[s[0]].defaultTemplate),e.context.selectedTemplate=e.selectedTemplate)}}}}}function ee(t,a){e.selectedChat.user===a.id?(e.selectedChat.customer=a,e.selectedChat.customerCompany=a.company,e.context.chatUserCompany=a.company&&a.company.name,e.context.company=e.context.chatUserCompany,e.context.customerId=a.id,X()):e.selectedChat.user!==A.personDetails.id&&(A.getPersonDetailsByID(e.selectedChat.user).then(function(t){A.personDetails=t,e.$broadcast("personDataUpdated")}),console.warn("selected chat user id: "+e.selectedChat.user+", does not match with person id: "+a.id))}function te(t){if(t){var a=_.findIndex(e.agentChats,{
sid:e.selectedChat.sessionid});a!==-1&&e.agentChats.splice(a,1)}e.selectedChat=null,e.$broadcast(p.ON_SELECTED_LIVE_CHAT),A.personDetails=[],e.$broadcast("personDataUpdated"),I(function(){e.state.appModalEventConfirmWaiting=!1},1e3)}function ae(t,a){if(e.selectedChat&&a&&a.id&&(e.isWOCreateAllowed&&"workorderTemplate"===a.type||e.isIncidentCreateAllowed&&"incidentTemplate"===a.type)){e.selectedTemplate=a;var n=_.findIndex(e.agentChats,{sid:e.selectedChat.sessionid});n!==-1&&e.agentChats[n].selectedChatContext&&(e.agentChats[n].selectedChatContext.selectedTemplate=e.selectedTemplate)}}function ne(){if(e.selectedChat){e.selectedTemplate=null;var t=_.findIndex(e.agentChats,{sid:e.selectedChat.sessionid});t!==-1&&e.agentChats[t].selectedChatContext&&(e.agentChats[t].selectedChatContext.selectedTemplate=e.selectedTemplate)}}function ie(t,a,n){if(e.selectedChat){angular.extend(a,{tag:EntityVO.TYPE_RESOURCE,relationshipType:RelationItemVO.TYPE_RELATEDTO,isKASharedWithUser:n});var i=_.findIndex(e.agentChats,{sid:e.selectedChat.sessionid});if(i!==-1&&e.agentChats[i].selectedChatContext)if(e.agentChats[i].selectedChatContext.selectedKnowledge){var o=_.findIndex(e.agentChats[i].selectedChatContext.selectedKnowledge,{id:a.id});o===-1&&e.agentChats[i].selectedChatContext.selectedKnowledge.push(a)}else e.agentChats[i].selectedChatContext.selectedKnowledge=[],e.agentChats[i].selectedChatContext.selectedKnowledge.push(a);K(e.selectedChat.sessionid,null,null,null,e.agentChats[i].selectedChatContext),g.cache[e.selectedChat.sessionid]=g.cache[e.selectedChat.sessionid]&&g.cache[e.selectedChat.sessionid].length?g.cache[e.selectedChat.sessionid]:[];var r=_.findIndex(g.cache[e.selectedChat.sessionid],{id:a.id});r===-1&&g.cache[e.selectedChat.sessionid].push(a)}}function oe(t,a){if(e.selectedChat){var n=_.findIndex(e.agentChats,{sid:e.selectedChat.sessionid});if(n!==-1&&e.agentChats[n].selectedChatContext&&e.agentChats[n].selectedChatContext.selectedKnowledge){var i=_.findIndex(e.agentChats[n].selectedChatContext.selectedKnowledge,{id:a.id});e.agentChats[n].selectedChatContext.selectedKnowledge.splice(i,1)}if(K(e.selectedChat.sessionid,null,null,null,e.agentChats[n].selectedChatContext),g.cache[e.selectedChat.sessionid]&&g.cache[e.selectedChat.sessionid].length>0){var o=_.findIndex(g.cache[e.selectedChat.sessionid],{id:a.id});g.cache[e.selectedChat.sessionid].splice(o,1)}}}function re(t,a){if(e.selectedChat){var n=_.findIndex(e.agentChats,{sid:e.selectedChat.sessionid});n!==-1&&e.agentChats[n].selectedChatContext&&(e.agentChats[n].selectedChatContext.summaryText=a,K(e.selectedChat.sessionid,null,null,null,e.agentChats[n].selectedChatContext))}}function se(t,a,n){if(e.selectedChat){var i,o;if(a.type===EntityVO.TYPE_KNOWLEDGE){if(!a.additionalInformation&&!a.additionalInformation.crossLaunchURL)return;var r=a.additionalInformation&&a.additionalInformation.crossLaunchURL,s=y("i18n")("live.chat.KA.sharedWithUser");i="<span>"+s+"<br><a href='"+r+"' target='_blank'>"+a.displayId+": "+a.title+"</a></span>",ie(t,a,!0),o=e.selectedChat.sessionid}else i=a.messageToSend,o=n;var l={data:{chatSessionId:o,messageToSend:i,type:a.type,ticketId:a.ticketId||a.displayId},event:R.app_send_message_to_chat};N(l)}}function le(t){var a,n,o=t.chatData.modalTitle,r={confirmationData:t.action.confirmationData,confirmationEvent:t.action.confirmationEvent};t.action.confirmationEvent===R.app_event_confirm_close_session||t.action.confirmationEvent===R.app_event_confirm_abandon_session?e.selectedChat.ticket?t.action.confirmationEvent===R.app_event_confirm_close_session?f.getTicketDetails(e.selectedChat.ticket.ticketId,e.selectedChat.ticket.ticketType,!0).then(function(e){e?e.status&&e.status.value?e.type===EntityVO.TYPE_INCIDENT&&("Resolved"===e.status.value||"Cancelled"===e.status.value||"Closed"===e.status.value)||e.type===EntityVO.TYPE_WORKORDER&&("Completed"===e.status.value||"Cancelled"===e.status.value||"Closed"===e.status.value)?(a=t.chatData&&t.chatData.modalMessage?t.chatData.modalMessage:y("i18n")("live.chat.close.with.closed.ticket",[t.chatData.session.user.first_name,t.chatData.session.user.last_name]),n=ce(!1,r,t),ue(o,a,n,null,!0)):(a=i.getLocalizedString("live.chat.close.with.ticket"),n=ce(!0,r,t),ue(o,a,n)):(a=t.chatData&&t.chatData.modalMessage?t.chatData.modalMessage:y("i18n")("live.chat.close.with.closed.ticket",[t.chatData.session.user.first_name,t.chatData.session.user.last_name]),n=ce(!1,r,t),ue(o,a,n,!0)):(a=i.getLocalizedString("live.chat.close.with.ticket"),n=ce(!0,r,t),ue(o,a,n))})["catch"](function(e){a=i.getLocalizedString("live.chat.close.with.ticket"),n=ce(!0,r,t),ue(o,a,n)}):t.action.confirmationEvent===R.app_event_confirm_abandon_session&&(a=i.getLocalizedString("live.chat.abandon.with.ticket"),n=ce(!1,r,t),ue(o,a,n)):(a=t.action.confirmationEvent===R.app_event_confirm_close_session?i.getLocalizedString("live.chat.close.without.ticket"):i.getLocalizedString("live.chat.abandon.without.ticket"),n=ce(!1,r,t),ue(o,a,n)):(a=t.chatData.modalMessage,n=ce(!1,r,t),ue(o,a,n))}function ce(e,t,a){var n;return n=e?[{text:i.getLocalizedString("common.button.yes"),data:{option:"yes",confirmationData:t,session:a.chatData.session}},{text:i.getLocalizedString("common.button.no"),data:{option:"no",confirmationData:t,session:a.chatData.session}},{text:i.getLocalizedString("common.button.cancel"),data:!1}]:[{text:i.getLocalizedString("common.button.yes"),data:{option:"yes",confirmationData:t,session:a.chatData.session}},{text:i.getLocalizedString("common.button.cancel"),data:!1}]}function de(e,t,a,n){if(_.forEach(e,function(e){delete e.isKASharedWithUser}),e.length>0){if(l.comaroundEnabled){var i=_.remove(e,{type:EntityVO.TYPE_KNOWLEDGE});i&&i.length&&g.bulkAddRelationHKM({uuid:t.displayId||t.ticketDisplayId},i)}e.length>0&&B(a,n,e)}}function ue(t,a,n,i,o){r.modal({title:t,text:a,buttons:n}).result.then(function(t){if(t){e.state.appModalEventConfirmWaiting=!0;var a=_.findIndex(e.agentChats,{sid:e.selectedChat.sessionid});if(i)te(!0);else{var n=e.agentChats[a]&&e.agentChats[a].selectedChatContext&&e.agentChats[a].selectedChatContext.ticket;if(t.confirmationData.confirmationEvent===R.app_event_confirm_close_session||t.confirmationData.confirmationEvent===R.app_event_confirm_abandon_session)if(n){if("yes"!==t.option||o){if("no"===t.option||o){if(U(t.session,n),e.agentChats[a].selectedChatContext&&e.agentChats[a].selectedChatContext.selectedKnowledge){var r=he(e.agentChats[a].selectedChatContext.selectedKnowledge,e.selectedChat.sessionid);de(r,n,n.ticketId,n.ticketType)}me(t.session.sessionid,n.ticketId,n.ticketType),ge(n.ticketId,n.ticketType),te(!0)}}else if(n.ticketDisplayId||n.ticketType||n.ticketId)return pe(n,t.confirmationData,t.session,null,null,null,!0),void me(t.session.sessionid,n.ticketId,n.ticketType)}else Y(e.selectedChat),te(!0);else t.confirmationData.confirmationEvent===R.app_event_confirm_release_session&&te(!0)}N({data:t.confirmationData.confirmationData,event:t.confirmationData.confirmationEvent})}})}function pe(t,a,n,i,o,r,s){var l;m.getMetadataByType(t.ticketType).then(function(c){var d,u,p,m=c&&c.statuses;if(t.ticketType===EntityVO.TYPE_INCIDENT?(a.confirmationEvent===R.app_event_confirm_close_session?(d=_.find(m,{name:"Resolved"}),u=_.find(d.statusReasons,{name:"No Further Action Required"})):(d=_.find(m,{name:"Cancelled"}),u=_.find(d.statusReasons,{name:"No longer a Causal CI"})),p=a.confirmationEvent===R.app_event_confirm_close_session||a.confirmationEvent===D.sac_session_cancelled?y("i18n")("live.chat.close.resolution.note"):a.confirmationEvent===R.app_unrelate_ticket?y("i18n")("live.chat.ticket.unrelate.success",[t.ticketDisplayId]):y("i18n")("live.chat.abandon.resolution.note"),l={status:d.name,statusReason:u.name,resNote:p}):t.ticketType===EntityVO.TYPE_WORKORDER&&(a.confirmationEvent===R.app_event_confirm_close_session?(d=_.find(m,{name:"Completed"}),u=_.find(d.statusReasons,{name:"Successful"})):(d=_.find(m,{name:"Cancelled"}),u=a.confirmationEvent===D.sac_session_cancelled?_.find(d.statusReasons,{name:"Cancelled by Requester"}):_.find(d.statusReasons,{name:"Cancelled by Support"})),p=a.confirmationEvent===R.app_event_confirm_close_session?y("i18n")("live.chat.close.resolution.note"):a.confirmationEvent===R.app_unrelate_ticket?y("i18n")("live.chat.ticket.unrelate.success",[t.ticketDisplayId]):y("i18n")("live.chat.abandon.resolution.note"),l={status:d.name,statusReason:u.name,resNote:p}),t.ticketId)f.update(t.ticketId,t.ticketType,l,i).then(function(l){if(!r){if(l&&500===l.status){var c=void 0;c=i?y("i18n")("live.chat.cancel.enduser.worknote"):p,z(t.ticketId,t.ticketType,{text:c})}n&&U(n,t);var d=he(null,n.sessionid);return de(d,t,t.ticketId,t.ticketType),s&&(ge(t.ticketId,t.ticketType),N({data:a.confirmationData,event:a.confirmationEvent}),e.selectedChat.sessionid===a.confirmationData&&te(!0)),o||e.selectedChat.sessionid!==a.confirmationData?void((o&&o===e.selectedChat.sessionid||e.selectedChat.sessionid===a.confirmationData)&&(e.selectedChat=null)):void(e.selectedChat=null)}});else{var g,h={search_text:t.ticketDisplayId},E={types:["tickets"]};S.getGlobalSearchResults(h,E).then(function(a){!_.isEmpty(a.items)&&a.items[0]&&a.items[0].results&&a.items[0].results.length&&(g=_.find(a.items[0].results,{displayId:t.ticketDisplayId}),f.update(g.id,g.type,l).then(function(){if(!r){n&&U(n,t);var a=he(null,n.sessionid);return de(a,g,g.id,g.type),o?void(o&&o===e.selectedChat.sessionid&&(e.selectedChat=null)):void(e.selectedChat=null)}}))})}})}function me(e,t,a){var n={event:R.app_gpt_summary,data:{sid:e,ticketId:t,ticketType:a}};N(n)}function fe(e,t,n,i){if(i&&i.length>0){var o={worknote:i,access:!0,workInfoType:35e3,chatSessionId:e},r=origin+"/smartit/rest/"+n+"/worknote/"+t;a({method:"PUT",url:r,data:o,headers:{"Content-Type":"application/json"}}).then(function(e){},function(e){console.error("An error occurred: ",e.status,e.data),console.error("Failed URL: ",e.config.url)})}}function ge(t,a){var n=e.selectedChatTicketConfig[a],i=n.openTicketOnClose;if(i&&(e.hasEditPermission=P.hasPermissionForTicket(a),"forceEdit"===n.openTicketOnCloseMode&&(n.openTicketOnCloseMode="edit"),"edit"===n.openTicketOnCloseMode&&e.hasEditPermission||"view"===n.openTicketOnCloseMode)){var o=E.href("liveChatDraft",{id:t,draftType:a,launchMode:n.openTicketOnCloseMode});s.open(o,"_blank","noopener, noreferrer")}}function he(t,a){var n,i=[];if(t)n=t;else{var o=_.findIndex(e.agentChats,{sid:a});o!==-1&&e.agentChats[o].selectedChatContext&&e.agentChats[o].selectedChatContext.selectedKnowledge&&(n=e.agentChats[o].selectedChatContext.selectedKnowledge)}if(n)for(var r=0;r<n.length;r++){var s=n[r];s=(new RelationItemVO).build(s),s.isPoi=void 0,s.realObject=void 0,s.entityLink=void 0,s.isKASharedWithUser=n[r].isKASharedWithUser,s.tag||(s.tag=EntityVO.TYPE_RESOURCE),s.relationshipType||(s.relationshipType=EntityVO.TYPE_RELATEDTO),s.type||(s.type=EntityVO.TYPE_KNOWLEDGE),i.push(s)}return i}function ye(e,t){var a,n;return delete e.accessMappings,e.customer.accessMappings&&delete e.customer.accessMappings,t===EntityVO.TYPE_INCIDENT?(""===e.causalCI&&(delete e.causalCI,delete e.causalCIreconId),""===e.impactedService&&(delete e.impactedService,delete e.impactedServiceReconId),e.contact&&e.contact.accessMappings&&delete e.contact.accessMappings):t===EntityVO.TYPE_WORKORDER&&(n=e,a={id:n.id,displayId:n.displayId,summary:n.summary,customer:n.customer,desc:n.desc,priority:n.priority,status:n.status,categorizations:n.categorizations,type:EntityVO.TYPE_WORKORDER},n.reportedSource&&(a.reportedSource=n.reportedSource),n.location&&n.location.poiId&&(a.location={poiId:n.location.poiId}),n.locationCompany&&(a.locationCompany=n.locationCompany,n.customer&&n.customer.company&&(a.locationCompany=n.customer.company)),n.impactedService&&(a.impactedService=n.impactedService),n.scheduledStartDate&&(a.scheduledStartDate=moment(n.scheduledStartDate).valueOf()),n.scheduledEndDate&&(a.scheduledEndDate=moment(n.scheduledEndDate).valueOf()),n.actualStartDate&&(a.actualStartDate=moment(n.actualStartDate).valueOf()),n.actualEndDate&&(a.actualEndDate=moment(n.actualEndDate).valueOf()),n.supportGroup&&(a.supportGroup=n.supportGroup),n.assignee&&(a.assignee=n.assignee),n.managerGroup&&(a.managerGroup=n.managerGroup),n.manager&&(a.manager=n.manager),n.templateId&&(a.templateId=n.templateId),n.templateName&&(a.templateName=n.templateName),n.attachments&&(a.attachments=n.attachments),_.size(n.customFields)&&(a.customFields=n.customFields),n.dynamicFields&&(a.dynamicFields=n.dynamicFields),n.chatSessionId&&(a.chatSessionId=n.chatSessionId),e=a),e}function Ee(){var t;e.$on("$stateChangeStart",function(a,n,o){if(e.isDirtyFlag===!0&&!e.state.loadingLiveChat&&("liveChatAgentConsole"!==n.name||"liveChatDashboard"!==n.name)){a.preventDefault(),t=e.noOfDraftScreensOpen>0?y("i18n")("live.chat.data-loss.notification.dirty.message"):i.getLocalizedString("live.chat.notification.dirty.message");var s=r.modal({title:i.getLocalizedString("common.notification.dirty.title"),text:t,buttons:[{text:i.getLocalizedString("common.labels.yes"),data:{stateName:n.name,stateParams:o}},{text:i.getLocalizedString("common.labels.no")}]});s.result.then(function(t){_.isEmpty(t)||(e.isDirtyFlag=!1,e.noOfDraftScreensOpen=0,ke(),E.transitionTo(t.stateName,t.stateParams))})}})}e.state={loadingLiveChat:!0,creatingTicket:!1,appModalEventConfirmWaiting:!1},e.isDirtyFlag=!0;var ve="liveChatDashboard",Te="liveChatAgentConsole",Se="lcConsolePendingMsg",Ce=3e4,_e=100;e.agentChats=[],e.chatTicketDataForCreateMap=new Map,e.createTicketInProgressForChatSessionSet=new Set,e.hideForDashboard=!1,e.noOfDraftScreensOpen=0,e.userid=o.get("user.userId"),u.getFullCurrentUserData().then(function(){e.user=u.userFullData,e.context={company:e.user&&e.user.company&&e.user.company.name,customerId:e.user.id,id:EntityVO.TYPE_LIVE_CHAT,type:EntityVO.TYPE_LIVE_CHAT,summary:"",status:"",accessMappings:{relationsEditAllowed:!1,duplicateActionAllowed:!0}}}),e.isWOInstalled=l.isServerApplicationEnabled(EntityVO.TYPE_WORKORDER)&&c.isAuthorized(d.ITSM_AGENT_ROLE),e.isIncidentCreateAllowed=!0,e.isWOCreateAllowed=!0,e.filterConfig=l.get("resource.filter"),e.filterConfigMap=_.keyBy(e.filterConfig,"name"),e.$on(p.PERSON_DATA_LOADED,ee),e.$on(p.SELECT_TEMPLATE_FROM_RS,ae),e.$on(p.UNSELECT_TEMPLATE_FROM_RS,ne),e.$on(p.SHARE_KNOWLEDGE_TO_LIVE_CHAT,se),e.$on(p.SAVE_TO_TICKET_FROM_RS,ie),e.$on(p.REMOVE_FROM_TICKET_FROM_RS,oe),e.$on(p.SEARCH_TEXT_CHANGED,re),e.$on(p.RELATE_TICKET_TO_CHAT,W),e.$on(p.UNRELATE_TICKET_TO_CHAT,Q),e.$on(p.TICKET_ASSIGNEES_UPDATED_FROM_BLADE,J);var Oe=function(e){if(e&&"ls.lcConsolePendingMsg"===e.key){var t=o.get(Se);t&&(o.remove(Se),N(t))}},Ae=function(t){if(t&&t.origin&&!_.includes(e.eschatServerUrl,t.origin)&&!_.includes(e.smartITURL,t.origin))return void console.warn("Url Not allowed. event.origin does not match the eschat server url.\nevent.origin= "+t.origin+" ,eschatServerUrl = "+e.eschatServerUrl);if(!t||!t.data||!t.data.event||_.includes(e.allowedWindowEvents,t.data.event)!==!0&&_.includes(D,t.data.event)!==!0)return void console.warn("Ignoring. Not a LiveChat event.");if(t.data&&t.data.event===D.sac_login_completed)e.title=window.document.title,e.state.loadingLiveChat=!1,e.$apply(),"console"===E.current.data.path?(s.tabId=Te,Oe({key:"ls.lcConsolePendingMsg"})):"dashboard"===E.current.data.path&&(s.tabId=ve),"true"===o.get(s.tabId)?console.info("A Live chat tab for "+E.current.data.path+" is already open. We recommend to close this tab"):o.set(s.tabId,"true"),t.data.chatData&&"error"!==t.data.chatData.status&&x(),t.data.chatData&&t.data.chatData.ticketConfigSettings&&(e.ticketCreationConfigCompanyMap=JSON.parse(t.data.chatData.ticketConfigSettings)||{});else if(t.data&&t.data.event===D.sac_login_expired)e.selectedChat=null,e.agentChats=[],window.location.reload();else if(t.data&&t.data.event===D.sac_launch_live_chat&&t.data.chatData){var a=E.href("liveChatAgentConsole");s.open(a,"liveChatAgentConsole");var n={event:R.app_display_chat,data:{chatSessionId:t.data.chatData.sessionId}};o.set(Se,n)}else if(t.data&&t.data.event===D.sac_notify_on_change){if(console.log(t.data),e.title&&(t.data.chatData.showNotification===!1||e.isBrowserTabFocus===!0))return window.document.title=e.title,void console.debug("Live Chat sac_notify_on_change event but either notifications are disabled or browser tab is in focus. Ignoring event");var i=x(),c=window.document.hasFocus();if(e.isBrowserTabFocus===!1||c===!1||"always"===t.data.chatData.showNotification){if(i&&"granted"===Notification.permission){var d=t.data.chatData.options;if(d){var u=t.data.chatData.notificationTitle||"",m=d.timeout||8,f=new Notification(u,d);navigator.userAgent.toLowerCase().indexOf("firefox")<0&&(f.onclick=function(e){e.preventDefault(),window.parent.focus(),window.focus()}),setTimeout(function(){f.close()},1e3*m)}}else console.info("Either Notification API not supported on this platform or permission not granted yet");window.document.title=t.data.chatData.browserTitle+" "+e.title}else e.title&&(window.document.title=e.title,console.debug("Live Chat sac_notify_on_change event but Smart IT has focus. Ignoring event"))}else if(t.data&&t.data.event===D.sac_agent_chats){if(!(t.data&&t.data.chatData&&t.data.chatData.agentChats&&t.data.chatData.agentChats.length))return e.selectedChat=null,e.agentChats=[],void te();if(e.agentChats.length){var v=[];_.forEach(e.agentChats,function(a){var n=_.findIndex(t.data.chatData.agentChats,{sid:a.sid});n!==-1?v.push(a):e.selectedChat&&e.selectedChat.sessionid===a.sid&&te()}),e.agentChats=v,_.forEach(t.data.chatData.agentChats,function(t){_.findIndex(e.agentChats,{sid:t.sid})===-1&&e.agentChats.push(t)})}else e.agentChats=t.data.chatData.agentChats}else if(t.data&&t.data.event===D.sac_on_request_chat_ticket_data)e.state.createTicketRequestPendingFromLC=!1,e.relateTicketToChatInProgress?Z(e.relatedTicketData,t.data.chatData.session):$(t.data.chatData.session,e.relatedTicketData);else if(t.data&&t.data.event===D.sac_notify_on_error){e.state.creatingTicket===!0&&(e.state.creatingTicket=!1,r.error({text:y("i18n")("error.unknown"),clear:!1}));var T=void 0;T=t.data.chatData&&t.data.chatData.sessionId?"Live Chat error: Event - "+t.data.event+" Session Id - "+t.data.chatData.sessionId:"Live Chat error: Event - "+t.data.event,console.log(T)}else if(t.data&&t.data.event===D.sac_files_uploaded&&t.data.chatData.attachments)M(t.data.chatData.attachments,t.data.chatData);else if(t.data&&t.data.event===D.sac_session_context_change){var C=e.selectedChat&&e.selectedChat.user,O=e.selectedChat&&e.selectedChat.customer;if(console.log(t.data),e.selectedTemplate=null,e.sessionID=t.data.chatData.sessionid,e.context.selectedChat=!0,e.selectedChat=t.data.chatData,e.selectedChat.user=t.data.chatData.metadata&&(t.data.chatData.metadata.user||t.data.chatData.metadata.useremail),t.data.chatData.metadata&&t.data.chatData.metadata.appData&&(e.selectedChat.applicationData=JSON.parse(t.data.chatData.metadata.appData)),e.selectedChat.applicationData&&e.selectedChat.applicationData.newTicketDetails?e.selectedChat.ticket=e.selectedChat.applicationData.newTicketDetails:e.selectedChat.applicationData&&e.selectedChat.applicationData.ticketAssociationDetails&&e.selectedChat.applicationData.ticketAssociationDetails.id&&(e.selectedChat.ticket={ticketId:e.selectedChat.applicationData.ticketAssociationDetails.id,ticketDisplayId:e.selectedChat.applicationData.ticketAssociationDetails.displayId,ticketType:e.selectedChat.applicationData.ticketAssociationDetails.type}),e.selectedChat.applicationData&&e.selectedChat.applicationData.pinnedArticles&&e.selectedChat.applicationData.pinnedArticles.length){var A=[],I=[];_.forEach(e.selectedChat.applicationData.pinnedArticles,function(t){g.cache[e.selectedChat.sessionid]=g.cache[e.selectedChat.sessionid]&&g.cache[e.selectedChat.sessionid].length?g.cache[e.selectedChat.sessionid]:[];var a=_.findIndex(g.cache[e.selectedChat.sessionid],{id:t.id});if(a===-1){var n=void 0;if(l.comaroundEnabled){var i={search_text:t.title};n=w.getHKMRecommendedKA({},i).then(function(e){e&&e.length>0&&_.forEach(e,function(e){e.id===t.id&&I.push(e)})})}else{var i={search_text:t.displayId},o={types:["knowledge"]};n=S.getGlobalSearchResults(i,o).then(function(e){e.items[0]&&e.items[0].results&&e.items[0].results.length>0&&I.push(e.items[0].results[0])})}A.push(n)}}),h.all(A).then(function(){I.length>0&&(g.cache[e.selectedChat.sessionid]=I),e.$broadcast(p.REFRESH_RECOMMENDED_KNOWLEDGE,{isFromLiveChat:!0})},function(e){console.log("Search pinned articles failed: "+e)})}e.selectedChat.user===C&&(e.$broadcast("personDataUpdated",!0),e.selectedChat.customer=O,e.selectedChat.customerCompany=O&&O.company,e.context.chatUserCompany=O&&O.company&&O.company.name),e.selectedChat.status=t.data.chatData.metadata&&t.data.chatData.metadata.status,e.selectedChat.queueType=t.data.chatData.metadata&&t.data.chatData.metadata.queueType,e.selectedChat.autoCreateTicketType=t.data.chatData.metadata&&t.data.chatData.metadata.autoCreateTicketType,e.selectedChat.autoCreateTemplateId=t.data.chatData.metadata&&t.data.chatData.metadata.autoCreateTemplateId;var b=_.findIndex(e.agentChats,{sid:e.selectedChat.sessionid});if(b!==-1){if(e.context.id=t.data.chatData.sessionid,e.agentChats[b].selectedChatContext){if(e.context.status=e.selectedChat.status,e.context.accessMappings.relationsEditAllowed="Assigned"===e.context.status,e.context.summary=e.agentChats[b].selectedChatContext.summaryText||e.selectedChat.applicationData&&e.selectedChat.applicationData.searchText?e.agentChats[b].selectedChatContext.summaryText||e.selectedChat.applicationData.searchText:"",e.agentChats[b].selectedChatContext.selectedTemplate?(e.context.selectedTemplate=e.agentChats[b].selectedChatContext.selectedTemplate,e.selectedTemplate=e.context.selectedTemplate):(e.context.selectedTemplate=null,e.selectedTemplate=null),e.agentChats[b].selectedChatContext.selectedKnowledge&&(e.context.selectedKnowledge=e.agentChats[b].selectedChatContext.selectedKnowledge),e.agentChats[b].selectedChatContext.ticket)e.selectedChat.ticket=e.agentChats[b].selectedChatContext.ticket;else if(e.selectedChat.ticket)e.agentChats[b].selectedChatContext.ticket=e.selectedChat.ticket;else if(t.data.chatData.metadata.ticketid){var k,P={search_text:t.data.chatData.metadata.ticketid},N={types:["tickets"]};S.getGlobalSearchResults(P,N).then(function(a){!_.isEmpty(a.items)&&a.items[0]&&a.items[0].results&&(k=_.find(a.items[0].results,{displayId:t.data.chatData.metadata.ticketid}),e.selectedChat.ticket={ticketDisplayId:t.data.chatData.metadata.ticketid,ticketType:t.data.chatData.metadata.tickettype,ticketId:k&&k.id},e.agentChats[b].selectedChatContext.ticket=e.selectedChat.ticket)})}}else if(e.context.status=e.selectedChat.status,e.context.accessMappings.relationsEditAllowed="Assigned"===e.context.status,e.context.summary=e.selectedChat.applicationData&&e.selectedChat.applicationData.searchText?e.selectedChat.applicationData&&e.selectedChat.applicationData.searchText:"",e.context.selectedTemplate&&(e.context.selectedTemplate=null,e.selectedTemplate=null),e.context.selectedKnowledge&&(e.context.selectedKnowledge=null),e.agentChats[b].selectedChatContext=_.cloneDeep(e.context),e.selectedChat.applicationData&&e.selectedChat.applicationData.pinnedArticles&&e.selectedChat.applicationData.pinnedArticles.length&&(e.agentChats[b].selectedChatContext.selectedKnowledge=e.selectedChat.applicationData.pinnedArticles),e.selectedChat.ticket)e.agentChats[b].selectedChatContext.ticket=e.selectedChat.ticket;else if(t.data.chatData.metadata.ticketid){var F,P={search_text:t.data.chatData.metadata.ticketid},N={types:["tickets"]};S.getGlobalSearchResults(P,N).then(function(a){!_.isEmpty(a.items)&&a.items[0]&&a.items[0].results&&(F=_.find(a.items[0].results,{displayId:t.data.chatData.metadata.ticketid}),e.selectedChat.ticket={ticketDisplayId:t.data.chatData.metadata.ticketid,ticketType:t.data.chatData.metadata.tickettype,ticketId:F&&F.id},e.agentChats[b].selectedChatContext.ticket=e.selectedChat.ticket)})}}else e.context.summary="";e.$broadcast(p.ON_SELECTED_LIVE_CHAT,e.context),e.$apply(),L()}else if(t.data.event&&t.data.event===D.sac_open_confirmation_modal)le(t.data);else if(!t.data.event||t.data.event!==D.sac_session_cancelled&&t.data.event!==D.sac_session_transferred)if(t.data.event&&t.data.event===p.TICKET_CREATED_FROM_DRAFT){var G=t.data.eventData.livechatTicketData.chatSessionId,B=e.relatedTicketData,U=void 0;e.noOfDraftScreensOpen=--e.noOfDraftScreensOpen,e.chatTicketDataForCreateMap&&e.chatTicketDataForCreateMap.has(G)&&(U=e.chatTicketDataForCreateMap.get(G)),V(t.data.eventData.livechatTicketData,U,B),e.chatTicketDataForCreateMap["delete"](G)}else if(t.data.event&&t.data.event===p.DRAFT_TICKET_CLOSED)e.noOfDraftScreensOpen=--e.noOfDraftScreensOpen;else if(!t.data.event||t.data.event!==p.LIVECHAT_CREATEINCIDENT_SUCCESS&&t.data.event!==p.LIVECHAT_CREATEWORKORDER_SUCCESS){if(t.data.event&&t.data.event===D.sac_gpt_summary){var z=t.data.chatData.sid,q=t.data.chatData.ticketId,H=t.data.chatData.ticketType||"incident",K=t.data.chatData.summary;fe(z,q,H,K)}}else{e.noOfDraftScreensOpen=--e.noOfDraftScreensOpen;var j=t.data.eventData.split(";"),W={};_.forEach(j,function(e){var t=e.split("=");W[t[0]]=t[1]});var G=W.chatSessionId,B=e.relatedTicketData,U=void 0;if(e.chatTicketDataForCreateMap&&e.chatTicketDataForCreateMap.has(G)&&(U=e.chatTicketDataForCreateMap.get(G)),!W.summary){var Q=_.findIndex(e.agentChats,{sid:G});Q!==-1&&(W.summary=e.agentChats[Q].cleartextquestion.substring(0,_e))}V(W,U,B),e.chatTicketDataForCreateMap["delete"](G)}else{var J={confirmationEvent:t.data.event},X=void 0,ee=_.findIndex(e.agentChats,{sid:t.data.chatData.sessionid});ee!==-1&&(X=e.agentChats[ee]&&e.agentChats[ee].selectedChatContext&&e.agentChats[ee].selectedChatContext.ticket,e.agentChats.splice(ee,1)),X&&t.data.event===D.sac_session_cancelled?pe(X,J,t.data.chatData.session,!0,t.data.chatData.sessionid):X||t.data.event!==D.sac_session_cancelled?e.selectedChat.sessionid===t.data.chatData.sessionid&&te():(Y(e.selectedChat,t.data.chatData.sessionid),e.selectedChat&&t.data.chatData.sessionid===e.selectedChat.sessionid&&(e.selectedChat=null,t.data.chatData.sessionid=null))}},Ie=function(t){"blur"===t.type?e.isBrowserTabFocus=!1:"focus"===t.type&&(e.isBrowserTabFocus=!0,e.title&&(window.document.title=e.title))},be=function(){s.addEventListener&&(s.addEventListener("message",Ae,!1),s.addEventListener("focus",Ie,!1),s.addEventListener("blur",Ie,!1),s.addEventListener("storage",Oe,!1))},ke=function(){s.removeEventListener&&(s.removeEventListener("message",Ae,!1),s.removeEventListener("focus",Ie,!1),s.removeEventListener("blur",Ie,!1),s.removeEventListener("storage",Oe,!1)),o.remove(s.tabId),o.remove(Se)};e.createTicket=function(t){t===EntityVO.TYPE_INCIDENT?e.draftType="draftIncident":t===EntityVO.TYPE_WORKORDER&&(e.draftType="draftWorkorder");var a=e.selectedChat&&e.selectedChat.sessionid;if(e.isAutoCreateTicketEnabled===!0){if(e.state.creatingTicket=!1,a){if(e.createTicketInProgressForChatSessionSet.has(a))return void console.warn("Auto ticket creation already in progress for sessionId: "+a);e.createTicketInProgressForChatSessionSet.add(a)}}else e.state.creatingTicket=!0;e.ticketType=t;var n={event:R.app_request_chat_ticket_data,data:{chatSessionId:a}};N(n),e.state.createTicketRequestPendingFromLC=!0,I(function(){e.state.creatingTicket===!0&&e.state.createTicketRequestPendingFromLC===!0&&(e.state.creatingTicket=!1,console.log("No response from live chat on create ticket for sessionId: "+a),r.error({text:y("i18n")("error.unknown"),clear:!1}))},Ce)},G()}])}(),function(){angular.module("liveChatModule").controller("LiveChatDraftTicketController",["$state","$stateParams","localStorageService","pwaModel","ticketModel",function(e,t,a,n,i){function o(t){console.debug("openDraftView() pwaEnabled= "+t),s.type===EntityVO.TYPE_INCIDENT?(u=new IncidentVO,u=angular.copy(s,u),t?(n.createIncFromSmartRecorder=!0,n.smartRecorderData=u,c="pwaDraftIncident"):(i.cache.draft=u,c="draftIncident")):s.type===EntityVO.TYPE_WORKORDER&&(u=new WorkOrderVO,u=angular.copy(s,u),t?(n.createWOFromSmartRecorder=!0,n.smartRecorderData=u,c="pwaDraftWorkorder"):(i.cache.draft=u,c="draftWorkorder")),a.remove("draft.ticket"),a.remove("draft.ticket.error"),console.debug("openDraftView() stateToGo= "+c+" ,stateParams= "+JSON.stringify(p)),e.go(c,p)}var r=t.draftType,s=a.get("draft.ticket"),l=!1;if(console.log("LiveChatDraftTicketController: $stateParams= "+JSON.stringify(t)),r&&s){var c,d=a.get("draft.ticket.error"),u=null,p={isSrcLiveChat:t.isSrcLiveChat||"true",error:d,crossLaunchContext:t.crossLaunchContext||"LIVECHAT"};n.isPwaEnabledPromise().then(function(e){l=e})["finally"](function(){o(l)})}else t.id&&r&&t.launchMode?n.isPwaEnabledPromise().then(function(e){l=e})["finally"](function(){console.debug("openTicketView() pwaEnabled= "+l);var a=r,n={id:t.id,editMode:"edit"===t.launchMode};l&&(a+="PV"),console.debug("openTicketView() stateToGo= "+a+" ,stateParams= "+JSON.stringify(n)),e.go(a,n)}):e.go("smartRecorder")}])}(),function(){angular.module("liveChatModule").service("liveChatService",["$q","$log","events","ticketModel","ticketActionService","userModel","searchService",function(e,t,a,n,i,o,r){function s(e,t,a,n,i){var o={};o.assignee={id:i.id,loginId:i.loginId,fullName:i.fullName,thumbnail:i.thumbnail,thumbnailMime:i.thumbnailMime},o.group={id:i.supportGroupId,name:i.supportGroup,organization:i.organization,company:i.company},c(e,t,o,a,n)}function l(e,a,n,o){e.ghostEntity=!0,i.showAssignDialog(e,!0,o).result.then(function(t){c(e,a,t,n,o)},function(i){t.error("Could not assign ticket properly. ",i,e),c(e,a,{autoAssign:!0},n,o)})}function c(e,t,a,n,i){a.autoAssign?d(e):a.group&&(e.autoAssign=!1,e.assignee=a.assignee,e.supportGroup=a.group||a.supportGroup,e.manager=a.manager,e.managerGroup=a.managerGroup,a.managerAutoAssign&&(e.manager={managerAutoAssign:!0},e.managerGroup={}),e.type!==EntityVO.TYPE_INCIDENT||o.userId!==e.assignee.loginId&&o.decodedUserId!==e.assignee.loginId||(e.status.value="In Progress")),u(e,t,n)}function d(e){e.autoAssign=!0,e.assignee={autoAssign:!0},e.supportGroup={}}function u(e,t,n){delete e.ghostEntity,n.$broadcast(a.TICKET_ASSIGNEES_UPDATED_FROM_BLADE,{ticket:e,chatSession:t})}this.assignToMe=function(a,i,o,c){var d=a,p=i.customer.company.name;"ticketassignee"===a&&(d=i.type===EntityVO.TYPE_WORKORDER?"workorderassignee":"");var m=[n.getTicketAssigneePersons(i.type,d),r.getLiveAgentDefaultSupportGroup(p)];e.all(m).then(function(e){var t=e[0];t=_.uniqBy(t.results,function(e){return e.loginId&&e.supportGroupId});var n,r=e[1];t.length>1&&_.find(t,function(e){var t=_.find(e.supportGroups,{isDefault:!0});return!!t&&(n=e,!0)}),1===t.length?n=t[0]:n||(n=_.find(t,function(e){return!(!r||r.assignedGroup!==e.supportGroup||r.supportOrganization!==e.supportOrganization||r.supportGroupCompany!==e.company.name)})),n&&n.loginId?s(i,o,c,a,n):l(i,o,c,a)})["catch"](function(e){t.error("Could not assign ticket properly. ",e),u(i,o,c)})}}])}(),function(){var e={MapTypeId:{ROADMAP:"roadmap",SATELLITE:"satellite",HYBRID:"hybrid"},ControlPosition:{LEFT_BOTTOM:6},ZoomControlStyle:{LARGE:2}};e.adapters={},e._adapters={},e.adapters.loadScripts=function(e){for(var t=[],a=0,n=e.length;a<n;a++)t.push($.getScript(e[a]));return $.when.apply($,t)},e.adapters.saveMapsAvailability=function(e){angular.mapsAvailable=e},e.adapters.getMapAdapterLink=function(e){return"scripts/app/location/map-api-adapters/map-adapter-"+e+".js"},e.adapters.loadAdapter=function(e,t){var a=this.getMapAdapterLink(e);$.ajax({url:a,dataType:"script",success:t,scriptAttrs:{}})},e.adapters.init=function(t){var a=t.MAP_API||"google",n=$.Deferred();return this.loadAdapter(a,function(){var i=e.adapters.activate(a);i.init(t,n)}),n.promise()},e.adapters.register=function(t,a){e._adapters[t]=a},e.adapters.activate=function(t){return e.adapter=e._adapters[t],e.adapter},e.mapInit=function(t){
_.isFunction(e.adapter.mapInit)&&e.adapter.mapInit(t.adapter)},e.event={},e.event.addListener=function(t,a,n){e.adapter.event.addListener(t.adapter,a,n)},e.event.trigger=function(t,a){e.adapter.event.trigger(t.adapter||{impl:t.impl||t},a)},e.event.addDomListener=function(t,a,n){e.adapter.event.addDomListener(t,a,n)},e.event.addListenerOnce=function(t,a,n){e.adapter.event.addListenerOnce(t.adapter,a,n)},e.event.clearInstanceListeners=function(t){e.adapter.event.clearInstanceListeners(t.adapter)},e.MVCObject=function(){},e.MVCObject.prototype.setValues=function(e){for(var t in e)void 0===this[t]&&(this[t]=e[t])},e.geocoder={},e.geocoder.geocode=function(t,a,n){e.adapter.geocoder.geocode(t,a,n)},e.getDirectionUrl=function(t){return e.adapter.getDirectionUrl(t)},e.Map=function(t,a){this.setValues(a),this.adapter=e.adapter.map(t,a),this.mapTypes=new e.MapTypeRegistry(this)},e.Map.prototype=new e.MVCObject,e.MapTypeRegistry=function(e){this.adapter=e.adapter.getMapTypeRegistry()},e.MapTypeRegistry.prototype.set=function(e,t){this[e]=t,this.adapter.set(e,t)},e.Map.prototype.addMarker=function(e,t){this.adapter.addMarker(e,t)},e.Map.prototype.setCenter=function(e){this.adapter.setCenter(e)},e.Map.prototype.setMapTypeId=function(e){this.mapTypeId=e,this.adapter.setMapTypeId(e)},e.Map.prototype.getCenter=function(){return this.adapter.getCenter()},e.Map.prototype.fitBounds=function(e){this.adapter.fitBounds(e)},e.Map.prototype.setZoom=function(e){this.adapter.setZoom(e)},e.Map.prototype.getZoom=function(){return this.adapter.getZoom()},e.Map.prototype.getBounds=function(){return this.adapter.getBounds()},e.Map.prototype.getProjection=function(){return new e.Projection(this)},e.Projection=function(e){this.adapter=e.adapter.getProjection()},e.Projection.prototype.fromPointToLatLng=function(e){return this.adapter.fromPointToLatLng(e)},e.Map.prototype.panToBounds=function(e){this.adapter.panToBounds(e)},e.Map.prototype.panTo=function(e){this.adapter.panTo(e)},e.Point=function(e,t){this.x=e,this.y=t},e.Size=function(e,t){this.width=e,this.height=t},e.LatLng=function(e,t){this._lat=e,this._lng=t},e.LatLng.prototype.lat=function(){return this._lat},e.LatLng.prototype.lng=function(){return this._lng},e.LatLngBounds=function(t,a){t&&(this.sw=new e.LatLng(t._lat,t._lng),a||(this.ne=new e.LatLng(t._lat,t._lng))),a&&(this.ne=new e.LatLng(a._lat,a._lng),t||(this.sw=new e.LatLng(a._lat,a._lng)))},e.LatLngBounds.prototype.contains=function(e){return e._lat>=this.sw._lat&&e._lat<=this.ne._lat&&(this.sw._lng<=this.ne._lng&&e._lng>=this.sw._lng&&e._lng<=this.ne._lng||this.sw._lng>this.ne._lng&&(e._lng>=this.sw._lng||e._lng<=this.ne._lng))},e.LatLngBounds.prototype.extend=function(t){return this.sw||this.ne?(this.sw._lat>t._lat&&(this.sw._lat=t._lat),this.sw._lng>t._lng&&(this.sw._lng=t._lng),this.ne._lat<t._lat&&(this.ne._lat=t._lat),void(this.ne._lng<t._lng&&(this.ne._lng=t._lng))):(this.sw=new e.LatLng(t._lat,t._lng),void(this.ne=new e.LatLng(t._lat,t._lng)))},e.LatLngBounds.prototype.getCenter=function(){if(this.sw||this.ne)return new e.LatLng((this.sw._lat+this.ne._lat)/2,(this.sw._lng+this.ne._lng)/2)},e.InfoWindow=function(t){this.setValues(t),t.map&&(t.map=t.map.adapter),this.adapter=e.adapter.infoWindow(t)},e.InfoWindow.prototype=new e.MVCObject,e.InfoWindow.prototype.open=function(){this.adapter.open(arguments)},e.RichMarker=function(t){this.setValues(t),t.map&&(t.map=t.map.adapter),this.adapter=e.adapter.richMarker(t),this.content=this.adapter.content},e.RichMarker.prototype=new e.MVCObject,e.RichMarker.prototype.setPosition=function(e){this.position=e,this.adapter.setPosition(e)},e.RichMarker.prototype.getPosition=function(){return this.position},e.RichMarker.prototype.setVisible=function(e){this.adapter.setVisible(e)},e.RichMarker.prototype.destroy=function(){this.adapter.destroy()},e.InfoBubble=function(t){this.setValues(t),t.map&&(t.map=t.map.adapter),this.adapter=e.adapter.infoBubble(t)},e.InfoBubble.prototype=new e.MVCObject,e.InfoBubble.prototype.open=function(e,t){this.adapter.open(e.adapter,t?t.adapter:void 0)},e.InfoBubble.prototype.close=function(){this.adapter.close()},e.InfoBubble.prototype.getContent=function(){return this.adapter.getContent()},e.InfoBubble.prototype.setContent=function(e){this.adapter.setContent(e)},e.MarkerClusterer=function(t,a,n){this.setValues(n);for(var i=[],o=0;o<a.length;o++)i.push(a[o].adapter);this.adapter=e.adapter.markerClusterer(t.adapter,i,n)},e.MarkerClusterer.prototype=new e.MVCObject,e.MarkerClusterer.prototype.clearMarkers=function(){this.adapter.clearMarkers()},window.bmcMaps=e}(),function(){angular.module("locationModule").controller("LocationMapController",["$scope","$stateParams",function(e,t){e.POI={id:t.id},e.state={loadingMap:!0}}])}(),function(){angular.module("locationModule").directive("locationMap",["userModel","locationModel","$compile",function(e,t,a){return{restrict:"AE",template:'<div class="location-map__content"><div ></div></div>',replace:!0,link:function(e,n){function i(){t.initLocationMap(n[0],e.POI).then(function(n){e.locationMap=n,t.addLocationMarker(e.locationMap,e.POI.details),a(e.POI.details.marker.content)(e),e.activePOI=e.POI.details,a("<poi-info-bubble parent='activePOI'></poi-info-bubble>")(e),e.state.loadingMap=!1})["catch"](function(){e.state.loadingMap=!1})}e.locationModel=t,e.openInfoBubble=function(t){t.preventDefault(),t.stopPropagation(),e.activePOI=e.POI.details,e.POI.details.infoBubble?(e.activePOI.infoBubble.open(e.locationMap.floormap),e.activePOI.marker.setVisible(!1)):a("<poi-info-bubble parent='activePOI'></poi-info-bubble>")(e)},t.getPOIdetails(e.POI.id).then(function(a){e.POI.details=a,t.getMapTiles(a).then(function(){e.POI.tiles=t.tilesCache[a.id],i()})})}}}])}(),function(){angular.module("locationModule").factory("locationModel",["locationService","googleMapService","$q",function(e,t,a){function n(e){return i.typesCache[e.assetTypeId]?e.type=i.typesCache[e.assetTypeId]:i.typeRequestPromise.then(function(){e.type=i.typesCache[e.assetTypeId]}),e}var i={locationsCache:null,floormapsCache:null,poiByLocationCache:{},tilesCache:{},typesCache:{},typeRequestPromise:a.when(1),allPOICache:null};return i.getLocationsList=function(){return _.isEmpty(i.locationsCache)?e.getLocationsBulk().then(function(e){i.locationsCache=e.locations,i.floormapsCache=_.keyBy(e.floormaps,"id")}):a.when(1)},i.filterLocations=function(e){return i.getLocationsList().then(function(){var t=_.filter(i.locationsCache,function(t){var a=new RegExp(e,"gi"),n=!!t.name&&!!t.name.match(a),i=!!t.address&&!!t.address.match(a);return n||i});return t})},i.getLocationByPoiId=function(t){return e.getPOIdetails(t,["locationId"]).then(function(t){return t?e.getLocationById(t.locationId).then(function(e){return e}):a.when(null)})},i.getPOItypes=function(){return _.isEmpty(i.typesCache)?(i.typeRequestPromise=e.getPOItypes().then(function(e){i.typesCache=e}),i.typeRequestPromise):a.when(1)},i.getPOIdetails=function(t){return i.getPOItypes(),e.getPOIdetails(t).then(function(e){return n(e)})},i.getPOIbyLocation=function(t){var n=i.getPOItypes(),o=e.getPOIbyLocation(t);return a.all([o,n]).then(function(e){var a=e[0];i.poiByLocationCache[t]=[],_.each(a,function(e){e.floormap=i.floormapsCache?i.floormapsCache[e.floorMapId]:{},e.type=i.typesCache[e.assetTypeId],i.poiByLocationCache[t].push(e)})})},i.filterLocationPOI=function(e,t){return i.getPOIbyLocation(e).then(function(){var a=new RegExp(t,"gi"),n=_.filter(i.poiByLocationCache[e],function(e){var t=!!e.name&&!!e.name.match(a),n=!!e.type&&!!e.type.name.match(a),i=!!e.floormap&&!!e.floormap.name.match(a);return t||n||i});return n})},i.getMapTiles=function(t){return i.tilesCache[t.id]?a.when(i.tilesCache[t.id]):e.getMapTiles(t.floorMapId).then(function(e){i.tilesCache[t.id]=e})},i.initLocationMap=function(e,a){var n={mapContainer:e,tiles:a.tiles};return t.initFloorMap(n).then(function(e){return e})},i.addLocationMarker=function(e,a){return t.panAssetOnMap(e.floormap,a)},i}])}(),function(){angular.module("locationModule").service("locationService",["$resource","$q",function(e,t){function a(e,t){for(var a=e[0].items||[],n=0,i=a.length;n<i;n++){var o=a[n],r=o.scale;t[r]?angular.noop():t[r]={},t[r][o.column+"_"+o.row]=o}return t}var n=e("/smartit/rest/v2/:type/:action:itemId",{},{getLocation:{method:"GET",isArray:!0,params:{type:"location"}},getLocationsBulk:{method:"GET",isArray:!0,params:{type:"bulk",action:"location",include:"floormap[id,name,locationId]",fields:"id,name,address",floor_map_count:!0,floor_map_with_images_only:!0}},getPOIbyLocation:{url:"/smartit/rest/search",method:"POST",isArray:!0,transformRequest:function(e){return JSON.stringify({queryName:"MYIT_FLOOR_MAP_ASSETS_BY_LOCATION_ID",queryParameters:[{name:"locationId",value:e.id}],attributes:{LocationFloorMapAsset:["id","floorMapId","name","assetTypeId","assetStatus","desc","xPos","yPos","tag"]}})}},getMapTiles:{method:"GET",isArray:!0,params:{type:"image_tile"}},getPOItypes:{url:"/smartit/rest/search",method:"POST",isArray:!0},getPOIById:{url:"/smartit/rest/search",method:"POST",isArray:!0,transformRequest:function(e){return JSON.stringify({queryName:"MYIT_FLOOR_MAP_ASSET_GET_BY_ID",queryParameters:[{name:"id",value:e.id}],attributes:{LocationFloorMapAsset:e.fields||["id","floorMapId","name","assetTypeId","assetStatus","xPos","yPos","locationId"]}})},transformResponse:function(e){var t=e?JSON.parse(e):[],a=t[0]?t[0].items:[];return a}}});this.getLocationsBulk=function(){return n.getLocationsBulk().$promise.then(function(e){var t=[],a=_.find(e,{dataSourceName:"location"}).items,n=_.find(e,{dataSourceName:"floormap"}).items;return a.length&&(t=_.filter(a,function(e){return!!e.floorMapCount})),{locations:t,floormaps:n}})},this.getLocationById=function(e){return n.getLocation({itemId:e},{fields:"id,name,address"}).$promise.then(function(e){return e[0].items?e[0].items[0]:{}})},this.getPOItypes=function(){return n.getPOItypes({queryName:"MYIT_ALL_ASSETS_TYPE_QUERY"}).$promise.then(function(e){var t=e[0].items;return t&&(t=_.keyBy(t,"id")),t})},this.getPOIbyLocation=function(e){return n.getPOIbyLocation({id:e}).$promise.then(function(e){return e[0].items})},this.getPOIdetails=function(e,t){return n.getPOIById({id:e,fields:t}).$promise.then(function(e){return e[0]})},this.getMapTiles=function(e){for(var i=[],o=0,r=LocationVO.SCALE_LEVELS.length;o<r;o++){var s=n.getMapTiles({scale:LocationVO.SCALE_LEVELS[o],floor_map_id:e}).$promise;i.push(s)}return t.all(i).then(function(e){var t={};return _.each(e,function(e){a(e,t)}),t})}}])}(),function(){angular.module("locationModule").directive("poiInfoBubble",function(){return{restrict:"AE",template:'<div><div class="location-map__info-bubble"><div class="location-map__info-bubble_poi-details"><div class="location-map__info-bubble_poi-name">{{poi.name}}</div><div class="location-map__info-bubble_poi-type">{{poi.type.name}}</div></div></div><div class="location-map__info-bubble_anchor"></div></div>',replace:!0,scope:{poi:"=parent"},link:function(e,t){function a(){e.poi.infoBubble.close(),e.poi.marker.setVisible(!0)}var n=e.poi.marker.map,i=new bmcMaps.InfoBubble({content:t[0],position:e.poi.marker.position,shadowStyle:0,borderWidth:0,padding:0,backgroundColor:"transparent",borderRadius:4,arrowSize:0,hideCloseButton:!0,arrowPosition:50,arrowStyle:0});e.poi.infoBubble=i,e.poi.infoBubble.open(n),e.poi.marker.setVisible(!1),bmcMaps.event.addListener(n,"click",a),e.$on("$destroy",function(){bmcMaps.event.clearInstanceListeners(n)})}}})}(),function(){angular.module("mcsmModule").directive("mcsmDetails",["mcsmModel","$filter","systemAlertService","i18nService",function(e,t,a,n){return{restrict:"E",templateUrl:"views/mcsm/mcsm-details.html",scope:{ticket:"=",showDeleteIcon:"="},link:function(i){i.allManualAssociationSupportingSystems=[],i.manualAssociationSupportingSystems=[],i.isManualAssociationInProgress=!1,i.allowManualAssociationToMultipleVendors=!1,i.ticketType=n.getLocalizedString("ticket.type."+i.ticket.type)||i.ticket.type,i.manualAssociationHelpText=n.getLocalizedStringwithParams("ticket.vendor.label.helpText",[i.ticketType,i.ticketType,i.ticketType]),i.ticket.isMCSMEnabled&&e.getManualAssociationSupportingSystems(i.ticket.type).then(function(e){i.allManualAssociationSupportingSystems=e,i.allManualAssociationSupportingSystems.length>0&&!i.allowManualAssociationToMultipleVendors&&(i.allManualAssociationSupportingSystems.length>1&&(i.manualAssociationHelpText+=" "+n.getLocalizedString("ticket.vendor.label.helpTextSingleVendor")),i.$watchCollection("ticket.vendorInfo",function(e){_.isArray(e)&&e[0]&&e[0].vendor&&e[0].vendor.id?i.manualAssociationSupportingSystems=_.filter(i.allManualAssociationSupportingSystems,{id:e[0].vendor.id}):i.manualAssociationSupportingSystems=i.allManualAssociationSupportingSystems}))}),i.startManualAssociation=function(t){i.isManualAssociationInProgress=!0,e.updateAssociation(i.ticket.type,i.ticket.displayId,t.id).then(function(e){i.ticket.vendorInfo=e,i.ticket.brokerVendorName=t.providerName||t.name})["catch"](function(e){a.error({text:e.data&&(e.data.detailedMessage||e.data.error)||e,clear:!1})})["finally"](function(){i.isManualAssociationInProgress=!1})},i.removeAssociation=function(n,o){o.stopPropagation();var r=a.modal({title:t("i18n")("common.notification.delete.title"),text:t("i18n")("common.notification.delete.message"),buttons:[{text:t("i18n")("common.notification.delete.button1"),data:!0},{text:t("i18n")("common.notification.delete.button2"),data:!1}]});r.result.then(function(o){o&&(n.isRemoveAssociationInProgress=!0,e.removeAssociation(i.ticket.type,i.ticket.displayId,n.id,n.vendor.id).then(function(){a.success({text:t("i18n")("ticket.notification.unlink.message",1),hide:1e4}),_.remove(i.ticket.vendorInfo,{id:n.id}),0===i.ticket.vendorInfo.length&&(i.ticket.brokerVendorName="")})["catch"](function(e){a.error({text:e.data&&(e.data.detailedMessage||e.data.error)||e,clear:!1})})["finally"](function(){n.isRemoveAssociationInProgress=!1}))})}}}}])}(),function(){angular.module("mcsmModule").factory("mcsmModel",["$log","$q","mcsmService",function(e,t,a){var n={manualAssociationSupportingSystemsByType:{}};return n.getManualAssociationSupportingSystems=function(e){var i=n.manualAssociationSupportingSystemsByType[e];return i?t.when(i):a.getManualAssociationSupportingSystems(e).then(function(t){return n.manualAssociationSupportingSystemsByType[e]=t,t})},n.updateAssociation=function(e,t,n){return a.updateAssociation(e,t,n)},n.removeAssociation=function(e,t,n,i){return a.removeAssociation(e,t,n,i)},n}])}(),function(){angular.module("mcsmModule").service("mcsmService",["$resource",function(e){var t=e("/smartit/rest/mcsm",{},{getManualAssociationSupportingSystems:{url:"/smartit/rest/mcsm/vendordevops?type=:type",method:"GET",isArray:!0},updateAssociation:{url:"/smartit/rest/mcsm/devops/:type/:displayId/vendor/:vendorId",method:"GET",isArray:!1},removeAssociation:{url:"/smartit/rest/mcsm/devops/:type/:displayId/vendorticketid/:vendorTicketId?vendorId=:vendorId",method:"DELETE",isArray:!1}});this.getManualAssociationSupportingSystems=function(e){return t.getManualAssociationSupportingSystems({type:e}).$promise.then(function(e){return _.isArray(e)?e:[]})},this.updateAssociation=function(e,a,n){return t.updateAssociation({type:e,displayId:a,vendorId:n}).$promise.then(function(e){return e&&e.tickets||[]})},this.removeAssociation=function(e,a,n,i){return t.removeAssociation({type:e,displayId:a,vendorTicketId:n,vendorId:i}).$promise.then(function(e){return e&&e.tickets||[]})}}])}(),function(){angular.module("headerNavigationModule").controller("HeaderNavigationController",["$scope","$rootScope","$window","screenConfigurationModel","metadataModel","userModel","screenConfigurationService","events","session","headerNavigationModel","configurationModel","searchModel","$state","gainsightModel","studioModel",function(e,t,a,n,i,o,r,s,l,c,d,u,p,m,f){function g(e){return e&&e.actionList.length?(c.clearCustomActions(),e.actionList&&e.actionList.length&&c.getCustomActions(e),void y()):(c.clearCustomActions(),void y())}function h(){for(var t=e.navigationItems.length;t--;)"calendarStudio"!==e.navigationItems[t].state||e.cssEnabledForCalendar||e.navigationItems.splice(t,1),"liveChat"!==e.navigationItems[t].state||e.cssEnabledForLiveChat||e.navigationItems.splice(t,1),"dropdown"===e.navigationItems[t].type&&e.navigationItems[t]&&e.navigationItems[t].elements&&e.navigationItems[t].elements.length&&(d.comaroundEnabled?_.remove(e.navigationItems[t].elements,function(e){return e.app===EntityVO.TYPE_KNOWLEDGE&&!("createKnowledgeHKM"===e.name||"knowledgeConsoleHKM"===e.name)}):_.remove(e.navigationItems[t].elements,function(e){return"createKnowledgeHKM"===e.name||"knowledgeConsoleHKM"===e.name}),e.enableISCalendar||e.enableISAssetConsole||e.enableSharedTicketConsole||e.enableHelixGPTGlobalChat||_.remove(e.navigationItems[t].elements,function(e){return"studioConfig"===e.i18nKey})),e.navigationItems[t].app===EntityVO.TYPE_KNOWLEDGE&&d.comaroundEnabled&&e.navigationItems.splice(t,1)}function y(){e.navigationItems=c.updateNavigationItems(),i.getMetadataByType("global").then(function(t){d.comaroundEnabled&&u.getHKMUrls(),m.getTelemetryConfiguration().then(function(a){e.enableAnalyticsSettings=t.enableGainsight&&a.settings.enableGainsight}),e.enableInAppSurvey=t&&t.configurationParameters&&"true"===t.configurationParameters.enableInAppSurvey,e.cssEnabledForCalendar=t&&t.configurationParameters&&"true"===t.configurationParameters.calendarFeatureEnabled,e.cssEnabledForLiveChat=t&&t.configurationParameters&&"true"===t.configurationParameters.enableESChatIntegration,e.enableISCalendar=t&&t.configurationParameters&&"true"===t.configurationParameters.enableISCalendar,e.enableISAssetConsole=t&&t.configurationParameters&&"true"===t.configurationParameters.enableISAssetConsole,e.enableSharedTicketConsole=t&&t.configurationParameters&&"true"===t.configurationParameters.enableSharedTicketConsole,e.enableHelixGPTGlobalChat=t&&t.configurationParameters&&"true"===t.configurationParameters.enableHelixGPTGlobalChat,h()})}var E={serverVersion:l.serverVersion,appName:"Galileo UC",locale:window.myitsmLocale,deviceToken:"dummyToken",model:"Web Client"};e.enableAnalyticsSettings=!1,e.enableInAppSurvey=!1,e.cssEnabledForCalendar=!1,e.cssEnabledForLiveChat=!1,e.isHelixGPTGlobalSearchEnabled=function(){return f.enableHelixGPTGlobalChat},e.launchURL=function(e){i.getMetadataByType("global").then(function(t){var n,i,s,l=new RegExp("\\[\\w+\\]"),c=e.url,d="new"===e.target?"_blank":"_self",u="T"===t.configurationParameters["Enable-Progressive-Views"]||"true"===t.configurationParameters["Enable-Progressive-Views"],m=localStorage.getItem("midtierUrl");if(u="T"!==localStorage.getItem("overridePV")&&u,u&&m&&c.indexOf("pv://")>-1)return c=c.replace("pv://",""),p.go("pwaAction",{data:{formName:encodeURI(c)}}),!1;if(!t.ootbMapping)return void a.open(encodeURI(c),d);for(;c.search(l)!==-1;)n=c.match(l),i=n[0].replace(/[\[\]']+/g,""),_.has(E,i)?c=c.replace(l,E[i]):(s="supportGroups"===i?_.map(o.userFullData.supportGroups,"name").join(","):r.getContextPropertyByMetadataMapping(o.userFullData,t,i)||"",c=c.replace(l,s));var f=a.open(encodeURI(c),d);f.opener=null})},n.loadActionsForRuntime("global").then(function(){g(n.runtimeActionsCache.global)}),e.$on(s.PERMISSIONS_CHANGED,c.updateNavigationItems());var v=t.$on(s.GLOBAL_MENU_ACTIONS_UPDATE,function(){g(n.runtimeActionsCache.global)});e.$on("$destroy",function(){console.log("destroy root scope events bound from here"),v()})}])}(),function(){angular.module("headerNavigationModule").directive("headerNavigation",["events","$window","$timeout","$modal",function(e,t,a,n){return{restrict:"E",templateUrl:"views/navigation/header-navigation.html",replace:!0,controller:"HeaderNavigationController",link:function(i){function o(e){var t=$(e.target),a="click"===e.type&&!(t.hasClass("header-search__bar")||t.parents().hasClass("search-criteria-box")||"header-search_button"===t.attr("id"))||27===e.keyCode||13===e.keyCode&&t.hasClass("search__close");a&&(i.showSearchBar=!1,i.$apply(),angular.element(document.body).off("keydown",o),angular.element(document.body).off("click",o))}function r(){u.length=0,_.forEach(p.children(),function(e){u.push(e.clientWidth)}),c=u.pop(),m=0,_.forEach(u,function(e){m+=e}),i.navBarMeasured=!0}function s(){var e,t=1e3,a=m;if(e=p[0].clientWidth,a>e)for(t=u.length-1,a=a-_.last(u)+c,t;t>0&&!(a<e);t--)a-=u[t-1];i.wrapIndex=t}function l(){a.cancel(d),d=a(function(){s()},1e3)}var c,d,u=[],p=angular.element(".navigation-bar__items-container"),m=0;i.toggleSearchBar=function(){i.showSearchBar=!0,i.showSearchBar&&angular.element(document.body).on("keydown click",o)},i.openSurvey=function(){return n.open({templateUrl:"views/common/feedback.html",controller:"feedbackController",windowClass:"action-blade",backdrop:"custom"})},i.navBarMeasured=!1,i.expandNavItem=function(e,t){return e.preventDefault(),e.stopPropagation(),t.expanded?void(t.expanded=!1):(_.forEach(i.navigationItems,function(e){e.expanded=!1}),void(t.expanded=!0))},i.setFocusToMyProfile=function(){angular.element('[ux-id="user-menu-dropdown"]').focus()},i.$on(e.LAST_REPEATER_ELEMENT,function(){!i.navBarMeasured&&r(),s()}),angular.element(t).on("resize",l),i.$on("$destroy",function(){angular.element(document.body).off("keydown",o),angular.element(document.body).off("click",o),angular.element(t).off("resize",l)})}}}]).controller("feedbackController",["$scope","$modalInstance","$rootScope","$sce","i18nService",function(e,t,a,n,i){var o="https://bmc.co1.qualtrics.com/jfe/form/SV_bkYhsabqPlJ4KKp",r=a.licenseKeys&&a.licenseKeys.length?a.licenseKeys.join():"None",s=["EN","EN-CA","ES","FR","FR-CA","ZH","IT","KO","DE","RU","JA","HE","PT","PL"],l=s.indexOf(i.language.toUpperCase())>=0?i.language.toUpperCase():"EN";e.surveyURL=n.trustAsResourceUrl(o+"?Q_Language="+l+"&product=Smart IT&productVersion=233&licenseKey="+r),e.close=function(){t.close()}}])}(),function(){angular.module("headerNavigationModule").factory("headerNavigationModel",["permissionModel","configurationModel","screenConfigurationModel","systemAlertService","i18nService","roles","$window","pwaModel","utilityFunctions","searchModel","studioModel","$filter",function(e,t,a,n,i,o,r,s,l,c,d,u){function p(){a.getSmartReporterUrl().then(function(e){e=decodeURI(e),r.open(e,"_blank")})["catch"](function(e){n.error({text:e.data.errorCode?i.getLocalizedString("error.unknown"):e.data.error})})}function m(){t.helixDashboardUrl&&l.isValidHttpUrl(t.helixDashboardUrl)?r.open(t.helixDashboardUrl,"_blank"):console.error("Provided Helix Dashboard Url is invalid")}function f(){t.comaroundEnabled&&c.getHKMUrls().then(function(e){e.createUrl&&(e.createUrl=decodeURI(e.createUrl),r.open(e.createUrl,"_blank"))})}function g(){t.comaroundEnabled&&c.getHKMUrls().then(function(e){e.consoleUrl&&(e.consoleUrl=decodeURI(e.consoleUrl),r.open(e.consoleUrl,"_blank"))})}function h(){v("proactiveProblemManagementURL")}function y(){v("realtimeIncidentCorrelationURL")}function E(){if(d.baseUrlForIS&&(d.enableISCalendar||d.enableSharedConsole)){var e="/com.bmc.dsm.itsm-applications/settings/AGGADGGJJ03PPAR1P4VKR1P4VKS8TP",t="/helix/index.html#";r.open(d.baseUrlForIS+t+e,"_blank")}else console.error("Innovation Studio is not configured")}function v(e){a.getExternalUrl(e).then(function(e){e=decodeURI(e),r.open(e,"_blank")})["catch"](function(e){n.error({text:e.data.errorCode?i.getLocalizedString("error.unknown"):e.data.error})})}function T(a){var n,i=[];return _.forEach(a,function(a){if(a.elements)a.elements=T(a.elements),a.elements.length&&i.push(a);else{if(a.roles&&a.roles.length){if(a.app===EntityVO.TYPE_LIVE_CHAT){if("link"===a.type){if(e.checkLiveChatRoles())return}else if("dropdownItem"===a.type&&!e.checkLiveChatRoles())return;n=_.every(a.roles,function(t){return e.hasRole(t)})}else n=_.some(a.roles,function(t){return e.hasRole(t)});if(!n)return}if(a.role&&!e.hasRole(a.role))return;if(a.app&&!t.isServerApplicationEnabled(a.app))return;if(a.permission)if("galileo-asset-access"===a.permission){if(!e.hasAssetCreatePermission())return}else if(!e.hasPermission(a.permission))return;i.push(a)}}),i}var S=s.isPwaEnabledPromise()?"PV":"",C="Studio",O={},A=[{state:"dashboard",i18nKey:"dashboard",type:"link"},{i18nKey:"console",type:"dropdown",elements:[{name:"ticketConsole",state:"ticketConsole"+C,i18nKey:"ticketConsole",icon:"file_text_o",roles:[o.ITSM_AGENT_ROLE,o.ITSM_CHANGE_USER_ROLE,o.ITSM_PROBLEM_USER_ROLE]},{name:"knowledgeConsole",state:"knowledgeConsole",i18nKey:"knowledgeConsole",icon:"lightbulb_o",app:EntityVO.TYPE_KNOWLEDGE,role:o.ITSM_KNOWLEDGE_USER_ROLE},{name:"knowledgeConsoleHKM",handler:g,i18nKey:"knowledgeConsole",icon:"lightbulb_o",app:EntityVO.TYPE_KNOWLEDGE,type:"link",permission:o.ITSM_KNOWLEDGE_USER_ROLE},{name:"assetConsole",state:"assetConsole"+C,i18nKey:"assetConsole",icon:"cube_o",app:EntityVO.TYPE_ASSET,role:o.ITSM_ASSET_USER_ROLE}]},{state:"calendar"+C,i18nKey:"calendar",type:"link",roles:[o.ITSM_CHANGE_USER_ROLE,o.ITSM_RELEASE_USER_ROLE,o.ITSM_AGENT_ROLE,o.ITSM_PROBLEM_USER_ROLE,o.ITSM_ASSET_USER_ROLE]},{state:"smartRecorder",i18nKey:"smartRecorder",type:"link",role:o.ITSM_AGENT_ROLE},{i18nKey:"create",type:"dropdown",elements:[{name:"createIncident"+S,state:"createIncident"+S,i18nKey:"incident",icon:"file_text_o",permission:o.ITSM_AGENT_ROLE},{name:"createWorkorder"+S,state:"createWorkorder"+S,i18nKey:"workorder",icon:"file_wrench_o",app:EntityVO.TYPE_WORKORDER,permission:o.ITSM_AGENT_ROLE},{name:"createKnowledge",state:"createKnowledge",i18nKey:"knowledge",icon:"lightbulb_o",app:EntityVO.TYPE_KNOWLEDGE,permission:o.ITSM_KNOWLEDGE_USER_ROLE},{name:"createKnowledgeHKM",handler:f,i18nKey:"knowledge",icon:"lightbulb_o",app:EntityVO.TYPE_KNOWLEDGE,type:"link",permission:o.ITSM_KNOWLEDGE_USER_ROLE},{name:"PV"===S?"createChangePV":"createChange.selector",state:"PV"===S?"createChangePV":"createChange.selector",i18nKey:"change",icon:"files_change_o",app:EntityVO.TYPE_CHANGE,permission:o.ITSM_CHANGE_USER_ROLE},{name:"PV"===S?"createReleasePV":"createRelease.selector",state:"PV"===S?"createReleasePV":"createRelease.selector",i18nKey:"release",icon:"app_box_open_o",app:EntityVO.TYPE_RELEASE,permission:o.ITSM_RELEASE_USER_ROLE},{name:"createProblem"+S,state:"createProblem"+S,i18nKey:"problem",icon:"search_exclamation",app:EntityVO.TYPE_PROBLEM,permission:o.ITSM_PROBLEM_USER_ROLE},{name:"createKnownerror",state:"createKnownerror",i18nKey:"knownerror",icon:"file_exclamation_o",app:EntityVO.TYPE_KNOWNERROR,permission:o.ITSM_PROBLEM_USER_ROLE},{name:"createBroadcast",state:"createBroadcast",i18nKey:"broadcast",icon:"speaker",permission:o.ITSM_BROADCAST_USER_ROLE},{name:"createAsset"+S,state:"createAsset"+S,i18nKey:"asset",icon:"cube_o",app:EntityVO.TYPE_ASSET,permission:o.ITSM_ASSET_USER_ROLE}]},{i18nKey:"workspaces",type:"dropdown",elements:[{handler:h,i18nKey:"proactiveProblemManagement",icon:"search_exclamation",app:EntityVO.TYPE_ITSM_INSIGHTS,roles:[o.ITSM_AGENT_ROLE,o.ITSM_PROBLEM_USER_ROLE]},{handler:y,i18nKey:"realtimeIncidentCorrelation",icon:"file_text_o",app:EntityVO.TYPE_ITSM_INSIGHTS,permission:o.ITSM_AGENT_ROLE}]},{state:"liveChatAgentConsole",i18nKey:"liveChat",type:"link",app:EntityVO.TYPE_LIVE_CHAT,roles:[o.ITSM_AGENT_ROLE,o.ESCHAT_AGENT_ROLE]},{state:"liveChatDashboard",i18nKey:"liveChat",type:"link",app:EntityVO.TYPE_LIVE_CHAT,roles:[o.ITSM_AGENT_ROLE,o.ESCHAT_ADMIN_ROLE]},{i18nKey:"liveChat",type:"dropdown",app:EntityVO.TYPE_LIVE_CHAT,elements:[{name:"liveChatAgentConsole",state:"liveChatAgentConsole",i18nKey:"liveChatAgentConsole",icon:"comments_o",type:"dropdownItem",app:EntityVO.TYPE_LIVE_CHAT,roles:[o.ITSM_AGENT_ROLE,o.ESCHAT_AGENT_ROLE]},{name:"liveChatDashboard",state:"liveChatDashboard",i18nKey:"liveChatDashboard",icon:"app_chart_bar",type:"dropdownItem",app:EntityVO.TYPE_LIVE_CHAT,roles:[o.ITSM_AGENT_ROLE,o.ESCHAT_ADMIN_ROLE]}]},{handler:m,i18nKey:"helixDashboard",app:EntityVO.TYPE_HELIX_DASHBOARD,type:"link"},{handler:p,i18nKey:"reports",app:EntityVO.TYPE_REPORTS,type:"link"},{i18nKey:"configuration",type:"dropdown",elements:[{name:"screenConfiguration",state:"screenConfiguration",i18nKey:"screenConfiguration",icon:"gear",permission:"admin:screenConfiguration"},{name:"knowledgeStyleConfiguration",state:"knowledgeStyleConfiguration",i18nKey:"knowledgeTemplateStyles",icon:"lightbulb_o",app:EntityVO.TYPE_KNOWLEDGE,role:o.ITSM_ADMIN_ROLE},{name:"createAqiQuestions",state:"createAqiQuestions",i18nKey:"aqi",icon:"pencil",app:EntityVO.TYPE_KNOWLEDGE,permission:o.ITSM_KCS_COACH_ROLE},{name:"adminConsoleConfig",state:"adminConsoleConfig",i18nKey:"adminConsoleConfig",icon:"gear",permission:"admin:screenConfiguration"},{type:"link",i18nKey:"studioConfig",icon:"gear",handler:E,permission:"admin:screenConfiguration"}]},{state:"knowledgeTeam",i18nKey:"knowledge",type:"link",app:EntityVO.TYPE_KNOWLEDGE,role:o.ITSM_KCS_COACH_ROLE},{i18nKey:"customActions",type:"dropdown",hideHeader:!0,elements:[]}],I=_.find(A,{i18nKey:"customActions"});return O.updateNavigationItems=function(){return T(A)},O.clearCustomActions=function(){_.remove(I.elements,{extended:!0})},O.getCustomActions=function(e){_.forEach(e.actionList,function(e){if(_.includes(e.supportedPlatforms,"web")){var t={extended:!0};t.label=e.labels[i.language]||e.labels["default"],t.url=e.url,t.target=e.target,t.sequenceNo=e.sequenceNo,I.elements.push(t)}});s.isPwaEnabled();I.elements.length&&("alphabetical"===e.actionOrder?I.elements=_.sortBy(I.elements,"label"):I.elements=_.sortBy(I.elements,"sequenceNo"))},O}])}(),function(){angular.module("ticketModule").directive("previewOutage",["metadataModel","$filter","configurationModel","ticketModel","relationModel","systemAlertService","$window","$timeout","ticketActionService",function(e,t,a,n,i,o,r,s,l){return{restrict:"A",templateUrl:"views/ticket/outage-details.html",controller:"PreviewTicketController",scope:{isFullVersion:"="},link:function(s,c,d){function u(){m.isScheduled="Scheduled Full"===m.outageTypeName||"Scheduled Partial"===m.outageTypeName,m.isScheduled||(m.scheduledStartDate="",m.scheduledStartTime="",m.scheduledEndDate="",m.scheduledEndTime="")}function p(e,t){return t=t?moment(t):moment(e),1e3*moment(e).set("hours",t.get("hours")).set("minutes",t.get("minutes")).format("X")}var m,f,g;d.$observe("previewOutage",function(e){s.init(e,EntityVO.TYPE_OUTAGE,!0)}),s.showMeridian=window.showMeridian,s.editMode=!1,s.isViewScreen=!0,s.setTarget=s.$parent.$parent.newTab?"_blank":null,s.outageCreationEnabled=!0,s.datePickerOptions={startingDay:a.getWeekStartingDay(),"show-weeks":!1,minDate:moment().year(1970).month(0).date(2),maxDate:moment().year(2038).month(0).date(18)},e.getMetadataByType(EntityVO.TYPE_GLOBAL).then(function(e){s.globalMetadata=e}),s.enableOutageEdit=function(){f=_.cloneDeep(s.basicData),m=s.outage=s.basicData,g=s.outageMetadata={},s.editMode=!0,m.parent=m.affectedAsset,m.today=(new Date).getTime(),m.scheduledStartDate&&(m.scheduledStartTime=_.clone(m.scheduledStartDate)),m.scheduledEndDate&&(m.scheduledEndTime=_.clone(m.scheduledEndDate)),m.actualStartDate&&(m.actualStartTime=_.clone(m.actualStartDate)),m.actualEndDate&&(m.actualEndTime=_.clone(m.actualEndDate)),m.scheduledStartDatePicker={open:!1},m.scheduledEndDatePicker={open:!1},m.actualStartDatePicker={open:!1},m.actualEndDatePicker={open:!1},s.state.dataIsLoading=!0,e.getMetadataByType(EntityVO.TYPE_OUTAGE).then(function(e){angular.extend(g,e),m.outageType=_.find(g.types,{name:m.outageTypeName}),m.outageTypeName=m.outageType.name,m.status=_.find(g.statuses,{name:m.status.value}),u()})["finally"](function(){s.state.dataIsLoading=!1})},s.save=function(){var e={type:m.outageTypeName,desc:m.desc,scheduledStartDate:m.scheduledStartDate?p(new Date(m.scheduledStartDate),new Date(m.scheduledStartTime)):null,scheduledEndDate:m.scheduledEndDate?p(new Date(m.scheduledEndDate),new Date(m.scheduledEndTime)):null,actualStartDate:m.actualStartDate?p(new Date(m.actualStartDate),new Date(m.actualStartTime)):null,
actualEndDate:m.actualEndDate?p(new Date(m.actualEndDate),new Date(m.actualEndTime)):null};s.state.dataIsLoading=!0,n.update(m.id,EntityVO.TYPE_OUTAGE,e).then(function(e){m.status=e.status,m.outageType=_.find(g.types,{name:e.outageTypeName}),s.basicData.outageTypeName=m.outageType.name,m.scheduledStartDate=e.scheduledStartDate,m.scheduledEndDate=e.scheduledEndDate,m.actualStartDate=e.actualStartDate,m.actualEndDate=e.actualEndDate,m.actualStartDateHumanized=e.actualStartDate?moment(e.actualStartDate).format("lll"):"",m.actualEndDateHumanized=e.actualEndDate?moment(e.actualEndDate).format("lll"):"",m.scheduledStartDateHumanized=e.scheduledStartDate?moment(e.scheduledStartDate).format("lll"):"",m.scheduledEndDateHumanized=e.scheduledEndDate?moment(e.scheduledEndDate).format("lll"):"",s.editMode=!1,i.refreshRelations(s.basicData.affectedAsset.reconciliationId,EntityVO.TYPE_ASSET)})["finally"](function(){s.state.dataIsLoading=!1})},s.cancel=function(){s.editMode=!1,s.basicData=f},s.deleteOutage=function(){var e=o.modal({title:t("i18n")("common.notification.delete.title"),text:t("i18n")("common.notification.delete.message"),buttons:[{text:t("i18n")("controls.action.ok"),data:!0},{text:t("i18n")("controls.action.cancel"),data:!1}]});e.result.then(function(e){if(e){var a={parentType:EntityVO.TYPE_ASSET,parentId:s.basicData.affectedAsset.reconciliationId},n={type:EntityVO.TYPE_OUTAGE,id:s.basicData.id,relationshipType:"relatedto",parentId:a.parentId};s.state.dataIsLoading=!0,i.removeRelation(a,[n]).then(function(){o.success({text:t("i18n")("ticket.notification.delete.outage"),hide:1e4}),i.refreshRelations(s.basicData.affectedAsset.reconciliationId,EntityVO.TYPE_ASSET).then(function(){r.history.back()})})["catch"](function(){s.state.dataIsLoading=!1})}})},s.updateType=function(e){s.basicData.updateOutageForm.$setDirty(),m.outageType=e,m.outageTypeName=m.outageType.name,u()},s.updateDateTime=function(e){if((m[e+"StartDate"]&&!m[e+"StartTime"]||!m[e+"StartDate"]&&m[e+"StartTime"])&&(m[e+"StartTime"]=_.clone(m[e+"StartDate"])),(m[e+"EndDate"]&&!m[e+"EndTime"]||!m[e+"EndDate"]&&m[e+"EndTime"])&&(m[e+"EndTime"]=_.clone(m[e+"EndDate"])),m[e+"StartDate"]&&m[e+"EndDate"]){var t=p(new Date(m[e+"StartDate"]),new Date(m[e+"StartTime"])),a=p(new Date(m[e+"EndDate"]),new Date(m[e+"EndTime"]));a<=t?m.updateOutageForm[e+"EndDate"].$setValidity("validScheduledEndDateTime",!1):m.updateOutageForm[e+"EndDate"].$setValidity("validScheduledEndDateTime",!0)}!m[e+"StartDate"]&&m[e+"EndDate"]?m.updateOutageForm[e+"StartDate"].$setValidity("validScheduledStartDateTime",!1):m.updateOutageForm[e+"StartDate"].$setValidity("validScheduledStartDateTime",!0)},s.share=function(e){l.showShareDialog(s.basicData).result.then(function(){e.currentTarget.focus()},function(){e.currentTarget.focus()})},s.openDatePicker=function(e){e.open=!0}}}}])}(),function(){angular.module("personModule").controller("createPersonController",["$scope","$state","$q","$modalInstance","i18nService","systemAlertService","userModel","searchModel","personModel","metadataModel","screenConfigurationModel","personCompany",function(e,t,a,n,i,o,r,s,l,c,d,u){"ngInject";function p(){e.state={dataIsLoading:!0,tooManyCompanies:!1,tooManySites:!1},e.selections={},e.person=f,m();var t=s.getOperatingCompanies(null,-1).then(function(t){e.selections.companies=_.cloneDeep(t.companies),e.state.tooManyCompanies=t.exceedsChunkSize}),n=c.getPersonMetadata(EntityVO.TYPE_PERSON).then(function(t){angular.extend(f,t),e.person.company=r.userFullData.company,e.person.isVIP=_.find(t.vip,{name:"No"}),e.person.clientSensitivity=_.find(t.clientSensitivities,{name:"Standard"}),e.person.clientType=_.find(t.clientTypes,{name:"Customer"}),e.person.contactType=_.find(t.contactTypes,{name:"Customer"})});d.loadScreenConfigurationAndCustomFieldLabels(ScreenConfigurationVO.prototype.PERSON_DETAILS_SCREEN,EntityVO.TYPE_PERSON),a.all([n,t]).then(function(){u?e.updateCompany(u):e.getSitesByCompany(e.person.company.name),e.state.dataIsLoading=!1})}function m(){e.$on("$stateChangeStart",function(e,a,r){if(g()){e.preventDefault();var s=o.modal({title:i.getLocalizedString("common.notification.dirty.title"),text:i.getLocalizedString("common.notification.dirty.message"),buttons:[{text:i.getLocalizedString("common.labels.yes"),data:{stateName:a.name,stateParams:r}},{text:i.getLocalizedString("common.labels.no")}]});s.result.then(function(e){_.isEmpty(e)||(f={},n.dismiss(),t.transitionTo(e.stateName,e.stateParams))})}else n.dismiss()})}var f={type:EntityVO.TYPE_PERSON};e.updateCompany=function(t){e.person.company={name:t.name,id:t.id},e.person.organization="",e.person.department="",e.person.site="",e.getSitesByCompany(e.person.company.name)},e.getCompaniesByName=function(e){return s.getCompaniesByText(e).then(function(e){return e.companies})},e.getOrganizationsAndUpdate=function(t){e.organizationsLoading=!0,l.getOrganizationList(t.name).then(function(t){e.organizations=t})["finally"](function(){e.organizationsLoading=!1})},e.getDepartmentsAndUpdate=function(t,a){e.departmentsLoading=!0,l.getDepartmentList(t,a.name).then(function(t){e.departments=t})["finally"](function(){e.departmentsLoading=!1})},e.getSitesByCompany=function(t){return e.sitesLoading=!0,s.getSitesByCompany(t).then(function(t){e.sites=t.objects,e.state.tooManySites=t.exceedsChunkSize})["finally"](function(){e.sitesLoading=!1})},e.getSitesByTextAndCompany=function(t){return t=t?t:"%",s.getSitesByTextAndCompany(t,e.person.company.name).then(function(e){return{list:e.list,exceedsChunkSize:e.exceedsChunkSize}})},e.selectSite=function(t){e.person.site=t},e.createPerson=function(){e.state.dataIsLoading=!0,l.createPerson(e.person).then(function(e){n.close(e)})["catch"](function(e){e&&e.data&&o.error({text:e.data.error,clear:!1})})["finally"](function(){e.state.dataIsLoading=!1})},e.cancel=function(){n.dismiss()};var g=function(){return e.createCustomerForm.$dirty||!_.isEmpty(f.firstName)||!_.isEmpty(f.lastName)};p()}]).value("personCompany",null)}(),function(){angular.module("personModule").directive("editPersonData",["events","$sce",function(e,t){return{restrict:"E",templateUrl:"views/person/edit-person-data.html",scope:{personProfile:"="},controller:["$scope","personModel","searchModel","utilityFunctions",function(t,a,n,i){function o(){var n={organization:t.person.organization,department:t.person.department,siteName:t.person.site?t.person.site.name:"",firstName:i.escapeHTML(t.person.firstName),lastName:i.escapeHTML(t.person.lastName),jobTitle:i.escapeHTML(t.person.jobTitle)};t.$emit(e.SAVE_CHANGES_REQUEST,null,!0),a.updatePersonInfo(t.person.id,n).then(function(){t.$emit("personDataUpdated")})["finally"](function(){t.$emit(e.SAVE_CHANGES_COMPLETE)})}t.getOrganizationsAndUpdate=function(e){t.organizationsLoading=!0,a.getOrganizationList(e.name).then(function(e){t.organizations=e})["finally"](function(){t.organizationsLoading=!1})},t.getDepartmentsAndUpdate=function(e,n){t.departmentsLoading=!0,a.getDepartmentList(e,n.name).then(function(e){t.departments=e})["finally"](function(){t.departmentsLoading=!1})},t.state={tooManySites:!1},t.sitesLoading=!1,t.getSitesByCompany=function(e){return t.sitesLoading=!0,n.getSitesByCompany(e).then(function(e){t.sites=e.objects,t.state.tooManySites=e.exceedsChunkSize})["finally"](function(){t.sitesLoading=!1})},t.getSitesByTextAndCompany=function(e){return e=e?e:"%",n.getSitesByTextAndCompany(e,t.person.company.name).then(function(e){return{list:e.list,exceedsChunkSize:e.exceedsChunkSize}})},t.selectSite=function(e){t.person.site=e};var r=function(){t.person=_.cloneDeep(t.personProfile),t.getSitesByCompany(t.person.company.name)},s=function(){console.log("handleSaveChanges in editPersonData directive"),o()},l=function(){t.person=_.cloneDeep(t.personProfile)};t.$on(e.TOGGLE_EDIT_MODE,r),t.$on(e.SAVE_CHANGES,s),t.$on(e.DISCARD_CHANGES,l),t.person=_.cloneDeep(t.personProfile)}]}}])}(),PersonAssetVO.prototype=new BaseVO,PersonAssetVO.prototype.constructor=PersonAssetVO,PersonAssetVO.prototype.getProps=function(){return BaseVO.prototype.getProps().concat("reconciliationId","name","desc","type","assetType","ticketCount","receivedDate","classId","product","role","assetExtension","status","manufacturer")},PersonAssetVO.prototype.postBuild=function(){this.assetReceivedDate=moment(this.receivedDate).fromNow(!0),this.categories=this.product.categorizations,this.entityLink="#/"+EntityVO.TYPE_ASSET+"/"+this.reconciliationId+"/"+this.classId},function(){angular.module("personModule").controller("PersonController",["$scope","personModel","userModel","$state","$filter","attachmentService","screenConfigurationModel","events","ticketActionService","$q","chatModel","$modal","openMailClientService","configurationModel","metadataModel","systemAlertService","$timeout","$window","$location",function(e,t,a,n,i,o,r,s,l,c,d,u,p,m,f,g,h,y,E){function v(){var t,a;e.selectedChat&&(e.selectedChat&&"Assigned"!==e.selectedChat.status||(e.setDeafultStyleForTickets=!0,e.selectedChat&&"Assigned"===e.selectedChat.status&&(t=!e.selectedChat.ticket||!e.selectedChat.ticket.ticketId,a=!(!e.selectedChat.ticket||!e.selectedChat.ticket.ticketId),e.setDeafultStyleForTickets&&(t||a)&&(e.setDeafultStyleForTickets=!1))))}function T(t,a){e.activeEditableSectionId=a,"ticket-header"===a&&(e.editHeader=!0)}function S(t,a){e.activeEditableSectionId=null,"ticket-header"===a&&(e.editHeader=!1)}function C(a,n){h(function(){e.person=t.personDetails,n&&!_.isEmpty(e.person)&&(O(),A())},0)}function O(){e.restrictPersonProfileResultForNoOfDays=m.restrictPersonProfileResultForNoOfDays,e.person=t.personDetails,e.$emit(s.PERSON_DATA_LOADED,e.person),e.disableClick=!(!_.isUndefined(e.person.email)&&""!==e.person.email),e.setTarget=e.selectedChat?"_blank":null,e.personSupportGroups=t.personDetails.supportGroups,e.personAvailability=e.person.availability,!e.isFullVersion&&e.person.accessMappings&&(e.person.accessMappings.detailsEditAllowed=!1),e.person.isSupportStaff?(t.getAssignedTickets(e.person.loginId,0,!0,k,e.restrictPersonProfileResultForNoOfDays).then(function(){e.personAssignedTickets=t.personAssignedTickets.ticketList,e.personAssignedTicketsTotalMatches=t.personAssignedTickets.totalMatches}),t.getKnowledgeArticles(e.person.loginId).then(function(){e.personKnowledgeArticles=t.personKnowledgeArticles,e.personKnowledgeArticlesTotalMatches=t.personKnowledgeArticles.totalMatches})):t.getAllTickets(e.person.loginId,0,!1,k,e.restrictPersonProfileResultForNoOfDays).then(function(){e.personAllTickets=t.personAllTickets.ticketList,e.personAllTicketsTotalMatches=t.personAllTickets.totalMatches,e.personAllTicketsChunkAvailable=t.personAllTickets.exceedsChunkSize}),e.isServiceBrokerEnabled&&t.getOpenServiceBrokerTickets(e.person.loginId,0,e.restrictPersonProfileResultForNoOfDays).then(function(){e.personOpenSBETickets=t.personOpenServiceBrokerTickets.ticketList,e.personOpenSBETicketsTotalMatches=t.personOpenServiceBrokerTickets.totalMatches})}function A(){e.state.isPersonDataLoading=!1,e.isPersonProfile===!0&&e.personDataLoaded({$event:e.person}),t.getServiceSummaryStats(I).then(function(){e.serviceSummary=t.serviceSummary}),t.getPersonAssets(I,!0).then(function(){e.personAssetList=t.personAssets}),c.all(f.getMetadataByType(EntityVO.TYPE_WORKORDER),f.getMetadataByType(EntityVO.TYPE_INCIDENT),f.getMetadataByType(EntityVO.TYPE_ASSET),f.getMetadataByType(EntityVO.TYPE_PROBLEM),f.getMetadataByType(EntityVO.TYPE_CHANGE),f.getMetadataByType(EntityVO.TYPE_TASK),f.getMetadataByType(EntityVO.TYPE_RELEASE),f.getMetadataByType(EntityVO.TYPE_KNOWLEDGE)).then(function(){e.restrictPersonProfileResultForNoOfDays=m.restrictPersonProfileResultForNoOfDays,t.getOpenTickets(e.person.loginId,0,!!e.person.isSupportStaff,k,e.restrictPersonProfileResultForNoOfDays).then(function(){e.personOpenTickets=t.personOpenTickets.ticketList,e.personOpenTicketsTotalMatches=t.personOpenTickets.totalMatches,e.personOpenTicketsChunkAvailable=t.personOpenTickets.exceedsChunkSize,v()})})}var I,b=r.getScreenNameByTicketType(EntityVO.TYPE_PERSON);e.isServiceBrokerEnabled=m.isServerApplicationEnabled(EntityVO.TYPE_SBEREQUEST),e.$on("personDataUpdated",C);var k;e.restrictPersonProfileResultForNoOfDays=0,e.follow=function(){var n=a.userFullData.loginId;return t.followPerson(n,e.person.loginId)},e.unfollow=function(){var n=a.userFullData.loginId;return t.unfollowPerson(n,e.person.loginId)},e.toggleFollowingFlag=function(){var t=e.person.following?e.unfollow:e.follow;t(e.person).then(function(){e.person.following=!e.person.following})},e.share=function(t){l.showShareDialog(e.person).result.then(function(){t.currentTarget.focus()},function(){t.currentTarget.focus()})},e.emailPerson=function(){var t=a.userFullData.fullName+i("i18n")("shareBlade.emailSubject");p.openMailClient(e.person.email,t,"")},e.showPrintDialog=function(t){var a=u.open({templateUrl:"views/common/print-action-blade.html",controller:"PrintController",windowClass:"action-blade",size:"extra-lg",resolve:{params:function(){return{entity:e.person,feed:e.person.feed}}}});a.result["finally"](function(){t.currentTarget.focus()})},e.setTaskSection=function(t){e.activeTaskSection=t},e.init=function(a){I=a,e.$on(s.TOGGLE_EDIT_MODE,T),e.$on(s.EDIT_COMPLETE,S),a&&(k=e.selectedChat?0:1,e.editHeader=!1,e.isCollapsed=!0,e.activeTaskSection="assets",e.state={isPersonDataLoading:!0},e.chatModel=d,c.all([t.getPersonDetailsByID(a),r.loadScreenConfigurationAndCustomFieldLabels(b,EntityVO.TYPE_PERSON)]).then(O)["finally"](A))},e.showProfileDetails=function(t,a,i){if("href"in i.target)return void(e.selectedChat&&"javascript:void(0)"!==i.target.href&&(i.target.target="_blank"));switch(a){case EntityVO.TYPE_TICKET:if(e.selectedChat){var o=n.href(t.type,{id:t.id});y.open(o,"_blank")}else n.go(t.type,{id:t.id});break;case EntityVO.TYPE_ASSET:if(e.selectedChat){var o=n.href(a,{assetId:t.reconciliationId,assetClassId:t.classId});y.open(o,"_blank")}else n.go(a,{assetId:t.reconciliationId,assetClassId:t.classId});break;case EntityVO.TYPE_KNOWLEDGE:if(e.selectedChat){var o=n.href(a,{id:t.uuid});y.open(o,"_blank")}else n.go(a,{id:t.uuid})}},e.handleFileChange=function(t){o.uploadProfileThumbnail(e.person.loginId,EntityVO.TYPE_PERSON,t,"").then(function(t){t.thumbnail&&(e.person.thumbnail=t.thumbnail,e.person.loginId===a.userFullData.loginId&&(a.userFullData.thumbnail=t.thumbnail))},function(e){g.error({text:i("i18n")("attachment.fileExtension.error")})})},e.editDisabledFor=function(t){return e.activeEditableSectionId&&e.activeEditableSectionId!==t},e.loadMoreRequestedByTickets=function(){e.state.isPersonDataLoading||e.state.isMoreRequestedByTicketsLoading||!e.personOpenTicketsChunkAvailable||(e.state.isMoreRequestedByTicketsLoading=!0,t.getOpenTickets(t.personDetails.id,t.personOpenTickets.ticketList.length,!!e.person.isSupportStaff,k,e.restrictPersonProfileResultForNoOfDays)["finally"](function(){e.state.isMoreRequestedByTicketsLoading=!1,e.personOpenTickets=t.personOpenTickets.ticketList,e.personOpenTicketsTotalMatches=t.personOpenTickets.totalMatches,e.personOpenTicketsChunkAvailable=t.personOpenTickets.exceedsChunkSize,v()}))},e.requestedByCount=function(){if(window.isRtl){var t=" ("+(e.personOpenTicketsTotalMatches||0)+") "+e.person.firstName+" "+i("i18n")("person.details.tickets.requestedBy");return t}return i("i18n")("person.details.tickets.requestedBy")+" "+e.person.firstName+" ("+(e.personOpenTicketsTotalMatches||0)+")"},e.loadMoreAllTickets=function(){e.state.isPersonDataLoading||e.state.isMoreAllTicketsLoading||!e.personAllTicketsChunkAvailable||(e.state.isMoreAllTicketsLoading=!0,t.getAllTickets(t.personDetails.id,t.personAllTickets.ticketList.length,!1,k,e.restrictPersonProfileResultForNoOfDays)["finally"](function(){e.state.isMoreAllTicketsLoading=!1,e.personAllTickets=t.personAllTickets.ticketList,e.personAllTicketsTotalMatches=t.personAllTickets.totalMatches,e.personAllTicketsChunkAvailable=t.personAllTickets.exceedsChunkSize,v()}))},e.loadMoreAssignedTickets=function(){!e.state.isPersonDataLoading&&!e.state.isPersonMoreTicketsLoading&&t.personAssignedTickets.totalMatches>t.personAssignedTickets.ticketList.length&&(e.state.isPersonMoreTicketsLoading=!0,t.getAssignedTickets(t.personDetails.id,t.personAssignedTickets.ticketList.length,!0,k,e.restrictPersonProfileResultForNoOfDays)["finally"](function(){e.state.isPersonMoreTicketsLoading=!1,e.personAssignedTickets=t.personAssignedTickets.ticketList,e.totalMatches=t.personAssignedTickets.totalMatches,v()}))},e.getMoreOpenServiceBrokerTickets=function(){e.state.isPersonMoreOpenSBETicketsLoading=!0,t.getOpenServiceBrokerTickets(t.personDetails.id,t.personOpenServiceBrokerTickets.ticketList.length,e.restrictPersonProfileResultForNoOfDays)["finally"](function(){e.state.isPersonMoreOpenSBETicketsLoading=!1,e.personOpenSBETickets=t.personOpenServiceBrokerTickets.ticketList,e.personOpenSBETicketsTotalMatches=t.personOpenServiceBrokerTickets.totalMatches,v()})},e.isURL=function(e){var t=/(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/;return t.test(e)},e.$on(s.EDIT_COMPLETE,S)}])}(),function(){angular.module("myitsmApp").directive("editPersonContact",["events",function(e){return{restrict:"E",templateUrl:"views/person/person-contact-edit.html",replace:!0,scope:{personProfile:"="},controller:["$scope","personModel","searchModel",function(t,a,n){function i(){t.isPersonDataSaving=!0;var n={siteName:t.person.site?t.person.site.name:"",phone:t.person.phone,fax:t.person.fax,cell:t.person.cell,email:t.person.email},i={};t.person.isSupportStaff&&(i={introduction:t.person.introduction,enabled:t.person.enabled,availableForAssignment:t.person.availableForAssignment,linkedIn:t.person.linkedIn,twitter:t.person.twitter},n=_.merge(n,i)),t.$emit(e.SAVE_CHANGES_REQUEST,null,!0),a.updatePersonInfo(t.person.id,n).then(function(){t.$emit("personDataUpdated")})["finally"](function(){t.$emit(e.SAVE_CHANGES_COMPLETE),t.isPersonDataSaving=!1})}t.state={tooManySites:!1},t.sitesLoading=!1,t.getSitesByCompany=function(e){return t.sitesLoading=!0,n.getSitesByCompany(e).then(function(e){t.sites=e.objects,t.state.tooManySites=e.exceedsChunkSize})["finally"](function(){t.sitesLoading=!1})},t.getSitesByTextAndCompany=function(e){return e=e?e:"%",n.getSitesByTextAndCompany(e,t.person.company.name).then(function(e){return{list:e.list,exceedsChunkSize:e.exceedsChunkSize}})},t.selectSite=function(e){t.person.site=e};var o=function(){t.person=_.cloneDeep(t.personProfile),t.getSitesByCompany(t.person.company.name)},r=function(){console.log("handleSaveChanges in editPersonContact directive"),i()},s=function(){t.person=_.cloneDeep(t.personProfile)};t.$on(e.TOGGLE_EDIT_MODE,o),t.$on(e.SAVE_CHANGES,r),t.$on(e.DISCARD_CHANGES,s),t.person=_.cloneDeep(t.personProfile)}]}}])}(),function(){angular.module("personModule").filter("personShortName",function(){return function(e){if(e){var t=e.split(" ");return t[0]+" "+t[1].charAt(0)+"."}}}).filter("lastUpdatedDate",function(){return function(e){return moment(e).calendar({sameElse:"lll"})}})}(),function(){angular.module("personModule").directive("personInfoCard",["$state","googleMapService",function(e,t){return{restrict:"E",scope:{person:"=",showThumbnail:"@",label:"=",profileType:"@",context:"=",personType:"@"},priority:99,replace:!0,templateUrl:"views/person/person-infocard-template.html",link:function(e){e.googleMapAvailable=t.isAvailable,e.context&&e.context.type===EntityVO.TYPE_SBEREQUEST&&(e.context.displayId=e.context.id,e.context.summary=e.context.serviceName),e.isCustomerRequired=function(){return"customer"===e.personType&&"person"!==e.profileType&&("incident"!==e.profileType||"Infrastructure Event"!==e.context.serviceType)}}}}])}(),function(){angular.module("personModule").factory("personModel",["personService","$q","configurationModel","systemAlertService","userModel",function(e,t,a,n,i){function o(e,t){if(Number.isInteger(e)&&0!==e){var a=new Date,n=a.getTime();a.setDate(a.getDate()-e);var i=a.getTime();t.createDateRanges=[],t.createDateRanges.push({start:i,end:n})}}function r(e){var t={};return _.forEach(e,function(e){if(s.filterDict[e.filter]){var a=_.find(s.filterDict[e.filter].options,{name:e.option}),n=a.criteria.name;t[n]=a.criteria.value}}),t}var s={personDetails:{},personAssets:[],personOpenTickets:{ticketList:[],totalMatches:0,exceedsChunkSize:!1},personClosedTickets:{ticketList:[],totalMatches:0},personOpenServiceBrokerTickets:{ticketList:[],totalMatches:0},personClosedServiceBrokerTickets:{ticketList:[],totalMatches:0},personAllTickets:{ticketList:[],totalMatches:0,exceedsChunkSize:!1},personAssignedTickets:{ticketList:[],totalMatches:0},personKnowledgeArticles:[],filterConfig:_.cloneDeep(a.get("ticketConsole.filter")),defaultChunkSize:20};return s.criteria={filterCriteria:{},chunkInfo:{startIndex:0,chunkSize:s.defaultChunkSize}},s.filterDict=_.keyBy(s.filterConfig,"name"),s.getPersonDetailsByID=function(t){return i.userId!==t&&(t=encodeURIComponent(t)),e.getPersonDetailsByID(t).then(function(e){return s.personDetails=e,e})},s.getListOfPersonByName=function(t,a){var n=""+t,i=!0;return t&&a&&(n=t+" "+a,i=!1),e.getListOfPersonByName(n,i)},s.getListOfPersonsByText=function(t){return e.getListOfPersonByName(t)},s.getListOfChangeManagerByText=function(t){return e.getListOfPersonByName(t,!1,"changemanager")},s.getListOfRequestManagerByText=function(t){return e.getListOfPersonByName(t,!1,"workordermanager")},s.getListOfChangeCoordinatorByText=function(t){return e.getListOfPersonByName(t,!1,"changecoordinator")},s.getListOfProblemCoordinatorByText=function(t){return e.getListOfPersonByName(t,!1,"problemcoordinator")},s.getListOfReleaseCoordinatorByText=function(t){return e.getListOfPersonByName(t,!1,"releasecoordinator")},s.getListOfPersonNamesByText=function(t){return e.getListOfPersonNamesByName(t)},s.getServiceSummaryStats=function(t){return e.getServiceSummaryStats(t).then(function(e){s.serviceSummaryRaw=e[0].statsMetrics,s.serviceSummary={ratingCount:0,ratingScore:0,escalation:0,ratingMarkers:[]};var t;for(t=0;t<s.serviceSummaryRaw.length;t++)"Number of Ratings"===s.serviceSummaryRaw[t].name?s.serviceSummary.ratingCount=s.serviceSummaryRaw[t].value:"Average Rating"===s.serviceSummaryRaw[t].name?s.serviceSummary.ratingScore=s.serviceSummaryRaw[t].value:"Number of Escalations"===s.serviceSummaryRaw[t].name&&(s.serviceSummary.escalation=s.serviceSummaryRaw[t].value);for(t=0;t<5;t++)s.serviceSummary.ratingScore>=t+.75?s.serviceSummary.ratingMarkers.push({value:100}):s.serviceSummary.ratingScore>=t+.25?s.serviceSummary.ratingMarkers.push({value:50}):s.serviceSummary.ratingMarkers.push({value:0})})},s.getPersonAssets=function(t,a){return e.getPersonAssets(t,a).then(function(e){s.personAssets=e})},s.getOpenTickets=function(t,a,n,i,r){var l={};return l.chunkInfo={startIndex:a||0,chunkSize:s.defaultChunkSize},l.filterCriteria={customer:{loginId:t},statusMapping:"open"},l.sortInfo={sortFieldName:"modifiedDate",sortFieldOrder:"DESC"},l.statCount=!!n,l.queryMinimalView=i||0,o(r,l.filterCriteria),e.getTickets(l).then(function(e){a>0?s.personOpenTickets.ticketList=_.union(s.personOpenTickets.ticketList,e.ticketList):s.personOpenTickets.ticketList=e.ticketList,s.personOpenTickets.totalMatches=e.totalMatches,s.personOpenTickets.exceedsChunkSize=e.exceedsChunkSize})},s.getOpenServiceBrokerTickets=function(t,a,n){var i={};return i.chunkInfo={startIndex:a||0,chunkSize:s.defaultChunkSize},i.filterCriteria={customer:{loginId:t},statusMapping:"open"},i.sortInfo={sortFieldName:"modifiedDate",sortFieldOrder:"DESC"},o(n,i.filterCriteria),e.getServiceBrokerTickets(i).then(function(e){a>0?s.personOpenServiceBrokerTickets.ticketList=_.union(s.personOpenServiceBrokerTickets.ticketList,e.ticketList):s.personOpenServiceBrokerTickets.ticketList=e.ticketList,s.personOpenServiceBrokerTickets.totalMatches=e.totalMatches})},s.getClosedTickets=function(t,a,n,i,r){var l={};return l.filterCriteria={customer:{loginId:t},statusMapping:"close"},l.sortInfo={sortFieldName:"modifiedDate",sortFieldOrder:"DESC"},l.chunkInfo={startIndex:a||0,chunkSize:s.defaultChunkSize},l.statCount=!!n,l.queryMinimalView=i||0,o(r,l.filterCriteria),e.getTickets(l).then(function(e){a>0?s.personClosedTickets.ticketList=_.union(s.personClosedTickets.ticketList,e.ticketList):s.personClosedTickets.ticketList=e.ticketList,s.personClosedTickets.totalMatches=e.totalMatches})},s.getClosedServiceBrokerTickets=function(t,a,n){var i={};return i.filterCriteria={customer:{loginId:t},statusMapping:"close"},i.sortInfo={sortFieldName:"modifiedDate",sortFieldOrder:"DESC"},i.chunkInfo={startIndex:a||0,chunkSize:s.defaultChunkSize},o(n,i.filterCriteria),e.getServiceBrokerTickets(i).then(function(e){a>0?s.personClosedServiceBrokerTickets.ticketList=_.union(s.personClosedServiceBrokerTickets.ticketList,e.ticketList):s.personClosedServiceBrokerTickets.ticketList=e.ticketList,s.personClosedServiceBrokerTickets.totalMatches=e.totalMatches})},s.getAllTickets=function(t,a,n,i,r){var l={};return l.filterCriteria={customer:{loginId:t}},l.chunkInfo={startIndex:a||0,chunkSize:s.defaultChunkSize},l.sortInfo={sortFieldName:"modifiedDate",sortFieldOrder:"DESC"},l.statCount=!!n,l.queryMinimalView=i||0,o(r,l.filterCriteria),e.getTickets(l).then(function(e){a>0?s.personAllTickets.ticketList=_.union(s.personAllTickets.ticketList,e.ticketList):s.personAllTickets.ticketList=e.ticketList,s.personAllTickets.totalMatches=e.totalMatches,s.personAllTickets.exceedsChunkSize=e.exceedsChunkSize})},s.getAssignedTickets=function(t,a,n,i,l){var c={},d=[{filter:"assignees",option:"me"},{filter:"statuses",option:"allOpen"}],u=_.find(s.filterDict.assignees.options,{label:"me"});return u.criteria.value=[{loginId:t}],c.filterCriteria=r(d),o(l,c.filterCriteria),c.chunkInfo={startIndex:a||0,chunkSize:s.defaultChunkSize},c.sortInfo={sortFieldName:"modifiedDate",sortFieldOrder:"DESC"},c.statCount=!!n,c.queryMinimalView=i||0,e.getAssignedTickets(c).then(function(e){if(a>0){var t=_.union(s.personAssignedTickets.ticketList,e.ticketList);s.personAssignedTickets.ticketList=_.sortBy(t,"modifiedDate").reverse()}else s.personAssignedTickets.ticketList=e.ticketList;s.personAssignedTickets.totalMatches=e.totalMatches})},s.getKnowledgeArticles=function(t){var a={authoredBy:{loginId:t}};return e.getKnowledgeArticles(a).then(function(e){s.personKnowledgeArticles=e})},s.searchPersonInSocialByNameQuery=function(a){return a?e.searchPersonInSocialByNameQuery(a):t.when([])},s.updatePersonInfo=function(a,o){return e.updatePersonInfo(a,o).then(function(e){s.personDetails=_.merge(s.personDetails,e),i.userFullData.id===e.id&&(i.userFullData=_.merge(i.userFullData,e))})["catch"](function(e){return e&&n.error({text:e.data.error,clear:!1}),t.reject(e)})},s.getOrganizationList=function(t){return e.getOrganizationList(t)},s.getDepartmentList=function(t,a){return e.getDepartmentList(t,a)},s.getSiteList=function(t){return e.getSiteList(t)},s.followPerson=function(t,a){return e.followPerson(t,a)},s.unfollowPerson=function(t,a){return e.unfollowPerson(t,a)},s.createPerson=function(t){var a={firstName:t.firstName,middleName:t.middleName,lastName:t.lastName,email:t.email,company:t.company,clientType:t.clientType?t.clientType.name:void 0,clientSensitivity:t.clientSensitivity?t.clientSensitivity.name:void 0,contactType:t.contactType?t.contactType.name:void 0,isVIP:"Yes"===t.isVIP.name,jobTitle:t.jobTitle,organization:t.organization,department:t.department,site:t.site&&t.site.name?t.site:{},phone:t.phone,fax:t.fax,cell:t.cell,corporateId:t.corporateId,loginId:t.loginId};return e.createPerson(a).then(function(e){return e})},s}])}(),function(){angular.module("personModule").controller("PersonPreviewController",["$scope","$stateParams","$state","personModel","$q","metadataModel","configurationModel","screenConfigurationModel","systemAlertService","$filter","pwaModel",function(e,t,a,n,i,o,r,s,l,c,d){function u(){var t=e.personId,a=s.getScreenNameByTicketType(EntityVO.TYPE_PERSON);e.assetLimit=4,e.ticketOpenLimit=4,e.ticketCloseLimit=4,e.ticketSBEOpenLimit=4,e.ticketSBECloseLimit=4,e.state={loadingSummaryStats:!0,loadingPersonDetails:!0,loadingPersonAssets:!0,loadingOpenTickets:!0,loadingClosedTickets:!0,loadingSBEOpenTickets:!0,loadingSBEClosedTickets:!0},e.person="",e.pvEnabled=d.isPwaEnabled(),n.getServiceSummaryStats(e.personId).then(function(){e.serviceSummary=n.serviceSummary})["finally"](function(){e.state.loadingSummaryStats=!1}),i.all([n.getPersonDetailsByID(t),s.loadScreenConfigurationAndCustomFieldLabels(a,EntityVO.TYPE_PERSON)]).then(function(){e.person=n.personDetails,e.personSupportGroups=n.personDetails.supportGroups})["finally"](function(){e.state.loadingPersonDetails=!1});var r=n.getPersonAssets(t,!1),l=o.getMetadataByType(EntityVO.TYPE_ASSET);i.all([r,l]).then(function(){e.personAssetList=n.personAssets})["finally"](function(){e.state.loadingPersonAssets=!1});var c=o.getMetadataByTypes(EntityVO.ALL_TYPES),u=n.getOpenTickets(t,0,!0,1,e.restrictPersonProfileResultForNoOfDays);i.all([c,u]).then(function(){e.personOpenTickets=n.personOpenTickets.ticketList,e.personOpenTicketsTotalMatches=n.personOpenTickets.totalMatches})["finally"](function(){e.state.loadingOpenTickets=!1});var m=n.getClosedTickets(t,0,!0,1,e.restrictPersonProfileResultForNoOfDays);i.all([c,m]).then(function(){e.personClosedTickets=n.personClosedTickets.ticketList,e.personClosedTicketsTotalMatches=n.personClosedTickets.totalMatches})["finally"](function(){e.state.loadingClosedTickets=!1}),p&&(n.getOpenServiceBrokerTickets(t,0,e.restrictPersonProfileResultForNoOfDays).then(function(){e.personOpenServiceBrokerTickets=n.personOpenServiceBrokerTickets.ticketList,e.personOpenServiceBrokerTicketsTotalMatches=n.personOpenServiceBrokerTickets.totalMatches})["finally"](function(){e.state.loadingSBEOpenTickets=!1}),n.getClosedServiceBrokerTickets(t,0,e.restrictPersonProfileResultForNoOfDays).then(function(){e.personClosedServiceBrokerTickets=n.personClosedServiceBrokerTickets.ticketList,e.personClosedServiceBrokerTicketsTotalMatches=n.personClosedServiceBrokerTickets.totalMatches})["finally"](function(){e.state.loadingSBEClosedTickets=!1}))}var p=r.isServerApplicationEnabled(EntityVO.TYPE_SBEREQUEST);e.isServiceBrokerEnabled=p,e.restrictPersonProfileResultForNoOfDays=r.restrictPersonProfileResultForNoOfDays,e.getMoreOpenTickets=function(){n.getOpenTickets(n.personDetails.id,n.personOpenTickets.ticketList.length,!0,1,e.restrictPersonProfileResultForNoOfDays)["finally"](function(){e.personOpenTickets=n.personOpenTickets.ticketList,e.personOpenTicketsTotalMatches=n.personOpenTickets.totalMatches})},e.getMoreClosedTickets=function(){n.getClosedTickets(n.personDetails.id,n.personClosedTickets.ticketList.length,!0,1,e.restrictPersonProfileResultForNoOfDays)["finally"](function(){e.personClosedTickets=n.personClosedTickets.ticketList,e.personClosedTicketsTotalMatches=n.personClosedTickets.totalMatches})},e.getMoreOpenServiceBrokerTickets=function(){n.getOpenServiceBrokerTickets(n.personDetails.id,n.personOpenServiceBrokerTickets.ticketList.length,e.restrictPersonProfileResultForNoOfDays)["finally"](function(){e.personOpenServiceBrokerTickets=n.personOpenServiceBrokerTickets.ticketList,e.personOpenServiceBrokerTicketsTotalMatches=n.personOpenServiceBrokerTickets.totalMatches})},e.getMoreClosedServiceBrokerTickets=function(){n.getClosedServiceBrokerTickets(n.personDetails.id,n.personClosedServiceBrokerTickets.ticketList.length,e.restrictPersonProfileResultForNoOfDays)["finally"](function(){e.personClosedServiceBrokerTickets=n.personClosedServiceBrokerTickets.ticketList,e.personClosedServiceBrokerTicketsTotalMatches=n.personClosedServiceBrokerTickets.totalMatches})},e.selectAssetItem=function(t){t.pinned?(e.$emit("assetUnselected",t),t.pinned=!1):(e.$emit("assetSelected",t),t.pinned=!0)},e.showItemDetails=function(t,n){if(!(n&&"href"in n.target)){var i;t.classId?(i={assetId:t.reconciliationId,assetClassId:t.classId},e.pvEnabled?a.go("assetPV",i):a.go("asset",i)):r.isServerApplicationEnabled(t.type)?(i={
id:t.id},a.go(t.type,i)):l.warning({text:c("i18n")("person.preview.notification.disabled.application"),hide:1e4})}},u()}])}(),function(){angular.module("personModule").directive("personPreview",function(){return{restrict:"E",templateUrl:"views/person/preview.html",scope:{personId:"=",displayFullProfile:"=",savedTemplate:"="},controller:"PersonPreviewController"}})}(),function(){angular.module("personModule").controller("PersonProfileController",["$scope","$stateParams",function(e,t){e.personId=t.id,e.state={isPersonDataLoaded:!1,commentable:!1},e.personDataLoaded=function(t){e.state.isPersonDataLoaded=!0,t.accessMappings&&t.accessMappings.timelineEditAllowed?e.state.commentable=!0:e.state.commentable=!1}}])}(),PersonProfileVO.prototype=Object.create(BaseVO.prototype),PersonProfileVO.prototype.constructor=PersonProfileVO,PersonProfileVO.prototype.getProps=function(){return BaseVO.prototype.getProps().concat("firstName","lastName","fullName","department","email","company","phone","thumbnailMime","thumbnail","site","organization","loginId","available","jid","cell","fax","jobTitle","customFields","isSupportStaff","enabled","introduction","linkedIn","twitter","availableForAssignment","deskLocation","manager","costCenter","openTickets","accessMappings","supportGroups","following","type","isVIP","personId")},PersonProfileVO.prototype.getFullName=function(){return this.firstName+" "+this.lastName},PersonProfileVO.prototype.getSiteAddress=function(){var e=this.site&&this.site.address||{};return e.address?e.address:e.street+", "+e.city+", "+e.state+" "+(e.zip?e.zip:"")+", "+e.country},PersonProfileVO.prototype.postBuild=function(){if(_.isEmpty(this.accessMappings))this.accessMappings={detailsEditAllowed:!0,timelineEditAllowed:!0,relationsEditAllowed:!0};else{for(var e={},t=0;t<this.accessMappings.length;t++)e[this.accessMappings[t].id+"EditAllowed"]="write"===this.accessMappings[t].permission;this.accessMappings=e}},function(){angular.module("personModule").service("personService",["$resource","$http",function(e,t){function a(e){return(new PersonProfileVO).build(e)}function n(e){var t=[];return angular.forEach(e,function(e){var a=(new PersonAssetVO).build(e);t.push(a)}),t}function i(e){for(var t=e,a=0;a<t.length;a++)t[a]=o(t[a]),"Resolved"===t[a].status||"Closed"===t[a].status?t[a].closedDate=moment(t[a].modifiedDate).fromNow():t[a].receivedDate=moment(t[a].modifiedDate).calendar({sameElse:"lll"});return _.sortBy(t,"modifiedDate").reverse()}function o(e){return(new TicketSummaryVO).build(e)}function r(e){return{filterCriteria:e,attributeNames:["displayId","type","summary","submitDate","modifiedDate","assignee","status","detailedDescription","priority","templateGuid","templateId","chatSessionId","reportedSource"]}}var s=e("/smartit/rest/person/:id",{},{getPersonDetailsByID:{method:"GET",isArray:!0},getListOfPersonByName:{method:"GET",url:"/smartit/rest/person/search?name=:name&thumbnail=:thumbnail",isArray:!0},getPersonAssets:{method:"GET",isArray:!0,url:"/smartit/rest/asset/:id?allAssets=:showAllAssets"},getTickets:{method:"POST",isArray:!0,url:"/smartit/rest/v2/person/workitems/get"},getServiceBrokerTickets:{method:"POST",isArray:!0,url:"/smartit/rest/sberequest/workitems"},searchPersonInSocialByNameQuery:{method:"GET",isArray:!0,url:"/smartit/rest/v2/profile",params:{type:"user",search_types:"user",fields:"elementId,jid,tenantId,firstName,lastName"}},getServiceSummaryStats:{method:"POST",isArray:!0,url:"/smartit/rest/foundation/stats/get"},updatePersonInfo:{method:"PUT",isArray:!0,url:"/smartit/rest/person/all/:id"},getOrganizationList:{method:"POST",isArray:!0,url:"/smartit/rest/foundation/items?type=organization"},getDepartmentList:{method:"POST",isArray:!0,url:"/smartit/rest/foundation/items?type=department"},getSiteList:{method:"GET",isArray:!0,url:"/smartit/rest/foundation/search/site?searchText=%"},getKnowledgeArticlesList:{method:"GET",isArray:!0,url:"/smartit/rest/knowledge"},createPerson:{method:"POST",isArray:!0,url:"/smartit/rest/person"},getServiceBrokerTicketsMock:{method:"GET",isArray:!0,url:"mocks/user-sberequest-workitems.json"}});this.getPersonDetailsByID=function(e){return s.getPersonDetailsByID({id:e}).$promise.then(function(e){return a(e[0].items[0])})},this.getListOfPersonByName=function(e,t,n){var i;return i=angular.isDefined(n)?{name:e,thumbnail:!0,role:n}:{name:e,thumbnail:!0},s.getListOfPersonByName(i).$promise.then(function(e){if(e[0].items.length){if(t)return e[0].items;var n=e[0].items,i=n.map(function(e){return a(e)});return i}return[]})},this.getListOfPersonNamesByName=function(e){return s.getListOfPersonByName({name:e,thumbnail:!1}).$promise.then(function(e){if(e[0].items.length){var t=e[0].items,n=t.map(function(e){return a(e)});return n}return[]})},this.getPersonAssets=function(e,t){return s.getPersonAssets({id:e,showAllAssets:t}).$promise.then(function(e){return n(e[0].items[0].objects)})},this.getTickets=function(e){var t=r(e.filterCriteria);return t.chunkInfo=e.chunkInfo,e.sortInfo&&(t.sortInfo=e.sortInfo),t.statCount=e.statCount,t.queryMinimalView=e.queryMinimalView,s.getTickets(t).$promise.then(function(e){return{ticketList:i(e[0].items[0].objects),totalMatches:e[0].items[0].totalMatches,exceedsChunkSize:e[0].items[0].exceedsChunkSize}})},this.getServiceBrokerTickets=function(e){var t=r(e.filterCriteria);return t.chunkInfo=e.chunkInfo,e.sortInfo&&(t.sortInfo=e.sortInfo),s.getServiceBrokerTickets(t).$promise.then(function(e){return{ticketList:i(e[0].items[0].objects),totalMatches:e[0].items[0].totalMatches}})},this.getAssignedTickets=function(e){var t=r(e.filterCriteria);return t.chunkInfo=e.chunkInfo,t.sortInfo=e.sortInfo,t.statCount=e.statCount,t.queryMinimalView=e.queryMinimalView,s.getTickets(t).$promise.then(function(e){return{ticketList:i(e[0].items[0].objects),totalMatches:e[0].items[0].totalMatches}})},this.getKnowledgeArticles=function(e){var t={criteria:e};return s.getKnowledgeArticlesList(t).$promise.then(function(e){return e[0].items.length>0?_.map(e[0].items[0].objects,function(e){return(new KnowledgeArticleVO).build(e)}):[]})},this.searchPersonInSocialByNameQuery=function(e){return s.searchPersonInSocialByNameQuery({search_string:e}).$promise.then(function(e){return e[0].items})},this.updatePersonInfo=function(e,t){return s.updatePersonInfo({id:e},t).$promise.then(function(e){return a(e[0].items[0].responseObject)})},this.getOrganizationList=function(e){var t=angular.toJson({companyName:e});return s.getOrganizationList(t).$promise.then(function(e){return e[0].items[0].objects})},this.getDepartmentList=function(e,t){var a=angular.toJson({organizationName:e,companyName:t});return s.getDepartmentList(a).$promise.then(function(e){return e[0].items[0].objects})},this.getSiteList=function(e){var t={companyName:e};return s.getSiteList(t).$promise.then(function(e){return e[0].items[0].objects})},this.getServiceSummaryStats=function(e){var t={filterCriteria:{customer:{loginId:e}},stats:[{name:"service-summary"}]};return s.getServiceSummaryStats(t).$promise.then(function(e){return e[0].items[0].objects})},this.followPerson=function(e,a){return t({method:"POST",headers:{"Content-Type":"application/json"},url:"/smartit/rest/v2/profile/user/"+e+"/following?follow_type=user&following_id="+a})},this.unfollowPerson=function(e,a){return t({method:"DELETE",headers:{"Content-Type":"application/json"},url:"/smartit/rest/v2/profile/user/"+e+"/following?follow_type=user&following_id="+a})},this.createPerson=function(e){return s.createPerson(e).$promise.then(function(e){return e[0].items[0]})}}])}(),function(){angular.module("personModule").directive("previewPerson",["userModel",function(e){return{restrict:"A",templateUrl:"views/person/person-details.html",scope:{displayMenu:"=",editModeAllowed:"&",personDataLoaded:"&",isFullVersion:"=",selectedChat:"=",isPersonProfile:"=?"},controller:"PersonController",link:function(e,t,a){a.$observe("previewPerson",function(t){e.init(t)}),e.editModeAllowed=!!a.editModeAllowed}}}])}(),TicketSummaryVO.prototype=Object.create(BaseVO.prototype),TicketSummaryVO.prototype.constructor=TicketSummaryVO,TicketSummaryVO.prototype.getProps=function(){return BaseVO.prototype.getProps().concat("displayId","summary","type","status","submitDate","modifiedDate","assignee","isAutomatic","categorizations","detailedDescription","priority","templateGuid","templateId","chatSessionId","reportedSource","relRequestId","relDwpcRequestId")},TicketSummaryVO.prototype.postBuild=function(){"change"!==this.type&&"task"!==this.type||(this.subType=this.isAutomatic?"-auto":"")},function(){angular.module("createProblemModule").controller("CreateProblemController",["$scope","$modal","$state","userModel","$filter","searchModel","events","createTicketModel","screenConfigurationModel","ticketModel","i18nService","systemAlertService","categoriesService","$q","metadataModel","ticketActionService","fieldValidationModel","configurationModel","$timeout",function(e,t,a,n,i,o,r,s,l,c,d,u,p,m,f,g,h,y,E){function v(){e.state={dataIsLoading:!0,tooManyCompanies:!1,assigneeLoading:!0,initialLoading:!0},e.selections={},e.siteOptions={company:{visible:!1,attribute:"companyName"},region:{attribute:"region"},siteGroup:{attribute:"siteGroup"},site:{attribute:"name"}},e.formContainsInvalidFields=s.formContainsInvalidFields,s.currentTicket=R,e.problem=R,e.problem.autoAssign=!0,e.problem.coordinatorAutoAssign=!0,e.problemMetadata=P,e.loggedInUserId=n.decodedUserId||n.userId,e.company={},n.userFullData.availableForAssignment?e.availableForAssignment=n.userFullData.availableForAssignment:n.getFullCurrentUserData().then(function(){e.availableForAssignment=n.userFullData.availableForAssignment}),I();var t=f.getMetadataByType(EntityVO.TYPE_PROBLEM),a=c.getDraft(EntityVO.TYPE_PROBLEM);m.all([t,a]).then(function(t){var a=t[1];angular.extend(P,t[0]),_.includes(P&&P.requiredOOTBObjectName,"desc")?(e.isDescRequired=!0,e.isNew=!0):e.isDescRequired=!1,P.statuses=_.reject(P.statuses,{isValidForCreate:!1}),R.selectedStatus=_.head(P.statuses),e.updateStatusReason(),R.selectedImpact=_.last(P.impacts),R.selectedUrgency=_.last(P.urgencies),R.investigationDriver=_.head(P.investigationDrivers),R.id=a.id,R.displayId=a.displayId,R.categorizations=a.categorizations,R.accessMappings=a.accessMappings,R.company=a.company,R.supportGroup=a.supportGroup?a.supportGroup:{},R.coordinatorGroup=a.coordinatorGroup?a.coordinatorGroup:{},R.type=a.type,R.location=a.location?a.location:{},R.location.companyName=a.company.name,a.status&&a.status.value&&(R.selectedStatus=_.head(_.filter(P.statuses,{name:a.status.value})),e.updateStatusReason()),a.coordinator?(R.coordinator=a.coordinator,e.problem.coordinatorAutoAssign=!1):R.coordinator={},a.assignee?(R.assignee=a.assignee,e.problem.autoAssign=!1):R.assignee={},e.state.assigneeLoading=!1,D(null,a.categorizations)})["finally"](function(){e.state.dataIsLoading=!1,e.state.initialLoading=!1});var i=l.loadScreenConfigurationAndCustomFieldLabels(ScreenConfigurationVO.prototype.PROBLEM_DETAILS_SCREEN,EntityVO.TYPE_PROBLEM),r=n.getFullCurrentUserData().then(function(){e.setCompany(n.userFullData)}),d=o.getOperatingCompanies(null,-1).then(function(t){e.selections.companies=_.cloneDeep(t.companies),e.state.tooManyCompanies=t.exceedsChunkSize});m.all([t,a,r,i,d]).then(function(){R.allCategories=_.cloneDeep(p.populateCategories(R.categorizations,P));var t=l.getEditableFieldsForScreen(ScreenConfigurationVO.prototype.PROBLEM_DETAILS_SCREEN);e.customFields=angular.copy(t)})}function T(){var e=u.modal({type:"info",title:i("i18n")("common.notification.dirty.title"),text:i("i18n")("create.problem.companyChange.warning"),buttons:[{text:i("i18n")("common.button.yes"),data:!0},{text:i("i18n")("common.button.no"),data:!1}]});return e.result}function S(e,t){R.ghostEntity=!0,g.showAssignDialog(R,!0,t).result.then(function(t){O(t),e.currentTarget.focus()},function(){e.currentTarget.focus()})}function C(e,t){var a={};"problemcoordinator"===t?(a.manager={id:e.id,loginId:e.loginId,fullName:e.fullName,thumbnail:e.thumbnail,thumbnailMime:e.thumbnailMime},a.managerGroup={id:e.supportGroupId,name:e.supportGroup,organization:e.organization,company:e.company}):(a.assignee={id:e.id,loginId:e.loginId,fullName:e.fullName,thumbnail:e.thumbnail,thumbnailMime:e.thumbnailMime},a.group={id:e.supportGroupId,name:e.supportGroup,organization:e.organization,company:e.company}),O(a)}function O(e){e.autoAssign?b():e.group&&(R.autoAssign=!1,R.assignee=e.assignee,R.supportGroup=e.group),e.coordinatorAutoAssign?k():e.managerGroup&&(R.coordinatorAutoAssign=!1,R.coordinator=e.manager,R.coordinatorGroup=e.managerGroup)}function A(){return e.createProblemForm.$dirty||!_.isEmpty(R.attachments)}function I(){e.$on("$stateChangeStart",function(t,n,i){if(A()&&n.name!==EntityVO.TYPE_PROBLEM){t.preventDefault();var o=u.modal({title:d.getLocalizedString("common.notification.dirty.title"),text:d.getLocalizedString("common.notification.dirty.message"),buttons:[{text:d.getLocalizedString("common.labels.yes"),data:{stateName:n.name,stateParams:i}},{text:d.getLocalizedString("common.labels.no")}]});o.result.then(function(t){_.isEmpty(t)||(s.currentTicket=R={},e.createProblemForm.$setPristine(),a.transitionTo(t.stateName,t.stateParams))})}})}function b(){R.autoAssign=!0,R.assignee={},R.supportGroup={}}function k(){R.coordinatorAutoAssign=!0,R.coordinator={},R.coordinatorGroup={}}function D(t,a){var n={};n.depends=p.buildCategoriesForRootCause(a,R.allCategories),n.depends.productManufacturer=null;var i=e.company&&e.company.name?{name:e.company.name}:null;c.getRootCause(n,i).then(function(t){t&&(e.selections.rootCause=t)})}if(!y.isServerApplicationEnabled(EntityVO.TYPE_PROBLEM))return void a.go("unauthorized");e.currentDate=new Date;var R={type:EntityVO.TYPE_PROBLEM,autoAssign:!0,coordinatorAutoAssign:!0,customFields:{}};e.datePickerOptions={startingDay:y.getWeekStartingDay(),"show-weeks":!1,minDate:moment().year(1970).month(0).date(2),maxDate:moment().year(2038).month(0).date(18)};var P={};e.getList=function(t,a){return"service"===t||"asset"===t?s.getList(t,a,EntityVO.TYPE_PROBLEM).then(function(a){return"service"===t?(e.exceedsChunkSizeService=a.exceedsChunkSize,e.isTooltipOpenService=!0):"asset"===t&&(e.exceedsChunkSizeAsset=a.exceedsChunkSize,e.isTooltipOpenAsset=!0),E(function(){e.isTooltipOpenService=!1,e.isTooltipOpenAsset=!1},1e4),a.objects}):s.getList(t,a)},e.onInputFocusBlur=function(){e.isTooltipOpenService=!1,e.isTooltipOpenAsset=!1},e.setCompany=function(t){e.problem.company=t.company,e.problem.location={},e.problem.location.companyName=e.problem.company.name,e.company=_.cloneDeep(e.problem.company)},e.updateCompany=function(t){var a=t;T().then(function(t){t?(e.problem.company=a,e.$broadcast(r.CLEAR_FOUNDATION_SERVICE,e.problem.company),e.$broadcast(r.CLEAR_CATEGORY_DETAILS,e.problem.company),e.problem.location.companyName=e.problem.company.name,R.selectedService="",R.selectedAsset="",e.problem.coordinatorAutoAssign||(R.coordinator={}),e.problem.autoAssign||(R.assignee={})):e.company=e.problem.company})},e.getCompaniesByName=function(e){return o.getCompaniesByText(e).then(function(e){return{list:e.companies,exceedsChunkSize:e.exceedsChunkSize}})},e.$watch("problem.selectedService",function(){R&&_.isObject(R.selectedService)&&(R.impactedService=R.selectedService,e.$emit(r.AFFECTED_SERVICE_UPDATED,R.selectedService))}),e.$watch("problem.company",function(){e.updatePriority()}),e.updatePriority=function(){R.company&&R.selectedImpact&&R.selectedUrgency&&c.getPriority(R.company.name,R.selectedImpact.name,R.selectedUrgency.name,EntityVO.TYPE_PROBLEM).then(function(e){R.calculatedPriority=_.find(P.priorities,{name:e}),R.calculatedPriority||u.error({text:i("i18n")("ticket.calculationError.calculatedPriority"),clear:!1})})},e.clearSelectedService=function(){R.selectedService=""},e.clearSelectedAsset=function(){R.selectedAsset=""},e.assign=function(e){S(e)},e.assignToMe=function(e,t){var a=t,n=R.supportGroup;"ticketassignee"===t?a="":"problemcoordinator"===t&&(n=R.coordinatorGroup);var i,o=null,r=R.company;r=r?r.name:"",i=R.customer&&R.customer.company?R.customer.company.name:R.company?R.company.name:"",o=R.locationCompany?R.locationCompany.name:null,c.getTicketAssigneePersonsBySearchText(a,i,o,null,r,null).then(function(i){i=_.uniqBy(i.results,function(e){return e.loginId&&e.supportGroupId});var o=1===i.length?i[0]:_.find(i,{supportGroupId:n.id});o&&o.loginId?C(o,a):S(e,t)})},e.createProblem=function(){e.state.dataIsLoading=!0,R.summary=R.summary.replace(/\u00a0/g," ");var t=_.cloneDeep(R.categorizations);R.categorizations=p.collectValues(R.allCategories,e.problem).categorizations,s.createProblem().then(function(a){a&&(e.state.dataIsLoading=!1,R.categorizations=_.cloneDeep(t),u.error({text:a,clear:!0}))})},e.cancel=function(){a.go("dashboard")},e.needResolutionNote=function(){return~[EntityVO.STATUS_CLOSED,EntityVO.STATUS_RESOLVED].indexOf(R.selectedStatus.name.toLowerCase())},e.isFieldRequired=function(t){var a=e.problem.selectedStatus?e.problem.selectedStatus.name:"";return h.isFieldRequired(EntityVO.TYPE_PROBLEM,a,"",t)},e.updateStatusReason=function(){!_.isEmpty(R.selectedStatus.statusReasons)&&e.isFieldRequired("statusReason")?R.selectedStatusReason=_.head(R.selectedStatus.statusReasons):R.selectedStatusReason={}},e.$on(r.TICKET_UPDATE_ROOTCAUSE,D),v()}])}(),function(){angular.module("ticketModule").directive("problemDetailsEditor",["events","userModel","systemAlertService","$filter","screenConfigurationModel","ticketModel","categoriesService","searchModel",function(e,t,a,n,i,o,r,s){return{restrict:"E",replace:!0,templateUrl:"views/problem/problem-details-editor.html",scope:{ticket:"=",metadata:"=",form:"=",updateIsHandledByParent:"="},link:function(t){function l(){var e=a.modal({type:"info",title:n("i18n")("common.notification.dirty.title"),text:n("i18n")("edit.problem.companyChange.warning"),buttons:[{text:n("i18n")("common.button.yes"),data:!0},{text:n("i18n")("common.button.no"),data:!1}]});return e.result}function c(){t.editMode=!0,d()}function d(){t.isDescRequired=_.includes(t.metadata&&t.metadata.requiredOOTBObjectName,"desc"),t.updatedInfo={location:t.ticket.location?t.ticket.location:{},company:t.ticket.company,workaround:t.ticket.workaround,resolution:t.ticket.resolution,rootCause:t.ticket.rootCause?{name:t.ticket.rootCause}:null,investigationDriver:t.ticket.investigationDriver?_.find(t.metadata.investigationDrivers,function(e){return e.name===t.ticket.investigationDriver})||{name:t.ticket.investigationDriver}:""},t.updatedInfo.location.companyName=t.updatedInfo.company.name}function u(){var a=p(),n=!t.updateIsHandledByParent;t.$emit(e.SAVE_CHANGES_REQUEST,a,n||t.ticket.isDraft)}function p(){var e={};return t.updatedInfo.company.name!==t.ticket.company.name&&(e.company=t.updatedInfo.company.name),t.updatedInfo.investigationDriver.name!==t.ticket.investigationDriver&&(e.investigationDriver=t.updatedInfo.investigationDriver.name),t.updatedInfo.location!==t.ticket.location&&(e.location=t.updatedInfo.location),t.updatedInfo.workaround!==t.ticket.workaround&&(e.workaround=t.updatedInfo.workaround),t.updatedInfo.resolution!==t.ticket.resolution&&(e.resolution=t.updatedInfo.resolution),e.rootCause=t.updatedInfo.rootCause?t.updatedInfo.rootCause.name:"",e}function m(){t.editMode=!1}function f(){t.ticket=_.cloneDeep(t.originalTicket),m()}function g(a,n){_.isEmpty(n)||(t.ticket.company=n.company?n.company:t.ticket.company,t.ticket.investigationDriver=n.investigationDriver?n.investigationDriver:t.ticket.investigationDriver,t.ticket.location=n.location?n.location:t.ticket.location,t.ticket.workaround=n.workaround?n.workaround:"",t.ticket.resolution=n.resolution?n.resolution:"",t.ticket.rootCause=n.rootCause?n.rootCause:""),t.ticket.isDraft&&(h(),t.$emit(e.SAVE_CHANGES_COMPLETE)),m()}function h(){t.ticket.company=t.updatedInfo.company.name!==t.ticket.company.name?t.updatedInfo.company.name:t.ticket.company,t.ticket.investigationDriver=t.updatedInfo.investigationDriver.name!==t.ticket.investigationDriver?t.updatedInfo.investigationDriver.name:t.ticket.investigationDriver,t.ticket.location=t.updatedInfo.location!==t.ticket.location?t.updatedInfo.location:t.ticket.location,t.ticket.rootCause=t.updatedInfo.rootCause?t.updatedInfo.rootCause.name:"",t.ticket.workaround=t.updatedInfo.workaround!==t.ticket.workaround?t.updatedInfo.workaround:t.ticket.workaround,t.ticket.resolution=t.updatedInfo.resolution!==t.ticket.resolution?t.updatedInfo.resolution:t.ticket.resolution}function y(){t.$broadcast(e.SAVE_CHANGES_COMPLETE),m()}function E(e,a){var n={};n.depends=r.buildCategoriesForRootCause(a,t.metadata.allCategories),n.depends.productManufacturer=null,o.getRootCause(n,t.ticket.company).then(function(e){e&&(t.selections.rootCause=e)})}t.state={tooManyCompanies:!1},t.siteOptions={company:{visible:!1,attribute:"companyName"},region:{attribute:"region"},siteGroup:{attribute:"siteGroup"},site:{attribute:"name"}},t.selections={investigationDrivers:t.metadata.investigationDrivers,companies:[],rootCause:[]},t.originalTicket=_.cloneDeep(t.ticket),t.getCompaniesByName=function(e){return s.getCompaniesByText(e).then(function(e){return{list:e.companies,exceedsChunkSize:e.exceedsChunkSize}})},s.getOperatingCompanies(null,-1).then(function(e){t.selections.companies=_.cloneDeep(e.companies),t.state.tooManyCompanies=e.exceedsChunkSize}),t.updatedInfo={location:t.ticket.location?t.ticket.location:{}},t.updatedInfo.location.companyName=t.ticket.company.name,E(null,t.ticket.categorizations),t.updateCompany=function(){l().then(function(a){a?(t.$broadcast(e.CLEAR_AFFECTED_SERVICE,t.updatedInfo.company),t.$broadcast(e.CLEAR_CATEGORY_DETAILS,t.updatedInfo.company),t.$broadcast(e.CLEAR_FOUNDATION_SERVICE,t.updatedInfo.company),t.updatedInfo.rootCause={name:""}):t.updatedInfo.company=t.ticket.company})},t.buildSiteTag=function(e){var t=e.siteGroup?" > "+e.siteGroup:"",a=e.name?" > "+e.name:"",n=e.region?e.region:"";return n+t+a},t.clear=function(e){t.updatedInfo[e]=null},t.hasCustomFields=function(e){var t=i.getPanelById(e);return t&&t.hasCustomFields()},d(),t.$on(e.TICKET_UPDATE_ROOTCAUSE,E),t.$on(e.SAVE_CHANGES,u),t.$on(e.TOGGLE_EDIT_MODE,c),t.$on(e.SAVE_ALL_CHANGES_COMPLETE,g),t.$on(e.SAVE_ALL_CHANGES_FAULT,y),t.$on(e.DISCARD_CHANGES,f)}}}])}(),function(){angular.module("releaseModule").directive("activityDetailsEditor",["events","createTicketService","fieldValidationModel","systemAlertService","i18nService",function(e,t,a,n,i){return{restrict:"E",replace:!0,templateUrl:"views/release/activity-details-editor.html",scope:{ticket:"=",metadata:"=",form:"="},link:function(o){function r(){o.editMode=!0,o.ticketCopy=_.cloneDeep(o.ticket),o.updatedInfo={customer:o.ticket.customer,company:o.ticket.company,location:o.ticket.location,priority:_.find(o.metadata.priorities,function(e){return e.name===o.ticket.priority})},o.updatedInfo.location.companyName=o.updatedInfo.company.name,o.updatedInfo.location.region=o.ticket.location.region}function s(){var t=l();o.$emit(e.SAVE_CHANGES_REQUEST,t)}function l(){var e={};return o.updatedInfo.priority.name!==o.ticket.priority&&(e.priority=o.updatedInfo.priority.name),o.updatedInfo.location!==o.ticket.location&&(e.location=o.updatedInfo.location),e}function c(){o.editMode=!1,o.updatedInfo={}}function d(e,t){_.isEmpty(t)||(o.ticket.changeReason=t.changeReason,o.ticket.customer=t.customer,o.ticket.location=t.location,o.ticket.priority=t.priority,o.ticket.parentGuid=o.ticketCopy.parentGuid),o.isDatesRequired()&&(o.ticket.scheduledStartDate=o.ticketCopy.scheduledStartDate,o.ticket.scheduledEndDate=o.ticketCopy.scheduledEndDate,o.ticket.actualStartDate=o.ticketCopy.actualStartDate,o.ticket.actualEndDate=o.ticketCopy.actualEndDate),c()}function u(){o.$broadcast(e.SAVE_CHANGES_COMPLETE),c()}o.ticketCopy=_.cloneDeep(o.ticket),o.siteOptions={company:{visible:!1,attribute:"companyName"},region:{attribute:"region"},siteGroup:{attribute:"siteGroup"},site:{attribute:"name"}},o.clear=function(e){o.updatedInfo[e]=null},o.getListPersons=function(e,a){return o.searchingPersons=!0,t.getListOfPersonsByCompany(e,a).then(function(e){return o.searchingPersons=!1,e[0].items})},o.buildSiteTag=function(e){var t=e.siteGroup?" > "+e.siteGroup:"",a=e.name?" > "+e.name:"",n=e.region?e.region:"";return n+t+a},o.validateRequestedFor=function(){o.updatedInfo.customer.id||(o.updatedInfo.customer=""),o.searchingPersons=!1},o.setChangeLocation=function(){return n.modal({title:i.getLocalizedString("create.release.setRequestedForLocation.title"),text:i.getLocalizedString("create.release.setRequestedForLocation.text"),buttons:[{text:i.getLocalizedString("common.button.yes"),data:!0},{text:i.getLocalizedString("common.button.no"),data:!1}]}).result.then(function(e){if(e){var t=o.updatedInfo.customer.site;t.company=o.ticket.company.name,o.updatedInfo.location=t}})},o.isDatesRequired=function(){return(a.isFieldRequired(o.ticket.type,o.ticket.status.value,"scheduledStartDate")||a.isFieldRequired(o.ticket.type,o.ticket.status.value,"actualStartDate"))&&(o.ticket.accessMappings.actualdateEditAllowed||o.ticket.accessMappings.scheduleddateEditAllowed)},o.$on(e.SAVE_CHANGES,s),o.$on(e.TOGGLE_EDIT_MODE,r),o.$on(e.SAVE_ALL_CHANGES_COMPLETE,d),o.$on(e.SAVE_ALL_CHANGES_FAULT,u),o.$on(e.DISCARD_CHANGES,c)}}}])}(),function(){angular.module("releaseModule").controller("CreateReleaseController",["$scope","$rootScope","$state","$q","$http","$modal","$timeout","releaseTabIds","userModel","searchModel","metadataModel","ticketModel","createTicketModel","ticketActionService","categoriesService","editTicketDatesService","ticketTemplateModel","ticketService","systemAlertService","events","localStorageService","i18nService","configurationModel","$filter","feedModel","utilityFunctions",function(e,t,a,n,i,o,r,s,l,c,d,u,p,m,f,g,h,y,E,v,T,S,C,O,A,I){function b(t){if(e.releasePlanMilestoneDirty){var a=k();a.result.then(function(e){t(e?!0:!1)})}else t(!0)}function k(){var e=E.modal({title:S.getLocalizedString("common.notification.dirty.title"),text:S.getLocalizedString("common.notification.dirty.message"),buttons:[{text:S.getLocalizedString("common.labels.yes"),data:!0},{text:S.getLocalizedString("common.labels.no")}]});return e}function D(t){e.lastUsedTemplates.unshift(t),e.lastUsedTemplates=_.uniqBy(e.lastUsedTemplates,function(e){return e.id}).splice(0,50),T.set("release.lastUsedTemplates",e.lastUsedTemplates)}function R(t){e.state.lastUsedTemplatesLoading=!0,e.currentRecentlyUsedTemplates=[];var a=_.filter(e.lastUsedTemplates,{forCompany:t});a.length?u.getRecentlyUsedReleaseTemplates(a,e.releaseMetadata).then(function(t){e.state.lastUsedTemplatesLoading=!1,t&&(e.currentRecentlyUsedTemplates=P(t))})["catch"](function(){e.state.lastUsedTemplatesLoading=!1}):e.state.lastUsedTemplatesLoading=!1}function P(e){var t=["riskLevel","impact","urgency","releaseType","impactedService"];return _.forEach(e,function(e){_.forEach(t,function(t){_.isUndefined(e.templateObject[t])||(e[t]=e.templateObject[t])})}),e}function w(t,a){var n={supportGroup:e.draftTicket.coordinatorGroup,assignee:e.draftTicket.coordinator,locationCompany:e.draftTicket.company,type:EntityVO.TYPE_RELEASE};m.showAssignDialog(n,!0,a).result.then(function(e){N(e),t.currentTarget.focus()},function(){t.currentTarget.focus()})}function L(e){var t={};t.assignee={id:e.id,loginId:e.loginId,fullName:e.fullName,thumbnailMime:e.thumbnailMime,thumbnail:e.thumbnail},t.group={id:e.supportGroupId,name:e.supportGroup,organization:e.organization,company:e.company},N(t)}function N(t){t.autoAssign?(e.draftTicket.autoAssignAssignee=!0,e.draftTicket.coordinator={},e.draftTicket.coordinatorGroup={}):(e.draftTicket.autoAssignAssignee=!1,t.assignee&&(e.draftTicket.coordinator=t.assignee),t.group&&(e.draftTicket.coordinatorGroup=t.group))}function M(){r(function(){e.$broadcast(v.REFRESH_RELEASE_PLAN_LIST)},1e3)}function V(e){return y.getDraft(EntityVO.TYPE_RELEASE,e)}function F(){return e.draftTicket.company.name===l.userFullData.company.name?l.userFullData.company.site:{}}function x(t,a){a&&t.company&&t.company.name===e.draftTicket.company.name&&!_.isEmpty(t.location)||(t.location=F()),t.company=e.draftTicket.company,e.draftTicket=angular.extend(e.draftTicket,t),p.currentTicket=e.draftTicket,e.draftTicket.impact=e.draftTicket.impact?_.head(_.filter(e.releaseMetadata.impacts,{name:e.draftTicket.impact})):_.last(e.releaseMetadata.impacts),e.draftTicket.urgency=e.draftTicket.urgency?_.head(_.filter(e.releaseMetadata.urgencies,{name:e.draftTicket.urgency})):_.last(e.releaseMetadata.urgencies),G(),e.draftTicket.businessJustification=e.draftTicket.businessJustification?_.head(_.filter(e.releaseMetadata.businessJustifications,{name:e.draftTicket.businessJustification})):_.includes(e.releaseMetadata&&e.releaseMetadata.requiredOOTBObjectName,"businessJustification")?_.head(e.releaseMetadata.businessJustifications):null,e.draftTicket.releaseType=e.draftTicket.releaseType?_.head(_.filter(e.releaseMetadata.types,{name:e.draftTicket.releaseType})):null,e.draftTicket.location&&(e.draftTicket.location.companyName=e.draftTicket.company.name),e.draftTicket.riskLevel?(e.draftTicket.riskLevel=_.head(_.filter(e.releaseMetadata.riskLevels,{name:e.draftTicket.riskLevel})),e.draftTicket.riskLevelSelectionMode="manual"):(e.draftTicket.riskLevelSelectionMode="auto",e.calculateRisk(e.draftTicket.riskLevelSelectionMode)),e.draftTicket.allCategories=_.cloneDeep(f.populateCategories(e.draftTicket.categorizations,e.releaseMetadata))}function G(){if(e.draftTicket.priority)e.draftTicket.priority=_.head(_.filter(e.releaseMetadata.priorities,{name:e.draftTicket.priority}));else{var t=_.last(e.releaseMetadata.impacts),a=_.last(e.releaseMetadata.urgencies);e.draftTicket.impact===t&&e.draftTicket.urgency===a?e.draftTicket.priority=_.last(e.releaseMetadata.priorities):e.draftTicket.priority={}}}function $(){a.go("createRelease.wizard")}function B(){e.selectedMainTab=e.tabIds.main.template,e.state.selectedWizardTab=e.tabIds.wizard.basics,e.datePickerOptions={startingDay:C.getWeekStartingDay(),"show-weeks":!1,minDate:moment().year(1970).month(0).date(2),maxDate:moment().year(2038).month(0).date(18)},e.template={search:"",list:[],selected:{},showSearchResults:!1,preview:null},e.draftTicket={type:EntityVO.TYPE_RELEASE,scheduledStartDatePicker:{open:!1},scheduledEndDatePicker:{open:!1},deploymentStartDatePicker:{open:!1},deploymentEndDatePicker:{open:!1}},e.draftCreated=!1,e.showRecentTemplates=!1,e.setCompany(l.userFullData.company),a.go("createRelease.selector")}function U(e){return A.processPendingWorkNote(e)||n.when(1)}function z(){e.state={dataIsLoading:!0,templatesLoading:!1,tooManyCompanies:!1,savingRelease:!1,lastUsedTemplatesLoading:!0};var t=T.get("release.lastUsedTemplates");e.lastUsedTemplates=t?t:[],e.releaseMetadata={};var a=d.getMetadataByType(EntityVO.TYPE_RELEASE).then(function(t){angular.extend(e.releaseMetadata,t),(!e.releaseMetadata.documentTypes||e.releaseMetadata.documentTypes&&0===e.releaseMetadata.documentTypes.length)&&i.get("mocks/change-request-metadata-document-types.json").then(function(t){e.releaseMetadata.documentTypes=t.documentTypes})}),o=l.getFullCurrentUserData().then(function(){e.loggedInUserId=l.decodedUserId||l.userId,e.availableForAssignment=l.userFullData.availableForAssignment,c.getOperatingCompanies(null,-1).then(function(t){e.selections.companies=_.cloneDeep(t.companies),e.state.tooManyCompanies=t.exceedsChunkSize})});n.all([a,o]).then(function(){e.state.dataIsLoading=!1,B()})}a.go("createRelease.selector"),e.tabIds=s,e.draftTicket={type:EntityVO.TYPE_RELEASE},e.selections={companies:[]},e.siteOptions={company:{visible:!1,attribute:"companyName"},region:{attribute:"region"},siteGroup:{attribute:"siteGroup"},site:{attribute:"name"}},e.validator=g,e.releasePlanMilestoneDirty=!1,e.createDraftRelease=function(){e.state.dataIsLoading=!0,e.draftCreated=!1,e.isNew=!0;var t=null;e.selectedMainTab!==e.tabIds.main.scratch&&(t=e.template.selected.id),V(t).then(function(a){e.state.dataIsLoading=!1;
var n=!_.isEmpty(t);x(a,n),e.template.selected.forCompany=e.draftTicket.company.name,e.template.selected&&e.template.selected.id&&D(e.template.selected),e.draftCreated=!0,$()})["catch"](function(t){e.state.dataIsLoading=!1,t=t.data.detailedMessage||t.data.error||t,E.error({text:t,clear:!0})})},e.setCompany=function(t){e.draftTicket.company=t,e.showRecentTemplates=!0,R(t.name)},e.selectMainTab=function(t){e.selectedMainTab=t},e.releaseWizardValid=function(){return 0===e.invalidFormCount()},e.invalidFormCount=function(){var t=0;return _.forOwn(e.tabIds.wizard,function(a,n){e.formValid(n)||t++}),t},e.isValidSummary=function(){return!!(e.draftTicket.summary&&e.draftTicket.summary.length>0)},e.formValid=function(t){return!e[t]||!e[t].$invalid},e.formDirty=function(t){return!!e[t]&&e[t].$dirty},e.dirtyFormCount=function(){var t=0;for(var a in e.tabIds.wizard)e.formDirty(a)&&t++;return t},e.releaseWizardDirty=function(){return 0!==e.dirtyFormCount()||!_.isEmpty(e.draftTicket.documents)},e.$on(v.RELEASE_WIZARD_FORM_STATE,function(t,a){e[a.name]=e[a.name]||{},"undefined"!=typeof a.invalid&&(e[a.name].$invalid=a.invalid),"undefined"!=typeof a.dirty&&(e[a.name].$dirty=a.dirty)}),e.clear=function(){if(e.releaseWizardDirty()){var t=k();t.result.then(function(e){e&&B()})}else B()},e.clearTemplateSearch=function(){e.template={search:"",list:[],selected:{},showSearchResults:!1,preview:null}},e.openDatePicker=function(e,t){e.open=!0,t.stopPropagation()},e.updatePriority=function(){e.state.dataIsLoading=!0,u.getReleasePriority(e.draftTicket.company.name,e.draftTicket.impact.name,e.draftTicket.urgency.name).then(function(t){e.draftTicket.priority=_.find(e.releaseMetadata.priorities,{name:t}),e.draftTicket.priority||E.error({text:O("i18n")("create.change.wizard.basicDetails.priority.warning"),hide:1e4}),e.state.dataIsLoading=!1})},e.nextStep=function(){var t=!1;_.forOwn(e.tabIds.wizard,function(a,n){return t?(t=!1,void(e.state.selectedWizardTab=n)):void(a===e.state.selectedWizardTab&&(t=!0))})},e.isDocumentTab=function(){return e.state.selectedWizardTab===e.tabIds.wizard.documents},e.getTemplateList=function(t){return h.getReleaseTemplateList(t,e.draftTicket.company.name,e.releaseMetadata).then(function(t){return e.state.exceedsChunkSizeTemplates=t.exceedsChunkSize,e.state.isTooltipOpenTemplates=t.exceedsChunkSize,r(function(){e.state.isTooltipOpenTemplates=!1},1e4),_.uniqBy(_.map(t.items,"name"))})},e.getRecommendedTemplates=function(){_.isEmpty(e.template.search)||(e.state.templatesLoading=!0,h.getReleaseTemplateList(e.template.search,e.draftTicket.company.name,e.releaseMetadata).then(function(t){e.template.list=t.items})["finally"](function(){e.state.templatesLoading=!1,e.template.showSearchResults=!0}))},e.getList=function(t,a){return p.getList(t,a).then(function(a){return"service"===t&&(e.state.exceedsChunkSizeService=a.exceedsChunkSize),e.state.isTooltipOpenService=e.state.exceedsChunkSizeService,r(function(){e.state.isTooltipOpenService=!1},1e4),a.objects})},e.onInputFocusBlur=function(){e.state.isTooltipOpenService=!1,e.state.isTooltipOpenTemplates=!1},e.getCompaniesByName=function(e){return c.getCompaniesByText(e).then(function(e){return{list:e.companies,exceedsChunkSize:e.exceedsChunkSize}})},e.createBlankActivity=function(){function t(){u.activityParent=e.draftTicket;var t=o.open({templateUrl:"views/create/create-activity.html",controller:"CreateActivityController",windowClass:"ticket__open-modal",backdrop:!1,keyboard:!1});t.result.then(function(){M(),p.currentTicket=e.draftTicket})}b(function(e){e&&t()})},e.browseActivityTemplate=function(){function t(){u.activityParent=e.draftTicket;var t=o.open({templateUrl:"views/template/browse-ticket-template-action-blade.html",windowClass:"action-blade",controller:"BrowseTicketTemplateController",resolve:{ticketType:function(){return EntityVO.TYPE_ACTIVITY},metadata:function(){return{}},company:function(){return e.draftTicket.company}}});t.result.then(function(){M()})}b(function(e){e&&t()})},e.createRelease=function(){b(function(i){i&&(e.state.savingRelease=!0,e.draftTicket.summary=e.draftTicket.summary.replace(/\u00a0/g," "),e.draftTicket.categorizations=f.collectValues(e.draftTicket.allCategories,e.draftTicket,null,!0).categorizations,t.timezone&&(e.draftTicket.scheduledStartDate=e.draftTicket.scheduledStartDate?I.convertToUserPreferenceTimezone(e.draftTicket.scheduledStartDate,t.timezone):e.draftTicket.scheduledStartDate,e.draftTicket.scheduledEndDate=e.draftTicket.scheduledEndDate?I.convertToUserPreferenceTimezone(e.draftTicket.scheduledEndDate,t.timezone):e.draftTicket.scheduledEndDate,e.draftTicket.deploymentStartDate=e.draftTicket.deploymentStartDate?I.convertToUserPreferenceTimezone(e.draftTicket.deploymentStartDate,t.timezone):e.draftTicket.deploymentStartDate,e.draftTicket.deploymentEndDate=e.draftTicket.deploymentEndDate?I.convertToUserPreferenceTimezone(e.draftTicket.deploymentEndDate,t.timezone):e.draftTicket.deploymentEndDate),e.$broadcast(v.SAVE_TICKET_DRAFT),p.createRelease().then(function(t){n.all(p.saveDocuments(p.currentTicket))["finally"](function(){t.type=EntityVO.TYPE_RELEASE,U(t)["finally"](function(){e.state.savingRelease=!1,a.go(EntityVO.TYPE_RELEASE,{id:t.id})})})})["catch"](function(t){e.state.savingRelease=!1,t=t.data.detailedMessage||t.data.error||t,E.error({text:t,clear:!0})}))})},e.assign=function(t){var a={supportGroup:e.draftTicket.coordinatorGroup,assignee:e.draftTicket.coordinator,company:e.draftTicket.company,locationCompany:e.draftTicket.company,type:EntityVO.TYPE_RELEASE};m.showAssignDialog(a,!0).result.then(function(a){a.autoAssign?(e.draftTicket.autoAssignAssignee=!0,e.draftTicket.coordinator={},e.draftTicket.coordinatorGroup={}):(e.draftTicket.autoAssignAssignee=!1,a.assignee&&(e.draftTicket.coordinator=a.assignee),a.group&&(e.draftTicket.coordinatorGroup=a.group)),e[s.wizard.basics].$dirty=!0,t.currentTarget.focus()},function(){t.currentTarget.focus()})},e.assignToMe=function(t,a){var n,i=a,o=e.draftTicket.coordinatorGroup,r=null,s=e.draftTicket.company;s=s?s.name:"",n=e.draftTicket.customer&&e.draftTicket.customer.company?e.draftTicket.customer.company.name:e.draftTicket.company?e.draftTicket.company.name:"",r=e.draftTicket.location&&e.draftTicket.location.companyName?e.draftTicket.location.companyName:null,u.getTicketAssigneePersonsBySearchText(i,n,r,null,s,null).then(function(e){e=_.uniqBy(e.results,function(e){return e.loginId&&e.supportGroupId});var n=1===e.length?e[0]:_.find(e,{supportGroupId:o.id});n&&n.loginId?L(n):w(t,a)})},e.calculateRisk=function(t){"auto"===t?y.getReleaseRisk(e.draftTicket.id).then(function(t){null===t.riskLevel&&(e.draftTicket.isCalculateRiskNull=!0);var a=_.findIndex(e.releaseMetadata.riskLevels,{name:t.riskLevel});a!==-1?(e.draftTicket.titleRiskLevelCls="risk-level-"+(a+1),e.draftTicket.riskLevel=_.find(e.releaseMetadata.riskLevels,{name:t.riskLevel})):e.draftTicket.riskLevel||(e.draftTicket.titleRiskLevelCls="risk-level-1",e.draftTicket.riskLevel=e.releaseMetadata.riskLevels[0])}):e.draftTicket.isCalculateRiskNull=!1},e.riskLevel=function(){return e.draftTicket.riskLevel?e.draftTicket.riskLevel.label:""},e.addExistingChange=function(t){var a=o.open({templateUrl:"views/release/relate-change-action-blade.html",windowClass:"action-blade-aif",controller:"RelateChangeController",resolve:{linkParams:function(){var t=1;return e.draftTicket.noOfRelatedItems[e.draftTicket.milestone.name]&&(t=e.draftTicket.noOfRelatedItems[e.draftTicket.milestone.name]+1),{selectedItems:[{id:e.draftTicket.id,type:EntityVO.TYPE_RELEASE,desc:e.draftTicket.summary,displayId:e.draftTicket.displayId,milestone:e.draftTicket.milestone}],isDraft:!0,sequence:t}}}});a.result.then(function(){M()})["finally"](function(){t.currentTarget.focus()})},e.$watch("draftTicket.company",function(){e.draftTicket.company&&(e.template={search:"",list:[],selected:{},showSearchResults:!1,preview:null})}),e.$on(v.RELEASE_PLAN_MILESTONE_CHANGE,function(){e.releasePlanMilestoneDirty=!0}),e.$on(v.RELEASE_PLAN_MILESTONE_NOT_DIRTY,function(){e.releasePlanMilestoneDirty=!1}),e.$watch("draftTicket.impactedService",function(){e.draftTicket&&_.isObject(e.draftTicket.impactedService)&&e.$emit(v.AFFECTED_SERVICE_UPDATED,e.draftTicket.impactedService)}),z()}])}(),function(){angular.module("releaseModule").directive("editReleasePlan",["$modal","$state","ticketModel","createTicketModel","$timeout","events","systemAlertService","i18nService","pwaModel","configurationModel","permissionModel","roles",function(e,t,a,n,i,o,r,s,l,c,d,u){return{restrict:"E",replace:!0,templateUrl:"views/release/edit-release-plan.html",scope:{ticket:"=",milestones:"="},link:function(p){function m(){i(function(){p.$broadcast(o.REFRESH_RELEASE_PLAN_LIST)},1e3)}function f(e){if(p.releasePlanMilestoneDirty){var t=g();t.result.then(function(t){e(t?!0:!1)})}else e(!0)}function g(){var e=r.modal({title:s.getLocalizedString("common.notification.dirty.title"),text:s.getLocalizedString("common.notification.dirty.message"),buttons:[{text:s.getLocalizedString("common.labels.yes"),data:!0},{text:s.getLocalizedString("common.labels.no")}]});return e}p.releasePlanMilestoneDirty=!1,p.addExistingChange=function(t){var a=1;p.ticket.noOfRelatedItems[p.ticket.milestone]&&(a=p.ticket.noOfRelatedItems[p.ticket.milestone]+1);var n=e.open({templateUrl:"views/release/relate-change-action-blade.html",windowClass:"action-blade-aif",controller:"RelateChangeController",resolve:{linkParams:function(){return{selectedItems:[{id:p.ticket.id,type:EntityVO.TYPE_RELEASE,desc:p.ticket.summary,displayId:p.ticket.displayId,milestone:{name:p.ticket.milestone}}],isDraft:!0,sequence:a}}}});n.result.then(function(){m()})["finally"](function(){t.currentTarget.focus()})},p.createBlankActivity=function(){f(function(t){if(t){a.activityParent=p.ticket;var i=e.open({templateUrl:"views/create/create-activity.html",controller:"CreateActivityController",windowClass:"ticket__open-modal",backdrop:!1,keyboard:!1});i.result.then(function(){m(),n.currentTicket=p.ticket})}})},p.browseActivityTemplate=function(){f(function(t){if(t){a.activityParent=p.ticket;var n=e.open({templateUrl:"views/template/browse-ticket-template-action-blade.html",windowClass:"action-blade",controller:"BrowseTicketTemplateController",resolve:{ticketType:function(){return EntityVO.TYPE_ACTIVITY},metadata:function(){return{}},company:function(){return p.ticket.company}}});n.result.then(function(){m()})}})},p.haveChangePermission=function(){return c.isServerApplicationEnabled(EntityVO.TYPE_CHANGE)&&d.hasPermission(u.ITSM_CHANGE_USER_ROLE)},p.createRelatedDraft=function(e,n){f(function(i){if(i){a.cache.draft={type:e};var o=1;if(p.ticket.noOfRelatedItems[p.ticket.milestone]&&(o=p.ticket.noOfRelatedItems[p.ticket.milestone]+1),a.cache.relatedDraft={type:e,fromType:EntityVO.TYPE_RELEASE,id:p.ticket.id,fromContext:p.ticket,relationship:RelationItemVO.TYPE_MEMBEROF,sequence:o},EntityVO.TYPE_CHANGE==e&&l.isPwaEnabled()){p.ticket.sequence=o,p.ticket.milestoneId=p.ticket.milestone?_.find(p.milestones,{name:p.ticket.milestone}).index:"",l.createRelatedFromRelease={fromType:e,fromContext:p.ticket};var r={isSrcRelease:"true",crossLaunchContext:"RELEASE"};t.go("pwaDraftChange",r)}else t.go(n)}})},p.$on(o.RELEASE_PLAN_MILESTONE_CHANGE,function(){p.releasePlanMilestoneDirty=!0}),p.$on(o.RELEASE_PLAN_MILESTONE_NOT_DIRTY,function(){p.releasePlanMilestoneDirty=!1})}}}])}(),function(){angular.module("releaseModule").controller("RelateChangeController",["$scope","$modalInstance","linkParams","searchService","$q","relationModel","metadataModel","systemAlertService","i18nService",function(e,t,a,n,i,o,r,s,l){var c=EntityVO.TYPE_RELEASE,d={},u={searching:!1,processing:!0,isDirty:!1},p={};e.state=u,e.selected=d,e.availableEntities=null,e.ticketType=c,o.getRelationsByTag(a.selectedItems[0].id,EntityVO.TYPE_RELEASE,"releasePlan").then(function(e){p.relations=e,u.processing=!1}),e.searchEntities=function(){function t(t){var a=t.items.length>0?t.items[0].results:[];_.forEach(p.relations,function(e){e.type===EntityVO.TYPE_CHANGE&&(a=_.reject(a,{id:e.id}))}),e.availableEntities=a}var a={},o={};if(!d.searchText)return!1;u.showSuggestedItemsTooltip&&(u.showSuggestedItemsTooltip=!1),u.searching=!0,d.entities=[],a={search_text:d.searchText,types:EntityVO.TYPE_CHANGE,chunk_index:0,chunk_size:50},o={allowSpecialCharacters:!0};var s=[n.getGlobalSearchResults(a,o)];return r.cache[EntityVO.TYPE_CHANGE]||s.push(r.getMetadataByType(EntityVO.TYPE_CHANGE)),i.all(s).then(function(e){t(e[0])})["finally"](function(){u.searching=!1})},e.selectEntity=function(e){u.isDirty=!0,e.isSelected?d.entities.push(e):_.remove(d.entities,{id:e.id})},e.link=function(){u.processing=!0;var e=a.sequence,n=_.map(a.selectedItems,function(e){var t={uuid:e.id,type:e.type};return t}),i=_.map(d.entities,function(t){var n={id:t.id,displayId:t.displayId,relationshipType:RelationItemVO.TYPE_CONSISTSOF,tag:RelationItemVO.TAG_LINKEDITEM,type:t.type,desc:t.title,parentDesc:a.selectedItems[0].desc,milestone:a.selectedItems[0].milestone.name,details:{sequence:e}};return e++,a.selectedItems[0].displayId&&(n.parentDisplayId=a.selectedItems[0].displayId),n});o.bulkAddRelation(n,i).then(function(){t.close(),u.processing=!1},function(e){s.error({text:e.data.results.error,clear:!1}),t.dismiss()})["catch"](function(e){s.error({text:e.data.results.error,clear:!1}),t.dismiss()})},e.close=function(){if(u.isDirty){var e=s.modal({title:l.getLocalizedString("common.notification.dirty.title"),text:l.getLocalizedString("common.notification.dirty.message"),buttons:[{text:l.getLocalizedString("common.labels.yes"),data:!0},{text:l.getLocalizedString("common.labels.no"),data:!1}]});e.result.then(function(e){e&&t.dismiss()})}else t.dismiss()}}])}(),function(){angular.module("releaseModule").directive("releaseBasicDetails",["events","tabIds","editTicketDatesService",function(e,t,a){return{restrict:"E",replace:!0,templateUrl:"views/release/release-basic-details.html",link:function(n){n.$watch(t.wizard.basics+".$invalid",function(a){"undefined"!=typeof a&&n.$emit(e.RELEASE_WIZARD_FORM_STATE,{name:t.wizard.basics,invalid:a})}),n.$watch(t.wizard.basics+".$dirty",function(a){"undefined"!=typeof a&&n.$emit(e.RELEASE_WIZARD_FORM_STATE,{name:t.wizard.basics,dirty:a})}),n.updateDateTime=function(e){a.updateDateTime(n[n.tabIds.wizard.basics],n.draftTicket,e)},n.clearImpactedService=function(){n.draftTicket.impactedService=""},n.$watch("draftTicket.scheduledStartDate",function(e,t){e&&(n.draftTicket.tempScheduledInit=angular.copy(new Date(e)))}),n.$watch("draftTicket.deploymentStartDate",function(e,t){e&&(n.draftTicket.tempDeploymentInit=angular.copy(new Date(e)))})}}}])}(),function(){angular.module("releaseModule").directive("releaseDetailsEditor",["events","createTicketService","fieldValidationModel","systemAlertService","i18nService",function(e,t,a,n,i){return{restrict:"E",replace:!0,templateUrl:"views/release/release-details-editor.html",scope:{ticket:"=",metadata:"=",form:"="},link:function(o){function r(){o.editMode=!0,o.ticketCopy=_.cloneDeep(o.ticket),o.updatedInfo={location:o.ticket.location?o.ticket.location:{},company:o.ticket.company,customer:o.ticket.customer,releaseType:_.find(o.metadata.types,function(e){return e.name===o.ticket.releaseType}),businessJustification:_.find(o.metadata.businessJustifications,function(e){return e.name===o.ticket.businessJustification})},o.updatedInfo.location.companyName=o.updatedInfo.company.name}function s(){var t=l();o.$emit(e.SAVE_CHANGES_REQUEST,t)}function l(){var e={};return angular.isObject(o.updatedInfo.releaseType)?e.releaseType=o.updatedInfo.releaseType.name:e.releaseType="",angular.isObject(o.updatedInfo.businessJustification)&&(e.businessJustification=o.updatedInfo.businessJustification.name),o.updatedInfo.location!==o.ticket.location&&(e.location=o.updatedInfo.location),e}function c(){o.editMode=!1,o.updatedInfo={}}function d(e,t){_.isEmpty(t)||(o.ticket.changeReason=t.changeReason,o.ticket.customer=t.customer,o.ticket.releaseType=t.releaseType,o.ticket.businessJustification=t.businessJustification,o.ticket.location=t.location),o.isDatesRequired()&&(o.ticket.scheduledStartDate=o.ticketCopy.scheduledStartDate,o.ticket.scheduledEndDate=o.ticketCopy.scheduledEndDate,o.ticket.actualStartDate=o.ticketCopy.actualStartDate,o.ticket.actualEndDate=o.ticketCopy.actualEndDate,o.ticket.targetDate=o.ticketCopy.targetDate),c()}function u(){o.$broadcast(e.SAVE_CHANGES_COMPLETE),c()}o.ticketCopy=_.cloneDeep(o.ticket),o.siteOptions={company:{visible:!1,attribute:"companyName"},region:{attribute:"region"},siteGroup:{attribute:"siteGroup"},site:{attribute:"name"}},o.clear=function(e){o.updatedInfo[e]=null},o.getListPersons=function(e,a){return o.searchingPersons=!0,t.getListOfPersonsByCompany(e,a).then(function(e){return o.searchingPersons=!1,e[0].items})},o.buildSiteTag=function(e){var t=e.siteGroup?" > "+e.siteGroup:"",a=e.name?" > "+e.name:"",n=e.region?e.region:"";return n+t+a},o.validateRequestedFor=function(){o.updatedInfo.customer.id||(o.updatedInfo.customer=""),o.searchingPersons=!1},o.setChangeLocation=function(){return n.modal({title:i.getLocalizedString("create.release.setRequestedForLocation.title"),text:i.getLocalizedString("create.release.setRequestedForLocation.text"),buttons:[{text:i.getLocalizedString("common.button.yes"),data:!0},{text:i.getLocalizedString("common.button.no"),data:!1}]}).result.then(function(e){if(e){var t=o.updatedInfo.customer.site;t.company=o.ticket.company.name,o.updatedInfo.location=t}})},o.isDatesRequired=function(){return(a.isFieldRequired(o.ticket.type,o.ticket.status.value,"scheduledStartDate")||a.isFieldRequired(o.ticket.type,o.ticket.status.value,"actualStartDate"))&&(o.ticket.accessMappings.actualdateEditAllowed||o.ticket.accessMappings.scheduleddateEditAllowed)},o.$on(e.SAVE_CHANGES,s),o.$on(e.TOGGLE_EDIT_MODE,r),o.$on(e.SAVE_ALL_CHANGES_COMPLETE,d),o.$on(e.SAVE_ALL_CHANGES_FAULT,u),o.$on(e.DISCARD_CHANGES,c)}}}])}(),function(){angular.module("releaseModule").directive("releasePlanDetails",function(){return{restrict:"E",replace:!0,templateUrl:"views/release/release-plan-details.html"}})}(),function(){angular.module("releaseModule").directive("releasePlanItemList",["$q","$filter","relationModel","metadataModel","relationService","systemAlertService","events","$timeout",function(e,t,a,n,i,o,r,s){return{restrict:"E",replace:!0,templateUrl:"views/release/release-plan-item-list.html",scope:{ticket:"=",isNew:"=?"},link:function(l){function c(){_.forEach(l.milestoneFilters,function(e){e.selected=!1})}function d(e){e&&(e.selected=!e.selected),l.releasePlanGroups=angular.copy(g),_.some(l.milestoneFilters,{selected:!0})&&(_.remove(l.releasePlanGroups,function(e){return!_.find(l.milestoneFilters,{name:e[0].realObject.releaseMilestone||""}).selected}),l.dirty=!1)}function u(){return a.getRelationsByTag(l.ticket.id,l.ticket.type,"releasePlan").then(function(e){l.releasePlanGroups=p(e),g=angular.copy(l.releasePlanGroups),l.ticket.noOfRelatedItems={},_.forEach(l.releasePlanGroups,function(e){e.length&&(l.ticket.noOfRelatedItems[e[0].realObject.releaseMilestone]=e.length)})})}function p(e){var t=_.chain(e).groupBy("realObject.releaseMilestone").map(function(e){return e}).value();return t}function m(){l.state.dataIsLoading=!0,u().then(function(){c(),l.state.dataIsLoading=!1})}function f(){l.state.dataIsLoading=!0;var a=u(),i=n.getMetadataByType(EntityVO.TYPE_ACTIVITY),o=n.getMetadataByType(EntityVO.TYPE_RELEASE);e.all([a,i,o]).then(function(e){var a=e[2];l.milestoneFilters=angular.copy(a.milestones),l.milestoneFilters.unshift({name:"",label:t("i18n")("common.labels.noneSet")}),l.milestones=angular.copy(a.milestones),l.state.dataIsLoading=!1})}l.state={dataIsLoading:!1,movingToOtherList:!1},l.releasePlanGroups={},l.milestoneFilters={},l.milestones={},l.isNew===!0?l.target="_blank":l.target="_self",l.parentSortableOptions={placeholder:"profile-relation__item-task-container",connectWith:".profile-relation__release-plan-container",cancel:":input,.locked",receive:function(e,t){var a=t.item.sortable.droptargetModel[0].realObject.releaseMilestone;a!==t.item.sortable.model.realObject.releaseMilestone&&(l.state.movingToOtherList=!0,t.item.sortable.model.realObject.releaseMilestone=a)},stop:function(e,t){function a(e){var a=1;_.forEach(e,function(n,i){var o=!1,r=null;i+1!==e.length&&(r=e[i+1]),r&&n.realObject.sequence===r.realObject.sequence&&t.item.sortable.model.id!==r.id&&(o=!0),n.realObject.sequence=a,a=o?n.realObject.sequence:n.realObject.sequence+1});var n=_.findIndex(l.releasePlanGroups,function(t){if(t&&t.length&&e[0].realObject.releaseMilestone===t[0].realObject.releaseMilestone)return!0});l.releasePlanGroups[n]=e}var n=_.cloneDeep(t.item.sortable.sourceModel);if(l.state.movingToOtherList){var i=_.cloneDeep(t.item.sortable.droptargetModel);a(i),l.state.movingToOtherList=!1}if(n.length)a(n);else{var o=_.findIndex(l.releasePlanGroups,function(e){return 0===e.length});o!==-1&&l.releasePlanGroups.splice(o,1)}l.dirty=!0}};var g={};l.applyFilter=function(e){if(l.dirty){var a=o.modal({type:"info",title:t("i18n")("common.notification.dirty.title"),text:t("i18n")("common.notification.dirty.loseChanges"),buttons:[{text:t("i18n")("common.button.yes"),data:!0},{text:t("i18n")("common.button.no"),data:!1}]});a.result.then(function(t){t&&d(e)})}else d(e)},l.getSelectedFiltersList=function(){return _.filter(l.milestoneFilters,{selected:!0})},l.selectAll=function(e){_.forEach(l.milestoneFilters,function(t){t.selected=e}),l.releasePlanGroups=angular.copy(g)},l.updateMilestone=function(e,t){if(t.realObject.releaseMilestone!==e.name){l.$emit(r.RELEASE_PLAN_MILESTONE_CHANGE);var a=_.findIndex(l.releasePlanGroups,function(e){if(t.realObject.releaseMilestone===e[0].realObject.releaseMilestone&&(_.remove(e,{id:t.id}),0===e.length))return!0});a!==-1&&l.releasePlanGroups.splice(a,1);var n=_.findIndex(l.releasePlanGroups,function(t){if(e.name===t[0].realObject.releaseMilestone)return!0});n!==-1?l.releasePlanGroups[n].push(t):l.releasePlanGroups.push([t]),t.realObject.releaseMilestone=e.name,l.updateItemsSequence(t)}},l.updateItemsSequence=function(e){e.realObject.sequence<=0||isNaN(e.realObject.sequence)||_.isEmpty(e.realObject.sequence)?e.realObject.sequence=1:e.realObject.sequence=parseInt(e.realObject.sequence);var t=_.findIndex(l.releasePlanGroups,function(t){if(e.realObject.releaseMilestone===t[0].realObject.releaseMilestone)return!0}),a=angular.copy(l.releasePlanGroups[t]),n=_.findIndex(a,function(t){return t.id==e.id});a[n]=e,a.sort(function(e,t){return(e.length?e[0].realObject.sequence:e.realObject.sequence)-(t.length?t[0].realObject.sequence:t.realObject.sequence)}),s(function(){l.releasePlanGroups[t]=a},2e3),l.dirty=!0},l.saveSequence=function(){var e=[];_.forEach(l.releasePlanGroups,function(t){var a=_.find(g,function(e){return!!e.length&&e[0].realObject.releaseMilestone===t[0].realObject.releaseMilestone});a||(a=[]),_.forEach(t,function(t){var n=_.find(a,{id:t.id});if(!n||t.realObject.sequence!==n.realObject.sequence||t.realObject.releaseMilestone!==n.realObject.releaseMilestone){var i={parentId:l.ticket.id,parentName:EntityVO.TYPE_RELEASE,parentDisplayId:l.ticket.displayId,milestone:t.realObject.releaseMilestone,sequence:t.realObject.sequence,id:t.id,displayId:t.displayId,type:t.type};e.push(i)}})}),e.length&&i.updateReleasePlanItemsSequence(e).then(function(){m(),l.dirty=!1,l.$emit(r.RELEASE_PLAN_MILESTONE_NOT_DIRTY)},function(e){o.error({text:e.data.error,clear:!1}),$modalInstance.dismiss()})},l.onRevertClick=function(){d(),l.dirty=!1},l.removeItem=function(e){var n=o.modal({title:t("i18n")("common.notification.delete.title"),text:t("i18n")("common.notification.delete.message"),buttons:[{text:t("i18n")("common.notification.delete.button1"),data:!0},{text:t("i18n")("common.notification.delete.button2"),data:!1}]});n.result.then(function(t){function n(t){_.forEach(t,function(t){e.item.realObject.releaseMilestone===t[0].realObject.releaseMilestone&&(_.remove(t,{id:e.item.id}),t.length&&(l.ticket.noOfRelatedItems[t[0].realObject.releaseMilestone]=t.length))});var a=_.findIndex(t,function(e){return 0===e.length});a!==-1&&t.splice(a,1)}if(t)if(e.item.type===EntityVO.TYPE_ACTIVITY)a.deleteActivity(e.item).then(function(){n(g),n(l.releasePlanGroups)},function(e){o.error({text:e.data.error,clear:!1}),$modalInstance.dismiss()});else{var i={parentType:l.ticket.type,parentId:l.ticket.id},r={id:e.item.id,type:e.item.type,relationshipType:e.item.relationshipType,parentDisplayId:l.ticket.displayId};a.removeRelation(i,[r]).then(function(){n(g),n(l.releasePlanGroups)},function(e){o.error({text:e.planData.error,clear:!1}),$modalInstance.dismiss()})}})},l.$on(r.REFRESH_RELEASE_PLAN_LIST,function(){m()}),f()}}}])}(),function(){angular.module("releaseModule").directive("releaseProfilePlans",["$q","attachmentService","events",function(e,t,a){return{restrict:"E",replace:!0,templateUrl:"views/release/release-profile-plans.html",scope:{changeRequest:"=context",documentTypes:"=types",editModeAllowed:"="},link:function(n){function i(){n.types=_.cloneDeep(n.documentTypes),r=_.cloneDeep(n.changeRequest.plans),s=_.keyBy(r,"id");var e=[],a=_.cloneDeep(n.changeRequest.plans);_.each(a,function(a){var i=_.find(n.types,{index:a.workNote.workNoteTypeId}),o=_.find(e,{index:i.index});return a.attachments=t.normalizeAttachments(a),a.desc=a.workNote.notes,a.label=i.label,_.each(a.attachments,function(e){e.pendingSave=!0}),o?o.plans.push(a):(i.active=!0,i.activePlanIndex=0,i.plans=[a],a.workNote&&a.workNote.locked&&(i.isLocked=!0),e.push(i)),a}),n.changeRequest.documents=e,n.state.hideControlButtons=!e.length}function o(e){var t={},a=_.groupBy(e,function(e){return e.workNote.workNoteTypeId});return _.each(e,function(e){a[e.workNote.workNoteTypeId].length>1?(t[e.workNote.workNoteTypeId]?t[e.workNote.workNoteTypeId]++:t[e.workNote.workNoteTypeId]=1,e.typeIndex=t[e.workNote.workNoteTypeId]):1===a[e.workNote.workNoteTypeId].length&&e.typeIndex&&(e.typeIndex=null)}),_.sortBy(e,function(e){return e.workNote.workNoteTypeId})}var r,s;n.state={processing:!1,hideControlButtons:!1},n.editMode=!1,n.showDocumentViewer=function(e){n.$parent.ticketActions.showAttachmentPreviewer(e)},n.editPlans=function(){i(),n.editMode=!0},n.cancelEdit=function(){n.changeRequest.plans=r,n.editMode=!1,n.types=n.documentTypes,n.changeRequest.documents=[]},n.updatePlans=function(){var a=[];return n.state.processing=!0,_.each(n.changeRequest.documents,function(e){_.each(e.plans,function(i){if(i.desc||i.attachments.length){var o={text:i.desc,type:e.index,locked:!1,access:!0,attachments:[],attachmentInfos:[]};if(_.each(i.attachments,function(e){e.id||(o.attachments.push(e),o.attachmentInfos.push({name:e.name,action:"add"}))}),i.id){var r=s[i.id];_.each(r.attachmentInfos,function(e){var t=_.find(i.attachments,function(t){return!!t.attachmentReference&&t.attachmentReference.attachmentId===e.attachmentReference.attachmentId});t||o.attachmentInfos.push({name:e.name,attachmentId:e.attachmentReference.attachmentId,action:"delete"})}),(i.workNote.notes!==o.text||o.attachmentInfos.length>0)&&a.push(t.updateChangePlan({parentId:n.changeRequest.id,id:i.id},o))}else a.push(t.createChangePlan(n.changeRequest.id,o))}})}),_.each(r,function(e){var i,o=_.find(n.changeRequest.documents,{index:e.workNote.workNoteTypeId});o&&(i=_.find(o.plans,{id:e.id})),o&&i||(a.push(t.deleteChangePlan(n.changeRequest.id,e.id)),_.remove(n.changeRequest.plans,{id:e.id}))}),e.all(a)["finally"](function(){n.state.processing=!1,n.editMode=!1}).then(function(e){_.each(e,function(e){var t=e.data[0];if("deleted"!==e.action){var a=_.find(n.documentTypes,{index:t.workNote.workNoteTypeId});if(t.workNote.documentType=a,"created"===e.action)n.changeRequest.plans.push(e.data[0]);else if("updated"===e.action){var i=_.find(n.changeRequest.plans,{id:e.data[0].id}),o=n.changeRequest.plans.indexOf(i);e.data[0].workNote.documentType=a,o>=0?n.changeRequest.plans[o]=e.data[0]:(_.remove(n.changeRequest.plans,{id:e.data[0].id}),n.changeRequest.plans.push(e.data[0]))}}}),n.changeRequest.plans=o(n.changeRequest.plans)})},n.$on(a.CHANGE_REQUEST_PLANS_EDIT_STATUS,function(e,t){n.state.hideControlButtons=t.hideButtons})}}}])}(),function(){angular.module("releaseModule").directive("releaseRiskLevelBadge",["metadataModel",function(e){return{restrict:"E",replace:!0,templateUrl:"views/release/risk-level-badge.html",scope:{riskLevel:"="},link:function(t){function a(){e.getMetadataByType(EntityVO.TYPE_RELEASE).then(function(e){angular.extend(t.metadata,e)})}t.metadata={},t.riskLevelCls=function(){var e=_.findIndex(t.metadata.riskLevels,function(e){return e.name===t.riskLevel||e.name===t.riskLevel.name});return"ticket__risk-level-"+(e+1)},a()}}}])}(),function(){angular.module("releaseModule").directive("releaseRisks",["events","tabIds",function(e,t){return{restrict:"E",replace:!0,templateUrl:"views/release/release-risks.html",link:function(a){a.$watch(t.wizard.risks+".$invalid",function(n){"undefined"!=typeof n&&a.$emit(e.RELEASE_WIZARD_FORM_STATE,{name:t.wizard.risks,invalid:n})}),a.$watch(t.wizard.risks+".$dirty",function(n){"undefined"!=typeof n&&a.$emit(e.RELEASE_WIZARD_FORM_STATE,{name:t.wizard.risks,dirty:n})})}}}])}(),function(){angular.module("releaseModule").constant("releaseTabIds",{main:{template:"template",scratch:"scratch"},wizard:{basics:"basics",releasePlan:"releasePlan",risks:"risks",documents:"documents"}})}(),function(){angular.module("releaseModule").directive("releaseWizard",[function(){return{restrict:"E",replace:!0,templateUrl:"views/release/release-wizard.html"}}])}(),function(){angular.module("releaseModule").directive("releaseWizardTab",[function(){return{restrict:"E",replace:!0,scope:{tabid:"=",title:"@",icon:"@",selectedtab:"=",valid:"&"},templateUrl:"views/release/release-wizard-tab.html"}}])}(),function(){angular.module("pwa").controller("ChangeCalendarController",["$scope","$state","$stateParams","metadataModel","userModel","layoutConfigurationModel","screenConfigurationModel","searchModel","$q","$timeout","utilityFunctions","collisionModel","events","$rootScope",function(e,t,a,n,i,o,r,s,l,c,d,u,p,m){function f(){e.editMode=!0,e.isNew=!0,e.changeMetadata={},e.draftCreated=!1,e.context=new ChangeVO({type:EntityVO.TYPE_CHANGE,scheduledStartDatePicker:{open:!1},scheduledEndDatePicker:{open:!1},actualStartDatePicker:{open:!1},actualEndDatePicker:{open:!1},targetDatePicker:{open:!1},customFields:{},needsReloadingRiskQuestions:!0,accessMappings:{}}),n.getMetadataByType(EntityVO.TYPE_CHANGE).then(function(t){e.collisionStatuses=t.collisionStatuses}),e.$emit(p.INSIDE_CHANGE_CALENDAR),e.changeCalendarLoaded()}function g(t){c(function(){if("string"==typeof t.data&&d.checkIfJson(t.data)){var a,n,i,o,r,s=JSON.parse(t.data);if(s)switch(s.eventType){case"changeCalendar":r=s.eventData.split(":"),a=1e3*Number(r[0].split("=")[1]),n=1e3*Number(r[1].split("=")[1]),i=r[2].split("=")[1],o=r[3].split("=")[1],e.model.context.scheduledStartDate=new Date(a),e.model.context.scheduledEndDate=new Date(n),e.model.context.id=i,e.model.context.displayId=i,e.model.mode=o,l.all([u.changeCalendarGet(i,new Date(a),new Date(n),y(),o),u.changeCalendarCollisionGet(new Date(a),new Date(n),i,o)]).then(function(t){var a=t[0],n=t[1];e.model.loadingCollisions=!1,e.model.collisions=a,e.model.collisions.scheduledStartDate=e.model.context.scheduledStartDate,e.model.collisions.scheduledEndDate=e.model.context.scheduledEndDate,n&&(e.collisionsCopy=n,e.collisionsCopy.changeList.filter(function(t){t.id===e.model.context.id&&e.collisionsCopy.changeList.splice(e.collisionsCopy.changeList.indexOf(t),1)}),e.model.collisions.changeList=e.collisionsCopy.changeList,e.selectAllToggle(!1),e.addressCollisions(e.model.collisions.changeList),m.$emit(p.CHANGE_COLLISION_STATUS_CHANGED,e.model.collisions.changeList))});break;case"resolveCollision":if(e.collisionsCopy&&e.collisionsCopy.changeList.length){var c,f,g,E,v,T,S,C,O;c=s.eventData.split(":"),f=c[0],g=c[1],E=c[2],v=c[3],T=f.split("|"),
S=g.split("|"),C=E.split("|"),O=_.find(e.collisionStatuses,{name:v});for(var A=0;A<T.length;A++){var I=h(S[A]);I&&_.each(I.configurationItems,function(e){e.id===T[A]&&(e.selected=!0,e.status={name:C[A]})})}e.collisionsCopy.changeList.filter(function(e){for(var t=0;t<e.configurationItems.length;t++)e.configurationItems[t].selected&&e.configurationItems[t].status&&e.configurationItems[t].status.name!==O.name&&("Resolved"!==e.configurationItems[t].status.name&&"Ignored"!==e.configurationItems[t].status.name||(e.ciCount=e.ciCount+1),e.configurationItems[t].status=O,e.configurationItems[t].rationale="","Resolved"!==O.name&&"Ignored"!==O.name||(e.ciCount=e.ciCount-1),e.configurationItems[t].modified=!0)}),e.model.collisions.changeList=e.collisionsCopy.changeList,e.selectAllToggle(!1),e.addressCollisions(e.model.collisions.changeList),m.$emit(p.CHANGE_COLLISION_STATUS_CHANGED,e.model.collisions.changeList)}break;default:return}}})}function h(t){return _.find(e.collisionsCopy.changeList,{displayId:t})}function y(){var t=angular.copy(e.filters.selected),a={};return _.forEach(t,function(e){var n=e.criteria,i=_.isArray(n.value),o=n.name;a[o]?i?a[o]=_.union(a[o],n.value):(t.splice(_.findIndex(t,{name:e.name}),1),a[o]=n.value):a[o]=n.value}),a}e.$watch("model.context",function(){e.model.context&&e.loadDefaultData()}),e.defaultData=a.defaultData||"",e.loadDefaultData=function(){e.defaultData&&4===e.defaultData.split("|").length&&(e.model.context.scheduledStartDate=new Date(Number(e.defaultData.split("|")[1])),e.model.context.scheduledEndDate=new Date(Number(e.defaultData.split("|")[2])),e.model.context.id=e.defaultData.split("|")[0],e.model.context.displayId=e.model.context.id,e.model.mode=e.defaultData.split("|")[3],e.defaultData=null)},e.changeCalendarLoaded=function(){var e,t=localStorage.getItem("pwaDomain"),a=window.parent;t&&a&&(e={eventType:"changeCalendarLoaded",eventData:!0},d.windowPostMessage(a,e,t))},e.selections={companies:[]},e.changeMetadata={},e.handleFilterChange=function(){e.model.context.id&&u.changeCalendarGet(e.model.context.id,e.model.context.scheduledStartDate,e.model.context.scheduledEndDate,y(),e.model.mode).then(function(t){e.model.loadingCollisions=!1,e.model.collisions=t,e.model.collisions.scheduledStartDate=e.model.context.scheduledStartDate,e.model.collisions.scheduledEndDate=e.model.context.scheduledEndDate})},e.handleShowWeekend=function(e){var t,a=localStorage.getItem("pwaDomain"),n=window.parent;a&&n&&(t={eventType:"showWeekends",eventData:e},d.windowPostMessage(n,t,a))},e.handleDateChangeOnCalendar=function(e,t,a){var n,i,o,r,s;n=e?e.valueOf():e,i=t?t.valueOf():t,n&&i&&n!==i&&(o=localStorage.getItem("pwaDomain"),s=window.parent,o&&s&&(r={eventType:"dateChange",eventData:"schedule"+a.charAt(0).toUpperCase()+a.slice(1)+"Date="+n},d.windowPostMessage(s,r,o)))},e.selectAllToggle=function(t){var a=0;if(e.collisionsCopy&&e.collisionsCopy.changeList){for(var n=0;n<e.collisionsCopy.changeList.length;n++){e.collisionsCopy.changeList[n].selected=t,a+=e.collisionsCopy.changeList[n].configurationItems.length;for(var i=0;i<e.collisionsCopy.changeList[n].configurationItems.length;i++)e.collisionsCopy.changeList[n].configurationItems[i].selected=t}t?e.collisionsSelected=a:e.collisionsSelected=0}},e.addressCollisions=function(t){e.model.addressedCollisions={},_.forEach(t,function(t){e.model.addressedCollisions[t.id]=!t.ciCount})},window.onmessage=g,f()}])}(),function(){angular.module("pwa").controller("PwaActionController",["$state","$stateParams","$rootScope",function(e,t){t.data&&t.data.formName||e.go("dashboard")}])}(),function(){angular.module("pwa").factory("pwaModel",["authModel","session","$window","$q","$rootScope","AUTH_EVENTS","systemAlertService","$filter","metadataModel",function(e,t,a,n,i,o,r,s,l){function c(){var t=localStorage.getItem("midtierUrl"),a=localStorage.getItem("homeServer");return!(!d.pwaConfigurationFlag||!t)&&(!!e.isSSOEnabled()||(a||!1))}var d={};return d.taskFrom="",d.pwaConfigurationFlag=!1,d.createIncFromSmartRecorder=!1,d.createRelatedFromAsset=!1,d.draftCallMade=!1,d.init=function(){l.getMetadataByType(EntityVO.TYPE_GLOBAL).then(function(e){d.pwaConfigurationFlag="T"===e.configurationParameters["Enable-Progressive-Views"]||"true"===e.configurationParameters["Enable-Progressive-Views"],d.pwaConfigurationFlag="T"!==localStorage.getItem("overridePV")&&d.pwaConfigurationFlag})},d.isPwaEnabledPromise=function(){return d.pwaConfigurationFlag?n.when(c()):l.getMetadataByType(EntityVO.TYPE_GLOBAL).then(function(e){return d.pwaConfigurationFlag="T"===e.configurationParameters["Enable-Progressive-Views"]||"true"===e.configurationParameters["Enable-Progressive-Views"],d.pwaConfigurationFlag="T"!==localStorage.getItem("overridePV")&&d.pwaConfigurationFlag,c()})},d.isPwaEnabled=function(){return c()},d.isDraftCallMade=function(){return d.draftCallMade},d.init(),d}])}(),function(){angular.module("resourceModule").directive("pwaRsPreview",["events","relationModel","objectValueMapperService","utilityFunctions","$sce",function(e,t,a,n,i){return{restrict:"EA",replace:!0,templateUrl:"views/pwa/pwa-rs-preview.html",scope:{resourcePreviewItem:"=",closeModal:"&"},link:function(t,a,i){function o(e){var t=localStorage.getItem("pwaDomain"),a=r();t&&a&&n.windowPostMessage(a,e,t)}function r(){return document.getElementsByClassName("app__pwa-iframe")&&document.getElementsByClassName("app__pwa-iframe").length?document.getElementsByClassName("app__pwa-iframe")[0].contentWindow:null}t.editMode=!1,t.isTitleMultiline=!1,t.$on(e.MULTILINE_CONTENT_CHANGED,function(e,a){t.isTitleMultiline=a.isContentMultiline}),t.$on(e.KNOWLEDGE_ARTICLE_PREVIEW_LOADED,function(e,a){t.articleFlagged=a.article.flagged,t.currentArticle=a.article}),t.$on(e.PWA_UPDATED_KNOWLEDGE,function(e,a){t.resourcePreviewItem.showSaveToTicket="true"===a.showSaveToTicket,t.resourcePreviewItem.showSaveAndResolve="true"===a.showSaveAndResolve,t.resourcePreviewItem.showDeleteFromTicket="true"===a.showDeleteFromTicket}),t.$on(e.TICKET_PROFILE_RESEND_EVENT,function(e,a){e.stopPropagation(),t.$broadcast(a.eventName,a.eventData)}),t.saveAndResolve=function(e){var a={eventType:"saveAndResolve",eventData:e.data.id};o(a),t.closePreview()},t.sendPVEvent=function(e){var t={eventType:e.eventType,eventData:JSON.stringify({guid:e.data.id})};o(t)},t.setFlag=function(a){(t.currentArticle.accessMappings.flagEditAllowed&&a||t.currentArticle.accessMappings.unflagEditAllowed&&!a)&&t.$broadcast(e.ADD_FLAG_NOTE,{flag:a})},t.closePreview=function(){t.closeModal()}}}}])}(),function(){angular.module("pwa").controller("PwaTicketController",["$scope","$state","$stateParams","$modal","metadataModel","$rootScope","events","AUTH_EVENTS","$window","authModel","utilityFunctions","ticketModel","$filter","relationModel","historyModel","chatModel","personModel","pwaModel","$timeout","systemAlertService","i18nService","localStorageService","$http","$sce","assetModel","configurationModel","browser",function(e,t,a,n,i,o,r,s,l,c,d,u,p,m,f,g,h,y,E,v,T,S,C,O,A,I,b){function k(e){var t=localStorage.getItem("pwaDomain"),a=G();t&&a&&d.windowPostMessage(a,e,t)}function D(a,n,i){var o,r=localStorage.getItem("pwaDomain"),s=document.getElementsByClassName("app__pwa-iframe-create")&&document.getElementsByClassName("app__pwa-iframe-create").length?document.getElementsByClassName("app__pwa-iframe-create")[0].contentWindow:null;r&&s&&(o={eventType:"checkDirtyForm",eventData:null},a&&a.preventDefault(),d.windowPostMessage(s,o,r),E(function(){if(e.isFormDirty){var a=v.modal({title:T.getLocalizedString("common.notification.dirty.title"),text:T.getLocalizedString("common.notification.dirty.message"),buttons:[{text:T.getLocalizedString("common.labels.yes"),data:!0},{text:T.getLocalizedString("common.labels.no"),data:!1}]});a.result.then(function(a){if(a)if("stateChange"===e.reference)ye(),Te(),t.go(n,i);else if("historyBack"===e.reference&&window.history.length){var o=window.location.href;window.history.back(),E(function(){var e=window.location.href;o===e&&t.go("dashboard")},500)}else t.go("dashboard");else e.reference=null})}else if("stateChange"===e.reference)Te(),t.go(n,i);else if("historyBack"===e.reference&&window.history.length){var o=window.location.href;window.history.back(),E(function(){var e=window.location.href;o===e&&t.go("dashboard")},500)}else t.go("dashboard")},800))}function R(){C({method:"GET",url:"/smartit/rest/keepAlive"}).then(function(){},function(e){console.error("keepAlive : "+e)})}function P(a){E(function(){if("string"==typeof a.data&&d.checkIfJson(a.data)){var n,i=JSON.parse(a.data);if(i){if(i.action&&"eventRelayedFromIS"===i.action){var s=JSON.parse(i.eventData),u=_.find(Oe,{openEvent:s.eventType});if(u)w(u.name,s);else if("openPersonProfile"===s.eventType&&(n=s.eventData?s.eventData:null)){try{n=decodeURI(n)}catch(p){console.info("decode failed")}t.go("personPV",{id:n},{inherit:!1})}}if(Ee=_.find(Oe,{openEvent:i.eventType}))w(Ee.name,i);else if(i.action&&"keepAlive"===i.action)R();else if(i.action&&"sessionExpired"===i.action)c.isSSOEnabled()?l.location.href=l.location.origin+"/smartit/atssologout.html":(e.appState=-1,c.logout());else if(i.homeServer)localStorage.setItem("homeServer",i.homeServer);else switch(i.eventType){case"createTicket":L(i);break;case"Save_CreateTicket":o.$broadcast(r.PWA_TASK_MODAL,{taskCreated:!0});break;case"Cancel_CreateTicket":o.$broadcast(r.PWA_TASK_MODAL,{taskCreated:!1});break;case"updatedKnowledge":var f=i.eventData.split("|");o.$broadcast(r.PWA_UPDATED_KNOWLEDGE,{showSaveAndResolve:f[0],showDeleteFromTicket:f[1],showSaveToTicket:f[2]});break;case"TASK_LOADED":le();break;case"openPersonProfile":if(n=i.eventData?i.eventData:null){try{n=decodeURI(n)}catch(p){console.info("decode failed")}t.go("personPV",{id:n},{inherit:!1})}break;case"createRelatedTicket":N(i);break;case"addTicketToHistory":M(i);break;case"goToPreviousScreen":e.reference="historyBack",D();break;case"closeGlobalSearch":angular.element(document.body).click();break;case"startChat":V(i);break;case"isFormDirty":F(i);break;case"showDirtyWarning":x(i);break;case"SMARTRECORDER_CREATEWORKORDER_LOADED":case"LIVECHAT_CREATEWORKORDER_LOADED":case"ASSET_CREATEWORKORDER_LOADED":case"CHANGE_CREATEWORKORDER_LOADED":case"KNOWNERROR_CREATEWORKORDER_LOADED":case"PROBLEM_CREATEWORKORDER_LOADED":re();break;case"SMARTRECORDER_CREATEINCIDENT_LOADED":case"LIVECHAT_CREATEINCIDENT_LOADED":case"ASSET_CREATEINCIDENT_LOADED":case"CHANGE_CREATEINCIDENT_LOADED":case"KNOWNERROR_CREATEINCIDENT_LOADED":case"PROBLEM_CREATEINCIDENT_LOADED":ne();break;case"CHANGE_CREATEPROBLEM_LOADED":case"KNOWNERROR_CREATEPROBLEM_LOADED":se();break;case"CHANGE_CREATEKNOWNERROR_LOADED":ie();break;case"RELEASE_CREATECHANGE_LOADED":oe();break;case"LIVECHAT_CREATEINCIDENT_SUCCESS":case"LIVECHAT_CREATEWORKORDER_SUCCESS":if(e.isSrcLiveChat&&window.opener){var g={eventData:i.eventData,event:i.eventType};window.opener.postMessage(g,window.location&&window.location.origin)}break;case"SHOW_ALERT":i.eventData.options.detail=i.eventData&&i.eventData.options.detail.replace(/[\u00A0-\u9999<>\&]/gim,function(e){return"&#"+e.charCodeAt(0)+";"}),i.eventData&&"info"===i.eventData.type?v.info({text:i.eventData.options.detail,hide:1e4,displayOnStateChange:!0}):i.eventData&&"success"===i.eventData.type?v.success({text:i.eventData.options.detail,hide:1e4,displayOnStateChange:!0}):i.eventData&&"warn"===i.eventData.type?(v.warning({text:i.eventData.options.detail,hide:1e4,displayOnStateChange:!0}),i.eventData.options.messageNumber&&449===i.eventData.options.messageNumber&&t.go("dashboard")):i.eventData&&"error"===i.eventData.type&&(i.eventData.options.removeAfter?v.error({text:i.eventData.options.detail,stopHideControl:!0,hide:i.eventData.options.removeAfter,displayOnStateChange:!1}):v.error({text:i.eventData.options.detail,displayOnStateChange:!0}));break;case"ASSET_CREATEINCIDENT_SUCCESS":var h=i.eventData&&i.eventData.match(/(?:parentGUID=)([^\s\;]+)/),y=Array.isArray(h)&&h[1];y?delete m.cache[y]:console.error("No parent asset GUID");break;default:return}}e.dataLoading=!1}})}function w(i,o){var r,s=o.eventData?o.eventData:null;if(s)if(e.state&&e.state.current&&e.state.current.data&&"CREATE"==e.state.current.data.mode&&Te(),r=o.eventData.split("|"),"assetPV"===i||"asset"===i)r&&2===r.length&&t.go(i,{assetId:r[0],assetClassId:r[1]},{location:!e.isLastStateDraft||"replace"});else if("broadcast"===i)t.go("dashboard");else{if(!b.isMobile&&"openKnowledgeArticle"===o.eventType)return e.selectedItem={id:s,type:"knowledge"},r&&r.length>=2&&(e.selectedItem.id=r[0],e.selectedItem.showSaveAndResolve="true"===r[1],e.selectedItem.showDeleteFromTicket="true"===r[2],e.selectedItem.showSaveToTicket="true"===r[3]),n.open({template:'<pwa-rs-preview resource-preview-item="selectedItem" close-modal="closeModal()" class="full-height"></pwa-rs-preview>',windowClass:"action-blade preview",size:"lg",backdrop:"false",controller:["$scope","$modalInstance","selectedItem",function(e,t,a){e.selectedItem=a,e.closeModal=function(){t.close()}}],resolve:{selectedItem:function(){return e.selectedItem}}});if(r&&2===r.length&&"newTab"===r[1]){var l="#/"+i+"/"+r[0];window.open(l,"_blank")}else t.go(i,{id:r[0]},{reload:a.id===r[0],inherit:!1,location:!e.isLastStateDraft||"replace"})}}function L(e){var a=e.eventData?_.find(Oe,{name:e.eventData}):null;a&&a.createEvent&&t.go(a.createEvent)}function N(a){var i,o,s,l,c,d,p,f=a.eventData.split("|");if(f&&4===f.length){if(i=f[0],o=f[1],s=f[2],l=f[3],ve=_.find(Oe,{name:i}),b.isMobile&&"knowledge"===i)return void v.error({text:T.getLocalizedString("error.createKnowledge.notSupported"),clear:!0,displayOnStateChange:!1});if(ve&&ve.relatedTicketNavigation){var g;if("asset"===o){var h=s.split("/");g=A.getAssetDetailsByID(h[0],h[1])}else g=u.getTicket(s,o);g.then(function(s){e.context=s,"knowledge"===i?(u.articleParent=e.context,p=n.open({templateUrl:"views/create/create-ka.html",controller:"CreateKnowledgeArticleModalController",windowClass:"modal_full-content",backdrop:!1,keyboard:!1}),p.result.then(function(n){e.state.loadingRelatedItems=!0;var i=(new RelationItemVO).build({id:n.id,displayId:n.articleId,title:n.title,desc:n.title,type:n.type,additionalInformation:{modifiedDate:n.modifiedDate},tag:EntityVO.TYPE_RESOURCE,relationshipType:EntityVO.TYPE_RELATEDTO});c={type:e.context.type,uuid:e.context.id},d={id:i.id,desc:i.desc,type:i.type,tag:EntityVO.TYPE_RESOURCE,relationshipType:EntityVO.TYPE_RELATEDTO},m.addRelation(c,[d]).then(function(){e.state.loadingRelatedItems=!1,e.$emit(r.SELECT_RESOURCE_TAB),d.type===EntityVO.TYPE_KNOWLEDGE&&delete m.cache[d.id],B(a),t.go(i.type,{id:i.id})})})):(u.cache.draft={type:i},u.cache.relatedDraft={type:i,fromType:e.getContextType(),id:"asset"===o?e.context.instanceId:e.context.id,fromContext:e.context},e.getContextType()===EntityVO.TYPE_ASSET&&(u.cache.relatedDraft.id=e.context.reconciliationId,u.cache.relatedDraft.relationship=_.trim(l)),t.go(ve.relatedTicketNavigation))})}}}function M(e){var t={"&apos;":"'","&quot;":'"',"&fs;":"/","&bs;":"\\","&lt;":"<","&gt;":">","&amp;":"&"};try{var a=e.eventData.replace(/\t/g,"    "),n=JSON.parse(a.replace(/'/g,'"').replace(/\//g,"&fs;").replace(/\\/g,"&bs;").replace(/\n/g,"\\n").replace(/\r/g,"\\r"));_.each(t,function(e,t){n.summary=n.summary.replace(new RegExp(t,"g"),e)}),n.type===EntityVO.TYPE_KNOWLEDGE&&(n.isDecisionTree=function(){return!1}),f.addToHistory(n.type,n)}catch(i){U(i+" : "+p("i18n")("history.error.runProcess"))}}function V(e){var t,a,n,i=e.eventData.split("|"),o=null;t=i[0],a=i[1],t===EntityVO.TYPE_PERSON?h.getPersonDetailsByID(a).then(function(e){if(e&&e.jid){var t=e.jid,a=g.currentUser.loginId===(e.loginId||e.elementId);t&&!a?b.isMobile||g.createChatRoom(t):z(p("i18n")("chat.systemMessage.conversationError")+(a?p("i18n")("chat.systemMessage.self"):e.fullName))}else U(p("i18n")("chat.systemMessage.invalidJid"))}):t===EntityVO.TYPE_ASSET?(n=i[2],o={type:t,ticketType:t,id:a,reconciliationId:a,classId:n}):o={type:t,id:a},b.isMobile?v.error({text:T.getLocalizedString("error.chat.notSupported"),clear:!0,displayOnStateChange:!1}):o&&g.createAssignedChatRoom(o)}function F(t){e.isFormDirty=t.eventData}function x(e){var t=v.modal({title:T.getLocalizedString("common.notification.dirty.title"),text:T.getLocalizedString("common.notification.dirty.message"),buttons:[{text:T.getLocalizedString("common.labels.yes"),data:!0},{text:T.getLocalizedString("common.labels.no"),data:!1}]});t.result.then(function(e){var t,a=localStorage.getItem("pwaDomain"),n=G();a&&n&&(t={eventType:"dirtyFormNavigateAway",eventData:e?"yes":"no"},E(function(){d.windowPostMessage(n,t,a)}))})}function G(){return document.getElementsByClassName("app__pwa-iframe")&&document.getElementsByClassName("app__pwa-iframe").length?document.getElementsByClassName("app__pwa-iframe")[0].contentWindow:null}function B(e){var t={eventType:"acknowledgement",eventData:e.eventType+"EventCompleted"};k(t)}function U(e){E(function(){v.error({text:e,icon:"icon-comments",clear:!0,hide:1e4})})}function z(e){E(function(){v.warning({text:e,icon:"icon-comments",clear:!0,hide:1e4})})}function Y(){var e=[];return _.filter(y.smartRecorderData.confirmedItems,function(t){t.type===EntityVO.TYPE_PERSON&&t.content.personId!==y.smartRecorderData.customer.personId&&(!y.smartRecorderData.contact||y.smartRecorderData.contact&&t.content.personId!==y.smartRecorderData.contact.personId)&&e.push(t.content.personId)}),e.length?e.toString():""}function q(e){var t=[];return _.filter(y.smartRecorderData.relatedAsset,function(e){t.push(e.reconciliationId)}),e.causalCI&&e.causalCI.reconciliationId&&t.indexOf(e.causalCI.reconciliationId===-1)&&t.push(e.causalCI.reconciliationId),t.length?t.toString():""}function H(){var e=[];return _.filter(y.smartRecorderData.confirmedResourceList,function(t){t.type===EntityVO.TYPE_KNOWLEDGE&&e.push(t.id)}),e.length?e.toString():""}function K(){var e=[];return _.filter(y.smartRecorderData.confirmedResourceList,function(t){t.type===EntityVO.TYPE_INCIDENT&&e.push(t.id)}),e.length?e.toString():""}function j(){var e=[];return _.filter(y.smartRecorderData.confirmedResourceList,function(t){if(t.type===EntityVO.TYPE_OUTAGE){var a=t.displayId&&t.displayId.split("|")[0]||"";!a&&console.error("Unavailability ID not received."),e.push(a)}}),e.length?e.toString():""}function W(t){var a=y.smartRecorderData,n=a.desc?a.desc:"",i=a.template&&a.template.id?a.template.id:"";e.isSrcLiveChat&&(n=a.summary?a.summary:"",i=a.templateGuid?a.templateGuid:"",""===i&&(i=a.templateId?a.templateId:""));var o={eventType:t,eventData:"SMTRecorder_Company="+(a.customer&&a.customer.company?a.customer.company.name:"")+";SMTRecorder_Customer="+(a.customer&&a.customer.personId?a.customer.personId:"")+";SMTRecorder_Contact="+(a.contact&&a.contact.personId?a.contact.personId:"")+";SMTRecorder_Summary="+n.replace(/;/g,"[#semi#]")+";SMTRecorder_Template="+i+";SMTRecorder_Service="+(a.impactedService&&a.impactedService.reconciliationId?a.impactedService.reconciliationId:"")+";SMTRecorder_CI="+(a.causalCI&&a.causalCI.reconciliationId?a.causalCI.reconciliationId:"")+";SMTRecorder_MentionList="+Y()+";SMTRecorder_CIList="+q(a)+";SMTRecorder_RelatedKAList="+H()+";SMTRecorder_RelatedTicketList="+K()+";SMTRecorder_OutageList="+j()};if(I.comaroundEnabled&&(o.eventData+=";SMTRecorder_IsHKMEnabled=true"),a.impact&&(o.eventData+=";SMTRecorder_Impact="+a.impact),a.urgency&&(o.eventData+=";SMTRecorder_Urgency="+a.urgency),a.resolution&&(o.eventData+=";SMTRecorder_Resolution="+a.resolution.replace(/;/g,"[#semi#]")),e.isSrcLiveChat){var r=";SMTRecorder_ChatSessionId="+(a.chatSessionId?a.chatSessionId:"")+";SMTRecorder_ReportedSource="+(a.reportedSource?a.reportedSource:"")+";SMTRecorder_Status="+(a.status&&a.status.value?a.status.value:"")+";SMTRecorder_AssigneeLoginId="+(a.assignee&&a.assignee.loginId?a.assignee.loginId:"")+";SMTRecorder_AssigneeSupportGroupId="+(a.supportGroup&&a.supportGroup.id?a.supportGroup.id:"")+";SMTRecorder_ManagerLoginId="+(a.manager&&a.manager.loginId?a.manager.loginId:"")+";SMTRecorder_ManagerGroupId="+(a.managerGroup&&a.managerGroup.id?a.managerGroup.id:"");o.eventData+=r}return e.errorQuickCreate&&(o.eventData+=";SMTRecorder_DisplayError="+e.errorQuickCreate.replace(/;/g,"[#semi#]")),o}function Q(e,t,a){var n=_.find(e.allCategories,{name:t}),i=_.find(n.listOfTiers,{name:a}).selectedValue;return void 0===i?"":i}function J(e){var t=y.createRelatedFromAssetData.fromContext;return{eventType:e,eventData:"SMTRecorder_PCT1="+Q(t,"product","productCategoryTier1")+";SMTRecorder_PCT2="+Q(t,"product","productCategoryTier2")+";SMTRecorder_PCT3="+Q(t,"product","productCategoryTier3")+";SMTRecorder_PCTName="+Q(t,"product","productName")+";SMTRecorder_PCTModel="+Q(t,"product","productModelVersion")+";SMTRecorder_Manufacturer="+(t.manufacturer?t.manufacturer:"")+";SMTRecorder_ParentTicketID ="+t.reconciliationId+";SMTRecorder_ParentRelationshipType="+RelationItemVO.TYPE_RELATEDTO+";SMTRecorder_Summary="+t.name+";SMTRecorder_Description="+t.desc.replace(/;/g,"[#semi#]")}}function Z(e,t,a){var n=_.find(e.categorizations,{name:t});return void 0===n.tiers[a]?"":n.tiers[a]}function X(e){var t=y.createRelatedFromRelease.fromContext;return{eventType:e,eventData:"SMTRecorder_Company="+t.company.name+";SMTRecorder_ParentTicketID="+t.id+";SMTRecorder_Summary="+t.summary.replace(/;/g,"[#semi#]")+";SMTRecorder_Description="+t.desc.replace(/;/g,"[#semi#]")+";SMTRecorder_Priority="+t.priority+";SMTRecorder_Impact="+t.impact+";SMTRecorder_Urgency="+t.urgency+";SMTRecorder_Sequence="+t.sequence+";SMTRecorder_Milestone="+t.milestoneId+";SMTRecorder_ParentRelationshipType="+RelationItemVO.TYPE_MEMBEROF+";SMTRecorder_Template="+(t.templateId?t.templateId:"")+";SMTRecorder_PCT1="+Z(t,"product","productCategoryTier1")+";SMTRecorder_PCT2="+Z(t,"product","productCategoryTier2")+";SMTRecorder_PCT3="+Z(t,"product","productCategoryTier3")+";SMTRecorder_OCT1="+Z(t,"operational","operationCategoryTier1")+";SMTRecorder_OCT2="+Z(t,"operational","operationCategoryTier2")+";SMTRecorder_OCT3="+Z(t,"operational","operationCategoryTier3")}}function ee(e){var t=y.createRelatedFromChange.fromContext;return{eventType:e,eventData:"SMTRecorder_Company="+(t.customer&&t.customer.company?t.customer.company.name:"")+";SMTRecorder_Customer="+(t.customer&&t.customer.personId?t.customer.personId:"")+";SMTRecorder_Contact="+(t.contact&&t.contact.personId?t.contact.personId:"")+";SMTRecorder_Description="+t.desc.replace(/;/g,"[#semi#]")+";SMTRecorder_Summary="+t.summary.replace(/;/g,"[#semi#]")+";SMTRecorder_Template="+(t.templateId?t.templateId:"")+";SMTRecorder_Service="+(t.impactedService&&t.impactedService.reconciliationId?t.impactedService.reconciliationId:"")+";SMTRecorder_Priority="+t.priority+";SMTRecorder_Impact="+t.impact+";SMTRecorder_Urgency="+t.urgency+";SMTRecorder_ParentTicketID="+t.id+";SMTRecorder_ParentRelationshipType="+RelationItemVO.TYPE_CREATEDBY+";SMTRecorder_PCT1="+Z(t,"product","productCategoryTier1")+";SMTRecorder_PCT2="+Z(t,"product","productCategoryTier2")+";SMTRecorder_PCT3="+Z(t,"product","productCategoryTier3")+";SMTRecorder_OCT1="+Z(t,"operational","operationCategoryTier1")+";SMTRecorder_OCT2="+Z(t,"operational","operationCategoryTier2")+";SMTRecorder_OCT3="+Z(t,"operational","operationCategoryTier3")}}function te(e){var t=y.createRelatedFromKnownError.fromContext;return{eventType:e,eventData:"SMTRecorder_Company="+(t.coordinator&&t.coordinator.company?t.coordinator.company.name:"")+";SMTRecorder_Customer="+(t.coordinator&&t.coordinator.personId?t.coordinator.personId:"")+";SMTRecorder_Description="+t.desc.replace(/;/g,"[#semi#]")+";SMTRecorder_Summary="+t.summary.replace(/;/g,"[#semi#]")+";SMTRecorder_Service="+(t.impactedService&&t.impactedService.reconciliationId?t.impactedService.reconciliationId:"")+";SMTRecorder_Priority="+t.priority+";SMTRecorder_Impact="+t.impact+";SMTRecorder_Urgency="+t.urgency+";SMTRecorder_ParentTicketID="+t.id+";SMTRecorder_ParentRelationshipType="+RelationItemVO.TYPE_CREATEDBY+";SMTRecorder_PCT1="+Z(t,"product","productCategoryTier1")+";SMTRecorder_PCT2="+Z(t,"product","productCategoryTier2")+";SMTRecorder_PCT3="+Z(t,"product","productCategoryTier3")+";SMTRecorder_OCT1="+Z(t,"operational","operationCategoryTier1")+";SMTRecorder_OCT2="+Z(t,"operational","operationCategoryTier2")+";SMTRecorder_OCT3="+Z(t,"operational","operationCategoryTier3")+";SMTRecorder_LocationCompany="+(t.locationCompany&&t.locationCompany.name?t.locationCompany.name:"")+";SMTRecorder_CI="+(t.causalCI&&t.causalCI.reconciliationId?t.causalCI.reconciliationId:"")+";"}}function ae(e){var t=y.createRelatedFromProblem.fromContext;return{eventType:e,eventData:"SMTRecorder_Company="+(t.coordinator&&t.coordinator.company?t.coordinator.company.name:"")+";SMTRecorder_Customer="+(t.coordinator&&t.coordinator.personId?t.coordinator.personId:"")+";SMTRecorder_Description="+t.desc.replace(/;/g,"[#semi#]")+";SMTRecorder_Summary="+t.summary.replace(/;/g,"[#semi#]")+";SMTRecorder_Service="+(t.impactedService&&t.impactedService.reconciliationId?t.impactedService.reconciliationId:"")+";SMTRecorder_Priority="+t.priority+";SMTRecorder_Impact="+t.impact+";SMTRecorder_Urgency="+t.urgency+";SMTRecorder_ParentTicketID="+t.id+";SMTRecorder_ParentRelationshipType="+RelationItemVO.TYPE_CREATEDBY+";SMTRecorder_PCT1="+Z(t,"product","productCategoryTier1")+";SMTRecorder_PCT2="+Z(t,"product","productCategoryTier2")+";SMTRecorder_PCT3="+Z(t,"product","productCategoryTier3")+";SMTRecorder_OCT1="+Z(t,"operational","operationCategoryTier1")+";SMTRecorder_OCT2="+Z(t,"operational","operationCategoryTier2")+";SMTRecorder_OCT3="+Z(t,"operational","operationCategoryTier3")+";SMTRecorder_LocationCompany="+(t.locationCompany&&t.locationCompany.name?t.locationCompany.name:"")+";SMTRecorder_CI="+(t.causalCI&&t.causalCI.reconciliationId?t.causalCI.reconciliationId:"")+";"}}function ne(){var a,n,i=localStorage.getItem("pwaDomain"),o=G();i&&o&&(y.smartRecorderData?(n=e.isSrcLiveChat?"LIVECHAT_CREATEINCIDENT":"SMARTRECORDER_CREATEINCIDENT",a=W(n),d.windowPostMessage(o,a,i),y.draftCallMade=!0,y.smartRecorderData=null):y.createRelatedFromAssetData?(n="ASSET_CREATEINCIDENT",a=J(n),d.windowPostMessage(o,a,i),y.createRelatedFromAssetData=null):y.createRelatedFromChange?(n="CHANGE_CREATEINCIDENT",a=ee(n),d.windowPostMessage(o,a,i),y.createRelatedFromChange=null):y.createRelatedFromKnownError?(n="KNOWNERROR_CREATEINCIDENT",a=te(n),d.windowPostMessage(o,a,i),y.createRelatedFromKnownError=null):y.createRelatedFromProblem?(n="PROBLEM_CREATEINCIDENT",a=ae(n),d.windowPostMessage(o,a,i),y.createRelatedFromProblem=null):t.go("smartRecorder"))}function ie(){var e,t,a=localStorage.getItem("pwaDomain"),n=G();a&&n&&y.createRelatedFromChange&&(t="CHANGE_CREATEKNOWNERROR",e=ee(t),d.windowPostMessage(n,e,a),y.createRelatedFromChange=null)}function oe(){var e,t,a=localStorage.getItem("pwaDomain"),n=G();a&&n&&(y.createRelatedFromRelease&&(t="RELEASE_CREATECHANGE",e=X(t),d.windowPostMessage(n,e,a)),y.createRelatedFromRelease=null)}function re(){var a,n,i=localStorage.getItem("pwaDomain"),o=G();i&&o&&(y.smartRecorderData?(n=e.isSrcLiveChat?"LIVECHAT_CREATEWORKORDER":"SMARTRECORDER_CREATEWORKORDER",a=W(n),d.windowPostMessage(o,a,i),y.draftCallMade=!0,y.smartRecorderData=null):y.createRelatedFromAssetData?(n="ASSET_CREATEWORKORDER",a=J(n),d.windowPostMessage(o,a,i),y.createRelatedFromAssetData=null):y.createRelatedFromChange?(n="CHANGE_CREATEWORKORDER",a=ee(n),d.windowPostMessage(o,a,i),y.createRelatedFromChange=null):y.createRelatedFromKnownError?(n="KNOWNERROR_CREATEWORKORDER",a=te(n),d.windowPostMessage(o,a,i),y.createRelatedFromKnownError=null):y.createRelatedFromProblem?(n="PROBLEM_CREATEWORKORDER",a=ae(n),d.windowPostMessage(o,a,i),y.createRelatedFromProblem=null):t.go("smartRecorder"))}function se(){var e,t,a=localStorage.getItem("pwaDomain"),n=G();a&&n&&(y.smartRecorderData?(t="CHANGE_CREATEPROBLEM",e=W(t),d.windowPostMessage(n,e,a),y.draftCallMade=!0,y.smartRecorderData=null):y.createRelatedFromChange?(t="CHANGE_CREATEPROBLEM",e=ee(t),d.windowPostMessage(n,e,a),y.createRelatedFromChange=null):y.createRelatedFromKnownError?(t="KNOWNERROR_CREATEPROBLEM",e=te(t),d.windowPostMessage(n,e,a),y.createRelatedFromKnownError=null):console.error("in problemDraftFormLoaded"))}function le(){var e,t=localStorage.getItem("pwaDomain"),a=document.getElementById("task-pwa-frame")&&document.getElementById("task-pwa-frame").contentWindow?document.getElementById("task-pwa-frame").contentWindow:null;t&&a&&u.taskParent&&(e=ue(u.taskParent),d.windowPostMessage(a,e,t))}function ce(e){return null===e||void 0===e?"":e}function de(e,t){var a=_.filter(i.cache[e].statuses,{name:t});return a&&1===a.length?a[0].index:null}function ue(e){return"change"===e.type?pe(e):"knownerror"===e.type?me(e):"problem"===e.type?fe(e):"activity"===e.type?ge(e):void 0}function pe(e){var t=null===e.contact||void 0===e.contact?{}:e.contact,a=null===e.customer||void 0===e.customer?{}:e.customer,n=null===e.location||void 0===e.location?{}:e.location,i=null===e.supportGroup||void 0===e.supportGroup?{}:e.supportGroup,o=a.supportGroups&&a.supportGroups.length?a.supportGroups[0].name:"",r=null===e.assignee||void 0===e.assignee?{}:e.assignee,s=de(e.type,e.status.value);return{eventType:"TASK_LOADED",eventData:"PARENT_FormName=CHG:Infrastructure Change;PARENT_DisplayId="+ce(e.displayId)+";PARENT_Id="+ce(e.id)+";PARENT_TemplateId=;PARENT_TemplateName=;PARENT_Status="+ce(e.status.value)+";PARENT_StatusIndex="+ce(s)+";PARENT_Summary="+ce(e.summary)+";PARENT_Priority="+ce(e.priority)+";PARENT_ContactFirstName="+ce(t.firstName)+";PARENT_ContactLastName="+ce(t.lastName)+";PARENT_ContactOrganization="+ce(t.organization)+";PARENT_ContactDepartment="+ce(t.department)+";PARENT_ContactPersonId="+ce(t.personId)+";PARENT_ContactPhone="+ce(t.phone)+";PARENT_ContactLoginId="+ce(t.firstName)+";PARENT_Company="+ce(e.company.name)+";PARENT_SiteName="+ce(n.name)+";PARENT_SiteRegion="+ce(n.region)+";PARENT_SiteGroup="+ce(n.siteGroup)+";PARENT_CustomerFirstName="+ce(a.firstName)+";PARENT_CustomerLastName="+ce(a.lastName)+";PARENT_CustomerFullName="+ce(a.fullName)+";PARENT_CustomerLoginId="+ce(a.loginId)+";PARENT_CustomerPhone="+ce(a.phone)+";PARENT_CustomerIsSupportStaff="+ce(a.isSupportStaff)+";PARENT_CustomerpersonId="+ce(a.personId)+";PARENT_CustomerCompany="+ce(a.company.name)+";PARENT_CustomerSiteName="+ce(n.name)+";PARENT_CustomerSiteRegion="+ce(n.region)+";PARENT_CustomerSiteGroup="+ce(n.siteGroup)+";PARENT_CustomerSiteId="+ce(n.siteId)+";PARENT_Assignee="+ce(r.fullName)+";PARENT_AssigneeGroup="+ce(o)+";PARENT_AssigneeGroupId="+ce(i.id)+";PARENT_TaskPhaseId="+ce(e.taskPhaseId)+";PARENT_TaskPhaseName="+ce(e.taskPhaseName)+";"}}function me(e){var t=null===e.contact||void 0===e.contact?{}:e.contact,a=null===e.customer||void 0===e.customer?{}:e.customer,n=null===e.assignee.site||void 0===e.assignee.site?{}:e.assignee.site,i=null===e.supportGroup||void 0===e.supportGroup?{}:e.supportGroup,o=null===e.assignee||void 0===e.assignee?{}:e.assignee,r=o.supportGroups&&o.supportGroups.length?o.supportGroups[0].name:"",s=de(e.type,e.status.value);return{eventType:"TASK_LOADED",eventData:"PARENT_FormName=PBM:Known Error;PARENT_DisplayId="+ce(e.displayId)+";PARENT_Id="+ce(e.id)+";PARENT_TemplateId=;PARENT_TemplateName=;PARENT_Status="+ce(e.status.value)+";PARENT_StatusIndex="+ce(s)+";PARENT_Summary="+ce(e.summary)+";PARENT_Priority="+ce(e.priority)+";PARENT_ContactFirstName="+ce(t.firstName)+";PARENT_ContactLastName="+ce(t.lastName)+";PARENT_ContactOrganization="+ce(t.organization)+";PARENT_ContactDepartment="+ce(t.department)+";PARENT_ContactPersonId="+ce(t.personId)+";PARENT_ContactPhone="+ce(t.phone)+";PARENT_ContactLoginId="+ce(t.firstName)+";PARENT_Company="+ce(e.company.name)+";PARENT_SiteName="+ce(n.name)+";PARENT_SiteRegion="+ce(n.region)+";PARENT_SiteGroup="+ce(n.siteGroup)+";PARENT_CustomerFirstName="+ce(a.firstName)+";PARENT_CustomerLastName="+ce(a.lastName)+";PARENT_CustomerFullName="+ce(a.fullName)+";PARENT_CustomerLoginId="+ce(a.loginId)+";PARENT_CustomerPhone="+ce(a.phone)+";PARENT_CustomerIsSupportStaff="+ce(a.isSupportStaff)+";PARENT_CustomerpersonId="+ce(a.personId)+";PARENT_CustomerCompany="+ce(o.company.name)+";PARENT_CustomerSiteName="+ce(n.name)+";PARENT_CustomerSiteRegion="+ce(n.region)+";PARENT_CustomerSiteGroup="+ce(n.siteGroup)+";PARENT_CustomerSiteId="+ce(n.siteId)+";PARENT_Assignee="+ce(o.fullName)+";PARENT_AssigneeGroup="+ce(r)+";PARENT_AssigneeGroupId="+ce(i.id)+";"
}}function fe(e){var t=null===e.contact||void 0===e.contact?{}:e.contact,a=null===e.customer||void 0===e.customer?{}:e.customer,n=null===e.assignee.site||void 0===e.assignee.site?{}:e.assignee.site,i=null===e.supportGroup||void 0===e.supportGroup?{}:e.supportGroup,o=null===e.assignee||void 0===e.assignee?{}:e.assignee,r=o.supportGroups&&o.supportGroups.length?o.supportGroups[0].name:"",s=de(e.type,e.status.value);return{eventType:"TASK_LOADED",eventData:"PARENT_FormName=PBM:Problem Investigation;PARENT_DisplayId="+ce(e.displayId)+";PARENT_Id="+ce(e.id)+";PARENT_TemplateId=;PARENT_TemplateName=;PARENT_Status="+ce(e.status.value)+";PARENT_StatusIndex="+ce(s)+";PARENT_Summary="+ce(e.summary)+";PARENT_Priority="+ce(e.priority)+";PARENT_ContactFirstName="+ce(t.firstName)+";PARENT_ContactLastName="+ce(t.lastName)+";PARENT_ContactOrganization="+ce(t.organization)+";PARENT_ContactDepartment="+ce(t.department)+";PARENT_ContactPersonId="+ce(t.personId)+";PARENT_ContactPhone="+ce(t.phone)+";PARENT_ContactLoginId="+ce(t.firstName)+";PARENT_Company="+ce(e.company.name)+";PARENT_SiteName="+ce(n.name)+";PARENT_SiteRegion="+ce(n.region)+";PARENT_SiteGroup="+ce(n.siteGroup)+";PARENT_CustomerFirstName="+ce(a.firstName)+";PARENT_CustomerLastName="+ce(a.lastName)+";PARENT_CustomerFullName="+ce(a.fullName)+";PARENT_CustomerLoginId="+ce(a.loginId)+";PARENT_CustomerPhone="+ce(a.phone)+";PARENT_CustomerIsSupportStaff="+ce(a.isSupportStaff)+";PARENT_CustomerpersonId="+ce(a.personId)+";PARENT_CustomerCompany="+ce(o.company.name)+";PARENT_CustomerSiteName="+ce(n.name)+";PARENT_CustomerSiteRegion="+ce(n.region)+";PARENT_CustomerSiteGroup="+ce(n.siteGroup)+";PARENT_CustomerSiteId="+ce(n.siteId)+";PARENT_Assignee="+ce(o.fullName)+";PARENT_AssigneeGroup="+ce(r)+";PARENT_AssigneeGroupId="+ce(i.id)+";"}}function ge(e){var t=null===e.contact||void 0===e.contact?{}:e.contact,a=null===e.customer||void 0===e.customer?{}:e.customer,n=null===e.assignee.site||void 0===e.assignee.site?{}:e.assignee.site,i=null===e.supportGroup||void 0===e.supportGroup?{}:e.supportGroup,o=null===e.assignee||void 0===e.assignee?{}:e.assignee,r=o.supportGroups&&o.supportGroups.length?o.supportGroups[0].name:"",s=de(e.type,e.status.value);return{eventType:"TASK_LOADED",eventData:"PARENT_FormName=AAS:Activity;PARENT_DisplayId="+ce(e.displayId)+";PARENT_Id="+ce(e.id)+";PARENT_TemplateId=;PARENT_TemplateName=;PARENT_Status="+ce(e.status.value)+";PARENT_StatusIndex="+ce(s)+";PARENT_Summary="+ce(e.summary)+";PARENT_Priority="+ce(e.priority)+";PARENT_ContactFirstName="+ce(t.firstName)+";PARENT_ContactLastName="+ce(t.lastName)+";PARENT_ContactOrganization="+ce(t.organization)+";PARENT_ContactDepartment="+ce(t.department)+";PARENT_ContactPersonId="+ce(t.personId)+";PARENT_ContactPhone="+ce(t.phone)+";PARENT_ContactLoginId="+ce(t.firstName)+";PARENT_Company="+ce(e.company.name)+";PARENT_SiteName="+ce(n.name)+";PARENT_SiteRegion="+ce(n.region)+";PARENT_SiteGroup="+ce(n.siteGroup)+";PARENT_CustomerFirstName="+ce(a.firstName)+";PARENT_CustomerLastName="+ce(a.lastName)+";PARENT_CustomerFullName="+ce(a.fullName)+";PARENT_CustomerLoginId="+ce(a.loginId)+";PARENT_CustomerPhone="+ce(a.phone)+";PARENT_CustomerIsSupportStaff="+ce(a.isSupportStaff)+";PARENT_CustomerpersonId="+ce(a.personId)+";PARENT_CustomerCompany="+ce(e.company.name)+";PARENT_CustomerSiteName="+ce(n.name)+";PARENT_CustomerSiteRegion="+ce(n.region)+";PARENT_CustomerSiteGroup="+ce(n.siteGroup)+";PARENT_CustomerSiteId="+ce(n.siteId)+";PARENT_Assignee="+ce(o.fullName)+";PARENT_AssigneeGroup="+ce(r)+";PARENT_AssigneeGroupId="+ce(i.id)+";"}}function he(){if("Scratch"===y.taskFrom||"Template"===y.taskFrom){var t=localStorage.getItem("midtierUrl"),a=localStorage.getItem("homeServer"),n="Task",i="SV_Create",o="TASK";if("Scratch"===y.taskFrom){var r="SHR:SV_TicketCreate/SV_TicketCreate";a?e.formSrc=O.trustAsResourceUrl(t+"/pwa/#/forms/"+a+"/"+r+"?origin="+window.location.origin+"&targetForm="+n+"&targetView="+i+"&context="+o+"&mode=GET"):e.formSrc=O.trustAsResourceUrl(t+"/pwa/#/goto/"+r+"?origin="+window.location.origin+"&targetForm="+n+"&targetView="+i+"&context="+o+"&mode=GET")}else{var r="TMS:TemplateSelection/SV_TMS_TemplateSearch";a?e.formSrc=O.trustAsResourceUrl(t+"/pwa/#/forms/"+a+"/"+r+"?origin="+window.location.origin+"&context="+o+"&mode=GET"):e.formSrc=O.trustAsResourceUrl(t+"/pwa/#/goto/"+r+"?origin="+window.location.origin+"&context="+o+"&mode=GET")}}}function ye(){"true"===a.isSrcLiveChat&&window.opener&&window.opener.postMessage({event:r.DRAFT_TICKET_CLOSED},window.location&&window.location.origin)}"false"==l.localStorage.getItem("sessionActive")&&o.$broadcast(s.SESSION_EXPIRED),e.id=t.params.id?t.params.id:null,e.isLastStateDraft=!1,(a.isSrcLiveChat||a.isSrcExt)&&(e.isLastStateDraft=!0),he(),i.getMetadataByType("global").then(function(a){var n="T"===a.configurationParameters["Enable-Progressive-Views"]||"true"===a.configurationParameters["Enable-Progressive-Views"];n="T"!==localStorage.getItem("overridePV")&&n;var i="true"===a.configurationParameters.enableReleasePV;if(n){if(n&&i===!1&&_.includes(["releasePV","createReleasePV","activityPV"],t.current.name)){var o=t.current.name.replace("PV","");e.id?t.go(o,{id:e.id}):t.go(o)}}else if("pwaDraftIncident"===t.current.name)t.go("incident");else if("pwaDraftWorkorder"===t.current.name)t.go("workorder");else{var o=t.current.name.replace("PV","");e.id?t.go(o,{id:e.id}):t.go(o)}})["catch"](function(e){e&&v.error({text:e.data.error,clear:!1})}),e.ccsEnabledForPWA=!0,e.isSrcLiveChat="true"===a.isSrcLiveChat,e.errorQuickCreate=a.error,e.isFormDirty=!1;var Ee,ve,Te,Se,Ce,_e,Oe=[{createEvent:"createIncidentPV",openEvent:"openIncident",name:"incidentPV",relatedTicketNavigation:"draftIncident"},{createEvent:"createWorkorderPV",openEvent:"openWorkorder",name:"workorderPV"},{createEvent:"",openEvent:"openRequest",name:"request"},{createEvent:"createChange",openEvent:"openChange",name:"changePV",relatedTicketNavigation:"drafteChange"},{createEvent:"createKnownerror",openEvent:"openKnownError",name:"knownerrorPV",relatedTicketNavigation:"draftKnownerror"},{createEvent:"createProblem",openEvent:"openProblem",name:"problemPV",relatedTicketNavigation:"draftProblem"},{createEvent:"createRelease",openEvent:"openRelease",name:"release"},{createEvent:"",openEvent:"openTask",name:"taskPV"},{createEvent:"",openEvent:"openOutage",name:"outage"},{createEvent:"createKnowledge",openEvent:"openKnowledgeArticle",name:"knowledge",relatedTicketNavigation:"createKnowledge"},{createEvent:"createAsset",openEvent:"openAsset",name:"assetPV"},{createEvent:"createActivity",openEvent:"openActivity",name:"activity"},{createEvent:"",openEvent:"openSBERequest",name:"sberequest"},{createEvent:"Broadcast",openEvent:"Broadcast",name:"broadcast"}];$(document).on("focusout",function(){E(function(){document.activeElement instanceof HTMLIFrameElement&&(Se=document.getElementsByClassName("open"),Se.length?(Ce=Se[0].getElementsByClassName("dropdown-toggle"),Ce.length&&(Ce=Ce[0],Ce.click())):(Se=document.getElementsByClassName("search__close"),Se.length&&(_e=Se[0],_e.click())))},0)}),Te=e.$on("$stateChangeStart",function(t,a,n){e.reference||n.isNewSearch||(e.reference="stateChange",D(t,a,n))}),window.onmessage=P,e.getContextType=function(){return e.context.ticketType||e.context.type},window.addEventListener("beforeunload",function(e){e&&ye()})}])}(),function(){angular.module("searchModule").controller("SearchBarController",["$scope","searchModel","$state","$timeout","$location","metadataModel","configurationModel","searchService","userModel","utilityFunctions",function(e,t,a,n,i,o,r,s,l,c){function d(e){return e?e.trim():""}l.isAccessibleUser||setTimeout(function(){document.getElementById("globalSearchBox").focus()}),e.isSearchBarActive=!1;var u=r.get("search.targetAreas");e.searchMetadata={targetAreas:u},e.searchText=a.params.searchText||"",a.params.searchCriteria?e.selectedTargetArea=_.find(u,{types:a.params.searchCriteria}):e.selectedTargetArea=_.find(u,{selected:!0}),e.changedTargetArea=s.targetArea,e.$watch("changedTargetArea",function(t){t.selectedTargetArea&&(e.selectedTargetArea=t.selectedTargetArea)},!0),e.skipWildcardInGlobalSearch="true",e.wildCardEntered=!1;var p=o.getMetadataByType(EntityVO.TYPE_GLOBAL);p.then(function(t){t.configurationParameters&&"true"===t.configurationParameters.skipWildcardInGlobalSearch?e.skipWildcardInGlobalSearch=t.configurationParameters.skipWildcardInGlobalSearch:e.skipWildcardInGlobalSearch="false",t.configurationParameters&&"true"===t.configurationParameters.disableTypeaheadInGlobalSearch?e.disableTypeaheadInGlobalSearch=!0:e.disableTypeaheadInGlobalSearch=!1}),e.wildCardValidation=function(){if("true"===e.skipWildcardInGlobalSearch){e.wildCardEntered=!1;for(var t=0,a=0;a<e.searchText.length;a++){var i=e.searchText.charAt(a);if("%"!==i){e.wildCardEntered=!1;break}t+=1,e.wildCardEntered=!0}e.searchText=e.searchText.substr(t),n.cancel(e.timerPromise),e.timerPromise=n(function(){angular.element("#globalSearchBox").siblings(".tooltip").fadeOut("slow")},4e3)}},e.changeSearchCriteria=function(t){e.targetArea=t;var a=i.path();e.searchText&&a.startsWith("/search")&&e.moveToSearchState()},e.activateSearchBar=function(){e.isSearchBarActive=!0},e.deactivateSearchBar=function(){n(function(){e.isSearchBarActive=!1},500)},e.moveToSearchState=function(t){var n,i;t?(e.searchText=t,n=d(t)):n=d(e.searchText),i=e.selectedTargetArea?e.selectedTargetArea.types:null,n&&i&&(e.isSearchBarActive=!1,s.setSelectedTargetArea(e.selectedTargetArea),e.deactivateSearchBar(),a.go("search",{searchText:n,searchCriteria:i,isNewSearch:!0},{reload:!0}))},e.selectSuggestedResult=function(t){e.moveToSearchState(t&&c.decodeHTML(t))},e.getSuggestedSearchResults=function(a){if(!e.disableTypeaheadInGlobalSearch&&!_.startsWith(a,"%"))return e.isSearchBarActive=!0,t.getSuggestedSearchResults(a)}}])}(),function(){angular.module("searchModule").controller("SearchController",["$rootScope","$scope","searchModel","$state","$filter","i18nService","events","configurationModel","searchService","metadataModel","authModel","browser",function(e,t,a,n,i,o,r,s,l,c,d,u){function p(e,a){return function(){e===C&&(a===O.HKM?(t.loadingHKMItems=!1,m(t.searchModel.hkmSearchResults)):a===O.SBE?(t.loadingSBEItems=!1,m(t.searchModel.sbeSearchResults)):(t.loadingGlobalItems=!1,m(t.searchModel.globalSearchResults)))}}function m(e){var a;t.isSearchDataLoading=t.loadingGlobalItems||!1,t.searchResults&&t.searchResults.items&&t.searchResults.items.length?(a=t.searchResults.items).push.apply(a,e.items):e&&void 0!==e.items&&(t.searchResults=e),!s.isServerApplicationEnabled(EntityVO.TYPE_SBEREQUEST)&&t.searchResults&&t.searchResults.items&&t.searchResults.items.length>0&&(_.remove(t.searchResults.items,{searchCategory:"sberequest"}),console.error("There is a problem with enableSbeIntegration")),_.forEach(t.searchResults.items,function(e){e.displayLimit=t.defaultDisplayLimit,t.selectedCategory&&(e.searchCategory===t.selectedCategory.name?(e.displayLimit=e.totalCount,t.selectedCategory.totalCount=e.totalCount):e.active=!1)}),t.searchResults.items&&t.searchResults.items.length&&h()}function f(e,t){if(0!==e){var a=new Date,n=a.getTime();a.setDate(a.getDate()-e);var i=a.getTime();t.modifiedDateRange={startDate:i,endDate:n}}}function g(){t.searchResults={},t.searchResults.items=[],t.defaultDisplayLimit=4,t.searchResultActiveCount=0,t.isAllResultsDisplaying=!0,t.searchModel=a,t.searchText=n.params.searchText,t.comaroundEnabled=s.comaroundEnabled,n.params&&n.params.isNewSearch&&t.clearAllFilters(),t.$watchCollection("searchModel.selectedFilters",function(){t.searchModel.filterCriteria=y(t.searchModel.selectedFilters);var e=_.cloneDeep(t.searchModel.filterCriteria),a=l.getSelectedTargetArea();e&&e.types&&e.types.length||!a||(e.types=a.types),E(),e&&e.types&&t.comaroundEnabled&&_.includes(t.selectedTargetArea.types,EntityVO.FILTER_TYPE_KNOWLEDGE)&&(_.includes(e.types,EntityVO.FILTER_TYPE_KNOWLEDGE)||e.types.push(EntityVO.FILTER_TYPE_KNOWLEDGE),1===e.types.length&&(t.showFilters=!1)),t.getGlobalSearchResults(t.searchText,e)})}function h(){t.searchResultActiveCount=0;var e=_.chain(t.searchResults.items).filter("active").find(function(e){return t.searchResultActiveCount=e.results.length,e.results.length}).value().results[0];t.isMobile||n.current.name&&n.current.name.includes("search")&&t.selectItem(e)}function y(t){var a={};return _.forEach(t,function(n){var i=n.criteria,o=_.isArray(i.value),r=i.name;"date"===n.type&&_.forEach(i.defaultValues,function(t,a){i.value[a]=e.$eval(t,{moment:moment})}),a[r]?o?a[r]=_.union(a[r],i.value):(t.splice(_.findIndex(t,{name:n.name}),1),a[r]=i.value):a[r]=i.value}),a}function E(){t.searchResults&&t.searchResults.items&&(t.searchResults.items=[])}var v=s.get("search.targetAreas"),T=[],S=l.getSelectedTargetArea(),C=0,O={HKM:"HKM",GLOBAL:"GLOBAL",SBE:"SBE"};t.showFilters=!0,t.comaroundEnabled=!1,t.isMobile=u.isMobile,t.loadingSBEItems=!1,t.restrictDWPCTicketsForNoOfDays=0,c.getMetadataByType("global").then(function(e){t.searchMetadata={targetAreas:v},t.loadingMoreItems=!1,t.loadingGlobalItems=!1,t.loadingHKMItems=!1,t.searchText=n.params.searchText||"",n.params.searchCriteria?t.selectedTargetArea=_.find(v,{types:n.params.searchCriteria}):S?t.selectedTargetArea=_.find(v,{types:S.types}):t.selectedTargetArea=_.find(v,{selected:!0}),g()}),t.changeSearchCriteria=function(e){var a=e?e.types:null,n=t.searchText;if(n&&a){l.setSelectedTargetArea(e),s.comaroundEnabled&&1===a.length&&a[0]===EntityVO.TYPE_KNOWLEDGE?(t.showFilters=!1,t.selectedItem={}):t.showFilters=!0;var i={types:a};t.clearAllFilters(),t.$emit(r.REFRESH_SEARCH_FILTERS),E(),t.getGlobalSearchResults(n,i)}},t.getGlobalSearchResults=function(e,i){if(t.isSearchDataLoading=!0,C++,!e||o.getByteLength(e)<3)t.isSearchDataLoading=!1;else{if(i=i||{},i.types||(i.types=n.params.searchCriteria?n.params.searchCriteria:T=_.find(v,{selected:!0}).types),i=_.cloneDeep(i),s.comaroundEnabled){if(_.includes(i.types,EntityVO.TYPE_KNOWLEDGE)||_.includes(i.types,"all")){t.loadingHKMItems=!0;var r=p(C,O.HKM);a.getHKMSearchResults(e,!0)["finally"](r)}else t.loadingHKMItems=!1;_.includes(i.types,EntityVO.TYPE_KNOWLEDGE)&&_.remove(i.types,function(e){return e===EntityVO.TYPE_KNOWLEDGE}),_.includes(i.types,"all")&&(i.types=[EntityVO.FILTER_TYPE_ASSET,EntityVO.FILTER_TYPE_PERSON,EntityVO.FILTER_TYPE_TICKETS])}if(i.types&&i.types.length){t.loadingGlobalItems=!0;var l=s.isServerApplicationEnabled(EntityVO.TYPE_SBEREQUEST),c=!1;_.includes(i.types,EntityVO.TYPE_SBEREQUEST)&&(c=!0,_.remove(i.types,function(e){return e===EntityVO.TYPE_SBEREQUEST}));var d=p(C,O.GLOBAL),u=p(C,O.SBE);a.getGlobalSearchResults(e,i,!0)["finally"](d),l&&(c||_.includes(i.types,"all")||_.includes(i.types,"tickets"))&&(i.types=["sberequest"],t.loadingSBEItems=!0,t.restrictDWPCTicketsForNoOfDays=s.restrictDWPCTicketsForNoOfDays,i.modifiedDateRange||f(t.restrictDWPCTicketsForNoOfDays,i),a.getGlobalSearchResults(e,i,!0)["finally"](u))}else t.loadingGlobalItems=!1}},t.triggerListLimit=function(e,a){a.displayLimit===t.defaultDisplayLimit?a.displayLimit=e.length:a.displayLimit=t.defaultDisplayLimit},t.selectItem=function(e){t.selectedItem=e,t.selectedItem.type===EntityVO.TYPE_ASSET&&(t.assetIdsObject={assetId:e.additionalInformation.reconciliationId,assetClassId:e.additionalInformation.classId}),s.get("pwaEnabledTickets.tickets").indexOf(e.type)>=0?c.getMetadataByType("global").then(function(a){var i="T"===a.configurationParameters["Enable-Progressive-Views"]||"true"===a.configurationParameters["Enable-Progressive-Views"];if(i="T"!==localStorage.getItem("overridePV")&&i,i&&localStorage.getItem("midtierUrl"))if("asset"===e.type)if(t.isMobile)n.go(e.type+"PV",{assetId:e.additionalInformation.reconciliationId,assetClassId:e.additionalInformation.classId});else{var o=e.additionalInformation.reconciliationId+"|"+e.additionalInformation.classId;n.go("search."+e.type+"PV",{guid:o,displayId:o})}else t.isMobile?n.go(e.type+"PV",{id:e.id}):n.go("search."+e.type+"PV",{guid:e.id,displayId:e.displayId});else n.go("search."+e.type,{},{location:!1})}):(e.type==EntityVO.TYPE_RELEASE||e.type==EntityVO.TYPE_ACTIVITY)&&"true"===s.enableReleasePV&&s.isPWAEnabled&&"T"!==localStorage.getItem("overridePV")&&localStorage.getItem("midtierUrl")?t.isMobile?n.go(e.type+"PV",{id:e.id}):n.go("search."+e.type+"PV",{guid:e.id,displayId:e.displayId}):t.isMobile?n.go(e.type,{id:e.id}):n.go("search."+e.type,{},{location:!1})},t.$on(r.SET_PREVIEW_ITEM,function(e,a){a&&a.id&&a.type&&(t.selectedItem=a)}),t.selectCategory=function(e){"sberequest"===e?t.selectedCategory=t.searchModel.sbeConfig:t.selectedCategory=t.searchModel.categoriesConfig[e],_.forEach(t.searchResults.items,function(a){a.searchCategory!==e?a.active=!1:(a.displayLimit=a.totalCount,t.selectedCategory.totalCount=a.totalCount)}),h(),t.isAllResultsDisplaying=!1,T===t.searchModel.filterCriteria.types&&(t.searchModel.filterCriteria.types=t.selectedCategory.types),s.comaroundEnabled&&e===EntityVO.FILTER_TYPE_KNOWLEDGE&&(t.showFilters=!1),t.$broadcast(r.ELLIPSIS_EVENT)},t.loadMoreCategoryItems=function(){if(!t.loadingMoreItems&&!t.isAllResultsDisplaying){var e=_.find(t.searchResults.items,function(e){return t.selectedCategory.name===e.searchCategory&&e.totalCount>(e.chunkIndex+1)*a.chunkSize});if(e){t.loadingMoreItems=!0;var n=_.clone(t.searchModel.filterCriteria);_.isEmpty(n)||!n.types?n.types=t.selectedCategory.types:n.types=_.intersection(t.selectedCategory.types,n.types),s.comaroundEnabled&&_.includes(n.types,EntityVO.TYPE_KNOWLEDGE)?a.loadMoreHKMSearchResults(t.searchText,e.nextChunkIndex,!0)["finally"](function(){var e=_.find(t.searchResults.items,function(e){return e.searchCategory===EntityVO.FILTER_TYPE_KNOWLEDGE}),a=t.searchModel.hkmSearchResults.items[0];e.results=a.results,e.chunkIndex=a.chunkIndex,e.nextChunkIndex=a.nextChunkIndex,e.totalCount=a.totalCount,t.loadingMoreItems=!1}):(t.restrictDWPCTicketsForNoOfDays=s.restrictDWPCTicketsForNoOfDays,1===n.types.length&&_.includes(n.types,EntityVO.TYPE_SBEREQUEST)&&!n.modifiedDateRange&&f(t.restrictDWPCTicketsForNoOfDays,n),a.loadMoreGlobalSearchResults(t.searchText,n,e.nextChunkIndex,!0)["finally"](function(){s.comaroundEnabled&&_.forEach(t.searchModel.globalSearchResults.items,function(e){var a=_.find(t.searchResults.items,function(t){return t.searchCategory===e.searchCategory});a.results=e.results,a.chunkIndex=e.chunkIndex,a.nextChunkIndex=e.nextChunkIndex,a.totalCount=e.totalCount}),t.loadingMoreItems=!1}))}}},t.closeCategory=function(){t.selectedCategory&&(t.searchModel.filterCriteria.types&&(t.searchModel.filterCriteria.searchCompanies||t.searchModel.filterCriteria.createDateRange||t.searchModel.filterCriteria.modifiedDateRange||t.searchModel.filterCriteria.statuses)&&(delete t.searchModel.filterCriteria.types,_.forEach(t.searchModel.selectedFilters,function(e){e.category&&t.removeFilter(e)}),t.getGlobalSearchResults(n.params.searchText,t.searchModel.filterCriteria)),delete t.searchModel.filterCriteria.types,t.selectedCategory=null,t.isAllResultsDisplaying=!0,t.comaroundEnabled&&t.selectedTargetArea.types&&(t.selectedTargetArea.types.length>1||t.selectedTargetArea.types[0]!==EntityVO.FILTER_TYPE_KNOWLEDGE)&&(t.showFilters=!0),_.forEach(t.searchResults.items,function(e){e.active=!0,e.displayLimit=t.defaultDisplayLimit}))},t.openPreviewItemFullDetails=function(){t.selectedItem.type===EntityVO.TYPE_ASSET?n.go(t.selectedItem.type,{assetId:t.assetIdsObject.assetId,assetClassId:t.assetIdsObject.assetClassId}):n.go(t.selectedItem.type,{id:t.selectedItem.id})},t.clearAllFilters=function(){_.forEach(t.searchModel.selectedFilters,function(e){e.active=!1}),t.searchModel.selectedFilters=[],t.selectedCategory=null,t.isAllResultsDisplaying=!0,t.searchModel.filterCriteria={}},t.localizedStatus=function(e){return t.comaroundEnabled?i("i18n")("hkm.status."+e):i("localizeLabel")(e,"status","knowledge")},t.localizedAssetType=function(e){return i("localizeLabel")(e,"assetType","asset")}}])}(),function(){angular.module("searchModule").directive("searchFilter",["events","$timeout","configurationModel","searchModel","personModel","$filter","userModel","systemAlertService","assetService","$rootScope","assetConsoleModel","ticketConsoleModel","knowledgeConsoleModel","utilityFunctions",function(e,t,a,n,i,o,r,s,l,c,d,u,p,m){return{restrict:"E",templateUrl:"views/search/search-filter.html",scope:{config:"=",targetArea:"=?",selectedFilters:"=",label:"@",displayLimit:"=",hidePills:"=",hideCloseicon:"=",searchKeywords:"=",filterConfig:"=",readonlyPresets:"@",consoleMode:"=",consoleType:"=?",isSbIntegrated:"=?"},link:function(f){function g(){var e=[];!f.isSBEFilterEnabled&&_.find(f.selectedFilters,{name:EntityVO.TYPE_SBEREQUEST})?(_.each(f.config,function(t){"types"!==t.name&&"modifiedDateRange"!==t.name&&(t.isHidden=!0,_.each(t.options,function(t){"search"!==t.type&&"custom"!==t.type&&!f.advancedFilterType(t)&&t.active&&e.push(t)}))}),f.isSBEFilterEnabled=!0):f.isSBEFilterEnabled&&!_.find(f.selectedFilters,{name:EntityVO.TYPE_SBEREQUEST})&&(_.each(f.config,function(e){"types"!==e.name&&"modifiedDateRange"!==e.name&&(e.isHidden=!1)}),f.isSBEFilterEnabled=!1),_.each(e,f.addFilter)}f.filterLabelPath=f.consoleMode?"console.filter.name.":"search.filter.name.",f.filterOptionLabelPath=f.consoleMode?"console.filter.optionName.":"search.filter.optionName.",f.ticketTypeFilter=_.find(f.config,{name:"ticketTypes"}),f.assetTypeFilter=_.find(f.config,{name:"assetTypes"}),f.showMeridian=window.showMeridian,angular.isUndefined(f.consoleType)&&(f.consoleType="asset");var h=c.$on(e.REFRESH_SEARCH_FILTERS,function(){f.updateSearchResultFilterGrouping()}),y=null;switch(f.consoleType){case"ticket":y=u;break;case"knowledge":y=p;break;case"asset":y=d}var E=function(e){if("custom"===e.type)if(e.selected){var t=_.findIndex(f.config,{name:"custom"});_.forEach(f.config[t].options,function(t){t.name!==e.name&&(t.selected=!1,t.filters&&(f.searchKeywords=f.searchKeywords.toString().split(",").join(" "),_.forEach(t.filters,function(e){if("keywords"!==e.criteria.name){var t=_.findIndex(f.selectedFilters,{name:e.name});t!==-1&&(f.selectedFilters=_.reject(f.selectedFilters,{name:e.name}),_.forEach(f.config,function(t){if(t.name===e.criteria.name)for(var a in t.options)if(t.options[a].name===e.name)return void("owners"===t.options[a].criteria.name||"products"===t.options[a].criteria.name||"myRegion"!==t.options[a].name&&"region"===t.options[a].criteria.name||"mySiteGroup"!==t.options[a].name&&"siteGroup"===t.options[a].criteria.name||"mySite"!==t.options[a].name&&"sites"===t.options[a].criteria.name?t.options.splice(a,1):t.options[a].active=!1)}))}else"keywords"===e.criteria.name&&(f.searchKeywords=f.searchKeywords.replace(e.name,"").trim())})))}),e.filters&&e.filters.length>0&&(f.searchKeywords=f.searchKeywords.toString().split(",").join(" "),_.forEach(e.filters,function(e){var t=["approvedBy","createdBy","managedBy","owner","supportedBy","usedBy"],a=["me","mySite","mySiteGroup","myRegion"],n=["site","siteGroup","region"];if("keywords"!==e.criteria.name){var i=_.findIndex(f.selectedFilters,function(t){return t.name===e.name&&t.criteria.value===e.criteria.value});i===-1&&(f.selectedFilters.push(e),_.forEach(f.config,function(i){if(i.name===e.criteria.name)if(!e.label&&_.includes(a,e.name)&&(e.label=e.name),i.showLabelInPill&&(e.filterLabel=i.label),"owners"===i.name||"products"===i.name||"me"!==e.name&&_.includes(t,i.name)||!_.includes(a,e.name)&&_.includes(n,i.name))v(i,e);else if(d.advancedFilterType(e)&&_.isPlainObject(e.name)){if("cpu"===e.criteria.name){var o=[];_.forOwn(e.criteria.value[0],function(e){o.push(e)}),e.name=o.join("-")}else if("operatingSystem"===e.criteria.name||"processor"===e.criteria.name){var r=[];_.forOwn(e.criteria.value[0],function(e){r.push(e.value)}),e.name=r.join(", ")}v(i,e)}else _.forEach(i.options,function(t){t.name===e.name?t.active=!0:t.criteria&&_.isEqual(t.criteria,e.criteria)&&(t.active=!0,e.name=t.name)})}))}else if("keywords"===e.criteria.name){var o=f.searchKeywords.indexOf(e.name);o===-1&&(f.searchKeywords+=f.searchKeywords?", "+e.name:e.name)}}))}else f.updateCustomFilterOption(e);else if(e.active){var a=e.filterName||e.criteria.name,n=_.keyBy(f.config,"name"),i=n[a];i&&i.showLabelInPill&&(e.filterName=i.name,e.filterLabel=i.label);var o=_.isArray(e.criteria.value);d.advancedFilterType(e)&&(o=!1),o||_.remove(f.selectedFilters,function(t){if(t.criteria.name===e.criteria.name&&t.name!==e.name)return t.active=!1,!0});var r=_.findIndex(f.selectedFilters,{name:e.name,filterName:e.filterName});r===-1&&f.selectedFilters.push(e)}else f.selectedFilters=_.reject(f.selectedFilters,function(t){return t.name===e.name&&t.filterName===e.filterName||t.criteria.name===e.name});f.updateFilterGrouping()},v=function(e,t){angular.isObject(_.find(e.options,{name:t.name}))||(e.options.push(t),E(_.last(e.options)))};_.each(f.config,function(e){var t=_.find(e.options,"active");t&&!f.hidePills&&(f.selectedFilters=_.uniq(f.selectedFilters.concat(t)))}),f.updateAssetFilterGrouping=function(){var e=_.findIndex(f.config,{name:"assetTypes"});if(e!==-1){var t=_.map(_.filter(f.config[e].options,{active:!0}),"criteriaValue");_.forEach(f.config,function(e){e.assetType&&(e.isHidden=!(1===t.length&&t[0]===e.assetType[0]),e.isHidden&&(_.remove(f.selectedFilters,function(t){return e.name===t.filterName||e.name===t.criteria.name}),e.options&&e.options.length&&e.options[0].criteriaKeys&&d.clearCriteriaKeyValues(null,e.options[0].criteriaKeys))),"assetSubTypes"===e.name&&_.forEach(e.options,function(e){e.isHidden=t&&t.length&&!_.includes(t,e.criteria.typeName),e.isHidden&&(e.active=!1,_.remove(f.selectedFilters,function(t){return e.name===t.name&&e.criteria.typeName===t.criteria.typeName}))})})}},f.updateTicketFilterGrouping=function(){var e=_.findIndex(f.config,{name:"ticketTypes"}),t=_.map(_.filter(f.config[e].options,{active:!0}),"name");_.forEach(f.config,function(e){angular.isUndefined(e.ticketType)||0===t.length||0!==_.intersection(e.ticketType,t).length?(e.isHidden=!1,"statuses"!==e.name&&"priorities"!==e.name||_.forEach(e.options,function(e){e.isHidden=!(0===t.length||0!==_.intersection(e.criteria.ticketTypes,t).length)})):e.isHidden=!0})},f.updateSearchResultFilterGrouping=function(){var e=_.findIndex(f.config,{name:"types"}),t=!0;_.forEach(f.config[e].options,function(e){e.targetAreas.indexOf(f.targetArea.name)===-1?e.isHidden=!0:(t=!1,e.isHidden=!1)}),f.config[e].isHidden=t},f.updateFilterGrouping=function(){"ticket"===f.consoleType?f.updateTicketFilterGrouping():"asset"===f.consoleType&&f.updateAssetFilterGrouping(),angular.isUndefined(f.targetArea)||f.updateSearchResultFilterGrouping()},f.updateFilterGrouping(),f.expandFilterItem=function(e,a){_.forEach(f.config,function(t){t.name!==e.name&&(t.expanded=!1)}),e.expanded=!e.expanded,t(function(){angular.element(a.currentTarget).parent().find("[role=menuitemcheckbox]").first().focus()},0)},f.handleKeydown=function(e,t){32===e.keyCode&&(f.addFilter(t),e.preventDefault(),e.stopPropagation())},f.addFilter=function(e){"custom"!==e.type?e.active=!e.active:"custom"===e.type&&(e.selected=!e.selected),"timeStampRange"!==e.type&&("custom"!==e.type&&e.criteria&&("assetTypes"===e.criteria.name?f.updateAssetFilterGrouping():"ticketTypes"===e.criteria.name&&f.updateTicketFilterGrouping()),E(e))},f.removeFilter=function(e){e.active=!1,_.forEach(f.config,function(t){t.name!==e.criteria.name&&t.name!==e.filterName||(_.forEach(t.options,function(t){t.name===e.name&&(t.active=!1)}),"operatingSystem"!==t.name&&"processor"!==t.name||_.forEach(t.options[0].criteriaKeys,function(e){e.active=!1,e.searchText=""}))}),E(e)},f.updateCustomFilterOption=function(e){e.filters&&e.filters.length>0&&(f.searchKeywords=f.searchKeywords.toString().split(",").join(" "),_.forEach(e.filters,function(e){if("keywords"!==e.criteria.name){var t=_.findIndex(f.selectedFilters,{name:e.name});t!==-1&&(f.selectedFilters=_.reject(f.selectedFilters,{name:e.name}),_.forEach(f.config,function(t){if(t.name===e.criteria.name)for(var a in t.options)if(t.options[a].name===e.name)return void("owners"===t.options[a].criteria.name||"products"===t.options[a].criteria.name||"myRegion"!==t.options[a].name&&"region"===t.options[a].criteria.name||"mySiteGroup"!==t.options[a].name&&"siteGroup"===t.options[a].criteria.name||"mySite"!==t.options[a].name&&"sites"===t.options[a].criteria.name?t.options.splice(a,1):t.options[a].active=!1)}))}else"keywords"===e.criteria.name&&(f.searchKeywords=f.searchKeywords.replace(e.name,"").trim())}))},f.removeCustomFilter=function(t,a){var n=s.modal({title:o("i18n")("common.notification.delete.title"),text:o("i18n")("search.filter.optionName.notification.delete.message"),buttons:[{text:o("i18n")("common.labels.yes"),data:!0},{text:o("i18n")("common.labels.no"),data:!1}]});n.result.then(function(n){n&&(f.updateCustomFilterOption(t),c.$broadcast(e.CI_REMOVE_CUSTOM_FILTER,t,a),a.options=_.reject(a.options,{name:t.name}),r.removeUserPreferences("CIFilter",t),l.removeCIPresetConfiguration(t.name))})},f.applyKeywordFilter=function(e,t){if(t.searchText){var a={name:t.searchText,active:!0,type:"dynamic",criteria:{name:e.name,value:"rack"===e.name?[{id:t.searchText}]:[t.searchText]}};"custom"===e.type&&"customFilter"===t.filterType&&(a.filterType="customFilter"),v(e,a),t.searchText=""}},f.applyRangeFilter=function(e,t){if(!_.isEmpty(t.range)){var a=t.range.min,n=t.range.max;(!t.range.min||t.range.min<0)&&(t.range.min=0,a=t.range.min),(!t.range.max||t.range.max<t.range.min)&&(t.range.max=t.range.min,n=a,0===t.range.max&&(t.range.max=1,n=1));var i={name:a+" - "+n,active:!0,type:"dynamic",range:t.range,criteria:{name:e.name,value:[t.range]}};e.options[0]=i,E(e.options[0])}},f.searchFilterOption=function(e,t,a){e.isSearching=!0;var o=a||{},r=f.$eval(o.selectedSearchMode?o.selectedSearchMode.method:e.method,{searchModel:n,personModel:i,consoleModel:y,parentScope:f.$parent}),s=function(e,t){var a=o.selectedSearchMode?o.selectedSearchMode.fields.key:t.fields.key,n=o.selectedSearchMode?o.selectedSearchMode.fields.value:t.fields.value;if(e.length&&!_.isEmpty(e[0]))return _.map(e,function(e){return{key:e[a],value:f.$eval(t.valueFormat,_.merge({value:_.get(e,n)},e.attributeMap)),companyName:e.attributeMap&&e.attributeMap.companyName?e.attributeMap.companyName:e.companyName,realObject:e}})},l=f.consoleType===EntityVO.TYPE_ASSET;return l&&o.selectedSearchMode&&o.selectedSearchMode.method&&"searchModel.getOrganizationsByText"===o.selectedSearchMode.method?r(t,l).then(function(t){return e.isSearching=!1,s(t,e)}):r(t).then(function(t){if(e.isSearching=!1,t&&t[0])return s(t,e)})},f.searchTextOption=function(e,t){var a={name:t.name,active:!0,type:"dynamic",criteria:{name:e.name,value:[t.searchText]}},n=_.find(f.selectedFilters,{name:t.name});n&&(f.selectedFilters=_.without(f.selectedFilters,n)),f.selectedFilters.push(a)},f.onFilterOptionSelect=function(e,t,a){var n,i=null;"assignedSupportGroups"===e.name||"changeManagerGroup"===e.name||"requestManagerGroups"===e.name?(i=_.cloneDeep(a.realObject),delete i.companyName,delete i.companyAndOrganization):i=a.value,n=_.has(a,"realObject.attributeMap.companyName")?a.key+": "+a.realObject.attributeMap.companyName:_.has(a,"realObject.companyName")?a.key+": "+a.realObject.companyName:_.has(a,"realObject.company.name")?a.key+": "+a.realObject.company.name:a.key,"assignedSupportGroups"!==e.name&&"changeManagerGroup"!==e.name&&"problemCoordinatorGroups"!==e.name&&"releaseCoordinatorGroup"!==e.name&&"requestManagerGroups"!==e.name||(_.has(a,"realObject.companyAndOrganization")?n=a.key+": "+a.realObject.companyAndOrganization:_.has(a,"realObject.attributeMap.companyAndOrganization")&&(n=a.key+": "+a.realObject.attributeMap.companyAndOrganization));var o={name:n,active:!0,type:"dynamic",criteria:{name:e.name,value:[i]}};t.searchText="",v(e,o)},f.applyAdvancedFilterOption=function(e,t,a){var n=e.criteriaKeys?e.criteriaKeys:e.options[0].criteriaKeys;t.active=!t.active;
var i=_.some(n,function(e){return e.active});f.onFilterOptionKeySelect(e,t,a,i)},f.onFilterOptionKeySelect=function(e,t,a,n){var i={active:n,type:"dynamic",criteria:{name:e.name}},o=[],r={},s=e.criteriaKeys?e.criteriaKeys:e.options[0].criteriaKeys;if(a&&(t.selectedValue=a.value,t.searchText=a.key,_.isEmpty(a.value.categorizations)||(t.selectedValue=t.searchText=a.value.categorizations[0].tiers.productName)),t.searchText||(t.active=!1),_.forEach(s,function(e){r[e.name]={operator:e.selectedOperator.id,value:"search"===e.type?e.selectedValue:e.searchText},r[e.name].value&&e.active?o.push(r[e.name].value):delete r[e.name]}),_.isEmpty(r)){var l=_.find(f.selectedFilters,{filterName:e.name});return void(l&&(l.active=!1,E(l)))}i.criteria.value=[r],i.name=o.join(", "),E(i)},f.datePickerOptions={formatYear:"yy",startingDay:a.getWeekStartingDay(),"show-weeks":!1,"format-day":"d",minDate:moment().year(1970).month(0).date(2),maxDate:moment().year(2038).month(0).date(18)},f.openDatePicker=function(e,t){e&&(e.preventDefault(),e.stopPropagation()),t.isOpen=!0},f.closeDatePickers=function(e){e.startDatePicker.isOpen=!1,e.endDatePicker.isOpen=!1},f.onDateRangeSubmit=function(e,t,a){t.active=!1;var n=t.startDatePicker.date.getTime(),i=t.endDatePicker.date.getTime();c.timezone&&(n=m.convertToUserPreferenceTimezone(n,c.timezone).getTime(),i=m.convertToUserPreferenceTimezone(i,c.timezone).getTime());var r={name:o("datePreConfigTimezone")(n,"mediumDate")+" "+o("datePreConfigTimezone")(n,"shortTime")+" - "+o("datePreConfigTimezone")(i,"mediumDate")+" "+o("datePreConfigTimezone")(i,"shortTime"),active:!0,type:"dynamic"};"custom"===e.type&&"customFilter"===t.filterType&&(r.filterType="customFilter"),_.isUndefined(f.targetArea)?r.criteria={name:t.criteria.name,type:"date",value:[{start:n,end:i}]}:r.criteria={name:t.criteria.name,value:{startDate:n,endDate:i}};var s=_.find(e.options,{name:r.name});angular.isObject(s)?(s.active=!0,E(s)):(e.options.push(r),E(r))},f.advancedFilterType=function(e){return d.advancedFilterType(e)},f.$watch("selectedFilters",function(){if(f.selectedFilters&&f.selectedFilters.length)_.forEach(f.selectedFilters,function(e){var t=_.findIndex(f.config,{name:"custom"});t>0&&f.config[t].options&&_.forEach(f.config[t].options,function(t){if(t.selected){var a=_.find(t.filters,function(a){if(a===e)return t});a||(t.selected=!1)}})});else{var e=_.findIndex(f.config,{name:"custom"});e>0&&f.config[e].options&&_.forEach(f.config[e].options,function(e){e.selected=!1})}f.isSbIntegrated&&g()},!0),f.$on(e.PRESET_REMOVE_FILTER,function(e,t){f.removeFilter(t.filterOption)}),f.$on("$destroy",function(){h()})}}}])}(),function(){angular.module("searchModule").filter("searchSuggestion",function(){return function(e,t){var a=e.indexOf(t);return a>=0?e.replace(t,'<span class="suggested-results__match">'+t+"</span>"):e}}).filter("highlightSearchResult",function(){return function(e){return e.replace(/\[[^[]+?\]/gi,function(e){return'<span class="searched-results__highlight">'+e.replace("[","").replace("]","")+"</span>"})}}).filter("removeSearchTags",function(){return function(e){return e.replace(/[\[\]]/gi,"")}}).filter("highlightWord",function(){return function(e,t){if(t){var a=new RegExp(t,"g");return e.replace(a,'<span class="searched-results__highlight">'+t+"</span>")}return e}})}(),function(){angular.module("searchModule").factory("searchModel",["configurationModel","permissionModel","$rootScope","searchService","$q","roles","userModel","metadataModel","assetService","systemAlertService",function(e,t,a,n,i,o,r,s,l,c){function d(a){var n={};u.filterConfig=e.get("search.filter"),a&&a.accessRestrictions&&a.accessRestrictions.length<=1&&_.remove(u.filterConfig,{name:"searchCompanies"}),e.isServerApplicationEnabled(EntityVO.TYPE_SERVICEREQUEST)||(n=_.keyBy(u.filterConfig,"name"),n.types.options=_.reject(n.types.options,function(e){return e.name===EntityVO.TYPE_SERVICEREQUEST})),e.isServerApplicationEnabled(EntityVO.TYPE_WORKORDER)||(n=_.keyBy(u.filterConfig,"name"),n.types.options=_.reject(n.types.options,function(e){return e.name===EntityVO.TYPE_WORKORDER})),e.isServerApplicationEnabled(EntityVO.TYPE_KNOWLEDGE)&&t.hasRole(o.ITSM_KNOWLEDGE_USER_ROLE)&&!e.comaroundEnabled||(n=_.keyBy(u.filterConfig,"name"),n.types.options=_.reject(n.types.options,function(e){return e.name===EntityVO.TYPE_KNOWLEDGE})),t.hasRole(o.ITSM_AGENT_ROLE)||(n=_.keyBy(u.filterConfig,"name"),n.types.options=_.reject(n.types.options,function(e){return _.includes([EntityVO.TYPE_INCIDENT,EntityVO.TYPE_SERVICEREQUEST,EntityVO.TYPE_WORKORDER],e.name)})),e.isServerApplicationEnabled(EntityVO.TYPE_CHANGE)&&t.hasRole(o.ITSM_CHANGE_USER_ROLE)||(n=_.keyBy(u.filterConfig,"name"),n.types.options=_.reject(n.types.options,function(e){return e.name===EntityVO.TYPE_CHANGE})),e.isServerApplicationEnabled(EntityVO.TYPE_RELEASE)&&t.hasRole(o.ITSM_RELEASE_USER_ROLE)||(n=_.keyBy(u.filterConfig,"name"),n.types.options=_.reject(n.types.options,function(e){return e.name===EntityVO.TYPE_RELEASE||e.name===EntityVO.TYPE_ACTIVITY})),t.hasRole(o.ITSM_AGENT_ROLE)||t.hasRole(o.ITSM_CHANGE_USER_ROLE)||(n=_.keyBy(u.filterConfig,"name"),n.types.options=_.reject(n.types.options,function(e){return e.name===EntityVO.TYPE_TASK})),e.isServerApplicationEnabled(EntityVO.TYPE_KNOWNERROR)&&t.hasRole(o.ITSM_PROBLEM_USER_ROLE)||(n=_.keyBy(u.filterConfig,"name"),n.types.options=_.reject(n.types.options,function(e){return e.name===EntityVO.TYPE_KNOWNERROR})),e.isServerApplicationEnabled(EntityVO.TYPE_PROBLEM)&&t.hasRole(o.ITSM_PROBLEM_USER_ROLE)||(n=_.keyBy(u.filterConfig,"name"),n.types.options=_.reject(n.types.options,function(e){return e.name===EntityVO.TYPE_PROBLEM})),e.isServerApplicationEnabled(EntityVO.TYPE_SBEREQUEST)&&t.hasRole(o.ITSM_SBE_USER_ROLE)||(u.isSBEIntegrationEnabled=!1,n=_.keyBy(u.filterConfig,"name"),n.types.options=_.reject(n.types.options,function(e){return e.name===EntityVO.TYPE_SBEREQUEST})),u.isFilterConfigLoaded=!0}var u={siteCache:{},groupsCache:{},SupportOrganizationsCache:{},approverSupportOrganizationsCache:{},approverGroupsCache:{},allGroups:null},p=null;return u.globalSearchResults=[],u.hkmSearchResults=[],u.smartSearchResults=[],u.sbeSearchResults=[],u.selectedFilters=[],u.filterCriteria={},u.filterConfig={},u.categoriesConfig=e.get("search.categories"),u.sbeConfig={name:"sberequest",totalCount:0,types:["sberequest"]},u.chunkSize=50,u.companyChunkSize=80,u.siteChunkSize=100,u.organizationChunkSize=80,u.supportGroupChunkSize=80,u.regionChunkSize=80,u.locationSiteChunkSize=80,u.departmentChunkSize=80,u.siteGroupChunkSize=80,u.supportPersonChunkSize=80,u.inventoryChunkSize=80,u.isFilterConfigLoaded=!1,u.isSBEIntegrationEnabled=!0,u.useChunkingForOperatingCompanies=!0,u.init=function(){s.getMetadataByType(EntityVO.TYPE_GLOBAL).then(function(){e.companyChunkSize&&(u.companyChunkSize=e.companyChunkSize),e.organizationChunkSize&&(u.organizationChunkSize=e.organizationChunkSize),e.supportGroupChunkSize&&(u.supportGroupChunkSize=e.supportGroupChunkSize),e.supportPersonChunkSize&&(u.supportPersonChunkSize=e.supportPersonChunkSize),e.disableCollisionManagement&&(u.disableCollisionManagement=e.disableCollisionManagement),e.disableImpactAnalysis&&(u.disableImpactAnalysis=e.disableImpactAnalysis),e.locationSiteChunkSize&&(u.locationSiteChunkSize=e.locationSiteChunkSize)}),r.getFullCurrentUserData().then(function(e){d(e)})},u.runSmartSearch=function(e){return n.getSmartSearchResults(e).then(function(e){u.smartSearchResults=e})},u.getSuggestedSearchResults=function(e){return n.getSuggestedSearchResults(e).then(function(e){return u.suggestedSearchResults=e,e})},u.getGlobalSearchResults=function(e,t,a){return u.loadMoreGlobalSearchResults(e,t,0,a)},u.loadMoreGlobalSearchResults=function(t,a,o,r){var s={search_text:t,chunk_index:o,suggest_search:!(!r||r!==!0)&&r,chunk_size:u.chunkSize};a=_.cloneDeep(a),e.comaroundEnabled&&_.includes(a.types,EntityVO.TYPE_KNOWLEDGE)&&_.remove(a.types,function(e){return e===EntityVO.TYPE_KNOWLEDGE});var l=a.types.length?n.getGlobalSearchResults(s,a):i.when(1);return l["catch"](function(e){console.error("Search failure: "+JSON.stringify(e))}).then(function(e){o?_.forEach(e.items,function(e){var t=_.find(u.globalSearchResults.items,function(t){return t.searchCategory===e.searchCategory}),a=_.find(u.sbeSearchResults.items,function(t){return t.searchCategory===e.searchCategory});t?(t.results=_.union(t.results,e.results),t.chunkIndex=e.chunkIndex,t.nextChunkIndex=e.nextChunkIndex,t.totalCount=e.totalCount):a&&(a.results=_.union(a.results,e.results),a.chunkIndex=e.chunkIndex,a.nextChunkIndex=e.nextChunkIndex,a.totalCount=e.totalCount)}):e&&e.items.length>0&&(e&&e.items&&1==e.items.length&&e.items[0].searchCategory&&"sberequest"==e.items[0].searchCategory?u.sbeSearchResults=e:u.globalSearchResults=e)})},u.getHKMSearchResults=function(e,t){return u.loadMoreHKMSearchResults(e,0,t)},u.loadMoreHKMSearchResults=function(e,t,a){var i={chunk_index:t,suggest_search:!(!a||a!==!0)&&a,chunk_size:u.chunkSize},o={search_text:e};return n.getHKMRecommendedKA(i,o).then(function(e){t?_.forEach(e.items,function(e){var t=_.find(u.hkmSearchResults.items,function(t){return t.searchCategory===e.searchCategory});t&&(t.results=_.union(t.results,e.results),t.chunkIndex=e.chunkIndex,t.nextChunkIndex=e.nextChunkIndex,t.totalCount=e.totalCount)}):u.hkmSearchResults=e})},u.getFoundationRegionsByText=function(e){var t={type:"region",searchText:e};return n.getFoundationItems(t).then(function(e){return e.foundationItems})},u.getFoundationSiteGroupsByText=function(e){var t={type:"siteGroup",searchText:e};return n.getFoundationItems(t).then(function(e){return e.foundationItems})},u.getFoundationSitesByText=function(e){var t={type:"site",searchText:e};return n.getFoundationItems(t).then(function(e){return e.foundationItems})},u.getFoundationSitesObjectByText=function(e){var t={type:"site",searchText:e};return n.getFoundationItems(t).then(function(e){return e})},u.getSitesByText=function(e){return n.getSitesByText(e)},u.getSitesObjectByText=function(e){return n.getSitesObjectByText(e)},u.getSitesByTextAndCompany=function(e,t){return n.getSitesByTextAndCompany(e,t)},u.getOrganizationsByText=function(e,t,a){return n.getOrganizationsByText(e,a?a:u.organizationChunkSize,t)},u.getOrganizationsByCompany=function(e,t){return e?n.getOrganizationsByCompany(e,t).then(function(e){return e}):i.when({})},u.getDepartmentsByCompany=function(e,t){return e?n.getDepartmentsByCompany(e,t).then(function(e){return e}):i.when({})},u.getSupportGroupsListByText=function(e,t){return e?n.getSupportGroupsList({companyName:e,searchText:t}).then(function(e){return e}):i.when({})},u.getOrganizationsByTextAndCompany=function(e,t,a){return n.getOrganizationsByTextAndCompany(e,t,a?a:u.organizationChunkSize)},u.getSupportOrganizationsByText=function(e,t){return n.getSupportOrganizationsByText(e,t?t:u.organizationChunkSize)},u.getAssigneeSupportOrgByCompany=function(e,t,a,o,r,s,l,c){if(!a&&!o&&!s&&u.SupportOrganizationsCache[e])return i.when({organizations:u.SupportOrganizationsCache[e],exceedsChunkSize:u.exceedsChunkSizeAssigneeOrg});var d,p={companyName:e};return a&&(p.role=a),t&&(d={startIndex:0,chunkSize:t}),o&&(p.customerCompany=o),r&&(p.locationCompany=r),s&&(p.ownerCompany=s),l&&(p.primaryCompany=l),c&&(p.authorCompany=c),n.getAssigneeSupportOrgByCompany(p,d).then(function(t){return a||o||s||(u.SupportOrganizationsCache[e]=t.organizations,u.exceedsChunkSizeAssigneeOrg=t.exceedsChunkSize),t})},u.getSupportOrganizationsByCompany=function(e,t,a,o,r,s,l){if(!e)return i.when({organizations:[],exceedsChunkSize:!1});if(!a&&!o&&!s&&u.SupportOrganizationsCache[e])return i.when({organizations:u.SupportOrganizationsCache[e],exceedsChunkSize:u.exceedsChunkSizeSupportOrg});var c,d={companyName:e};return a&&(d.role=a),t&&(c={startIndex:0,chunkSize:t}),o&&(d.customerCompany=o),r&&(d.locationCompany=r),s&&(d.ownerCompany=s),l&&(d.primaryCompany=l),n.getSupportOrganizationsByCompany(d,c).then(function(t){return a||o||s||(u.SupportOrganizationsCache[e]=t.organizations,u.exceedsChunkSizeSupportOrg=t.exceedsChunkSize),t})},u.getSupportOrganizationsByTextAndCompany=function(e,t,a,i,o,r,s){var l={companyName:t};return i&&(l.customerCompany=i),o&&(l.locationCompany=o),r&&(l.ownerCompany=r),s&&(l.primaryCompany=s),n.getSupportOrganizationsByTextAndCompany(e,l,a).then(function(e){return e})},u.getAssigneeByText=function(e){return n.getAssigneeByText(e)},u.getCompaniesByText=function(e,t,a){var i={chunkInfo:{startIndex:0,chunkSize:t?t:u.companyChunkSize}};return t&&t===-1&&(i={}),a&&(i.searchOptions=a),n.getCompaniesByText(e,i).then(function(e){return e})},u.getListOfCompaniesByText=function(e,t,a){var i={chunkInfo:{startIndex:0,chunkSize:t?t:u.companyChunkSize}};return t&&t===-1&&(i={}),a&&(i.searchOptions=a),n.getCompaniesByText(e,i).then(function(e){return e.companies})},u.getSupportCompaniesByText=function(e,t,a){var i={chunkInfo:{startIndex:0,chunkSize:a?a:u.companyChunkSize}};return t&&(i.searchOptions=t),n.getSupportCompaniesByText(e,i)},u.getAssigneeSupportCompaniesByText=function(e,t,a){return n.getAssigneeSupportCompaniesByText(e,a,t).then(function(e){return e})},u.getOutages=function(e){return n.getOutages(e)},u.getOperatingCompanies=function(e,t){return t&&t===-1&&(u.useChunkingForOperatingCompanies=!1),e&&(e.customerCompany||e.ownerCompany)||!u.operatingCompanies?u.getCompaniesByText(null,t,e).then(function(t){return e&&(e.customerCompany||e.ownerCompany)||(u.operatingCompanies=t.companies,u.exceedsChunkSizeOperatingCompanies=t.exceedsChunkSize),u.useChunkingForOperatingCompanies?t.companies:t}):i.when(u.operatingCompanies).then(function(e){return u.useChunkingForOperatingCompanies?e:{companies:e,exceedsChunkSize:u.exceedsChunkSizeOperatingCompanies}})},u.getSupportCompanies=function(e,t){return u.getSupportCompaniesByText(null,e,t)},u.getAssigneeSupportCompanies=function(e,t){return u.getAssigneeSupportCompaniesByText(null,e,t)},u.getAssigneeSupportGroupsForCompanyAndOrg=function(e,t,a,o,r,s,l,c,d,p){if(!(e||t||r||s||l||d))return a?u.getSupportGroupsForRole(a,p):u.getSupportGroups(p);if(!t&&!a&&!r&&!l&&!d&&u.groupsCache[e])return i.when({supportGroups:u.groupsCache[e],exceedsChunkSize:u.exceedsChunkSizeAssigneeGroup});var m={companyName:e},f={};return t&&(m.organization=t),a&&(m.role=a),o&&(f.chunkInfo={startIndex:0,chunkSize:o}),r&&(m.customerCompany=r),s&&(m.locationCompany=s),l&&(m.ownerCompany=l),c&&(m.primaryCompany=c),d&&(m.authorCompany=d),n.getAssigneeSupportGroupsList(f,m).then(function(n){return t||a||r||l||d||(u.groupsCache[e]=n.supportGroups,u.exceedsChunkSizeAssigneeGroup=n.exceedsChunkSize),n})},u.getAssigneeSupportGroupsForCompanyAndOrgByName=function(e,t,a,i,o,r,s,l,c,d){var u={companyName:e},p={searchText:a};return t&&(u.organization=t),d&&(u.role=d),i&&(p.chunkInfo={startIndex:0,chunkSize:i}),o&&(u.customerCompany=o),r&&(u.locationCompany=r),s&&(u.ownerCompany=s),l&&(u.primaryCompany=l),c&&(u.authorCompany=c),n.getAssigneeSupportGroupsList(p,u).then(function(e){return e})},u.getSupportGroupsForCompanyAndOrg=function(e,t,a,o,r,s,l,c){if(!e)return a?u.getSupportGroupsForRole(a):u.getSupportGroups();if(!t&&!a&&!r&&!l&&u.groupsCache[e])return i.when({supportGroups:u.groupsCache[e],exceedsChunkSize:u.exceedsChunkSizeAssigneeGroup});var d={companyName:e};return t&&(d.organization=t),a&&(d.role=a),o&&(d.chunkInfo={startIndex:0,chunkSize:o}),r&&(d.customerCompany=r),s&&(d.locationCompany=s),l&&(d.ownerCompany=l),c&&(d.primaryCompany=c),n.getSupportGroupsList(d).then(function(n){return t||a||r||l||(u.groupsCache[e]=n.supportGroups,u.exceedsChunkSizeAssigneeGroup=n.exceedsChunkSize),n})},u.getRecommendedSupportGroups=function(e,t,a,i){var o={searchText:t,company:a};return i&&(o.locationCompany=i),n.getRecommendedSupportGroupsList({ticketType:e},o)},u.getSupportGroupsForCompanyAndOrgByName=function(e,t,a,i){var o={companyName:e,searchText:a};return t&&(o.organization=t),i&&(o.chunkInfo={startIndex:0,chunkSize:i}),n.getSupportGroupsList(o)},u.getAffectedBusinessService=function(e){return n.getListOfServiceByText(e).then(function(e){return e})},u.getSupportGroups=function(e){if(u.allGroups)return i.when({supportGroups:u.allGroups,exceedsChunkSize:u.exceedsChunkSizeAssigneeGroup});var t={};return e&&(t.assignmentAvailability=!0),n.getSupportGroupsList(t).then(function(e){return u.allGroups=e.supportGroups,u.groupsCache=_.groupBy(u.allGroups,"companyName"),u.exceedsChunkSizeAssigneeGroup=e.exceedsChunkSize,e})},u.getSupportGroupsForKAShare=function(e){var t={};return e&&(t.chunkInfo={startIndex:0,chunkSize:e}),n.getSupportGroupsList(t).then(function(e){return u.allGroups=e.supportGroups,u.groupsCache=_.groupBy(u.allGroups,"companyName"),u.exceedsChunkSizeAssigneeGroup=e.exceedsChunkSize,e})},u.getSupportGroupsForRole=function(e,t){var a={role:e};return t&&(a.assignmentAvailability=!0),n.getSupportGroupsList(a)},u.getSupportGroupsByText=function(e){return n.getSupportGroupsList({searchText:e})},u.getListOfSupportGroupsByText=function(e){return n.getSupportGroupsList({searchText:e}).then(function(e){return e.supportGroups})},u.getChangeManagerGroupsByText=function(e){return n.getSupportGroupsList({searchText:e,role:"changemanager"}).then(function(e){return e.supportGroups})},u.getChangeCoordinatorGroupsByText=function(e){return n.getSupportGroupsList({searchText:e,role:"changecoordinator"}).then(function(e){return e.supportGroups})},u.getRequestManagerGroupsByText=function(e){return n.getSupportGroupsList({searchText:e,role:"workordermanager"}).then(function(e){return e.supportGroups})},u.getProblemCoordinatorGroupsByText=function(e){return n.getSupportGroupsList({searchText:e,role:"problemcoordinator"}).then(function(e){return e.supportGroups})},u.getReleaseCoordinatorGroupsByText=function(e){return n.getSupportGroupsList({searchText:e,role:"problemcoordinator"}).then(function(e){return e.supportGroups})},u.getApproverSupportCompanies=function(e,t,a){var i={chunkInfo:{startIndex:0,chunkSize:t?t:u.companyChunkSize}};return n.getApproverSupportCompanies(e,i,a)},u.getApproverSupportOrganizations=function(e,t,a,o){if(!t)return i.when([]);if(!e&&u.approverSupportOrganizationsCache[t])return i.when(u.approverSupportOrganizationsCache[t]);var r={companyName:t,role:o&&o===EntityVO.TYPE_RELEASE?"releaseapprover":"changeapprover"},s={startIndex:0,chunkSize:a?a:u.organizationChunkSize};return n.getApproverSupportOrganizations(e,r,s).then(function(a){return e||(u.approverSupportOrganizationsCache[t]=a),a})},u.getApproverSupportGroups=function(e,t,a,o,r){if(!t)return i.when({supportGroups:[],exceedsChunkSize:!1});if(!e&&!a&&u.approverGroupsCache[t])return i.when({supportGroups:u.approverGroupsCache[t],exceedsChunkSize:u.exceedsChunkSizeApproverGroup});var s={companyName:t,role:r&&r===EntityVO.TYPE_RELEASE?"releaseapprover":"changeapprover",chunkInfo:{startIndex:0,chunkSize:o?o:u.supportGroupChunkSize}};return e&&(s.searchText=e),a&&(s.organization=a),n.getSupportGroupsList(s).then(function(n){return e||a||(u.approverGroupsCache[t]=n.supportGroups,u.exceedsChunkSizeApproverGroup=n.exceedsChunkSize),n})},u.getSitesByCompany=function(e){return u.siteCache[e]?i.when({objects:u.siteCache[e],exceedsChunkSize:u.exceedsChunkSizeSite}):n.getSitesByCompany(e).then(function(t){return u.siteCache[e]=t.objects,u.exceedsChunkSizeSite=t.exceedsChunkSize,t})},u.getFilteredOutagesList=function(e,t){return e?n.getFilteredOutagesList(e,t).then(function(e){return e}):i.when({error:"No search filters specified!"})},u.getFilteredSuggestedOutagesList=function(e){var t={relatedCI:!0,unavailabilityStatus:"Latent"===e.timing?["Restored"]:["Scheduled"]};return n.getFilteredOutagesList(t,e).then(function(e){return e})},u.searchCIsRelatedToChangeRequestByCriteria=function(e,t,a){return t&&e?n.searchCIsRelatedToChangeRequestByCriteria(t,e,a):i.when({error:"Missing required params"})},u.searchBusinessServiceByKeyword=function(e){return l.getListOfAssetsByType(e,"Business Service").then(function(e){var t=[];try{t=e[0].items[0].objects}catch(a){console.log(a)}return t})},u.getFoundationSuppliersByText=function(e){var t={type:"company",searchText:e,searchOptions:{companyType:"Supplier"}};return n.getFoundationItems(t).then(function(e){return e.foundationItems})},u.getFoundationManufacturersByText=function(e){var t={type:"company",searchText:e,searchOptions:{companyType:"Manufacturer"}};return n.getFoundationItems(t).then(function(e){return e.foundationItems})},u.removeKnowledgeOptionsIfHKMEnabled=function(t){e.comaroundEnabled&&_.remove(t,function(e){return"tickets"===e.name&&(e.selected=!0),"all"===e.name&&(e.types=["tickets","asset","person"]),"knowledge"===e.name||"ticketKnowledge"===e.name})},u.getHKMUrls=function(){return p?i.when(_.cloneDeep(p)):p=n.getHKMUrls().then(function(e){return p=_.cloneDeep(e),e})["catch"](function(e){c.error({text:e.data.errorCode?i18nService.getLocalizedString("error.unknown"):e.data.error})})},u}])}(),function(){angular.module("searchModule").service("searchService",["$resource","utilityFunctions","configurationModel",function(e,t,a){function n(e){var t=e[0]&&e[0].items||[];return t.forEach(function(e){e.results=e.results.map(function(e){return(new GlobalSearchItemVO).build(e)})}),t}function i(e){var a=[];return _.forEach(e,function(e){a.push(t.escapeHTML(e))}),a}function o(e){var t={items:e[0]&&e[0].items||[],totalCount:0};return _.forEach(t.items,function(e){t.totalCount+=e.totalCount,e.active=!0,e.sortOrder=s[e.searchCategory]||100,e.results=_.map(e.results,function(e){return e=(new GlobalSearchItemVO).build(e),e.additionalInformation.accessMappings&&(e.additionalInformation.accessMappings=(new AccessMappingVO).parseAccessMap(e.additionalInformation.accessMappings)),e})}),t.items=_.sortBy(t.items,"sortOrder"),t}var r=e("/smartit/rest/v2/search",{},{getSmartSearchResults:{url:"/smartit/rest/smartsearch?search_text=:searchText",method:"GET",isArray:!0},getSuggestedSearchResults:{url:"/smartit/rest/globalsearch/suggest/search",method:"GET",isArray:!1,transformResponse:function(e){return{results:angular.fromJson(e)}}},getGlobalSearchResults:{url:"/smartit/rest/globalsearch",method:"POST",headers:{"Content-Type":"application/json"},isArray:!0},getSites:{url:"/smartit/rest/foundation/search/site",method:"GET",isArray:!0},getList:{url:"/smartit/rest/foundation/items",method:"GET",isArray:!0},getAssigneeByText:{url:"/smartit/rest/foundation/items",method:"GET",isArray:!0},getCompaniesByText:{url:"/smartit/rest/foundation/items",method:"GET",isArray:!0},getSupportGroupsList:{url:"/smartit/rest/person/search/supportgroup",method:"GET",isArray:!0},getListOfServiceByText:{url:"/smartit/rest/asset/search",method:"GET",isArray:!0},getOutages:{url:"/smartit/rest/outage/search",method:"GET",isArray:!0},getFilteredOutagesList:{url:"/smartit/rest/outage/search/filter",method:"POST",headers:{"Content-Type":"application/json"},isArray:!0},getFilteredOutagesListMock:{url:"mocks/suggested-outages-list.json",isArray:!0,method:"GET"},searchCIsRelatedToChangeRequestByCriteria:{url:"/smartit/rest/asset/list/get",isArray:!0,method:"POST"},getListForAssignee:{url:"/smartit/rest/foundation/assignment/items",isArray:!0,headers:{"Content-Type":"application/json"},method:"POST"},getAssigneeSupportGroupsList:{url:"/smartit/rest/foundation/assignment/supportgroup",method:"POST",isArray:!0},getRecommendedSupportGroupsList:{url:"/smartit/rest/foundation/recommendation/:ticketType/supportgroup",method:"POST",isArray:!0},getRequestForRelatedTicket:{url:"/smartit/rest/request/search/:id",method:"GET",isArray:!0},getLiveAgentDefaultSupportGroup:{url:"/smartit/rest/foundation/supportgroup/:customerCompany",method:"GET",isArray:!0},getHKMRecommendedKA:{url:"/smartit/rest/knowledge/search",method:"POST",isArray:!0},getHKMUrls:{url:"/smartit/rest/knowledge/hkmurls",method:"GET",isArray:!0}}),s={tickets:1,knowledge:2,asset:3,person:4};this.targetArea={selectedTargetArea:null},this.setSelectedTargetArea=function(e){this.targetArea.selectedTargetArea=e},this.getSelectedTargetArea=function(){return this.targetArea.selectedTargetArea},this.getSmartSearchResults=function(e){return r.getSmartSearchResults({searchText:e}).$promise.then(function(e){return n(e)})},this.getSuggestedSearchResults=function(e){return r.getSuggestedSearchResults({text:e}).$promise.then(function(e){return i(e.results||[])})},this.getGlobalSearchResults=function(e,t){return r.getGlobalSearchResults(e,t).$promise.then(function(e){return o(e)})},this.getHKMRecommendedKA=function(e,t){return r.getHKMRecommendedKA(e,t).$promise.then(function(e){return o(e)})},this.getOrganizationsByText=function(e,t,a){var n={type:"organization",searchText:e,isFromAssetConsole:a};return r.getList(n).$promise.then(function(e){return _.map(e[0].items[0].objects,function(e){return(new OrganizationVO).build(e)})})},this.getOrganizationsByCompany=function(e,t){var a={type:"organization",searchOptions:{companyName:e},searchText:t};return r.getList(a).$promise.then(function(e){var t=_.map(e[0].items[0].objects,function(e){return(new OrganizationVO).build(e)});return{organizations:t,exceedsChunkSize:e[0].items[0].exceedsChunkSize}})},this.getOrganizationsByTextAndCompany=function(e,t){var a={type:"organization",searchText:e,searchOptions:{companyName:t}};return r.getList(a).$promise.then(function(e){var t=_.map(e[0].items[0].objects,function(e){return(new OrganizationVO).build(e)});return{items:t,exceedsChunkSize:e[0].items[0].exceedsChunkSize}})},this.getSupportOrganizationsByText=function(e){var t={type:"supportOrganization",searchText:e};return r.getList(t).$promise.then(function(e){var t=_.map(e[0].items[0].objects,function(e){return(new OrganizationVO).build(e)});return{organizations:t,exceedsChunkSize:e[0].items[0].exceedsChunkSize}})},this.getAssigneeSupportOrgByCompany=function(e,t){var a={type:"supportOrganization"};return t&&(a.chunkInfo=t),r.getListForAssignee(a,e).$promise.then(function(e){var t=_.map(e[0].items[0].objects,function(e){return(new OrganizationVO).build(e)});return{organizations:t,exceedsChunkSize:e[0].items[0].exceedsChunkSize}})},this.getSupportOrganizationsByCompany=function(e,t){var a={type:"supportOrganization",searchOptions:e};return t&&(a.chunkInfo=t),r.getList(a).$promise.then(function(e){var t=_.map(e[0].items[0].objects,function(e){return(new OrganizationVO).build(e)});return{organizations:t,exceedsChunkSize:e[0].items[0].exceedsChunkSize}})},this.getSupportOrganizationsByTextAndCompany=function(e,t){var a={type:"supportOrganization",searchText:e,searchOptions:t};return r.getList(a).$promise.then(function(e){var t=_.map(e[0].items[0].objects,function(e){return(new OrganizationVO).build(e)});return{organizations:t,exceedsChunkSize:e[0].items[0].exceedsChunkSize}})},this.getDepartmentsByCompany=function(e,t){var a={type:"department",searchOptions:{companyName:e},searchText:t};return r.getList(a).$promise.then(function(e){var t=_.map(e[0].items[0].objects,function(e){return(new OrganizationVO).build(e)});return{organizations:t,exceedsChunkSize:e[0].items[0].exceedsChunkSize}})},this.getAssigneeByText=function(e){var t={type:"assignee",searchText:e};return r.getAssigneeByText(t).$promise.then(function(e){return e[0].items[0].objects})},this.getCompaniesByText=function(e,t){var a={type:"company",searchText:e};return _.assign(a,t),r.getCompaniesByText(a).$promise.then(function(e){var t=e[0].items[0];return{companies:t.objects,exceedsChunkSize:t.exceedsChunkSize,totalMatches:t.totalMatches}})},this.getSupportCompaniesByText=function(e,t){var a={type:"supportCompany",searchText:e};return _.assign(a,t),r.getCompaniesByText(a).$promise.then(function(e){return e[0].items[0].objects})},this.getAssigneeSupportCompaniesByText=function(e,t,a){var n={type:"assigneeSupportCompany",searchText:e};return _.assign(n,t),r.getListForAssignee(n,a).$promise.then(function(e){return{objects:e[0].items[0].objects,exceedsChunkSize:e[0].items[0].exceedsChunkSize}})},this.getSupportGroupsList=function(e){return r.getSupportGroupsList(e).$promise.then(function(e){var t=_.map(e[0].items[0].objects,function(e){return(new SupportGroupVO).build(e)});return{supportGroups:t,exceedsChunkSize:e[0].items[0].exceedsChunkSize}})},this.getAssigneeSupportGroupsList=function(e,t){return r.getAssigneeSupportGroupsList(e,t).$promise.then(function(e){var t=_.map(e[0].items[0].objects,function(e){return(new SupportGroupVO).build(e)});return{supportGroups:t,exceedsChunkSize:e[0].items[0].exceedsChunkSize}})},this.getRecommendedSupportGroupsList=function(e,t){return r.getRecommendedSupportGroupsList(e,t).$promise.then(function(e){var t=_.map(e[0].items[0].objects,function(e){return(new SupportGroupVO).build(e)});return{supportGroups:t}})},this.getApproverSupportCompanies=function(e,t,a){var n={searchText:e,type:"approverSupportCompany",searchOptions:{role:a&&a===EntityVO.TYPE_RELEASE?"releaseapprover":"changeapprover"}};return _.assign(n,t),r.getCompaniesByText(n).$promise.then(function(e){return e[0].items[0].objects})},this.getApproverSupportOrganizations=function(e,t,a){var n={type:"approverSupportOrganization",searchOptions:t};return e&&e.length>0&&(n.searchText=e),a&&(n.chunkInfo=a),r.getList(n).$promise.then(function(e){return _.map(e[0].items[0].objects,function(e){return(new OrganizationVO).build(e)})})},this.getFoundationItems=function(e){return r.getList(e).$promise.then(function(e){var t=e[0].items[0];return{foundationItems:t.objects,exceedsChunkSize:t.exceedsChunkSize}})},this.getSitesByText=function(e){return r.getSites({searchText:e}).$promise.then(function(e){return{list:e[0].items[0].objects,exceedsChunkSize:e[0].items[0].exceedsChunkSize}})},this.getSitesObjectByText=function(e){return r.getSites({searchText:e}).$promise.then(function(e){return _.map(e[0].items[0].objects,function(e){return(new SiteVO).build(e)})})},this.getOutages=function(e){return r.getOutages(e).$promise.then(function(e){return _.map(e[0].items[0].objects,function(e){return(new OutageVO).build(e)})})},this.getSitesByCompany=function(e){var t={companyName:e,searchText:"%"};return r.getSites(t).$promise.then(function(e){return e[0].items[0]})},this.getSitesByTextAndCompany=function(e,t){var a={searchText:e,companyName:t};return r.getSites(a).$promise.then(function(e){return{list:e[0].items[0].objects,exceedsChunkSize:e[0].items[0].exceedsChunkSize}})},this.getListOfServiceByText=function(e,t){var a={searchParam:e,company:{name:t},assetType:"Business Service"};return r.getListOfServiceByText(a).$promise.then(function(e){return e[0].items[0].objects})},this.getListObjOfServiceByText=function(e,t){var a={searchParam:e,company:{name:t},assetType:"Business Service"};return r.getListOfServiceByText(a).$promise.then(function(e){return{list:e[0].items[0].objects,exceedsChunkSize:e[0].items[0].exceedsChunkSize}})},this.getFilteredOutagesList=function(e,t){var a={relatedCI:!1,searchText:"",ciNames:"",unavailabilityType:[],unavailabilityStatus:[],scheduledDate:[]},n={};t&&t.id&&t.type&&(n.attributeMap={id:t.id,ticketType:t.type}),_.each(a,function(t,a){e[a]&&(n[a]=e[a])}),n.ciNames&&n.relatedCI&&(n.relatedCI=!1);var i={filterCriteria:{outageCriteria:n}};return r.getFilteredOutagesList(i).$promise.then(function(e){var t=e[0]&&e[0].items||[],a=t[0]&&t[0].objects||[];return _.map(a,function(e){return(new OutageVO).build(e)})})},this.searchCIsRelatedToChangeRequestByCriteria=function(e,t,n){var i={chunkInfo:{chunkSize:a.MaxLimitRelationships,startIndex:0},filterCriteria:{relatedCI:!0,attributeMap:{id:t&&t.id,ticketType:EntityVO.TYPE_CHANGE}}};return angular.extend(i.filterCriteria,e),n&&angular.extend(i.chunkInfo,n),r.searchCIsRelatedToChangeRequestByCriteria({source:"cioutages"},i).$promise.then(function(e){var t=[];try{t=_.uniqBy(e[0].items[0].objects,function(e){return e.reconciliationId})}catch(a){console.log(a)}return t.forEach(function(e){return(new AssetVO).build(e)}),t})},this.getRequestForRelatedTicket=function(e){return r.getRequestForRelatedTicket({id:e}).$promise.then(function(e){
return e[0].items[0]||void 0})},this.getLiveAgentDefaultSupportGroup=function(e){return r.getLiveAgentDefaultSupportGroup({customerCompany:e}).$promise.then(function(e){return e[0].items[0]||void 0})},this.getHKMUrls=function(){return r.getHKMUrls().$promise.then(function(e){return e[0].items[0]||void 0})}}])}(),angular.module("resourceModule").directive("rs",["$state","$q","$filter","$timeout","relationModel","ticketModel","$templateCache","attachmentService","systemAlertService","events","$http","$compile","knowledgeArticleModel","objectValueMapperService","configurationModel","pwaModel","utilityFunctions",function(e,t,a,n,i,o,r,s,l,c,d,u,p,m,f,g,h){return{restrict:"E",templateUrl:"views/resource/rs.html",transclude:!0,scope:{context:"=",savedTemplate:"=",kcsAssessMode:"="},controller:["$scope","$rootScope",function(e,t){function n(){e.state.watcherOn||(e.state.watcherOn=!0,e.$on(c.SET_PREVIEW_ITEM,function(t,a){a&&a.id&&a.type&&(e.resourcePreviewItem=a)}))}function o(t){t.visited||(p.markArticleVisited(t.id,e.context.id),t.visited=!0)}function r(e){l.error({text:e.data.errorCode?a("i18n")("error.unknown"):e.data.error||e.data.results.error})}e.summary={text:""},e.state={savingResource:!1,kaSearchEnabled:!1,isPreviewInjected:!1,watcherOn:!1},this.isKaSearchEnabled=function(){return e.state.kaSearchEnabled},this.isResourceRelated=function(t){var a=i.cache[e.context.id];return!!a&&_.find(a,{id:t.id})},this.handleKeydown=function(e,t){32===e.keyCode&&(this.toggleRelation(t),e.preventDefault(),e.stopPropagation())},this.toggleRelation=function(t){e.context.accessMappings.relationsEditAllowed&&(this.isResourceRelated(t)?this.deleteFromTicket(t):this.saveToTicket(t))},this.saveToTicket=function(t,a){if(e.context.type===EntityVO.TYPE_SMARTRECORDER||e.context.isDraft||e.context.type===EntityVO.TYPE_LIVE_CHAT)return void e.$emit(c.SAVE_TO_TICKET_FROM_RS,t);e.kcsAssessMode?t.relationshipType=RelationItemVO.TYPE_DUPLICATEOF:e.context.type===EntityVO.TYPE_KNOWLEDGE&&t.type===EntityVO.TYPE_KNOWLEDGE&&(t.relationshipType=RelationItemVO.TYPE_REFERENCES),e.state.savingResource=!0;var n={type:e.context.type,uuid:e.context.id},o={id:t.id,desc:t.additionalInformation&&t.additionalInformation.title?t.additionalInformation.title:t.title?t.title:t.desc,type:t.type,tag:EntityVO.TYPE_RESOURCE,relationshipType:t.relationshipType?t.relationshipType:EntityVO.TYPE_RELATEDTO};return a&&_.isObject(a)&&angular.extend(o,a),i.addRelation(n,[o]).then(function(){t.tag=o.tag,o.type===EntityVO.TYPE_KNOWLEDGE&&delete i.cache[o.id]})["catch"](r)["finally"](function(){e.state.savingResource=!1})},this.deleteFromTicket=function(t){if(e.context.type===EntityVO.TYPE_SMARTRECORDER||e.context.isDraft||e.context.type===EntityVO.TYPE_LIVE_CHAT)return void e.$emit(c.REMOVE_FROM_TICKET_FROM_RS,t);e.state.savingResource=!0;var a={parentType:e.context.type,parentId:e.context.id},n={id:t.type===EntityVO.TYPE_OUTAGE?t.displayId:t.id,type:t.type,tag:t.tag?t.tag:EntityVO.TYPE_RESOURCE,relationshipType:t.relationshipType?t.relationshipType:EntityVO.TYPE_RELATEDTO};t.type===EntityVO.TYPE_OUTAGE&&n.id.indexOf("|")!==-1&&(n.id=n.id.substring(0,n.id.indexOf("|"))),i.removeRelation(a,[n])["finally"](function(){e.state.savingResource=!1,delete t.tag,n.type===EntityVO.TYPE_KNOWLEDGE&&delete i.cache[n.id]})},this.deleteMultipleFromTicket=function(t){e.state.savingResource=!0;var a={parentType:e.context.type,parentId:e.context.id},n=[];_.forEach(t,function(e){var t={id:e.id,type:e.type,tag:e.tag?e.tag:EntityVO.TYPE_RESOURCE,relationshipType:e.relationshipType};n.push(t)}),i.removeRelation(a,n)["catch"](r)["finally"](function(){e.state.savingResource=!1,_.forEach(t,function(e){delete e.tag})})},this.saveAndResolve=function(t){e.resourcePreviewItem=null;var n,i,o,r,s={operational:!1,product:!1};t.relationshipType!==EntityVO.TYPE_RESOLVED&&(t.relationshipType=EntityVO.TYPE_RESOLVED),r=e.context.categorizations,p.getKnowledgeArticleById(t.id,!1,!0).then(function(d){f.copyPrimaryCategoriesOnResolve&&_.forEach(r,function(e){"product"===e.name&&(o=_.find(d.categorizations,{name:"product"}),o&&o.tiers&&(null==o.tiers.productCategoryTier1&&(o.tiers.productCategoryTier1=""),null==o.tiers.productCategoryTier2&&(o.tiers.productCategoryTier2=""),null==o.tiers.productCategoryTier3&&(o.tiers.productCategoryTier3=""),null==o.tiers.productName&&(o.tiers.productName=""),null==o.tiers.productModelVersion&&(o.tiers.productModelVersion="")),e&&e.tiers&&(null==e.tiers.productCategoryTier1&&(e.tiers.productCategoryTier1=""),null==e.tiers.productCategoryTier2&&(e.tiers.productCategoryTier2=""),null==e.tiers.productCategoryTier3&&(e.tiers.productCategoryTier3=""),null==e.tiers.productName&&(e.tiers.productName=""),null==e.tiers.productModelVersion&&(e.tiers.productModelVersion="")),o&&o.tiers&&o.tiers.productCategoryTier1?e.tiers&&e.tiers.productCategoryTier1?e.tiers.productCategoryTier1==o.tiers.productCategoryTier1&&e.tiers.productCategoryTier2==o.tiers.productCategoryTier2&&e.tiers.productCategoryTier3==o.tiers.productCategoryTier3&&e.tiers.productName==o.tiers.productName&&e.tiers.productModelVersion==o.tiers.productModelVersion?(s.product=!1,n=!!n&&n):(s.product=!0,n=!0):(s.product=!0,n=!!n&&n):(s.product=!1,n=!1)),"operational"===e.name&&(o=_.find(d.categorizations,{name:EntityVO.CATEGORY_OPERATIONAL}),o&&o.tiers&&(null==o.tiers.operationCategoryTier1&&(o.tiers.operationCategoryTier1=""),null==o.tiers.operationCategoryTier2&&(o.tiers.operationCategoryTier2=""),null==o.tiers.operationCategoryTier3&&(o.tiers.operationCategoryTier3="")),e&&e.tiers&&(null==e.tiers.operationCategoryTier1&&(e.tiers.operationCategoryTier1=""),null==e.tiers.operationCategoryTier2&&(e.tiers.operationCategoryTier2=""),null==e.tiers.operationCategoryTier3&&(e.tiers.operationCategoryTier3="")),!(o&&o.tiers&&o.tiers.operationCategoryTier1)||e.tiers&&e.tiers.operationCategoryTier1==o.tiers.operationCategoryTier1&&e.tiers.operationCategoryTier2==o.tiers.operationCategoryTier2&&e.tiers.operationCategoryTier3==o.tiers.operationCategoryTier3?(s.opeartional=!1,n=!!n&&n):e.tiers&&e.tiers.operationCategoryTier1?(s.operational=!0,n=!0):(s.operational=!0,n=!!n&&n))}),n?(i=l.modal({type:"info",title:"Warning",text:a("i18n")("resourceSlice.categoryMismatch.message"),buttons:[{text:a("i18n")("common.button.yes"),data:!0},{text:a("i18n")("common.button.no"),data:!1}]}),i.result.then(function(a){a?d.updateCategories=!0:d.updateCategories=!1,e.saveToTicket(t),e.context.type===EntityVO.TYPE_SMARTRECORDER||e.context.isDraft?e.$emit(c.RESOLVE_TICKET_FROM_RS,t,d):e.$emit(c.TICKET_PROFILE_RESEND_EVENT,{eventName:c.RESOLVE_TICKET_FROM_RS,data:d})})):(t.updateCategories=s.operational||s.product,d.updateCategories=t.updateCategories,e.saveToTicket(t),e.context.type===EntityVO.TYPE_SMARTRECORDER||e.context.isDraft?e.$emit(c.RESOLVE_TICKET_FROM_RS,t,d):e.$emit(c.TICKET_PROFILE_RESEND_EVENT,{eventName:c.RESOLVE_TICKET_FROM_RS,data:d}))})},this.linkAsDuplicateOf=function(t){e.resourcePreviewItem=null,e.context.type===EntityVO.TYPE_SMARTRECORDER||e.context.isDraft?e.$emit(c.MARK_AS_DUPLICATE_OF_FROM_RS,t):(e.resourcePreviewItem=null,e.saveToTicket(t,{tag:EntityVO.TYPE_LINKEDITEM,relationshipType:EntityVO.TYPE_DUPLICATEOF}).then(function(){e.$emit(c.TICKET_PROFILE_RESEND_EVENT,{eventName:c.MARK_AS_DUPLICATE_OF_FROM_RS})}))},this.setPreviewItem=function(t,a){a&&a.stopPropagation(),f.comaroundEnabled&&t.type===EntityVO.TYPE_KNOWLEDGE?t&&t.additionalInformation&&t.additionalInformation.comaroundGetUrl&&h.isValidHttpUrl(t.additionalInformation.comaroundGetUrl)?(e.$broadcast(c.CLOSE_TICKET_PREVIEW),window.open(t.additionalInformation.comaroundGetUrl,"_blank")):console.error("Provided Comaround URL is invalid"):!g.isPwaEnabled()||t.type!==EntityVO.TYPE_INCIDENT&&t.type!==EntityVO.TYPE_WORKORDER&&t.type!==EntityVO.TYPE_PROBLEM&&t.type!==EntityVO.TYPE_KNOWNERROR?(m.isShelvedParentEmpty()&&t.type!==EntityVO.TYPE_KNOWLEDGE&&e.context.type!==EntityVO.TYPE_KNOWLEDGE&&m.shelveAsParent(),t.type===EntityVO.TYPE_KNOWLEDGE&&(n(),o(t)),e.state.isPreviewInjected?e.resourcePreviewItem=t:e.showResourcePreviewElement(t),e.$broadcast(c.DISMISS_NOTE_FORM,{})):(e.resourcePreviewItem=t,e.resourcePreviewItem.loadPVPreview=!0),e.$broadcast(c.DISMISS_NOTE_FORM,{})},this.isResourcePreview=function(t){return!!e.resourcePreviewItem&&e.resourcePreviewItem.id===t.id},this.toggleSearchKa=function(){e.state.kaSearchEnabled&&e.$broadcast(c.REFRESH_RECOMMENDED_KNOWLEDGE),e.state.kaSearchEnabled=!e.state.kaSearchEnabled},this.sendToLiveChat=function(t){if(t){var a=t&&t.additionalInformation,n=a&&a.comaroundGetUrl,i=a&&a.crossLaunchURL;!(i&&"string"==typeof i&&i.length>0)&&n&&"string"==typeof n&&n.length>0&&(t=JSON.parse(JSON.stringify(t)),t.additionalInformation.crossLaunchURL=n),e.$emit(c.SHARE_KNOWLEDGE_TO_LIVE_CHAT,t)}},e.summarySearchTextChanged=function(t){e.context.summary!==t&&(e.context.summary=t,e.$emit(c.SEARCH_TEXT_CHANGED,e.context.summary))},e.clearSearch=function(){e.summary.text="",e.context.summary=e.summary.text,e.$emit(c.SEARCH_TEXT_CHANGED,e.context.summary)},e.$on(c.ON_SELECTED_LIVE_CHAT,function(t,a){a&&a.summary?(e.summary.text=a.summary,e.summarySearchTextChanged(a.summary)):e.clearSearch()}),this.context=e.context,e.toggleSearchKa=this.toggleSearchKa,e.saveToTicket=this.saveToTicket,e.deleteFromTicket=this.deleteFromTicket,e.saveAndResolve=this.saveAndResolve,e.linkAsDuplicateOf=this.linkAsDuplicateOf}],link:function(e){e.showResourcePreviewElement=function(t){e.state.isPreviewInjected=!0,e.resourcePreviewItem=t}}}}]),angular.module("resourceModule").directive("rsDuplicateKaSearch",["metadataModel","$q","knowledgeArticleModel","categoriesService","roles","events","relationModel",function(e,t,a,n,i,o,r){return{require:"^rs",restrict:"E",templateUrl:"views/resource/rs-duplicate-ka-search.html",link:function(i,s,l,c){function d(e){i.searchResults=[];var t=_.filter(e,{type:EntityVO.TYPE_KNOWLEDGE}),a=_.filter(t,function(e){if(e.relationshipType===RelationItemVO.TYPE_DUPLICATEOF||e.relationshipType===RelationItemVO.TYPE_RELATEDTO||e.relationshipType===RelationItemVO.TYPE_REFERENCES)return!0}),n=_.reject(m,function(e){return _.find(t,{id:e.id})});a.length?(i.$emit(o.DUPLICATE_ARTICLE_FOUND,a),i.previewItem&&i.compareFullArticle&&(i.previewItem=_.find(a,{id:i.previewItem.id})||_.find(n,{id:i.previewItem.id}))):i.$emit(o.DUPLICATE_ARTICLE_FOUND,[]),i.searchResults=a.concat(n),g.searchNotFound=!i.searchResults||!i.searchResults.length}function u(){i.clearSearch(),i.state=g,i.itemsLimit=4,i.sortOptions=[{name:"mostRelevant",sortFieldName:"",sortFieldOrder:""},{name:"mostFavorite",sortFieldName:"favorite",sortFieldOrder:"des"},{name:"mostRecent",sortFieldName:"modifiedDate",sortFieldOrder:"des"}],i.selectedSortOption=i.sortOptions[0],g.processing=!0,t.all([e.getMetadataByType(EntityVO.TYPE_KNOWLEDGE),a.getKnowledgeArticleTemplates()]).then(function(e){var t=e[0],a=[{name:"operational",tiers:{}},{name:"product",tiers:{}}];i.availableStatuses=t.statuses?t.statuses.slice():[],_.remove(i.availableStatuses,{name:"Work In Progress"}),i.articlePlaceholder.allCategories=_.cloneDeep(n.populateCategories(a,t)),i.availableSources=e[1],i.searchArticle(!0)})["finally"](function(){g.processing=!1})}function p(){i.$watchCollection("contextRelations",function(e){return g.watcherOn?void d(e):void(g.watcherOn=!0)},!0)}angular.extend(i,c);var m,f=i.context,g={processing:!1,searching:!1,searchNotFound:!1,optionIsCollapsed:!0,watcherOn:!1};i.articlePlaceholder={type:EntityVO.TYPE_KNOWLEDGE,allCategories:[],customer:{},summary:""},i.articlePlaceholder.customer.company=f.customer,r.cache[f.id]||(r.cache[f.id]=[]),i.contextRelations=r.cache[f.id],i.toggleOptions=function(){g.optionIsCollapsed=!g.optionIsCollapsed},i.setSortOption=function(e){i.selectedSortOption=e,i.searchArticle()},i.changeStatusOption=function(e){i.statusOptions=e},i.changeSourceOption=function(e){i.sourceOptions=e},i.searchArticle=function(e){if(!g.searching){g.searching=!0,i.searchResults=[],g.searchNotFound=!1;var n={search_text:i.articlePlaceholder.summary,suggest_search:!0},o={},r=i.articlePlaceholder.allCategories;e&&(n.search_text=f.title+(f.desc?" "+f.desc:"")),i.statusOptions&&(o.statuses=[{value:i.statusOptions.name}]),i.sourceOptions&&(o.source=i.sourceOptions.name),o.category=[],_.each(r,function(e){if(e.listOfTiers[0]&&e.listOfTiers[0].selectedValue){var t={};t.name=e.name,t.tiers={},_.each(e.listOfTiers,function(e){t.tiers[e.name]=e.selectedValue?e.selectedValue:""}),o.category.push(t)}}),t.all([a.findArticleByText(n,o,i.selectedSortOption)]).then(function(e){_.isEmpty(e[0])||(m=_.reject(e[0],{id:f.id})),d(i.contextRelations),!g.watcherOn&&p()})["finally"](function(){g.searching=!1})}},i.clearSearch=function(){i.articlePlaceholder.summary="",i.searchResults=[],g.searchNotFound=!1},i.toggleDuplicateMode=function(){i.$emit(o.TOGGLE_CHECK_DUPLICATE_MODE,!1)},i.viewFullArticle=function(e,t){i.compareFullArticle=t,t&&(i.previewItem=e,i.articleId=e.id)},i.$on(o.ASSESSMENT_REMOVE_DUPLICATES,function(){var e=[];_.forEach(i.searchResults,function(t){t instanceof RelationItemVO&&t.relationshipType===RelationItemVO.TYPE_DUPLICATEOF&&e.push(t)}),i.deleteMultipleFromTicket(e)}),u()}}}]),angular.module("resourceModule").directive("rsDwpCatalog",["smartRecorderModel","events",function(e,t){return{require:"^rs",restrict:"E",scope:{},templateUrl:"views/resource/rs-dwp-catalog.html",link:function(a,n,i,o){function r(){var n={searchText:u.summary||a.summarySearchText};return n.searchText?(p.itemLimit=m,p.isDataLoading=!0,void e.getListOfDwpTemplates(n.searchText).then(function(e){a.templates=e.objects,a.$emit(t.RESOURCES_FOUND,{data:a.templates,type:"templates"}),!p.watchersOn&&s()})["finally"](function(){p.isDataLoading=!1})):void(a.templates=[])}function s(){p.watchersOn=!0,a.$watchCollection("context",function(e,t){var n,i=["summary","company","customerId"],o=i.length;for(e.template&&e.template.id?(e.template.id!==t.template.id||e.template.id===t.template.id&&!a.savedTemplateId)&&(a.savedTemplateId=e.template.id,d()):a.savedTemplateId="",n=0;n<o;n++)if(e[i[n]]!==t[i[n]]){r();break}},!0)}function l(e){a.savedTemplateId=e.id,d(),a.$emit(t.SELECT_TEMPLATE_FROM_RS,e)}function c(){a.savedTemplateId="",a.$emit(t.UNSELECT_TEMPLATE_FROM_RS)}function d(){var e=angular.copy(a.templates);_.find(e,function(t,n){if(a.savedTemplateId===t.id&&0!==n)return e.splice(n,1),e.unshift(t),!0}),a.templates=e}angular.extend(a,o);var u=a.context,p={itemLimit:4,isDataLoading:!1,watchersOn:!1},m=4;a.templates=[],a.toggleTemplateSelection=function(e){a.savedTemplateId!==e.id?l(e):c()},a.context=u,a.state=p,r()}}}]),angular.module("resourceModule").directive("rsKaAttachments",["systemAlertService","attachmentService","i18nService","events",function(e,t,a,n){return{require:"^rs",restrict:"E",scope:{printMode:"@?"},templateUrl:"views/resource/rs-ka-attachments.html",link:function(i,o,r,s){function l(){return m.loadingAttachments=!0,t.getAttachmentsInfo(p.id,p.type).then(function(e){i.attachments=e})["finally"](function(){m.loadingAttachments=!1})}function c(e){return i.state.uploadingAttachments=!0,t.uploadAttachment(i.context.type,i.context.id,e).then(function(e){Array.prototype.push.apply(i.attachments,e)})["finally"](function(){i.state.uploadingAttachments=!1})}function d(){return e.modal({title:a.getLocalizedString("common.notification.delete.title"),text:a.getLocalizedString("common.notification.delete.message"),buttons:[{text:a.getLocalizedString("common.notification.delete.button1"),data:!0},{text:a.getLocalizedString("common.notification.delete.button2"),data:!1}]})}function u(e,a){_.pull(i.attachments,a),t.deleteAttachment(EntityVO.TYPE_KNOWLEDGE,{dataSourceId:a.attachmentReference.dataSourceId,attachmentId:a.attachmentReference.attachmentId})}angular.extend(i,s);var p=i.context,m={loadingAttachments:!1,uploadingAttachments:!1};l(),i.$on(n.REFRESH_RESOURCE_FEED,function(){l()}),i.handleFileChange=function(a){var n=t.prepareFileToUpload({fileInput:a});return n&&n.size<=0?void e.warning({text:$filter("i18n")("attachment.file_empty"),icon:"icon-exclamation_triangle",clear:!0,hide:5e3}):void(n&&c([n]))},i.removeAttachment=function(e,t){t.stopPropagation();var a=d();a.result.then(function(t){t&&u(t,e)})},i.getAttachment=function(e){m.loadingAttachments=!0,t.getAttachmentFile(EntityVO.TYPE_KNOWLEDGE,e)["finally"](function(){i.state.loadingAttachments=!1})},i.context=p,i.state=m}}}]),angular.module("resourceModule").directive("rsKaSearch",["ticketService","ticketModel","$state","metadataModel","$q","knowledgeArticleModel","relationModel","categoriesService","$modal","permissionModel","roles","$filter","configurationModel","events","searchModel",function(e,t,a,n,i,o,r,s,l,c,d,u,p,m,f){return{require:"^rs",restrict:"E",replace:!0,templateUrl:"views/resource/rs-ka-search.html",link:function(e,g,h,y){function E(){var t=[{name:"All"}];return e.context.type===EntityVO.TYPE_KNOWLEDGE&&e.context.company&&"All"===e.context.company.name?t:(e.context.type===EntityVO.TYPE_KNOWLEDGE||e.context.type===EntityVO.TYPE_PROBLEM||e.context.type===EntityVO.TYPE_KNOWNERROR?t.push(e.context.company):t.push(e.context.customer?e.context.customer.company:{name:e.context.company}),t)}function v(t,a){var n;if(p.comaroundEnabled){var i={search_text:t.search_text};a.category&&a.category.length&&(i.category=a.category),n=o.getHKMRecommendedKA(t,i)}else n=o.findArticleByText(t,a,e.selectedSortOption);n.then(function(t){I=_.filter(t,function(t){return e.context.id!==t.id}),T(e.contextRelations)})["finally"](function(){A.searching=!1})}function T(t){if(!I||!I.length)return void(A.searchNotFound=!0);var a=_.filter(t,function(e){return _.find(I,{id:e.id})}),n=_.reject(I,function(e){return _.find(a,{id:e.id})});e.searchResults=a.concat(n),e.context.type!==EntityVO.TYPE_KNOWLEDGE&&C(e.searchResults)}function S(){e.$watchCollection("contextRelations",function(t){return A.watcherOn?r.unlinked.length&&y.isKaSearchEnabled()?(r.unlinked.length=0,void v(e.searchData,e.searchOptions)):void T(t):void(A.watcherOn=!0)},!0)}function C(t){var a=o.getVisitedArticlesForTicket(e.context.id);t.some(function(e){return e.visited=!1,e instanceof GlobalSearchItemVO}),_.isEmpty(a)||_.forEach(t,function(e){e.visited=_.includes(a,e.id)})}function O(){e.clearSearch(),e.state=A,e.itemsLimit=4,e.sortOptions=[{name:"mostRelevant",sortFieldName:"",sortFieldOrder:""},{name:"mostFavorite",sortFieldName:"favorite",sortFieldOrder:"des"},{name:"mostRecent",sortFieldName:"modifiedDate",sortFieldOrder:"des"}],e.selectedSortOption=e.sortOptions[0],A.processing=!0;var t=e.comaroundEnabled?i.when([]):o.getKnowledgeArticleTemplates();i.all([n.getMetadataByType(EntityVO.TYPE_KNOWLEDGE),t]).then(function(t){var a=t[0],n=[{name:"operational",tiers:{}},{name:"product",tiers:{}}];e.availableStatuses=a.statuses?a.statuses.slice():[],_.remove(e.availableStatuses,{name:"Work In Progress"}),e.articlePlaceholder.allCategories=_.cloneDeep(s.populateCategories(n,a)),e.availableSources=t[1]})["finally"](function(){A.processing=!1})}angular.extend(e,y),e.comaroundEnabled=p.comaroundEnabled,e.context.type!==EntityVO.TYPE_KNOWLEDGE&&t.cache[e.context.id]?e.context=t.cache[e.context.id]:o.articles[e.context.id]&&(e.context=o.articles[e.context.id]);var A={processing:!1,searching:!1,searchNotFound:!1,watcherOn:!1,optionIsCollapsed:!0,canCreateKnowledge:c.hasPermission(d.ITSM_KNOWLEDGE_USER_ROLE)&&!e.context.isDraft&&e.context.accessMappings.relationsEditAllowed},I=[];e.articlePlaceholder={type:EntityVO.TYPE_KNOWLEDGE,allCategories:[],customer:{},summary:"",allCompanies:[]},e.titleRegExp=new RegExp(/.{1,5}/g),e.context.type===EntityVO.TYPE_SMARTRECORDER?e.articlePlaceholder.customer.company={name:e.context.company}:e.context.type===EntityVO.TYPE_PROBLEM||e.context.type===EntityVO.TYPE_KNOWNERROR?e.articlePlaceholder.customer.company=e.context.company:e.context.customer&&e.context.customer.company?e.articlePlaceholder.customer.company=e.context.customer.company:e.articlePlaceholder.customer.company=e.context.customer||e.context.company,e.contextRelations=r.cache[e.context.id],e.companyState={selected:!0,showFilter:p.showFilterForRecommendedKnowledge},e.context.type===EntityVO.TYPE_KNOWLEDGE?(e.articlePlaceholder.allCompanies=e.context.allCompanies,_.find(e.articlePlaceholder.allCompanies,{name:"All"})||e.articlePlaceholder.allCompanies.push({name:"All"})):(e.articlePlaceholder.allCompanies.push({name:"All"}),e.articlePlaceholder.allCompanies.push(e.articlePlaceholder.customer.company)),e.toggleOptions=function(){A.optionIsCollapsed=!A.optionIsCollapsed},e.createNewArticle=function(){if(e.comaroundEnabled)f.getHKMUrls().then(function(e){e.createUrl&&(e.createUrl=decodeURI(e.createUrl),window.open(e.createUrl,"_blank"))});else{t.articleParent=e.context;var n=l.open({templateUrl:"views/create/create-ka.html",controller:"CreateKnowledgeArticleModalController",windowClass:"modal_full-content",backdrop:!1,keyboard:!1});n.result.then(function(t){e.$emit(m.TICKET_PROFILE_RESEND_EVENT,{eventName:m.TICKET_SHOW_LOADER});var n=(new RelationItemVO).build({id:t.id,displayId:t.articleId,title:t.title,desc:t.title,type:t.type,additionalInformation:{modifiedDate:t.modifiedDate},tag:EntityVO.TYPE_RESOURCE,relationshipType:EntityVO.TYPE_RELATEDTO,realObject:{status:t.status,version:t.version,modifiedDate:t.modifiedDate}});e.saveToTicket(n).then(function(){a.go(n.type,{id:n.id})})["finally"](function(){e.$emit(m.TICKET_PROFILE_RESEND_EVENT,{eventName:m.TICKET_HIDE_LOADER})}),e.toggleSearchKa()})}},e.setSortOption=function(t){e.selectedSortOption=t,e.searchArticle()},e.changeStatusOption=function(t){e.statusOptions=t},e.changeSourceOption=function(t){e.sourceOptions=t},e.searchArticle=function(){if(!A.searching){A.searching=!0,e.searchResults=[],A.searchNotFound=!1,o.clearVisitedArticlesForTicket(e.context.id);var t={search_text:e.articlePlaceholder.summary,suggest_search:!0,chunk_index:0,chunk_size:15},a={},n=e.articlePlaceholder.allCategories;if(e.statusOptions&&(a.statuses=[{value:e.statusOptions.name}]),e.sourceOptions&&(a.source=e.sourceOptions.name),e.companyState.showFilter&&e.companyState.selected){var i=E();i&&(a.searchCompanies=i)}a.category=[],_.each(n,function(e){if(e.listOfTiers[0]&&e.listOfTiers[0].selectedValue){var t={};t.name=e.name,t.tiers={},_.each(e.listOfTiers,function(e){t.tiers[e.name]=e.selectedValue?e.selectedValue:""}),a.category.push(t)}}),v(t,a),e.searchData=t,e.searchOptions=a,!A.watcherOn&&S()}},e.getTicketLabel=function(){return u("i18n")("ticket.type."+e.context.type)},e.clearSearch=function(){e.articlePlaceholder.summary="",e.searchResults=[],I.length=0,A.searchNotFound=!1},e.localizedStatus=function(t){return e.comaroundEnabled?u("i18n")("hkm.status."+t):u("localizeLabel")(t,"status","knowledge")},O()}}}]),angular.module("resourceModule").directive("rsKaTickets",["relationModel","events",function(e,t){return{require:"^rs",restrict:"E",scope:{},templateUrl:"views/resource/rs-ka-tickets.html",link:function(a,n,i,o){function r(){c.loadingRelatedTickets=!0;var t;t=l?e.refreshRelations(a.context.id,a.context.type):e.getRelations(a.context.id,a.context.type),t.then(function(){e.cache[a.context.id]&&(a.relatedTickets=_.filter(e.cache[a.context.id],function(e){return e.type!==EntityVO.TYPE_KNOWLEDGE}))})["finally"](function(){l=!1,c.loadingRelatedTickets=!1})}angular.extend(a,o);var s=a.context,l=!1,c={itemLimit:4,loadingRelatedTickets:!1};r(),a.$on(t.REFRESH_RESOURCE_FEED,function(){l=!0,r()}),a.context=s,a.state=c}}}]),angular.module("resourceModule").directive("rsRecommendedKa",["searchService","relationModel","$q","configurationModel","events","$filter",function(e,t,a,n,i,o){return{require:"^rs",restrict:"E",scope:{},templateUrl:"views/resource/rs-recommended-ka.html",link:function(r,s,l,c){function d(){if(O||v.type===EntityVO.TYPE_PROBLEM||v.type===EntityVO.TYPE_KNOWNERROR?S.query.recommendedSearch=!0:(g(),S.post.sites=v.customer&&v.customer.site?[v.customer.site]:[]),T.isDataLoading=!0,!v.id)return void(T.isDataLoading=!1);var e=h(!0);a.all([t.getRelations(v.id,v.type),e]).then(function(e){r.contextRelations=angular.copy(t.cache[v.id]),y(e[1])})["finally"](function(){T.isDataLoading=!1})}function u(a){return t.unlinked.length&&!c.isKaSearchEnabled()?(t.unlinked.length=0,T.isDataLoading=!0,void e.getGlobalSearchResults(S.query,S.post).then(function(e){_.isEmpty(e.items)||(E=_.reject(e.items[0].results,{id:v.id})),p(a,E)})["finally"](function(){T.isDataLoading=!1})):void p(a,E)}function p(e,t){var a=_.filter(e,{type:EntityVO.TYPE_KNOWLEDGE}),n=_.reject(t,function(e){return _.find(a,{id:e.id})}),o=_.remove(a,{relationshipType:EntityVO.TYPE_RESOLVED});o&&o.length&&(a=o.concat(a)),r.recommendedArticles=a.concat(n),r.$emit(i.RESOURCES_FOUND,{data:r.recommendedArticles,type:"articles"})}function m(){T.watchersOn=!0,r.$watchCollection("contextRelations",function(e){u(e)},!0),r.$watchCollection("context",function(e,t){var a=t.summary||t.title,n=e.summary||e.title;n===a&&e.desc===t.desc&&_.isEqual(e.company,t.company)&&_.isEqual(e.customer&&e.customer.company,t.customer&&t.customer.company)&&_.isEqual(e.categorizations,t.categorizations)||(S.post.search_text=(e.summary||e.title)+(e.desc?" "+e.desc:""),d())})}function f(){var e=[{name:"All"}];return v.type===EntityVO.TYPE_KNOWLEDGE&&v.company&&"All"===v.company.name?e:(v.type===EntityVO.TYPE_KNOWLEDGE||v.type===EntityVO.TYPE_PROBLEM||v.type===EntityVO.TYPE_KNOWNERROR?e.push({name:v.company.name}):e.push(v.customer?v.customer.company:{name:v.company}),e)}function g(){var e=f();e&&(S.post.searchCompanies=e)}function h(t){if(r.state.itemLimit=C,delete S.query.suggest_search,delete S.post.searchCompanies,delete S.post.category,r.recommendedKAFilterCB.company&&(S.query.suggest_search=!0,g()),t&&r.isSmartRecorderScreen&&r.recommendedKAFilterCB.showFilter&&r.context.template&&r.context.template.templateObject){var a=_.find(r.context.template.templateObject.categorizations,{name:"operational"});a&&!_.isEmpty(a.tiers)&&(r.showOpcatFilterforSmartRecorder=!0,r.recommendedKAFilterCB.category=!0)}if(r.recommendedKAFilterCB.category){var n;if(r.isSmartRecorderScreen?r.context.template&&r.context.template.templateObject&&(n=r.context.template.templateObject):n=r.context,n){var a=_.find(n.categorizations,{name:"operational"});a&&!_.isEmpty(a.tiers)&&(S.post.category=[],S.post.category.push({name:a.name,tiers:a.tiers}))}}return r.comaroundEnabled?(S.post&&(delete S.post.types,delete S.post.sites,delete S.post.searchCompanies),S.query&&S.query.chunk_size?S.query={chunk_size:S.query.chunk_size}:S.query={},e.getHKMRecommendedKA(S.query,S.post)):e.getGlobalSearchResults(S.query,S.post)}function y(e){_.isEmpty(e.items)||(E=_.reject(e.items[0].results,{id:v.id})),T.watchersOn?u(r.contextRelations):m()}angular.extend(r,c);var E,v=r.context,T={isKnowledgeInstalled:n.isServerApplicationEnabled(EntityVO.TYPE_KNOWLEDGE),itemLimit:4,isDataLoading:!1,watchersOn:!1},S={query:{chunk_size:15,need_totalcount:!1},post:{types:["knowledge"],search_text:(v.summary||v.title)+(v.desc?" "+v.desc:"")}},C=4;r.comaroundEnabled=n.comaroundEnabled,r.context.type===EntityVO.TYPE_LIVE_CHAT&&(S.query.isFromLiveChat=!0),r.recommendedArticles=[],r.titleRegExp=new RegExp(/.{1,5}/g),r.showOpcatFilterforSmartRecorder=!1,r.isSmartRecorderScreen=r.context.type===EntityVO.TYPE_SMARTRECORDER;var O=!!n.showFilterForRecommendedKnowledge;r.recommendedKAFilterCB={company:O,category:!r.isSmartRecorderScreen&&O,showFilter:O},r.context=v,r.state=T,r.localizedStatus=function(e){return r.comaroundEnabled?o("i18n")("hkm.status."+e):o("localizeLabel")(e,"status","knowledge")},r.getTicketLabel=function(){return o("i18n")("ticket.type."+v.type)},r.toggleCompanyCategoryFilter=function(){T.isDataLoading=!0,h().then(function(e){y(e)})["finally"](function(){T.isDataLoading=!1})},r.isResourceSharable=function(e){if(r.context.type===EntityVO.TYPE_LIVE_CHAT){var t=e&&e.additionalInformation,a=_.find(t&&t.additionalCategoriesCompanies,{name:r.context.chatUserCompany}),n=t&&t.comaroundGetUrl,i=t&&t.company,o=n&&"string"==typeof n&&n.length>0||i&&"All"===i.name||r.context.chatUserCompany===(i&&i.name)||a;return r.context.type===EntityVO.TYPE_LIVE_CHAT&&r.context.selectedChat&&!e.internalUse&&("Assigned"===r.context.status||"Participate(Assigned)"===r.context.status)&&o}},d(),r.$on(i.REFRESH_RESOURCE_FEED,function(e,t){t.isRefreshTicket||d()}),r.$on(i.REFRESH_RECOMMENDED_KNOWLEDGE,function(){r.contextRelations=angular.copy(t.cache[v.id]),u(r.contextRelations)}),r.$on(i.UPDATE_CONTEXT_ON_REFRESH,function(e,t){t&&(v=r.context=t)})}}}]),angular.module("resourceModule").directive("rsRecommendedOutages",["searchModel","relationModel","metadataModel","$q","events",function(e,t,a,n,i){return{require:"^rs",restrict:"E",scope:{},templateUrl:"views/resource/rs-recommended-outages.html",link:function(o,r,s,l){function c(){var i={companyName:p(f),searchText:f.summary,affectedService:f.impactedService&&f.impactedService.name,affectedAsset:f.causalCI&&f.causalCI.name};g.isDataLoading=!0,n.all([t.getRelations(f.id,f.type),e.getOutages(i),a.getMetadataByType(EntityVO.TYPE_OUTAGE)]).then(function(e){o.contextRelations=angular.copy(t.cache[f.id]),m=_.reject(e[1],{id:f.id}),g.watchersOn?d(o.contextRelations):u()})["finally"](function(){g.isDataLoading=!1})}function d(e){var t=_.filter(e,{type:EntityVO.TYPE_OUTAGE}),a=_.reject(m,function(e){return _.find(t,{id:e.id})});o.recommendedOutages=t.concat(a),o.$emit(i.RESOURCES_FOUND,{data:o.recommendedOutages,type:"outages"})}function u(){g.watchersOn=!0,o.$watchCollection("contextRelations",function(e){d(e)},!0),o.$watchCollection("context",function(e,t){e.summary!==t.summary&&c()})}function p(e){return"smartRecorder"===e.type&&e.company?e.company.name?e.company.name:e.company:null}angular.extend(o,l);var m,f=o.context,g={itemLimit:4,isDataLoading:!1,watchersOn:!1};o.recommendedOutages=[],o.context=f,o.state=g,c(),o.$on(i.REFRESH_RESOURCE_FEED,function(){c()})}}}]),angular.module("resourceModule").directive("rsRecommendedTickets",["searchService","relationModel","$q","events","configurationModel",function(e,t,a,n,i){return{require:"^rs",restrict:"E",scope:{},templateUrl:"views/resource/rs-recommended-tickets.html",link:function(o,r,s,l){function c(){var n={query:{chunk_size:15,need_totalcount:!1},post:{types:["incident"],searchCompanies:f.customer?[f.customer.company]:[{name:f.company}],sites:f.customer?[f.customer.site]:[],search_text:f.summary+(f.desc?" "+f.desc:"")}};g.isDataLoading=!0,a.all([t.getRelations(f.id,f.type),e.getGlobalSearchResults(n.query,n.post)]).then(function(e){o.contextRelations=angular.copy(t.cache[f.id]),e[1].items[0]&&e[1].items[0].results&&(p=_.reject(e[1].items[0].results,{id:f.id})),g.watchersOn?d(o.contextRelations):u()})["finally"](function(){g.isDataLoading=!1})}function d(e){var t=_.chain(e).filter({tag:RelationItemVO.TAG_RESOURCE}).reject(function(e){return _.includes([EntityVO.TYPE_KNOWLEDGE,EntityVO.TYPE_OUTAGE],e.type)}).value(),a=_.reject(p,function(t){return _.find(e,{id:t.id})});o.recommendedTickets=t.concat(a),o.$emit(n.RESOURCES_FOUND,{data:o.recommendedTickets,type:"tickets"})}function u(){g.watchersOn=!0,o.$watchCollection("contextRelations",function(e){d(e)},!0),o.$watchCollection("context",function(e,t){e.summary===t.summary&&e.desc===t.desc||c()})}angular.extend(o,l);var p,m,f=o.context,g={itemLimit:4,isDataLoading:!1,watchersOn:!1,ticketFilterStatuses:["all","open","resolved","cancelled"]};g.ticketFilterSelectedStatus=g.ticketFilterStatuses[0],o.recommendedTickets=[],o.statusFilter=function(e){return"all"===g.ticketFilterSelectedStatus||("open"===g.ticketFilterSelectedStatus?_.includes(["Assigned","In Progress","Pending"],e.getStatus()):e.getStatus().toLowerCase()===g.ticketFilterSelectedStatus||void 0)},o.iconClass=function(e){return m=i.showSecurityTickets&&"Security Incident"===e.additionalInformation.serviceType?"icon-security-incident":"icon-"+e.type},o.context=f,o.state=g,c(),
o.$on(n.REFRESH_RESOURCE_FEED,function(){c()})}}}]),function(){angular.module("resourceModule").directive("rsResourcePreview",["events","relationModel","objectValueMapperService","$sce",function(e,t,a,n){return{restrict:"EA",replace:!0,templateUrl:"views/resource/rs-resource-preview.html",scope:{savedTemplate:"=",saveToTicket:"&",linkAsDuplicateOf:"&",saveAndResolve:"&",deleteFromTicket:"&",removeLinkedItem:"&",context:"=",resourcePreviewItem:"=",hideEditButton:"="},link:function(i,o,r){function s(){i.closePreview(),i.$apply()}function l(){o.is(":visible")||(i.closePreview(),i.$apply())}function c(){var e=27;event.which===e&&(i.closePreview(),i.$apply())}function d(){i.resourcePreviewItem&&(i.resourcePreviewActionDelete=!!_.find(i.contextRelations,{id:i.resourcePreviewItem.id}))}function u(e){if(i.showKAOptions=!0,e.type===EntityVO.TYPE_KNOWLEDGE){var t=e.additionalInformation&&e.additionalInformation.status&&(_.isObject(e.additionalInformation.status)?e.additionalInformation.status.value:e.additionalInformation.status.value);!t&&e.status&&(t=e.status),f.indexOf(t)!==-1&&(i.showKAOptions=!1)}}function p(){i.context.type===EntityVO.TYPE_KNOWLEDGE?i.showSaveAndDelete=!1:i.showSaveAndDelete=i.context.accessMappings.relationsEditAllowed}function m(){i.showSaveAndResolve=!0,i.context.type===EntityVO.TYPE_INCIDENT&&i.context.status&&(i.context.status.value.toLowerCase()!==EntityVO.STATUS_RESOLVED&&i.context.status.value.toLowerCase()!==EntityVO.STATUS_CLOSED||(i.showSaveAndResolve=!1))}var f=["Cancelled","Retire Approval","Retired","Closed Version"];i.saveable=!!angular.isDefined(r.saveable)&&i.$parent.$eval(r.saveable),i.editMode=!1,i.isTitleMultiline=!1,"eschat"===i.context.id&&(i.openKALinkInNewTab=!0);var g={knowledge:"preview-knowledge-article"},h=o.parents(".app__content-frame"),y=h.find(".resource-slice__fade-out"),E="resource-preview-opened",v=h.find(".nav-tabs li"),T=angular.element(document.body);i.$watch("$location.path",function(){var e=!i.context.isDraft;i.closePreview(e)}),y.on("click",s),v.on("click",l),T.on("keydown.rsResourcePreview",c),i.getPreviewSource=function(){function e(){var e=localStorage.getItem("midtierUrl"),t=e.lastIndexOf("/");return t===e.length-1&&(e=e.substr(0,t)),e.search("/arsys")>-1?e:e+"/arsys"}var t,a=localStorage.getItem("midtierUrl")?e():null,o="goto",r="",s="SV_View",l=localStorage.getItem("homeServer"),c=window.location.origin,d=i.resourcePreviewItem.id;i.resourcePreviewItem.type===EntityVO.TYPE_INCIDENT?(r="SHR:SV_TicketDisplay/SV_TicketDisplay",t="Incident"):i.resourcePreviewItem.type===EntityVO.TYPE_WORKORDER?(r="SHR:SV_TicketDisplay/SV_TicketDisplay",t="Work Order"):i.resourcePreviewItem.type===EntityVO.TYPE_PROBLEM?(r="SHR:SV_TicketDisplay/SV_TicketDisplay",t="Problem Investigation"):i.resourcePreviewItem.type===EntityVO.TYPE_KNOWNERROR&&(r="SHR:SV_TicketDisplay/SV_TicketDisplay",t="Known Error"),l&&(o="forms/"+l);var u=a+"/pwa/#/"+o+"/"+r+"?origin="+c+"&mode=GET&context=PREVIEW";return u+=t?"&targetForm="+t+"&targetView="+s+"&targetId="+d:"&guid="+d,n.trustAsResourceUrl(u)},i.closePreview=function(t){a.isShelvedParentEmpty()||t||a.unshelveParent(i.context&&i.context.type),i.resourcePreviewItem&&(i.resourcePreviewItem.type===EntityVO.TYPE_KNOWLEDGE&&i.$emit(e.KNOWLEDGE_ARTICLE_GETTING_EDIT_STATUS,!1),i.resourcePreviewItem=null)},i.edit=function(t){var a=o.find("div["+g[t]+"]");a&&a.trigger(e.CHANGE_TO_EDIT_MODE)},i.$on(e.TOGGLE_KNOWLEDGE_ARTICLE_EDIT_MODE,function(){i.editMode=!i.editMode}),i.$on(e.TICKET_PROFILE_RESEND_EVENT,function(e,t){e.stopPropagation(),i.$broadcast(t.eventName,t.eventData)}),i.$on(e.KNOWLEDGE_ARTICLE_PREVIEW_LOADED,function(e,t){i.articleFlagged=t.article.flagged,i.currentArticle=t.article}),i.$on(e.MULTILINE_CONTENT_CHANGED,function(e,t){i.isTitleMultiline=t.isContentMultiline}),i.addComment=function(){i.$broadcast(e.SET_FOCUS_TO_ACTIVITY_INPUT)},i.setFlag=function(t){(i.currentArticle.accessMappings.flagEditAllowed&&t||i.currentArticle.accessMappings.unflagEditAllowed&&!t)&&i.$broadcast(e.ADD_FLAG_NOTE,{flag:t})},i.$watch("resourcePreviewItem",function(e){i.editMode=!1,e?(i.contextRelations=t.cache[i.context.id],d(),p(),m(),u(e),h.addClass(E)):h.removeClass(E)}),i.$watchCollection("contextRelations",function(){d()},!0),o.on("$destroy",function(){y.off("click",s),T.off("keydown.rsResourcePreview"),h.removeClass(E)}),i.$on("$destroy",function(){y.off("click",s),v.off("click",l),T.off("keydown.rsResourcePreview",c),s()}),i.$on(e.CLOSE_TICKET_PREVIEW,function(){i.closePreview(),i.$apply()})}}}])}(),angular.module("resourceModule").directive("rsTemplates",["ticketTemplateModel","events",function(e,t){return{require:"^rs",restrict:"E",scope:{},templateUrl:"views/resource/rs-templates.html",link:function(a,n,i,o){function r(){var n={searchText:u.summary||a.summarySearchText,companyName:u.company,customerId:u.customerId};return a.context.type===EntityVO.TYPE_LIVE_CHAT&&(n.isFromLiveChat=!0,n.type=a.context.searchTicketTypes||a.searchTicketTypes),!n.searchText||n.type&&"none"===n.type[0]?void(a.templates=[]):(p.itemLimit=m,p.isDataLoading=!0,void e.getTemplatesForSmartRecorder(n).then(function(e){a.templates=e,a.$emit(t.RESOURCES_FOUND,{data:a.templates,type:"templates"}),!p.watchersOn&&s()})["finally"](function(){p.isDataLoading=!1}))}function s(){p.watchersOn=!0,a.$watchCollection("context",function(e,t){var n,i=["summary","company","customerId"],o=i.length;for(e.template&&e.template.id?(e.template.id!==t.template.id||e.template.id===t.template.id&&!a.savedTemplateId)&&(a.savedTemplateId=e.template.id,d()):a.context.type===EntityVO.TYPE_LIVE_CHAT&&a.context.selectedTemplate?a.savedTemplateId=a.context.selectedTemplate.id:a.savedTemplateId="",n=0;n<o;n++)if(e[i[n]]!==t[i[n]]){r();break}},!0)}function l(e){a.savedTemplateId=e.id,d(),a.$emit(t.SELECT_TEMPLATE_FROM_RS,e)}function c(){a.savedTemplateId="",a.$emit(t.UNSELECT_TEMPLATE_FROM_RS)}function d(){var e=angular.copy(a.templates);_.find(e,function(t,n){if(a.savedTemplateId===t.id&&0!==n)return e.splice(n,1),e.unshift(t),!0}),a.templates=e}angular.extend(a,o);var u=a.context,p={itemLimit:4,isDataLoading:!1,watchersOn:!1},m=4;a.templates=[],a.toggleTemplateSelection=function(e){a.savedTemplateId!==e.id?l(e):c()},a.$on(t.ON_SELECTED_LIVE_CHAT,function(e,t){t&&t.searchText?a.summarySearchText=t.searchText:a.summarySearchText="",a.templates=[],r()}),a.context=u,a.state=p,r()}}}]),function(){angular.module("securityModule").config(["$httpProvider",function(e){e.interceptors.push(["$injector",function(e){return e.get("authInterceptor")}])}]),angular.module("securityModule").factory("authInterceptor",["$rootScope","$q","AUTH_EVENTS","$injector","session","$filter",function(e,t,a,n,i,o){return{response:function(e){if("true"===localStorage.getItem("sessionActive")&&!_.includes(e.config.url,"/smartit/rest/sessionstatus")&&!_.includes(e.config.url,"/smartit/rest/serverstates")&&localStorage.getItem("pwaDomain")&&(_.includes(e.config.url,"/smartit/rest")||_.includes(e.config.url,"/smartit/restapi"))&&200===e.status){if(e.config.url&&"/smartit/rest/keepAlive"===e.config.url)return e;localStorage.setItem("smartITActivity","true")}return e},responseError:function(r){if(500!==r.status&&(!i.expired||403!==r.status&&503!==r.status)){var s=n.get("$modalStack");s.dismissAll()}return 401===r.status&&(r.data&&r.data.search("MOBILITY_ERROR_SESSION_EXPIRED")?(i.expired=!0,r.data.error=o("i18n")("error.MOBILITY_ERROR_SESSION_EXPIRED"),e.$broadcast(a.SESSION_EXPIRED,r)):e.$broadcast(a.NOT_AUTHORIZED,r)),r.data&&r.data.ARConnectionProblem&&(r.data.error=r.data.additionalMessage,e.$broadcast(a.AR_CONNECTION_FAILED,r)),!i.expired&&403===r.status&&r.data&&("MOBILITY_ERROR_SESSION_EXPIRED"===r.data.error||_.isString(r.data)&&r.data.indexOf("MOBILITY_ERROR_SESSION_EXPIRED")!==-1)&&(i.expired=!0,"string"==typeof r.data&&(r.data={}),r.data.error=o("i18n")("error.MOBILITY_ERROR_SESSION_EXPIRED"),e.$broadcast(a.SESSION_EXPIRED,r)),!i.expired&&503===r.status&&r.data&&_.isString(r.data.error)&&r.data.error.indexOf("503-SERVICE UNAVAILABLE")!==-1&&(i.expired=!0,"string"==typeof r.data&&(r.data={}),r.data.error=r.data.error,e.$broadcast(a.INITIALIZE_METADATA_ERROR,r)),!i.expired&&503===r.status&&r.data&&_.isString(r.data.error)&&r.data.error.indexOf("503-SERVICE UNAVAILABLE")!==-1&&(i.expired=!0,"string"==typeof r.data&&(r.data={}),r.data.error=r.data.error,e.$broadcast(a.INITIALIZE_METADATA_ERROR,r)),t.reject(r)}}}])}(),function(){angular.module("securityModule").factory("authModel",["authService","session","$window","$q","$rootScope","AUTH_EVENTS","systemAlertService","$filter",function(e,t,a,n,i,o,r,s){function l(t){if(401===t.status){var a=r.modal({type:"error",title:s("i18n")("error"),text:s("i18n")("user.loginError.401"),buttons:[{text:s("i18n")("common.labels.ok"),data:!0}]});a.result.then(function(){e.logout()})}403===t.status?r.modal({type:"error",title:s("i18n")("error"),text:s("i18n")("error.unauthorized"),buttons:[{text:s("i18n")("user.logout"),data:!0}]}).result.then(function(t){t&&e.logout()}):500===t.status&&r.modal({type:"error",title:s("i18n")("error"),text:s("i18n")("error.unknown"),buttons:[{text:s("i18n")("user.logout"),data:!0}]}).result.then(function(t){t&&e.logout()})}var c={};return c.login=function(t,n){var i={userId:encodeURIComponent(t)},o={password:n,appName:"Galileo",appVersion:"23.3.04.000",apiVersion:23300400,locale:window.myitsmLocale,deviceToken:"dummyToken",os:a.navigator.userAgent,model:"Web Client"};return e.isSSOEnabled()&&(i.userId=null,delete o.password),e.login(i,o)},c.logout=function(){return e.logout()},c.isSSOEnabled=function(){return e.isSSOEnabled()},c.getMidtierUrl=function(){return e.getMidtierUrl()},c.isAuthenticated=function(){return e.isAuthenticated()},c.isAuthorized=function(t){if(!t)return!1;if(_.isArray(t)&&0===t.length)return!0;for(var a=0;a<t.length;a++)if(e.isAuthorized(t[a]))return!0;return!1},c.checkSessionStatus=function(){return console.log("authModel.checkSessionStatus"),e.serverState().then(function(){return e.sessionStatus().then(function(){return t.alive?void i.$broadcast(o.SESSION_ACTIVE):e.isSSOEnabled()?c.login()["catch"](l):(i.$broadcast(o.NOT_AUTHENTICATED),n.reject("NOT_AUTHENTICATED"))})})},c.deRegister=function(){return e.deRegister()},c}])}(),function(){angular.module("securityModule").service("session",function(){return{create:function(e,t,a){this.userId=e,this.userRole=a,this.ssoEnabled=t,this.alive=!0,this.expired=!1},destroy:function(){this.userId=null,this.userRole=null,this.ssoEnabled=!1,this.alive=!1,this.expired=!1}}}).factory("authService",["$resource","$rootScope","localStorageService","permissionModel","session","AUTH_EVENTS","events","$q","$cookies","configurationModel",function(e,t,a,n,i,o,r,s,l,c){function d(e){return!(!e||""===e)&&new RegExp("^(http|https)://","i").test(e)}var u=e("/smartit/rest/users/sessions/:userId",{},{login:{method:"POST"},logout:{method:"DELETE",headers:{"Content-Type":"application/json"},data:""},sessionStatus:{method:"GET",url:"/smartit/rest/sessionstatus"},serverState:{method:"GET",url:"/smartit/rest/serverstates"},licenceDeregister:{method:"POST",url:"/smartit/rest/arlicense/timeout/deregister"}}),p=!1,m=null,f={login:function(e,n){return u.login(e,n).$promise.then(function(n){if(e.userId=e.userId?decodeURIComponent(e.userId):null,_.isEmpty(n.accessObjects)){console.log("login response returned no access rights");var l=p?s.when(1):u.logout().$promise;return l.then(function(){return s.reject({status:401})})}console.log("login success"),i.create(e.userId||n.loginId,p),a.set("user.userId",i.userId),n.csrf&&a.set("user.antiCsrfToken",n.csrf),t.$broadcast(r.PERSON_PERMISSION_DATA_LOADED,n.accessObjects),c.set("enabledServerApplications",n.enabledApplications),c.set("ckEditorSource",{enabled:n.isCKEditorSourceEditable}),c.set("eschatConfiguration",n.eschat),n.attachmentSecurityConfiguration&&c.set("attachmentSecurityConfiguration",n.attachmentSecurityConfiguration),t.$broadcast(o.LOGIN_SUCCESS,{isSsoEnabled:p})})},logout:function(){var e=u.logout().$promise;return e.then(function(e){console.log("logout success"),a.remove("user.userId"),sessionStorage.removeItem("calendarFilterState"),sessionStorage.removeItem("calendarFilterView"),sessionStorage.removeItem("calendarFilterDate"),i.destroy();var n={};_.isEmpty(e)||!e.postLogoutUrl&&!e.redirectUrl||(n=e),t.$broadcast(o.LOGOUT_SUCCESS,n)}),e},sessionStatus:function(){return u.sessionStatus({getLicenseKey:!0}).$promise.then(function(e){i.alive=1===e.session,m=e["midtier.base.url"],d(m)?t.$broadcast(r.MIDTIER_URL_LOADED,m):localStorage.removeItem("midtierUrl"),i.alive&&!_.isEmpty(e.accessObjects)?(i.expired=!1,i.userId=a.get("user.userId"),i.userId||(i.userId=l.get("loginId"),a.set("user.userId",i.userId)),t.$broadcast(r.PERSON_PERMISSION_DATA_LOADED,e.accessObjects),c.set("enabledServerApplications",e.enabledApplications),c.set("ckEditorSource",{enabled:e.isCKEditorSourceEditable}),c.set("eschatConfiguration",e.eschat),t.licenseKeys=e.licenseKeys,e.attachmentSecurityConfiguration&&c.set("attachmentSecurityConfiguration",e.attachmentSecurityConfiguration)):i.destroy(),console.log("session status:",i)})},serverState:function(){return u.serverState().$promise.then(function(e){p=2===parseInt(e[0],10),console.log("SSO "+(p?"enabled":"disabled"))})},isAuthenticated:function(){return!!i.userId},isAuthorized:function(e){return this.isAuthenticated()&&n.hasRole(e)},isSSOEnabled:function(){return p},getMidtierUrl:function(){return m},deRegister:function(){return u.licenceDeregister()}};return f}])}(),function(){angular.module("securityModule").directive("hasPermission",["permissionModel","events",function(e,t){return{link:function(a,n,i){function o(){var t=e.hasPermission(r);t?n.show():n.hide()}if(!_.isString(i.hasPermission))throw"hasPermission value must be a string";var r=i.hasPermission.trim();o(),a.$on(t.PERMISSIONS_CHANGED,o)}}}])}(),function(){angular.module("securityModule").factory("permissionModel",["$rootScope","events","AUTH_EVENTS","roles",function(e,t,a,n){function i(a,i){s=i,_.find(s,{id:n.ITSM_ADMIN_ROLE,permission:"write"})&&(r=["admin:screenConfiguration"]),_.find(s,{id:n.ITSM_ASSET_USER_ROLE,permission:"write"})&&s.push({id:n.ITSM_ASSET_ADMIN_ROLE,permission:"write"}),e.$broadcast(t.PERMISSIONS_CHANGED)}function o(){l.setPermissions([])}var r=[],s=[],l={};return l.setPermissions=function(a){r=a,e.$broadcast(t.PERMISSIONS_CHANGED)},l.hasPermission=function(e){return!!_.includes(r,e.trim())||_.find(s,{id:e,permission:"write"})},l.getRolePermission=function(e){return _.find(s,{id:e})},l.hasAssetCreatePermission=function(){var e=l.getRolePermission("galileo-asset-access"),t=l.getRolePermission("galileo-asset-creator");return!!(e&&"write"===e.permission||e&&"read"===e.permission&&t&&"write"===t.permission)},l.hasPermissionForCalendar=function(e){var t;t=e==EntityVO.TYPE_CHANGE?n.ITSM_CHANGE_USER_ROLE:e==EntityVO.TYPE_RELEASE?n.ITSM_RELEASE_USER_ROLE:n.ITSM_AGENT_ROLE;var a=_.findIndex(s,{id:t});return a>-1},l.hasPermissionForTicket=function(e){var t;t=e==EntityVO.TYPE_CHANGE?n.ITSM_CHANGE_USER_ROLE:e==EntityVO.TYPE_PROBLEM||e==EntityVO.TYPE_KNOWNERROR?n.ITSM_PROBLEM_USER_ROLE:e==EntityVO.TYPE_RELEASE?n.ITSM_RELEASE_USER_ROLE:e==EntityVO.TYPE_KNOWLEDGE?n.ITSM_KNOWLEDGE_USER_ROLE:e==EntityVO.TYPE_ASSET?n.ITSM_ASSET_USER_ROLE:n.ITSM_AGENT_ROLE;var a=_.findIndex(s,{id:t,permission:"write"});return a===-1&&e===EntityVO.TYPE_TASK&&(a=_.findIndex(s,function(e){return e.id===n.ITSM_PROBLEM_USER_ROLE||e.id===n.ITSM_CHANGE_USER_ROLE})),a!==-1},l.hasRole=function(e){return void 0!==_.find(s,function(t){return t.id===e.trim()})},e.$on(t.PERSON_PERMISSION_DATA_LOADED,i),e.$on(a.LOGOUT_SUCCESS,o),l.checkLiveChatRoles=function(){return l.hasRole(n.ESCHAT_AGENT_ROLE)&&l.hasRole(n.ESCHAT_ADMIN_ROLE)},l.hasAdminOnlyRole=function(){var e=l.hasRole(n.ITSM_ADMIN_ROLE),t=l.hasRole(n.ITSM_AGENT_ROLE)||l.hasRole(n.ITSM_CHANGE_USER_ROLE)||l.hasRole(n.ITSM_KNOWLEDGE_USER_ROLE);return e&&!t},l.hasKnowledgeOnlyRole=function(){var e=_.reject(s,{id:n.ITSM_ADMIN_ROLE});return 1===e.length&&l.hasRole(n.ITSM_KNOWLEDGE_USER_ROLE)},l}])}(),angular.module("serviceRequestModule").directive("fulfillmentMap",["relationModel","pwaModel","$state","configurationModel","systemAlertService","$filter",function(e,t,a,n,i,o){return{restrict:"E",scope:{context:"=",isDraft:"="},link:function(r){r.state={},r.isDraft||(r.state.loadingLinkedResources=!0,e.refreshRelations(r.context.id,r.context.ticketType).then(function(e){r.relatedTickets=_.filter(e,{tag:RelationItemVO.TAG_LINKEDITEM}),r.activeRelatedTickets=_.filter(r.relatedTickets,function(e){return e.isAppEnabled=n.isServerApplicationEnabled(e.type),r.isfulfillmentActive(e)}),r.closedRelatedTickets=_.difference(r.relatedTickets,r.activeRelatedTickets)})["finally"](function(){r.state.loadingLinkedResources=!1})),r.showRelatedTicketDetails=function(e){if(e.type===EntityVO.TYPE_ASSET){var r={assetId:e.id,assetClassId:e.additionalInformation.classId};a.go(e.realObject.processStepType,r)}else if(n.isServerApplicationEnabled(e.type)){r={id:e.id};var s=e.realObject.processStepType;t.isPwaEnabled()&&n.get("pwaEnabledTickets.tickets").indexOf(s)>=0&&(s!==EntityVO.TYPE_RELEASE&&s!==EntityVO.TYPE_ACTIVITY||"true"===n.enableReleasePV)&&(s=s&&s+"PV"),a.go(s,r)}else i.alertStack.length&&i.dismissAllAlerts(),i.warning({text:o("i18n")("person.preview.notification.disabled.application"),hide:1e4})},r.fulfillmentStatusClass=function(e){var t="",a=e.realObject&&e.realObject.processStepStatus||"";switch(a){case"In Progress":t="resource-slice__fulfillment-item_in-progress";break;case"Pending":t="resource-slice__fulfillment-item_pending";break;case"Planning":t="resource-slice__fulfillment-item_planning";break;case"Activated":t="resource-slice__fulfillment-item_activated";break;case"Completed":t="resource-slice__fulfillment-item_completed";break;case"Cancelled":t="resource-slice__fulfillment-item_cancelled";break;case"Error":t="resource-slice__fulfillment-item_error";break;default:t=""}return t},r.fulfillmentIconClass=function(e){var t="",a=e.realObject&&e.realObject.processStepStatus||"";switch(a){case"In Progress":t="icon-circle";break;case"Pending":case"PENDING":t="icon-circle";break;case"Planning":case"Activated":case"ACTIVE":t="icon-calendar";break;case"Completed":case"COMPLETED":t="icon-check_circle";break;case"Cancelled":case"CANCELLED":t="icon-cross_circle";break;case"Error":case"FAILED":t="icon-alert_circle";break;default:t=""}return t},r.isfulfillmentActive=function(e){e.realObject&&e.realObject.returnCode&&"error"===e.realObject.returnCode&&(e.realObject.processStepStatus="Error");var t=e.realObject&&e.realObject.processStepStatus||"",a="In Progress"===t||"Pending"===t||"Planning"===t||"Activated"===t;return"sberequest"!==r.context.type||a||(a=_.indexOf(["NEW","ACTIVE","SUSPENDED","PENDING","WAITING_FOR_APPROVAL","APPROVED"],t)),a}},templateUrl:"views/service-request/fulfillment-map.html"}}]),ServiceRequestVO.prototype=new TicketVO,ServiceRequestVO.prototype.constructor=ServiceRequestVO,ServiceRequestVO.prototype.getProps=function(){return TicketVO.prototype.getProps().concat("quantity","price","expectedDate","requiredDate","isCrossLaunchRequest","isCrossLaunchSubmitted","crossLaunchURL","crossLaunchURLDisplay","crossLaunchURLCreate","requestTemplateTitle","requestTemplateId","questionDefinitions","conditionalQuestions","questionResponses","currency","instructions","approvalSummaries","hideAttributes","accessMappings","completionDate")},ServiceRequestVO.prototype.postBuild=function(){if(this.hideAttributes){var e=this;_.each(this.hideAttributes,function(t){e.isAttributeHidden[t]=!0})}if(_.isEmpty(this.accessMappings))this.accessMappings={detailsEditAllowed:!1,statusEditAllowed:!0,timelineEditAllowed:!0,relationsEditAllowed:!1};else{for(var t={},a=0;a<this.accessMappings.length;a++){var n=this.accessMappings[a].id.indexOf("action")!==-1?this.accessMappings[a].id.replace(/\-/g,"").replace("action","")+"ActionAllowed":this.accessMappings[a].id+"EditAllowed";t[n]="write"===this.accessMappings[a].permission}this.accessMappings=t}this.resolvedDate=this.completionDate},function(){angular.module("smartRecorderModule").controller("SmartRecorderController",["$log","$scope","$state","$q","$filter","$sce","ticketModel","metadataModel","$timeout","ticketTemplateModel","smartRecorderModel","categoriesService","i18nService","systemAlertService","localStorageService","srdModel","configurationModel","events","$stateParams","relationModel","utilityFunctions","$modal","userModel","authModel","pwaModel",function(e,t,a,n,i,o,r,s,l,c,d,u,p,m,f,g,h,y,E,v,T,S,C,O,A){function I(e,a){Q(),a.relationship="customer",a.relDisplayName=p.getLocalizedString("smartrecorder.personTypeMenu.shortName.customer"),a.displayName=a.content.fullName,t.addConfirmedItem(a)}function b(e,t){var n=d.smartRecorderData&&d.smartRecorderData.template,i=_.isEmpty(n)?null:n.id;!h.quickTicketCreateEnabled||t===EntityVO.TYPE_SERVICEREQUEST&&i&&n&&n.templateObject&&n.templateObject.isCrossLaunchRequest?a.go(e):Y(t,e)}function k(){t.$on("$stateChangeStart",function(){t.smartRecorderData.isDirty()&&d.saveState||!h.showNameInSmartRecorderCreateTicket&&!t.smartRecorderData.isDirty()&&t.smartRecorderData.customer&&t.smartRecorderData.customer.firstName?(d.smartRecorderData=(new SmartRecorderVO).build(t.smartRecorderData),t.smartRecorderData.resetDirty()):d.saveState=!1})}function D(e){if(e){var t="";_.isObject(e)?t=e.data&&e.data.error||e.detailMessage||e.message:_.isString(e)&&(t=e),m.modal({title:p.getLocalizedString("common.notification.error.title"),text:t,buttons:[{text:p.getLocalizedString("controls.action.ok")}]})}}function R(e){var o,l,c,u=!1;t.loading=!0;var p=s.getMetadataByType(EntityVO.TYPE_INCIDENT).then(function(e){o=e}),f=t.smartRecorderData.template?t.smartRecorderData.template.id:null,g=r.getDraft(EntityVO.TYPE_INCIDENT,f,t.smartRecorderData.desc).then(function(e){l=e});angular.isDefined(t.smartRecorderData.template)&&null!==t.smartRecorderData.template&&h.copyPrimaryCategoriesOnResolve&&_.forEach(t.smartRecorderData.template.templateObject.categorizations,function(e){(angular.isDefined(e.tiers.productCategoryTier1)||angular.isDefined(e.tiers.operationCategoryTier1))&&(u=!0)}),n.all([p,g]).then(function(){l.status={value:"Resolved",reason:"No Further Action Required"},l.resolution=e.title,_.isEmpty(t.smartRecorderData.customer)||(l.customer=t.smartRecorderData.customer,l.customer.accessMappings&&delete l.customer.accessMappings,l.company=t.smartRecorderData.customer.company.name),_.isEmpty(t.smartRecorderData.contact)||(l.contact=t.smartRecorderData.contact),t.smartRecorderData.desc&&(l.desc=t.smartRecorderData.desc),l.impact||(l.impact=_.last(o.impacts).name),l.urgency||(l.urgency=_.last(o.urgencies).name),_.isEmpty(t.smartRecorderData.impactedService)||(l.impactedService={},l.impactedService.name=t.smartRecorderData.impactedService.name,l.impactedService.reconciliationId=t.smartRecorderData.impactedService.reconciliationId),_.isEmpty(t.smartRecorderData.causalCI)||(l.causalCI={},l.causalCI.name=t.smartRecorderData.causalCI.name,l.causalCI.reconciliationId=t.smartRecorderData.causalCI.reconciliationId);var n=[];if(!_.isEmpty(t.smartRecorderData.confirmedResourceList))for(var s=t.smartRecorderData.confirmedResourceList,p=0;p<s.length;p++){var f=s[p];f=(new RelationItemVO).build(f),f.parentId=l.id,f.isPoi=void 0,f.realObject=void 0,f.entityLink=void 0,f.details={parentDisplayId:l.displayId},f.tag||(f.tag=EntityVO.TYPE_RESOURCE),f.relationshipType||(f.relationshipType=EntityVO.TYPE_RELATEDTO),n.push(f)}_.isEmpty(t.smartRecorderData.relatedAsset)||_.forEach(t.smartRecorderData.relatedAsset,function(e){n.push({id:e.reconciliationId,type:EntityVO.TYPE_ASSET,tag:EntityVO.TYPE_LINKEDITEM,desc:e.name,relationshipType:EntityVO.TYPE_RELATEDTO,parentId:l.id,displayId:l.displayId})}),delete l.accessMappings,u?(c=m.modal({type:"info",title:"Warning",text:i("i18n")("resourceSlice.categoryMismatch.message"),buttons:[{text:i("i18n")("common.button.yes"),data:!0},{text:i("i18n")("common.button.no"),data:!1}]}),t.loading=!1,c.result.then(function(i){i?(t.loading=!0,e.categorizations.forEach(function(e){l.categorizations.forEach(function(t){e.name===t.name&&(t.tiers=e.tiers)})}),r.saveDraft(EntityVO.TYPE_INCIDENT,l).then(function(){v.addRelation({uuid:l.id,type:EntityVO.TYPE_INCIDENT},n).then(function(){d.saveState=!1,a.go(EntityVO.TYPE_INCIDENT,{id:l.id})})["catch"](function(e){D(e)})["finally"](function(){t.loading=!1})})["catch"](function(e){D(e),t.loading=!1})):(t.loading=!0,r.saveDraft(EntityVO.TYPE_INCIDENT,l).then(function(){v.addRelation({uuid:l.id,type:EntityVO.TYPE_INCIDENT},n).then(function(){d.saveState=!1,a.go(EntityVO.TYPE_INCIDENT,{id:l.id})})["catch"](function(e){D(e)})["finally"](function(){t.loading=!1})})["catch"](function(e){D(e),t.loading=!1}))})):(t.loading=!0,h.copyPrimaryCategoriesOnResolve&&e.categorizations.forEach(function(e){l.categorizations.forEach(function(t){e.name===t.name&&(t.tiers=e.tiers)})}),r.saveDraft(EntityVO.TYPE_INCIDENT,l).then(function(){v.addRelation({uuid:l.id,type:EntityVO.TYPE_INCIDENT},n).then(function(){d.saveState=!1,a.go(EntityVO.TYPE_INCIDENT,{id:l.id})})["catch"](function(e){D(e)})["finally"](function(){t.loading=!1})})["catch"](function(e){D(e),t.loading=!1}))})}function P(){f.set("smartRecorder.drafts",t.storedDrafts)}function w(){var e=_.find(t.smartRecorderData.confirmedItems,function(e){return"customer"===e.relationship});return void 0===e&&(d.customer={},t.smartRecorderData.customer=null),!!e}function L(){var e=_.find(t.smartRecorderData.confirmedItems,function(e){return"contact"===e.relationship});return void 0===e&&(t.smartRecorderData.contact=null),!!e}function N(){var e=_.find(t.smartRecorderData.confirmedItems,function(e){return"affectedasset"===e.relationship});return void 0===e&&(t.smartRecorderData.causalCI=null),!!e}function M(){t.smartRecorderData.relatedAsset=[],$.each(t.smartRecorderData.confirmedItems,function(e,a){"relatedasset"===a.relationship&&t.smartRecorderData.relatedAsset.push(a.content)})}function V(){v.cache[EntityVO.TYPE_SMARTRECORDER]=[],t.smartRecorderSetSecondPersonAsCustomer=!1,t.$watchCollection("smartRecorderData.confirmedResourceList",function(e){v.cache[EntityVO.TYPE_SMARTRECORDER].length=0,Array.prototype.push.apply(v.cache[EntityVO.TYPE_SMARTRECORDER],e)},!0),t.$on(y.SAVE_TO_TICKET_FROM_RS,F),t.$on(y.REMOVE_FROM_TICKET_FROM_RS,x),t.$on(y.RESOLVE_TICKET_FROM_RS,G),t.$on(y.MARK_AS_DUPLICATE_OF_FROM_RS,B),t.$on(y.SELECT_TEMPLATE_FROM_RS,U),t.$on(y.UNSELECT_TEMPLATE_FROM_RS,z);var e,a,i=!0;if(d.saveState&&d.smartRecorderData&&d.oldStateParams?J.customer!==d.oldStateParams.customer?i=!1:J.contact!==d.oldStateParams.contact?i=!1:J.desc!==d.oldStateParams.desc&&(i=!1):i=!1,d.oldStateParams=J,e=s.getMetadataByType(EntityVO.TYPE_GLOBAL),a=s.getMetadataByType(EntityVO.TYPE_SMART_RECORDER),t.eventTypes=[],n.all([e,a]).then(function(e){e[0]&&(j=e[0],t.restrictAssetSearchToCustomer=j.configurationParameters&&j.configurationParameters.restrictAssetSearchToCustomer,t.showCallLogButton=j.configurationParameters&&"true"===j.configurationParameters.enableSmartRecorderCallLog,j.configurationParameters&&"true"===j.configurationParameters.smartRecorderSetSecondPersonAsCustomer&&(t.smartRecorderSetSecondPersonAsCustomer=!0),j.configurationParameters&&j.configurationParameters["smartit.url"]&&(d.smartitUrl=j.configurationParameters["smartit.url"]),j.configurationParameters&&j.configurationParameters["dwp.base.url"]&&(d.dwpUrl=j.configurationParameters["dwp.base.url"]),j.configurationParameters&&j.configurationParameters.dwpCatalogChunkSize&&(d.dwpCatalogChunkSize=j.configurationParameters.dwpCatalogChunkSize),j.configurationParameters&&j.configurationParameters.enableDWPWidgetIntegration&&(t.enableDWPWidgetIntegration=h.enableDWPWidgetIntegration="true"===j.configurationParameters.enableDWPWidgetIntegration),t.enableSbeIntegration&&t.ssoEnabled&&t.enableDWPWidgetIntegration||(_.remove(t.filterConfig,{name:"recommendedDwpTemplates"}),console.error("There is problem with enableDWPWidgetIntegration or enableSbeIntegration or rsso configuration"))),e[1]&&(W=e[1],t.eventTypes=W.callLogEventTypes)}),!i&&(J.customer||J.contact||J.desc)){var r,c;t.loading=!0,t.clear(),d.saveState=!0,J.contact&&(c=d.getListOfPersons(J.contact,20)),J.customer&&(r=d.getListOfPersons(J.customer,20)),J.desc&&(t.smartRecorderData.desc=J.desc,t.smartRecorderData.textareaHtml=J.desc,t.smartRecorderData.inputTextHtml=J.desc),n.all([r,c,e]).then(function(e){if(e[1]){var a,n,i=e[1].list;if(1===i.length?a=i[0]:i.length>1&&(a=_.find(i,{corporateId:J.contact}),a||(a=_.find(i,{id:J.contact}),a||(a=_.find(i,{email:J.contact}),a||(a=_.find(i,{fullName:J.contact}))))),a)n={displayName:a.fullName,id:a.id,type:"person",originalName:J.contact,content:a,relationship:"contact",relDisplayName:p.getLocalizedString("common.label.contact")},t.addConfirmedItem(n);else{var o=p.getLocalizedStringwithParams("smartrecorder.noMatch.label",J.contact);m.error({text:o,clear:!1})}}if(e[0]){var r,s,l=e[0].list;if(1===l.length?r=l[0]:l.length>1&&(r=_.find(l,{corporateId:J.customer}),r||(r=_.find(l,{id:J.customer}),r||(r=_.find(l,{email:J.customer}),r||(r=_.find(l,{fullName:J.customer}))))),r)s={displayName:r.fullName,id:r.id,type:"person",originalName:J.customer,content:r,relationship:"customer",relDisplayName:p.getLocalizedString("common.label.customer")},t.addConfirmedItem(s);else{var c=p.getLocalizedStringwithParams("smartrecorder.noMatch.label",J.customer);m.error({text:c,clear:!1})}}J.desc&&t.smartSearch()})["finally"](function(){t.loading=!1})}else d.saveState&&d.smartRecorderData?A.isPwaEnabled()&&A.isDraftCallMade()?(t.clear(),A.draftCallMade=!1):(t.smartRecorderData=(new SmartRecorderVO).build(d.smartRecorderData),t.smartRecorderData.textareaHtml=o.trustAsHtml(t.smartRecorderData.inputTextHtml),t.loading=!1,l(function(){t.smartSearch()},0)):(t.clear(),d.saveState=!0,t.loading=!1);k()}function F(e,a){var n="resolved"===a.relationshipType?RelationItemVO.TYPE_RESOLVEDBY:RelationItemVO.TYPE_RELATEDTO;angular.extend(a,{tag:EntityVO.TYPE_RESOURCE,relationshipType:n}),t.smartRecorderData.confirmedResourceList.push(a)}function x(e,a){var n=_.findIndex(t.smartRecorderData.confirmedResourceList,{id:a.id});t.smartRecorderData.confirmedResourceList.splice(n,1)}function G(e,a,n){t.smartRecorderData.resourceForIncident=a,R(n)}function B(e,n){t.smartRecorderData.confirmedResourceList.push(n),z(),t.loading=!0;var i={customerLoginId:t.smartRecorderData.customer.id,desc:t.smartRecorderData.desc,summary:t.smartRecorderData.desc};r.applyAction(n.id,EntityVO.TYPE_INCIDENT,EntityVO.ACTION_DUPLICATE,i).then(function(e){_.isEmpty(e)||(i=e[0].items[0],d.saveState=!1,t.loading=!1,a.go(EntityVO.TYPE_INCIDENT,{id:i.id}))},function(e){d.saveState=!1,t.loading=!1,x(null,n)})}function U(e,a){t.smartRecorderData.template=a}function z(){t.smartRecorderData.template&&t.$broadcast("smartRecorderConfirmItemDelete",{id:t.smartRecorderData.template.id,displayName:t.smartRecorderData.template.name}),t.smartRecorderData.template=null}function Y(e,a){var i,o,l;t.loading=!0;var c=t.smartRecorderData.customer&&t.smartRecorderData.customer.company&&t.smartRecorderData.customer.company.name,u=s.getMetadataByType(e),p=t.smartRecorderData.template?t.smartRecorderData.template.id:null,m=r.getDraft(e,p,t.smartRecorderData.desc,c,null,t.smartRecorderData.customer);n.all([u,m]).then(function(s){i=s[0],l=s[1],_.isEmpty(t.smartRecorderData.customer)||(l.customer=t.smartRecorderData.customer,e===EntityVO.TYPE_WORKORDER?(_.isEmpty(l.completedDate)&&(l.completedDate=null),l.locationCompany=t.smartRecorderData.customer.company):l.company=t.smartRecorderData.customer.company.name),!l.hasOwnProperty("serviceType")||l.serviceType||t.smartRecorderData.template&&t.smartRecorderData.template.templateObject&&t.smartRecorderData.template.templateObject.serviceType||delete l.serviceType,
_.isEmpty(t.smartRecorderData.contact)||(l.contact=t.smartRecorderData.contact),t.smartRecorderData.desc&&(l.desc=t.smartRecorderData.desc),e===EntityVO.TYPE_INCIDENT&&(l.impact||(l.impact=_.last(i.impacts).name),l.urgency||(l.urgency=_.last(i.urgencies).name),d.smartRecorderData.template&&d.smartRecorderData.template.name&&(l.templateName=d.smartRecorderData.template.name)),_.isEmpty(t.smartRecorderData.impactedService)||(l.impactedService={},l.impactedService.name=t.smartRecorderData.impactedService.name,l.impactedService.reconciliationId=t.smartRecorderData.impactedService.reconciliationId),_.isEmpty(t.smartRecorderData.causalCI)||(l.causalCI={},l.causalCI.name=t.smartRecorderData.causalCI.name,l.causalCI.reconciliationId=t.smartRecorderData.causalCI.reconciliationId),o=_.cloneDeep(l),o=q(o,e);var c=[];if(!_.isEmpty(t.smartRecorderData.confirmedResourceList))for(var u=t.smartRecorderData.confirmedResourceList,p=0;p<u.length;p++){var m=u[p];m=(new RelationItemVO).build(m),m.parentId=o.id,m.isPoi=void 0,m.realObject=void 0,m.entityLink=void 0,m.details={parentDisplayId:o.displayId},m.tag||(m.tag=EntityVO.TYPE_RESOURCE),m.relationshipType||(m.relationshipType=EntityVO.TYPE_RELATEDTO),c.push(m)}_.isEmpty(t.smartRecorderData.relatedAsset)||_.forEach(t.smartRecorderData.relatedAsset,function(e){c.push({id:e.reconciliationId,type:EntityVO.TYPE_ASSET,tag:EntityVO.TYPE_LINKEDITEM,desc:e.name,relationshipType:EntityVO.TYPE_RELATEDTO,parentId:o.id,displayId:o.displayId})});var f=!0;r.saveQuickTicketDraft(e,o).then(function(){if(c.length>0){var i=[],r=[];h.comaroundEnabled&&(r=_.remove(c,{type:EntityVO.TYPE_KNOWLEDGE}),r&&r.length&&i.push(v.bulkAddRelationHKM({uuid:o.displayId},r))),c.length&&i.push(v.addRelation({uuid:o.id,type:e},c)),f=!1,n.all(i).then(function(){d.saveState=!1,H(e,o.id,o.displayId)})["catch"](function(t){K(e,a,t)})["finally"](function(){t.loading=!1})}else H(e,o.id,o.displayId)})["catch"](function(t){r.cache.draft=l,K(e,a,t)})["finally"](function(){f&&(t.loading=!1)})})}function q(e,t){var a,n;return delete e.accessMappings,e.customer.accessMappings&&delete e.customer.accessMappings,t===EntityVO.TYPE_INCIDENT?(""===e.causalCI&&(delete e.causalCI,delete e.causalCIreconId),""===e.impactedService&&(delete e.impactedService,delete e.impactedServiceReconId),e.contact&&e.contact.accessMappings&&delete e.contact.accessMappings):t===EntityVO.TYPE_WORKORDER?(n=e,a={id:n.id,displayId:n.displayId,summary:n.summary,customer:n.customer,desc:n.desc,priority:n.priority,status:n.status,categorizations:n.categorizations,type:EntityVO.TYPE_WORKORDER},n.location&&n.location.poiId&&(a.location={poiId:n.location.poiId}),n.locationCompany&&(a.locationCompany=n.locationCompany),n.contact&&n.contact.id&&(a.contact=n.contact),n.impactedService&&(a.impactedService=n.impactedService),n.scheduledStartDate&&(a.scheduledStartDate=moment(n.scheduledStartDate).valueOf()),n.scheduledEndDate&&(a.scheduledEndDate=moment(n.scheduledEndDate).valueOf()),n.actualStartDate&&(a.actualStartDate=moment(n.actualStartDate).valueOf()),n.actualEndDate&&(a.actualEndDate=moment(n.actualEndDate).valueOf()),n.supportGroup&&(a.supportGroup=n.supportGroup),n.assignee&&(a.assignee=n.assignee),n.managerGroup&&(a.managerGroup=n.managerGroup),n.manager&&(a.manager=n.manager),n.templateId&&(a.templateId=n.templateId),n.templateName&&(a.templateName=n.templateName),null!==n.woAutomationStatus&&void 0!==n.woAutomationStatus&&""!==n.woAutomationStatus&&(a.woAutomationStatus=n.woAutomationStatus),n.attachments&&(a.attachments=n.attachments),_.size(n.customFields)&&(a.customFields=n.customFields),n.dynamicFields&&(a.dynamicFields=n.dynamicFields),e=a):t===EntityVO.TYPE_SERVICEREQUEST&&(a={},a.displayId=e.displayId,a.id=e.id,a.summary=e.summary,a.desc=e.desc,a.requestTemplateTitle=e.requestTemplateTitle,a.requestTemplateId=e.requestTemplateId,a.customer={loginId:e.customer.loginId},a.contact=e.contact?{loginId:e.contact.loginId}:{loginId:e.customer.loginId},e.isAttributeHidden.quantity||_.isEmpty(e.quantity)||(a.quantity=e.quantity),a.questionResponses=[],_.forEach(e.questionDefinitions,function(t){if(t.visibility||t.isHidden){var n;if(t.isHidden&&t.parentId){var i=_.find(e.questionDefinitions,{id:t.parentId}),o=T.calculateConditionalQuestionVisibility(i,t,!1);if(!o)return t}if("CHECK_BOXES"===t.format&&t.answer)angular.isArray(t.answer)&&(n=t.answer.join(";"));else if("CHECK_BOXES"!==t.format&&"STATIC_MENU"!==t.format&&"QUERY_MENU"!==t.format&&"RADIO_BUTTONS"!==t.format||t.answer)"DATE_TIME"===t.format||"DATE_ONLY"===t.format||"TIME_ONLY"===t.format?n=t.answer?T.convertDateTimeAnswerToISO8601(t.answer):null:(n=t.answer,t.isHidden&&!n&&(n=t.defaultValue));else{var r=[];_.forEach(t.options,function(e){e.isDefault&&r.push(e.value)}),n=r.join(";")}a.questionResponses.push({questionId:t.id,value:n,order:t.sortOrder})}}),e=a),e}function H(e,a,n){t.clear();var o="<p class='smart-recorder__systemalert'>"+i("i18n")("smartrecorder.quickTicketCreate.success",[T.getTicketCreatedSuccessMessageWithLink(a,n,e)])+"</p>";m.success({text:o,clear:!0,hide:1e4,isHTML:!0})}function K(e,n,i){if(t.loading=!1,A.isPwaEnabled())switch(A.smartRecorderData=(new SmartRecorderVO).build(t.smartRecorderData),e){case EntityVO.TYPE_INCIDENT:n="pwaDraftIncident";break;case EntityVO.TYPE_WORKORDER:n="pwaDraftWorkorder"}a.go(n,{error:i&&i.data&&i.data.error||i})}t.subTypes=[{displayName:p.getLocalizedString("smartrecorder.personTypeMenu.displayName.customer"),shortName:p.getLocalizedString("common.label.customer"),type:"person",relationship:"customer"},{displayName:p.getLocalizedString("smartrecorder.personTypeMenu.displayName.contact"),shortName:p.getLocalizedString("smartrecorder.personTypeMenu.shortName.contact"),type:"person",relationship:"contact"},{displayName:p.getLocalizedString("smartrecorder.personTypeMenu.displayName.mentioned"),shortName:p.getLocalizedString("smartrecorder.personTypeMenu.shortName.mentioned"),type:"person",relationship:"mentioned"},{displayName:p.getLocalizedString("common.label.asset"),shortName:p.getLocalizedString("common.label.asset"),type:"asset",relationship:"affectedasset"},{displayName:p.getLocalizedString("smartrecorder.AssetTypeMenu.displayName.RelatedAsset"),shortName:p.getLocalizedString("smartrecorder.AssetTypeMenu.displayName.RelatedAsset"),type:"asset",relationship:"relatedasset"},{displayName:p.getLocalizedString("smartrecorder.AssetTypeMenu.displayName.BusinessService"),shortName:p.getLocalizedString("smartrecorder.AssetTypeMenu.displayName.BusinessService"),type:"businessservice",relationship:"businessservice"}],t.context={id:EntityVO.TYPE_SMARTRECORDER,type:EntityVO.TYPE_SMARTRECORDER},t.showSmartSearchResults=!1,t.loading=!1,t.storedDrafts=[],t.recommendedOutagesFound=!1,t.recommendedArticlesFound=!1,t.recommendedTemplatesFound=!1,t.recommendedTicketsFound=!1,t.customerAddedFromAsset=!1,t.enableSbeIntegration=h.isServerApplicationEnabled(EntityVO.TYPE_SBEREQUEST),t.ssoEnabled=O.isSSOEnabled(),t.enableDWPWidgetIntegration=h.enableDWPWidgetIntegration,t.showPreview=function(e){t.smartRecorderData.previewId=e},t.hidePreview=function(){t.smartRecorderData.previewId=""},t.filterConfig=h.get("resource.filter"),t.filterConfigMap=_.keyBy(t.filterConfig,"name"),t.appliedFilters=[],t.isSRMInstalled=h.isServerApplicationEnabled(EntityVO.TYPE_SERVICEREQUEST),t.isWOInstalled=h.isServerApplicationEnabled(EntityVO.TYPE_WORKORDER),t.quickTicketCreateEnabled=h.quickTicketCreateEnabled,t.eventTypes=[],t.showCallLogButton=!1;var j,W,Q,J=E;t.handleKeydown=function(e,a){32===e.keyCode&&(t.applyFilter(a),e.preventDefault(),e.stopPropagation())},t.applyFilter=function(e){e.selected=!e.selected},t.selectAllFilters=function(e){_.forEach(t.filterConfig,function(t){t.selected=e})},t.addConfirmedItem=function(e){var a=!0;$.each(t.smartRecorderData.confirmedItems,function(t,n){if(e.id===n.id)return a=!1,!1}),a&&("person"===e.type&&w()&&L()?(e.relationship="mentioned",e.relDisplayName=p.getLocalizedString("smartrecorder.personTypeMenu.shortName.mentioned")):"person"===e.type&&"customer"===e.relationship&&w()?(e.relationship="contact",e.relDisplayName=p.getLocalizedString("smartrecorder.personTypeMenu.shortName.contact")):"person"===e.type&&"contact"===e.relationship&&L()&&(e.relationship="customer",e.relDisplayName=p.getLocalizedString("smartrecorder.personTypeMenu.shortName.customer")),w()&&t.smartRecorderSetSecondPersonAsCustomer&&!L()&&"person"===e.type&&(t.customerAddedFromAsset||(e.relationship="customer",e.relDisplayName="customer")),t.confirmedItemRelChange(e,e.relationship,e.relDisplayName),t.smartRecorderData.confirmedItems.push($.extend(!0,{},e)),"true"!==j.configurationParameters.defaultCustomerToPrimaryContact||w()||"asset"!==e.type||(t.customerAddedFromAsset=!0,Q=t.$on(y.ADD_CUSTOMER_FROM_ASSET,I)),"person"===e.type&&t.showPreview(e.id))},t.confirmedItemRelChange=function(e,a,n){e.relationship=a,e.relDisplayName=n,"person"===e.type&&"customer"===a?(d.customer=e.content,t.context.company=e.content.company.name,t.context.customerId=e.id,t.smartRecorderData.customer=_.cloneDeep(e.content),$.each(t.smartRecorderData.confirmedItems,function(a,n){n.id!==e.id&&"customer"===n.relationship&&($.each(t.smartRecorderData.confirmedItems,function(e,t){n.id!==t.id&&"contact"===t.relationship&&(t.relationship="mentioned",t.relDisplayName=p.getLocalizedString("smartrecorder.personTypeMenu.shortName.mentioned"))}),n.relationship="contact",n.relDisplayName=p.getLocalizedString("smartrecorder.personTypeMenu.shortName.contact"),t.smartRecorderData.contact=n.content)}),L(),t.smartRecorderData.template&&t.smartRecorderData.template.company&&"- Global -"!=t.smartRecorderData.template.company.name&&t.smartRecorderData.customer.company.name!=t.smartRecorderData.template.company.name&&t.unrelateTemplate()):"person"===e.type&&"contact"===a?(t.smartRecorderData.contact=_.cloneDeep(e.content),$.each(t.smartRecorderData.confirmedItems,function(a,n){n.id!==e.id&&"contact"===n.relationship&&(w()?(n.relationship="mentioned",n.relDisplayName=p.getLocalizedString("smartrecorder.personTypeMenu.shortName.mentioned")):(n.relationship="customer",n.relDisplayName=p.getLocalizedString("common.label.customer"),d.customer=n.content,t.context.company=n.content.company.name,t.context.customerId=n.id,t.smartRecorderData.customer=n.content))}),w(),t.smartRecorderData.template&&t.smartRecorderData.template.company&&"- Global -"!=t.smartRecorderData.template.company.name&&t.smartRecorderData.customer.company.name!=t.smartRecorderData.template.company.name&&t.unrelateTemplate()):"person"===e.type&&"mentioned"===a?(w(),L()):"businessservice"===e.type?(t.smartRecorderData.impactedService=e.content,e.relationship="businessservice",e.relDisplayName=p.getLocalizedString("smartrecorder.AssetTypeMenu.displayName.BusinessService"),$.each(t.smartRecorderData.confirmedItems,function(t,a){a.id!==e.id&&"businessservice"===a.relationship&&(a.relationship="relatedasset",a.relDisplayName=p.getLocalizedString("smartrecorder.AssetTypeMenu.displayName.RelatedAsset")),M()})):"asset"===e.type&&"affectedasset"===a?(t.smartRecorderData.causalCI=e.content,$.each(t.smartRecorderData.confirmedItems,function(t,a){a.id!==e.id&&"affectedasset"===a.relationship&&(a.relationship="relatedasset",a.relDisplayName=p.getLocalizedString("smartrecorder.AssetTypeMenu.displayName.RelatedAsset"))}),M()):"asset"===e.type&&"relatedasset"===a&&(t.smartRecorderData.relatedAsset.push(e.content),N())},t.deleteConfirmItem=function(e){$.each(t.smartRecorderData.confirmedItems,function(a,n){if(n.id===e.id&&n.type===e.type){switch(t.smartRecorderData.confirmedItems.splice(a,1),e.isDeleteItem=!0,e.relationship){case"customer":t.smartRecorderData.customer=null,t.context.customerId="",t.customerAddedFromAsset=!1;break;case"contact":t.smartRecorderData.contact=null;break;case"affectedasset":t.smartRecorderData.causalCI=null;break;case"relatedasset":M();break;case"businessservice":t.smartRecorderData.impactedService=null}return t.$broadcast("smartRecorderConfirmItemDelete",e),!1}})},t.saveDraft=function(){var e=t.smartRecorderData;t.storedDrafts.push({title:e.desc,timestamp:(new Date).getTime(),content:e}),P(),t.smartRecorderData=new SmartRecorderVO,t.clear()},t.loadDraft=function(e){t.clear(),t.smartRecorderData=(new SmartRecorderVO).build(e.content),t.smartRecorderData.textareaHtml=t.smartRecorderData.inputTextHtml,t.smartSearch()},t.createDraftIncident=function(){t.$broadcast(y.SAVE_INPUT_BEFORE_SAVE),l(function(){A.isPwaEnabled()&&!h.quickTicketCreateEnabled?(t.loading=!0,t.smartRecorderData.type=EntityVO.TYPE_INCIDENT,A.createIncFromSmartRecorder=!0,A.smartRecorderData=(new SmartRecorderVO).build(t.smartRecorderData),a.go("pwaDraftIncident")):(t.loading=!0,t.smartRecorderData.type=EntityVO.TYPE_INCIDENT,d.smartRecorderData=(new SmartRecorderVO).build(t.smartRecorderData),d.saveState=!1,b("draftIncident",EntityVO.TYPE_INCIDENT))})},t.createDraftWorkorder=function(){t.$broadcast(y.SAVE_INPUT_BEFORE_SAVE),l(function(){A.isPwaEnabled()&&!h.quickTicketCreateEnabled?(t.loading=!0,t.smartRecorderData.type=EntityVO.TYPE_WORKORDER,A.createWOFromSmartRecorder=!0,A.smartRecorderData=(new SmartRecorderVO).build(t.smartRecorderData),a.go("pwaDraftWorkorder")):(t.loading=!0,t.smartRecorderData.type=EntityVO.TYPE_WORKORDER,d.smartRecorderData=(new SmartRecorderVO).build(t.smartRecorderData),d.saveState=!1,b("draftWorkorder",EntityVO.TYPE_WORKORDER))})},t.createDraftRequest=function(){t.loading=!0,t.smartRecorderData.type=EntityVO.TYPE_SERVICEREQUEST,t.$broadcast(y.SAVE_INPUT_BEFORE_SAVE),l(function(){d.smartRecorderData=(new SmartRecorderVO).build(t.smartRecorderData),t.smartRecorderData.contact?g.getRequestOnBehalfOf(t.smartRecorderData.customer.id,t.smartRecorderData.contact.id).then(function(e){if(e)d.saveState=!1,b("draftServicerequest",EntityVO.TYPE_SERVICEREQUEST);else{t.loading=!1;var a=i("i18n")("serviceRequest.onBehalfOf.message",[t.smartRecorderData.contact.fullName,t.smartRecorderData.customer.fullName]);m.error({text:a,clear:!1})}}):(d.saveState=!1,b("draftServicerequest",EntityVO.TYPE_SERVICEREQUEST))})},t.createDraftDwpRequest=function(){t.$broadcast(y.SAVE_INPUT_BEFORE_SAVE),l(function(){S.open({template:'<div class="dwp-header">\n\t\t\t\t\t\t\t\t\t\t<span>{{ \'dwp.new.request\' | i18n }}</span>\n\t\t\t\t\t\t\t\t\t\t<span ng-click="onCrossClick()" class="icon-cross dwp-cross-icon"></span>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t  <dwp-window service-id="selectedTemplate.displayId" requested-for="requestedFor" requested-by="requestedBy" modal-instance="modalInstance"></dwp-window>',windowClass:"action-blade action-blade-left",backdrop:"static",keyboard:!1,controller:["$scope","$modalInstance","systemAlertService","i18nService",function(e,a,n,i){e.selectedTemplate=t.smartRecorderData.template,e.requestedFor=t.smartRecorderData.customer.loginId,e.requestedBy=t.smartRecorderData.contact&&t.smartRecorderData.contact.loginId?t.smartRecorderData.contact.loginId:e.requestedFor,e.modalInstance=a,e.onCrossClick=function(){var t=n.modal({title:i.getLocalizedString("common.button.cancel.request"),text:i.getLocalizedString("dwp.cancel.alert"),backdrop:"static",keyboard:!1,buttons:[{text:i.getLocalizedString("common.button.confirm"),data:!0},{text:i.getLocalizedString("common.button.cancel"),data:!1}]});t.result.then(function(t){t&&e.modalInstance.dismiss()})}}]})})},t.createCallLog=function(e){t.loading=!0,t.smartRecorderData.type=EntityVO.TYPE_CALL_LOG,d.smartRecorderData=(new SmartRecorderVO).build(t.smartRecorderData),d.saveState=!1;var a={persons:[],assets:[]};_.forEach(t.smartRecorderData.confirmedItems,function(e){var t={};e.type===EntityVO.TYPE_PERSON?(t.personId=e.content.personId,t.fullName=e.content.fullName,t.personType=e.relationship,a.persons.push(t)):(t.name=e.content.name,t.classId=e.content.classId,t.reconId=e.content.reconciliationId,a.assets.push(t))}),a.description=t.smartRecorderData.desc,t.smartRecorderData.customer&&(a.company=t.smartRecorderData.customer.company.name),a.callLogEventType=e,d.postCallLog(a).then(function(){t.clear(),m.success({text:p.getLocalizedString("smartrecorder.createCallLog.success"),clear:!0,hide:1e4}),t.loading=!1},function(e){m.error({text:e&&e.data&&e.data.error||e,clear:!0,hide:1e4}),t.loading=!1})},t.toggleDropdown=function(e){e.preventDefault(),e.stopPropagation(),angular.element(e.currentTarget.nextElementSibling).toggle()},t.closeDropdown=function(e){l(function(){angular.element(e.currentTarget.nextElementSibling).hide()},500)},t.clear=function(){t.smartRecorderData=new SmartRecorderVO,t.showSmartSearchResults=!1,t.context.company="",t.context.customerId="",t.context.summary="",t.context.template="",d.customer={},t.customerAddedFromAsset=!1,t.$broadcast("smartRecorderClear")},t.clearResourceTab=function(){t.showSmartSearchResults=!1,t.resourcesFound=!1,t.filterConfigMap={},t.smartRecorderData.template=null},t.smartSearch=function(){t.filterConfigMap=_.keyBy(t.filterConfig,"name"),(t.recommendedOutagesFound||t.recommendedTemplatesFound||t.recommendedArticlesFound||t.recommendedTicketsFound)&&(t.resourcesFound=!0),t.smartRecorderData.customer&&(t.context.customerId=t.smartRecorderData.customer.id||"",t.smartRecorderData.customer.company&&(t.context.company=t.smartRecorderData.customer.company.name||""),t.context.summary=t.smartRecorderData.desc.trim().replace(""," "),$.each(t.smartRecorderData.confirmedItems,function(e,a){"person"===a.type&&a.displayName&&(t.context.summary=t.context.summary.replace(a.displayName,"").trim())}),t.context.accessMappings={relationsEditAllowed:!0,duplicateActionAllowed:!0}),t.context.summary?t.showSmartSearchResults=!0:(t.showSmartSearchResults=!1,t.smartRecorderData.template=null)},t.saveTemplate=function(e){t.context.template=e,U({},e)},t.unrelateTemplate=function(){t.smartRecorderData.desc=t.smartRecorderData.desc.replace(t.context.template.name,""),t.context.template="",z()},t.$on("assetSelected",function(e,a){var n={};n="BMC_BUSINESSSERVICE"===a.classId?{displayName:a.name,id:a.reconciliationId,categories:a.categories,type:"businessservice",content:a,relationship:"businessservice",relDisplayName:p.getLocalizedString("smartrecorder.AssetTypeMenu.displayName.BusinessService")}:{displayName:a.name,id:a.reconciliationId,categories:a.categories,type:"asset",content:a,relationship:"affectedasset",relDisplayName:p.getLocalizedString("common.label.asset")},t.addConfirmedItem(n)}),t.$on("assetUnselected",function(e,a){$.each(t.smartRecorderData.confirmedItems,function(e,n){if(n.id===a.reconciliationId)return t.smartRecorderData.confirmedItems.splice(e,1),"affectedasset"==n.relationship?t.smartRecorderData.causalCI=null:M(),!1})}),t.$on(y.RESOURCES_FOUND,function(e,a){"outages"===a.type?t.recommendedOutagesFound=!(!a.data||!a.data.length):"templates"===a.type?t.recommendedTemplatesFound=!(!a.data||!a.data.length):"articles"===a.type?t.recommendedArticlesFound=!(!a.data||!a.data.length):"tickets"===a.type&&(t.recommendedTicketsFound=!(!a.data||!a.data.length)),t.recommendedOutagesFound||t.recommendedTemplatesFound||t.recommendedArticlesFound||t.recommendedTicketsFound?t.resourcesFound=!0:t.resourcesFound=!1}),V()}])}(),function(){angular.module("smartRecorderModule").directive("smartRecorderInput",["$filter","$window","$compile","$timeout","$modal","$q","smartRecorderModel","i18nService","configurationModel","permissionModel","metadataModel","roles","events","userModel","browser","authModel","utilityFunctions",function(e,t,a,n,i,o,r,s,l,c,d,u,p,m,f,g,h){return{restrict:"E",templateUrl:"views/smart-recorder/smart-recorder-input.html",scope:{inputText:"=",inputTextHtml:"=",textareaHtml:"=",customerName:"=",customerLoginId:"=",addItemSelected:"&",saveTemplate:"&",unrelateTemplate:"&",smartSearch:"&",clearParent:"&",clearResourceTab:"&",confirmedItems:"=",restrictAssetSearchToCustomer:"=?"},link:function(y,E){function v(){var e=ne.html();return f.isIE?e.replace(/&nbsp;/g," "):e}function T(){y.allowSearchByCompany&&1==y.userCompanies.length&&(y.actualTypeAheadText=y.userCompanies[0].name,n(function(){var e=$.Event("keydown");e.keyCode=65,angular.element(ne).html("#"+y.userCompanies[0].name),angular.element(ne).trigger(e),y.companySelected(y.userCompanies[0])},0))}function S(){var e=window.getSelection(),t=e.focusNode,a=t.textContent||t.nodeValue;if(_.isString(a)&&a.trim().charCodeAt(0)==="@".charCodeAt(0)){var n=t.previousSibling,i=!(!n||!n.getAttribute)&&n.getAttribute("companyAccelerator");if("true"===i)return n.textContent}}function C(){var e,t=0,a=0;if(window.getSelection){var n=window.getSelection();if(n.rangeCount&&(e=n.getRangeAt(0).cloneRange(),e.collapse(!0),e.getClientRects)){if(oe){var i=document.createTextNode(" ");e.insertNode(i)}var o=e.getClientRects()[0];o&&(t=o.left-12,window.isRtl&&(t=window.innerWidth-o.right-12),t=t+600>ne.width()?ne.width()-600:t,a=o.top+30),oe&&e.deleteContents()}}return 0===t&&0===a&&(t=13,a=165),{x:t,y:a}}function O(e,t){var n=ne[0];$.each(n.childNodes,function(n,i){if("#text"===i.nodeName.toLowerCase()&&i.data.length>1){var o=i.data.indexOf(e);if(o>-1){var r=document.createRange();r.setStart(i,o),r.setEnd(i,o+e.length);var s=angular.element("<span>"+t+"</span>");s.addClass("smart-recorder-highlight"),s.attr("ng-click","handleSmartInputHighlightSelected($event)"),s.attr("contenteditable",re),s.attr("readonly","true"),s.attr("UNSELECTABLE","ON");var l=a(s),c=l(y);r.deleteContents(),r.insertNode(c[0])}}})}function A(e,t,n,i){var o=ne[0];o.normalize&&o.normalize(),$.each(o.childNodes,function(r,s){if("#text"===s.nodeName.toLowerCase()&&s.data.length>1){var c=s.data.indexOf(e);if(c>-1){var d=document.createRange();if(d.setStart(s,c),d.setEnd(s,c+e.length),d.deleteContents(),"person"!==i||l.showNameInSmartRecorderCreateTicket){var u=angular.element("<span></span>");u.text(t),u.addClass("smart-recorder-highlightPerfectMatch"),u.attr("contenteditable",re),u.attr("id",n),u.attr("readonly","true"),u.attr("UNSELECTABLE","ON"),u.data("templateType",i),u.attr("tabindex",-1),"company"===i&&(u.attr("skipNodeText","true"),u.attr("companyAccelerator","true"),y.companyText=!0);var p=a(u),m=p(y);ie.push(m),d.insertNode(m[0])}else y.personText=!0;y.inputText=b(),y.inputTextHtml=v();var f=document.createRange(),g=window.getSelection(),h=o.lastChild;null!==h&&("br"===h.nodeName.toLowerCase()?(h=h.previousSibling,l.showNameInSmartRecorderCreateTicket&&(h.data=" ")):"#text"===h.nodeName.toLowerCase()&&""===h.data?h.data="":"span"===h.nodeName.toLowerCase()&&(h=document.createTextNode(""),o.appendChild(h)),f.setStart(h,h.length),f.collapse(!0)),g.removeAllRanges(),g.addRange(f),ne.focus()}}})}function I(e,t,a){e.outerHTML="<span class='smart-recorder-highlightPerfectMatch' contenteditable='"+re+"' id='"+a+"'>"+t+"</span>",y.inputTextHtml=v()}function b(){var e=ne[0],t="";return $.each(e.childNodes,function(e,a){if("br"===a.nodeName.toLowerCase())t+="\n";else{var n=a.getAttribute?a.getAttribute("skipNodeText"):a.skipNodeText;"true"!==n&&(t+=a.innerText||a.textContent)}}),t.replace(/[\r\n]+$/,"")}function k(t){var a=t.list;if(y.state.exceedsPersonChunkSize=t.exceedsChunkSize,(a.length>=H&&y.actualTypeAheadText!==r.personSearchString||y.actualTypeAheadText.length<r.personSearchString.length)&&y.actualTypeAheadText.length>=3)U=y.actualTypeAheadText,y.typeAheadText=y.actualTypeAheadText,r.getListOfPersons(U,H).then(k);else if(y.personProfileList=a,W=a.length+1,y.personProfileListFilteredLength=e("wildcardFilter")(y.personProfileList,y.typeAheadText,y.skipClientSideFiltering).length,y.typeAheadListPos=0,B=!1,y.personProfileList.length>0&&G)for(var n=y.actualTypeAheadText.length,i=y.typeAheadText.length;n>3||n>i;){var o=y.actualTypeAheadText.substr(0,n),s=e("wildcardFilter")(y.personProfileList,o).length;if(s>0){y.personProfileListFilteredLength=s,y.typeAheadText=o;break}n--}else y.personProfileListFilteredLength=0}function D(t){if(y.state.exceedsAssetChunkSize=t.exceedsChunkSize,(t.totalMatches>K&&y.actualTypeAheadText!==r.assetSearchString||y.actualTypeAheadText.length<r.assetSearchString.length)&&y.actualTypeAheadText.length>=3)U=y.actualTypeAheadText,y.typeAheadText=y.actualTypeAheadText,r.getListOfAssetsForCustomer(U,K).then(D);else if(t.objects&&t.objects.length){if(y.typeAheadText=y.actualTypeAheadText,y.assetProfileList=t.objects,j=t.totalMatches,y.assetProfileListFilteredLength=e("wildcardFilter")(y.assetProfileList,y.typeAheadText).length,y.typeAheadListPos=0,B=!1,y.assetProfileList.length>0&&G)for(var a=y.actualTypeAheadText.length,n=y.typeAheadText.length;a>3||a>n;){var i=y.actualTypeAheadText.substr(0,a),o=e("wildcardFilter")(y.assetProfileList,i).length;if(o>0){y.assetProfileListFilteredLength=o,y.typeAheadText=i;break}a--}}else y.assetProfileListFilteredLength=e("wildcardFilter")(y.assetProfileList,r.assetSearchString).length}function R(t){if(y.state.exceedsTemplateChunkSize=t.exceedsChunkSize,J=t.exceedsChunkSize,(t.totalMatches>q&&y.actualTypeAheadText!==r.incidentTemplateSearchString||y.actualTypeAheadText.length<r.incidentTemplateSearchString.length)&&y.actualTypeAheadText.length>=3)U=y.actualTypeAheadText,y.typeAheadText=y.actualTypeAheadText,r.getListOfTemplate(U,q).then(R);else if(t.objects&&t.objects.length){if(y.personProfileList=t.objects,W=t.totalMatches,y.personProfileListFilteredLength=e("wildcardFilter")(y.personProfileList,y.typeAheadText).length,y.typeAheadListPos=0,B=!1,y.personProfileList.length>0&&G)for(var a=y.actualTypeAheadText.length,n=y.typeAheadText.length;a>3||a>n;){var i=y.actualTypeAheadText.substr(0,a),o=e("wildcardFilter")(y.personProfileList,i).length;if(o>0){y.personProfileListFilteredLength=o,y.typeAheadText=i;break}a--}}else y.personProfileListFilteredLength=0}function P(t){if(y.state.exceedsWOTemplateChunkSize=t.exceedsChunkSize,Z=t.exceedsChunkSize,(t.totalMatches>q&&y.actualTypeAheadText!==r.workorderTemplateSearchString||y.actualTypeAheadText.length<r.workorderTemplateSearchString.length)&&y.actualTypeAheadText.length>=3)U=y.actualTypeAheadText,y.typeAheadText=y.actualTypeAheadText,r.getListOfworkorderTemplate(U,q).then(P);else if(t.objects&&t.objects.length){if(y.searchList3=t.objects,ee=t.totalMatches,y.searchList3FilteredLength=e("wildcardFilter")(y.searchList3,y.typeAheadText).length,y.typeAheadListPos=0,B=!1,y.searchList3.length>0&&G)for(var a=y.actualTypeAheadText.length,n=y.typeAheadText.length;a>3||a>n;){var i=y.actualTypeAheadText.substr(0,a),o=e("wildcardFilter")(y.searchList3,i).length;if(o>0){y.searchList3FilteredLength=o,y.typeAheadText=i;break}a--}}else y.searchList3FilteredLength=0}function w(t){if(y.state.exceedsSrdTemplateChunkSize=t.exceedsChunkSize,X=t.exceedsChunkSize,(t.totalMatches>q&&y.actualTypeAheadText!==r.srdSearchString||y.actualTypeAheadText.length<r.srdSearchString.length)&&y.actualTypeAheadText.length>=3)U=y.actualTypeAheadText,y.typeAheadText=y.actualTypeAheadText,r.getListOfSrd(U,q).then(w);else if(t.objects&&t.objects.length){if(y.assetProfileList=t.objects,j=t.totalMatches,y.assetProfileListFilteredLength=e("wildcardFilter")(y.assetProfileList,y.typeAheadText).length,y.typeAheadListPos=0,B=!1,y.assetProfileList.length>0&&G)for(var a=y.actualTypeAheadText.length,n=y.typeAheadText.length;a>3||a>n;){var i=y.actualTypeAheadText.substr(0,a),o=e("wildcardFilter")(y.assetProfileList,i).length;if(o>0){y.assetProfileListFilteredLength=o,y.typeAheadText=i;break}a--}}else y.assetProfileListFilteredLength=0}function L(t){y.state.exceedsDwpTemplateChunkSize=t.exceedsChunkSize,y.dwpChunkAvailable=t.exceedsChunkSize,t.objects&&t.objects.length?(y.dwpTemplateList=t.objects,y.showAllResults=!0,y.dwpListFilteredLength=e("wildcardFilter")(y.dwpTemplateList,y.typeAheadText,y.showAllResults).length,y.typeAheadListPos=0,B=!1):y.dwpListFilteredLength=0}function N(t){var a=t.companies;y.state.exceedsCompanyChunkSize=t.exceedsChunkSize,y.companiesList=a,y.filteredCompaniesListLength=e("wildcardFilter")(y.companiesList,y.typeAheadText).length,Q=t.exceedsChunkSize,y.typeAheadListPos=0,B=!1}function M(){c.hasRole(u.ITSM_PEOPLE_USER_ROLE)&&(y.hasPermissionToCreateCustomer=!0)}var V,F,x,G=!1,B=!1,U="",z=2e3,Y=8,q=20,H=20,K=4,j=0,W=0,Q=!1,J=!1,Z=!1,X=!1,ee=0,te=[],ae=null,ne=E.find(".smart-recorder-textarea"),ie=[],oe=t.navigator.userAgent.indexOf("MSIE")>-1||t.navigator.userAgent.indexOf("Trident/7.0")>-1,re=oe?"true":"false",se={enter:13,leftArrow:37,rightArrow:39,upArrow:38,downArrow:40},le=new MutationObserver(function(e){_.forEach(e,function(e){e.removedNodes.length&&_.forEach(e.removedNodes,function(e){y.$apply(function(){if(_.isElement(e)){var t=$(e).data("templateType");t&&t.indexOf("Template")>-1?(y.unrelateTemplate(),y.inputTextHtml=v(),y.inputText=b(),n(function(){y.smartSearch()},0)):t&&t.indexOf("company")>-1&&(y.companyText=!1,r.companySelectedByAgent=!1)}})})})});le.observe(ne[0],{attributes:!0,childList:!0,characterData:!0}),n(function(){ne[0].focus();var e=document.createRange();e.selectNodeContents(ne[0]),e.collapse(!1);var t=window.getSelection();t.removeAllRanges(),t.addRange(e)},0),y.companiesList=[],y.skipClientSideFiltering=!1,y.personProfileList=[],y.assetProfileList=[],y.searchList3=[],y.dwpTemplateList=[],y.smartResultItems=[],y.filteredCompaniesListLength=0,y.personProfileListFilteredLength=0,y.assetProfileListFilteredLength=0,y.searchList3FilteredLength=0,y.dwpListFilteredLength=0,y.showPopup=!1,y.popupType="",y.popupTopPosition=0,y.popupLeftPosition=0,y.selectedText="",y.typeAheadListPos=0,y.typeAheadText="",y.actualTypeAheadText="",y.smartRecorderModel=r,y.showPopupHeader=!1,y.allowSearchByCompany=!1,y.state={exceedsPersonChunkSize:!1,exceedsAssetChunkSize:!1,exceedsCompanyChunkSize:!1,exceedsTemplateChunkSize:!1,exceedsWOTemplateChunkSize:!1,exceedsSrdTemplateChunkSize:!1,exceedsDwpTemplateChunkSize:!1},y.enableSbeIntegration=l.isServerApplicationEnabled(EntityVO.TYPE_SBEREQUEST),y.ssoEnabled=g.isSSOEnabled(),y.enableDWPWidgetIntegration=l.enableDWPWidgetIntegration,r.actualCompanyContext=null;var ce,de;de=d.getMetadataByType(EntityVO.TYPE_GLOBAL),ce=m.getOperatingCompanies(),o.all([de,ce]).then(function(e){var t=e[0];y.userCompanies=e[1].companies,H=l.personChunkSize,t.configurationParameters&&(t.configurationParameters.assetSearchQueryLimit&&(K=t.configurationParameters.assetSearchQueryLimit),t.configurationParameters.enableDWPWidgetIntegration&&(y.enableDWPWidgetIntegration=l.enableDWPWidgetIntegration="true"===t.configurationParameters.enableDWPWidgetIntegration),t.configurationParameters.enableSearchForAccentChar&&(y.skipClientSideFiltering="true"===t.configurationParameters.enableSearchForAccentChar)),y.allowSearchByCompany=l.smartRecorderSearchByCompany,T()}),y.$on(p.SAVE_INPUT_BEFORE_SAVE,function(){y.handleSmartInputChange()}),y.profileSelected=function(e,t,a,i,o,l){G?(y.selectedText="@"+y.actualTypeAheadText,A(y.selectedText,a,i,t),G=!1):ae&&I(ae,a,i);var c={};c.displayName=a,c.id=i,c.type="asset"===t&&"BMC_BUSINESSSERVICE"===e.classId?"businessservice":t,c.originalName=y.selectedText,c.content=e,c.relationship=o,c.relDisplayName=s.getLocalizedString(l),c.contextCompanyName=r.actualCompanyContext,y.addItemSelected({item:c}),y.dismissPopup(),"asset"!==c.type&&"businessservice"!==c.type||n(function(){y.smartSearch()},0)},y.templateSelected=function(e,t){y.selectedText="!"+y.actualTypeAheadText,A(y.selectedText,e.name,e.id,t),G=!1,e.type=t,y.saveTemplate({item:e}),y.dismissPopup(),n(function(){y.smartSearch()},0)},y.companySelected=function(e){r.companySelectedByAgent=!0,y.selectedText="#"+y.actualTypeAheadText,y.customerCompany=e,A(y.selectedText,e.name,e.id,"company"),G=!1,y.dismissPopup()},y.clear=function(e){G=!1,B=!1,j=0,W=0,ee=0,y.typeAheadListPos=0,y.personProfileListFilteredLength=0,y.searchList3FilteredLength=0,y.dwpListFilteredLength=0,y.assetProfileListFilteredLength=0,y.filteredCompaniesListLength=0,y.showPopupHeader=!1,y.personText=!1,y.companyText=!1,r.companySelectedByAgent=!1,r.actualCompanyContext=null,ne.empty(),ne.focus(),y.dismissPopup(),e&&y.clearParent(),
T()},y.handleSmartInputKeyDown=function(e){if(e.keyCode!==se.upArrow&&e.keyCode!==se.downArrow&&e.keyCode!==se.enter||y.showPopup!==!0){if(e.keyCode===se.enter&&!y.showPopup&&window.getSelection){var t=window.getSelection(),a=t.getRangeAt(0),n=document.createElement("br");a.deleteContents(),a.insertNode(n),a.setStartAfter(n),a.setEndAfter(n),a.collapse(!1),t.removeAllRanges(),t.addRange(a),e.preventDefault()}}else e.preventDefault()},y.handleSmartInputPaste=function(e){var a;if(e.preventDefault(),e.originalEvent&&e.originalEvent.clipboardData)a=e.originalEvent.clipboardData.getData("text/plain");else{if(!t.clipboardData)return;a=t.clipboardData.getData("Text")}if(a)if(document.queryCommandSupported("insertText"))document.execCommand("insertText",!1,a);else{if(!document.queryCommandSupported("paste"))return;document.execCommand("paste",!1,a)}y.handleSmartInputChange()},y.personProfileMouseover=function(e){y.typeAheadListPos=e},y.dwpTemplateMouseover=function(e){y.typeAheadListPos=y.personProfileListFilteredLength+e},y.assetProfileMouseover=function(e){y.typeAheadListPos=y.personProfileListFilteredLength+y.dwpListFilteredLength+e},y.searchList3Mouseover=function(e){y.typeAheadListPos=y.personProfileListFilteredLength+y.dwpListFilteredLength+y.assetProfileListFilteredLength+e},y.handleSmartInputChange=function(t){var a,i=ne[0];if(y.state.exceedsPersonChunkSize=!1,y.state.exceedsAssetChunkSize=!1,y.state.exceedsCompanyChunkSize=!1,y.state.exceedsTemplateChunkSize=!1,y.state.exceedsWOTemplateChunkSize=!1,y.state.exceedsSrdTemplateChunkSize=!1,y.state.exceedsDwpTemplateChunkSize=!1,i.normalize&&i.normalize(),y.inputTextHtml=v(),y.inputText=b(),oe||i.lastChild&&"br"===i.lastChild.nodeName.toLowerCase()||i.appendChild(document.createElement("br")),t){if(t.ctrlKey===!0||t.altKey===!0)return;if(t.keyCode===se.upArrow&&y.showPopup===!0)return void(y.typeAheadListPos>0&&y.typeAheadListPos--);if(t.keyCode===se.downArrow&&y.showPopup===!0)return void(y.typeAheadListPos<y.filteredCompaniesListLength+y.personProfileListFilteredLength+y.assetProfileListFilteredLength+y.searchList3FilteredLength+y.dwpListFilteredLength-1&&y.typeAheadListPos++);if(t.keyCode===se.enter)return void y.handleSmartInputEnter()}if(0===y.inputText.replace(y.customerName,"").trim().length)return y.clearResourceTab(),G=!1,y.customerCompany="",void y.dismissPopup();if(y.inputText.length>0)if(a=y.inputText.indexOf(" @"),a===-1&&(a=y.inputText.indexOf("\n@")),a>-1?(a+=2,y.popupType="profile"):(a=y.inputText.indexOf(String.fromCharCode(160,64)),a>-1?(a+=2,y.popupType="profile"):"@"===y.inputText[0]&&(a=1,y.popupType="profile")),a<=-1&&(a=y.inputText.indexOf(" !"),a===-1&&(a=y.inputText.indexOf("\n!")),a>-1?(a+=2,y.popupType="template"):(a=y.inputText.indexOf(String.fromCharCode(160,33)),a>-1?(a+=2,y.popupType="template"):"!"===y.inputText[0]&&(a=1,y.popupType="template"))),a<=-1&&y.allowSearchByCompany&&(a=y.inputText.indexOf(" #"),a===-1&&(a=y.inputText.indexOf("\n#")),a>-1?(a+=2,y.popupType="company"):(a=y.inputText.indexOf(String.fromCharCode(160,35)),a>-1?(a+=2,y.popupType="company"):"#"===y.inputText[0]&&(a=1,y.popupType="company"))),a>-1){if(y.actualTypeAheadText=y.inputText.substring(a),G===!1){G=!0,y.typeAheadListPos=0;var s=C();if(y.popupLeftPosition=s.x,y.popupTopPosition=s.y,y.showPopup=!0,"profile"===y.popupType){var c=S();c&&(r.actualCompanyContext=c)}}}else G===!0&&(G=!1,y.dismissPopup());else G===!0&&(G=!1,y.dismissPopup());if(G===!0)if(""!==y.actualTypeAheadText.trim()&&y.actualTypeAheadText.length>=3&&y.actualTypeAheadText!==y.typeAheadText){var d=e("wildcardFilter")(y.companiesList,y.actualTypeAheadText).length,u=e("wildcardFilter")(y.personProfileList,y.actualTypeAheadText).length,p=e("wildcardFilter")(y.assetProfileList,y.actualTypeAheadText).length,m=e("wildcardFilter")(y.searchList3,y.actualTypeAheadText).length,f=e("wildcardFilter")(y.dwpTemplateList,y.actualTypeAheadText,y.showAllResults).length;if(y.showPopupHeader=!0,d+u+p+m+f>0||0===y.typeAheadText.length)y.typeAheadText=y.actualTypeAheadText,y.personProfileListFilteredLength=u,y.assetProfileListFilteredLength=p,y.searchList3FilteredLength=m,y.dwpListFilteredLength=f,y.filteredCompaniesListLength=d;else{var g=y.actualTypeAheadText.split(" ");if(g.length>3&&"company"!==y.popupType){var h=g[0]+" "+g[1];return u=e("wildcardFilter")(y.personProfileList,h).length,u>0?O("@"+h,h):(h=g[0],u=e("wildcardFilter")(y.personProfileList,h).length,u>0?O("@"+h,h):(p=e("wildcardFilter")(y.assetProfileList,g[0]).length,p>0&&O("@"+g[0],g[0]))),G=!1,void y.dismissPopup()}}y.typeAheadListPos=0,n.cancel(F),F=n(function(){if(y.actualTypeAheadText.length&&y.actualTypeAheadText.length>=3){if(0===U.length||0!==y.actualTypeAheadText.indexOf(U)||y.skipClientSideFiltering){if(U=y.actualTypeAheadText,y.typeAheadText=y.actualTypeAheadText,y.showPopup&&"profile"===y.popupType){var t=!("true"!==y.restrictAssetSearchToCustomer||!y.customerLoginId),a=l.smartRecorderSearchByCompany===!0&&y.customerCompany&&y.customerCompany.name&&y.customerCompany.name.length>0;r.getListOfPersons(U,H).then(k),l.skipAssetSearchInSmartRecorder||null==y.customerLoginId&&!a||r.getListOfAssetsForCustomer(U,K,t).then(D)}else y.showPopup&&"template"===y.popupType?y.confirmedItems&&y.confirmedItems.length>0&&(r.getListOfTemplate(U,q).then(R),l.isServerApplicationEnabled(EntityVO.TYPE_WORKORDER)&&r.getListOfworkorderTemplate(U,q).then(P),l.isServerApplicationEnabled(EntityVO.TYPE_SERVICEREQUEST)&&r.getListOfSrd(U,q).then(w),y.enableDWPWidgetIntegration&&y.enableSbeIntegration&&y.ssoEnabled?r.getListOfDwpTemplates(U).then(L):console.error("There is problem with enableDWPWidgetIntegration or enableSbeIntegration or rsso configuration")):y.showPopup&&"company"===y.popupType&&r.getListOfCompanies(U,q).then(N);return}x=angular.copy(y.typeAheadText),W>H&&(U=y.actualTypeAheadText,y.typeAheadText=y.actualTypeAheadText,y.showPopup&&"profile"===y.popupType?te.push(r.getListOfPersons(U,H).then(k)):y.showPopup&&"template"===y.popupType&&te.push(r.getListOfTemplate(U,H).then(R))),j>K&&(U=y.actualTypeAheadText,y.typeAheadText=y.actualTypeAheadText,y.showPopup&&"profile"===y.popupType&&te.push(r.getListOfAssetsForCustomer(U,K).then(D))),y.showPopup&&"template"===y.popupType?(U=y.actualTypeAheadText,y.typeAheadText=y.actualTypeAheadText,J&&te.push(r.getListOfTemplate(U,q).then(R)),Z&&l.isServerApplicationEnabled(EntityVO.TYPE_WORKORDER)&&te.push(r.getListOfworkorderTemplate(U,q).then(P)),X&&l.isServerApplicationEnabled(EntityVO.TYPE_SERVICEREQUEST)&&te.push(r.getListOfSrd(U,q).then(w)),y.dwpChunkAvailable&&y.enableDWPWidgetIntegration&&y.enableSbeIntegration&&y.ssoEnabled&&te.push(r.getListOfDwpTemplates(U).then(L))):y.showAllResults=!1,Q&&(U=y.actualTypeAheadText,y.typeAheadText=y.actualTypeAheadText,y.showPopup&&"company"===y.popupType&&te.push(r.getListOfCompanies(U,q).then(N))),te.length?o.all(te).then(function(){n(function(){var t=e("wildcardFilter")(y.personProfileList,y.actualTypeAheadText).length,a=e("wildcardFilter")(y.assetProfileList,y.actualTypeAheadText).length,n=e("wildcardFilter")(y.searchList3,y.actualTypeAheadText).length,i=e("wildcardFilter")(y.dwpTemplateList,y.actualTypeAheadText,y.showAllResults).length;y.showPopupHeader=!0,t+a+n+i===0?(y.typeAheadText=x,y.personProfileListFilteredLength=e("wildcardFilter")(y.personProfileList,y.typeAheadText).length,y.assetProfileListFilteredLength=e("wildcardFilter")(y.assetProfileList,y.typeAheadText).length,y.searchList3FilteredLength=e("wildcardFilter")(y.searchList3,y.typeAheadText).length,y.dwpListFilteredLength=e("wildcardFilter")(y.dwpTemplateList,y.typeAheadText,y.showAllResults).length):y.dwpListFilteredLength=i},0)}):(y.dwpListFilteredLength=e("wildcardFilter")(y.dwpTemplateList,y.typeAheadText,y.showAllResults).length,y.personProfileListFilteredLength=e("wildcardFilter")(y.personProfileList,y.typeAheadText).length,y.assetProfileListFilteredLength=e("wildcardFilter")(y.assetProfileList,y.typeAheadText).length,y.searchList3FilteredLength=e("wildcardFilter")(y.searchList3,y.typeAheadText).length)}},500)}else y.actualTypeAheadText.length<3?(y.personProfileList=[],y.assetProfileList=[],y.companiesList=[],y.searchList3=[],y.dwpTemplateList=[],y.typeAheadListPos=0,y.personProfileListFilteredLength=0,y.assetProfileListFilteredLength=0,y.searchList3FilteredLength=0,y.dwpListFilteredLength=0,y.filteredCompaniesListLength=0,y.typeAheadText="",y.showPopupHeader=!1,y.actualTypeAheadText="",U="",j=0,W=0,ee=0):("company"===y.popupType&&(y.state.exceedsCompanyChunkSize=Q),"template"===y.popupType&&(y.state.exceedsTemplateChunkSize=J,y.state.exceedsWOTemplateChunkSize=Z,y.state.exceedsSrdTemplateChunkSize=X));else{if(0===y.inputText.length)return void y.clear(l.showNameInSmartRecorderCreateTicket);if(y.customerName){n.cancel(V);var E=y.inputText.replace(""," ").replace(y.customerName,"").trim(),T=0===E.length?0:E.split(" ").length;T>0&&(T%Y===0?n(function(){y.smartSearch()},0):V=n(function(){G===!1&&y.smartSearch()},z))}}},y.handleHighlightItemChange=function(e){e.currentTarget.outerHTML=e.currentTarget.firstChild.data},y.handleSmartInputHighlightSelected=function(e){if(!G){B=!0,y.showPopup&&y.dismissPopup();var t=e.currentTarget.firstChild.data;ae=e.currentTarget,y.selectedText=t,y.popupTopPosition=e.clientY+18,y.popupLeftPosition=e.clientX-100,y.popupLeftPosition<12&&(y.popupLeftPosition=12),y.personProfileList=[],y.assetProfileList=[],y.searchList3=[],y.showPopup=!0;var a=l.smartRecorderSearchByCompany===!0&&y.customerCompany&&y.customerCompany.name&&y.customerCompany.name.length>0;r.getListOfPersons(t).then(k),l.skipAssetSearchInSmartRecorder||null==y.customerLoginId&&!a||r.getListOfAssetsForCustomer(t,K).then(D)}},y.handleSmartInputEnter=function(){if(y.showPopup===!0)if("company"!==y.popupType){if(y.typeAheadListPos<y.personProfileListFilteredLength&&y.personProfileListFilteredLength>0){var t=e("wildcardFilter")(y.personProfileList,y.typeAheadText),a=t[y.typeAheadListPos];"profile"===y.popupType?y.profileSelected(a,"person",a.fullName,a.id,"customer","common.label.customer"):y.templateSelected(a,"incidentTemplate")}else if("template"===y.popupType&&y.typeAheadListPos>=y.personProfileListFilteredLength&&y.typeAheadListPos<y.personProfileListFilteredLength+y.dwpListFilteredLength&&y.dwpListFilteredLength>0&&y.enableDWPWidgetIntegration&&y.enableSbeIntegration&&y.ssoEnabled){var n=e("wildcardFilter")(y.dwpTemplateList,y.typeAheadText),i=n[y.typeAheadListPos-y.personProfileListFilteredLength];y.templateSelected(i,"dwpcTemplate")}else if(y.typeAheadListPos>=y.personProfileListFilteredLength+y.dwpListFilteredLength&&y.typeAheadListPos<y.personProfileListFilteredLength+y.dwpListFilteredLength+y.assetProfileListFilteredLength&&y.assetProfileListFilteredLength>0){var o=e("wildcardFilter")(y.assetProfileList,y.typeAheadText),r=o[y.typeAheadListPos-y.personProfileListFilteredLength-y.dwpListFilteredLength];"profile"===y.popupType?y.profileSelected(r,"asset",r.name,r.reconciliationId,"affectedasset","common.label.asset"):y.templateSelected(r,"servicerequestTemplate")}else if(y.typeAheadListPos>=y.personProfileListFilteredLength+y.dwpListFilteredLength+y.assetProfileListFilteredLength&&y.typeAheadListPos<y.personProfileListFilteredLength+y.dwpListFilteredLength+y.assetProfileListFilteredLength+y.searchList3FilteredLength&&y.searchList3FilteredLength>0){var s=e("wildcardFilter")(y.searchList3,y.typeAheadText),l=s[y.typeAheadListPos-y.personProfileListFilteredLength-y.dwpListFilteredLength-y.assetProfileListFilteredLength];"template"===y.popupType&&y.templateSelected(l,"workorderTemplate")}}else{var c=e("wildcardFilter")(y.companiesList,y.typeAheadText)||[],d=c[y.typeAheadListPos];d&&y.companySelected(d)}},y.dismissPopup=function(){B||G||(y.showPopup=!1,y.personProfileList=[],y.assetProfileList=[],y.searchList3=[],y.typeAheadText="",y.typeAheadListPos=0,y.personProfileListFilteredLength=0,y.assetProfileListFilteredLength=0,y.searchList3FilteredLength=0,y.dwpListFilteredLength=0,y.showPopupHeader=!1,U="",j=0,W=0,ee=0)},y.$on("smartRecorderClear",function(){y.clear(!1)}),y.$on("smartRecorderConfirmItemDelete",function(e,t){var a=E.find("#"+t.id)[0];a&&(a.outerHTML=t.isDeleteItem?h.escapeHTML(t.displayName):"")}),y.setTextareaFocus=function(){ne.focus()},y.createCustomer=function(){var e=i.open({templateUrl:"views/person/create-person.html",controller:"createPersonController",windowClass:"modal_full-content",backdrop:!1,keyboard:!1,resolve:{personCompany:function(){return y.customerCompany}}});e.result.then(function(e){_.isEmpty(e)||(e.fullName=e.firstName+" "+e.lastName,y.selectedText="@"+y.actualTypeAheadText,y.profileSelected(e,"person",e.fullName,e.loginId,"customer","common.label.customer"))},function(){})},M(),y.$on(p.PERMISSIONS_CHANGED,M),y.$on("$destroy",function(){ae=null,ne=null,le.disconnect(),_.forEach(ie,function(e){e.remove()})})}}}])}(),function(){angular.module("smartRecorderModule").factory("smartRecorderModel",["$q","smartRecorderService","searchModel",function(e,t,a){function n(e){return e?(_.each(e,function(e){e.fullNameWithNoMiddleName1=e.firstName+" "+e.lastName,e.fullNameWithNoMiddleName2=e.lastName+" "+e.firstName}),e):[]}var i={smartRecorderData:null,customer:{},loadingListOfPerson:!1,loadingListOfAssets:!1,loadingListOfTemplate:!1,loadingListOfWorkorderTemplate:!1,loadingListOfDwpTemplate:!1,loadingListOfSrd:!1,loadingListOfCompanies:!1,getListOfPersonPromise:{},getListOfAssetsPromise:{},getListOfTemplatePromise:{},getListOfWorkorderTemplatePromise:{},getListOfSrdPromise:{},getListOfDwpPromise:{},getListOfCompaniesPromise:{},personSearchString:"",assetSearchString:"",incidentTemplateSearchString:"",workorderTemplateSearchString:"",srdSearchString:"",dwpSearchString:"",companySearchString:"",actualCompanyContext:null,postCallLogPromise:{},companySelectedByAgent:!1,smartitUrl:"",dwpUrl:"",dwpCatalogChunkSize:20};return i.getListOfPersons=function(e,a){var o=i.customer;if(i.loadingListOfPerson=!0,i.personSearchString=e,i.companySelectedByAgent){var r=i.actualCompanyContext||o&&o.company&&o.company.name;i.getListOfPersonPromise=t.getListOfPersonsByCompany(e,r,a).then(function(e){return{exceedsChunkSize:e[0].exceedsChunkSize,list:n(e[0].items)}})["finally"](function(){i.loadingListOfPerson=!1})}else i.getListOfPersonPromise=t.getListOfPersons(e,a).then(function(e){return{exceedsChunkSize:e[0].exceedsChunkSize,list:n(e[0].items)}})["finally"](function(){i.loadingListOfPerson=!1});return i.getListOfPersonPromise},i.getListOfAssetsForCustomer=function(a,n,o){var r=i.customer;if(i.assetSearchString=a,!(r&&r.company||i.actualCompanyContext))return e.reject("Customer info missing");if(i.loadingListOfAssets=!0,o){var s=r.loginId;i.getListOfAssetsPromise=t.getListOfAssetsByCustomer(a,s,n).then(function(e){return e[0].items[0]})["finally"](function(){i.loadingListOfAssets=!1})}else{var l=i.actualCompanyContext||null;i.getListOfAssetsPromise=t.getListOfAssetsByCompany(a,l,n).then(function(e){return e[0].items[0]})["finally"](function(){i.loadingListOfAssets=!1})}return i.getListOfAssetsPromise},i.getListOfAssets=function(e,a){return i.loadingListOfAssets=!0,i.assetSearchString=e,i.getListOfAssetsPromise=t.getListOfAssets(e,a).then(function(e){return e[0].items[0]})["finally"](function(){i.loadingListOfAssets=!1}),i.getListOfAssetsPromise},i.getListOfTemplate=function(a,n){var o=i.customer;return i.incidentTemplateSearchString=a,o&&o.company?(i.loadingListOfTemplate=!0,i.getListOfTemplatePromise=t.getListOfTemplate(a,o.company.name,n).then(function(e){return e[0].items[0]})["finally"](function(){i.loadingListOfTemplate=!1}),i.getListOfTemplatePromise):e.reject("Customer info missing")},i.getListOfworkorderTemplate=function(a,n){var o=i.customer;return i.workorderTemplateSearchString=a,o&&o.company?(i.loadingListOfWorkorderTemplate=!0,i.getListOfWorkorderTemplatePromise=t.getListOfworkorderTemplate(a,o.company.name,n).then(function(e){return e[0].items[0]})["finally"](function(){i.loadingListOfWorkorderTemplate=!1}),i.getListOfWorkorderTemplatePromise):e.reject("Customer info missing")},i.getListOfSrd=function(a,n){var o=i.customer;return i.srdSearchString=a,o&&o.company?(i.loadingListOfSrd=!0,i.getListOfSrdPromise=t.getListOfSrd(a,o.company.name,o.id,n).then(function(e){return e[0].items[0]})["finally"](function(){i.loadingListOfSrd=!1}),i.getListOfSrdPromise):e.reject("Customer info missing")},i.getListOfDwpTemplates=function(a){var n=i.customer;i.dwpSearchString=a;var o=i.dwpCatalogChunkSize;return n&&n.id?(i.loadingListOfDwpTemplate=!0,i.getListOfDwpPromise=t.getListOfDwpTemplates(a,n.id,o).then(function(e){return e[0].items[0]})["finally"](function(){i.loadingListOfDwpTemplate=!1}),i.getListOfDwpPromise):e.reject("Customer info missing")},i.getListOfCompanies=function(e,t){return i.companySearchString=e,i.loadingListOfCompanies=!0,i.getListOfCompaniesPromise=a.getCompaniesByText(e,t).then(function(e){return e})["finally"](function(){i.loadingListOfCompanies=!1}),i.getListOfCompaniesPromise},i.postCallLog=function(e){return i.postCallLogPromise=t.postCallLog(e).then(function(e){return e}),i.postCallLogPromise},i}])}(),function(){angular.module("smartRecorderModule").directive("smartRecorderSearch",["browser","i18nService",function(e,t){return{restrict:"E",replace:!0,templateUrl:"views/smart-recorder/smart-recorder-search.html",controller:["$scope","smartRecorderModel","configurationModel","authModel",function(e,t,a,n){e.enableSbeIntegration=a.isServerApplicationEnabled(EntityVO.TYPE_SBEREQUEST),e.ssoEnabled=n.isSSOEnabled(),e.enableDWPWidgetIntegration=a.enableDWPWidgetIntegration,e.showMailstopOnPersoncard=a.showMailstopOnPersoncard,e.showPhoneNumOnPersonCard=a.showPhoneNumOnPersonCard,e.showNoMatchProfileHeader=function(){return!(e.personProfileListFilteredLength||e.assetProfileListFilteredLength||e.filteredCompaniesListLength||t.loadingListOfCompanies||t.loadingListOfPerson||t.loadingListOfAssets)},e.showProfileMatchSummaryHeader=function(){return e.actualTypeAheadText===e.typeAheadText&&(e.personProfileListFilteredLength||e.assetProfileListFilteredLength||e.filteredCompaniesListLength)||t.loadingListOfPerson||t.loadingListOfAssets||t.loadingListOfCompanies},e.showCompaniesMatchCountAndSpinnerBlock=function(){return t.loadingListOfCompanies||e.filteredCompaniesListLength},e.showProfileMatchCountAndSpinnerBlock=function(){return t.loadingListOfPerson||t.loadingListOfAssets||e.personProfileListFilteredLength||e.assetProfileListFilteredLength}}],link:function(a,n,i){i.$observe("topposition",function(e){n.css("top",e?e+"px":"auto")}),window.isRtl?(e.isChrome&&"he"==t.language&&"activityFeedSearch"!==i.placementData&&(n.detach(),n.appendTo("body"),a.$on("$destroy",function(){n.remove()})),i.$observe("leftposition",function(e){n.css("right",e?e+"px":"auto")})):i.$observe("leftposition",function(e){n.css("left",e?e+"px":"auto")})}}}]).filter("wildcardFilter",function(){return function(e,t,a){function n(e){return e.replace(/[-[\]{}()*+?.,\\^$|#]/g,"\\$&")}if(a&&e&&e.length>0)return e;var i,o,r=[];return i=n(t),o=i.replace(/%+|\s/g,".*"),o=".*"+o+".*",o=new RegExp("^"+o+"$","im"),r=_.filter(e,function(e){var t=!1;return _.forOwn(e,function(e){("string"==typeof e&&e.match(o)||"object"==typeof e&&e.tag&&e.tag.match(o))&&(t=!0)}),t})}})}(),function(){angular.module("smartRecorderModule").service("smartRecorderService",["$resource",function(e){var t=e("/smartit/rest/person/search",{},{GetListOfPersons:{method:"GET",isArray:!0}}),a=e("/smartit/rest/asset/search",{},{GetListOfAssets:{method:"GET",isArray:!0}}),n=e("/smartit/rest/incident/templates",{},{GetListOfTemplate:{method:"GET",isArray:!0}}),i=e("/smartit/rest/workorder/templates",{},{GetListOfTemplate:{method:"GET",isArray:!0}}),o=e("/smartit/rest/request/templates",{},{GetListOfSrd:{method:"GET",isArray:!0}}),r=e("/smartit/rest/dwpc/templates",{},{GetListOfDwpTemplates:{method:"GET",isArray:!0}}),s=e("/smartit/rest/smartrecorder/calllog",{},{PostCallLog:{method:"POST",isArray:!1}});this.getListOfPersons=function(e,a){return t.GetListOfPersons({name:e,chunkInfo:{startIndex:0,chunkSize:a},thumbnail:!0}).$promise},this.getListOfPersonsByCompany=function(e,a,n){return t.GetListOfPersons({name:e,companyName:a,chunkInfo:{startIndex:0,chunkSize:n},thumbnail:!0}).$promise},this.getListOfAssets=function(e,t){return a.GetListOfAssets({searchParam:e,chunkInfo:{startIndex:0,chunkSize:t},thumbnail:!0,assetType:"All"}).$promise},this.getListOfAssetsByCompany=function(e,t,n){return a.GetListOfAssets({searchParam:e,company:t?{name:t}:null,chunkInfo:{startIndex:0,chunkSize:n},thumbnail:!0,assetType:"All"}).$promise},this.getListOfAssetsByCustomer=function(e,t,n){return a.GetListOfAssets({searchParam:e,userId:t,distinct:!0,chunkInfo:{startIndex:0,chunkSize:n},thumbnail:!0,assetType:"All"}).$promise},this.getListOfTemplate=function(e,t,a){return n.GetListOfTemplate({input:e,companyName:t,isName:!0,chunkInfo:{startIndex:0,chunkSize:a}}).$promise},this.getListOfworkorderTemplate=function(e,t,a){return i.GetListOfTemplate({input:e,companyName:t,isName:!0,chunkInfo:{startIndex:0,chunkSize:a}}).$promise},this.getListOfSrd=function(e,t,a,n){return o.GetListOfSrd({input:e,companyName:t,user:a,isName:!0,chunkInfo:{startIndex:0,chunkSize:n}}).$promise},this.getListOfDwpTemplates=function(e,t,a){return r.GetListOfDwpTemplates({input:e,requestFor:t,chunkInfo:{startIndex:0,chunkSize:a}}).$promise},this.postCallLog=function(e){return s.PostCallLog({},e).$promise}}])}(),SmartRecorderVO.prototype=new BaseVO,SmartRecorderVO.prototype.constructor=SmartRecorderVO,SmartRecorderVO.prototype.resetData=function(){this.type="",this.desc="",this.inputTextHtml="",this.textareaHtml="",this.previewId="",this.resolution="",this.status=null,this.impactedService=null,this.causalCI=null,this.relatedAsset=[],this.customer=null,this.contact=null,this.assignee=null,this.template=null,this.confirmedResourceList=[],this.confirmedItems=[]},SmartRecorderVO.prototype.isDirty=function(){return this.desc&&this.desc.length>0},SmartRecorderVO.prototype.resetDirty=function(){this.resetData()},SmartRecorderVO.prototype.getProps=function(){return BaseVO.prototype.getProps().concat("desc","type","inputTextHtml","resolution","status","impactedService","previewId","causalCI","relatedAsset","customer","contact","assignee","template","confirmedResourceList","confirmedItems")},ActivityTemplateVO.prototype=Object.create(BaseVO.prototype),ActivityTemplateVO.prototype.constructor=ActivityTemplateVO,ActivityTemplateVO.prototype.getProps=function(){return BaseVO.prototype.getProps().concat("name","summary","desc","templateObject","company")},function(){angular.module("templateModule").controller("BrowseTaskTemplateController",["$scope","$modalInstance","createTicketModel","ticketModel","ticketTemplateModel","$filter","$state","$stateParams","systemAlertService","i18nService","isFromBrowseTemplate","events","$rootScope",function(e,t,a,n,i,o,r,s,l,c,d,u,p){function m(){e.close()}function f(t){"Task Groups"===t.type&&(e.childState.dataIsLoading=!0,i.getTaskGroupPreview(t.id).then(function(t){e.selectedTemplates=t.map(function(e){return(new TaskTemplateVO).build(e)})})["finally"](function(){e.childState.dataIsLoading=!1}))}function g(){e.selectedTemplate="",e.taskTemplateRadioButtons.index=0,e.templates=o("filter")(h,y),_.isEmpty(e.templates)||(e.selectedTemplate=_.head(e.templates),f(e.selectedTemplate)),e.refreshPreview()}var h,y,E,v=c.getLocalizedString("incident.template.none.selected"),T=function(){e.enableSelectType=!d,e.selectedTemplate="",e.phase={},e.taskTemplateRadioButtons={index:0},e.state={dataIsLoading:!0,searchingTemplates:!1},e.childState={dataIsLoading:!1},i.getTaskTemplateMetadata().then(function(t){if(e.types=t,e.activityTypes=e.types[0].activityTypes,e.contextes=[v].concat(e.types[0].contextes),e.selectedType=e.types[0],e.selectedActivityType=e.activityTypes[0],e.selectedContext=e.contextes[0],y={type:e.selectedType.name,activityType:e.selectedActivityType.name},d)e.types=_.filter(e.types,function(e){return"Task Groups"!==e.name});else{E=n.taskParent,a.currentTicket={};var i,o;E.type===EntityVO.TYPE_ACTIVITY?(i=E.company,o=null):(i=E.company?E.company:E.customer.company,o=E.customer),E.type===EntityVO.TYPE_CHANGE&&(i.site=E.location?E.location:{siteId:"",region:"",name:"",siteGroup:""}),a.currentTicket={parentId:E.id,company:i,parentName:E.type,parentDisplayId:E.displayId,customer:o},E.taskPhaseId&&n.getFutureTaskPhases(E.company.name,E.taskPhaseId).then(function(t){e.taskPhases=t,_.each(e.taskPhases,function(t){t.guid===E.taskPhaseId&&(e.phase.selectedPhase=t)})})}a.getList("taskTemplate").then(function(e){h=_.cloneDeep(e.map(function(e){return(new TaskTemplateVO).build(e)})),g()})["finally"](function(){e.state.dataIsLoading=!1})}),n.getDraft("task").then(function(t){e.id=t.id})};e.updateType=function(t){e.selectedType=t;var a=_.find(e.types,function(e){return e.name===t.name});e.activityTypes=a.activityTypes,e.contextes=[v].concat(a.contextes),e.selectedActivityType=e.activityTypes[0],e.selectedContext=e.contextes[0],y={type:e.selectedType.name,activityType:e.selectedActivityType.name},g()},e.updateActivityType=function(t){e.selectedActivityType=t,y.activityType=e.selectedActivityType.name,g()},e.refreshPreview=function(){var t=o("filter")(e.templates,{name:e.searchText});e.taskTemplateRadioButtons.index=0,e.selectTemplate(t.length?t[0]:"")},e.searchTemplates=function(){if(e.searchText.length>0&&e.searchText.length<3)return void g();var t;t=E&&E.company&&E.company.name?E.company.name:n.taskParent.company&&n.taskParent.company.name,e.state.searchingTemplates=!0,i.getTaskTemplateList(e.searchText,t).then(function(e){var t=e[0].items[0].objects;h=_.cloneDeep(t.map(function(e){return(new TaskTemplateVO).build(e)})),g()})["finally"](function(){e.state.searchingTemplates=!1})},e.selectTemplate=function(t){f(t),e.selectedTemplate=t},e.submit=function(){if(d)t.close(e.selectedTemplate);else{e.state.dataIsLoading=!0;var i=e.selectedTemplate,r=a.currentTicket;r.id=e.id,i.templateObject.taskType&&(r.type=i.templateObject.taskType),i.summary&&(r.summary=i.summary),i.priority&&(r.priority=i.priority),i.desc&&(r.desc=i.desc),i.name&&(r.name=i.name),i.categorizations&&(r.categorizations=i.categorizations),e.phase.selectedPhase&&(r.phaseGuid=e.phase.selectedPhase.guid,r.phaseName=e.phase.selectedPhase.name),angular.isDefined(i.templateObject.supportGroup)&&i.templateObject.supportGroup.name&&(r.supportGroup=i.templateObject.supportGroup,r.autoAssign=!1,angular.isDefined(i.templateObject.assignee)&&i.templateObject.assignee.loginId&&(r.assignee=i.templateObject.assignee)),n.taskParent&&n.taskParent.type==EntityVO.TYPE_CHANGE&&n.taskParent.scheduledStartDate&&(r.scheduledStartDate=n.taskParent.scheduledStartDate),a.createTaskV2(r,i).then(function(a){a?(e.state.dataIsLoading=!1,l.modal({title:c.getLocalizedString("common.notification.error.title"),text:a,buttons:[{text:c.getLocalizedString("controls.action.ok")}]})):t.close(E),p.$broadcast(u.RELATIONS_UPDATE_COMPLETE,!0)})["catch"](function(e){e&&l.error({text:e.errorCode?o("i18n")("error.unknown"):e.data.error,clear:!1})})}},e.close=function(){var e=l.modal({title:c.getLocalizedString("common.notification.dirty.title"),text:c.getLocalizedString("common.notification.dirty.message"),buttons:[{text:c.getLocalizedString("common.labels.yes"),data:!0},{text:c.getLocalizedString("common.labels.no"),data:!1}]});e.result.then(function(e){e&&t.dismiss()})},e.$on(u.MODAL_BACKDROP_CLICK,m),T()}])}(),function(){angular.module("templateModule").controller("BrowseTicketTemplateController",["$scope","$modalInstance","ticketTemplateModel","createTicketModel","ticketModel","i18nService","ticketType","metadata","company","$filter","$q",function(e,t,a,n,i,o,r,s,l,c,d){function u(){t.dismiss()}function p(){e.state={dataIsLoading:!0},e.template={ticketType:r,searchText:""},e.selectedTemplate="",e.templateRadioButtons={index:0},r===EntityVO.TYPE_INCIDENT?(e.tiers=[1,2,3],e.tierOptions=[],e.selectedTier=a.selectedIncidentTemplateTier=[C,C,C],a.getIncidentTemplateTierOptions(0).then(function(t){e.tierOptions[0]=t})["finally"](function(){e.state.dataIsLoading=!1,y()})):r===EntityVO.TYPE_WORKORDER?a.getAllWorkorderTemplateList(s,l).then(function(){T=a.workorderTemplateList,v()})["finally"](function(){e.state.dataIsLoading=!1}):r===EntityVO.TYPE_ACTIVITY&&a.getAllActivityTemplateList({}).then(function(){T=a.activityTemplateList,v()})["finally"](function(){e.state.dataIsLoading=!1})}function m(t,a){var n={incidentTemplateCompanyName:l.name||l,searchText:e.template.searchText};return 0===t&&(e.tier.tier1=a,e.tier.tier2="",e.tier.tier3=""),n.incidentTemplateCategoryTier1=e.tier.tier1,1===t&&(e.tier.tier2=a,e.tier.tier3="",n.incidentTemplateCategoryTier2=e.tier.tier2),2===t&&(e.tier.tier3=a,n.incidentTemplateCategoryTier2=e.tier.tier2,n.incidentTemplateCategoryTier3=e.tier.tier3),n}function f(t,n){e.selectedTier[t]=n;var i=m(t,n),o=t+1;e.selectedTier[o]=C,e.tierOptions[o]="",S={},e.selectedTier[o+1]=C,e.tierOptions[o+1]="",e.state.dataIsLoading=!0,a.getIncidentTemplateListByCategory(i,s).then(function(){T=a.incidentTemplateList,v()})["finally"](function(){e.state.dataIsLoading=!1}),e.state.dataIsLoading=!0,t<2&&a.getIncidentTemplateTierOptions(o).then(function(t){e.tierOptions[o]=t})["finally"](function(){e.state.dataIsLoading=!1})}function g(t){e.selectedTemplate=t}function h(t){var a={incidentTemplateCompanyName:l.name||l,searchText:e.template.searchText};return t.tier1&&(a.incidentTemplateCategoryTier1=t.tier1),t.tier2&&(a.incidentTemplateCategoryTier2=t.tier2),t.tier3&&(a.incidentTemplateCategoryTier3=t.tier3),a}function y(){e.state.searchingTemplates=!0;var t,n={};if(r===EntityVO.TYPE_INCIDENT){var n=h(e.tier);t=a.getIncidentTemplateListByCategory(n,s).then(function(){T=a.incidentTemplateList})}else r===EntityVO.TYPE_WORKORDER?(n.companyName=l.name||l,n.searchText=e.template.searchText||"%",t=a.getWorkorderTemplateList(n,s).then(function(){T=a.workorderTemplateList})):r===EntityVO.TYPE_ACTIVITY?(n.searchText=e.template.searchText||"%",t=a.getActivityTemplateList(n).then(function(){T=a.activityTemplateList})):t=d.when(1);t["finally"](function(){v(),e.state.searchingTemplates=!1,e.apply()})}function E(){if(r===EntityVO.TYPE_ACTIVITY){e.state.dataIsLoading=!0;var a=i.activityParent;e.selectedTemplate.parentId=a.displayId,e.selectedTemplate.parentGuid=a.id,_.isObject(a.milestone)?e.selectedTemplate.milestone=a.milestone:e.selectedTemplate.milestone={name:a.milestone},a.noOfRelatedItems[e.selectedTemplate.milestone.name]?e.selectedTemplate.sequence=a.noOfRelatedItems[e.selectedTemplate.milestone.name]+1:e.selectedTemplate.sequence=1,n.createActivity(!0,e.selectedTemplate).then(function(a){e.state.dataIsLoading=!1,t.close(a)})}else t.close(e.selectedTemplate)}function v(){e.selectedTemplate="",e.templateRadioButtons.index=0,e.template.searchText?S.name=e.template.searchText:S.name&&delete S.name,e.templates=c("filter")(T,S);var t=new RegExp(/%+/);t.test(S.name)&&(e.templates=T),_.isEmpty(e.templates)||(e.selectedTemplate=_.head(e.templates))}var T=[],S={},C=a.defaultIncidentTemplateTier=o.getLocalizedString("incident.template.none.selected");e.updateTiers=f,e.selectTemplate=g,e.searchTemplate=_.debounce(y,400),e.submit=E,e.close=u,p(),e.tier={}}])}(),ChangeTemplateVO.prototype=Object.create(BaseVO.prototype),ChangeTemplateVO.prototype.constructor=ChangeTemplateVO,ChangeTemplateVO.prototype.getProps=function(){return BaseVO.prototype.getProps().concat("name","summary","desc","templateObject","company")},ChangeTemplateVO.prototype.postBuild=function(){var e=this.templateObject;e&&(this.impact=e.impact,this.urgency=e.urgency,this.priority=e.priority,this.riskLevel=e.riskLevel,this.timing=e.timing,this.changeReason=e.changeReason,this.impactedService=e.impactedService,this.categorizations=e.categorizations)},IncidentTemplateVO.prototype=Object.create(BaseVO.prototype),IncidentTemplateVO.prototype.constructor=IncidentTemplateVO,
IncidentTemplateVO.prototype.getProps=function(){return BaseVO.prototype.getProps().concat("name","type","desc","notes","summary","company","templateObject","modifiedDate")},IncidentTemplateVO.prototype.postBuild=function(){var e=this.templateObject;if(e){this.status=e.status?e.status.value:"";var t,a=e.templateCategorizations[0].tiers,n=_.size(a),i=_.values(a);for(this.priority=e.priority?e.priority:"",this.assignedGroup=e.assignedGroup.name,this.templateCategory=a.incidentTemplateCategoryTier1,this.categorizations=e.categorizations,this.resCategorizations=e.resCategorizations,t=1;t<=n;t++)this["tier"+t]=i[t-1]}this.type="incidentTemplate",this.createDateLabel=moment(this.createDate).calendar({sameElse:"lll"}),this.modifiedDateLabel=moment(this.modifiedDate).calendar({sameElse:"lll"})},function(){angular.module("templateModule").directive("previewSingleTaskTemplate",[function(){return{restrict:"E",templateUrl:"views/template/single-task-template-details.html",scope:{template:"="}}}]).directive("previewTaskGroupTemplate",[function(){return{restrict:"E",templateUrl:"views/template/task-group-template-details.html",scope:{templates:"=",state:"=",type:"="}}}]).directive("previewTicketTemplate",[function(){return{restrict:"E",templateUrl:"views/template/ticket-template-details.html",scope:{template:"="}}}])}(),ReleaseTemplateVO.prototype=Object.create(BaseVO.prototype),ReleaseTemplateVO.prototype.constructor=ReleaseTemplateVO,ReleaseTemplateVO.prototype.getProps=function(){return BaseVO.prototype.getProps().concat("name","summary","desc","templateObject","company")},ReleaseTemplateVO.prototype.postBuild=function(){var e=this.templateObject;e&&(this.releaseType=e.releaseType,this.impact=e.impact,this.urgency=e.urgency,this.riskLevel=e.riskLevel,this.categorizations=e.categorizations,this.impactedService=e.impactedService)},ServicerequestTemplateVO.prototype=Object.create(BaseVO.prototype),ServicerequestTemplateVO.prototype.constructor=ServicerequestTemplateVO,ServicerequestTemplateVO.prototype.getProps=function(){return BaseVO.prototype.getProps().concat("name","type","desc","company","templateObject","modifiedDate")},ServicerequestTemplateVO.prototype.postBuild=function(){var e=this.templateObject;if(e&&(this.price=e.price,this.currency=e.currency,this.turnaroundTime=e.turnaroundTime,this.turnaroundTimeUnits=e.turnaroundTimeUnits,this.summary=e.summary,e.hideAttributes)){var t=this;_.each(e.hideAttributes,function(e){t.isAttributeHidden[e]=!0})}this.type="servicerequestTemplate",this.createDateLabel=moment(this.createDate).calendar({sameElse:"lll"}),this.modifiedDateLabel=moment(this.modifiedDate).calendar({sameElse:"lll"})},SmartRecorderTemplateVO.prototype=Object.create(BaseVO.prototype),SmartRecorderTemplateVO.prototype.constructor=SmartRecorderTemplateVO,SmartRecorderTemplateVO.prototype.getProps=function(){return BaseVO.prototype.getProps().concat("name","desc","displayId","type","summary","createDate","modifiedDate","company","templateObject")},SmartRecorderTemplateVO.prototype.getCategoty=function(){return this.templateObject&&this.templateObject.categorizations[0].tiers.operationCategoryTier3},SmartRecorderTemplateVO.prototype.isAttributeHidden=function(e){return _.includes(this.templateObject.hideAttributes,e)},function(){angular.module("srdModule").factory("srdModel",["srdService","$modal","$log",function(e,t,a){var n={};return n.getRequestOnBehalfOf=function(t,n){return e.getRequestOnBehalfOf(t,n).then(function(e){return e[0].items[0]})["catch"](function(){a.error("Error calling srdService.getRequestOnBehalfOf")})},n.launchAIF=function(e,a,n,i,o,r,s){t.open({templateUrl:"views/template/srd-aif-details.html",windowClass:"action-blade-aif",backdrop:"static",controller:["$modalInstance","$scope","$window","$sce","$state",function(t,l,c,d,u){l.templateName=i;var p=o;e&&(p=p.replace("CUSTOMER%5FLOGIN",r),p=p.replace("CUSTOMER_LOGIN",r),s?(p=p.replace("CONTACT%5FLOGIN",s),p=p.replace("CONTACT_LOGIN",s)):(p=p.replace("CONTACT%5FLOGIN",r),p=p.replace("CONTACT_LOGIN",r))),l.crossLaunchURL=d.trustAsResourceUrl(p),l.cancel=function(){f(),t.dismiss("cancel"),a&&c.history.back()};var m=function(){window.addEventListener&&window.addEventListener("message",g,!1)},f=function(){window.removeEventListener&&window.removeEventListener("message",g,!1)},g=function(e){if(e.preventDefault(),e.data&&0===e.data.indexOf("submit;")){var a=e.data.substr(7);f(),t.dismiss(),n.dirty=!1,u.go("request",{id:a})}else"close"===e.data&&l.cancel()};m()}]})},n}])}(),function(){angular.module("srdModule").filter("safeHtml",["$sce",function(e){return e.trustAsHtml}]).directive("srdTextQuestion",["$timeout",function($timeout){return{restrict:"AE",replace:!0,scope:{data:"=",containerClass:"@"},templateUrl:"views/template/srd-questions/text.html",link:function(scope,element){function keyUpHandler(){var e=scope.data.numLines;if(""!==$.trim(scope.data.answer)?scope.data.hasAnswer=!0:scope.data.hasAnswer=!1,e){var t=scope.data.answer;if(void 0!==t){var a=t.split("\n").length;a>e?(scope.data.answer=oldValue,$timeout(function(){scope.$apply()})):oldValue=scope.data.answer}}}var oldValue=scope.data.answer;scope.data.validationExpression&&(scope.data.validationExpression=eval(scope.data.validationExpression)),element.bind("keyup",keyUpHandler),scope.$on("$destroy",function(){element.off("keyup",keyUpHandler)})}}}]).directive("srdRadioQuestion",["$timeout",function(e){return{restrict:"AE",replace:!0,scope:{data:"=",containerClass:"@"},templateUrl:"views/template/srd-questions/radio.html",link:function(t,a){t.dataSelect=function(a){a?(t.data.answer=a.value,t.data.answerLabel=a.label):(t.data.answer="",t.data.answerLabel=""),e(function(){t.$apply(),t.processChildControlByCondition()})},t.processChildControlByCondition=function(){function e(t){var a=$('[data-parent-name="'+t+'"]',n),i=null,o=angular.element($('[data-id="'+t+'"]',n).find("select"));if(o.length||(o=angular.element($('[data-id="'+t+'"]',n).find("input"))),o.length){var r=o.scope().data?o.scope().data:o.scope().question,s=r.answer;r.hasAnswer=!(null===s||"undefined"==typeof s||""===s),i="multiple"===o.attr("multiple")?o.val()?o.val().sort().join(";"):null:s,$.each(a,function(t,a){var n=$(a).data("condition-values").toString().split(";"),o=$(this).scope().data?$(this).scope().data:$(this).scope().question,s=o.answer,l=null;$.inArray(i,n)!==-1&&r.visibility?(o.isHidden||(o.visibility=!0),o.hasAnswer=!(null===s||"undefined"==typeof s||""===s),!o.hasAnswer&&o.defaultValue&&(o.answer=o.defaultValue)):(o.visibility=!1,o.hasAnswer=!1,o.answer=null,o.answerLabel=""),l=$("select",a).attr("name"),l||(l=$("input",a).attr("name")),l&&e(l)})}}var n=a.closest(".srd-questions-container");e(t.data.id)}}}}]).directive("srdCheckboxQuestion",function(){return{restrict:"AE",replace:!0,scope:{data:"="},templateUrl:"views/template/srd-questions/checkbox.html",link:function(e,t){if(e.updateAnswer=function(a){function n(e){var t=$('[data-parent-name="'+e+'"]',i),a=null,o=angular.element($('[data-id="'+e+'"]',i).find("select"));if(o.length||(o=angular.element($('[data-id="'+e+'"]',i).find("input"))),o.length){var r=o.scope().data?o.scope().data:o.scope().question,s=r.answer?r.answer:[];r.hasAnswer=!!(null!==s&&"undefined"!=typeof s&&""!==s&&s.length>0),r.hasAnswer&&(a=s&&s.join(";")),$.each(t,function(e,t){var i=$(t).data("condition-values").toString().split(";").sort().join(";"),o=$(this).scope().data?$(this).scope().data:$(this).scope().question,s=o.answer,l=null;a===i&&r.visibility?(o.isHidden||(o.visibility=!0),o.hasAnswer=!(null===s||"undefined"==typeof s||""===s)):(o.visibility=!1,o.hasAnswer=!1,"CHECK_BOXES"===o.format?o.answer=[]:o.answer=null,o.answerLabel=""),l=$("select",t).attr("name"),l||(l=$("input",t).attr("name")),l&&n(l)})}}a.selected=!a.selected,a.selected?e.data.answer.push(a.value):_.remove(e.data.answer,function(e){return e===a.value}),e.data.hasAnswer=!_.isEmpty(e.data.answer),e.data.currentValue=e.data.answer?e.data.answer.sort().join(";"):null;var i=t.closest(".srd-questions-container");n(e.data.id)},e.data.answer&&e.data.answer.length){var a=_.cloneDeep(e.data.answer);e.data.answer=[],_.forEach(a,function(t){var a=_.find(e.data.options,{value:t});a&&e.updateAnswer(a)})}else e.data.prepopulate||_.forEach(e.data.options,function(t){t.isDefault&&e.updateAnswer(t)})}}}).directive("srdNumberQuestion",function(){return{restrict:"AE",replace:!0,scope:{data:"=",containerClass:"@"},templateUrl:"views/template/srd-questions/number.html",link:function(e,t){t.bind("keyup",function(){""!==$.trim(e.data.answer)?e.data.hasAnswer=!0:e.data.hasAnswer=!1}),t.bind("mouseup",function(){""!==$.trim(e.data.answer)?e.data.hasAnswer=!0:e.data.hasAnswer=!1})}}}).directive("srdDateQuestion",["configurationModel",function(e){return{restrict:"AE",replace:!0,scope:{data:"=",containerClass:"@"},templateUrl:"views/template/srd-questions/date.html",link:function(t){t.status={opened:!1},t.open=function(){t.status.opened=!0},t.servReqDatePickerOptions={startingDay:e.getWeekStartingDay(),"show-weeks":!1}}}}]).directive("srdTimeQuestion",function(){return{restrict:"AE",replace:!0,scope:{data:"=",containerClass:"@"},templateUrl:"views/template/srd-questions/time.html",link:function(e){e.showMeridian=window.showMeridian}}}).directive("srdDateTimeQuestion",["configurationModel",function(e){return{restrict:"AE",replace:!0,scope:{data:"=",containerClass:"@"},templateUrl:"views/template/srd-questions/datetime.html",link:function(t){t.showMeridian=window.showMeridian,t.status={opened:!1},t.open=function(){t.status.opened=!0},t.servReqDatePickerOptions={startingDay:e.getWeekStartingDay(),"show-weeks":!1},t.updateDate=function(){!t.data.answer.time&&t.data.answer.date&&(t.data.answer.time=_.cloneDeep(t.data.answer.date))}}}}]).directive("checkFormValidity",function(){return{require:"ngModel",link:function(e,t,a,n){"undefined"!=typeof t.prop("validity")&&t.bind("input",function(){var a=t.prop("validity");e.$apply(function(){n.$setValidity("badInput",!a.badInput)})})}}}).directive("srdQueryMenuQuestion",["ticketTemplateModel",function(e){return{restrict:"AE",replace:!0,scope:{data:"=",questions:"=",containerClass:"@"},templateUrl:"views/template/srd-questions/query-menu.html",link:function(t,a){a.bind("change",function(){""!==t.data.answer?t.data.hasAnswer=!0:t.data.hasAnswer=!1}),t.updateDynamicQuestions=function(){e.updateDynamicQuestions(t.data,t.questions)},t.dataSelect=function(e){e?(t.data.answer=e.value,t.data.answerLabel=e.label):(t.data.answer="",t.data.answerLabel="")}}}}])}(),function(){angular.module("srdModule").filter("expectedCompletion",[function(){return function(e,t){var a="";return a+=" "+e+" ",1e3===t?a+=e<=1?"Hour":"Hours":2e3===t&&(a+=e<=1?"Day":"Days"),a}}]).filter("rangeHint",function(){return function(e){var t=e.minValue===e.minLabel?e.minValue:e.minLabel+" ("+e.minValue+")",a=e.maxValue===e.maxLabel?e.maxValue:e.maxLabel+" ("+e.maxValue+")";return t+" - "+a}}).filter("fileTypeIconClass",function(){return function(e){var t={doc:"doc",docx:"doc",ppt:"ppt",pptx:"ppt",xls:"xls",xlsx:"xls",csv:"xls",pdf:"pdf",txt:"txt",text:"txt",properties:"txt",bmp:"images",jpg:"images",jpeg:"images",jpe:"images",jfif:"images",gif:"images",png:"images",tiff:"images",asf:"videos",avi:"videos",wmv:"videos",mpeg1:"videos",mpeg:"videos",mpg:"videos",m1v:"videos",mp2:"videos",wav:"videos",snd:"videos",au:"videos",aif:"videos",aifc:"videos",aiff:"videos",wm:"videos",wma:"videos",mp3:"videos"},a=e.split(".").pop();if(a){var n=t[a.toLowerCase()];if(n)return"i-file-type-"+n}return"i-file-type-generic"}})}(),function(){angular.module("srdModule").service("srdService",["$resource",function(e){var t=e("",{},{GetRequestOnBehalfOf:{url:"/smartit/rest/request/requestobo/:customerId/:contactId",method:"GET",isArray:!0}});this.getRequestOnBehalfOf=function(e,a){var n={customerId:e,contactId:a};return t.GetRequestOnBehalfOf(n,{}).$promise}}])}(),TaskTemplateVO.prototype=Object.create(BaseVO.prototype),TaskTemplateVO.prototype.constructor=TaskTemplateVO,TaskTemplateVO.prototype.getProps=function(){return BaseVO.prototype.getProps().concat("name","summary","type","desc","notes","company","templateObject","modifiedDate")},TaskTemplateVO.prototype.postBuild=function(){var e=this.templateObject;e&&(this.context=e.context,this.priority=e.priority,"Single Tasks"===this.type?(this.activityType=e.taskType,this.supportGroup=e.supportGroup,this.assignee=e.assignee,this.categorizations=e.categorizations,_.each(e.categorizations,function(e){e.tiersArray=_.values(e.tiers)})):this.activityType=e.taskGroupType)},function(){angular.module("templateModule").factory("ticketTemplateModel",["ticketTemplateService","categoriesService","$log","metadataModel",function(e,t,a,n){function i(e){return n.getMetadataByTypes([EntityVO.TYPE_INCIDENT,EntityVO.TYPE_WORKORDER]).then(function(a){var n=a[0],i=a[1];return _.forEach(e,function(e){if("incidenttemplate"===e.type){e.type="incidentTemplate";var a=e.templateObject&&e.templateObject.categorizations.concat(e.templateObject.resCategorizations);e.allCategories=t.populateCategories(a,n)}else"workordertemplate"!==e.type&&"workOrderTemplate"!==e.type||(e.type="workorderTemplate",e.allCategories=t.populateCategories(e.templateObject.categorizations,i))}),e})}function o(e){var t=e&&e.objects||[];t.length||a.warn("Incient template list returned from server is empty or malformed."),h.incidentTemplateList=_.map(t,function(e){return s(e)}),a.debug("Incident template list loaded:"),a.debug(h.incidentTemplateList)}function r(e){var t=e&&e.objects||[];t.length||a.warn("Service request template list returned from server is empty or malformed."),h.servicerequestTemplateList=_.map(t,function(e){return p(e)}),a.debug("Service request template list loaded:"),a.debug(h.servicerequestTemplateList)}function s(e){var a=(new IncidentTemplateVO).build(e),n=a.categorizations.concat(a.resCategorizations);return a.allCategories=t.populateCategories(n,y),a}function l(e){var t=e&&e.objects||[];t.length||a.warn("workorder template list returned from server is empty or malformed."),h.workorderTemplateList=_.map(t,function(e){return c(e)}),a.debug("workorder template list loaded:"),a.debug(h.workorderTemplateList)}function c(e){var a=(new WorkorderTemplateVO).build(e);return a.allCategories=t.populateCategories(a.categorizations,E),a}function d(e){var t=e&&e.objects||[];t.length||a.warn("Activity template list returned from server is empty or malformed."),h.activityTemplateList=_.map(t,function(e){return u(e)}),a.debug("Activity template list loaded:"),a.debug(h.activityTemplateList)}function u(e){return(new ActivityTemplateVO).build(e)}function p(e){var t=(new ServicerequestTemplateVO).build(e);return t}function m(e,t){if(e){var a=moment(e);return t&&(a=moment(t).hour(a.hour()).minute(a.minute())),a.unix()}return null}function f(e){var a=(new ChangeTemplateVO).build(e);return a.allCategories=t.populateCategories(a.categorizations,v),a}function g(e){var a=(new ReleaseTemplateVO).build(e);return a.allCategories=t.populateCategories(a.categorizations,T),a}var h={},y=null,E=null,v=null,T=null;return h.selectedIncidentTemplateTier=[],h.defaultIncidentTemplateTier="",h.getTemplatesForSmartRecorder=function(t){return e.getTemplatesForSmartRecorder(t).then(function(e){return i(e)})},h.getIncidentTemplateList=function(t,n,i){return y=i,e.getIncidentTemplateList(t,n).then(o)["catch"](function(){a.error("Error getting incident template list.")})},h.getIncidentTemplateListByCategory=function(t,n){return y=n,e.getIncidentTemplateListByCategory(t).then(o)["catch"](function(){a.error("Error getting incident template list by category.")})},h.getIncidentTemplateTierOptions=function(t){var a={},n={};return h.selectedIncidentTemplateTier[0]!==h.defaultIncidentTemplateTier&&(a={templateCategoryTier1:h.selectedIncidentTemplateTier[0]},n={depends:a}),h.selectedIncidentTemplateTier[1]!==h.defaultIncidentTemplateTier&&(a.templateCategoryTier2=h.selectedIncidentTemplateTier[1]),e.getIncidentTemplateTierOptions(t+1,n).then(function(e){return e[0].items[0]})},h.getAllWorkorderTemplateList=function(t,n){return E=t,e.getAllWorkorderTemplateList(n).then(l)["catch"](function(){a.error("Error getting workorder template list.")})},h.getWorkorderTemplateList=function(t,n){return E=n,e.getWorkorderTemplateList(t.searchText,t.companyName).then(l)["catch"](function(){a.error("Error getting workorder template list.")})},h.getServicerequestTemplateList=function(t,n,i){return e.getServicerequestTemplateList(t,n,i).then(r)["catch"](function(){a.error("Error getting service request template list.")})},h.getServicerequestDynamicOptions=function(t,n){var i={srdId:t[0],questionId:t[1]};if("undefined"!=typeof t[2]&&"undefined"!=typeof t[3]){var o=t[2],r=t[3];_.each(o,function(e){r.indexOf(e.id)!==-1&&e.id!==t[1]&&("DATE_TIME"===e.format&&(e.answer=m(e.answer.time,e.answer.date)+""),"DATE_ONLY"===e.format&&(e.answer=moment(e.answer).unix()+""),"TIME_ONLY"===e.format&&(e.answer=m(e.answer)+""),"undefined"!=typeof e.answer&&null!==e.answer||(e.answer=""),i[e.id]=e.answer)})}return e.getServicerequestDynamicOptions(i).then(n)["catch"](function(){a.error("Error getting service request dynamic options.")})},h.processDynamicQuestions=function(e,t){_.each(t,function(a){if("QUERY_MENU"===a.format||"DYNAMIC_MENU"===a.format){var n=[e,a.id];"DYNAMIC_MENU"===a.format&&(n=[e,a.id,t,a.relatedQuestions]),h.getServicerequestDynamicOptions(n,function(e){a.options=e.objects})}})},h.updateDynamicQuestions=function(e,t){if("DYNAMIC_MENU"===e.format){if(e.dataLoading)return;e.options=[],e.dataLoading=!0;var a=[e.srdIdForNullCheck,e.id,t,e.relatedQuestions];h.getServicerequestDynamicOptions(a,function(t){e.options=t.objects})["finally"](function(){e.dataLoading=!1})}},h.getTaskTemplateMetadata=function(){return e.getTaskTemplateMetadata().then(function(e){return e[0].items[0].types})},h.getTaskGroupPreview=function(t){return e.getTaskGroupPreview(t).then(function(e){return e[0].items[0]})},h.getChangeTemplateList=function(t,a,n){return v=n,e.getChangeTemplateList(t,a).then(function(e){var t=e.objects,a=_.map(t,function(e){return f(e)});return{items:a,exceedsChunkSize:e.exceedsChunkSize}})},h.getReleaseTemplateList=function(t,a,n){return T=n,e.getReleaseTemplateList(t,a).then(function(e){var t=e.objects,a=_.map(t,function(e){return g(e)});return{items:a,exceedsChunkSize:e.exceedsChunkSize}})},h.getAllActivityTemplateList=function(t){return e.getAllActivityTemplateList(t).then(d)["catch"](function(){a.error("Error getting activity template list.")})},h.getActivityTemplateList=function(t){return e.getActivityTemplateList(t.searchText,t.companyName).then(d)["catch"](function(){a.error("Error getting activity template list.")})},h.getTaskTemplateList=function(t,a){return e.getTaskTemplateList(t,a)},h}])}(),function(){angular.module("templateModule").service("ticketTemplateService",["$resource",function(e){var t=e("/smartit/rest/smartrecord/templates",{},{getTemplates:{method:"POST",isArray:!0}}),a=e("",{},{GetIncidentTemplateList:{url:"/smartit/rest/incident/templates",method:"GET",isArray:!0},GetIncidentTemplateTierOptions:{url:"/smartit/rest/category/incidentTemplate/template/templateCategoryTier:id",method:"GET",isArray:!0},GetIncidentTemplateListByCategory:{url:"/smartit/rest/incident/templates/category",method:"GET",isArray:!0}}),n=e("",{},{GetServicerequestTemplateList:{url:"/smartit/rest/request/templates",method:"GET",isArray:!0},GetServicerequestDynamicOptions:{url:"/smartit/rest/request/:srdId/questionoptions/:questionId",method:"GET",isArray:!0}}),i=e("",{},{GetTaskTemplateMetadata:{url:"/smartit/rest/task/template/metadata",method:"GET",isArray:!0},GetTaskTemplateList:{url:"/smartit/rest/task/templates",method:"GET",isArray:!0},GetTaskGroupPreview:{url:"/smartit/rest/task/templates/preview/:groupId",method:"GET",isArray:!0}}),o=e("",{},{GetWorkorderTemplateList:{url:"/smartit/rest/workorder/templates",method:"GET",isArray:!0}}),r=e("",{},{GetChangeTemplateList:{url:"/smartit/rest/change/templates",method:"GET",isArray:!0}}),s=e("",{},{GetReleaseTemplateList:{url:"/smartit/rest/release/templates",method:"GET",isArray:!0}}),l=e("",{},{GetActivityTemplateList:{url:"/smartit/rest/activity/templates",method:"GET",isArray:!0}});this.getTemplatesForSmartRecorder=function(e){return t.getTemplates(e,{}).$promise.then(function(e){return _.chain(e[0].items[0].objects).sortBy("type").map(function(e){return(new SmartRecorderTemplateVO).build(e)}).value()})},this.getIncidentTemplateList=function(e,t){return a.GetIncidentTemplateList({input:e,companyName:t,isName:!0}).$promise.then(function(e){return e[0].items[0]})},this.getIncidentTemplateListByCategory=function(e){var t=_.transform(e,function(e,t,a){a&&t&&(e[a]=t)});return a.GetIncidentTemplateListByCategory(t).$promise.then(function(e){return e[0].items[0]})},this.getIncidentTemplateTierOptions=function(e,t){var n={id:e};return _.isUndefined(t)||(n.criteria=t),a.GetIncidentTemplateTierOptions(n).$promise},this.getServicerequestTemplateList=function(e,t,a){return n.GetServicerequestTemplateList({input:e,companyName:t,user:a}).$promise.then(function(e){return e[0].items[0]})},this.getServicerequestDynamicOptions=function(e){return n.GetServicerequestDynamicOptions(e).$promise.then(function(e){return e[0].items[0]})},this.getTaskTemplateMetadata=function(){return i.GetTaskTemplateMetadata().$promise},this.getTaskTemplateList=function(e,t){return i.GetTaskTemplateList({input:e,companyName:t}).$promise},this.getTaskGroupPreview=function(e){return i.GetTaskGroupPreview({groupId:e}).$promise},this.getWorkorderTemplateList=function(e,t){return o.GetWorkorderTemplateList({input:e,companyName:t,isName:!0}).$promise.then(function(e){return e[0].items[0]})},this.getAllWorkorderTemplateList=function(e){return o.GetWorkorderTemplateList({input:"%",companyName:e&&e.name?e.name:_.isString(e)?e:"",isName:!0,chunkInfo:{startIndex:0,chunkSize:200}}).$promise.then(function(e){return e[0].items[0]})},this.getChangeTemplateList=function(e,t){return r.GetChangeTemplateList({input:e,companyName:t,isName:!0}).$promise.then(function(e){return e[0].items[0]})},this.getReleaseTemplateList=function(e,t){return s.GetReleaseTemplateList({input:e,companyName:t,isName:!0}).$promise.then(function(e){return e[0].items[0]})},this.getActivityTemplateList=function(e,t){return l.GetActivityTemplateList({input:e,companyName:t}).$promise.then(function(e){return e[0].items[0]})},this.getAllActivityTemplateList=function(e){return l.GetActivityTemplateList({input:"%",companyName:e.name||null,chunkInfo:{startIndex:0,chunkSize:200}}).$promise.then(function(e){return e[0].items[0]})}}])}(),WorkorderTemplateVO.prototype=Object.create(BaseVO.prototype),WorkorderTemplateVO.prototype.constructor=WorkorderTemplateVO,WorkorderTemplateVO.prototype.getProps=function(){return BaseVO.prototype.getProps().concat("name","type","desc","notes","summary","company","templateObject","modifiedDate")},WorkorderTemplateVO.prototype.postBuild=function(){var e=this.templateObject;e&&(this.status=e.status?e.status.value:"",this.priority=e.priority?e.priority:"",this.supportGroup=e.supportGroup.name,this.managerGroup=e.managerGroup&&e.managerGroup.name,this.templateCategory=e.categorizations[0].tiers.operationCategoryTier3,this.categorizations=e.categorizations),this.type="workorderTemplate",this.createDateLabel=moment(this.createDate).calendar({sameElse:"lll"}),this.modifiedDateLabel=moment(this.modifiedDate).calendar({sameElse:"lll"})},TicketConsoleItemVO.prototype=new BaseVO,TicketConsoleItemVO.prototype.constructor=TicketConsoleItemVO,TicketConsoleItemVO.prototype.getProps=function(){var e=Object.keys(new TicketConsoleItemVO);return BaseVO.prototype.getProps().concat(e)},TicketConsoleItemVO.prototype.postBuild=function(){for(var e=0;e<this.categorizations.length;e++)for(var t in this.categorizations[e].tiers)this.categories[t]=this.categorizations[e].tiers[t];this.allowBulkUpdateStatus=!0,(this.type===EntityVO.TYPE_TASK&&this.status&&"Staged"===this.status.value||this.status&&"Closed"===this.status.value||this.isInApproval)&&(this.allowBulkUpdateStatus=!1)},function(){angular.module("consoleModule").factory("ticketConsoleModel",["consoleService","configurationModel","metadataModel","userModel","consoleColumnsModel","$rootScope","$q","$filter","authService","roles",function(e,t,a,n,i,o,r,s,l,c){function d(){var e=_.cloneDeep(m.criteria),t=!0;if(m.restrictConsoleResultForNoOfDays){if(m.removeDateRestriction&&m.removeDateRestriction.length)for(var a=0;a<m.removeDateRestriction.length;a++)if(Object.keys(e.filterCriteria).indexOf(m.removeDateRestriction[a])!==-1&&!_.isEmpty(e.filterCriteria[m.removeDateRestriction[a]])){t=!1;break}if(!m.checkDateFilterAdded()&&t){var n=new Date,i=n.getTime();n.setDate(n.getDate()-m.restrictConsoleResultForNoOfDays);var o=n.getTime();e.filterCriteria.createDateRanges=[],e.filterCriteria.createDateRanges.push({start:o,end:i})}}return e}function u(e,a){t.enableAdvanceSearchInConsole||m.quickSearchHighlightedColumn.indexOf(e.field||a)===-1||(e.cellTemplate=T)}var p,m={},f='<div class="ngHeaderSortColumn {{col.headerClass}}" ng-style="{\'cursor\': col.cursor}" ng-class="{ \'ngSorted\': !noSortVisible }"><div ux-id="column-header" ng-click="col.sort($event)" ng-class="\'colt\' + col.index" class="ngHeaderText">{{col.displayName}}</div>\t<div class="ngSortButtonUp" ng-show="col.showSortButtonDown()"></div>\t<div class="ngSortButtonDown" ng-show="col.showSortButtonUp()"></div>\t<div class="ngSortPriority">{{col.sortPriority}}</div>\t<div ng-class="{ ngPinnedIcon: col.pinned, ngUnPinnedIcon: !col.pinned }" ng-click="togglePin(col)" ng-show="col.pinnable"></div></div><div ng-show="col.resizable" class="ngHeaderGrip" ng-click="col.gripClick($event)" ng-mousedown="col.gripOnMouseDown($event)"></div>',g=140,h="TicketConsoleFilter",y="TicketConsoleColumns",E="",v={needsAttention:'<div class="ngCenteredCellText fixed-width-narrow" ng-class="col.colIndex()" ng-bind-html="COL_FIELD | tcCellNeedsAttention:row.entity"></div>',priority:'<div class="ngCenteredCellText fixed-width-narrow" ng-class="col.colIndex()" ng-bind-html="COL_FIELD | tcCellPriority:row.entity.type"></div>',targetDate:"<div class=\"ngCellText\" ng-class=\"col.colIndex()\"><span ng-cell-text class=\"{{(row.getProperty(col.field) | haveDatePassed)  ? 'ngCellDatePassed' : ''}}\"><time-ticker ng-if=\"row.getProperty(col.field)\" refresh-interval='30000' time='row.getProperty(col.field)'></time-ticker></span></div>"},T='<div class="ngCellText" ng-class="col.colIndex()"><span ng-cell-text ng-bind-html="row.getProperty(col.field) | tcCellHighlight:row.entity.highlight"></span></div>',S={priority:100,summary:350},C=t.get("ticketConsole.cellFilters"),O=!0,A=function(){_.forEach(m.columnsConfig,function(e){_.isObject(e)&&angular.extend(e,{headerCellTemplate:f,minWidth:g,width:e.width||g})})},I=function(e){var t=e,a=[];return _.each(e.value,function(e){_.findIndex(m.filterConfig,{name:e.filter})===-1&&a.push(e)}),_.each(a,function(e){"advanceSearchQuery"===e.filter?t=!0:_.findIndex(m.availableColConfig,{name:e.filter,type:"custom"})===-1&&(t=!1)}),t&&_.each(e.columnValue,function(t,a){"newColumnType"!==a&&_.findIndex(m.availableColConfig,{name:a})===-1&&delete e.columnValue[a]}),t},b=function(e,t){var a,n=["numberField","dynamicSelectionField","staticSelectionField","characterField"],i=m.availableColConfig,o=_.find(i,{name:e}),r=t;if(o&&o.field&&o.field.type&&o.field.options?a=o.field:o&&o.oldFields&&o.oldFields.type&&o.oldFields.options&&(a=o.oldFields),a&&"staticSelectionField"===a.type&&n.indexOf(a.type)!==-1){var s=_.find(a.options,{index:t});r=s?s.label:""}return r},k=function(e,t){var a=[];return _.each(m.metaDataArrays,function(n){if(n.consoleColumns&&!_.isEmpty(n.consoleColumns)){var i=n.metadatatype,o=n.consoleColumns[t.name];_.isArray(o)&&(_.isUndefined(_.find(o,{name:e.name}))||a.push(i))}}),a},D=function(e,t){return t.showLabelInPill=!0,t.label=t.displayName,t.visible=!0,t.onDisplay=!0,"staticSelectionField"===t.fieldType?_.each(e,function(e){e.type="constant",e.filterType="customFilter",e.onDisplay=!0,e.criteria={name:t.name,value:[e.name],ticketTypes:k(e,t)}}):"numberField"===t.fieldType?(e=[{label:t.displayName,type:"range",subtype:"range",filterType:"customFilter",criteria:{name:t.name,value:[{min:1,max:1}]}}],t.range={min:t.oldFields.min,max:t.oldFields.max}):"dateTimeField"===t.fieldType?"datetime"===t.oldFields.dataType?e=[{name:"createDatePast24",label:"past24",type:"date",filterType:"customFilter",defaultValues:{start:'moment().subtract(1, "days").valueOf()',end:"moment().valueOf()"},criteria:{name:t.name}},{name:"createDatePast48",label:"past48",type:"date",filterType:"customFilter",defaultValues:{start:'moment().subtract(2, "days").valueOf()',end:"moment().valueOf()"},criteria:{name:t.name}},{name:"createDatePastWeek",label:"pastWeek",type:"date",filterType:"customFilter",defaultValues:{start:'moment().subtract(7, "days").valueOf()',end:"moment().valueOf()"},criteria:{name:t.name}},{name:"createDateCustomRange",label:"customRange",type:"timeStampRange",filterType:"customFilter",format:"mediumDate",startDatePicker:{date:new Date},endDatePicker:{date:new Date},criteria:{name:t.name}}]:"date"!==t.oldFields.dataType&&"time"!==t.oldFields.dataType||(e=[{name:"createDateCustomRange",label:"customRange",type:"timeStampRange",filterType:"customFilter",format:"mediumDate",startDatePicker:{date:new Date},endDatePicker:{date:new Date},criteria:{name:t.name}}]):e=[{label:t.displayName,type:"search",subtype:"keyword",filterType:"customFilter"}],t.options=e,t},R=function(e){var t={};_.forEach(m.metaDataArrays,function(e){_.isEmpty(e.consoleColumns)||(_.isEmpty(t)?t=_.assign(t,e.consoleColumns):_.each(e.consoleColumns,function(e,a){if(t.hasOwnProperty(a)){if(_.isArray(e)){var n=t[a].concat(e);t[a]=_.uniqBy(n,"name")}}else t[a]=e}))}),m.mergedConsoleColumns=t,m.customColumnsObjs=_.filter(_.merge(_.cloneDeep(m.availableColumnsConfig),m.currentColumnsConfig),{type:"custom"});var a=[];return _.each(m.customColumnsObjs,function(e){e.visible&&t.hasOwnProperty(e.attributeName)&&(e=D(t[e.attributeName],e),_.isUndefined(_.find(m.filterConfig,{name:e.name}))&&a.push(e))}),m.filterConfig=_.sortBy(m.filterConfig.concat(a),"name"),e=_.assign(_.keyBy(a,"name"),e)},P=function(e,t){C.hasOwnProperty(t)&&(e.cellFilter=C[t])},w=function(e){var t=e,a={},n=[];_.forEach(m.metaDataArrays,function(e){_.isEmpty(e.consoleColumns)||(a[e.metadatatype]=Object.keys(e.consoleColumns),n.push(Object.keys(e.consoleColumns)))});var i=_.intersection.apply(null,n),o={};return _.forEach(m.metaDataArrays,function(e){_.forEach(e.consoleColumns,function(a,n){var r={};if(r={ticketType:[e.metadatatype]},o.hasOwnProperty(n)&&o[n].ticketType.push(e.metadatatype),i.indexOf(n)===-1&&!o.hasOwnProperty(n)){var s=_.find(t,{name:n});_.isUndefined(s)||(r.attributeName=n,s.hasOwnProperty("field")&&(s.field.label&&(r.displayName=s.field.label),"dateTimeField"===s.field.type&&(s.cellFilter="time"===s.field.dataType?"milliToTime":"date"===s.field.dataType?'date:"mediumDate":"+0:00"':'datePreConfigTimezone:"medium"')),s.hasOwnProperty("ootbMaping")?s.field=s.ootbMaping[0]:"custom"===s.type&&(s.oldFields||(s.oldFields=_.cloneDeep(s.field)),s.fieldType=s.field.type,s.field=s.name),v.hasOwnProperty(n)&&(s.cellTemplate=v[n]),u(s,n),P(s,n),S.hasOwnProperty(n)&&(s.width=S[n]),r=_.assign(r,s),o[n]=r)}})}),_.forEach(i,function(e){var a=_.find(t,{name:e});_.isUndefined(a)||(a.attributeName=e,a.hasOwnProperty("field")&&(a.field.label&&(a.displayName=a.field.label),"dateTimeField"===a.field.type&&(a.cellFilter="time"===a.field.dataType?"milliToTime":"date"===a.field.dataType?'date:"mediumDate":"+0:00"':'datePreConfigTimezone:"medium"')),a.hasOwnProperty("ootbMaping")?a.field=a.ootbMaping[0]:"custom"===a.type&&(a.oldFields||(a.oldFields=_.cloneDeep(a.field)),a.fieldType=a.field.type,a.field=a.name),v.hasOwnProperty(e)&&(a.cellTemplate=v[e]),
u(a,e),P(a,e),S.hasOwnProperty(e)&&(a.width=S[e]),o[e]=a)}),o};return m.filterPreferenceGroup=h,m.columnPreferenceGroup=y,m.formatFilterOptionForCustomField=D,m.ribbonConfig=t.get("ticketConsole.ribbon"),m.filterConfig=t.get("ticketConsole.filter"),m.statsConfig=t.get("ticketConsole.stats"),m.quickSearchMaxCharLimit=t.get("ticketConsole.config.quickSearchCharLimit"),window.isRtl&&m.statsConfig.reverse(),m.currentColumnsConfig={},m.ticketTypeFilter=_.find(m.filterConfig,{name:"ticketTypes"}),m.presetColumns=null,p=_.map(m.statsConfig,function(e){return{name:e.name}}),m.defaultChunkSize=75,m.exceedChunkSize=!1,m.criteria={filterCriteria:{},chunkInfo:{startIndex:0,chunkSize:m.defaultChunkSize},sortInfo:{},attributeNames:[],customAttributeNames:[]},m.itemList=[],m.selectedFilters=[],m.filterDict=_.keyBy(m.filterConfig,"name"),m.checkIfPwaEnabled=function(e){var t=e.configurationParameters&&("T"===e.configurationParameters["Enable-Progressive-Views"]||"true"===e.configurationParameters["Enable-Progressive-Views"]),a=localStorage.getItem("midtierUrl");return t&&a},m.populateMetadataAndColumns=function(){return r.all([a.getMetadataByTypes(EntityVO.TICKET_TYPES),i.getTicketAvailableColumnsList(),n.getUserPreferences(y),a.getMetadataByType(EntityVO.TYPE_GLOBAL)]).then(function(e){m.showStats=!t.explicitStatsRefresh,m.metaDataArrays=e[0],m.availableColList=_.cloneDeep(e[1].itemList),m.userSavedColumnPresets=e[2]||[],m.quickSearchHighlightedColumn=e[3]&&e[3].quickSearchHighlightedCols||[],m.removeDateRestriction=e[3]&&e[3].removeDateRestriction||[],m.isPwaEnabled=m.checkIfPwaEnabled(e[3])||!1,m.isPwaEnabled||(m.availableColList=_.reject(m.availableColList,{name:"majorIncident"})),t.showNeedsAttentionFlag||(m.filterConfig=_.reject(m.filterConfig,{name:"needsAttention"}),m.ribbonConfig=_.reject(m.ribbonConfig,{name:"bulk-need-attention"}),p=_.reject(p,{name:"needsAttention"}));var a,n=_.find(m.userSavedColumnPresets,{name:"defaultConsoleColumns"})||{},i=_.find(m.userSavedColumnPresets,{name:"columns"})||{};if(_.isEmpty(i)&&!_.isEmpty(n))a=n.value||{};else if(_.isEmpty(i.value))a=n.value||{};else{var o=!1;_.each(i.value,function(e){if("system"!==e.type&&"custom"!==e.type)return o=!0,!1}),o?(a=_.mergeWith(n.value,i.value,function(e,t){_.isObject(e)&&(e.type="system")}),m.updateColumnConfig(a)):a=i.value||{}}m.availableColConfig=_.cloneDeep(m.availableColList),_.each(a,function(e,t){_.isUndefined(_.find(m.availableColList,{name:t}))&&delete a[t]}),m.currentColumnsConfig=a,E=i.id,m.avialableCustomColumns=_.map(_.filter(m.availableColList,{type:"custom"}),"name"),m.availableColumnsConfig=w(m.availableColList)})},m.populateFilters=function(){return m.areFiltersPopulated?r.when(1):r.all([n.getFullCurrentUserData()]).then(function(e){m.filterDict=R(m.filterDict);var a=e[0],n=_.find(m.filterDict.assignees.options,{label:"me"}),i=_.find(m.filterDict.assignedSupportGroups.options,{label:"myGroup"}),o=_.find(m.filterDict.organizations.options,{label:"myOrganization"}),r=_.find(m.filterDict.sites.options,{label:"mySite"}),s=_.find(m.filterDict.changeManager.options,{label:"me"}),d=_.find(m.filterDict.requestManagers.options,{label:"me"}),u=_.find(m.filterDict.changeManagerGroup.options,{label:"myGroup"}),p=_.find(m.filterDict.requestManagerGroups.options,{label:"myGroup"}),f=_.find(m.filterDict.submittedBy.options,{label:"me"}),g=_.find(m.filterDict.approvedBy.options,{label:"me"}),h=_.find(m.filterDict.approvalAssignment.options,{label:"me"}),y=_.find(m.filterDict.approvalAssignment.options,{label:"myGroup"}),E=_.find(m.filterDict.problemCoordinators.options,{label:"me"}),v=_.find(m.filterDict.releaseCoordinator.options,{label:"me"}),T=_.find(m.filterDict.problemCoordinatorGroups.options,{label:"myGroup"}),S=_.find(m.filterDict.releaseCoordinatorGroup.options,{label:"myGroup"});n.subLabel=a.fullName,n.criteria.value=[{loginId:a.loginId}],i.criteria.value=a.supportGroups,o.subLabel=a.organization,o.criteria.value=[a.organization],r.subLabel=a.site.name,r.criteria.value=[{name:a.site.name}],s.subLabel=a.fullName,s.criteria.value=[{loginId:a.loginId}],d.subLabel=a.fullName,d.criteria.value=[{loginId:a.loginId}],f.subLabel=a.fullName,f.criteria.value=[{loginId:a.loginId}],u.criteria.value=a.supportGroups,p.criteria.value=a.supportGroups,g.subLabel=a.fullName,g.criteria.value=[{loginId:a.loginId}],h.subLabel=a.fullName,h.criteria.value=[{loginId:a.loginId}],y.criteria.value=a.supportGroups,E.subLabel=a.fullName,E.criteria.value=[{loginId:a.loginId}],v.subLabel=a.fullName,v.criteria.value=[{loginId:a.loginId}],T.criteria.value=a.supportGroups,S.criteria.value=a.supportGroups;var C=[],O=[],A=[],I=[],b=[],k=[],D=[],P=[],w=[];_.forEach(m.metaDataArrays,function(e){e.metadatatype===EntityVO.TYPE_CHANGE&&!l.isAuthorized(c.ITSM_CHANGE_USER_ROLE)||e.metadatatype===EntityVO.TYPE_KNOWNERROR&&!l.isAuthorized(c.ITSM_PROBLEM_USER_ROLE)||e.metadatatype===EntityVO.TYPE_PROBLEM&&!l.isAuthorized(c.ITSM_PROBLEM_USER_ROLE)||e.metadatatype===EntityVO.TYPE_INCIDENT&&!l.isAuthorized(c.ITSM_AGENT_ROLE)||e.metadatatype===EntityVO.TYPE_WORKORDER&&!l.isAuthorized(c.ITSM_AGENT_ROLE)||e.metadatatype===EntityVO.TYPE_SERVICEREQUEST&&!l.isAuthorized(c.ITSM_AGENT_ROLE)||(O=O.concat(e.riskLevels),A=A.concat(e.changeReasons),I=I.concat(e.timings),b=b.concat(e.investigationDrivers),e.metadatatype===EntityVO.TYPE_INCIDENT&&(P=P.concat(e.types),m.isPwaEnabled&&(w=w.concat(e.majorIncident))),_.forEach(e.statuses,function(t){if(_.findIndex(C,{name:t.name})!==-1){var a=_.find(C,{name:t.name});a.ticketTypes.push(e.metadatatype)}else t.ticketTypes=[e.metadatatype],C.push(t)}),_.forEach(e.priorities,function(t){if(_.findIndex(k,{name:t.name})!==-1){var a=_.find(k,{name:t.name});a.ticketTypes.push(e.metadatatype)}else t.ticketTypes=[EntityVO.TYPE_SERVICEREQUEST,e.metadatatype],k.push(t)}),_.forEach(e.milestones,function(t){if(_.findIndex(D,{name:t.name})!==-1){var a=_.find(D,{name:t.name});a.ticketTypes.push(e.metadatatype)}else t.ticketTypes=[e.metadatatype],D.push(t)}))}),O=_.sortBy(_.uniqBy(O,"name"),"name"),A=_.uniqBy(A,"name"),I=_.sortBy(_.uniqBy(I,"name"),"name"),b=_.sortBy(_.uniqBy(b,"name"),"name"),k=_.sortBy(_.uniqBy(k,"name"),"name"),D=_.sortBy(_.uniqBy(D,"name"),"name"),P=_.sortBy(_.uniqBy(P,"name"),"name"),w=_.sortBy(_.uniqBy(w,"name"),"name"),m.metaDataRefresh||(_.forEach(C,function(e){var t=_.find(m.filterDict.statuses.options,{name:e.label});t?(t.criteria.value.push(e.name),t.criteria.ticketTypes.push(e.ticketTypes),t.criteria.ticketTypes=_.flatten(t.criteria.ticketTypes)):m.filterDict.statuses.options.push({name:e.label,type:"dynamic",filterName:"statuses",criteria:{name:"ticketSpecificStatuses",value:[e.name],ticketTypes:e.ticketTypes}})}),_.forEach(O,function(e){m.filterDict.riskLevel.options.push({name:e.label,type:"dynamic",filterName:"riskLevel",criteria:{name:"riskLevel",value:[e.name]}})}),_.forEach(A,function(e){m.filterDict.changeReason.options.push({name:e.label,type:"dynamic",filterName:"changeReason",criteria:{name:"changeReason",value:[e.name]}})}),_.forEach(I,function(e){m.filterDict.changeClass.options.push({name:e.label,type:"dynamic",filterName:"changeClass",criteria:{name:"changeClass",value:[e.name]}})}),_.forEach(b,function(e){m.filterDict.investigationDrivers.options.push({name:e.label,type:"dynamic",filterName:"investigationDrivers",criteria:{name:"investigationDrivers",value:[e.name]}})}),_.forEach(k,function(e){m.filterDict.priorities.options.push({name:e.label,filterValue:e.name,type:"dynamic",filterName:"priorities",criteria:{name:"priorities",value:[e.name],ticketTypes:e.ticketTypes}})}),_.forEach(D,function(e){m.filterDict.milestone.options.push({name:e.label,type:"dynamic",filterName:"milestone",criteria:{name:"milestone",value:[e.name],ticketTypes:e.ticketTypes}})}),_.forEach(P,function(e){m.filterDict.incidentTypes.options.push({name:e.label,type:"dynamic",filterName:"incidentTypes",filterValue:e.name,criteria:{name:"incidentTypes",value:[e.name]}})}),_.forEach(w,function(e){m.filterDict.majorIncident.options.push({name:e.label,type:"dynamic",filterName:"majorIncident",criteria:{name:"majorIncident",value:[e.name]}})})),t.isServerApplicationEnabled(EntityVO.TYPE_SLM)&&(l.isAuthorized(c.ITSM_AGENT_ROLE)||l.isAuthorized(c.ITSM_CHANGE_USER_ROLE))||(m.filterConfig=_.reject(m.filterConfig,{name:"slmStatusMappings"})),t.isServerApplicationEnabled(EntityVO.TYPE_SERVICEREQUEST)||(m.filterDict.ticketTypes.options=_.reject(m.filterDict.ticketTypes.options,{name:EntityVO.TYPE_SERVICEREQUEST})),t.isServerApplicationEnabled(EntityVO.TYPE_WORKORDER)||(m.filterDict.ticketTypes.options=_.reject(m.filterDict.ticketTypes.options,{name:EntityVO.TYPE_WORKORDER})),t.isServerApplicationEnabled(EntityVO.TYPE_CHANGE)&&l.isAuthorized(c.ITSM_CHANGE_USER_ROLE)||(m.filterDict.ticketTypes.options=_.reject(m.filterDict.ticketTypes.options,{name:EntityVO.TYPE_CHANGE}),m.filterConfig=_.reject(m.filterConfig,{name:"changeClass"}),m.filterConfig=_.reject(m.filterConfig,{name:"changeManager"}),m.filterConfig=_.reject(m.filterConfig,{name:"changeManagerGroup"}),m.filterConfig=_.reject(m.filterConfig,{name:"riskLevel"}),m.filterConfig=_.reject(m.filterConfig,{name:"changeReason"}),m.filterConfig=_.reject(m.filterConfig,{name:"approvalStatuses"}),m.filterConfig=_.reject(m.filterConfig,{name:"approvalAssignment"}),m.filterConfig=_.reject(m.filterConfig,{name:"approvedBy"})),t.isServerApplicationEnabled(EntityVO.TYPE_RELEASE)&&l.isAuthorized(c.ITSM_RELEASE_USER_ROLE)||(m.filterDict.ticketTypes.options=_.reject(m.filterDict.ticketTypes.options,{name:EntityVO.TYPE_RELEASE}),m.filterConfig=_.reject(m.filterConfig,{name:"deploymentStartDate,"}),m.filterConfig=_.reject(m.filterConfig,{name:"deploymentEndDate"}),m.filterConfig=_.reject(m.filterConfig,{name:"milestone"}),m.filterConfig=_.reject(m.filterConfig,{name:"releaseCoordinator"}),m.filterConfig=_.reject(m.filterConfig,{name:"releaseCoordinatorGroup"}),m.filterConfig=_.reject(m.filterConfig,{name:"targetDate"})),l.isAuthorized(c.ITSM_AGENT_ROLE)||(m.filterDict.ticketTypes.options=_.reject(m.filterDict.ticketTypes.options,function(e){return _.includes([EntityVO.TYPE_SERVICEREQUEST,EntityVO.TYPE_WORKORDER,EntityVO.TYPE_INCIDENT],e.name)})),t.isServerApplicationEnabled(EntityVO.TYPE_PROBLEM)&&l.isAuthorized(c.ITSM_PROBLEM_USER_ROLE)||(m.filterDict.ticketTypes.options=_.reject(m.filterDict.ticketTypes.options,{name:EntityVO.TYPE_PROBLEM}),m.filterDict.ticketTypes.options=_.reject(m.filterDict.ticketTypes.options,{name:EntityVO.TYPE_KNOWNERROR}),m.filterConfig=_.reject(m.filterConfig,{name:"problemCoordinatorGroups"}),m.filterConfig=_.reject(m.filterConfig,{name:"problemCoordinators"}),m.filterConfig=_.reject(m.filterConfig,{name:"investigationDrivers"})),l.isAuthorized(c.ITSM_AGENT_ROLE)||l.isAuthorized(c.ITSM_CHANGE_USER_ROLE)||(m.filterConfig=_.reject(m.filterConfig,{name:"organizations"}));var L=t.get("enabledServerApplications");_.forEach(m.filterDict.statuses.options,function(e){e.criteria&&e.criteria.ticketTypes&&(m.filterDict.statuses.options=_.reject(m.filterDict.statuses.options,function(e){return 0===_.intersection(L,e.criteria.ticketTypes).length}))}),_.forEach(m.filterDict.priorities.options,function(e){e.criteria&&e.criteria.ticketTypes&&(m.filterDict.priorities.options=_.reject(m.filterDict.priorities.options,function(e){return 0===_.intersection(L,e.criteria.ticketTypes).length}))})})},m.populateConfiguration=function(){return _.isEmpty(m.columnsConfig)?(m.restrictConsoleResultForNoOfDays=t.restrictConsoleResultForNoOfDays,r.all([n.getUserPreferences(h),a.getMetadataByType(EntityVO.TYPE_GLOBAL)]).then(function(e){if(m.columnsConfig=_.merge(_.cloneDeep(m.availableColumnsConfig),m.currentColumnsConfig),t.isServerApplicationEnabled(EntityVO.TYPE_SLM)||delete m.columnsConfig.slaStatus,m.userSavedFilterPresets=e[0],t.showNeedsAttentionFlag&&m.userSavedFilterPresets.unshift({id:"needsAttentionFilter",fixed:!0,name:"Needs Attention",label:s("i18n")("console.ticket.preDefinedUserFilter.needsAttentionFilter"),systemgenerated:!0,defaultpreset:!1,value:[{filter:"assignees",option:"me"},{filter:"needsAttention",option:"flagged"}]}),m.userSavedFilterPresets.unshift({id:"myAllOpenTicketsFilter",fixed:!0,name:"My Assigned Tickets",label:s("i18n")("console.ticket.preDefinedUserFilter.myAllOpenTicketsFilter"),systemgenerated:!0,defaultpreset:!1,value:[{filter:"assignees",option:"me"},{filter:"statuses",option:"allOpen"}]},{id:"myGroupOpenTicketsFilter",fixed:!0,name:"My Groups' Assigned Tickets",label:s("i18n")("console.ticket.preDefinedUserFilter.myGroupOpenTicketsFilter"),systemgenerated:!0,defaultpreset:!1,value:[{filter:"assignedSupportGroups",option:"myGroup"},{filter:"statuses",option:"allOpen"}]}),t.showSecurityTickets){var a=s("i18n")("console.filter.optionName.securityIncident");m.userSavedFilterPresets.unshift({id:"securityTicketsFilter",fixed:!0,name:"Security Tickets",label:s("i18n")("console.ticket.preDefinedUserFilter.securityTickets"),systemgenerated:!0,defaultpreset:!1,value:[{filter:"assignedSupportGroups",option:"myGroup"},{filter:"incidentTypes",option:a}]})}m.userSavedPresets=_.cloneDeep(m.userSavedFilterPresets),_.each(m.userSavedColumnPresets,function(e){if("columns"!==e.name&&"defaultConsoleColumns"!==e.name){var t=_.find(m.userSavedPresets,{name:e.name});t?(t.columnId=e.id,t.columnValue=e.value,t=I(t),t||_.remove(m.userSavedPresets,{name:e.name})):(e.columnId=e.id,e.columnValue=e.value,delete e.id,delete e.value,m.userSavedPresets.push(e))}}),A(),m.populateAttributeNames()})):r.when(1)},m.addUserSavedPresets=function(e){var t=_.find(m.userSavedFilterPresets,{name:e}),a=_.find(m.userSavedColumnPresets,{name:e}),n={};t?(n=t,a&&(n.columnId=a.id,n.columnValue=a.value)):a&&(n.columnId=a.id,n.columnValue=a.value,n.name=a.name),m.userSavedPresets.push(n)},m.populateAttributeNames=function(){m.criteria.attributeNames=_.map(_.filter(m.columnsConfig,function(e){return e.visible&&"system"===e.type}),"attributeName"),m.criteria.customAttributeNames=_.map(_.filter(m.columnsConfig,function(e){return e.visible&&"custom"===e.type}),"attributeName")},m.getItemList=function(){if(!m.criteria.attributeNames.length){var t=_.sortBy(_.filter(m.columnsConfig,{visible:!0,type:"system"}),"order");t.forEach(function(e){m.criteria.attributeNames.push(e.attributeName)})}if(!m.criteria.customAttributeNames.length){var a=_.sortBy(_.filter(m.columnsConfig,{visible:!0,type:"custom"}),"order");a.forEach(function(e){m.criteria.customAttributeNames.push(e.attributeName)})}if(_.each(m.criteria.attributeNames,function(e,t){var a=_.find(m.columnsConfig,{attributeName:e,type:"custom"});a&&(m.criteria.attributeNames.splice(t,1),m.criteria.customAttributeNames=_.union(m.criteria.customAttributeNames,[e]))}),m.criteria.customAttributeNames.length&&!m.appliedPreset.defaultpreset&&_.isObject(m.appliedPreset.columnValue))for(var n=m.criteria.customAttributeNames.length,i=n;i>=0;i--)_.has(m.appliedPreset.columnValue,m.criteria.customAttributeNames[i])||m.criteria.customAttributeNames.splice(i,1);var o=_.cloneDeep(m.criteria);return m.criteria.filterCriteria&&m.criteria.filterCriteria.createDateRanges||(o=d()),e.getTicketList(o).then(function(e){return _.forEach(e.itemList,function(e){_.isUndefined(e.customFields)||_.each(e.customFields,function(t,a){(0===t||t)&&(e[a]=b(a,t))})}),m.itemList=m.criteria.chunkInfo.startIndex?m.itemList.concat(e.itemList):e.itemList,m.exceedChunkSize=e.exceedChunkSize,e.totalCount})},m.dropCriteriaStartIndex=function(){m.criteria.chunkInfo.startIndex=0},m.getTicketConsoleMetric=function(){var t=_.cloneDeep(m.criteria);return m.criteria.filterCriteria&&m.criteria.filterCriteria.createDateRanges||(t=d()),e.getTicketStats(t.filterCriteria,p).then(function(e){_.forEach(m.statsConfig,function(t){var a=_.find(e,{name:t.name});t.value=a?a.value:0})})},m.applyFilterSet=function(e){_.forEach(e,function(e){if(m.filterDict[e.filter]){var t=e.checkForLocale?{filterValue:e.option}:{name:e.option},a=_.find(m.filterDict[e.filter].options,t);a||"dynamic"!==e.type||(a=e.realOption,m.filterDict[e.filter].options.push(e.realOption)),angular.isObject(a)&&!a.active&&(a.active=!0,m.applyFilter(a)),angular.isObject(a)&&m.metaDataRefresh&&(a.active=!0,m.applyFilter(a))}else"advanceSearchQuery"===e.filter&&m.applyFilter({advancedFilter:!0,criteria:{name:"advanceSearchQuery",value:e.option}})})},m.applyColumnSet=function(e){var a=_.filter(m.columnsConfig,{visible:!0});t.isServerApplicationEnabled(EntityVO.TYPE_SLM)||delete m.columnsConfig.slaStatus,m.presetColumns=[],_.each(m.columnsConfig,function(t){var a,n=e[t.name];n&&(a=angular.copy(t),a.order=n.order,a.visible="undefined"==typeof n.visible||n.visible,m.presetColumns.push(a))}),!e.newColumnType&&a.length&&_.forEach(a,function(e){if(!_.find(m.presetColumns,{name:e.name})){var t=angular.copy(e);m.presetColumns.push(t)}}),m.presetColumns=_.sortBy(m.presetColumns,"order"),m.criteria.attributeNames=_.map(m.presetColumns,"attributeName")},m.applyFilter=function(e){function t(t){var a,n,i,o=m.availableColConfig;return"dateTimeField"===t.fieldType?a=e.criteria.value[0]:"staticSelectionField"===t.fieldType?(i=_.find(o,{name:c}),i&&i.field&&i.field.options?n=_.find(i.field.options,{name:e.criteria.value[0]}):i&&i.oldFields&&i.oldFields.options&&(n=_.find(i.oldFields.options,{name:e.criteria.value[0]})),a=n&&n.index>-1?n.index:null):a=e.criteria.value[0],a}function a(e,t){return e=_.cloneDeep(e),_.remove(e,function(e){var a=_.findIndex(t,function(t){return _.isEqual(t,e)});return a>-1}),e}function n(e){e=_.cloneDeep(e);for(var t=0;t<e.length;t++)for(var a=t+1;a<e.length;a++)_.isEqual(e[t],e[a])&&(e.splice(a,1),a--);return e}var i,r=m.criteria.filterCriteria,s=e.criteria.name,l=_.isArray(e.criteria.value),c=e.filterName||e.criteria.name,d=m.filterDict[c];if(e.advancedFilter&&"advanceSearchQuery"===s)return void(r.advanceSearchQuery=e.criteria.value);if(e.active){if(d&&d.showLabelInPill&&(e.filterName=d.name,e.filterLabel=d.label),"date"===e.type&&(e.criteria.value=[{}],_.forEach(e.defaultValues,function(t,a){e.criteria.value[0][a]=o.$eval(t,{moment:moment})}),e.criteria.value[0].id=e.label,l=!1),"dynamic"===e.type&&"date"===e.criteria.type&&(l=!1),r[s])if(l)r[s]=_.union(r[s],e.criteria.value),r[s]=n(r[s]);else{var u=_.find(m.selectedFilters,{criteria:{name:e.criteria.name}});u.active=!1,m.applyFilter(u),r[s]=e.criteria.value}else if(e.filterType&&"customFilter"===e.filterType)if(d&&(i=t(d)),r.hasOwnProperty("customCriteria"))if(r.customCriteria.hasOwnProperty(s)&&_.isArray(r.customCriteria[s])&&l)r.customCriteria[s].push(i);else{if(!l){var p=_.find(m.selectedFilters,{criteria:{name:e.criteria.name}});p&&(p.active=!1,m.applyFilter(p))}r.customCriteria[s]=[i]}else r.customCriteria={},r.customCriteria[s]=[i];else r[s]=e.criteria.value;m.selectedFilters.unshift(e)}else{if(e.filterType&&"customFilter"===e.filterType)d&&(i=t(d)),r.customCriteria[s]=l?_.difference(r.customCriteria[s],[i]):[],r.customCriteria[s].length||delete r.customCriteria[s];else{r[s]=l?a(r[s],e.criteria.value):"";var f=_.filter(m.selectedFilters,function(t){return t.criteria.name===s&&0===t.criteria.value.length&&e.criteria.value.length>0});r[s]&&r[s].length||0!==f.length||delete r[s]}var g=_.findIndex(m.selectedFilters,function(t){return t.name===e.name&&t.criteria.name===e.criteria.name&&("affectedBusinessServices"!==e.criteria.name||t.criteria.value===e.criteria.value)});g>=0&&m.selectedFilters.splice(g,1)}},m.applyQuickSearch=function(e){""!==e?m.criteria.filterCriteria.quickSearchText=e:delete m.criteria.filterCriteria.quickSearchText},m.checkDateFilterAdded=function(){var e=!1;return _.each(m.selectedFilters,function(t){if("date"===t.criteria.type||"date"===t.type)return void(e=!0)}),m.dateFilterFound=e,m.dateFilterFound},m.saveFilterPreset=function(t){var a=_.cloneDeep(m.selectedFilters),i={name:t,value:_.map(a.reverse(),function(e){var t={filter:e.filterName||e.criteria.name,option:e.name};return"dynamic"===e.type&&(t.type="dynamic",t.realOption=angular.copy(e),delete t.realOption.active),t})};return m.criteria&&m.criteria.filterCriteria&&m.criteria.filterCriteria.advanceSearchQuery&&i.value.push({filter:"advanceSearchQuery",option:m.criteria.filterCriteria.advanceSearchQuery}),r.all([n.updateUserPreferences(h,i),e.saveTicketFilterConfiguration(t,m.criteria.filterCriteria)])},m.saveColumnPreset=function(e,t){return n.updateUserPreferences(y,{name:e,value:t})},m.removeUserFilterPreset=function(t){t.id&&(n.removeUserPreferences(h,t),e.removeFilterConfiguration(t.name,t.id)),t.columnId&&n.removeUserPreferences(y,{id:t.columnId}),_.remove(m.userSavedPresets,{name:t.name})},m.updateColumnConfig=function(e,t,a){function i(e){var t=!1;_.each(m.filterConfig,function(a,n){if(a.name>=e.name)return m.filterConfig.splice(n,0,e),t=!0,!1}),t||m.filterConfig.splice(m.filterConfig.length,0,e)}function o(e){var t,a=m.criteria.filterCriteria,n=m.selectedFilters;a.hasOwnProperty("customCriteria")&&a.customCriteria[e]&&(a.customColumnRemoved=!0,delete a.customCriteria[e]),_.remove(n,{filterType:"customFilter",filterName:e}),t=_.find(m.customColumnsObjs,{name:e}),t&&(t.expanded=!1,t.options&&_.isArray(t.options)&&_.each(t.options,function(e){e.active&&(e.active=!1)}))}var r=_.difference(_.keys(e),_.keys(m.currentColumnsConfig)),s=_.difference(_.keys(m.currentColumnsConfig),_.keys(e)),l=[];return r.length&&_.each(r,function(e){var t=_.find(m.customColumnsObjs,{name:e});t&&(t=D(m.mergedConsoleColumns[t.attributeName],t),l.push(t))}),n.updateUserPreferences(y,{id:a?a:E,name:t?t:"columns",value:e},{updateColumns:!0}).then(function(e){var t=a?_.find(e,{id:a}):_.find(e,{name:"columns"});t&&(m.currentColumnsConfig=t.value,E=t.id),r.length&&l.length&&(_.each(l,function(e){i(e)}),m.filterDict=_.assign(_.keyBy(l,"name"),m.filterDict)),s.length&&_.each(s,function(e){o(e);var t=_.findIndex(m.filterConfig,{name:e});t!==-1&&m.filterConfig.splice(t,1),_.isUndefined(m.filterDict[e])||delete m.filterDict[e]})})},m.checkForRangeFilter=function(e){return"range"===e.subtype&&"customFilter"===e.filterType},m.isSearchEnabled=function(){return O},m.setSearchEnabled=function(e){O=!!e},m.resetCache=function(e){m.metaDataRefresh=!0,m.columnsConfig=[],m.areFiltersPopulated=void 0,delete n.userConfig.TicketConsoleColumns,delete n.userConfig.TicketConsoleFilter,_.each(EntityVO.TICKET_TYPES,function(e){delete a.cache[e]}),i.consoleRefreshMetadata().then(function(){m.selectedFilters=[],e()})},m}])}(),ActivityVO.prototype=new TicketVO,ActivityVO.prototype.constructor=ActivityVO,ActivityVO.prototype.getProps=function(){return TicketVO.prototype.getProps().concat("scheduledStartDate","scheduledEndDate","actualStartDate","actualEndDate","location","templateId","templateGuid","requestedBy","parentId","parentGuid","parentName","parentTitle")},ActivityVO.prototype.postBuild=function(){TicketVO.prototype.postBuild.call(this),this.scheduledStartDate=this.scheduledStartDate?new Date(this.scheduledStartDate):null,this.scheduledEndDate=this.scheduledEndDate?new Date(this.scheduledEndDate):null,this.actualStartDate=this.actualStartDate?new Date(this.actualStartDate):null,this.actualEndDate=this.actualEndDate?new Date(this.actualEndDate):null,this.requestedBy.fullName=this.requestedBy.fullName?this.requestedBy.fullName:this.requestedBy.firstName+" "+this.requestedBy.lastName},function(){angular.module("ticketModule").controller("AssignController",["$scope","$modalInstance","userModel","screenConfigurationModel","ticketService","assignParams","events","systemAlertService","$q","i18nService","objectValueMapperService",function(e,t,a,n,i,o,r,s,l,c,d){function u(){e.customFieldFormIsDirty=!0,e.customFieldFormIsValid=R.isValid()}function p(e){return e.person.loginId||e.isGroup}function m(){e.assignActionForm.$dirty=!0}function f(){e.close()}var g,h,y,E={processing:!1,isDraft:o.isDraft,ghostEntity:!!o.ticket.ghostEntity};e.hideTabOnExpression={changeManager:!1,changeCoordinator:!1},e.ticket=_.cloneDeep(o.ticket),e.ticketRef=o.ticket,e.isDraft=o.isDraft,o.role?(e[o.role]=!0,e["assign"+o.role]=!0):o.activeRole&&(e[o.activeRole]=!0);var v={group:e.ticket.supportGroup&&e.ticket.supportGroup.id?(new SupportGroupVO).build(e.ticket.supportGroup):{},person:e.ticket.assignee&&e.ticket.assignee.loginId?(new PersonVO).build(e.ticket.assignee):{},isGroup:e.ticket.supportGroup&&e.ticket.supportGroup.id&&!e.ticket.assignee.loginId,autoAssign:!1};e.ticket.type===EntityVO.TYPE_INCIDENT||e.ticket.type===EntityVO.TYPE_WORKORDER||e.ticket.type===EntityVO.TYPE_TASK?(g=d.getValueByFieldName("assignee")||d.getValueByFieldName("assigneeName"),y=d.getValueByFieldName("assigneeSupportGroups")||d.getValueByFieldName("supportGroups"),o.ticket.assignee=g,o.ticket.supportGroup=y,v={group:y&&y.id?y:v.group,person:g&&g.loginId?g:v.person,isGroup:y&&y.id&&!(g&&g.loginId)||v.isGroup,autoAssign:!1}):e.ticket.type===EntityVO.TYPE_CHANGE&&(g=d.getFieldByName("changeCoordinator")||d.getFieldByName("assigneeName"),y=d.getFieldByName("changeCoordinatorSupportGroups"),e.hideTabOnExpression.changeCoordinator=g.isReadOnly&&y.isReadOnly,g.assigneeLoginId&&(h=g.assigneeLoginId),g=g.value,y=y.value,v={group:y&&y.id?y:v.group,person:g&&g.loginId?g:v.person,isGroup:y&&y.id&&g&&!g.loginId&&!h,autoAssign:!1});var T={group:e.ticket.managerGroup&&e.ticket.managerGroup.id?(new SupportGroupVO).build(e.ticket.managerGroup):{},person:e.ticket.manager&&e.ticket.manager.loginId?(new PersonVO).build(e.ticket.manager):{},isGroup:e.ticket.managerGroup&&e.ticket.managerGroup.id&&!e.ticket.manager.loginId,autoAssign:!1},S=o.ticket.manager||o.ticket.coordinator,C=o.ticket.managerGroup||o.ticket.coordinatorGroup;if(e.ticket.type!==EntityVO.TYPE_PROBLEM&&e.ticket.type!==EntityVO.TYPE_KNOWNERROR||(T={group:C&&C.id?(new SupportGroupVO).build(C):{},person:S&&S.loginId?(new PersonVO).build(S):{},isGroup:C&&C.id&&!S.loginId,autoAssign:!1}),e.ticket.type===EntityVO.TYPE_CHANGE){var O,A=d.getFieldByName("changeManager")||d.getFieldByName("managerName"),I=d.getFieldByName("changeManagerSupportGroups");e.hideTabOnExpression.changeManager=A.isReadOnly&&I.isReadOnly,A.assigneeLoginId&&(O=A.assigneeLoginId),A=A.value,I=I.value,T={group:I&&I.id?I:T.group,person:A&&A.loginId?A:T.person,isGroup:I&&I.id&&A&&!A.loginId&&!O,autoAssign:!1}}else if(e.ticket.type===EntityVO.TYPE_WORKORDER){var b=d.getFieldByName("requestManager")||d.getFieldByName("managerName"),k=d.getFieldByName("requestManagerSupportGroups");e.hideTabOnExpression.requestManager=b&&b.isReadOnly&&k&&k.isReadOnly,b&&(b=b.value),k&&(k=k.value),T={group:k&&k.id?k:T.group,person:b&&b.loginId?b:T.person,isGroup:k&&k.id&&!(b&&b.loginId)||T.isGroup,autoAssign:!1}}var D=n.getAssignmentPanel(e.ticket),R=angular.copy(D),P=D.fields||[];e.hideTabs=0===P.length&&e.ticket.type!==EntityVO.TYPE_WORKORDER&&e.ticket.type!==EntityVO.TYPE_CHANGE&&e.ticket.type!==EntityVO.TYPE_PROBLEM&&e.ticket.type!==EntityVO.TYPE_KNOWNERROR,e.groups=[];var w=R.fields||[];n.initFieldValues(w,e.ticket),e.customFields=w;var L=angular.copy(o.ticket.customFields);e.close=function(){if(e.assignActionForm.$dirty){var a=s.modal({title:c.getLocalizedString("common.notification.dirty.title"),text:c.getLocalizedString("common.notification.dirty.message"),buttons:[{text:c.getLocalizedString("common.labels.yes"),data:!0},{text:c.getLocalizedString("common.labels.no"),data:!1}]});a.result.then(function(a){a&&(o.ticket=_.cloneDeep(e.ticket),t.dismiss())})}else o.ticket=_.cloneDeep(e.ticket),t.dismiss()},e.enableSave=function(){return v.person.loginId&&v.person.supportGroupId&&(!o.ticket.assignee||v.person.loginId!==o.ticket.assignee.loginId||v.person.supportGroupId!==o.ticket.supportGroup.id)||v.isGroup&&(o.ticket.assignee&&o.ticket.assignee.id||!y||v.group.id!==y.id)||v.autoAssign||T.person.loginId&&T.person.supportGroupId&&(T.person.loginId!==(S||{}).loginId||T.person.supportGroupId!==(C||{}).id)||T.isGroup&&(S&&S.id||!C||T.group.id!==C.id)||T.autoAssign||e.customFieldFormIsDirty&&e.customFieldFormIsValid},e.submit=function(){E.processing=!0;var a={},o={};p(v)&&!v.autoAssign?v.isGroup?v.group&&e.ticket.supportGroup&&(v.person.loginId===e.ticket.assignee.loginId&&v.group.id===e.ticket.supportGroup.id||(o={group:v.group.name,groupId:v.group.id,company:v.group.company.name,organization:v.group.organization,autoAssign:!1}),v.person={}):("All"===v.group.id&&(v.person.supportGroups&&v.person.supportGroups.length>0?(v.person.supportGroupId&&(v.group=_.find(v.person.supportGroups,{id:v.person.supportGroupId})),v.group=v.group||v.person.supportGroups[0]):e.ticket.supportGroup&&e.ticket.supportGroup.id&&(v.group=(new SupportGroupVO).build(e.ticket.supportGroup))),v.person.loginId===e.ticket.assignee.loginId&&v.group.id===e.ticket.supportGroup.id||(o={loginId:v.person.loginId,fullName:v.person.fullName,group:v.group&&v.group.name?v.group.name:"",groupId:v.group&&v.group.id?v.group.id:"",company:v.group&&v.group.company&&v.group.company.name?v.group.company.name:"",organization:v.group&&v.group.organization?v.group.organization:"",autoAssign:!1})):(o={autoAssign:!0},v={person:{},group:{}});var r={};if(p(T)&&!T.autoAssign?T.isGroup?e.ticket.type===EntityVO.TYPE_PROBLEM||e.ticket.type===EntityVO.TYPE_KNOWNERROR?T.group.id===e.ticket.coordinatorGroup.id&&T.person.loginId===(e.ticket.coordinator&&e.ticket.coordinator.loginId)||(r={coordinatorGroup:T.group.name,coordinatorCompany:T.group.company.name,coordinatorOrganization:T.group.organization,coordinatorGroupId:T.group.id,coordinatorAutoAssign:!1}):(T.person.loginId===(e.ticket.manager&&e.ticket.manager.loginId)&&T.group.id===(e.ticket.managerGroup&&e.ticket.managerGroup.id)||(r={managerGroup:T.group.name,managerCompany:T.group.company.name,managerOrganization:T.group.organization,managerGroupId:T.group.id,managerAutoAssign:!1}),T.person={}):("All"===T.group.id&&(T.person.supportGroups&&T.person.supportGroups.length>0?(T.person.supportGroupId&&(T.group=_.find(T.person.supportGroups,{id:T.person.supportGroupId})),T.group=T.group||T.person.supportGroups[0]):C&&C.id&&(T.group=(new SupportGroupVO).build(C))),r=e.ticket.type===EntityVO.TYPE_PROBLEM||e.ticket.type===EntityVO.TYPE_KNOWNERROR?{coordinatorLoginId:T.person.loginId,coordinatorFullName:T.person.fullName,coordinatorGroup:T.group.name,coordinatorCompany:T.group.company.name,coordinatorOrganization:T.group.organization,coordinatorGroupId:T.group.id,coordinatorAutoAssign:!1}:{managerLoginId:T.person.loginId,managerFullName:T.person.fullName,managerGroup:T.group.name,managerCompany:T.group.company.name,managerOrganization:T.group.organization,managerGroupId:T.group.id,managerAutoAssign:!1}):r=e.ticket.type===EntityVO.TYPE_PROBLEM||e.ticket.type===EntityVO.TYPE_KNOWNERROR?{coordinatorAutoAssign:!0}:{managerAutoAssign:!0},a=_.merge(o,r),P.length){var s=n.collectChanges(e.customFields,L);_.size(s)&&(a=_.merge(a,{customFields:s}))}var c=E.isDraft?l.when:i.update;c(e.ticket.id,e.ticket.type,a).then(function(e){var n={originalObject:e,autoAssign:a.autoAssign,assignee:e&&e.assignee||v.person,group:v.group,managerAutoAssign:a.managerAutoAssign,manager:T.person,managerGroup:T.group,coordinatorAutoAssign:a.coordinatorAutoAssign};n.group.assignedToGroup=v.isGroup,n.managerGroup.assignedToGroup=T.isGroup,E.isDraft||_.isEmpty(e)?E.isDraft&&!_.isUndefined(a.customFields)&&(n.changes=a.customFields):(n.accessMappings=e.accessMappings||{},n.status=e.status||{},n.changes=e.customFields||{},a.autoAssign&&(n.assignee=e.assignee||{},n.group=e.supportGroup||{}),a.coordinatorAutoAssign&&(n.manager=e.coordinator,n.managerGroup=e.coordinatorGroup),a.managerAutoAssign&&(n.manager=e.manager,n.managerGroup=e.managerGroup)),n.group.persons=[],a.customFields&&_.forOwn(a.customFields,function(e,t){"undefined"==typeof n.changes[t]&&(n.changes[t]="")}),t.close(n)})["finally"](function(){E.processing=!1})},e.$on(r.FIELD_FORM_IS_DIRTY,u),e.$on(r.MODAL_FORM_IS_DIRTY,m),e.$on(r.MODAL_BACKDROP_CLICK,f),e.selectedAssignee=v,e.selectedManager=T,e.state=E,setTimeout(function(){e.assignActionForm&&(e.assignActionForm.$dirty=!1);
},0)}])}(),function(){angular.module("ticketModule").controller("BulkAssignController",["$scope","$modalInstance","$q","ticketService","assignParams","systemAlertService","i18nService","events",function(e,t,a,n,i,o,r,s){function l(){return d.person.loginId||d.isGroup||d.autoAssign}function c(){e.close()}var d={group:{},person:{},isGroup:!1,autoAssign:!1},u={processing:!1},p=i.selectedItems;e.ticket=p&&p[0]||{},p.length>0&&Object.keys(_.countBy(p,"customer.company.name")).length>=2&&(e.ticket.customer=null),e.groups=[],p&&p.length&&p[0].supportGroup.id&&(d.group=(new SupportGroupVO).build(p[0].supportGroup?p[0].supportGroup:p[0].assignedGroup)),e.close=function(){var e=o.modal({title:r.getLocalizedString("common.notification.dirty.title"),text:r.getLocalizedString("common.notification.dirty.message"),buttons:[{text:r.getLocalizedString("common.labels.yes"),data:!0},{text:r.getLocalizedString("common.labels.no"),data:!1}]});e.result.then(function(e){e&&t.dismiss()})},e.$on(s.MODAL_BACKDROP_CLICK,c),e.submit=function(){if(u.processing=!0,l()){var a={};d.autoAssign?(a={autoAssign:!0},d.person={},d.group={}):(d.isGroup||(d.group=d.person.supportGroups[0],a.loginId=d.person.loginId,a.fullName=d.person.fullName),e.ticket.type===EntityVO.TYPE_KNOWLEDGE?(a.assigneeGroup=d.group.name,a.assigneeGroupId=d.group.id,a.assigneeCompany=d.group.company?d.group.company.name:"",a.assigneeOrganization=d.group.organization):(a.group=d.group.name,a.groupId=d.group.id,a.company=d.group.company?d.group.company.name:"",a.organization=d.group.organization,a.autoAssign=!1));var i={ids:_.map(p,function(e){return{uuid:e.id,type:e.type}}),attributeValueMap:a};n.assignTickets(i).then(function(){var e={assignee:d.person,group:d.group};t.close(e)})["catch"](function(e){o.error({text:e.data.error,clear:!1}),u.processing=!1})}},e.assignee=d,e.state=u}])}(),ChangeVO.prototype=new TicketVO,ChangeVO.prototype.constructor=ChangeVO,ChangeVO.prototype.getProps=function(){return TicketVO.prototype.getProps().concat("type","crossLaunchURL","impactedService","changeReason","timing","timingReason","manager","scheduledStartDate","scheduledEndDate","targetDate","earliestStartDate","riskIsUserSpecified","actualStartDate","actualEndDate","riskLevel","impact","urgency","managerGroup","location","questionResponses","impactedAreas","templateId","isInApproval","isPasswordEnabled","isAutomatic","taskPhaseId","previousStatus","requestedByCompany","approvalProcessName","brokerVendorName","templateName","parentId","leadTime","createdfromParentTemplate","copyTasks")},ChangeVO.prototype.postBuild=function(){TicketVO.prototype.postBuild.call(this),this.scheduledStartDate=this.scheduledStartDate?new Date(this.scheduledStartDate):null,this.scheduledEndDate=this.scheduledEndDate?new Date(this.scheduledEndDate):null,this.actualStartDate=this.actualStartDate?new Date(this.actualStartDate):null,this.actualEndDate=this.actualEndDate?new Date(this.actualEndDate):null,this.targetDate=this.targetDate?new Date(this.targetDate):null,this.scheduledStartDateHumanized=this.scheduledStartDate?moment(this.scheduledStartDate).format("lll"):null,this.scheduledEndDateHumanized=this.scheduledEndDate?moment(this.scheduledEndDate).format("lll"):null,this.targetDateHumanized=this.targetDate?moment(this.targetDate).format("lll"):null,this.actualStartDateHumanized=this.actualStartDate?moment(this.actualStartDate).format("lll"):null,this.actualEndDateHumanized=this.actualEndDate?moment(this.actualEndDate).format("lll"):null},function(){angular.module("createTicketModule").controller("CopyChangeController",["$scope","$modalInstance","systemAlertService","$filter","ticket","ticketService","$state","relationModel",function(e,t,a,n,i,o,r,s){function l(t){var a=s.cache[e.ticket.id];return!("Yes"!=e.copyOptions.copyCI||!a.length)}var c={processing:!1},d=!1;e.dataSaving=!1,e.state=c,e.isCheckedAll=!1,e.copyOptions={copyRequestForCustomer:"No",copyCI:"No",copyImpactedAreas:"No",copyRelatedChange:"No",copyDocument:"No",copyTaskAutomatic:"Yes",copyTaskManual:"Yes",copyTaskCancelled:"No",copyTaskFailed:"No"},e.init=function(){e.ticket=_.cloneDeep(i),e.state.processing=!1},e.copyChange=function(){e.dataSaving=!0;var t={};for(var a in e.copyOptions)"Yes"==e.copyOptions[a]&&(t[a]="Yes");o.copyChange(e.ticket.id,t).then(function(t){var a=l(t);r.go("draftChange",{id:t.id,editMode:!0,isCopyChange:!0,copyChangeId:e.ticket.id,ticket:t,hasRelatedCis:a})})["finally"](function(){e.dataSaving=!1})},e.close=function(){t.dismiss()},e.toggleSelectAll=function(){if(d){d=!1;for(var t in e.copyOptions)e.copyOptions[t]="No"}else{d=!0;for(var t in e.copyOptions)e.copyOptions[t]="Yes"}},e.disableTaskType=function(){return"No"==e.copyOptions.copyTaskAutomatic&&"No"==e.copyOptions.copyTaskManual&&(e.copyOptions.copyTaskCancelled="No",e.copyOptions.copyTaskFailed="No"),!("Yes"==e.copyOptions.copyTaskAutomatic||"Yes"==e.copyOptions.copyTaskManual)},e.$watch("copyOptions",function(t,a){for(var n=0,i=Object.keys(t);n<i.length;n++){var o=i[n];"No"==t[o]&&(e.isCheckedAll=!1,d=!1)}},!0),e.init()}])}(),function(){angular.module("ticketModule").controller("dataLossPreventionProfileController",["$scope","$state","ticketModel","$q","metadataModel","$modal",function(e,t,a,n,i,o){e.id=t.params.id,e.type=t.current.name,e.ticket={},e.state={dataIsLoading:!0};var r=a.getTicket(e.id,e.type,!0),s=i.getMetadataByTypes(EntityVO.ALL_TYPES),l=[r,s];e.metadata={},n.all(l).then(function(t){e.basicData=t[0],e.metadata=_.find(t[1],{metadatatype:e.type})})["finally"](function(){e.state.dataIsLoading=!1}),e.showSensitiveInfo=function(e,t){o.open({templateUrl:"views/ticket/profiles/data-loss-prevention-sensitive-info-action-blade.html",windowClass:"action-blade",size:"lg",controller:["$scope","sensitiveData",function(e,t){e.rule=t.rule,e.policyName=t.policyName,e.toggleCount=function(e){e.isCountCollapsed=!e.isCountCollapsed}}],resolve:{sensitiveData:function(){return{rule:e,policyName:t}}}})}}])}(),DLPVO.prototype=new BaseVO,DLPVO.prototype.constructor=DLPVO,DLPVO.prototype.getProps=function(){return BaseVO.prototype.getProps().concat("summary","company","triggeredBy","parentType","parentDisplayId","parentId","parentSummary","eventSourceInfo","policies","type")},DLPVO.prototype.postBuild=function(){BaseVO.prototype.postBuild.call(this)},function(){angular.module("ticketModule").controller("DraftTicketController",["$scope","$rootScope","$state","$q","$log","$stateParams","ticketModel","metadataModel","smartRecorderModel","categoriesService","ticketActionService","systemAlertService","userModel","i18nService","$window","feedModel","$timeout","events","screenConfigurationModel","ticketTemplateModel","srdModel","$filter","$injector","relationModel","relationService","configurationModel","layoutConfigurationModel","objectValueMapperService","permissionModel","createTicketModel","localStorageService","attachmentService","utilityFunctions",function(e,t,a,n,i,o,r,s,l,c,d,u,p,m,f,g,h,y,E,v,T,S,C,O,A,I,b,k,D,R,P,w,L){function N(){if(e.state={dataIsLoading:!0},e.relationCounters={tickets:0,"linked-items":0},e.basicData={},e.metadata={},e.globalMetadata={},e.isFullVersion=!0,e.numberOfRelatedTasks=0,e.numberOfLinkedResources=0,e.editHeader=!1,e.isContactCollapsed=!0,a.params.isCopyChange)e.type=EntityVO.TYPE_CHANGE,fe=E.getScreenNameByTicketType(e.type);else{Te?(e.type=r.cache.draft.type,r.cache.draft.relationship&&(e.relationship=angular.copy(r.cache.draft.relationship)),l.smartRecorderData={}):e.type=l.smartRecorderData.type,fe=E.getScreenNameByTicketType(e.type),e.template=l.smartRecorderData.template;var t=_.filter(l.smartRecorderData.confirmedItems,{relationship:"mentioned"});t.length&&e.type!==EntityVO.TYPE_SERVICEREQUEST&&(e.activityFlag=!0,e.resourceFlag=!1,h(function(){e.$broadcast(y.SET_TICKET_DRAFT_MENTIONED)},2e3))}k.clearMap(e.type),e.hasEditPermission=D.hasPermissionForTicket(e.type)}function M(t,a,n,i){d.showAssignDialog(e.basicData,!0,a,i).result.then(function(e){F(e,n,a),t.currentTarget.focus()},function(){t.currentTarget.focus()})}function V(e,t,a){var n={};"workordermanager"===t||"problemcoordinator"===t?(n.manager={id:e.id,loginId:e.loginId,fullName:e.fullName,supportGroup:e.supportGroup,groupId:e.supportGroupId,company:e.company,organization:e.organization},n.managerGroup={id:e.supportGroupId,name:e.supportGroup,organization:e.organization,company:e.company}):(n.assignee={id:e.id,loginId:e.loginId,fullName:e.fullName,supportGroup:e.supportGroup,groupId:e.supportGroupId,company:e.company,organization:e.organization},n.group={id:e.supportGroupId,name:e.supportGroup,organization:e.organization,company:e.company}),F(n,a)}function F(t,a,n){var i=e.basicData;if(t.autoAssign?(i.assignee={},i.supportGroup={}):(t.assignee&&(i.assignee=t.assignee),t.group&&(i.supportGroup=t.group)),t.managerAutoAssign?(i.manager={},i.managerGroup={}):(t.manager&&(i.manager=t.manager),t.managerGroup&&(i.managerGroup=t.managerGroup)),t.coordinatorAutoAssign?(i.coordinator={},i.coordinatorGroup={}):(t.manager&&(i.coordinator=t.manager),t.managerGroup&&(i.coordinatorGroup=t.managerGroup)),_.size(t.changes)&&(E.updateTicketData(i,t.changes),!a)){var o=E.composePanelId(i.type,"Assignment");e.$broadcast(y.REFRESH_FIELD_VALUES,{panelId:o,ticket:i})}[EntityVO.TYPE_INCIDENT,EntityVO.TYPE_WORKORDER,EntityVO.TYPE_CHANGE].indexOf(e.basicData.type)!==-1&&e.$broadcast(y.TICKET_ASSIGNEES_UPDATED,i,!a,n)}function x(){R.currentTicket=e.basicData,!a.params.hasRelatedCis&&!R.currentTicket.impactedService||I.disableImpactAnalysis?U():G()}function G(){return u.modal({type:"info",title:m.getLocalizedString("create.change.wizard.confirmImpactAnalysis.title"),text:m.getLocalizedString("create.change.wizard.confirmImpactAnalysis.text"),details:m.getLocalizedString("create.change.wizard.confirmImpactAnalysis.text2"),additionalInfo:m.getLocalizedString("create.change.wizard.confirmImpactAnalysis.text3"),buttons:[{text:m.getLocalizedString("impact.analysis.button.submitWithImpactAnalysisWindow"),data:!0},{text:m.getLocalizedString("impact.analysis.button.submitWithoutImpactAnalysisWindow"),data:!1}]}).result.then(B,$)}function $(){e.$broadcast(y.CHANGE_TO_EDIT_MODE)}function B(e){U(e)}function U(t){e.$broadcast(y.PROVIDER_SHOW_LOADING);var i=R.collectTicketChanges(e.metadata);i.parentId=e.basicData.parentId,_.isEmpty(e.basicData.templateId)||(i.templateId=e.basicData.templateId),_.isEmpty(e.basicData.timing)||(i.timing=e.basicData.timing),_.isEmpty(e.basicData.timingReason)||(i.timingReason=e.basicData.timingReason);var o=c.collectValues(e.basicData.allCategories,e.basicData,null,!0);if(i.categorizations=o.categorizations,g.pendingWorkNote){var r={};r.worknote=g.pendingWorkNote.noteText,r.access=g.pendingWorkNote.access,r.workInfoType=g.pendingWorkNote.workInfoType,i.workInfo=r,g.pendingWorkNote.attachments&&g.pendingWorkNote.attachments.length&&(i.attachments=g.pendingWorkNote.attachments)}i.summary&&(i.summary=i.summary.replace(/\u00a0/g," ")),i.riskIsUserSpecified||delete i.riskLevel,R.currentTicket.questionResponses=i.questionResponses?i.questionResponses:"",e.basicData.riskIsUserSpecified=i.riskIsUserSpecified,delete i.questionDefinitions,delete i.questionResponses,i.scheduledStartDate=e.basicData.scheduledStartDate&&e.basicData.scheduledStartDate.valueOf()||i.scheduledStartDate,i.scheduledEndDate=e.basicData.scheduledEndDate&&e.basicData.scheduledEndDate.valueOf()||i.scheduledEndDate,i.actualStartDate=e.basicData.actualStartDate&&e.basicData.actualStartDate.valueOf()||i.actualStartDate,i.actualEndDate=e.basicData.actualEndDate&&e.basicData.actualEndDate.valueOf()||i.actualEndDate,i.targetDate=e.basicData.targetDate&&e.basicData.targetDate.valueOf()||i.targetDate,null!==e.basicData.createdfromParentTemplate&&(i.createdfromParentTemplate=e.basicData.createdfromParentTemplate),null!==e.basicData.copyTasks&&(i.copyTasks=e.basicData.copyTasks),R.createChangeRequestV2(i).then(function(o){var r=[];r.push(R.saveImpactedAreas(R.currentTicket.id,EntityVO.TYPE_CHANGE,R.currentTicket.impactedAreas)),i.riskIsUserSpecified||r.push(R.saveRiskResponse(R.currentTicket)),r.push(R.saveDocuments(R.currentTicket)),r=_.flatten(r),r.length>0&&n.all(r)["finally"](function(){R.onChangeCreateSuccess(o,t),h(function(){u.success({text:m.getLocalizedString("copychange.general.message2"),clear:!0,hide:1e4})},500),a.go(e.type,{id:o.id})})})["catch"](function(t){z(t),e.$broadcast(y.PROVIDER_HIDE_LOADING),e.$broadcast(y.CHANGE_TO_EDIT_MODE)})["finally"](function(){e.$broadcast(y.PROVIDER_HIDE_LOADING)})}function z(e){if(e){var t=_.isObject(e)?e.data:{error:e};if(me){var a=_.find(u.alertStack,{key:me.key});a&&a.close()}me=u.error({text:t.detailMessage||e.data.error,clear:!1})}}function Y(t){t.summary=t.summary.replace(/\u00a0/g," "),t.desc&&(t.desc=t.desc.replace(/\u00a0/g," ")),_.isString(t.contact)&&_.isEmpty(t.contact)&&(t.contact={}),r.saveDraft(e.type,t).then(function(t){var a=n.when(1),i=[];if(e.type!==EntityVO.TYPE_PROBLEM&&e.type!==EntityVO.TYPE_KNOWNERROR||(e.basicData.id=t.ticketData.id),"true"===o.isSrcLiveChat&&e.liveChatWindow){var r={type:e.basicData.type,id:e.basicData.id,displayId:e.basicData.displayId,chatSessionId:e.basicData.chatSessionId,summary:e.basicData.summary},s={eventData:{livechatTicketData:r},event:y.TICKET_CREATED_FROM_DRAFT};e.liveChatWindow.postMessage(s,window.location&&window.location.origin)}O.cache[e.basicData.id]&&(i=ee(e.basicData.id,e.basicData.displayId,O.cache[e.basicData.id])),Ce&&Ce.fromType===EntityVO.TYPE_PROBLEM&&Ce.type===EntityVO.TYPE_KNOWNERROR&&(Ce.relationship=RelationItemVO.TYPE_INITIATEDBY),Se&&i.push({id:Ce.id,relationshipType:Ce.relationship?Ce.relationship:RelationItemVO.TYPE_CREATEDBY,tag:RelationItemVO.TAG_LINKEDITEM,type:Ce.fromType,desc:Ce.fromContext.summary}),i.length&&(a=O.addRelation({uuid:e.basicData.id,type:e.type},i)),a.then(K)})["catch"](function(t){z(t),e.state.dataIsLoading=!1,e.$broadcast(y.HIDE_TICKET_DRAFT_LOADER)})}function q(){if(ge&&ge.length>0){var t={type:e.type,id:e.basicData.id},a={};return a.noteText=ge,g.saveNote(t,a)}return n.when(1)}function H(e){return g.processPendingWorkNote(e)||n.when(1)}function K(){O.cache[e.basicData.id]&&delete O.cache[e.basicData.id],Ce&&Ce.fromType===EntityVO.TYPE_ASSET&&delete O.cache[Ce.id];var t=q(),i=H(e.basicData);e.dirty=!1,delete r.cache[e.basicData.id],e.draftNotificationInstance&&u.dismissAlert(e.draftNotificationInstance.key),h(function(){u.success({text:S("i18n")("ticket.notification.save.message"),hide:1e4})},500);var o={id:e.basicData.id};n.all([t,i]).then(function(){e.state.dataIsLoading=!1,a.go(e.type,o,{location:"replace"})})}function j(t,a){angular.extend(a,{tag:EntityVO.TYPE_RESOURCE,relationshipType:RelationItemVO.TYPE_RELATEDTO}),O.markRelationForAdd(e.basicData.id,a)}function W(t,a){O.markRelationForDelete(e.basicData.id,a)}function Q(t,a,n){e.basicData.status={value:"Resolved",reason:"No Further Action Required"},k.getFieldByName("status").value="Resolved",k.getFieldByName("statusReason").value="No Further Action Required",k.getFieldByName("resolution").value=n.title,e.basicData.resolution=a.title,e.basicData.summary||(e.basicData.summary=e.basicData.desc.substring(0,100)),e.saveDraft(n)}function J(t,a){angular.extend(a,{tag:EntityVO.TYPE_LINKEDITEM,relationshipType:EntityVO.TYPE_DUPLICATEOF}),O.cache[e.basicData.id].push(a)}function Z(t,a){e.activeEditableSectionId=a,"ticket-header"===a&&e.enableHeaderEdit()}function X(){e.activeEditableSectionId=null}function ee(e,t,a){for(var n=[],i=0;i<a.length;i++){var o=a[i];o.type!==EntityVO.TYPE_TASK&&(o=(new RelationItemVO).build(o),o.parentId=e,o.isPoi=void 0,o.realObject=void 0,o.entityLink=void 0,o.details={parentDisplayId:t},o.tag||(o.tag=EntityVO.TYPE_RESOURCE),o.relationshipType||(o.relationshipType=EntityVO.TYPE_RELATEDTO),n.push(o))}return n}function te(){e.$on("$stateChangeStart",function(t,n,i){if(e.dirty){t.preventDefault();var o=u.modal({title:m.getLocalizedString("common.notification.dirty.title"),text:m.getLocalizedString("common.notification.dirty.message"),buttons:[{text:m.getLocalizedString("common.notification.dirty.button1"),data:{stateName:n.name,stateParams:i}},{text:m.getLocalizedString("common.notification.dirty.button2")}]});o.result.then(function(t){if(_.isEmpty(t))e.type===EntityVO.TYPE_SERVICEREQUEST&&e.isCrossLaunchRequest&&T.launchAIF(!0,!0,e,e.template.name,e.template.templateObject.crossLaunchURL,e.basicData.customer.id,e.basicData.contact?e.basicData.contact.id:null);else{e.dirty=!1,pe();var n=C.get("$modalStack");n.dismissAll(),a.transitionTo(t.stateName,t.stateParams,{location:"replace"})}})}})}function ae(e){var a;if(e.date&&e.time){t.timezone&&(e.date=L.convertToUserPreferenceTimezone(e.date,t.timezone),e.time=L.convertToUserPreferenceTimezone(e.time,t.timezone));var n=moment(e.time);a=moment(e.date).hour(n.hour()).minute(n.minute())}else t.timezone&&(e=L.convertToUserPreferenceTimezone(e,t.timezone)),a=moment(e);return a.format()}function ne(t,a){var n=!1,o=a.originalEvent;if(!a)return void i.warn("Could not open assignment blade. Required Event data is missing. ");n=!!a.assignToMe;var r=a.role;"manager"===r||"coordinator"===r?r=e.type+r:"assignee"===r&&(r=e.type===EntityVO.TYPE_CHANGE?e.type+"coordinator":"ticketassignee"),n?d.assignToMe(o,r,!a.saveSelection,e.basicData,e):d.assign(o,!a.saveSelection,e.basicData,e,r)}function ie(){var t;e.dirty=!0,k.setCopyChangeTicket(),te(),h(function(){u.warning({text:m.getLocalizedString("copychange.general.message"),hide:1e4})},500);var i=s.getMetadataByType(e.type).then(function(n){var i=[];e.metadata=n||{},_.forEach(e.metadata.riskLevels,function(e){i.push(e.name)}),t=r.getChangeRiskRules(a.params.ticket.company&&a.params.ticket.company.name).then(function(t){t&&t.workNoteRequiredForRisk&&(e.basicData.riskRulesConfigured=!0,e.basicData.riskLevelForNote=_.takeRight(i,i.length-i.indexOf(t.workNoteRequiredForRisk))),t&&t.changeReasonRequiredForRisk&&(e.basicData.riskRulesConfigured=!0,e.basicData.riskLevelForChangeReason=_.takeRight(i,i.length-i.indexOf(t.changeReasonRequiredForRisk)))})}),o=s.getMetadataByType(EntityVO.TYPE_GLOBAL).then(function(t){e.globalMetadata=t||{},ye=e.globalMetadata.configurationParameters.affectedServiceRelation}),l=b.loadScreenLayout(fe).then(function(t){e.screenLayout=t;var a=E.getFieldByName(fe,"impactedAreas");if(a){var n=_(e.screenLayout.panels).thru(function(e){return _.union(e,_.map(e,"panels"))}).flatten().find({id:a.panelId});n&&0==n.children.length&&_.remove(e.screenLayout.panels,{name:"impactedAreasSection"})}}),d=[].concat([i,o,l,t]);n.all(d).then(function(){e.basicData=a.params.ticket,e.basicData.fromCopyChange=!0,e.basicData.isDraft=!0,e.basicData.riskLevel="",e.basicData.isFullVersion=e.isFullVersion,e.type=EntityVO.TYPE_CHANGE,e.state.dataIsLoading=!1,_.isEmpty(e.basicData.status)&&(e.basicData.status.value="Draft");var t=e.basicData.categorizations;e.basicData.allCategories=c.populateCategories(t,e.metadata),e.basicData.noCategories=_.filter(e.basicData.allCategories,"valueToShow").length,e.addNote={inputText:""}})}function oe(e){return null!==e&&"undefined"!=typeof e&&""!==e}function re(e,t,a){return t.isHidden===!a&&se(e,t)&&!e.isHidden&&e.visibility}function se(e,t){return"RADIO_BUTTONS"===e.format||"STATIC_MENU"===e.format?t.conditionValues===e.answer:!("CHECK_BOXES"!==e.format||!e.answer)&&e.answer.sort().join(";")===t.conditionValues.split(";").sort().join(";")}function le(t){var a=_.filter(t,{level:0});a.sort(de),he=he.concat(a),ce(a,0),e.basicData.questionDefinitions=he}function ce(t,a){a++,_.each(t,function(t){var n=_.filter(e.basicData.questionDefinitions,{parentId:t.id,level:a});if(n.length){n.sort(de);var i=_.findIndex(he,{id:t.id}),o=_.slice(he,++i);he=_.slice(he,0,i).concat(n).concat(o),ce(n,a)}})}function de(e,t){var a=e.sortOrder,n=t.sortOrder;return a<n?-1:a>n?1:0}function ue(){e.relationCounters.tasks=A.getRelatedTasks(e.relationCache).length,e.relationCounters.linkedItems=A.getRelatedLinkedItems(e.relationCache,e.basicData,ye).length}function pe(){"true"===o.isSrcLiveChat&&e.liveChatWindow&&e.liveChatWindow.postMessage({event:y.DRAFT_TICKET_CLOSED},window.location&&window.location.origin)}var me,fe,ge="",he=[],ye=!1,Ee={name:"smartRecorder",params:{}},ve=o.error;"true"===o.isSrcLiveChat&&(e.liveChatWindow=window.opener);var Te=!_.isEmpty(r.cache.draft),Se=!_.isEmpty(r.cache.relatedDraft),Ce=Se?angular.copy(r.cache.relatedDraft):null;e.forms={},e.isDraft=!0,e.activityFlag=!1,e.resourceFlag=!0,e.formIsValid=!0,e.loggedInUserId=p.userId,e.isCategoriesEmpty=!1,e.relatedDraftInfo=Ce,e.formContainsInvalidFields=R.formContainsInvalidFields,e.ticketActions={assign:function(t,a,n){var i=n;e.type==EntityVO.TYPE_CHANGE&&("manager"===n?i=e.type+n:"ticketassignee"===n&&(i=e.type+"coordinator")),M(t,null,a,i)},assignToMe:function(t,a,n){var i=_.cloneDeep(e.basicData),o=a,s=i.supportGroup;"ticketassignee"===a?o=i.type===EntityVO.TYPE_WORKORDER?"workorderassignee":"":"workordermanager"===a?s=i.managerGroup:"problemcoordinator"===a&&(s=i.coordinatorGroup),r.getTicketAssigneePersons(i.type,o).then(function(e){e=_.uniqBy(e.results,function(e){return e.loginId&&e.supportGroupId});var i=1===e.length?e[0]:_.find(e,{supportGroupId:s.id});i&&i.loginId?V(i,o||a,n):M(t,a,n)})},editStatus:function(t){d.showEditStatusDialog(e.basicData,!0,!1).result.then(function(a){ge=a.worknote;var n=_.cloneDeep(e.basicData.attachments);r.cache[e.basicData.id].attachments=n,""===r.cache[e.basicData.id].desc&&""!==e.basicData.desc&&(r.cache[e.basicData.id].desc=e.basicData.desc),r.refreshStatus(e.basicData.id,e.basicData.type,a,e.basicData),t.currentTarget.focus()},function(){t.currentTarget.focus()})},editHeader:function(t){t&&(e.basicData.summary!==t.summary&&(e.basicData.summary=t.summary),e.basicData.priority=t.priority.name,e.type===EntityVO.TYPE_INCIDENT&&(e.basicData.impact=t.impact.name,e.basicData.urgency=t.urgency.name),e.type!==EntityVO.TYPE_PROBLEM&&e.type!==EntityVO.TYPE_KNOWNERROR||(e.basicData.impact=t.impact.name,e.basicData.urgency=t.urgency.name,e.basicData.targetDate=moment(t.targetDate).valueOf())),e.editHeader=!1},editCustomerCard:function(t){if(t){var a=_.find(t,{type:"customer"}),i=_.find(t,{type:"contact"});e.basicData.customer=a?a.data:{},e.basicData.contact=i?i.data:{}}return n.when(1)}},e.clearCategories=function(t){e.$broadcast(y.CLEAR_ALL_CATEGORIES,t)},e.enableHeaderEdit=function(){e.editHeader=!0},e.disableDuplicateOfEdit=function(){e.basicData.accessMappings.detailsEditAllowed=!1,e.basicData.accessMappings.statusEditAllowed=!1,e.basicData.accessMappings.relationsEditAllowed=!1},e.saveDraftChange=function(){e.$broadcast(y.SAVE_TICKET_DRAFT),x()},e.saveDraft=function(t){var a=e.getCreateData(t);Y(a)},e.getCreateData=function(a){k.isShelvedParentEmpty()||k.unshelveParent(e.type),e.$broadcast(y.SAVE_TICKET_DRAFT),e.state.dataIsLoading=!0;var n,i,o;if(""===e.basicData.causalCI&&(delete e.basicData.causalCI,delete e.basicData.causalCIreconId),""===e.basicData.impactedService&&(delete e.basicData.impactedService,delete e.basicData.impactedServiceReconId),(e.type===EntityVO.TYPE_INCIDENT||e.type===EntityVO.TYPE_WORKORDER)&&e.basicData.customer){var r=k.getFieldByName("site");r&&"widget"!==r.dataType&&e.basicData.customer.site&&(delete e.basicData.customer.site.siteId,delete e.basicData.customer.site.address,k.getFieldByName("region")||delete e.basicData.customer.site.region,k.getFieldByName("siteGroup")||delete e.basicData.customer.site.siteGroup)}if(e.type===EntityVO.TYPE_INCIDENT)n=c.collectValues(e.basicData.allCategories,e.basicData,null,!0),e.basicData.categorizations=n.categorizations,e.basicData.resCategorizations=n.resCategorizations,a&&a.updateCategories?(e.basicData.categorizations=a.categorizations,i=_.cloneDeep(e.basicData),delete i.accessMappings,i.customer.accessMappings&&delete i.customer.accessMappings,i.contact&&i.contact.accessMappings&&delete i.contact.accessMappings):(i=_.cloneDeep(e.basicData),delete i.accessMappings,i.customer.accessMappings&&delete i.customer.accessMappings,i.contact&&i.contact.accessMappings&&delete i.contact.accessMappings),i.customFields.hasOwnProperty("reportedSource")&&null===i.customFields.reportedSource&&delete i.customFields.reportedSource;else if(e.type===EntityVO.TYPE_WORKORDER)n=c.collectValues(e.basicData.allCategories,e.basicData,null,!0),e.basicData.categorizations=n.categorizations,o=e.basicData,o.customer.accessMappings&&delete o.customer.accessMappings,i={id:o.id,displayId:o.displayId,summary:o.summary,customer:o.customer,desc:o.desc,status:o.status,categorizations:o.categorizations,type:EntityVO.TYPE_WORKORDER},o.priority&&(i.priority=o.priority),o.location&&o.location.poiId&&(i.location={poiId:o.location.poiId}),o.locationCompany&&(i.locationCompany=o.locationCompany),o.contact&&o.contact.id&&(i.contact=o.contact),o.impactedService&&(i.impactedService=o.impactedService),o.scheduledStartDate&&(i.scheduledStartDate=moment(o.scheduledStartDate).valueOf()),o.scheduledEndDate&&(i.scheduledEndDate=moment(o.scheduledEndDate).valueOf()),o.actualStartDate&&(i.actualStartDate=moment(o.actualStartDate).valueOf()),o.actualEndDate&&(i.actualEndDate=moment(o.actualEndDate).valueOf()),o.supportGroup&&(i.supportGroup=o.supportGroup),o.assignee&&(i.assignee=o.assignee),o.managerGroup&&(i.managerGroup=o.managerGroup),o.manager&&(i.manager=o.manager),o.templateId&&(i.templateId=o.templateId),o.templateName&&(i.templateName=o.templateName),null!==o.woAutomationStatus&&void 0!==o.woAutomationStatus&&""!==o.woAutomationStatus&&(i.woAutomationStatus=o.woAutomationStatus),o.attachments&&(i.attachments=o.attachments),_.size(o.customFields)&&(i.customFields=o.customFields),o.dynamicFields&&(i.dynamicFields=o.dynamicFields);else if(e.type===EntityVO.TYPE_SERVICEREQUEST){if(i={},!e.basicData.isAttributeHidden.requiredDate&&e.basicData.requiredDate&&(t.timezone?(i.requiredDate=L.convertToUserPreferenceTimezone(e.basicData.requiredDate,t.timezone),i.requiredDate=moment(i.requiredDate).valueOf()):i.requiredDate=moment(e.basicData.requiredDate).valueOf(),i.requiredDate<moment().valueOf()))return u.error({text:m.getLocalizedString("create.ticket.invalid.requiredDate"),clear:!1}),void(e.state.dataIsLoading=!1);i.displayId=e.basicData.displayId,i.id=e.basicData.id,i.summary=e.basicData.summary,i.desc=e.basicData.desc,i.requestTemplateTitle=e.basicData.requestTemplateTitle,i.requestTemplateId=e.basicData.requestTemplateId,i.customer={loginId:e.basicData.customer.loginId},i.contact=e.basicData.contact?{loginId:e.basicData.contact.loginId}:{loginId:e.basicData.customer.loginId},e.basicData.isAttributeHidden.quantity||(i.quantity=e.basicData.quantity),i.questionResponses=[],_.forEach(e.basicData.questionDefinitions,function(t){if(t.visibility||t.isHidden){var a;if(t.isHidden&&t.parentId){var n=_.find(e.basicData.questionDefinitions,{id:t.parentId}),o=re(n,t,!1);if(!o)return t}if("CHECK_BOXES"===t.format&&t.answer)angular.isArray(t.answer)&&(a=t.answer.join(";"));else if("CHECK_BOXES"!==t.format&&"STATIC_MENU"!==t.format&&"QUERY_MENU"!==t.format&&"RADIO_BUTTONS"!==t.format||t.answer)"DATE_TIME"===t.format||"DATE_ONLY"===t.format||"TIME_ONLY"===t.format?a=t.answer?ae(t.answer):null:(a=t.answer,t.isHidden&&!a&&(a=t.defaultValue));else{var r=[];_.forEach(t.options,function(e){e.isDefault&&r.push(e.value)}),a=r.join(";")}i.questionResponses.push({questionId:t.id,value:a,order:t.sortOrder})}})}else e.type===EntityVO.TYPE_PROBLEM?(n=c.collectValues(e.basicData.allCategories,e.basicData),e.basicData.categorizations=n.categorizations,e.basicData.rootCause=e.basicData.rootCause?e.basicData.rootCause:null,e.basicData.impact=e.basicData.impact?e.basicData.impact:_.last(e.metadata.impacts).name,e.basicData.urgency=e.basicData.urgency?e.basicData.urgency:_.last(e.metadata.urgencies).name,e.basicData.investigationDriver=e.basicData.investigationDriver?e.basicData.investigationDriver:_.head(e.metadata.investigationDrivers).name,i=_.cloneDeep(e.basicData),delete i.accessMappings):e.type===EntityVO.TYPE_KNOWNERROR&&(n=c.collectValues(e.basicData.allCategories,e.basicData),e.basicData.categorizations=n.categorizations,e.basicData.rootCause=e.basicData.rootCause?e.basicData.rootCause:null,i=_.cloneDeep(e.basicData),delete i.accessMappings);return i},e.cancelNotification=function(){e.currentState=a.current,a.go(Ee.name,_.isEmpty(Ee.params)?"":Ee.params)},e.cancelCopyChange=function(){a.go("change",{id:a.params.copyChangeId})},e.saveResource=function(t){var n=_.find(O.cache[e.basicData.id],function(e){return e.id===t.id});if(void 0===n)if(O.markRelationForAdd(e.basicData.id,t),t.relationshipType===EntityVO.TYPE_DUPLICATEOF){e.state.dataIsLoading=!0;var i,o,s;_.isEmpty(k.getValueByFieldName("priority"))||(i=k.getValueByFieldName("priority").impact.name,o=k.getValueByFieldName("priority").urgency.name,s=k.getValueByFieldName("priority").priority.name);var l={customerLoginId:e.basicData.customer.id,desc:k.getValueByFieldName("desc").desc,summary:k.getValueByFieldName("summary"),impact:i,urgency:o,priority:s};e.isDraft&&e.basicData&&(l.displayId=e.basicData.displayId,l.id=e.basicData.id);var c=k.getValueByFieldName("impactedService");c.ci&&(l.impactedService=c.ci.name,l.serviceCIReconId=c.ci.reconciliationId),e.basicData.type===EntityVO.TYPE_INCIDENT&&(l.createData=e.getCreateData()),r.applyAction(t.id,EntityVO.TYPE_INCIDENT,EntityVO.ACTION_DUPLICATE,l).then(function(t){_.isEmpty(t)||(e.dirty=!1,l=t[0].items[0],e.state.dataIsLoading=!1,a.go(EntityVO.TYPE_INCIDENT,{id:l.id}))})["catch"](function(t){e.state.dataIsLoading=!1,e.basicData.accessMappings.detailsEditAllowed=!0})}else t.resourceToResolve&&(e.basicData.status={value:"Resolved",reason:"No Further Action Required"},e.basicData.resolution=t.title,e.basicData.summary||(e.basicData.summary=e.basicData.desc.substring(0,100)),e.saveDraft())},e.unrelateResource=function(t){O.markRelationForDelete(e.basicData.id,t)},e.initProfile=function(){return e.isCopyChange=a.params.isCopyChange,l.smartRecorderData||Te||a.params.isCopyChange?(N(),e.initEvents(),e.isCopyChange?ie():e.initDetails(),void(Te&&delete r.cache.draft)):void a.go("smartRecorder")},e.hasCustomFields=function(e){var t=E.getPanelById(e);return t&&t.hasCustomFields()},e.editDisabledFor=function(t){return e.activeEditableSectionId&&e.activeEditableSectionId!==t},e.initEvents=function(){e.$on(y.TOGGLE_EDIT_MODE,Z),e.$on(y.EDIT_COMPLETE,X),e.$on(y.SAVE_TO_TICKET_FROM_RS,j),e.$on(y.REMOVE_FROM_TICKET_FROM_RS,W),e.$on(y.RESOLVE_TICKET_FROM_RS,Q),e.$on(y.MARK_AS_DUPLICATE_OF_FROM_RS,J),e.$on(y.DRAFT_TICKET_RESOURCE_RELATED,function(t,a){for(var n=0;n<a.length;n++)e.saveResource(a[n])}),e.$on(y.DRAFT_TICKET_RESOURCE_UNRELATED,W),e.$on(y.SHOW_ASSIGN_TICKET_BLADE,ne),e.$on(y.WORKNOTE_REQUIRED,function(t,a){e.isNoteRequired=a.isRequired})},e.initDetails=function(){function t(a,n,i){i++,_.each(_.filter(e.basicData.questionDefinitions,{parentId:n}),function(e){e.level=i,a.children.push(e),e.visibility=re(a,e,!0),se(a,e)&&a.hasAnswer?e.hasAnswer=oe(e.answer):e.hasAnswer=!1,t(e,e.id,i)})}e.dirty=!0,h(function(){ve&&u.error({text:ve,hide:1e4}),e.draftNotificationInstance=u.warning({text:S("i18n")("ticket.notification.draft.message"),hide:1e4}),e.draftNotificationInstance.result["finally"](function(){e.draftNotificationInstance=null})},500),te(),l.smartRecorderData&&l.smartRecorderData.desc&&(l.smartRecorderData.desc=l.smartRecorderData.desc.replace(/\u00a0/g," "));var a=_.isEmpty(e.template)?null:e.template.id;if(a&&e.template.templateObject.isCrossLaunchRequest)return e.basicData.customer=l.smartRecorderData.customer,e.basicData.company={name:l.smartRecorderData.customer.company.name},_.isEmpty(l.smartRecorderData.contact)||(e.basicData.contact=l.smartRecorderData.contact),e.basicData.desc=l.smartRecorderData.desc,e.isCrossLaunchRequest=!0,e.state.dataIsLoading=!1,e.basicData.id="draft",void T.launchAIF(!0,!0,e,e.template.name,e.template.templateObject.crossLaunchURL,e.basicData.customer.id,e.basicData.contact?e.basicData.contact.id:null);
var i=l.smartRecorderData.customer&&l.smartRecorderData.customer.company&&l.smartRecorderData.customer.company.name,d=r.getDraft(e.type,a,l.smartRecorderData.desc,i,null,l.smartRecorderData.customer).then(function(t){e.itemId=t.id,r.cache[e.itemId]=angular.copy(t),Se&&delete r.cache.relatedDraft}),f=s.getMetadataByType(e.type).then(function(t){e.metadata=t||{}}),g=s.getMetadataByType(EntityVO.TYPE_GLOBAL).then(function(t){e.globalMetadata=t||{},ye=e.globalMetadata.configurationParameters.affectedServiceRelation}),C=b.loadScreenLayout(fe).then(function(t){e.screenLayout=t}),A=n.resolve({});"request"!==e.type&&(A=E.isV2CompatibleScreen(fe)?E.loadScreenConfigurationByName(fe):E.loadScreenConfigurationAndCustomFieldLabels(fe,e.type));var D=[].concat([d,f,g,C,A]);e.type!==EntityVO.TYPE_SERVICEREQUEST&&D.push(E.loadScreenConfigurationByName(fe)),n.all(D).then(function(){var n;if(e.basicData=r.cache[e.itemId]?angular.copy(r.cache[e.itemId]):{},e.basicData.isFullVersion=e.isFullVersion,e.basicData.isDraft=!0,e.type===EntityVO.TYPE_INCIDENT){var i=l.smartRecorderData.customer?l.smartRecorderData.customer.company.name:e.basicData.company.name;l.smartRecorderData&&l.smartRecorderData.template&&l.smartRecorderData.template.name&&(e.basicData.templateName=l.smartRecorderData.template.name),_.isEmpty(i)&&"true"===o.isSrcLiveChat&&(i=e.basicData.customer&&e.basicData.customer.company&&e.basicData.customer.company.name),r.getIncidentRules(i).then(function(t){e.basicData.serviceCIRequired="true"==t.serviceCIRequired,e.basicData.CIRequiredOnResolved="true"==t.CIRequiredOnResolved,e.basicData.serviceCIRequired?e.$broadcast(y.SERVICECI_REQUIRED,{isRequired:!0,name:"impactedService"}):e.$broadcast(y.SERVICECI_REQUIRED,{isRequired:!1,name:"impactedService"}),t.applyCognitiveForSupportGroup&&(e.basicData.applyCognitiveForSupportGroup=t.applyCognitiveForSupportGroup,e.$broadcast(y.APPLY_COGNITIVE_SG,{applyCognitive:t.applyCognitiveForSupportGroup}))})}if(e.type!==EntityVO.TYPE_WORKORDER&&(O.cache[e.itemId]=[]),_.isEmpty(l.smartRecorderData.status)||(e.basicData.status=l.smartRecorderData.status),_.isEmpty(l.smartRecorderData.resolution)||(e.basicData.resolution=l.smartRecorderData.resolution),_.isEmpty(l.smartRecorderData.assignee)||(e.basicData.assignee=l.smartRecorderData.assignee),_.isEmpty(l.smartRecorderData.customer)||(e.basicData.customer=l.smartRecorderData.customer,e.basicData.company={name:l.smartRecorderData.customer.company.name}),_.isEmpty(e.basicData.customer)||k.getFieldByName("locationCompany")||(e.basicData.locationCompany={name:e.basicData.customer.company.name}),_.isEmpty(l.smartRecorderData.contact)||(e.basicData.contact=l.smartRecorderData.contact),l.smartRecorderData.desc){var s=e.basicData.desc?e.basicData.desc+" ":"";e.basicData.desc=l.smartRecorderData.desc,s.trim()&&(e.basicData.desc+="\n"+s),e.basicData.desc.trim(),e.type!==EntityVO.TYPE_PROBLEM||e.basicData.summary||(e.basicData.summary=l.smartRecorderData.desc.substring(0,100))}if(_.isEmpty(e.basicData.company)&&(Se||"true"===o.isSrcLiveChat)){var d=e.basicData.customer&&e.basicData.customer.company&&e.basicData.customer.company.name||Ce&&Ce.fromContext&&Ce.fromContext.company&&Ce.fromContext.company.name;e.basicData.company={name:d}}if(e.type===EntityVO.TYPE_INCIDENT||e.type===EntityVO.TYPE_PROBLEM||e.type===EntityVO.TYPE_KNOWNERROR){var u;if(e.type===EntityVO.TYPE_INCIDENT&&(u=E.getFieldByName(fe,"priority")),!e.basicData.priority&&(e.type===EntityVO.TYPE_INCIDENT&&u&&u.isWidget()||e.type===EntityVO.TYPE_PROBLEM||e.type===EntityVO.TYPE_KNOWNERROR)){if(l.smartRecorderData.impact&&l.smartRecorderData.urgency){var f=_.find(e.metadata.impacts,{index:+l.smartRecorderData.impact}),g=_.find(e.metadata.urgencies,{index:+l.smartRecorderData.urgency});e.basicData.impact=f&&f.name||_.last(e.metadata.impacts).name,e.basicData.urgency=g&&g.name||_.last(e.metadata.urgencies).name}else e.basicData.impact=_.last(e.metadata.impacts).name,e.basicData.urgency=_.last(e.metadata.urgencies).name;r.getPriority(e.basicData.company.name,e.basicData.impact,e.basicData.urgency,e.type).then(function(t){e.basicData.priority=t})}}if(e.type===EntityVO.TYPE_WORKORDER)if(e.basicData.priority||(e.basicData.priority=_.last(e.metadata.priorities).name),a)O.getRelations(e.itemId,e.type).then(function(){if(!_.isEmpty(l.smartRecorderData.causalCI)){var t=l.smartRecorderData.causalCI;e.saveResource({id:t.reconciliationId,type:EntityVO.TYPE_ASSET,tag:EntityVO.TYPE_LINKEDITEM,desc:t.name,relationshipType:EntityVO.TYPE_RELATEDTO,parentId:e.itemId,displayId:e.basicData.displayId,realObject:{name:t.name,assetType:t.assetType,classId:t.classId,status:t.status,reconciliationId:t.reconciliationId,manufacturer:t.manufacturer,model:t.product.model}})}});else if(!_.isEmpty(l.smartRecorderData.causalCI)){O.cache[e.itemId]=[];var h=l.smartRecorderData.causalCI;e.saveResource({id:h.reconciliationId,type:EntityVO.TYPE_ASSET,tag:EntityVO.TYPE_LINKEDITEM,desc:h.name,relationshipType:EntityVO.TYPE_RELATEDTO,parentId:e.itemId,displayId:e.basicData.displayId,realObject:{name:h.name,assetType:h.assetType,classId:h.classId,status:h.status,reconciliationId:h.reconciliationId,manufacturer:h.manufacturer,model:h.product.model}})}if(e.type===EntityVO.TYPE_PROBLEM&&(p.userFullData.availableForAssignment?e.availableForAssignment=p.userFullData.availableForAssignment:p.getFullCurrentUserData().then(function(){e.availableForAssignment=p.userFullData.availableForAssignment}),l.smartRecorderData.investigationDriver?e.basicData.investigationDriver=l.smartRecorderData.investigationDriver:e.basicData.investigationDriver=e.basicData.investigationDriver?e.basicData.investigationDriver:_.head(e.metadata.investigationDrivers).name,l.smartRecorderData.resolution&&(e.basicData.resolution=l.smartRecorderData.resolution)),e.type===EntityVO.TYPE_INCIDENT&&(l.smartRecorderData.template&&l.smartRecorderData.template.templateObject?e.basicData.serviceType=l.smartRecorderData.template.templateObject.serviceType:e.basicData.serviceType||(e.basicData.serviceType=e.metadata.types[0].name)),e.type===EntityVO.TYPE_INCIDENT||e.type===EntityVO.TYPE_WORKORDER||e.type===EntityVO.TYPE_PROBLEM||e.type===EntityVO.TYPE_KNOWNERROR){if(e.basicData.status.value||(e.basicData.status.value=e.metadata.statuses[0].name),e.type===EntityVO.TYPE_WORKORDER||_.isEmpty(l.smartRecorderData.causalCI)||(e.basicData.causalCI={},e.basicData.causalCI.name=l.smartRecorderData.causalCI.name,e.basicData.causalCI.reconciliationId=l.smartRecorderData.causalCI.reconciliationId,e.basicData.causalCI.classId=l.smartRecorderData.causalCI.classId,e.basicData.resCategorizations=_.map(e.basicData.resCategorizations,function(e){var t=_.find(l.smartRecorderData.causalCI.product.categorizations,function(t){return"product"===t.name&&"resolutionProduct"===e.name});return t&&t.tiers&&(e.tiers.resProductCategoryTier1=t.tiers.productCategoryTier1,e.tiers.resProductCategoryTier2=t.tiers.productCategoryTier2,e.tiers.resProductCategoryTier3=t.tiers.productCategoryTier3,e.tiers.resProductName=t.tiers.productName,e.tiers.resProductModelVersion=t.tiers.productModelVersion),e})),n=e.basicData.categorizations,!_.isEmpty(l.smartRecorderData.impactedService)){e.basicData.impactedService={},e.basicData.impactedService.name=l.smartRecorderData.impactedService.name,e.basicData.impactedService.reconciliationId=l.smartRecorderData.impactedService.reconciliationId,e.basicData.impactedService.classId=l.smartRecorderData.impactedService.classId;var T=_.find(n,{name:"product"});null!==T&&(T.company=l.smartRecorderData.impactedService.company,T.tiers=_.head(l.smartRecorderData.impactedService.product.categorizations).tiers,T.cognitiveFlag=!1)}_.isEmpty(l.smartRecorderData.relatedAsset)||_.forEach(l.smartRecorderData.relatedAsset,function(t){e.saveResource({id:t.reconciliationId,type:EntityVO.TYPE_ASSET,tag:EntityVO.TYPE_LINKEDITEM,desc:t.name,relationshipType:EntityVO.TYPE_RELATEDTO,parentId:e.itemId,displayId:e.basicData.displayId,realObject:{name:t.name,assetType:t.assetType,classId:t.classId,status:t.status,reconciliationId:t.reconciliationId,manufacturer:t.manufacturer,model:t.product.model}})}),e.basicData.resCategorizations&&e.basicData.isClosed()?n=e.basicData.categorizations.concat(e.basicData.resCategorizations):e.basicData.type===EntityVO.TYPE_INCIDENT&&(e.basicData.categorizations.push(_.find(e.basicData.resCategorizations,{name:"resolutionProduct"})),e.basicData.categorizations.push(_.find(e.basicData.resCategorizations,{name:"resolution"})),n=e.basicData.categorizations),e.basicData.allCategories=c.populateCategories(n,e.metadata),_.forEach(e.basicData.allCategories,function(e){e.dirty=!0}),e.basicData.noCategories=_.filter(e.basicData.allCategories,"valueToShow").length,e.activeSection="resources"}else if(e.type===EntityVO.TYPE_SERVICEREQUEST){if(e.template&&e.template.templateObject){var S=(new Date).getTime(),C="TURN_AROUND_TIME_UNITS_DAYS"===e.template.templateObject.turnaroundTimeUnits?"days":"hours",A=moment(S).add(e.template.templateObject.turnaroundTime,C);e.basicData.expectedDate=moment(A).toDate()}e.servReqRequiredDatePicker={open:!1},e.servReqDatePickerOptions={startingDay:I.getWeekStartingDay(),"show-weeks":!1,minDate:moment().year(1970).month(0).date(1),maxDate:moment().year(2038).month(0).date(18)},e.basicData.requiredDate="",e.openDatePicker=function(e){e.open=!0},0===e.basicData.questionDefinitions.length&&(e.numOfRequiredFieldMissing=0,e.answerIsValid=!0,e.numOfRequiredAnswerMissing=0),e.basicData.isAttributeHidden.quantity||(e.basicData.quantity=1);var b=_.filter(l.smartRecorderData.confirmedItems,{relationship:"mentioned"});if(!I.showNameInSmartRecorderCreateTicket&&b.length){var D=1===b.length?m.getLocalizedString("createNew.ticket.mentionedPerson"):m.getLocalizedString("createNew.ticket.mentionedPersons"),R=[];_.forEach(b,function(e){R.push(e.displayName)}),e.basicData.desc+=" "+R.join(", ")+" "+D}_.forEach(e.basicData.questionDefinitions,function(t){if(e.basicData.questionResponses){t.prepopulate=!0;var a=e.basicData.questionResponses;_.forEach(a,function(e){if(e.questionId===t.id)return"CHECK_BOXES"===t.format?e.value?t.answer=e.value.split(";"):t.answer=[]:"STATIC_MENU"===t.format||"QUERY_MENU"===t.format||"RADIO_BUTTONS"===t.format?(t.answer=e.value,t.answerLabel=e.displayValue):"RANGE_CHOICE"===t.format?t.answer=parseInt(e.value,10):t.answer=e.value,!1}),"CHECK_BOXES"!==t.format||t.answer||(t.answer=[])}else"CHECK_BOXES"===t.format?(t.answer=[],_.forEach(t.options,function(e){e.isDefault&&t.answer.push(e.value)})):"STATIC_MENU"===t.format||"QUERY_MENU"===t.format||"RADIO_BUTTONS"===t.format?_.forEach(t.options,function(e){e.isDefault&&(t.answer=e.value,t.answerLabel=e.label)}):t.answer=t.defaultValue;t.parentId=null,t.conditionValues="",t.children=[],t.visibility=!0,t.validate=!1,"TEXT"===t.format&&(!t.maxLineCount||t.maxLineCount<1)&&(t.maxLineCount=1),0===t.maxLength&&(t.maxLength=null)}),_.each(e.basicData.conditionalQuestions,function(t){_.each(e.basicData.questionDefinitions,function(e){t.questionnaireId===e.questionnaireId&&(e.parentId||(e.parentId=t.parentQuestionId),e.conditionValues+=e.conditionValues.length?";"+t.questionConditionValues:t.questionConditionValues)})}),_.each(_.filter(e.basicData.questionDefinitions,{parentId:null}),function(e){e.level=0,e.hasAnswer=oe(e.answer),e.isHidden&&(e.visibility=!1),t(e,e.id,e.level)}),le(e.basicData.questionDefinitions),v.processDynamicQuestions(e.basicData.requestTemplateId,e.basicData.questionDefinitions)}e.relationCache=O.cache[e.itemId],e.$watchCollection("relationCache",function(){ue()},!0),_.isEmpty(l.smartRecorderData.confirmedResourceList)||e.type===EntityVO.TYPE_SERVICEREQUEST||(e.type===EntityVO.TYPE_WORKORDER?_.each(_.filter(l.smartRecorderData.confirmedResourceList,{type:EntityVO.TYPE_KNOWLEDGE}),function(t){O.markRelationForAdd(e.basicData.id,t)}):O.markRelationForAdd(e.basicData.id,l.smartRecorderData.confirmedResourceList))})["finally"](function(){e.state.dataIsLoading=!1,e.displayProfileSupportPanel=!0,r.cache[e.basicData.id]=angular.copy(e.basicData)})},e.countInvalidFields=function(){var t=0;return e.formIsValid=!0,_.forEach(e.forms,function(a){a&&a.$error.required&&(t+=a.layoutForm&&a.layoutForm.$error.required?a.layoutForm.$error.required.length:a.$error.required.length),a&&!a.$valid&&(e.formIsValid=!1)}),t},window.addEventListener("beforeunload",function(e){e&&pe()}),e.initProfile();var _e=e.$on("$stateChangeSuccess",function(e,t,a,n,i){Ee.name=n.name,i&&(Ee.params=i)});e.$on("$destroy",function(){_e()})}])}(),function(){angular.module("myitsmApp").directive("editCustomerCard",["createTicketModel","events","searchModel",function(e,t,a){return{restrict:"E",scope:{ticket:"=",metadata:"=",update:"&"},replace:!0,templateUrl:"views/ticket/edit-customer-card.html",link:function(n){function i(){n.personInfo=[],n.editMode=!1}n.showAddContact=!1,n.state={},n.selections={},n.selected={},n.removePerson=function(e){n.personInfo=_.reject(n.personInfo,{type:e}),"contact"===e&&(n.showAddContact=!0)},n.addPerson=function(){n.showAddContact=!1,n.personDropdown=!0},n.getListPersonsByCompany=function(t){return e.getPersonsByCompany(t,n.company.name||n.company).then(function(e){return e.items})},n.getList=function(t,a){return e.getList(t,a)},n.clearPerson=function(e){e.data=""},n.updateCustomer=function(e){n.personInfo.unshift({type:"customer",data:_.cloneDeep(e)}),n.company=e.company,n.selected.site={name:e.site.name,id:e.site.siteId,attributeMap:{companyName:e.site.companyName,siteAddress:e.site.address,regionName:e.site.region,siteGroupName:e.site.siteGroup}}},n.validateCustomer=function(){n.personInfo[0]&&"customer"===n.personInfo[0].type||(n.customer.data="")},n.updateContact=function(e){n.personDropdown=!1,n.personInfo.push({type:"contact",data:_.cloneDeep(e)})},n.save=function(){n.update({data:n.personInfo}).then(function(){n.$emit(t.SAVE_CHANGES_COMPLETE)},function(){n.$emit(t.SAVE_CHANGES_FAULT)})},n.isCustomerRequired=function(){return"incident"!==n.ticket.type||"Infrastructure Event"!==n.ticket.serviceType};var o=function(){n.editMode=!0,n.personDropdown=!1,n.company=n.ticket.company||n.ticket.customer.company,n.personInfo=n.ticket.customer.loginId?[{type:"customer",data:_.cloneDeep(n.ticket.customer)}]:[],n.ticket.customer.site&&(n.selected.site={name:n.ticket.customer.site.name,id:n.ticket.customer.site.siteId,attributeMap:{companyName:n.ticket.customer.company.name,siteAddress:n.ticket.customer.site.address,regionName:n.ticket.customer.site.region,siteGroupName:n.ticket.customer.site.siteGroup}}),n.ticket.contact.loginId?n.personInfo.push({type:"contact",data:_.cloneDeep(n.ticket.contact)}):n.showAddContact=!0};n.$watchCollection("personInfo",function(){n.personInfo&&n.personInfo[0]&&"customer"===n.personInfo[0].type?n.customer=n.personInfo[0]:n.customer={data:""}}),n.$watch("company",function(e){e&&n.loadRegions()}),n.$watch("selected.region",function(e){e?(n.selected.siteGroup&&n.selected.siteGroup.attributeMap.regionName!==e.name&&(n.selected.siteGroup=null),n.selected.site&&n.selected.site.attributeMap.regionName!==e.name&&(n.selected.site=null)):(n.selected.siteGroup=null,n.selected.site=null),n.editMode&&n.loadSiteGroups()}),n.$watch("selected.siteGroup",function(e){e?(n.selected.region={name:e.attributeMap.regionName},n.selected.site&&n.selected.site.attributeMap.siteGroupName!==e.name&&(n.selected.site=null)):n.selected.site=null,n.editMode&&n.loadSites()}),n.$watch("selected.site",function(e){e&&(n.selected.siteGroup={name:e.attributeMap.siteGroupName,attributeMap:{regionName:e.attributeMap.regionName}},n.personInfo[0].data.site={name:e.name,siteId:e.id,address:e.attributeMap.siteAddress,region:e.attributeMap.regionName,siteGroup:e.attributeMap.siteGroupName,companyName:e.attributeMap.companyName})}),n.loadRegions=function(){n.selections.regions=null,n.state.regionsLoading=!0,e.getList(EntityVO.TYPE_REGION,{companyName:n.company.name}).then(function(e){n.state.regionsLoading=!1,n.selections.regions=e.objects})},n.loadSiteGroups=function(){n.selections.siteGroups=null,n.state.siteGroupsLoading=!0;var t={companyName:n.company.name};n.selected.region&&(t.regionName=n.selected.region.name),e.getList(EntityVO.TYPE_SITE_GROUP,t).then(function(e){n.state.siteGroupsLoading=!1,n.selections.siteGroups=e.objects})},n.loadSites=function(){n.selections.sites=null,n.state.sitesLoading=!0;var t={companyName:n.company.name,chunkInfo:{startIndex:0,chunkSize:a.siteChunkSize}};n.selected.region&&(t.regionName=n.selected.region.name),n.selected.siteGroup&&(t.siteGroupName=n.selected.siteGroup.name),e.getList(EntityVO.TYPE_SITE,t).then(function(e){n.state.sitesLoading=!1,n.selections.sites=e.objects,n.state.tooManySites=e.exceedsChunkSize})},n.loadSitesByName=function(t){var i={companyName:n.company.name,chunkInfo:{startIndex:0,chunkSize:a.siteChunkSize}};return n.selected.region&&(i.regionName=n.selected.region.name),n.selected.siteGroup&&(i.siteGroupName=n.selected.siteGroup.name),e.getListOfSitesByName(i,t).then(function(e){return e.objects})};var r=function(){n.$emit(t.SAVE_CHANGES_REQUEST,null,!0),n.save(),i()};n.$on(t.TOGGLE_EDIT_MODE,o),n.$on(t.SAVE_CHANGES,r),n.$on(t.DISCARD_CHANGES,i)}}}])}(),function(){angular.module("myitsmApp").directive("editHeader",["events","ticketModel","systemAlertService","$filter","configurationModel",function(e,t,a,n,i){return{restrict:"EA",scope:{ticket:"=",metadata:"=",update:"&"},templateUrl:"views/ticket/edit-header.html",link:function(o){function r(){o.updatedInfo={summary:o.ticket.summary,priority:_.find(o.metadata.priorities,function(e){return e.name===o.ticket.priority})||{name:o.ticket.priority}},[EntityVO.TYPE_INCIDENT,EntityVO.TYPE_PROBLEM,EntityVO.TYPE_KNOWNERROR].indexOf(o.ticket.type)>=0&&(o.updatedInfo.impact=_.find(o.metadata.impacts,function(e){return e.name===o.ticket.impact}),o.updatedInfo.urgency=_.find(o.metadata.urgencies,function(e){return e.name===o.ticket.urgency})),[EntityVO.TYPE_PROBLEM,EntityVO.TYPE_KNOWNERROR].indexOf(o.ticket.type)>=0&&(o.updatedInfo.targetDate=o.ticket.targetDate)}o.disableSave=!0,o.datePickerOptions={startingDay:i.getWeekStartingDay(),"show-weeks":!1,minDate:moment().year(1970).month(0).date(2),maxDate:moment().year(2038).month(0).date(18)},o.showMeridian=window.showMeridian,o.initDate=o.ticket.targetDate||new Date,o.ticket.targetDate&&o.ticket.targetDate<(new Date).getTime()?o.minDate=o.ticket.targetDate:o.minDate=new Date,o.updatePriority=function(){[EntityVO.TYPE_INCIDENT,EntityVO.TYPE_PROBLEM,EntityVO.TYPE_KNOWNERROR].indexOf(o.ticket.type)>=0&&t.getPriority(o.ticket.company.name,o.updatedInfo.impact.name,o.updatedInfo.urgency.name,o.ticket.type).then(function(e){o.updatedInfo.priority=_.find(o.metadata.priorities,function(t){return t.name===e}),o.updatedInfo.priority||a.error({text:n("i18n")("ticket.calculationError.calculatedPriority"),clear:!1})}),o.disableSave=!1},o.isPriorityRequired=function(){return[EntityVO.TYPE_INCIDENT,EntityVO.TYPE_PROBLEM,EntityVO.TYPE_KNOWNERROR].indexOf(o.ticket.type)>=0},o.save=function(){o.update({data:o.updatedInfo})},o.cancel=function(){o.update(null),r()},o.showImpactField=function(){return[EntityVO.TYPE_INCIDENT,EntityVO.TYPE_PROBLEM,EntityVO.TYPE_KNOWNERROR].indexOf(o.ticket.type)!==-1},o.showPriorityField=function(){return[EntityVO.TYPE_WORKORDER,EntityVO.TYPE_TASK].indexOf(o.ticket.type)!==-1},o.onSummaryChange=function(){o.disableSave=!1,o.$emit(e.FIELD_FORM_IS_DIRTY)};var s=function(){o.save(),o.$emit(e.SAVE_CHANGES_COMPLETE)},l=function(){o.cancel()};r(),o.$on(e.SAVE_CHANGES,s),o.$on(e.DISCARD_CHANGES,l),o.$on(e.PROBLEM_UPDATE_TARGET_DATE_EVENT,function(e,t){o.updatedInfo.targetDate=t})}}}])}(),function(){angular.module("ticketModule").controller("EditStatusController",["$scope","$modalInstance","editStatusParams","ticketModel","metadataModel","categoriesService","$q","knowledgeArticleModel","systemAlertService","permissionModel","roles","searchModel","searchService","ticketService","fieldValidationModel","$filter","$state","i18nService","events","assetModel",function(e,t,a,n,i,o,r,s,l,c,d,u,p,m,f,g,h,y,E,v){function T(t,a,i){n.cache.draft={type:t},n.cache.relatedDraft={type:t,fromType:e.ticket.type,id:e.ticket.id,fromContext:e.ticket,relationship:i},h.go(a)}function S(){var e=l.modal({type:"info",title:g("i18n")("common.notification.dirty.title"),text:g("i18n")("create.knownerror.draft.problem"),buttons:[{text:g("i18n")("common.button.yes"),data:!0},{text:g("i18n")("common.button.no"),data:!1}]});return e.result}function C(e,t){return t=t?moment(t):moment(e),1e3*moment(e).set("hours",t.get("hours")).set("minutes",t.get("minutes")).format("X")}function O(){var t=C(e.ticket.scheduledStartDate,e.ticket.scheduledStartTime),a=C(e.ticket.scheduledEndDate,e.ticket.scheduledEndTime);e.fixScheduledDates=e.ticket&&"change"===e.ticket.type&&"Scheduled For Review"===V.status.name&&(t<e.ticket.earliestStartDate||a<e.ticket.earliestStartDate||a<t)}function A(){e.close()}function I(t){var a,n=e.ticket.customer?e.ticket.customer.company.name:e.ticket.company?e.ticket.company.name:"";return n||(n=e.ticket.selectedCompany),a={customerCompany:n},e.ticket.locationCompany&&e.ticket.locationCompany.name?a.locationCompany=e.ticket.locationCompany.name:(e.ticket.type===EntityVO.TYPE_TASK||e.ticket.type===EntityVO.TYPE_CHANGE)&&e.ticket.id&&e.ticket.company&&(a.locationCompany=e.ticket.company.name),t&&(a.role=t),u.getAssigneeSupportCompanies(a).then(function(t){M.tooManySupportCompanies=t.exceedsChunkSize,M.tooManyAssigneeCompanies=t.exceedsChunkSize,e.companies=_.cloneDeep(t.objects)})}function b(e,t,a,n,i,o){return u.getSupportOrganizationsByCompany(e,null,t,a,n,i,o).then(function(e){return t?M.tooManySupportOrganizations=e.exceedsChunkSize:M.tooManyAssigneeOrganizations=e.exceedsChunkSize,e.organizations})}function k(e,t,a,n,i,o,r){return u.getSupportGroupsForCompanyAndOrg(e.name,"All"===t.id?"":t.name,a,null,n,i,o,r).then(function(e){return a?M.tooManySupportGroups=e.exceedsChunkSize:M.tooManyAssigneeGroups=e.exceedsChunkSize,e.supportGroups})}var D,R,P,w=1===a.actionItems.length,L=a.actionItems[0].id,N=a.actionItems[0].type,M={processing:!0,updatingStatus:!1,loadingSupportPersons:!1,loadingSupportGroups:!1,loadingAssigneeGroups:!1,tooManySupportCompanies:!1,tooManyAssigneeCompanies:!1,tooManySupportOrganizations:!1,tooManyAssigneeOrganizations:!1,tooManySupportGroups:!1,tooManyAssigneeGroups:!1},V={status:{},statusReason:{},milestone:{},resolutionNote:"",worknote:"",manager:{},group:{},targetDate:"",isDisabled:!1,assignee:{},assigneeGroup:{}};e.isOptional={managerGroup:!1,manager:!1,targetDate:!1,coordinatorGroup:!1,coordinator:!1,assigneeGroup:!1,assignee:!1},e.companies=[],e.coordinatorCompany={},e.assigneeCompany={},e.coordinatorOrganizations=[],e.coordinatorOrganization={},e.assigneeOrganizations=[],e.assigneeOrganization={},e.showUpdateWarningForRequired=!1,e.showMeridian=window.showMeridian,w||(e.isOptional={managerGroup:!0,manager:!0,targetDate:!0,coordinatorGroup:!0,coordinator:!0,assigneeGroup:!0,assignee:!0},_.each(a.actionItems,function(t){switch(N){case EntityVO.TYPE_CHANGE:e.isOptional.manager&&t.changeManager&&""===t.changeManager.fullName&&(e.isOptional.manager=!1),e.isOptional.managerGroup&&t.changeManagerGroup&&""===t.changeManagerGroup.name&&(e.isOptional.managerGroup=!1),!e.showUpdateWarningForRequired&&(t.changeManager&&t.changeManager.fullName||t.changeManagerGroup&&t.changeManagerGroup.name)&&(e.showUpdateWarningForRequired=!0);break;case EntityVO.TYPE_PROBLEM:e.isOptional.targetDate&&""===t.targetDate&&(e.isOptional.targetDate=!1),e.isOptional.coordinator&&t.problemCoordinator&&""===t.problemCoordinator.fullName&&(e.isOptional.coordinator=!1),e.isOptional.coordinatorGroup&&t.problemCoordinatorGroup&&""===t.problemCoordinatorGroup.name&&(e.isOptional.coordinatorGroup=!1),e.isOptional.assignee&&t.assignee&&""===t.assignee.fullName&&(e.isOptional.assignee=!1),e.isOptional.assigneeGroup&&t.supportGroup&&""===t.supportGroup.name&&(e.isOptional.assigneeGroup=!1),!e.showUpdateWarningForRequired&&(t.problemCoordinator&&t.problemCoordinator.fullName||t.problemCoordinatorGroup&&t.problemCoordinatorGroup.name||t.assignee&&t.assignee.fullName||t.supportGroup&&t.supportGroup.name)&&(e.showUpdateWarningForRequired=!0)}})),e.state=M,e.selected=V,e.isReopen=a.isReopen,e.allowLocationCompany=N===EntityVO.TYPE_INCIDENT,e.isDraft=a.isDraft,e.needResolutionNote=function(){return N===EntityVO.TYPE_INCIDENT&&~[EntityVO.STATUS_CLOSED,EntityVO.STATUS_RESOLVED].indexOf(V.status.name.toLowerCase())},e.isSaveButtonDisabled=function(){return!!(e.needResolutionNote()&&""===V.resolutionNote||V.status.statusReasons&&_.isEmpty(V.statusReason)&&e.isFieldRequired("statusReason"))},e.checkStatusSwitcherIsDisabled=function(t,a){var n,i,o,r=["Pending","Cancelled","Closed","Rejected"];if(n="release"!==a?_.findIndex(e.availableStatuses,function(t){return t.index===e.selected.status.index}):_.findIndex(e.availableMilestoneStatuses,function(t){return t.index===e.selected.milestone.index}),n!==-1&&"release"!==a){if("prev"===t)return 0===n||r.indexOf(e.selected.status.name)>=0;if("next"===t)return("change"!==a||"Implementation In Progress"!==e.availableStatuses[n].name&&"Planning In Progress"!==e.availableStatuses[n].name)&&"problem"!==a&&"knownerror"!==a||!e.availableStatuses[n+1]||"Pending"!==e.availableStatuses[n+1].name&&"Cancelled"!==e.availableStatuses[n+1].name?(i=parseInt(n+1),o=e.availableStatuses[i]||{}):(i=parseInt(n+2),o=e.availableStatuses[i]||{}),"Completed"===e.selected.status.name&&"Closed"===o.name?r.indexOf(e.selected.status.name)>=0:r.indexOf(o.name)>=0||r.indexOf(e.selected.status.name)>=0}if(n!==-1&&"release"===a){if("prev"===t)return 0===n;if("next"===t&&(i=parseInt(n+1),void 0===e.availableMilestoneStatuses[i]))return!0}},e.switchState=function(t,a){var n,i,o,r={};n="release"!==a?_.findIndex(e.availableStatuses,function(t){return t.index===e.selected.status.index}):_.findIndex(e.availableMilestoneStatuses,function(t){return t.index===e.selected.milestone.index}),n!==-1&&("prev"===t?(i="change"!==a&&"problem"!==a||"Completed"!==e.availableStatuses[n].name?0!==n?parseInt(n-1):0:0!==n?parseInt(n-2):0,r="release"===a?e.availableMilestoneStatuses[i]||{}:e.availableStatuses[i]||{}):"next"===t&&(o=("change"!==a||"Implementation In Progress"!==e.availableStatuses[n].name&&"Planning In Progress"!==e.availableStatuses[n].name)&&"problem"!==a||!e.availableStatuses[n+1]||"Pending"!==e.availableStatuses[n+1].name?parseInt(n+1):parseInt(n+2),r="release"===a?e.availableMilestoneStatuses[o]||{}:e.availableStatuses[o]||{})),"release"!==a?e.changeStatus(r,a):(V.status={},e.changeMileStone(r,a))},e.changeMileStone=function(t,a,n){V.milestone=t,e.availableStatuses={},n&&(V.status={});var i=[];_.forEach(R,function(e){e.milestone===t.name&&i.push(e)}),e.availableStatuses=_.filter(P.statuses,function(e){return _.findIndex(i,{status:e.name})!==-1})},e.changeStatus=function(t,a){V.status=t,V.statusReason={},e.ticket.status.value=t.name,e.showDates=e.isFieldRequired("scheduledStartDate")||e.isFieldRequired("actualStartDate"),e.isFieldRequired("manager")&&D.manager&&!D.manager.loginId?e.noChangeManagerLoginId=!0:e.noChangeManagerLoginId=!1,e.fixScheduledDates="change"===a&&"Scheduled For Review"===V.status.name&&(e.ticket.scheduledStartDate&&e.ticket.scheduledStartDate.valueOf()<e.ticket.earliestStartDate||e.ticket.scheduledEndDate&&e.ticket.scheduledEndDate.valueOf()<e.ticket.earliestStartDate),a&&"change"===a&&"Completed"===e.ticket.status.value&&(V.statusReason=_.find(t.statusReasons,{name:"Final Review Required"})),e.editStatusForm.$dirty=!0},e.$watch("ticket.scheduledStartDate",function(){e.ticket&&"change"===e.ticket.type&&"Scheduled For Review"===V.status.name&&e.ticket.scheduledStartDate&&O()}),e.$watch("ticket.scheduledEndDate",function(){e.ticket&&"change"===e.ticket.type&&"Scheduled For Review"===V.status.name&&e.ticket.scheduledStartTime&&O()}),e.$watch("ticket.scheduledStartTime",function(){e.ticket&&"change"===e.ticket.type&&"Scheduled For Review"===V.status.name&&e.ticket.scheduledEndDate&&O()}),e.$watch("ticket.scheduledEndTime",function(){e.ticket&&"change"===e.ticket.type&&"Scheduled For Review"===V.status.name&&e.ticket.scheduledEndTime&&O()}),e.changeStatusReason=function(t){V.statusReason=t,e.editStatusForm.$dirty=!0},e.updateGroup=function(t){V.group=t,e.state.loadingSupportPersons=!0;var a="";return e.ticket.type===EntityVO.TYPE_CHANGE?a="role=changemanager":e.ticket.type===EntityVO.TYPE_PROBLEM&&(a="role=problemcoordinator"),e.editStatusForm.$dirty=!0,m.getGroupMembers(t.id,a).then(function(t){e.state.loadingSupportPersons=!1,e.supportGroupPersons=t.results,e.updateManager(null)})},e.updateManager=function(t){V.manager=t,e.editStatusForm.$dirty=!0},e.updateAssigneeGroup=function(t){return V.assigneeGroup=t,e.state.loadingAssignees=!0,e.editStatusForm.$dirty=!0,m.getGroupMembers(t.id,"").then(function(t){e.state.loadingAssignees=!1,e.assignees=t.results,e.updateAssignee(null)})},e.updateAssignee=function(t){V.assignee=t,e.editStatusForm.$dirty=!0},e.isFieldRequired=function(t){return"statusReason"===t?e.ticket.type===EntityVO.TYPE_INCIDENT||e.ticket.type===EntityVO.TYPE_CHANGE||e.ticket.type===EntityVO.TYPE_RELEASE||e.ticket.type===EntityVO.TYPE_PROBLEM||e.ticket.type===EntityVO.TYPE_TASK||e.ticket.type===EntityVO.TYPE_KNOWNERROR?f.isFieldRequired(e.ticket.type,e.ticket.status.value,e.ticket.timing,t):e.ticket.type!==EntityVO.TYPE_WORKORDER&&e.ticket.type!==EntityVO.TYPE_ACTIVITY:f.isFieldRequired(e.ticket.type,e.ticket.status.value,e.ticket.timing,t)&&!f.isFieldRequired(e.ticket.type,D.status.value,e.ticket.timing,t)},e.close=function(){if(e.editStatusForm.$dirty){var a=l.modal({title:y.getLocalizedString("common.notification.dirty.title"),text:y.getLocalizedString("common.notification.dirty.message"),buttons:[{text:y.getLocalizedString("common.labels.yes"),data:!0},{text:y.getLocalizedString("common.labels.no"),data:!1}]});a.result.then(function(e){e&&t.dismiss()})}else t.dismiss()},e.submit=function(){M.updatingStatus=!0;var i,s,l;i=_.map(a.actionItems,function(e){return{uuid:e.id,type:e.type}}),s={status:V.status.name,statuslabel:V.status.label},_.isEmpty(V.statusReason)||(s.statusReason=V.statusReason.name),_.isEmpty(V.milestone)||(s.milestone=V.milestone.name),V.resolutionNote&&(s.resNote=V.resolutionNote);var c=o.collectValues(e.resCategories,e.ticket).resCategorizations;c&&c.length&&(s.resCategorizations=c);var d=o.collectValues(e.categories,e.ticket).categorizations;if(d&&d.length&&(s.categorizations=d),V.worknote&&(s.worknote=V.worknote),e.ticket.type===EntityVO.TYPE_CHANGE){if(e.showDates){var u=null===D.scheduledStartDate?0:D.scheduledStartDate.valueOf(),p=null===D.scheduledEndDate?0:D.scheduledEndDate.valueOf(),m=null===D.actualStartDate?0:D.actualStartDate.valueOf(),f=null===D.actualEndDate?0:D.actualEndDate.valueOf(),g=null===D.targetDate?0:D.targetDate.valueOf();null!==e.ticket.scheduledStartDate&&u!==e.ticket.scheduledStartDate.valueOf()&&(s.scheduledStartDate=moment(e.ticket.scheduledStartDate).valueOf()),null!==e.ticket.scheduledEndDate&&p!==e.ticket.scheduledEndDate.valueOf()&&(s.scheduledEndDate=moment(e.ticket.scheduledEndDate).valueOf()),null!==e.ticket.actualStartDate&&m!==e.ticket.actualStartDate.valueOf()&&(s.actualStartDate=moment(e.ticket.actualStartDate).valueOf()),null!==e.ticket.actualEndDate&&f!==e.ticket.actualEndDate.valueOf()&&(s.actualEndDate=moment(e.ticket.actualEndDate).valueOf()),null!==e.ticket.targetDate&&g!==e.ticket.targetDate.valueOf()&&(s.targetDate=moment(e.ticket.targetDate).valueOf())}e.isFieldRequired("managerGroup")&&(V.manager.loginId!==D.manager.loginId&&(s.managerLoginId=V.manager.loginId,s.managerFullName=V.manager.fullName),V.group.name!==D.managerGroup.name&&(s.managerGroup=V.group.name,s.managerOrganization=V.group.organization,s.managerCompany=V.group.company&&V.group.company.name))}else e.ticket.type===EntityVO.TYPE_PROBLEM?(V.targetDate&&(s.targetDate=moment(V.targetDate).valueOf()),
s.coordinatorLoginId=V.manager?V.manager.loginId:void 0,s.coordinatorFullName=V.manager?V.manager.fullName:void 0,s.coordinatorGroupId=V.group?V.group.id:void 0,s.coordinatorGroup=V.group?V.group.name:void 0,s.coordinatorOrganization=V.group?V.group.organization:void 0,s.coordinatorCompany=V.group&&V.group.company?V.group.company.name:void 0,s.group=V.assigneeGroup?V.assigneeGroup.name:void 0,s.groupId=V.assigneeGroup?V.assigneeGroup.id:void 0,s.organization=V.assigneeGroup?V.assigneeGroup.organization:void 0,s.company=V.assigneeGroup&&V.assigneeGroup.company?V.assigneeGroup.company.name:void 0,V.assignee&&(s.fullName=V.assignee.fullName,s.loginId=V.assignee.loginId)):e.ticket.type===EntityVO.TYPE_INCIDENT&&(s.modifyAllFlag="Yes");var h=_.cloneDeep(s);return a.isReopen&&(delete h.status,delete h.statuslabel,delete h.resNote),l=a.isDraft?r.when:n.updateStatus,l(i,h,e.ticket.type).then(function(n){a.isDraft||_.isEmpty(n)||(s.updatedTickets=n),e.ticket.type===EntityVO.TYPE_PROBLEM&&"Completed"===s.status&&"Known Error"===s.statusReason&&(e.ticket.hasInitiatesRelation?S().then(function(e){e&&T(EntityVO.TYPE_KNOWNERROR,"draftKnownerror",RelationItemVO.TYPE_INITIATEDBY)}):T(EntityVO.TYPE_KNOWNERROR,"draftKnownerror",RelationItemVO.TYPE_INITIATEDBY)),t.close(s)})["catch"](function(e){e&&e.data&&e.data.error?t.dismiss(e.data.error):t.dismiss()})["finally"](function(){M.updatingStatus=!1})},e.$on(E.MODAL_BACKDROP_CLICK,A);var F;F=N===EntityVO.TYPE_KNOWLEDGE?s.getKnowledgeArticleById(L,!1,!0):e.isDraft?r.when(a.actionItems[0]):n.getTicket(L,N);var x;x=N===EntityVO.TYPE_CHANGE||N===EntityVO.TYPE_RELEASE||N===EntityVO.TYPE_PROBLEM||N===EntityVO.TYPE_KNOWNERROR?n.getAvailableStatuses(L,N):r.when(1),e.getSupportGroupsForAllCompanyByName=function(t,a){var n=null,i=null,o="";n=e.ticket.customer?e.ticket.customer.company.name:e.ticket.company?e.ticket.company.name:"",i=(e.ticket.type===EntityVO.TYPE_TASK||e.ticket.type===EntityVO.TYPE_CHANGE)&&e.ticket.id&&e.ticket.company?e.ticket.company.name:e.ticket.location?e.ticket.location.companyName:null,"supportGroup"===a?(e.state.loadingSupportGroups=!0,o=e.coordinatorOrganization&&e.coordinatorOrganization.name||""):"assigneeGroup"===a&&(e.state.loadingAssigneeGroups=!0,o=e.assigneeOrganization&&e.assigneeOrganization.name||"");var r=u.getAssigneeSupportGroupsForCompanyAndOrgByName("",o,t,null,n,i);return r.then(function(t){return e.state.loadingSupportGroups=!1,e.state.loadingAssigneeGroups=!1,{list:t.supportGroups,exceedsChunkSize:t.exceedsChunkSize}})},r.all([i.getMetadataByType(N),F,x]).then(function(t){D=t[1];var n,i=t[0],r=t[2],s={schedule:0,actual:0};if(!D.isInApproval||N!==EntityVO.TYPE_CHANGE&&N!==EntityVO.TYPE_RELEASE?V.status=w||N===EntityVO.TYPE_CHANGE?_.find(i.statuses,{name:a.actionItems[0].status&&a.actionItems[0].status.value||D.status.value}):{}:(V.status=w||N===EntityVO.TYPE_CHANGE?_.find(i.statuses,{name:"Cancelled"}):{},V.isDisabled=!1,w&&N===EntityVO.TYPE_RELEASE&&(r=_.find(r,{status:"Cancelled"}))),V.milestone=w?_.find(i.milestones,{name:D.milestone}):{},V.statusReason=_.isEmpty(V.status)?{}:_.find(V.status.statusReasons,{name:a.actionItems[0].status&&a.actionItems[0].status.reason||D.status.reason}),V.statusReason=_.isEmpty(V.statusReason)||w||N!==EntityVO.TYPE_CHANGE?V.statusReason:{},V.resolutionNote=(a.actionItems[0].resolutionNote||D.resolution)&&w?a.actionItems[0].resolutionNote||D.resolution:"",w||N!==EntityVO.TYPE_CHANGE)e.isChangeScheduleDatesRequired=!0,e.isChangeActualDatesRequired=!0;else{for(e.showChangeUpdateWarning=!0,e.isChangeScheduleDatesRequired=!1,e.isChangeActualDatesRequired=!1,n=0;n<a.actionItems.length;n++)e.isChangeScheduleDatesRequired||""!==a.actionItems[n].scheduledEndDate&&""!==a.actionItems[n].scheduledStartDate||(e.isChangeScheduleDatesRequired=!0),e.isChangeActualDatesRequired||""!==a.actionItems[n].actualEndDate&&""!==a.actionItems[n].actualStartDate||(e.isChangeActualDatesRequired=!0),""===a.actionItems[n].scheduledEndDate&&""===a.actionItems[n].scheduledStartDate&&s.schedule++,""===a.actionItems[n].actualEndDate&&""===a.actionItems[n].actualStartDate&&s.actual++;s.schedule!==a.actionItems.length&&s.actual!==a.actionItems.length||(e.showChangeUpdateWarning=!1)}if(N===EntityVO.TYPE_WORKORDER&&a.isDraft?e.availableStatuses=_.reject(i.statuses,{isValidForCreate:!1}):V.status&&V.status.invalidStatusTransitions&&V.status.invalidStatusTransitions.length?e.availableStatuses=_.filter(i.statuses,function(e){return!~_.indexOf(V.status.invalidStatusTransitions,e.name)}):V.status&&V.status.validKnowledgeTransitions?V.status.validKnowledgeTransitions.length?e.availableStatuses=_.filter(i.statuses,function(e){return _.find(V.status.validKnowledgeTransitions,{validStatus:e.name})}):e.availableStatuses=[]:N!==EntityVO.TYPE_CHANGE&&(N!==EntityVO.TYPE_PROBLEM&&N!==EntityVO.TYPE_KNOWNERROR||a.isDraft)?N!==EntityVO.TYPE_RELEASE||a.isDraft?N===EntityVO.TYPE_PROBLEM&&a.isDraft?e.availableStatuses=_.reject(i.statuses,{isValidForCreate:!1}):e.availableStatuses=i.statuses:(R=r,P=i,e.availableMilestoneStatuses=_.filter(i.milestones,function(e){return _.findIndex(r,{milestone:e.name})!==-1}),e.changeMileStone(V.milestone,"release")):e.availableStatuses=_.filter(i.statuses,function(e){return r.indexOf(e.name)!==-1}),e.ticket=angular.copy(D),D.resCategorizations&&(e.resCategories=angular.copy(o.populateCategories(D.resCategorizations,i))),D.categorizations){var l=_.filter(D.categorizations,function(e){return"resolutionProduct"!==e.name&&"resolution"!==e.name});e.categories=angular.copy(o.populateCategories(l,i))}if(M.processing=!1,N===EntityVO.TYPE_CHANGE)w?(V.manager=D.manager,V.group=D.managerGroup,m.getGroupMembers(V.group.id,"role=changemanager").then(function(t){e.supportGroupPersons=t.results})):(e.ticket.scheduledStartDate=null,e.ticket.scheduledEndDate=null,e.ticket.actualStartDate=null,e.ticket.actualEndDate=null),p.getSupportGroupsList({companyName:e.ticket.company.name,organization:e.selected.group&&e.selected.group.organization||"",role:"changemanager"}).then(function(t){e.coordinatorSupportGroups=t.supportGroups}),e.isFieldRequired("manager")&&D.manager&&!D.manager?e.noChangeManagerLoginId=!0:e.noChangeManagerLoginId=!1;else if(N===EntityVO.TYPE_PROBLEM){w?(V.manager=_.isEmpty(D.coordinator)||!D.coordinator.id?null:D.coordinator,V.targetDate=_.isUndefined(D.targetDate)?null:D.targetDate,V.assignee=_.isEmpty(D.assignee)||!D.assignee.id?null:D.assignee,!_.isEmpty(D.coordinatorGroup)&&D.coordinatorGroup.name?(V.group=D.coordinatorGroup,m.getGroupMembers(V.group.id,"role=problemcoordinator").then(function(t){e.supportGroupPersons=t.results})):V.group=null,!_.isEmpty(D.supportGroup)&&D.supportGroup.name?(V.assigneeGroup=D.supportGroup,m.getGroupMembers(V.assigneeGroup.id,"").then(function(t){e.assignees=t.results})):V.assigneeGroup=null):(V.targetDate=null,V.manager=null,V.assignee=null,V.group=null,V.assigneeGroup=null);var c=(e.ticket.customer?e.ticket.customer.company.name:e.ticket.company?e.ticket.company.name:"",e.ticket.location?e.ticket.location.companyName:null);I("problemcoordinator").then(function(){e.coordinatorCompany=D.coordinatorGroup.company,e.assigneeCompany=D.assignee.company;var t={name:D.coordinatorGroup.organization},a={name:D.supportGroup.organization};b(e.coordinatorCompany.name,"problemcoordinator",null,c,null,null).then(function(t){e.coordinatorOrganizations=t,e.coordinatorOrganization={name:D.coordinatorGroup.organization}}),b(e.assigneeCompany.name,null,null,c,null,null).then(function(t){e.assigneeOrganizations=t,e.assigneeOrganization={name:D.supportGroup.organization}}),k(e.coordinatorCompany,t,"",null,c,null,null).then(function(t){e.coordinatorSupportGroups=t}),k(e.assigneeCompany,a,"",null,c,null,null).then(function(t){e.assigneeGroups=t})})}}),e.getCompaniesByName=function(e){return u.getCompaniesByText(e).then(function(e){return e.companies})},e.getSupportOrganizationsByTextAndCompany=function(t,a){var n;return"coordinatorCompany"===a?n=e.coordinatorCompany&&e.coordinatorCompany.name||"":"assigneeCompany"===a&&(n=e.assigneeCompany&&e.assigneeCompany.name||""),u.getSupportOrganizationsByTextAndCompany(t,n).then(function(e){return"coordinatorCompany"===a?M.tooManySupportOrganizations=e.exceedsChunkSize:"assigneeCompany"===a&&(M.tooManyAssigneeOrganizations=e.exceedsChunkSize),e.organizations})},e.selectCoordinatorCompany=function(t){e.coordinatorCompany=t;var a=e.ticket.location?e.ticket.location.companyName:null;b(t.name,"problemcoordinator",null,a,null,null).then(function(t){e.coordinatorOrganizations=t})},e.selectAssigneeCompany=function(t){var a=e.ticket.location?e.ticket.location.companyName:null;e.assigneeCompany=t,b(t.name,null,null,a,null,null).then(function(t){e.assigneeOrganizations=t})},e.selectCoordinatorOrganization=function(t){var a=e.ticket.location?e.ticket.location.companyName:null;e.coordinatorOrganization=t,k(e.coordinatorCompany,t,"",null,a,null,null).then(function(t){e.coordinatorSupportGroups=t})},e.selectAssigneeOrganization=function(t){var a=e.ticket.location?e.ticket.location.companyName:null;e.assigneeOrganization=t,k(e.assigneeCompany,t,"",null,a,null,null).then(function(t){e.assigneeGroups=t})}}])}(),function(){angular.module("ticketModule").controller("ExtDraftTicketController",["$state","$stateParams","localStorageService","pwaModel","ticketModel","smartRecorderModel",function(e,t,a,n,i,o){function r(a){if(a&&a.data&&a.data.eventData&&"TICKET_DATA"===a.data.eventType)if(t.draftType){var i=!1;n.isPwaEnabledPromise().then(function(e){i=!!e})["finally"](function(){s(i,t.draftType,a.data.eventData)})}else e.go("smartRecorder")}function s(t,a,i){var r,s={isSrcExt:"true",crossLaunchContext:"CHANGE"};if(a===EntityVO.TYPE_PROBLEM){var l=new SmartRecorderVO;l.desc=i.desc,l.impact=i.impact,l.urgency=i.urgency,l.investigationDriver=i.investigationDriver,l.confirmedResourceList=i.relatedList,l.type=i.type,l.resolution=i.resolution,t?(n.smartRecorderData=l,r="pwaDraftProblem"):(o.smartRecorderData=l,o.saveState=!1,r="draftProblem")}e.go(r,s)}var l={eventType:"DRAFT_WINDOW_READY"};window.onmessage=r,window.opener&&window.opener.postMessage(l,"*")}])}(),IncidentVO.prototype=new TicketVO,IncidentVO.prototype.constructor=IncidentVO,IncidentVO.prototype.getProps=function(){return TicketVO.prototype.getProps().concat("resolvedDate","resCategorizations","impactedService","causalCI","impact","urgency","reopenedDate","resolution","templateId","serviceType","brokerVendorName","needsAttention","vendorTicketNumber","templateName")},KnownErrorVO.prototype=new TicketVO,KnownErrorVO.prototype.constructor=KnownErrorVO,KnownErrorVO.prototype.getProps=function(){return TicketVO.prototype.getProps().concat("type","crossLaunchURL","coordinator","coordinatorGroup","causalCI","viewAccess","rootCause","workaround","searchable","impactedService","resolution","impact","priority","urgency","targetDate","brokerVendorName")},KnownErrorVO.prototype.postBuild=function(){TicketVO.prototype.postBuild.call(this),this.targetDateHumanized=this.targetDate?moment(new Date(this.targetDate)).format("lll"):null},function(){angular.module("ticketModule").controller("LinkCIController",["$scope","$modalInstance","linkParams","ticketModel","configurationModel","events","$q","i18nService","$state","systemAlertService","relationModel","$rootScope",function(e,t,a,n,i,o,r,s,l,c,d,u){function p(){var t=[],a=[];return _.forEach(e.data.searches,function(e){e.allQueryItemsRelation&&e.allQueryItemsRelation.length>0&&(a=a.concat(e.allQueryItemsRelation)),_.forEach(e.results,function(a){_.forEach(a.relations,function(n){e.allQueryItemsRelation&&e.allQueryItemsRelation.length>0&&_.find(e.allQueryItemsRelation,{relationshipType:n})||t.push({relationshipType:n,tag:EntityVO.TYPE_LINKEDITEM,id:a.reconciliationId,type:EntityVO.TYPE_ASSET,desc:a.name})})})}),{linkedCIs:t,bulkCIsLinked:a}}function m(e,t){var a=t.searchCriteria;return a.chunkInfo.startIndex+=a.chunkInfo.chunkSize,t.matchesCount>=a.chunkInfo.startIndex?d.relateBulkCI(e,t,a).then(function(){return m(e,t)}):r.when(1)}function f(){e.$on("$stateChangeStart",function(t,a,n){if(e.linkedCount>0&&a.name!==g.type){t.preventDefault();var i=c.modal({title:s.getLocalizedString("common.notification.dirty.title"),text:s.getLocalizedString("common.notification.dirty.message"),buttons:[{text:s.getLocalizedString("common.labels.yes"),data:{stateName:a.name,stateParams:n}},{text:s.getLocalizedString("common.labels.no")}]});i.result.then(function(t){_.isEmpty(t)||(e.linkedCount=0,e.$dismiss(),l.transitionTo(t.stateName,t.stateParams))})}else e.$dismiss()})}e.company=a.selectedItem.company,e.data={searches:a.searches||[]},e.linkedCount=0,e.state={processing:!1};var g=n.linkCIsParent;g?(e.parentName=g.type,e.parentId=g.id,e.parentDisplayId=g.displayId):l.go("dashboard"),f(),e.$on(o.LINKED_COUNT,function(t,a){e.linkedCount=0;var n=[];_.forEach(a,function(t){if(t.results&&t.results.length>0){for(var a=t.results,i=0;i<a.length;i++)a[i].relations&&a[i].relations.length>0&&(t.allQueryItemsRelation&&t.allQueryItemsRelation.length>0||e.linkedCount++,n.indexOf(a[i].instanceId)<0&&n.push(a[i].instanceId));t.allQueryItemsRelation&&t.allQueryItemsRelation.length>0&&(e.linkedCount+=t.totalMatchCount)}})}),e.hasNotRelatedCIs=function(){return!(e.linkedCount>0)||(e.data.searches||[]).some(function(e){return e.selectedCount>0&&e.selectedCount>e.linkedCount})},e.startLinkProcess=function(){var t=p(),a=t.linkedCIs,n=t.bulkCIsLinked;return a.length>=80||n&&n.length>0?c.modal({type:"info",title:s.getLocalizedString("create.change.wizard.ci.confirmCIRelation.title"),text:s.getLocalizedString("create.change.wizard.ci.confirmCIRelation.text"),buttons:[{text:s.getLocalizedString("common.button.continue"),data:!0},{text:s.getLocalizedString("common.button.returnToScreen"),data:!1}]}).result.then(function(t){if(t)return e.link()}):e.link()},e.link=function(){var s=p(),l=s.linkedCIs,f=s.bulkCIsLinked,g=[],h=!1;if(l.length>0){h=!0;var y=d.addRelation({uuid:a.selectedItem.id,type:EntityVO.TYPE_CHANGE},l,h);g.push(y)}if(f.length>0&&_.forEach(f,function(e){var t={id:a.selectedItem.id,type:EntityVO.TYPE_CHANGE};if(e.matchesCount>100){var n=e.searchCriteria;n.chunkInfo={startIndex:0,chunkSize:50};var i=d.relateBulkCI(t,e,n).then(function(){return m(t,e)});g.push(i)}}),g.length>0){e.state.processing=!0;var E,v=r.all(g);f.length>0||e.linkedCount>=80?t.close({linkedItems:s,relationPromise:v,linkedCount:e.linkedCount}):v.then(function(e){var t=e[0]&&e[0][a.selectedItem&&a.selectedItem.id]&&e[0][a.selectedItem&&a.selectedItem.id].status;h&&t.type&&t.message&&(E=t)})["catch"](function(e){return c.error({text:e.data&&e.data.error?e.data.error:e.data.results.error?e.data.results.error:e.defaultMessage,clear:!1}),r.reject(e)})["finally"](function(){u.$broadcast(o.LINKED_CI_SAVE_COMPLETE),i.showARMessageOnGetEntry&&n.getARMessageInformation(a.selectedItem.id,EntityVO.TYPE_CHANGE),t.close({linkedItems:s,linkedCount:e.linkedCount,status:E}),e.state.processing=!1})}}}])}(),function(){angular.module("ticketModule").controller("LinkController",["$scope","$modalInstance","linkParams","configurationModel","searchService","ticketModel","relationModel","$q","metadataModel","searchModel","assetService","authService","roles","systemAlertService","i18nService","events","$filter",function(e,t,a,n,i,o,r,s,l,c,d,u,p,m,f,g,h){function y(e){var t=O[e];return e!==EntityVO.TYPE_CHANGE||a.linkFromTicketConsole||(t=_.reject(t,{type:EntityVO.TYPE_ASSET})),n.isServerApplicationEnabled(EntityVO.TYPE_ASSET)||(t=_.reject(t,{type:EntityVO.TYPE_ASSET})),n.isServerApplicationEnabled(EntityVO.TYPE_WORKORDER)&&u.isAuthorized(p.ITSM_AGENT_ROLE)||(t=_.reject(t,{type:EntityVO.TYPE_WORKORDER})),n.isServerApplicationEnabled(EntityVO.TYPE_CHANGE)&&u.isAuthorized(p.ITSM_CHANGE_USER_ROLE)||(t=_.reject(t,{type:EntityVO.TYPE_CHANGE})),n.isServerApplicationEnabled(EntityVO.TYPE_RELEASE)&&u.isAuthorized(p.ITSM_RELEASE_USER_ROLE)||(t=_.reject(t,{type:EntityVO.TYPE_RELEASE})),n.isServerApplicationEnabled(EntityVO.TYPE_INCIDENT)&&u.isAuthorized(p.ITSM_AGENT_ROLE)||(t=_.reject(t,{type:EntityVO.TYPE_INCIDENT})),n.isServerApplicationEnabled(EntityVO.TYPE_PROBLEM)&&u.isAuthorized(p.ITSM_PROBLEM_USER_ROLE)||(t=_.reject(t,{type:EntityVO.TYPE_PROBLEM})),n.isServerApplicationEnabled(EntityVO.TYPE_KNOWNERROR)&&u.isAuthorized(p.ITSM_PROBLEM_USER_ROLE)||(t=_.reject(t,{type:EntityVO.TYPE_KNOWNERROR})),t}function E(){e.close()}var v,T,S=a.selectedItems[0].ticketType?a.selectedItems[0].ticketType:a.selectedItems[0].type,C=1===a.selectedItems.length,O=n.get("link"),A={linkOption:{}},I={searching:!1,processing:!1,isDirty:!1},b=function(){_.forEach(A.entities,function(e){e.isSelected=!1}),A.entities=[]};e.state=I,e.selected=A,e.linkOptions=angular.copy(_.sortBy(y(S),"type")),e.availableEntities=null,e.selected.advancedFilters=[],e.searchConfig=angular.copy(n.get("outage.searchFilter")),e.ticketType=S;var k=_.keyBy(e.searchConfig,"label");if(_.each(e.linkOptions,function(e){e.relations=e.relations?e.relations.sort():[]}),s.all([l.getMetadataByType(EntityVO.TYPE_GLOBAL),l.getMetadataByType(EntityVO.TYPE_OUTAGE)]).then(function(t){v=t[0];var n=t[1];0===k.unavailabilityStatus.options.length&&_.forEach(n.statuses,function(t){var n=!1;("Latent"===a.selectedItems[0].timing&&"Restored"===t.name||"Latent"!==a.selectedItems[0].timing&&"Scheduled"===t.name)&&(n=!0),k.unavailabilityStatus.options.push({name:t.label,type:"dynamic",criteria:{name:"unavailabilityStatus",value:[t.name]},active:n}),n===!0&&e.selected.advancedFilters.push({name:t.label,type:"dynamic",criteria:{name:"unavailabilityStatus",value:[t.name]},active:n})}),0===k.unavailabilityType.options.length&&_.forEach(n.types,function(e){k.unavailabilityType.options.push({name:e.label,type:"dynamic",criteria:{name:"unavailabilityType",value:[e.name]}})}),0!==k.ciName.options.length&&_.forEach(k.ciName.options,function(t){t.active===!0&&e.selected.advancedFilters.push({name:t.label,type:"constant",criteria:{name:"relatedCI",value:[t.name]},active:t.active})})}),S===EntityVO.TYPE_CHANGE&&(e.$watch(function(){var t=_.find(e.selected.advancedFilters,{criteria:{name:"relatedCI"}}),a=_.find(e.selected.advancedFilters,{criteria:{name:"name"}});return{relatedCI:t,keywords:a}},function(t,a){var n,i=a.keywords,o=t.keywords,r=a.relatedCI,s=t.relatedCI;if(o&&!i){n=_.find(e.searchConfig,{name:"name"})||{};var l=_.find(n.options,{name:"relatedCI"})||{};l.active=!1;var c=e.selected.advancedFilters.indexOf(s);e.selected.advancedFilters.splice(c,1)}else s&&!r&&(n=_.find(e.searchConfig,{name:"name"})||{},_.each(n.options,function(e){e.criteria&&"name"===e.criteria.name&&(e.active=!1)}),e.selected.advancedFilters=_.reject(e.selected.advancedFilters,{criteria:{name:"name"}}))},!0),e.searchCIsByKeyword=function(e){return d.getListOfAssets(e).then(function(e){var t=[];try{t=e[0].items[0].objects}catch(a){console.log(a)}return t})}),e.selectLinkOption=function(t){I.isDirty=!0,A.linkOption=t,A.relation=1===A.linkOption.relations.length?t.relations[0]:"",A.searchText="",A.entities=[],e.availableEntities=null,[EntityVO.TYPE_OUTAGE].indexOf(t.type)>=0&&S===EntityVO.TYPE_CHANGE&&(I.searching=!0,c.getFilteredSuggestedOutagesList(R).then(function(t){t&&t.length>0&&(e.availableEntities=t,I.showSuggestedItemsTooltip=!0)})["finally"](function(){I.searching=!1}))},e.iconClass=function(e,t){return T="Security Incident"===e.serviceType?"icon-security-incident":"icon-"+t},e.searchEntities=function(){function t(t){var n=t.items.length>0?t.items[0].results:[];C&&S!==EntityVO.TYPE_ASSET&&S!==EntityVO.TYPE_KNOWLEDGE&&(A.linkOption.type===EntityVO.TYPE_ASSET?R.impactedService&&R.impactedService.reconciliationId&&(n=_.reject(n,{id:R.impactedService.reconciliationId})):n=_.reject(n,{id:a.selectedItems[0].id})),e.availableEntities=n}var n={},o={};if(!A.searchText)return!1;if(I.showSuggestedItemsTooltip&&(I.showSuggestedItemsTooltip=!1),I.searching=!0,A.entities=[],A.linkOption.type===EntityVO.TYPE_OUTAGE)return A.searchText&&(n.searchText=A.searchText),_.each(e.selected.advancedFilters,function(t){if("scheduledStartDates"===t.criteria.name){var a,i;t.criteria.value?(t.criteria.value.startDate?a=t.criteria.value.startDate:t.criteria.value.length&&t.criteria.value[0]&&t.criteria.value[0].start&&(a=t.criteria.value[0].start),t.criteria.value.endDate?i=t.criteria.value.endDate:t.criteria.value.length&&t.criteria.value[0]&&t.criteria.value[0].end&&(i=t.criteria.value[0].end)):(a=e.$eval(t.defaultValues.start,{moment:moment}),i=e.$eval(t.defaultValues.end,{moment:moment})),n.scheduledDate=[{start:a,end:i}]}else"unavailabilityStatus"===t.criteria.name?n.unavailabilityStatus?n.unavailabilityStatus.push(t.criteria.value[0]):n.unavailabilityStatus=[t.criteria.value[0]]:"unavailabilityType"===t.criteria.name?n.unavailabilityType?n.unavailabilityType.push(t.criteria.value[0]):n.unavailabilityType=[t.criteria.value[0]]:"relatedCI"===t.criteria.name?n.relatedCI=!0:"name"===t.criteria.name&&(n.ciNames?n.ciNames.push(t.criteria.value[0]):n.ciNames=[t.criteria.value[0]])}),c.getFilteredOutagesList(n,R).then(function(t){e.availableEntities=t})["finally"](function(){I.searching=!1});n={search_text:A.searchText,types:A.linkOption.type,chunk_index:0,chunk_size:50},A.linkOption.type===EntityVO.TYPE_ASSET&&(n.chunk_size=v.configurationParameters&&v.configurationParameters.assetSearchQueryLimit?v.configurationParameters.assetSearchQueryLimit:4),o={allowSpecialCharacters:!0},S===EntityVO.TYPE_KNOWLEDGE&&a.isDraft&&(n.suggest_search=!0);var r=[i.getGlobalSearchResults(n,o)];return l.cache[A.linkOption.type]||r.push(l.getMetadataByType(A.linkOption.type)),s.all(r).then(function(e){t(e[0])})["finally"](function(){I.searching=!1})},e.selectEntity=function(e){if(e.isSelected){if(A.relation===RelationItemVO.TYPE_DUPLICATEOF&&A.entities.length&&b(),e.type===EntityVO.TYPE_OUTAGE){var t=_.find(R.relations,{id:e.affectedAsset.reconciliationId});t||(e.affectedAsset.isRelatedToCR=!0)}A.entities.push(e)}else e.type===EntityVO.TYPE_OUTAGE&&e.affectedAsset.isRelatedToCR&&(e.affectedAsset.isRelatedToCR=!1),_.remove(A.entities,{id:e.id})},e.selectRelation=function(e){e===RelationItemVO.TYPE_DUPLICATEOF&&A.entities.length&&C&&(_.forEach(A.entities,function(e){e.isSelected=!1}),_.last(A.entities).isSelected=!0,_.remove(A.entities,{isSelected:!1})),e===RelationItemVO.TYPE_ORIGINALOF&&_.forEach(A.entities,function(e){e.additionalInformation.accessMappings.duplicateActionAllowed||(e.isSelected=!1)}),A.relation=e},e.isEntityDisabled=function(e){return A.relation===RelationItemVO.TYPE_ORIGINALOF&&!e.additionalInformation.accessMappings.duplicateActionAllowed},e.link=function(){var i=_.map(a.selectedItems,function(e){var t={};return t=S===EntityVO.TYPE_ASSET?{uuid:e.reconciliationId,type:e.ticketType}:{uuid:e.id,type:e.type}}),l={length:0},c=_.map(A.entities,function(e){var t,n={id:e.id,relationshipType:A.relation,tag:RelationItemVO.TAG_LINKEDITEM,type:A.linkOption.type,desc:e.title};return e.title||e.type!==EntityVO.TYPE_OUTAGE||(n.desc=e.desc),e.displayId&&(n.displayId=e.displayId),1===a.selectedItems.length&&a.selectedItems[0].displayId&&(n.parentDisplayId=a.selectedItems[0].displayId),(t=_.find(r.cache&&r.cache[i[0]&&i[0].uuid],function(t){if(t.id===e.id&&t.relationshipType===A.relation)return t}))?(l[e.id]=t,void l.length++):n}),d=a.isDraft?s.when:r.bulkAddRelation;c=_.without(c,void 0),l.length>0&&m.warning({text:h("i18n")("ticket.notification.alreadyExist.message",l.length),hide:1e4}),c.length&&(I.processing=!0,d(i,c).then(function(){var a=_.map(A.entities,function(e,t){var a=c[t];if(a)return e.type===EntityVO.TYPE_ASSET?(a.realObject={assignee:e.additionalInformation.assignee,priority:e.additionalInformation.priority,status:e.additionalInformation.status,assetType:e.additionalInformation.assetType,name:e.additionalInformation.name,manufacturer:e.additionalInformation.manufacturer,model:e.additionalInformation.product.model,reconciliationId:e.additionalInformation.reconciliationId,classId:e.additionalInformation.classId,title:e.title},a.displayId=e.displayId||""):(a.realObject=e,a.displayId=e.displayId||""),(new RelationItemVO).build(a)});a=_.without(a,void 0),t.close(a),e.$parent.$broadcast(g.RELATIONS_UPDATE_COMPLETE),n.showARMessageOnGetEntry&&i.length&&A.entities&&A.entities.length&&A.entities[0].type===EntityVO.TYPE_ASSET&&o.getARMessageInformation(i[0].uuid,i[0].type),I.processing=!1})["catch"](function(e){m.error({text:e.message?e.message:e.data.results.error,clear:!1}),t.dismiss()}))},C&&S!==EntityVO.TYPE_ASSET&&S!==EntityVO.TYPE_KNOWLEDGE){var D=a.selectedItems[0].id,R={};a.isDraft?(R=o.cache[D],R.relations=r.cache[D]):(I.processing=!0,s.all([o.getTicket(D,S),r.getRelations(D,S)]).then(function(t){if(R=angular.copy(t[0]),R.relations=t[1],S===EntityVO.TYPE_INCIDENT){var a=_.find(R.relations,{relationshipType:RelationItemVO.TYPE_ORIGINALOF});if(a&&a.relationshipType){var n=_.find(e.linkOptions,{type:S});n.relations=_.without(n.relations,RelationItemVO.TYPE_DUPLICATEOF)}}})["finally"](function(){I.processing=!1}))}1===e.linkOptions.length&&e.selectLinkOption(e.linkOptions[0]),e.close=function(){if(I.isDirty){var e=m.modal({title:f.getLocalizedString("common.notification.dirty.title"),text:f.getLocalizedString("common.notification.dirty.message"),buttons:[{text:f.getLocalizedString("common.labels.yes"),data:!0},{text:f.getLocalizedString("common.labels.no"),data:!1}]});e.result.then(function(e){e&&t.dismiss()})}else t.dismiss()},e.$on(g.MODAL_BACKDROP_CLICK,E)}])}(),OutageVO.prototype=new TicketVO,OutageVO.prototype.constructor=OutageVO,OutageVO.prototype.getProps=function(){return TicketVO.prototype.getProps().concat("type","scheduledEndDate","scheduledStartDate","actualStartDate","actualEndDate","affectedAsset","accessMappings")},OutageVO.prototype.postBuild=function(){if(this.outageTypeName=this.type,this.type=EntityVO.TYPE_OUTAGE,_.isEmpty(this.accessMappings))this.accessMappings={detailsEditAllowed:!0,statusEditAllowed:!0};else{for(var e={},t=0;t<this.accessMappings.length;t++)e[this.accessMappings[t].id+"EditAllowed"]="write"===this.accessMappings[t].permission;this.accessMappings=e}this.actualStartDateHumanized=this.actualStartDate?moment(this.actualStartDate).format("lll"):"",this.actualEndDateHumanized=this.actualEndDate?moment(this.actualEndDate).format("lll"):"",this.scheduledStartDateHumanized=this.scheduledStartDate?moment(this.scheduledStartDate).format("lll"):"",this.scheduledEndDateHumanized=this.scheduledEndDate?moment(this.scheduledEndDate).format("lll"):""},function(){angular.module("ticketModule").controller("PreviewTicketController",["$scope","$q","ticketModel","categoriesService","ticketActionService","followService","screenConfigurationModel","events","systemAlertService","srdModel","metadataModel","layoutConfigurationModel","$filter",function(e,t,a,n,i,o,r,s,l,c,d,u,p){e.init=function(i,o){function s(e,t){return t=t?moment(t):moment(e),1e3*moment(e).set("hours",t.get("hours")).set("minutes",t.get("minutes")).format("X")}e.itemId=i;var l={dataIsLoading:!0},c=r.getScreenNameByTicketType(o),m=a.getTicketForPreview(i,o),f=EntityVO.hasMetadata(o)?d.getMetadataByType(o):t.when({}),g=u.loadScreenLayout(c),h=r.loadScreenConfigurationAndCustomFieldLabels(c,o),y=[m,f,g,h];o!==EntityVO.TYPE_OUTAGE&&(e.isFullVersion=!1),e.isContactCollapsed=!0,t.all(y).then(function(t){var i=t[0],r=t[1];e.metadata=r,e.screenLayout=t[2];var l=i.categorizations;i.resCategorizations&&i.isClosed()?l=i.categorizations.concat(i.resCategorizations):i.type===EntityVO.TYPE_INCIDENT&&(i.categorizations.push(_.find(i.resCategorizations,{name:"resolutionProduct"})),i.categorizations.push(_.find(i.resCategorizations,{name:"resolution"})),l=i.categorizations),i.allCategories=n.populateCategories(l,r),i.noCategories=_.filter(i.allCategories,"valueToShow").length,i.priority||_.isEmpty(r.priorities)||(i.priority=_.last(r.priorities).name),e.isFullVersion||(o===EntityVO.TYPE_OUTAGE&&(i=_.cloneDeep(i)),i.accessMappings.detailsEditAllowed=!1,i.accessMappings.statusEditAllowed=!1,i.accessMappings.riskEditAllowed=!1,i.accessMappings.datesEditAllowed=!1,i.accessMappings.assignmentEditAllowed=!1),e.basicData=i,e.basicData.isFullVersion=e.isFullVersion,e.basicData.brokerVendorName&&a.getVendorInfo(e.basicData.displayId,e.basicData.type).then(function(t){e.basicData.vendorInfo=t}),e.basicData.type===EntityVO.TYPE_SERVICEREQUEST&&(e.basicData.expectedDate&&(e.basicData.expectedDate=s(e.basicData.expectedDate,e.basicData.expectedTime)),e.basicData.requiredDate&&(e.basicData.requiredDate=s(e.basicData.requiredDate,e.basicData.requiredTime)),_.forEach(e.basicData.questionResponses,function(e){if(e.value&&"DATE_TIME"===e.format){var t=new Date(1e3*e.value);e.displayValue=p("datePreConfigTimezone")(t,"mediumDate")+" "+p("datePreConfigTimezone")(t,"shortTime")}else e.value&&"DATE_ONLY"===e.format?e.displayValue=moment.utc(new Date(1e3*e.value)).format("ll"):e.value&&"TIME_ONLY"===e.format&&(e.displayValue=moment.utc(1e3*e.value).format("LT"))})),e.basicData.type===EntityVO.TYPE_SBEREQUEST&&_.forEach(e.basicData.answers,function(e){if(e.value&&"DATE_TIME_FIELD"===e.format){var t=new Date(1e3*e.value);e.displayValue=p("datePreConfigTimezone")(t,"mediumDate")+" "+p("datePreConfigTimezone")(t,"shortTime")}else e.value&&"DATE_FIELD"===e.format?e.displayValue=moment.utc(new Date(1e3*e.value)).format("ll"):e.value&&"TIME_FIELD"===e.format?e.displayValue=moment(e.displayValue,"hh:mm:ss").format("LT"):e.value&&"ATTACHMENT"===e.format&&_.forEach(e.additionalInfo,function(e){e.metadataFileNameEncoded=encodeURIComponent(e.metadataFileName)})})})["finally"](function(){l.dataIsLoading=!1}),e.openCrossLaunchURL=function(e){window.open(e)},e.state=l}}])}(),function(){angular.module("ticketModule").directive("previewIncident",[function(){return{restrict:"A",templateUrl:"views/ticket/incident-details-v2.html",scope:{},controller:"PreviewTicketController",link:function(e,t,a){a.$observe("previewIncident",function(t){e.init(t,EntityVO.TYPE_INCIDENT)})}}}]).directive("previewWorkOrder",[function(){return{restrict:"A",templateUrl:"views/ticket/workorder-details-v2.html",scope:{},controller:"PreviewTicketController",link:function(e,t,a){a.$observe("previewWorkOrder",function(t){e.init(t,EntityVO.TYPE_WORKORDER)})}}}]).directive("previewTask",[function(){return{restrict:"A",templateUrl:"views/ticket/task-details-v2.html",scope:{},controller:"PreviewTicketController",link:function(e,t,a){a.$observe("previewTask",function(t){e.init(t,EntityVO.TYPE_TASK)})}}}]).directive("previewServiceRequest",[function(){return{restrict:"A",templateUrl:"views/ticket/service-request-details.html",scope:{},controller:"PreviewTicketController",link:function(e,t,a){a.$observe("previewServiceRequest",function(t){e.init(t,EntityVO.TYPE_SERVICEREQUEST)})}}}]).directive("previewSbeRequest",[function(){return{restrict:"A",templateUrl:"views/ticket/sbe-request-details.html",scope:{},controller:"PreviewTicketController",link:function(e,t,a){a.$observe("previewSbeRequest",function(t){e.init(t,EntityVO.TYPE_SBEREQUEST)})}}}]).directive("previewChangeRequest",[function(){return{restrict:"A",templateUrl:"views/ticket/change-details-v2.html",scope:{},controller:"PreviewTicketController",link:function(e,t,a){a.$observe("previewChangeRequest",function(t){e.init(t,EntityVO.TYPE_CHANGE)})}}}]).directive("previewRelease",[function(){return{restrict:"A",templateUrl:"views/ticket/release-details.html",scope:{},controller:"PreviewTicketController",link:function(e,t,a){a.$observe("previewRelease",function(t){e.init(t,EntityVO.TYPE_RELEASE)})}}}]).directive("previewActivity",[function(){return{restrict:"A",templateUrl:"views/ticket/activity-details.html",scope:{},controller:"PreviewTicketController",link:function(e,t,a){a.$observe("previewActivity",function(t){e.init(t,EntityVO.TYPE_ACTIVITY)})}}}]).directive("previewProblem",[function(){return{restrict:"A",templateUrl:"views/ticket/problem-details.html",scope:{},controller:"PreviewTicketController",
link:function(e,t,a){a.$observe("previewProblem",function(t){e.init(t,EntityVO.TYPE_PROBLEM)})}}}]).directive("previewKnownError",[function(){return{restrict:"A",templateUrl:"views/ticket/known-error-details.html",scope:{},controller:"PreviewTicketController",link:function(e,t,a){a.$observe("previewKnownError",function(t){e.init(t,EntityVO.TYPE_KNOWNERROR)})}}}]).directive("previewTicketGeneric",["$compile",function(e){return{restrict:"E",template:"<div></div>",scope:{ticketType:"=",ticketId:"=",newTab:"=",context:"=?"},link:function(t,a){function n(e){var t;switch(e){case EntityVO.TYPE_INCIDENT:t="preview-incident";break;case EntityVO.TYPE_KNOWLEDGE:t="preview-knowledge-article";break;case EntityVO.TYPE_WORKORDER:t="preview-work-order";break;case EntityVO.TYPE_OUTAGE:t="preview-outage";break;case EntityVO.TYPE_KNOWNERROR:t="preview-known-error";break;case EntityVO.TYPE_PROBLEM:t="preview-problem"}return t}function i(i){var r="<div is-full-version=\"false\" class=\"resource-preview__container\" ng-class=\"{'resource-preview_incident': ticketType === 'incident', 'resource-preview_wo': ticketType === 'workorder'}\"></div>",s=n(i),l=angular.element(r);l.attr(s,"{{ticketId}}"),l.attr("ng-if","ticketType === '"+i+"'"),t.context&&t.context.type===EntityVO.TYPE_LIVE_CHAT&&l.attr("is-from-livechat",!0);var c=e(l)(t);a.append(c),o.push(i)}var o=[];t.$watch("ticketId",function(e){e&&o.indexOf(t.ticketType)===-1&&i(t.ticketType)})}}}])}(),ProblemVO.prototype=new TicketVO,ProblemVO.prototype.constructor=ProblemVO,ProblemVO.prototype.getProps=function(){return TicketVO.prototype.getProps().concat("completedDate","type","impact","urgency","crossLaunchURL","investigationDriver","location","rootCause","workaround","resolution","impactedAreas","impactedService","causalCI","targetDate","coordinator","coordinatorGroup","brokerVendorName")},ProblemVO.prototype.postBuild=function(){TicketVO.prototype.postBuild.call(this),this.targetDateHumanized=this.targetDate?moment(new Date(this.targetDate)).format("lll"):null},ReleaseVO.prototype=new TicketVO,ReleaseVO.prototype.constructor=ReleaseVO,ReleaseVO.prototype.getProps=function(){return TicketVO.prototype.getProps().concat("type","crossLaunchURL","impactedService","businessJustification","coordinator","coordinatorGroup","timing","timingReason","manager","completedDate","scheduledStartDate","scheduledEndDate","targetDate","riskIsUserSpecified","actualStartDate","actualEndDate","deploymentEndDate","deploymentStartDate","riskLevel","impact","urgency","managerGroup","location","questionResponses","impactedAreas","templateId","templateGuid","templateName","isInApproval","isPasswordEnabled","isAutomatic","taskPhaseId","previousStatus","approvalProcessName","milestone","priority","releaseType")},ReleaseVO.prototype.postBuild=function(){TicketVO.prototype.postBuild.call(this),this.scheduledStartDate=this.scheduledStartDate?new Date(this.scheduledStartDate):null,this.scheduledEndDate=this.scheduledEndDate?new Date(this.scheduledEndDate):null,this.actualStartDate=this.actualStartDate?new Date(this.actualStartDate):null,this.actualEndDate=this.actualEndDate?new Date(this.actualEndDate):null,this.targetDate=this.targetDate?new Date(this.targetDate):null,this.scheduledStartDateHumanized=this.scheduledStartDate?moment(this.scheduledStartDate).format("lll"):null,this.scheduledEndDateHumanized=this.scheduledEndDate?moment(this.scheduledEndDate).format("lll"):null,this.targetDateHumanized=this.targetDate?moment(this.targetDate).format("lll"):null,this.actualStartDateHumanized=this.actualStartDate?moment(this.actualStartDate).format("lll"):null,this.actualEndDateHumanized=this.actualEndDate?moment(this.actualEndDate).format("lll"):null},SbeRequestVO.prototype=Object.create(BaseVO.prototype),SbeRequestVO.prototype.constructor=SbeRequestVO,SbeRequestVO.prototype.getProps=function(){return BaseVO.prototype.getProps().concat("type","serviceName","orderId","serviceId","description","excerpt","status","quantity","paymentType","freeLabelText","currency","completedDate","onceCost","monthlyCost","yearlyCost","ticketType","requestedBy","requestedFor","canRequestAgain","orderTitle","modifiedDate","customFields","answers","isInApproval")},SbeRequestVO.prototype.postBuild=function(){this.accessMappings={detailsEditAllowed:!1,summaryEditAllowed:!1,statusEditAllowed:!1,timelineEditAllowed:!1,relationsEditAllowed:!1,priorityEditAllowed:!1,coordinatorEditAllowed:!1,tasksEditAllowed:!1,requestedforEditAllowed:!1,incidentTypeEditAllowed:!1},this.paymentType="FREE"===this.paymentType?" - ":this.paymentType},function(){angular.module("ticketModule").controller("ShareController",["$scope","$modalInstance","shareParams","ticketService","$location","$filter","userModel","openMailClientService","searchModel","urlCreatorService",function(e,t,a,n,i,o,r,s,l,c){function d(e){m.processing=!0,n.getPersonsBySupportGroupId(e.id,"","",l.supportPersonChunkSize).then(function(e){m.tooManySupportPeople=e.exceedsChunkSize,u(e.results)})["finally"](p)}function u(e){g.group.members=e}function p(){m.processing=!1}var m={processing:!0,tooManySupportGroups:!1,tooManySupportPeople:!1,noSupportGroups:!1},f=[],g={group:{}};e.selectGroup=function(e){_.forEach(g.group.members,function(e){e.isSelected=!1}),g.group=e,!g.group.members&&d(e)},e.isPersonSelected=function(){return!!_.find(g.group.members,"isSelected")},e.share=function(){m.processing=!0;var e=g.note?[g.note]:[],n=_.without(_.map(_.filter(g.group.members,"isSelected"),"email"),""),i=r.userFullData.fullName+o("i18n")("shareBlade.emailSubject");_.forEach(a.actionItems,function(t){if(t.type===EntityVO.TYPE_KNOWLEDGE){var a=c.create(t);a=a.replace(/#\//,""),e.push(a)}else e.push(c.create(t))}),s.openMailClient(n.join("; "),i,e.join(" \r\n")),t.close()},e.getSupportGroupsByText=function(e){return l.getSupportGroupsByText(e).then(function(e){return e.supportGroups})},e.onPersonSearchTextChanged=function(){e.searchText!==r.userFullData.fullName&&(e.personLoginId=""),e.selected.group.id&&(m.tooManySupportPeople?e.searchText.length>2?(m.processing=!0,n.getAssigneeBySupportGroupId(e.selected.group.id,e.searchText,e.personLoginId,"","",l.supportPersonChunkSize,!0).then(function(e){u(e.results)})["finally"](function(){m.processing=!1})):g.group.members=[]:d(g.group))},e.selected=g,e.supportGroups=f,e.state=m,l.getSupportGroupsForKAShare(l.supportGroupChunkSize).then(function(t){t.exceedsChunkSize?(e.supportGroups=t.supportGroups,m.processing=!1,m.tooManySupportGroups=!0,m.noSupportGroups=!1):t.supportGroups.length?(e.supportGroups=t.supportGroups,g.group=t.supportGroups[0],d(g.group),m.tooManySupportGroups=!1,m.noSupportGroups=!1):(m.processing=!1,m.noSupportGroups=!0)})}])}(),TaskVO.prototype=new TicketVO,TaskVO.prototype.constructor=TaskVO,TaskVO.prototype.getProps=function(){return TicketVO.prototype.getProps().concat("name","parentType","parentName","parentDisplayId","parentId","parentSummary","scheduledEndDate","scheduledStartDate","actualStartDate","actualEndDate","isAutomatic","jobID","jobType","jobVersion")},TaskVO.prototype.postBuild=function(){TicketVO.prototype.postBuild.call(this),this.scheduledStartDate=this.scheduledStartDate?new Date(this.scheduledStartDate):null,this.scheduledEndDate=this.scheduledEndDate?new Date(this.scheduledEndDate):null,this.actualStartDate=this.actualStartDate?new Date(this.actualStartDate):null,this.actualEndDate=this.actualEndDate?new Date(this.actualEndDate):null,this.scheduledStartDateHumanized=this.scheduledStartDate?moment(this.scheduledStartDate).format("lll"):null,this.scheduledEndDateHumanized=this.scheduledEndDate?moment(this.scheduledEndDate).format("lll"):null,this.actualStartDateHumanized=this.actualStartDate?moment(this.actualStartDate).format("lll"):null,this.actualEndDateHumanized=this.actualEndDate?moment(this.actualEndDate).format("lll"):null,this.subType=this.isAutomatic?"-auto":""},function(){angular.module("myitsmApp").service("ticketActionService",["$modal","$filter","$q","$timeout","$state","events","emailModel","followService","systemAlertService","ticketModel","metadataModel","screenConfigurationModel","relationModel","srdModel","$log","objectValueMapperService","slaCalculatorService",function(e,t,a,n,i,o,r,s,l,c,d,u,p,m,f,g,h){function y(e){return e.allCompanies?_.find(e.allCompanies,function(e){return e.primary}):e.company}function E(e,t,a,n){n.state.processing=!0;var i={};i="problemcoordinator"===t?{coordinatorLoginId:e.loginId,coordinatorFullName:e.fullName,coordinatorGroup:e.supportGroup,coordinatorCompany:e.company.name,coordinatorOrganization:e.organization,coordinatorGroupId:e.supportGroupId,coordinatorAutoAssign:!1}:"workordermanager"===t||"changemanager"===t?{managerLoginId:e.loginId,managerFullName:e.fullName,managerGroup:e.supportGroup,managerCompany:e.company.name,managerOrganization:e.organization,managerGroupId:e.supportGroupId,managerAutoAssign:!1}:{loginId:e.loginId,fullName:e.fullName,group:e.supportGroup,groupId:e.supportGroupId,company:e.company.name,organization:e.organization,autoAssign:!1},c.update(a.id,a.type,i).then(function(e){if(_.isUndefined(e.data)){var t={};t=a.type===EntityVO.TYPE_RELEASE?{assignee:e.coordinator,group:e.supportGroup||e.coordinatorGroup,manager:e.manager||e.coordinator,managerGroup:e.managerGroup||e.coordinatorGroup,status:e.status,accessMappings:e.accessMappings}:a.type===EntityVO.TYPE_PROBLEM||a.type===EntityVO.TYPE_KNOWNERROR?{assignee:e.assignee,group:e.supportGroup,manager:e.coordinator,managerGroup:e.coordinatorGroup,status:e.status,accessMappings:e.accessMappings}:{assignee:e.assignee,group:e.supportGroup,manager:e.manager||e.coordinator,managerGroup:e.managerGroup||e.coordinatorGroup,status:e.status,accessMappings:e.accessMappings},S(t,a,n)}else l.error({text:e.data.error,clear:!0})})["finally"](function(){n.state.processing=!1})}function v(e,t,a,n,i,o){n.showAssignDialog(_.cloneDeep(t),!1,a,o).result.then(function(a){S(a,t,i),e.currentTarget.focus()},function(){e.currentTarget.focus()})}function T(e,t,a,n,i){a.showAssignDialog(_.cloneDeep(e),!0,t,i).result.then(function(t){C(t,e,n,i)},function(t){f.error("Could not assign ticket properly. ",t,e)})}function S(e,t,a){t.type===EntityVO.TYPE_ACTIVITY&&(e.originalObject.parentGuid=t.parentGuid),e.originalObject&&e.originalObject.constructor.name===t.constructor.name&&_.extend(t,e.originalObject),t.assignee=e.assignee,t.supportGroup=e.group,t.supportGroup&&delete t.supportGroup.assignedToGroup,t.coordinatorGroup||(t.coordinatorGroup={}),t.coordinator||(t.coordinator={}),t.manager=e.manager,t.managerGroup=e.managerGroup,t.managerGroup&&delete t.managerGroup.assignedToGroup,t.accessMappings=e.accessMappings,t.status=e.status,t.type===EntityVO.TYPE_RELEASE&&(t.coordinator=e.assignee),t.type===EntityVO.TYPE_PROBLEM||t.type===EntityVO.TYPE_KNOWNERROR?(t.coordinator=e.coordinator||e.manager,t.coordinatorGroup=e.coordinatorGroup||e.managerGroup):(t.coordinator.fullName=e.assignee?e.assignee.fullName:"",t.coordinatorGroup.name=e.group?e.group.name:"",t.coordinatorGroup.id=e.group?e.group.id:""),u.updateTicketData(t,e.changes),c.cache&&c.cache[t.id]&&_.extend(c.cache[t.id],t);var n=u.composePanelId(t.type,"Assignment");console.log("target panel id : "+n),a.$broadcast(o.REFRESH_FIELD_VALUES,{panelId:n}),a.$broadcast(o.AFTER_SAVED_CHANGES,t),a.$broadcast(o.TICKET_ASSIGNEES_UPDATED,t,!0),a.$broadcast(o.TICKET_ASSIGNEES_UPDATED_FROM_BLADE,t,!0)}function C(e,t,a,n,i){t.assignee=e.assignee,t.supportGroup=e.group||e.supportGroup,t.manager=e.manager,t.managerGroup=e.managerGroup,t.coordinator=t.coordinator||{},t.coordinator.fullName=e.assignee?e.assignee.fullName:"",t.coordinatorGroup=t.coordinatorGroup||{},t.coordinatorGroup.name=e.group?e.group.name:"",t.type===EntityVO.TYPE_RELEASE&&(t.coordinator.id=e.assignee.id),t.type!==EntityVO.TYPE_PROBLEM&&t.type!==EntityVO.TYPE_KNOWNERROR||(t.coordinator=e.manager,t.coordinatorGroup=e.managerGroup),e.autoAssign&&(t.assignee={autoAssign:!0},t.supportGroup={}),e.managerAutoAssign&&(t.manager={managerAutoAssign:!0},t.managerGroup={}),e.coordinatorAutoAssign&&(t.coordinator={coordinatorAutoAssign:!0},t.coordinatorGroup={}),a.$broadcast(o.TICKET_ASSIGNEES_UPDATED,_.cloneDeep(t),!1,n,i),a.$broadcast(o.TICKET_ASSIGNEES_UPDATED_FROM_BLADE,t,!0)}this.showAssignDialog=function(t,a,n,i){return t.assignee||(t.assignee={customFields:{}}),e.open({templateUrl:"views/common/assign-action-blade.html",controller:"AssignController",windowClass:"action-blade",keyboard:"custom",backdrop:"custom",resolve:{assignParams:function(){return{ticket:t,isDraft:a,role:n,activeRole:i}}}})},this.showBulkAssignDialog=function(t){return e.open({templateUrl:"views/common/bulk-assign-action-blade.html",controller:"BulkAssignController",windowClass:"action-blade",backdrop:"custom",resolve:{assignParams:function(){return{selectedItems:t}}}})},this.showShareDialog=function(t){return e.open({templateUrl:"views/common/share-action-blade.html",controller:"ShareController",windowClass:"action-blade",resolve:{shareParams:function(){return{actionItems:_.isArray(t)?t:[t]}}}})},this.showEditStatusDialog=function(t,a,n){return e.open({templateUrl:"views/ticket/edit-status-action-blade.html",windowClass:"action-blade",controller:"EditStatusController",keyboard:"custom",backdrop:"custom",resolve:{editStatusParams:function(){return{actionItems:_.isArray(t)?t:[t],isDraft:a,isReopen:n}}}})},this.showLinkDialog=function(t,a){return e.open({templateUrl:"views/ticket/link-item-action-blade.html",windowClass:"action-blade",controller:"LinkController",resolve:{linkParams:function(){return{selectedItems:t,isDraft:a,linkFromTicketConsole:!0}}}})},this.showPlansEditDialog=function(t,a){return e.open({templateUrl:"views/change/documents-action-blade.html",windowClass:"action-blade",controller:"EditChangeRequestPlansController",resolve:{planEditParams:function(){return{metadata:t,ticket:a}}}})},this.share=function(e){e.type===EntityVO.TYPE_SERVICEREQUEST||e.type===EntityVO.TYPE_SBEREQUEST?this.showShareDialog(e).result.then(function(){$(".profile-action-bar__item-link").focus()},function(){$(".profile-action-bar__item-link").focus()}):r.createEmail([e])},this.follow=function(e){return s.follow(e)},this.unfollow=function(e){return s.unfollow(e)},this.showPrintDialog=function(t,a,n,i,o,r){var s=e.open({templateUrl:"views/common/print-action-blade.html",controller:"PrintController",windowClass:"action-blade",size:"extra-lg",resolve:{params:function(){return{entity:a,relationCounters:n,feed:i,metadata:o,screenLayout:r}}}});s.result["finally"](function(){t.currentTarget.focus()})},this.confirmAction=function(e,n,i){var o=a.defer();if(e.type===EntityVO.TYPE_INCIDENT&&n===EntityVO.ACTION_REOPEN)this.showEditStatusDialog(e,!1,!0).result.then(function(t){return c.refreshStatus(e.id,e.type,t)}).then(function(){o.resolve()});else if(e.type===EntityVO.TYPE_SERVICEREQUEST&&n===EntityVO.ACTION_CANCEL){var r=l.modal({title:t("i18n")("common.notification.delete.title"),text:t("i18n")("action."+n+".confirm",[t("i18n")("common.labels."+e.type)]),buttons:[{text:t("i18n")("common.notification.delete.button1"),data:!0},{text:t("i18n")("common.notification.delete.button2"),data:!1}]}),s=this;r.result.then(function(t){t&&s.applyAction(e,n,i)})}return o.promise},this.applyAction=function(e,a,r){var s={};r.state.processing=!0,r.state.isDataLoading=!0,c.applyAction(e.id,e.type,a,s).then(function(d){if(!_.isEmpty(d)){if(s=d[0].items[0],e.type===EntityVO.TYPE_INCIDENT)a===EntityVO.ACTION_REOPEN&&(i.go(EntityVO.TYPE_INCIDENT,{id:s.id}),n(function(){l.success({text:t("i18n")("ticket.notification.reopen.message",s.displayId+": "+s.summary),hide:1e4})},100));else if(e.type===EntityVO.TYPE_SERVICEREQUEST)a===EntityVO.ACTION_REOPEN||a===EntityVO.ACTION_CANCEL?(e.status=angular.copy(s.status),c.refreshSLA(e),r.$emit(o.TICKET_PROFILE_RESEND_EVENT,{eventName:o.REFRESH_ACTIVITY_FEED})):a===EntityVO.ACTION_REQUESTAGAIN&&(s.isCrossLaunchSubmitted?m.launchAIF(!0,!1,r,s.requestTemplateTitle,s.crossLaunchURLCreate,e.customer.loginId,e.contact?e.contact.loginId:null):(c.cache.draft=(new ServiceRequestVO).build(s),i.go("draftServicerequest")));else if(e.type===EntityVO.TYPE_CHANGE){if("restart"===a){var u=angular.copy(e.plans);e=(new ChangeVO).build(d[0].items[0]),e.plans=u}else e=(new ChangeVO).build(d[0].items[0]),e.plans=angular.copy(e.plans);r.$emit(o.AFTER_SAVED_CHANGES,e)}else e.type===EntityVO.TYPE_RELEASE&&(e=(new ReleaseVO).build(d[0].items[0]),e.plans=angular.copy(e.plans),c.cache&&c.cache[e.id]&&(_.extend(c.cache[e.id],e),r.basicData=c.cache[e.id]));var p=g.getFieldByName(e.type===EntityVO.TYPE_TASK?"taskStatus":"status"),f=e.type===EntityVO.TYPE_TASK?"taskStatus":"status";r.$emit(o.WIDGET_VALUE_CHANGE,{fieldName:p&&p.name,memberName:f}),e.status&&e.serviceTargets&&e.serviceTargets.length>0&&h.processServiceTarget(e,e.serviceTargets)}})["finally"](function(){r.state.processing=!1,r.state.isDataLoading=!1})},this.assign=function(e,t,a,n,i){a.type===EntityVO.TYPE_RELEASE&&(a.assignee=a.coordinator,a.supportGroup=a.coordinatorGroup),t?T(a,null,this,n,i):v(e,a,null,this,n,i)},this.assignToMe=function(e,t,a,n,i){var o=t,r=n.supportGroup||{},s=this;"ticketassignee"===t?o=n.type===EntityVO.TYPE_WORKORDER?"workorderassignee":"":"workordermanager"===t||"changemanager"===t?r=n.managerGroup||{}:"problemcoordinator"!==t&&"releasecoordinator"!==t||(r=n.coordinatorGroup),n.type===EntityVO.TYPE_ACTIVITY&&(o="");var l,d=null,u=y(n),p=null,m=null;u=u?u.name:"",n.type!==EntityVO.TYPE_KNOWLEDGE?(l=n instanceof TicketConsoleItemVO||n.type!==EntityVO.TYPE_INCIDENT&&n.type!==EntityVO.TYPE_WORKORDER?n.customer&&n.customer.company?n.customer.company.name:n.company?n.company.name:"":g.getExactValueByFieldName("customerCompany")||"",d=(n.type===EntityVO.TYPE_TASK||n.type===EntityVO.TYPE_CHANGE)&&n.id&&n.company?n.company.name:n instanceof TicketConsoleItemVO||n.type!==EntityVO.TYPE_INCIDENT&&n.type!==EntityVO.TYPE_WORKORDER?n.locationCompany?n.locationCompany.name:null:g.getExactValueByFieldName("locationCompany")):(p=n.owner.company?n.owner.company.name:"",m=n.author.company?n.author.company.name:""),i.state.AssignToMeIsLoading=!0,c.getTicketAssigneePersonsBySearchText(o,l,d,p,u,m).then(function(l){l=_.uniqBy(l.results,function(e){return e.loginId&&e.supportGroupId});var c=1===l.length?l[0]:_.find(l,{supportGroupId:r.id});c&&c.loginId?a?(["workordermanager","changemanager"].indexOf(t)!==-1?_.assign(n,{manager:{id:c.id,loginId:c.loginId,fullName:c.fullName,supportGroup:c.supportGroup,groupId:c.supportGroupId,company:c.company,organization:c.organization,thumbnail:c.thumbnail,thumbnailMime:c.thumbnailMime},managerGroup:{id:c.supportGroupId,name:c.supportGroup,organization:c.organization,company:c.company}}):["problemcoordinator","releasecoordinator"].indexOf(t)!==-1?_.assign(n,{coordinator:{id:c.id,loginId:c.loginId,fullName:c.fullName,supportGroup:c.supportGroup,groupId:c.supportGroupId,company:c.company,organization:c.organization,thumbnail:c.thumbnail,thumbnailMime:c.thumbnailMime},coordinatorGroup:{id:c.supportGroupId,name:c.supportGroup,organization:c.organization,company:c.company}}):_.assign(n,{assignee:{id:c.id,loginId:c.loginId,fullName:c.fullName,supportGroup:c.supportGroup,groupId:c.supportGroupId,company:c.company,organization:c.organization,thumbnail:c.thumbnail,thumbnailMime:c.thumbnailMime},group:{id:c.supportGroupId,name:c.supportGroup,organization:c.organization,company:c.company}}),n.autoAssign=!1,C(n,n,i,t,!0)):E(c,o,n,i):a?T(n,t,s,i,t):v(e,n,t,s,i)})["finally"](function(){i.state.AssignToMeIsLoading=!1})},this.toggleNeedAttentionFlag=function(e,t){var a=_.map(e,function(e){return{uuid:e.id,type:e.type}});return c.updateStatus(a,t)}}])}(),function(){angular.module("ticketModule").controller("TicketController",["$scope","$rootScope","$state","$stateParams","$q","$filter","$modal","$window","$injector","ticketModel","relationModel","approvalModel","knowledgeArticleModel","categoriesService","ticketActionService","followService","screenConfigurationModel","events","systemAlertService","srdModel","metadataModel","$timeout","$location","emailModel","relationService","approvalService","i18nService","collisionModel","searchModel","configurationModel","userModel","chatModel","layoutConfigurationModel","$log","permissionModel","objectValueMapperService","expressionEvaluatorService",function(e,t,a,n,i,o,r,s,l,c,d,u,p,m,f,g,h,y,E,v,T,S,C,O,A,I,b,k,D,R,P,w,L,N,M,V,F){function x(t){e.basicData=t[0],e.basicData.isMCSMEnabled=ye,e.basicData.isFullVersion=e.isFullVersion,e.metadata=_.find(t[1],{metadatatype:e.type}),e.screenLayout=t[2],e.basicData.type=e.type,e.basicData.hasImpactAnalysis=!1,e.isSBEApprovalLoaded=!1,e.metadata&&(e.metadata.configurationParameters=oe.configurationParameters),e.availableForAssignment=P.userFullData.availableForAssignment;var a=i.when(1);e.basicData.type===EntityVO.TYPE_INCIDENT&&(a=c.getIncidentRules(e.basicData.company&&e.basicData.company.name)),a.then(function(t){t&&t.serviceCIRequired&&(e.basicData.serviceCIRequired="true"===t.serviceCIRequired),t&&t.CIRequiredOnResolved&&(e.basicData.CIRequiredOnResolved="true"===t.CIRequiredOnResolved),e.$broadcast(y.SERVICECI_REQUIRED,{isRequired:e.basicData.serviceCIRequired,name:"impactedService"}),t&&t.applyCognitiveForSupportGroup&&(e.basicData.applyCognitiveForSupportGroup=t.applyCognitiveForSupportGroup,e.$broadcast(y.APPLY_COGNITIVE_SG,{applyCognitive:t.applyCognitiveForSupportGroup}))}),G(),e.$broadcast(y.TICKET_BASIC_DATA_LOADED),ne=e.basicData.impactedService?e.basicData.impactedService.name:"",ie=e.basicData.causalCI?e.basicData.causalCI.name:""}function G(){e.basicData.type!==EntityVO.TYPE_CHANGE&&e.basicData.type!==EntityVO.TYPE_RELEASE||e.basicData.isInApproval&&e.basicData.accessMappings.summaryEditAllowed&&(e.basicData.accessMappings.statusEditAllowed=!0),e.basicData.desc&&(e.basicData.desc=e.basicData.desc.replace("&nbsp;"," "));var t=e.basicData.categorizations;if(e.basicData.resCategorizations&&e.basicData.isClosed()?t=e.basicData.categorizations.concat(e.basicData.resCategorizations):e.basicData.type===EntityVO.TYPE_INCIDENT&&(e.basicData.categorizations.push(_.find(e.basicData.resCategorizations,{name:"resolutionProduct"})),e.basicData.categorizations.push(_.find(e.basicData.resCategorizations,{name:"resolution"})),t=e.basicData.categorizations),t&&e.basicData.type!==EntityVO.TYPE_ACTIVITY&&(e.basicData.allCategories=m.populateCategories(t,e.metadata),e.basicData.noCategories=_.filter(e.basicData.allCategories,"valueToShow").length),!e.metadata||e.basicData.priority||_.isEmpty(e.metadata.priorities)||(e.basicData.priority=_.last(e.metadata.priorities).name),e.basicData.type===EntityVO.TYPE_TASK&&(e.isParentAppEnabled=R.isServerApplicationEnabled(e.basicData.parentName),e.basicData.locationCompany=e.basicData.company&&e.basicData.company.name),e.basicData.type===EntityVO.TYPE_SERVICEREQUEST&&(e.basicData.expectedDate&&(e.basicData.expectedDate=J(e.basicData.expectedDate,e.basicData.expectedTime)),e.basicData.requiredDate&&(e.basicData.requiredDate=J(e.basicData.requiredDate,e.basicData.requiredTime)),_.forEach(e.basicData.questionResponses,function(e){if(e.value&&"DATE_TIME"===e.format){var t=new Date(1e3*e.value);e.displayValue=o("datePreConfigTimezone")(t,"mediumDate")+" "+o("datePreConfigTimezone")(t,"shortTime")}else e.value&&"DATE_ONLY"===e.format?e.displayValue=moment.utc(new Date(1e3*e.value)).format("ll"):e.value&&"TIME_ONLY"===e.format&&(e.displayValue=moment.utc(1e3*e.value).format("LT"))})),e.basicData.type===EntityVO.TYPE_SBEREQUEST&&_.forEach(e.basicData.answers,function(e){if(e.value&&"DATE_TIME_FIELD"===e.format){var t=new Date(1e3*e.value);e.displayValue=o("datePreConfigTimezone")(t,"mediumDate")+" "+o("datePreConfigTimezone")(t,"shortTime")}else e.value&&"DATE_FIELD"===e.format?e.displayValue=moment.utc(new Date(1e3*e.value)).format("ll"):e.value&&"TIME_FIELD"===e.format?e.displayValue=moment(e.displayValue,"hh:mm:ss").format("LT"):e.value&&"ATTACHMENT"===e.format&&_.forEach(e.additionalInfo,function(e){e.metadataFileNameEncoded=encodeURIComponent(e.metadataFileName)})}),e.basicData.type!==EntityVO.TYPE_CHANGE||D.disableCollisionManagement||H(),!D.disableImpactAnalysis&&e.basicData.accessMappings&&e.basicData.accessMappings.impactEditAllowed&&Q(),e.basicData.brokerVendorName&&c.getVendorInfo(e.basicData.displayId,e.basicData.type).then(function(t){e.basicData.vendorInfo=_.sortBy(t,"id")}),ue==EntityVO.TYPE_CHANGE){var a=[];_.forEach(e.metadata.riskLevels,function(e){a.push(e.name)}),c.getChangeRiskRules(e.basicData.company&&e.basicData.company.name).then(function(t){t&&t.changeReasonRequiredForRisk&&(e.basicData.riskRulesConfigured=!0,e.basicData.riskLevelForChangeReason=_.takeRight(a,a.length-a.indexOf(t.changeReasonRequiredForRisk))),t&&t.hasOwnProperty("enableAssginmentEngineIntegration")&&("1"===t.enableAssginmentEngineIntegration?e.basicData.enableAssginmentEngineIntegration=!1:"0"===t.enableAssginmentEngineIntegration&&(e.basicData.enableAssginmentEngineIntegration=!0)),e.$emit(y.TICKET_BASIC_DATA_LOADED,{ticket:e.basicData})})}else e.$emit(y.TICKET_BASIC_DATA_LOADED,{ticket:e.basicData});e.$emit(y.TICKET_PROFILE_RESEND_EVENT,{eventName:y.UPDATE_CONTEXT_ON_REFRESH,data:e.basicData})}function $(){e.state.dataIsLoading=!1,_.isUndefined(e.basicData)&&(e.basicData={})}function B(t,a){e.dirty=!0,e.activeEditableSectionId=a,"ticket-header"===a&&e.enableHeaderEdit();var n=V.getFieldsByType("category");_.forEach(n,function(e){return e.readOnlyCondition?void(e.isReadOnly=F.evaluate(e.readOnlyCondition)):void(e.isReadOnly=e.readOnly)})}function U(){e.dirty=!1,e.activeEditableSectionId=null,ue===EntityVO.TYPE_CHANGE&&(Y(),H())}function z(t,a){a.type!==EntityVO.TYPE_CHANGE&&a.type!==EntityVO.TYPE_INCIDENT&&(e.basicData.assignee=a.assignee,e.basicData.supportGroup=a.supportGroup,e.basicData.manager=a.manager,e.basicData.managerGroup=a.managerGroup,e.basicData.coordinator=a.coordinator,e.basicData.coordinatorGroup=a.coordinatorGroup)}function Y(){me.tasks=A.getRelatedTasks(e.relations[de]).length,me.linkedItems=A.getRelatedLinkedItems(e.relations[de],e.basicData,he).length,fe=A.getRelatedCIs(e.relations[de]),me.CIs=_.chain(fe).reject(function(t){var a=e.basicData;return!he&&a&&_.includes([a.causalCI&&a.causalCI.reconciliationId,a.impactedService&&a.impactedService.reconciliationId],t.id)&&t.type===EntityVO.TYPE_ASSET}).value().length,e.relationCounters=me}function q(){e.alertDetails={alertItems:[]};var t=[];ue!==EntityVO.TYPE_CHANGE&&ue!==EntityVO.TYPE_RELEASE||(e.basicData.isInApproval||ge||e.basicData.hasImpactAnalysis||e.showRunCollisionDetectionMsg?(e.hasAlerts=!0,e.basicData.isInApproval&&(e.alertDetails.alertItems.push("approval_banner"),t.push(b.getLocalizedString("alert.heading.approvalBanner"))),!ge&&!e.showRunCollisionDetectionMsg||D.disableCollisionManagement||(e.alertDetails.alertItems.push("collision_banner"),t.push(b.getLocalizedString("alert.heading.collisions")),e.showRunCollisionDetectionMsg&&(e.alertDetails.collisionDetails={showRunCollisionDetectionMsg:!0})),e.basicData.hasImpactAnalysis&&!D.disableImpactAnalysis&&e.basicData.accessMappings&&e.basicData.accessMappings.impactEditAllowed&&(e.alertDetails.alertItems.push("impact_analysis_banner"),t.push(b.getLocalizedString("alert.heading.impactAnalysis")))):e.hasAlerts=!1,e.alertDetails.alertHeading=t.join(", ")),ue===EntityVO.TYPE_SBEREQUEST&&e.basicData.isInApproval&&!e.isSBEApprovalLoaded&&(e.isSBEApprovalLoaded=!0,I.getListOfApprovers({id:e.basicData.id,type:EntityVO.TYPE_SBEREQUEST}).then(function(t){t&&(e.basicData.approvalSummaries=t.approvalSummaries,e.basicData.approvalList=t.approvalList,e.basicData.isUserApprovalPending=t.isUserApprovalPending,e.basicData.groupedSummary=t.groupedSummary)}))}function H(){if(e.basicData){Y();var t=fe;e.basicData.impactedService&&e.basicData.impactedService.reconciliationId&&(_.find(t,{id:e.basicData.impactedService.reconciliationId})||t.push({id:e.basicData.impactedService.reconciliationId})),e.basicData.scheduledStartDate&&e.basicData.scheduledEndDate&&t&&t.length&&(isNaN(R.autoTriggerChangeCollisionForCIsUpto)||_.isUndefined(R.autoTriggerChangeCollisionForCIsUpto)||t.length<=R.autoTriggerChangeCollisionForCIsUpto)?k.getListOfCollisionsById(e.basicData,!1).then(function(t){e.showRunCollisionDetectionMsg=!1,t.totalUnaddressedCount>0?(e.collisions=t,ge=!0):ge=!1})["finally"](function(){q()}):(e.collisions={},e.showRunCollisionDetectionMsg=!!(e.basicData.scheduledStartDate&&e.basicData.scheduledEndDate&&t&&t.length&&!isNaN(R.autoTriggerChangeCollisionForCIsUpto)&&!_.isUndefined(R.autoTriggerChangeCollisionForCIsUpto)&&t.length>R.autoTriggerChangeCollisionForCIsUpto),q())}}function K(){e.state.dataIsLoading=!0,c.getTicketDetails(e.basicData.id,e.basicData.type)["finally"](function(){e.state.dataIsLoading=!1}).then(function(t){return e.basicData.isInApproval=t.isInApproval,q(),c.refreshStatus(e.basicData.id,e.basicData.type,{status:t.status.value,milestone:t.milestone,updatedTickets:[t]})})}function j(t,a){var n={status:"Resolved",statusReason:"No Further Action Required",resNote:a.title||a.desc};a.updateCategories?(n.categorizations=a.categorizations,c.update(de,ue,n).then(function(t){t&&500!==t.status&&e.$broadcast(y.AFTER_SAVED_CHANGES,e.basicData)})):c.update(de,ue,n).then(function(t){t&&500!==t.status&&e.$broadcast(y.AFTER_SAVED_CHANGES,e.basicData)})}function W(){pe.dataIsLoading=!0,c.getTicket(e.basicData.id,e.basicData.type,!0).then(function(t){e.basicData.status=t.status,e.basicData.accessMappings=t.accessMappings})["finally"](function(){pe.dataIsLoading=!1})}function Q(){c.getImpactAnalysisStatus(e.basicData.id,e.basicData.type).then(function(t){t.status&&t.status.value&&(e.basicData.hasImpactAnalysis=!0,"Relationship Assessment Completed"===t.status.value?e.basicData.impactAnalysisStatus="Completed":"Analysis Completed"===t.status.value||"Analysis In Progress"===t.status.value||"Relationship Assessment In Progress"===t.status.value?e.basicData.impactAnalysisStatus="Pending":e.basicData.impactAnalysisStatus="Unknown"),e.basicData.hasImpactAnalysis&&q()})}function J(e,t){return t=t?moment(t):moment(e),1e3*moment(e).set("hours",t.get("hours")).set("minutes",t.get("minutes")).format("X")}function Z(t,a){var n=!1,i=a.originalEvent,o=!a.saveSelection;if(!a)return void N.warn("Could not open assignment blade. Required Event data is missing. ");if(n=!!a.assignToMe,a.role){var r=a.role;"manager"===r?r=e.type+r:"assignee"===r&&(r=[EntityVO.TYPE_CHANGE,EntityVO.TYPE_PROBLEM,EntityVO.TYPE_RELEASE].indexOf(e.type)!==-1?e.type+"coordinator":"ticketassignee")}n?e.ticketActions.assignToMe(i,r,o):e.ticketActions.assign(i,o,r)}function X(t,a){e.state.dataIsLoading=!0,e.basicData=a;var n=ne!==(a.impactedService&&a.impactedService.name)||ie!==(a.causalCI&&a.causalCI.name)||["Cancelled","Rejected","Bypassed"].indexOf(a.status.value)!==-1;e.$emit(y.TICKET_PROFILE_RESEND_EVENT,{eventName:y.REFRESH_ACTIVITY_FEED}),n&&(d.refreshRelations(de,ue).then(function(t){e.relations=angular.copy(d.cache)}),ne=a.impactedService&&a.impactedService.name,ie=a.causalCI&&a.causalCI.name),G(),S(function(){e.state.dataIsLoading=!1})}function ee(){var t=e.relationCounters.CIs;if(Y(),e.type===EntityVO.TYPE_PROBLEM&&e.relations&&e.basicData&&_.each(e.relations[e.basicData.id],function(t){t.type===EntityVO.TYPE_KNOWNERROR&&t.relationshipType===RelationItemVO.TYPE_INITIATES&&(e.basicData.hasInitiatesRelation=!0)}),e.basicData&&e.basicData.accessMappings&&e.basicData.accessMappings.impactEditAllowed&&!D.disableImpactAnalysis){var a=R.get("moreActions."+e.type);e.moreDropDownOptions={actions:a,registeredCallbacks:e.moreDropDownActionsCallbackFuncns}}e.type===EntityVO.TYPE_CHANGE&&me.CIs>0&&t!==me.CIs&&!D.disableCollisionManagement&&H()}function te(){e.state.dataIsLoading=!0}function ae(){e.state.dataIsLoading=!1}"requestPreview"===a.current.name||"sberequestPreview"===a.current.name?(e.id=n.id,e.type="requestPreview"===a.current.name?EntityVO.TYPE_SERVICEREQUEST:EntityVO.TYPE_SBEREQUEST,
e.isFullVersion=!1,t.hasParent=!0,t.hideNavigationBar=!0):e.isFullVersion=!0;var ne,ie,oe,re,se,le,ce,de=e.id,ue=e.type,pe={dataIsLoading:!0},me={tickets:0,linkedItems:0},fe={},ge=!1,he=!1,ye=!1,Ee=h.getScreenNameByTicketType(ue),ve=T.getMetadataByType(EntityVO.TYPE_GLOBAL).then(function(t){oe=t;var i="T"===t.configurationParameters["Enable-Progressive-Views"]||"true"===t.configurationParameters["Enable-Progressive-Views"];i="T"!==localStorage.getItem("overridePV")&&i;var o="true"===t.configurationParameters.enableReleasePV;(ue===EntityVO.TYPE_RELEASE||ue===EntityVO.TYPE_ACTIVITY)&&o&&i&&localStorage.getItem("midtierUrl")?a.go(e.type+"PV",{id:n.id},{inherit:!1}):ue!==EntityVO.TYPE_RELEASE&&i&&localStorage.getItem("midtierUrl")&&R.get("pwaEnabledTickets.tickets").indexOf(e.type)>=0&&a.go(e.type+"PV",{id:n.id},{inherit:!1})})["catch"](function(e){e&&E.error({text:e.data.error,clear:!1})}),Te=i.resolve({});"request"!==ue&&"sberequest"!==ue&&((R.isPwaEnabled||"T"!==localStorage.getItem("overridePV"))&&localStorage.getItem("midtierUrl")&&R.get("pwaEnabledTickets.tickets").indexOf(e.type)>=0?a.go(e.type+"PV",{id:n.id},{inherit:!1}):Te=h.isV2CompatibleScreen(Ee)?h.loadScreenConfigurationByName(Ee):h.loadScreenConfigurationAndCustomFieldLabels(Ee,ue));var Se=function(t){t&&t.configurationParameters&&(he="true"===t.configurationParameters.affectedServiceRelation,ye="true"===t.configurationParameters.isMCSMEnabled),re=c.getTicket(de,ue,!0,!0),se=T.getMetadataByTypes(EntityVO.ALL_TYPES),le=L.loadScreenLayout(Ee),ce=[re,se,le,Te],R.showARMessageOnGetEntry&&ce.push(c.getARMessageInformation(de,ue)),i.all(ce).then(function(e){x(e)})["catch"](function(e){throw E.error({text:("sberequest"===ue?e.data.detailedMessage:e.data.detailMessage)||e.data.error||e,clear:!1}),e})["finally"]($),d.getRelations(de,ue).then(function(){e.relations=angular.copy(d.cache)})};e.metadata={},e.numberOfRelatedTasks=0,e.numberOfLinkedResources=0,e.editHeader=!1,e.isContactCollapsed=!0,e.hasAlerts=!1,e.dirty=!1,e.loggedInUserId=P.decodedUserId||P.userId,e.isCategoriesEmpty=!1,e.hasEditPermission=M.hasPermissionForTicket(ue),e.chatModel={connected:w.connected},e.$watch(function(){return w.connected},function(t){e.chatModel.connected=t}),e.$on("$destroy",function(){delete c.cache[de],delete d.cache[de];var e=V.isProviderActionEventRegistered();e&&(e(),V.registerProviderActionCallExpressionEvent(null))}),e.refreshTicket=function(t){e.state.dataIsLoading=!0,t||(delete c.cache[de],delete d.cache[de],u.clearListOfApproversCache(de)),e.basicData&&e.basicData.accessMappings&&!e.basicData.accessMappings.impactEditAllowed&&!D.disableImpactAnalysis&&(e.moreDropDownOptions=null),re=c.getTicket(de,ue,!t),se=T.getMetadataByTypes(EntityVO.ALL_TYPES),le=L.loadScreenLayout(Ee,!t),Te=h.getScreenNameByTicketType(ue)&&!t?h.isV2CompatibleScreen(Ee)?h.loadScreenConfigurationByName(Ee,!0):h.loadScreenConfigurationAndCustomFieldLabels(Ee,ue,!0):i.when({}),ce=[re,se,le,Te],R.showARMessageOnGetEntry&&ce.push(c.getARMessageInformation(de,ue)),d.getRelations(de,ue).then(function(t){e.relations=angular.copy(d.cache)}),e.$emit(y.REFRESH_TICKET,{isRefreshTicket:!0}),i.all(ce).then(function(e){x(e)})["finally"]($)},e.relations=angular.copy(d.cache),e.$watchCollection("relations",function(){ee()},!0),e.$on(y.RELATIONS_UPDATE_COMPLETE,function(t,a){a?(delete d.cache[de],d.getRelations(e.id,e.type).then(function(t){e.relations=angular.copy(d.cache),ee()})):(e.relations=angular.copy(d.cache),ee())}),e.moreDropDownActionsCallbackFuncns={runImpactAnalysis:function(){function t(e,t,n){return E.modal({title:e,text:t,type:"info",buttons:[{text:b.getLocalizedString("impact.analysis.cancel.existing.yes"),data:!0},{text:b.getLocalizedString("impact.analysis.cancel.existing.no"),data:!1}]}).result.then(function(e){e&&a(n)})}function a(t){c.impactAnalysisAction(e.basicData.id,e.basicData.type,t).then(function(t){e.basicData.hasImpactAnalysis=!1,t&&t.status&&t.status.value&&(e.basicData.hasImpactAnalysis=!0,"Relationship Assessment Completed"===t.status.value?e.basicData.impactAnalysisStatus="Completed":"Analysis Completed"===t.status.value||"Analysis In Progress"===t.status.value||"Relationship Assessment In Progress"===t.status.value?e.basicData.impactAnalysisStatus="Pending":e.basicData.impactAnalysisStatus="Unknown")})}var n,i,o;if(e.basicData.hasImpactAnalysis&&"Pending"===e.basicData.impactAnalysisStatus)n=b.getLocalizedString("impact.analysis.cancel.existing.modal.title"),i=b.getLocalizedString("impact.analysis.cancel.existing.modal.text"),o={command:"force_start"},t(n,i,o);else if(e.basicData.hasImpactAnalysis&&"Completed"===e.basicData.impactAnalysisStatus)n=b.getLocalizedString("impact.analysis.dismiss.existing.modal.title"),i=b.getLocalizedString("impact.analysis.dismiss.existing.modal.text"),o={command:"force_start"},t(n,i,o);else{if(!e.basicData.hasImpactAnalysis&&0===me.CIs&&!e.basicData.impactedService)return E.modal({title:b.getLocalizedString("impact.analysis.noCIs.modal.title"),text:b.getLocalizedString("impact.analysis.noCIs.modal.text"),type:"info",buttons:[{text:b.getLocalizedString("common.labels.ok"),data:!1}]});o={command:"start"},a(o)}}},e.$watch("basicData",function(){if(e.basicData&&(q(),ee(),e.relations=angular.copy(d.cache)),e.basicData&&e.basicData.accessMappings&&e.basicData.accessMappings.impactEditAllowed&&!D.disableImpactAnalysis){var t=R.get("moreActions."+e.type);e.moreDropDownOptions={actions:t,registeredCallbacks:e.moreDropDownActionsCallbackFuncns}}},!0),ve.then(Se),e.$on("$stateChangeStart",function(t,n,i){if(e.dirty){t.preventDefault();var o=E.modal({title:b.getLocalizedString("common.notification.dirty.title"),text:b.getLocalizedString("common.notification.dirty.message"),buttons:[{text:b.getLocalizedString("common.notification.dirty.button1"),data:{stateName:n.name,stateParams:i}},{text:b.getLocalizedString("common.notification.dirty.button2")}]});o.result.then(function(t){if(_.isEmpty(t))s.history.forward(),e.type===EntityVO.TYPE_SERVICEREQUEST&&e.isCrossLaunchRequest&&v.launchAIF(!0,!0,e,e.template.name,e.template.templateObject.crossLaunchURL,e.basicData.customer.id,e.basicData.contact?e.basicData.contact.id:null);else{e.dirty=!1;var n=l.get("$modalStack");n.dismissAll(),a.transitionTo(t.stateName,t.stateParams)}})}}),e.ticketActions={assign:function(t,a,n){var i=a?_.cloneDeep(e.ticket):e.ticket;f.assign(t,a,i,e,n)},assignToMe:function(t,a,n){var i=n?_.cloneDeep(e.ticket):e.ticket;f.assignToMe(t,a,n,i,e)},share:function(){f.share(e.ticket)},follow:function(){return f.follow(e.ticket)},unfollow:function(){return f.unfollow(e.ticket)},showPrintDialog:function(t){f.showPrintDialog(t,e.ticket,me,e.ticket.feed)},editStatus:function(t){f.showEditStatusDialog(e.basicData,!1,!1).result.then(function(a){return t.currentTarget.focus(),c.refreshStatus(e.basicData.id,e.basicData.type,a)},function(){t.currentTarget.focus()}).then(function(){e.$broadcast(y.PROBLEM_UPDATE_TARGET_DATE_EVENT,e.basicData.targetDate),e.$broadcast(y.CLOSE_EDIT_MODE_ON_STATUS_CLOSED_FROM_BLADE,e.basicData.accessMappings),e.$emit(y.TICKET_PROFILE_RESEND_EVENT,{eventName:y.REFRESH_ACTIVITY_FEED})})},editHeader:function(t){if(t){var a;t.summary=t.summary.replace(/\u00a0/g," "),a=[EntityVO.TYPE_INCIDENT,EntityVO.TYPE_PROBLEM,EntityVO.TYPE_KNOWNERROR].indexOf(e.type)>=0?{summary:t.summary,impact:t.impact.name,urgency:t.urgency.name,priority:t.priority.name}:e.type===EntityVO.TYPE_CHANGE?{summary:t.summary}:{summary:t.summary,priority:t.priority.name},e.type!==EntityVO.TYPE_PROBLEM&&e.type!==EntityVO.TYPE_KNOWNERROR||(a.targetDate=moment(t.targetDate).valueOf()),c.editHeader(e.basicData.id,e.type,a).then(function(t){var a=!1;e.basicData.priority!==t.priority&&(a=!0,e.$emit(y.TICKET_PROFILE_RESEND_EVENT,{eventName:y.REFRESH_ACTIVITY_FEED})),e.basicData.targetDate!==t.targetDate&&(a=!0),e.basicData=_.merge(e.basicData,t),a&&c.refreshSLA(e.basicData)},function(){e.type!==EntityVO.TYPE_PROBLEM&&e.type!==EntityVO.TYPE_KNOWNERROR||(t.targetDate=e.basicData.targetDate)})["finally"](function(){e.editHeader=!1})}else e.editHeader=!1},editCustomerCard:function(t){var a={},n={};if(t.length>0){var i=t[0].data;n={site:i.site,phone:i.phone,loginId:i.loginId}}return t.length>1&&(a={phone:t[1].data.phone,loginId:t[1].data.loginId}),c.editCustomerCard(e.basicData.id,e.type,{customer:n,contact:a}).then(function(t){e.basicData=_.assign(e.basicData,t),e.basicData.customer.loginId=n.loginId,e.basicData.contact.loginId=a.loginId})},viewCustomForm:function(){v.launchAIF(!1,!1,e,e.basicData.requestTemplateTitle,e.basicData.crossLaunchURLDisplay)},confirmAction:function(t){f.confirmAction(e.ticket,t,e).then(function(){e.$emit(y.TICKET_PROFILE_RESEND_EVENT,{eventName:y.REFRESH_ACTIVITY_FEED}),f.applyAction(e.ticket,t,e)})},applyAction:function(t){f.applyAction(e.ticket,t,e)},showApprovalList:function(){ue!==EntityVO.TYPE_SERVICEREQUEST&&ue!==EntityVO.TYPE_SBEREQUEST||(_.forEach(e.basicData.approvalSummaries,function(e){e.status.name=e.status.value?e.status.value.split(" ").join("_").toLowerCase():""}),I.showApproversDialog(e.basicData.approvalList,e.basicData))},editPlans:function(){return f.showPlansEditDialog(e.metadata,e.basicData)},showAttachmentPreviewer:function(e){c.showAttachmentPreviewerPopup(e)}},e.toggleFollowingFlag=function(){var t=e.basicData.following?e.ticketActions.unfollow:e.ticketActions.follow;t(e.basicData).then(function(){e.basicData.following=!e.basicData.following})},e.enableHeaderEdit=function(){e.editHeader=!0},e.disableDuplicateOfEdit=function(){e.basicData.status.value="Pending",e.basicData.accessMappings.detailsEditAllowed=!1,e.basicData.accessMappings.statusEditAllowed=!1,e.basicData.accessMappings.relationsEditAllowed=!1},e.hasCustomFields=function(e){var t=h.getPanelById(e);return t&&t.hasCustomFields()},e.editDisabledFor=function(t){return e.activeEditableSectionId&&e.activeEditableSectionId!==t},e.editDatesView=function(){a.go("changeEditDates",{id:e.basicData.id})},e.$on(y.DISABLE_PARENT_EDITMODE,function(t,a){e.$broadcast(y.DISABLE_EDITPARENT,a)}),e.$on(y.DISABLE_EDITMODE,function(t,a){e.$broadcast(y.DISABLE_EDIT,a)}),e.$on(y.DISABLE_CHILD_EDITMODE,function(t,a){e.$broadcast(y.DISABLE_EDITCHILD,a)}),e.clearCategories=function(t){e.$broadcast(y.CLEAR_ALL_CATEGORIES,t)},e.calculateRisk=function(t){"auto"===t&&(e.state.risklevelLoading=!0,c.calculateRisk(e.basicData.id).then(function(t){null===t.riskLevel&&(e.basicData.isCalculateRiskNull=!0),console.log(t.riskLevel);var a=_.findIndex(e.metadata.riskLevels,{name:t.riskLevel});a!==-1?(e.basicData.titleRiskLevelCls="risk-level-"+(a+1),e.basicData.riskLevel=_.find(e.metadata.riskLevels,{name:t.riskLevel})):e.basicData.riskLevel||(e.basicData.titleRiskLevelCls="risk-level-1",e.basicData.riskLevel=e.metadata.riskLevels[0]),e.state.risklevelLoading=!1}))},e.riskLevel=function(){return e.basicData.riskLevel?e.basicData.riskLevel.label:""},e.state=pe,e.relationCounters=me,e.$on(y.AFFECTED_SERVICE_UPDATE_SAVED,function(){e.$broadcast(y.REFRESH_RELATED_ITEM_LIST,{event:y.AFFECTED_SERVICE_UPDATE_SAVED})}),e.$on(y.REFRESH_TICKET_FROM_TITLE_BAR,function(){e.refreshTicket()}),e.$on(y.CHANGE_TO_EDIT_MODE,function(t,a){e.$broadcast(y.CHANGE_TO_EDIT_MODE,a)}),e.$on(y.TOGGLE_EDIT_MODE,B),e.$on(y.EDIT_COMPLETE,U),e.$on(y.SHOW_APPROVERS,e.ticketActions.showApprovalList),e.$on(y.APPROVE_UPDATING_COMPLETE,K),e.$on(y.RESOLVE_TICKET_FROM_RS,j),e.$on(y.MARK_AS_DUPLICATE_OF_FROM_RS,W),e.$on(y.LINKED_CI_SAVE_COMPLETE,U),e.$on(y.SHOW_ASSIGN_TICKET_BLADE,Z),e.$on(y.AFTER_SAVED_CHANGES,X),e.$on(y.TICKET_ASSIGNEES_UPDATED_FROM_BLADE,z),e.$on(y.TICKET_SHOW_LOADER,te),e.$on(y.TICKET_HIDE_LOADER,ae)}])}(),function(){angular.module("ticketModule").factory("ticketModel",["ticketService","relationService","relationModel","$q","personModel","slaCalculatorService","attachmentService","categoriesService","systemAlertService","$filter","metadataModel","userModel","smartRecorderModel","objectValueMapperService",function(e,t,a,n,i,o,r,s,l,c,d,u,p,m){function f(e,t,a,i){var o,s=[];return _.size(e.attachmentToUpload)&&(i===EntityVO.TYPE_TASK?(o=r.uploadAttachment(i,a,e.attachmentToUpload).then(function(e){e&&e.length?(_.each(e,function(e){e.attachmentReference.dataSourceId=a,e.id=e.attachmentReference.attachmentId}),t=t&&t.length?t.concat(e):e):t=e}),s.push(o)):_.each(e.attachmentToUpload,function(e){o=r.uploadAttachment(i,a,e).then(function(e){_.size(e)&&t.push(e[0])}),s.push(o)})),s.length>0?n.all(s).then(function(e){return v.cache[a]&&(v.cache[a].attachments=t),angular.copy(v.cache[a])})["catch"](function(e){return e}):v.cache[a]}function g(e,t){var a={};if(e.isDraft=!1,_.isEmpty(e.attachments))return a.ticketData=t,a;var i=[];return _.each(e.attachments,function(a){var n=r.uploadAttachment(e.type,t.id,a);i.push(n)}),n.all(i).then(function(e){return a={attachments:e,ticketData:t}})["catch"](function(e){return a.ticketData=t,setTimeout(function(){l.error({text:e&&e.data&&e.data.error||e,clear:!1})}),a})}function h(e,t){var a=(new ChangeTemplateVO).build(e);return a.allCategories=s.populateCategories(a.categorizations,t),a}function y(e,t){var a=(new ReleaseTemplateVO).build(e);return a.allCategories=s.populateCategories(a.categorizations,t),a}function E(e){var t="common.relationship.type."+e,a=c("i18n")(t);return a!==t?a:e}var v={dataCache:{},cache:{}},T=moment.duration(2,"minutes").valueOf(),S=[];return v.getTicketDetails=function(t,a){return e.getBasicInformation(t,a)},v.getTicketAttachments=function(e,t){return EntityVO.hasAttachments(t)?r.getAttachmentsInfo(e,t):n.when([])},v.calculateRisk=function(t){return e.getReleaseRisk(t)},v.getTicket=function(t,a,i){if(!v.cache[t]||v.cache[t]&&a&&v.cache[t].type!==a||i)return v.cache[t]=n.all([e.getBasicInformation(t,a),v.getTicketAttachments(t,a)]).then(function(e){var i=e[0];if(a===EntityVO.TYPE_CHANGE||a===EntityVO.TYPE_RELEASE){var o=d.cache[a]||{},r=o.documentTypes?n.when(o):_.has(o,"$$state.status")&&o;r&&r.then(function(t){Array.isArray(t)&&(t=_.find(t,{metadatatype:a}));var n=t&&t.documentTypes;i.plans=e[1],n&&_.each(i.plans,function(e){var t=_.find(n,{index:e.workNote.workNoteTypeId});e.workNote.documentType=t})})}else i.attachments=e[1];return v.cache[t]=i,v.cache[t]}),n.when(v.cache[t]);var o=_.has(v.cache[t],"$$state.status");return n.when(o?v.cache[t]:angular.copy(v.cache[t]))},v.update=function(t,a,i,o){function s(e,i){return _.size(e.attachmentToDelete)?(_.each(e.attachmentToDelete,function(e){i=_.reject(i,function(t){return t.attachmentReference.dataSourceId===e.attachmentReference.dataSourceId&&t.attachmentReference.attachmentId===e.attachmentReference.attachmentId}),l.push(r.deleteAttachment(a,{dataSourceId:e.attachmentReference.dataSourceId,attachmentId:e.attachmentReference.attachmentId}))}),n.all(l).then(function(){return v.cache[t].attachments=i,f(e,i,t,a)})):f(e,i,t,a)}var l=[],c=m.getFieldByName("desc"),d=c&&c.getValue()||{};if(i.loginId&&d&&(d.attachmentToUpload||d.attachmentToDelete)){var u=v.cache[t]&&v.cache[t].attachments?_.reject(v.cache[t].attachments,{pendingSave:!0}):[];return s(d,u).then(function(){return u=v.cache[t].attachments,e.update(t,a,i,o).then(function(e){return _.assign(v.cache[t],e),v.cache[t].attachments=u,angular.copy(v.cache[t])})})["catch"](function(e){return e})}return e.update(t,a,i,o).then(function(e){_.assign(v.cache[t],e);var a=m.getFieldByName("desc"),n=a&&a.getValue()||{},i=v.cache[t]&&v.cache[t].attachments?_.reject(v.cache[t].attachments,{pendingSave:!0}):[];return s(n,i)})["catch"](function(e){return e})},v.getTicketAssigneePersons=function(t,a,n,i){return e.getAssigneeSupportGroupPersons(i||"","","",u.userId,a,"",n,"","","","",!0)},v.getTicketAssigneePersonsBySearchText=function(t,a,n,i,o,r){return e.getAssigneeSupportGroupPersons("","",u.userFullData&&u.userFullData.fullName||"",u.userId,t,null,a,n,i,o,r,!0,!0)},v.getTicketWithAsyncRelations=function(e,t){return a.getRelations(e,t),v.getTicket(e,t)},v.getARMessageInformation=function(t,a){return e.getARMessageInformation(t,a)},v.getTicketForPreview=function(e,t){return v.cache[e]&&moment().valueOf()-v.cache[e].syncTime>T&&delete v.cache[e],v.getTicket(e,t)},v.getDraft=function(t,a,i,o,r,s,l){if(!_.isEmpty(v.cache.draft)){if(!_.isEmpty(v.cache.relatedDraft)){var c=v.cache.relatedDraft;return c.fromType===EntityVO.TYPE_ASSET?e.getRelatedDraftFromAsset(c.type,c.fromContext):e.getDraftForRelated(c.type,c.fromType,c.id)}return n.when(v.cache.draft)}if(t===EntityVO.TYPE_WORKORDER){var d={};return s||l?(d.customer=s,d.contact=l):d=p.smartRecorderData,e.getDraftWorkOrder(t,a,i,r?null:d)}return e.getDraft(t,a,i,o,s)},v.saveDraft=function(t,a){return t===EntityVO.TYPE_INCIDENT&&a.serviceType&&(a.serviceType=a.serviceType),e.saveDraft(t,a).then(function(e){return g(a,e)})},v.saveQuickTicketDraft=function(t,a){return t===EntityVO.TYPE_INCIDENT&&a.serviceType&&(a.serviceType=a.serviceType),e.saveQuickTicketDraft(t,a).then(function(e){return g(a,e)})},v.getFullPersonData=function(e){var t=v.cache[e];return i.getListOfPersonByName(t.customer.firstName,t.customer.lastName).then(function(e){e.length&&(t.customer=e[0])})},v.getAttachmentsInfo=function(e,t){return r.getAttachmentsInfo(e,t).then(function(e){return e})["catch"](function(e){return e})},v.updateStatus=function(t,a,i){return e.updateStatus(t,a,i)["catch"](function(e){return e&&l.error({text:e.data.error,clear:!1}),n.reject(e)})},v.refreshStatus=function(e,t,a,n){n=n||v.cache[e];var i=d.cache[t];if(n.status.value=_.find(i.statuses,{name:a.status}).name,n.status.reason=a.statusReason,n.milestone=a.milestone,n.resolution=a.resNote,!_.isEmpty(a.updatedTickets)){var o=_.find(a.updatedTickets,function(t){return t.id===e});n.accessMappings=o.accessMappings,n.modifiedDate=o.modifiedDate,t===EntityVO.TYPE_CHANGE?(n.scheduledStartDate=o.scheduledStartDate?new Date(o.scheduledStartDate):null,n.scheduledEndDate=o.scheduledEndDate?new Date(o.scheduledEndDate):null,n.actualStartDate=o.actualStartDate?new Date(o.actualStartDate):null,n.actualEndDate=o.actualEndDate?new Date(o.actualEndDate):null,n.targetDate=o.targetDate?new Date(o.targetDate):null,n.managerGroup=o.managerGroup,n.manager=o.manager,n.isInApproval=o.isInApproval,n.isInApproval&&(n.accessMappings.statusEditAllowed=!0),n.status.value=_.find(i.statuses,{name:o.status.value}).name):t===EntityVO.TYPE_RELEASE?(n.scheduledStartDate=o.scheduledStartDate?new Date(o.scheduledStartDate):null,n.scheduledEndDate=o.scheduledEndDate?new Date(o.scheduledEndDate):null,n.actualStartDate=o.actualStartDate?new Date(o.actualStartDate):null,n.actualEndDate=o.actualEndDate?new Date(o.actualEndDate):null,n.targetDate=o.targetDate?new Date(o.targetDate):null,n.isInApproval=o.isInApproval,n.isInApproval&&(n.accessMappings.statusEditAllowed=!0),n.status.value=_.find(i.statuses,{name:o.status.value}).name):t===EntityVO.TYPE_PROBLEM&&(n.coordinator=o.coordinator,n.coordinatorGroup=o.coordinatorGroup,n.assignee=o.assignee,n.completedDate=o.completedDate,n.supportGroup=o.supportGroup,n.targetDate!==o.targetDate&&(n.targetDate=o.targetDate,n.SLA=o.SLA,v.refreshSLA(n)))}if(t!==EntityVO.TYPE_OUTAGE&&v.refreshSLA(n),t===EntityVO.TYPE_INCIDENT&&n.isClosed()){_.each(a.resCategorizations,function(e){var t=_.findIndex(n.resCategorizations,{name:e.name});t>-1?n.resCategorizations[t]=e:n.resCategorizations.push(e)}),_.each(a.categorizations,function(e){var t=_.findIndex(n.categorizations,{name:e.name});t>-1?n.categorizations[t]=e:n.categorizations.push(e)});var r=_.cloneDeep(n.categorizations);n.resCategorizations&&_.each(n.resCategorizations,function(e){var t=_.findIndex(n.categorizations,{name:e.name});t>-1?(n.categorizations[t]=e,r[t]=e):r.push(e)}),n.allCategories=s.populateCategories(r,i),n.noCategories=_.filter(n.allCategories,"valueToShow").length}},v.applyAction=function(t,a,i,o){return e.applyAction(t,a,i,o)["catch"](function(e){return e&&l.error({text:e.data.error,clear:!1}),n.reject(e)})},v.editHeader=function(t,a,n){return e.editHeader(t,a,n)},v.editCustomerCard=function(t,a,n){return e.editCustomerCard(t,a,n)},v.getPriority=function(t,a,n,i){return e.getPriority(t,a,n,i)},v.getChangePriority=function(t,a,n){return e.getChangePriority(t,a,n)},v.getChangeRiskRules=function(t){return e.getChangeRiskRules(t)},v.getIncidentRules=function(t){return e.getIncidentRules(t)},v.getReleasePriority=function(t,a,n){return e.getReleasePriority(t,a,n)},v.getAvailableStatuses=function(t,a){return e.getAvailableStatuses(t,a)},v.refreshSLA=function(e){e.SLA&&(e.isClosed()&&(e.resolvedDate=1e3*moment().unix()),e.SLA.slaProgressBarValid=!1,"full"===e.SLA.slaRenderType?o.getAndCalculateSLA(e):"partial"===e.SLA.slaRenderType&&o.calculate(e))},v.groupRelatedItems=function(e){_.each(e,function(e){e.relationshipType=e.relationshipClassId||e.relationshipType,e.relationshipTypeLabel=E(e.relationshipType)});var t=_.sortBy(e,"relationshipTypeLabel"),a=_.groupBy(t,"relationshipTypeLabel"),n=[];for(var i in a)a.hasOwnProperty(i)&&n.push({relationshipType:i,limit:4,items:a[i]});return n},v.showAttachmentPreviewerPopup=function(e){r.showAttachmentPreviewDialog(e)},v.getTaskPhases=function(t,a){if(!t)return n.when({error:"Missing required parameter"});var i=_.find(S,{company:t});if(!i){var o=e.getTaskPhases({companyName:t,isTemplate:a}).then(function(e){return i.phases=e,e});i={phases:o,company:t},S.push(i)}return n.when(i.phases)},v.getFutureTaskPhases=function(e,t){return e?v.getTaskPhases(e).then(function(e){var a=_.findIndex(e,{guid:t});return(e||[]).slice(a)}):n.when({error:"Missing required parameter"})},v.getImpactAnalysisVisualisationData=function(t,a){return e.getImpactAnalysisVisualisationData(t,a).then(function(e){return e[0].items[0]||{}})},v.getImpactAnalysisStatus=function(t,a){return e.getImpactAnalysisStatus(t,a).then(function(e){return e})},v.impactAnalysisAction=function(t,a,n){if(t&&a)return e.impactAnalysisAction(t,a,n).then(function(e){return e})["catch"](function(e){e&&l.error({text:e.data&&e.data.error||e,clear:!0})})},v.getURLforTaskFlow=function(t,a){if(t)return e.getURLforTaskFlow(t,a).then(function(e){return window.open(e.url,"_blank"),e})["catch"](function(e){e&&l.error({text:e.data&&e.data.error||e,clear:!0})})},v.saveImpactedAreas=function(t,a,i){var o;return i&&i.length>0?(o=e.saveImpactedAreas(t,a,i),o["catch"](function(e){e&&l.error({text:e.data&&e.data.defaultMessage||e.data&&e.data.error||e,clear:!0})}),o):n.when(1)},v.deleteImpactedAreas=function(t,a,i){return i&&i.length>0?e.deleteImpactedAreas(t,a,i):n.when(1)},v.getRootCause=function(t,a){var n={company:a,depends:t.depends};return e.getRootCause(n)},v.getRecentlyUsedChangeTemplates=function(t,a){var n=a,i=[];return _.each(t,function(e){i.push({id:e.id,company:e.company,name:e.name})}),e.getRecentlyUsedChangeTemplates(i).then(function(e){var t=e[0].items[0].objects;return _.map(t,function(e){return h(e,n)})})},v.getRecentlyUsedReleaseTemplates=function(t,a){var n=a,i=[];return _.each(t,function(e){i.push({id:e.id,company:e.company,name:e.name})}),e.getRecentlyUsedReleaseTemplates(i).then(function(e){var t=e[0].items[0].objects;return _.map(t,function(e){return y(e,n)})})},v.getVendorInfo=function(t,a){return e.getVendorInfo(t,a).then(function(e){return _.each(e,function(e){e&&_.isString(e.vendorTicketUrl)&&(e.vendorTicketUrl=decodeURIComponent(e.vendorTicketUrl))}),e})},v.getGUIDByDisplayID=function(t,a){return e.getGUIDByDisplayID(t,a)},v}])}(),function(){angular.module("ticketModule").controller("TicketProfileController",["$scope","$state","ticketModel","$timeout","historyModel","events","systemAlertService","configurationModel","objectValueMapperService","metadataModel","$stateParams",function(e,t,a,n,i,o,r,s,l,c,d){e.id=t.params.id,e.type=t.current.name,e.ticket={},e.progress={},e.state={},e.isActive=[{active:!0},{active:!1}],e.activityNote={},e.isNoteRequired=!1,l.clearMap(e.type),"task"===e.type||"outage"===e.type||s.isServerApplicationEnabled(e.type)||t.go("unauthorized"),c.getMetadataByType("global").then(function(a){var n="T"===a.configurationParameters["Enable-Progressive-Views"]||"true"===a.configurationParameters["Enable-Progressive-Views"];n="T"!==localStorage.getItem("overridePV")&&n,n&&localStorage.getItem("midtierUrl")&&s.get("pwaEnabledTickets.tickets").indexOf(e.type)>=0&&t.go(e.type+"PV",{id:d.id},{inherit:!1})})["catch"](function(e){e&&r.error({text:e.data.error,clear:!1})}),e.$on(o.TICKET_BASIC_DATA_LOADED,function(t,a){i.addToHistory(EntityVO.TYPE_TICKET,a.ticket),e.ticket=a.ticket,e.state.loadResources=!!e.isActive[1].active}),e.$on(o.TICKET_PROFILE_RESEND_EVENT,function(t,a){t.stopPropagation(),e.$broadcast(a.eventName,a.data)}),e.$on(o.SHOW_PROGRESS_MODAL_FOR_EDIT,function(t,a){a&&(e.progress.title=a.title||"",e.progress.text=a.text||"",e.progress.cssClass=a.cssClass||"",e.state.showProgressModal=a.showModal)}),e.$on(o.REFRESH_TICKET,function(t,a){e.$broadcast(o.REFRESH_ACTIVITY_FEED),e.$broadcast(o.REFRESH_RESOURCE_FEED,a)}),e.$on(o.SELECT_RESOURCE_TAB,function(){e.isActive[0].active=!1,e.state.loadResources=e.isActive[1].active=!0}),e.$on(o.SELECT_ACTIVITY_TAB,function(){e.isActive[0].active=!0,e.state.loadResources=e.isActive[1].active=!1}),e.$on(o.SAVE_COPY_CHANGE_DRAFT,function(){e.$broadcast(o.SAVE_COPY_CHANGE_ACTIVITY)}),e.loadResources=function(){e.state.loadResources=!0}}])}(),function(){angular.module("ticketModule").service("ticketService",["$resource","$http","systemAlertService","$q","slaCalculatorService","approvalService","$filter","$state",function(e,t,a,n,i,o,r,s){function l(e){_.forEach(e,function(e){"Note"===e.type?a.info({text:e.message,hide:15e3}):"Warning"===e.type&&a.warning({text:e.message,hide:15e3})})}function c(e,t){var a=t;return e===EntityVO.TYPE_TASK?a=(new TaskVO).build(a):e===EntityVO.TYPE_INCIDENT?a=(new IncidentVO).build(a):e===EntityVO.TYPE_WORKORDER?a=(new WorkOrderVO).build(a):e===EntityVO.TYPE_SERVICEREQUEST?(a=(new ServiceRequestVO).build(a),o.getApprovals(a)):e===EntityVO.TYPE_SBEREQUEST?a=(new SbeRequestVO).build(a):e===EntityVO.TYPE_OUTAGE?a=(new OutageVO).build(a):e===EntityVO.TYPE_CHANGE?a=(new ChangeVO).build(a):e===EntityVO.TYPE_RELEASE?a=(new ReleaseVO).build(a):e===EntityVO.TYPE_ACTIVITY?a=(new ActivityVO).build(a):e===EntityVO.TYPE_KNOWNERROR?a=(new KnownErrorVO).build(a):e===EntityVO.TYPE_PROBLEM?a=(new ProblemVO).build(a):e===EntityVO.TYPE_KNOWLEDGE?a=(new KnowledgeArticleVO).build(a):e===EntityVO.TYPE_DLP&&(a=(new DLPVO).build(a)),a.status&&a.serviceTargets&&a.serviceTargets.length>0&&i.processServiceTarget(a,a.serviceTargets),a}function d(e,t,a){var n,i=e.map(function(e){return(new PersonVO).build(e)});n=_.uniqBy(i,function(e){return e.loginId+"*"+e.supportGroupId});var o={};return o.results=n,o.totalMatches=t,o.exceedsChunkSize=a,o}function u(e,t){var a,n=e.map(function(e){return(new PersonVO).build(e)});a=_.uniqBy(n,function(e){return e.loginId+"*"+e.supportGroupId});var i={};return i.results=a,i.exceedsChunkSize=t,i}var p=e("",{},{assignTickets:{url:"/smartit/rest/bulkupdate/assignee/",method:"POST",isArray:!0},bulkUpdate:{url:"/smartit/rest/v2/bulkupdate/all",method:"POST",isArray:!0},getBasicInformation:{url:"/smartit/rest/:type/:id",method:"GET",isArray:!0},getBasicInformation_v2:{url:"/smartit/rest/v2/:type/:id",method:"GET",isArray:!0},getARMessageInformation:{url:"/smartit/rest/ticket/:type/:id",method:"GET",isArray:!0},getAttachmentsInfo:{url:"/smartit/rest/attachment/info/:type/:id",method:"GET",isArray:!0},updateStatus:{url:"/smartit/rest/:type/status/:id",method:"PUT",isArray:!1},update:{url:"/smartit/rest/:type/all/:id",method:"PUT",isArray:!0},update_v2:{url:"/smartit/rest/v2/:type/all/:id",method:"PUT",isArray:!0},getDraft:{url:"/smartit/rest/:type/draft",method:"GET",isArray:!0},getDraft_v2:{url:"/smartit/rest/v2/:type/draft",method:"GET",isArray:!0},getDraft_v3:{url:"/smartit/rest/v3/:type/draft",method:"GET",isArray:!0},getDraft_WO_v2:{url:"/smartit/rest/v2/workorder/draft",method:"POST",isArray:!0},saveDraft:{url:"/smartit/rest/:type",method:"POST",isArray:!0},saveDraft_v2:{url:"/smartit/rest/v2/:type",method:"POST",isArray:!0},getPriority:{url:"/smartit/rest/:type/calculatepriority",method:"GET",isArray:!0},getChangePriority:{url:"/smartit/rest/change/calculatepriority",method:"GET",isArray:!0},getChangeRiskRules:{url:"/smartit/rest/change/config/changerules",method:"GET",isArray:!0},getIncidentRules:{url:"/smartit/rest/incident/config/rules",method:"GET",isArray:!0},getReleasePriority:{url:"/smartit/rest/release/calculatepriority",method:"GET",isArray:!0},getReleaseRisk:{url:"/smartit/rest/release/:id/calculateRisk",method:"GET",isArray:!1},getGroupMembers:{url:"/smartit/rest/person/supportgrouppersons/:groupId?:params",method:"GET",isArray:!0},getSupportGroupPersons:{url:"/smartit/rest/person/supportgrouppersons",method:"GET",isArray:!0},applyAction:{url:"/smartit/rest/:type/action/:action/:id",method:"POST",isArray:!0},getAvailableStatuses:{url:"/smartit/rest/:type/availablestatuses/:id",method:"GET",isArray:!0},getTaskPhases:{url:"/smartit/rest/change/taskphases",method:"GET",isArray:!0},getDraftForRelated:{url:"/smartit/rest/ticket/create/:type/from/:fromType/:id",method:"POST",isArray:!0},getRelatedDraftFromAsset:{url:"/smartit/rest/ticket/create/:type/from/asset",method:"POST",isArray:!0},saveImpactedAreas:{method:"POST",isArray:!1,url:"/smartit/rest/impactedarea/:type/:id"},getRootCause:{method:"GET",isArray:!0,url:"/smartit/rest/category/problem/rootcause/rootcauseList"},getImpactAnalysis:{method:"GET",isArray:!0,url:"/smartit/rest/asset/impact/:type/:id?returnRelationships=true"},getImpactAnalysisMock:{method:"GET",isArray:!0,url:"mocks/impact-analysis-large.json"},getImpactAnalysisStatus:{method:"GET",isArray:!0,url:"/smartit/rest/asset/impactjob/:type/:id"},impactAnalysisAction:{method:"POST",isArray:!0,url:"/smartit/rest/asset/impactjob/:type/:id"},getAssigneeSupportGroupPersons:{url:"/smartit/rest/person/assignment/supportgrouppersons",method:"POST",isArray:!0},getRecentlyUsedChangeTemplates:{url:"/smartit/rest/change/recentTemplate",method:"POST",isArray:!0},getRecentlyUsedReleaseTemplates:{url:"/smartit/rest/release/recentTemplate",method:"POST",isArray:!0},getURLforTaskFlow:{url:"/smartit/rest/task/taskFlowURL/:id",method:"POST",isArray:!1,responseType:"text",transformResponse:function(e){var t=e;return e={},e.url=t,e}},getVendorInfo:{url:"/smartit/rest/mcsm/:type/remedy/:displayId",method:"GET",isArray:!1},copyChange:{url:"/smartit/rest/ticket/create/change/from/change/:ticketId",method:"POST",isArray:!0},getGUIDByDisplayID:{url:"/smartit/rest/:type/displayid/:id",method:"GET",isArray:!0}});this.assignTickets=function(e){return p.assignTickets(e).$promise},this.getARMessageInformation=function(e,t){return p.getARMessageInformation({id:e,type:t}).$promise.then(function(e){l(e[0].items[0])})},this.getBasicInformation=function(e,t){var a=t===EntityVO.TYPE_INCIDENT?p.getBasicInformation_v2:p.getBasicInformation;return a({id:e,type:t}).$promise.then(function(e){var a=c(t,e[0].items[0]);return a.syncTime=e[0].syncTime,a})},this.getDraft=function(e,t,a,n,i){var o=e===EntityVO.TYPE_INCIDENT?p.getDraft_v3:p.getDraft,r={type:e};return t&&(r.templateId=t),a&&(r.draftSummary=a),n&&(r.companyName=n),i&&(r.customerId=i.loginId),o(r).$promise.then(function(t){return c(e,t[0].items[0])})},this.getDraftWorkOrder=function(e,t,a,n){var i=p.getDraft_WO_v2,o={type:e};return t&&(o.templateId=t),a&&(o.summary=a),n&&(n.contact&&(o.contact=n.contact),n.customer&&(o.customer=n.customer),n.template&&(o.templateName=n.template.name)),i(o).$promise.then(function(t){return c(e,t[0].items[0])})},this.getAttachmentsInfo=function(e,t){return p.getAttachmentsInfo({id:e,type:t}).$promise.then(function(e){return e[0].items.length?e[0].items:[]})},this.updateStatus=function(e,t){return p.bulkUpdate({ids:e,attributeValueMap:t}).$promise.then(function(t){for(var n=[],i=0;i<e.length;i++){var o=t[0].items[i].statusInfo;o&&"Warning"===o.type&&a.warning({text:o.message,hide:1e4}),o&&"Failure"===o.type?a.error({
text:o.message,clear:!1}):n.push(c(e[i].type,t[0].items[i].responseObject))}if(0===n.length)throw"";return n})},this.update=function(e,t,i,o){var l=t===EntityVO.TYPE_INCIDENT?p.update_v2:p.update;return l({id:e,type:t},i).$promise.then(function(e){if(e[0].items[0].statusInfo&&"Warning"===e[0].items[0].statusInfo.type&&3e3!==e[0].items[0].statusInfo.number){if(a.warning({text:e[0].items[0].statusInfo.message,displayOnStateChange:!0}),e[0].items[0].responseObject)return c(t,e[0].items[0].responseObject)}else{if(e[0].items[0].responseObject)return c(t,e[0].items[0].responseObject);e[0].items[0].statusInfo&&3e3===e[0].items[0].statusInfo.number&&a.modal({title:r("i18n")("common.notification.dirty.title"),text:e[0].items[0].statusInfo.message,type:"warning",buttons:[{text:r("i18n")("common.button.continue")}]}).result.then(function(){s.go("dashboard")})}return{}})["catch"](function(e){return o||a.error({text:e.data.error,clear:!1}),n.reject(e)})},this.editHeader=function(e,t,a){return this.update(e,t,a)},this.editCustomerCard=function(e,t,a){return this.update(e,t,a)},this.saveDraft=function(e,t){var a=e===EntityVO.TYPE_INCIDENT?p.saveDraft_v2:p.saveDraft;return a({type:e},t).$promise.then(function(e){return e[0].items[0]})},this.saveQuickTicketDraft=function(e,t){var a=e===EntityVO.TYPE_INCIDENT?p.saveDraft_v2:p.saveDraft,n={quickCreateMode:!0};return a({type:e,criteria:n},t).$promise.then(function(e){return e[0].items[0]})},this.getPriority=function(e,t,a,n){return p.getPriority({type:n,companyName:e,impact:t,urgency:a}).$promise.then(function(e){return e[0].items[0]||[]})},this.getChangePriority=function(e,t,a){return p.getChangePriority({companyName:e,impact:t,urgency:a}).$promise.then(function(e){return e[0].items[0]||[]})},this.getChangeRiskRules=function(e){return p.getChangeRiskRules({companyName:e}).$promise.then(function(e){return e[0].items[0]||[]})},this.getIncidentRules=function(e){return p.getIncidentRules({companyName:e}).$promise.then(function(e){return e[0].items[0]||[]})},this.getReleasePriority=function(e,t,a){return p.getReleasePriority({companyName:e,impact:t,urgency:a}).$promise.then(function(e){return e[0].items[0]||[]})},this.getReleaseRisk=function(e){return p.getReleaseRisk({id:e}).$promise.then(function(e){return e})},this.getGroupMembers=function(e,t){return p.getGroupMembers({groupId:e,params:t,thumbnail:!0}).$promise.then(function(e){return u(e[0].items[0].objects,!0)})},this.getAssigneeSupportGroupPersons=function(e,t,a,n,i,o,r,s,l,c,m,f,g){var h={companyName:e},y={};return t&&(h.organization=t),a&&(y.searchText=a),n&&(h.personLoginId=decodeURIComponent(n)),i&&(h.role=i),o&&(y.chunkInfo={startIndex:0,chunkSize:o}),r&&(h.customerCompany=r),s&&(h.locationCompany=s),angular.isDefined(l)&&(h.ownerCompany=l),c&&(h.primaryCompany=c),m&&(h.authorCompany=m),h.available=f,p.getAssigneeSupportGroupPersons(y,h).$promise.then(function(e){return!_.isUndefined(g)&&g?d(e[0].items[0].objects,e[0].items[0].totalMatches,e[0].items[0].exceedsChunkSize):u(e[0].items[0].objects,e[0].items[0].exceedsChunkSize)})},this.getPersonsBySupportCompanyAndOrg=function(e,t,a,n,i,o,r,s,l,c){var m={companyName:e,thumbnail:!0};return t&&(m.organization=t),a&&(m.personText=a),n&&(m.role=n),i&&(m.chunkInfo={startIndex:0,chunkSize:i}),o&&(m.customerCompany=o),r&&(m.locationCompany=r),angular.isDefined(s)&&(m.ownerCompany=s),l&&(m.primaryCompany=l),p.getSupportGroupPersons(m).$promise.then(function(e){return!_.isUndefined(c)&&c?d(e[0].items[0].objects,e[0].items[0].totalMatches,e[0].items[0].exceedsChunkSize):u(e[0].items[0].objects,e[0].items[0].exceedsChunkSize)})},this.getAssigneeBySupportGroupId=function(e,t,a,n,i,o,r,s,l,c,m,f){var g={supportGroupId:e},h={};return t&&(h.searchText=t),a&&(g.personLoginId=a),n&&(g.customerCompany=n),l&&(g.locationCompany=l),angular.isDefined(c)&&(g.ownerCompany=c),angular.isDefined(m)&&(g.authorCompany=m),i&&(g.role=i),o&&(h.chunkInfo={startIndex:0,chunkSize:o}),s&&(g.primaryCompany=s),g.available=r,p.getAssigneeSupportGroupPersons(h,g).$promise.then(function(e){return!_.isUndefined(f)&&f?d(e[0].items[0].objects,e[0].items[0].totalMatches,e[0].items[0].exceedsChunkSize):u(e[0].items[0].objects,e[0].items[0].exceedsChunkSize)})},this.getPersonsBySupportGroupId=function(e,t,a,n,i){var o={supportGroupId:e,thumbnail:!0};return t&&(o.personText=t),a&&(o.role=a),n&&(o.chunkInfo={startIndex:0,chunkSize:n}),p.getSupportGroupPersons(o).$promise.then(function(e){return!_.isUndefined(i)&&i?d(e[0].items[0].objects,e[0].items[0].totalMatches,e[0].items[0].exceedsChunkSize):u(e[0].items[0].objects,e[0].items[0].exceedsChunkSize)})},this.applyAction=function(e,t,a,n){return p.applyAction({id:e,type:t,action:a},n).$promise},this.getAvailableStatuses=function(e,t){return p.getAvailableStatuses({id:e,type:t}).$promise.then(function(e){return e[0].items||[]})},this.getTaskPhases=function(e){return p.getTaskPhases(e).$promise.then(function(e){return e[0].items})},this.getDraftForRelated=function(e,t,a,n){var i={id:a,fromType:t,type:e};return n&&(i.templateId=n),p.getDraftForRelated(i,{}).$promise.then(function(t){return c(e,t[0].items[0])})},this.getRelatedDraftFromAsset=function(e,t,a){var n={type:e};return a&&(n.templateId=a),delete t.accessMappings,delete t.allCategories,delete t.lifecycleDates,p.getRelatedDraftFromAsset(n,t).$promise.then(function(t){return c(e,t[0].items[0])})},this.saveImpactedAreas=function(e,t,a){return p.saveImpactedAreas({id:e,type:t},a).$promise},this.deleteImpactedAreas=function(e,i,o){return t({method:"DELETE",headers:{"Content-Type":"application/json"},url:"/smartit/rest/impactedarea/"+i+"/"+e,data:o})["catch"](function(e){return a.error({text:e.data&&(e.data.defaultMessage||e.data.error),clear:!1}),n.reject(e)})},this.getRootCause=function(e){return p.getRootCause({criteria:e}).$promise.then(function(e){for(var t=[],a=0;a<e[0].items[0].length;a++)t.push({name:e[0].items[0][a],label:e[0].items[0][a]});return t})},this.getImpactAnalysisVisualisationData=function(e,t){return p.getImpactAnalysis({id:t,type:e}).$promise},this.getImpactAnalysisStatus=function(e,t){return p.getImpactAnalysisStatus({id:e,type:t}).$promise.then(function(e){return e[0].items[0]||[]})},this.impactAnalysisAction=function(e,t,a){return p.impactAnalysisAction({id:e,type:t},a).$promise.then(function(e){return e[0].items[0]||[]})},this.getRecentlyUsedChangeTemplates=function(e){return p.getRecentlyUsedChangeTemplates({templateList:e}).$promise},this.getRecentlyUsedReleaseTemplates=function(e){return p.getRecentlyUsedReleaseTemplates({templateList:e}).$promise},this.getURLforTaskFlow=function(e,t){return p.getURLforTaskFlow({id:e},t).$promise},this.getVendorInfo=function(e,t){return p.getVendorInfo({displayId:e,type:t}).$promise.then(function(e){return e&&e.tickets||[]})},this.copyChange=function(e,t){return p.copyChange({ticketId:e},t).$promise.then(function(e){return c("change",e[0].items[0])})},this.getGUIDByDisplayID=function(e,t){return p.getGUIDByDisplayID({type:e,id:t}).$promise.then(function(e){return e[0].items[0]&&e[0].items[0].id||void 0})}}])}(),function(){angular.module("ticketModule").directive("ticketTasks",["ticketModel","relationModel","userModel","$q","$filter","$modal","events","$timeout","$state","i18nService","systemAlertService","objectValueMapperService","pwaModel",function(e,t,a,n,i,o,r,s,l,c,d,u,p){return{restrict:"E",templateUrl:"views/ticket/ticket-tasks.html",scope:{ticket:"=",relationCounters:"=",tasksDisabled:"="},link:function(n,m){function f(){for(var e=[],t=0;t<arguments.length;t++)arguments[t]instanceof Array?e.push.apply(e,f.apply(this,arguments[t])):e.push(arguments[t]);return e}function g(e,t){"Assigned"===e.realObject.status.value&&t.push(e.realObject.mainSequence)}function h(e){var t=[];return _.forEach(e,function(e){e.length?_.forEach(e,function(e){g(e,t)}):g(e,t)}),t}function y(e,t,a){var n,i=!0;if(!isNaN(t)&&t<a)for(n=t;n<a;n++)e[n]&&e[n].length?i=y(e[n],0,e[n].length):"Staged"!==e[n].realObject.status.value&&"Cancelled"!==e[n].realObject.status.reason&&"Pending"!==e[n].realObject.status.value&&(i=!1);else for(n=a;n<t;n++)e[n]&&e[n].length?i=y(e[n],0,e[n].length):"Staged"!==e[n].realObject.status.value&&"Cancelled"!==e[n].realObject.status.reason&&"Pending"!==e[n].realObject.status.value&&(i=!1);return i}function E(e,t){e.realObject.childSequence=t+"."+e.realObject.sequence}function v(){n.$on("$stateChangeStart",function(e,t,a){if(n.dirty){e.preventDefault();var i=d.modal({title:c.getLocalizedString("common.notification.dirty.title"),text:c.getLocalizedString("common.notification.dirty.message"),buttons:[{text:c.getLocalizedString("common.notification.dirty.button1"),data:{stateName:t.name,stateParams:a}},{text:c.getLocalizedString("common.notification.dirty.button2")}]});i.result.then(function(e){_.isEmpty(e)||(n.dirty=!1,l.transitionTo(e.stateName,e.stateParams))})}})}function T(){p.taskFrom="Scratch",e.taskParent=n.ticket;var t=o.open({templateUrl:"views/create/create-taskPV-v2.html",controller:"PwaTicketController",windowClass:"ticket__open-modal",backdrop:!1,keyboard:!1});t.result.then(function(){A(),m.find("button.profile-relation__add-relation-button").focus(),n.$emit(r.TICKET_PROFILE_RESEND_EVENT,{eventName:r.REFRESH_ACTIVITY_FEED}),n.$emit(r.RELATIONS_UPDATE_COMPLETE,!0)},function(){m.find("button.profile-relation__add-relation-button").focus()});var a=n.$on(r.PWA_TASK_MODAL,function(e,n){n.taskCreated?t.close():t.dismiss(),a()})}function S(){e.taskParent=n.ticket,u.shelveAsParent(n.ticket.type);var t=o.open({templateUrl:"views/create/create-task-v2.html",controller:"CreateTaskV2Controller",windowClass:"ticket__open-modal",backdrop:!1,keyboard:!1});t.result.then(function(){u.unshelveParent(n.ticket.type),A(),m.find("button.profile-relation__add-relation-button").focus(),n.$emit(r.TICKET_PROFILE_RESEND_EVENT,{eventName:r.REFRESH_ACTIVITY_FEED}),n.$emit(r.RELATIONS_UPDATE_COMPLETE,!0)},function(){u.unshelveParent(n.ticket.type),m.find("button.profile-relation__add-relation-button").focus()})}function C(){p.taskFrom="Template",e.taskParent=n.ticket;var t=o.open({templateUrl:"views/create/create-taskPV-v2.html",windowClass:"action-blade",controller:"PwaTicketController",backdrop:"custom"});t.result.then(function(){A(),m.find("button.profile-relation__add-relation-button").focus(),n.$emit(r.TICKET_PROFILE_RESEND_EVENT,{eventName:r.REFRESH_ACTIVITY_FEED})},function(){m.find("button.profile-relation__add-relation-button").focus()});var a=n.$on(r.PWA_TASK_MODAL,function(e,n){n.taskCreated?t.close():t.dismiss(),a()})}function O(){e.taskParent=n.ticket;var t=o.open({templateUrl:"views/template/browse-task-template-action-blade.html",windowClass:"action-blade",controller:"BrowseTaskTemplateController",backdrop:"custom",resolve:{isFromBrowseTemplate:function(){return!1}}});t.result.then(function(){A(),m.find("button.profile-relation__add-relation-button").focus(),n.$emit(r.TICKET_PROFILE_RESEND_EVENT,{eventName:r.REFRESH_ACTIVITY_FEED})},function(){m.find("button.profile-relation__add-relation-button").focus()})}function A(){var e;n.ticket.isDraft&&(e=t.cache[I.id]),k.processing=!0,t.refreshRelations(I.id,I.type)["finally"](function(){k.processing=!1,e&&_.forEach(e,function(e){var a=_.find(t.cache[I.id],{id:e.id});a||t.cache[n.ticket.id].push(e)})})}n.userModel={isAccessibleUser:!1},n.itemsLimit=4;var I=n.ticket,b=[],k={loadingTaskResources:!I.isDraft,processing:!1,showing:!1};n.relations=t.cache,v(),n.$watch(function(){return a.isAccessibleUser},function(e){n.userModel.isAccessibleUser=e}),n.$watch("relations",function(){if(n.relatedTasks=_.filter(_.cloneDeep(n.relations[I.id]),{type:EntityVO.TYPE_TASK})||[],n.originalTasks=_.cloneDeep(n.relatedTasks),n.relatedTasks.length){var e=[],t=[];_.forEach(n.relatedTasks,function(a,n,i){if(a.editable=!1,I.type!==EntityVO.TYPE_PROBLEM&&I.type!==EntityVO.TYPE_KNOWNERROR&&(a.editable=!(!I.accessMappings.relationsEditAllowed||I.accessMappings.tasksEditAllowed===!1||"Staged"!==a.realObject.status.value)),a.realObject.taskGroupId){a.realObject.nestedTaskGroup&&(a.editable=!1),a.realObject.taskGroupType||(a.realObject.taskGroupType=a.realObject.sequence?"Sequencing":"Standard"),a.realObject.sequence=a.realObject.sequence?a.realObject.sequence:1,a.realObject.childSequence=a.realObject.mainSequence+"."+a.realObject.sequence;var o=_.find(t,function(e){return e.realObject.taskGroupId===a.realObject.taskGroupId});0===t.length||t.length&&o?t.push(a):(e.push(t),t=[],t.push(a)),n===i.length-1&&e.push(t)}else t.length&&(e.push(t),t=[]),e.push(a)}),n.relatedTasks=e,b=angular.copy(n.relatedTasks)}n.relationCounters&&(n.relationCounters.tasks=f(n.relatedTasks).length)},!0),n.parentSortableOptions={placeholder:"profile-relation__item-task-container",connectWith:".profile-relation__task-container",cancel:":input,.locked",update:function(e,t){k.showing=!1;var a=h(t.item.sortable.droptargetModel),o=t.item.sortable.droptargetModel[t.item.sortable.dropindex],r=1;r=o.length?o[0].realObject.mainSequence:o.realObject.mainSequence;var l=!0;_.forEach(a,function(e){if(r>=e)return l=!1,!1}),0===a.length&&y(t.item.sortable.droptargetModel,t.item.sortable.dropindex,t.item.sortable.index)&&(l=!1),l&&!k.showing&&(k.showing=!0,s(function(){n.draftNotificationInstance=d.warning({text:i("i18n")("ticket.relatedTasks.closed.label"),hide:1e4}),n.draftNotificationInstance.result["finally"](function(){n.draftNotificationInstance=null})},500),t.item.sortable.cancel())},stop:function(e,t){if(!k.showing){var a=_.cloneDeep(t.item.sortable.sourceModel),i=_.find(a,function(e,a){return e.length&&(e=e[0]),t.item.sortable.dropindex<a&&t.item.sortable.model.id!==e.id&&"Assigned"===e.realObject.status.value});i&&i.length&&(i=i[0]);var o=1;_.forEach(a,function(e,n){var r=!1,s=null;n+1!==a.length&&(s=a[n+1].length?a[n+1][0]:a[n+1]),e.length?(s&&e[0].realObject.mainSequence===s.realObject.mainSequence&&(t.item.sortable.model.length?t.item.sortable.model[0].id:t.item.sortable.model.id)!==s.id&&(r=!0),_.forEach(e,function(a,r){t.item.sortable.model.id===a.id&&"Staged"!==a.realObject.status.value&&(a.realObject.status.value="Staged"),"Staged"===a.realObject.status.value&&(a.realObject.mainSequence=o,!i||n!==t.item.sortable.dropindex||0!==r&&a.realObject.sequence!==e[0].realObject.sequence||(a.realObject.mainSequence=i.realObject.mainSequence,a.realObject.status.value="Pending"),a.realObject.childSequence=a.realObject.mainSequence+"."+a.realObject.sequence)}),o=r?e[0].realObject.mainSequence:e[0].realObject.mainSequence+1):(s&&e.realObject.mainSequence===s.realObject.mainSequence&&(t.item.sortable.model.length?t.item.sortable.model[0].id:t.item.sortable.model.id)!==s.id&&(r=!0),t.item.sortable.model.id===e.id&&"Staged"!==e.realObject.status.value&&(e.realObject.status.value="Staged"),"Staged"===e.realObject.status.value&&(e.realObject.mainSequence=o,i&&n===t.item.sortable.dropindex&&(e.realObject.mainSequence=i.realObject.mainSequence,e.realObject.status.value="Pending")),o=r?e.realObject.mainSequence:e.realObject.mainSequence+1)}),n.relatedTasks=a,n.dirty=!0}}},n.childSortableOptions={placeholder:"profile-relation__item-task-child",connectWith:".profile-relation__task-group-container",cancel:":input,.locked",update:function(e,t){var a=_.find(t.item.sortable.sourceModel,function(e,a){return t.item.sortable.dropindex<=a&&t.item.sortable.model.id!==e.id&&("Closed"===e.realObject.status.value||"Bypassed"===e.realObject.status.value)}),o=!1;t.item.sortable.model.realObject.taskGroupId!==t.item.sortable.droptargetModel[0].realObject.taskGroupId&&(o=!0),!a&&!o||k.showing||(k.showing=!0,s(function(){n.draftNotificationInstance=d.warning({text:a?i("i18n")("ticket.relatedTasks.closed.label"):i("i18n")("ticket.relatedTasks.groupChange.label"),hide:1e4}),n.draftNotificationInstance.result["finally"](function(){n.draftNotificationInstance=null,k.showing=!1})},500),t.item.sortable.cancel())},stop:function(e,t){if(!k.showing){var a,i=_.cloneDeep(t.item.sortable.sourceModel),o=_.find(i,function(e,a){return t.item.sortable.dropindex<a&&t.item.sortable.model.id!==e.id&&"Staged"!==e.realObject.status.value}),r=1;_.forEach(i,function(e,n){var s=!1,l=null;n+1!==i.length&&(l=i[n+1]),l&&e.realObject.sequence===l.realObject.sequence&&t.item.sortable.model.id!==l.id&&(s=!0),t.item.sortable.model.id===e.id&&(a=n,"Staged"!==e.realObject.status.value&&(e.realObject.status.value="Staged")),"Staged"===e.realObject.status.value&&(e.realObject.sequence=r,o&&n===t.item.sortable.dropindex&&(e.realObject.sequence=o.realObject.sequence,e.realObject.status.value="Pending"),e.realObject.childSequence=e.realObject.mainSequence+"."+e.realObject.sequence),r=s?e.realObject.sequence:e.realObject.sequence+1}),_.forEach(n.relatedTasks,function(e,o){e.length&&e[a]&&e[a].id===t.item.sortable.model.id&&(n.relatedTasks[o]=i)}),n.dirty=!0}}},n.updateTaskSequence=function(e){e.realObject.mainSequence<=0||isNaN(e.realObject.mainSequence)||_.isEmpty(e.realObject.mainSequence)?e.realObject.mainSequence=1:e.realObject.mainSequence=parseInt(e.realObject.mainSequence),"Staged"!==e.realObject.status.value&&(e.realObject.status.value="Staged");var t=angular.copy(n.relatedTasks),a=!0,i=_.find(t,function(t,n){if(t.length){var i;return _.find(t,function(t){i=e.realObject.mainSequence<=t.realObject.mainSequence&&("Closed"===t.realObject.status.value||"Bypassed"===t.realObject.status.value)}),i}return e.realObject.mainSequence<=t.realObject.mainSequence&&("Closed"===t.realObject.status.value||"Bypassed"===t.realObject.status.value)||(a=!1,!1)});i&&a&&(e.realObject.mainSequence=i.length?i[0].realObject.mainSequence+1:i.realObject.mainSequence+1);var o=_.find(t,function(t){if(t.length){var a;return _.find(t,function(t){a=e.realObject.mainSequence<=t.realObject.mainSequence&&"Closed"!==t.realObject.status.value&&"Bypassed"!==t.realObject.status.value&&"Staged"!==t.realObject.status.value}),a}return e.realObject.mainSequence<=t.realObject.mainSequence&&"Closed"!==t.realObject.status.value&&"Bypassed"!==t.realObject.status.value&&"Staged"!==t.realObject.status.value});o&&(e.realObject.status.value="Pending",e.realObject.mainSequence=o.length?o[0].realObject.mainSequence:o.realObject.mainSequence);var r=_.findIndex(t,function(t){return t.length&&(t=t[0]),e.id===t.id});t[r]=e,t.sort(function(e,t){return(e.length?e[0].realObject.mainSequence:e.realObject.mainSequence)-(t.length?t[0].realObject.mainSequence:t.realObject.mainSequence)}),s(function(){n.relatedTasks=t},2e3),n.dirty=!0},n.updateParentSequence=function(e){e[0].realObject.mainSequence<=0||isNaN(e[0].realObject.mainSequence)||_.isEmpty(e[0].realObject.mainSequence)?e[0].realObject.mainSequence=1:e[0].realObject.mainSequence=parseInt(e[0].realObject.mainSequence),"Staged"!==e[0].realObject.status.value&&(e[0].realObject.status.value="Staged");var t=angular.copy(n.relatedTasks),a=e[0].realObject.mainSequence,i=h(t),o=!1;_.forEach(i,function(t){if(e[0].realObject.mainSequence<=t)return a=t,o=!0,!1});for(var r=0;r<e.length;)e[r].realObject.mainSequence=a,r++;i&&i.length&&o&&(e[0].realObject.status.value="Pending",e[0].realObject.mainSequence=i[0]);var l=e[0].realObject.mainSequence,c=l+"."+e[0].realObject.sequence,d=e[0].realObject.status.value,u=e[0].editable;_.forEach(e,function(e){e.realObject.mainSequence=l,e.realObject.childSequence=l+"."+e.realObject.sequence,c===e.realObject.childSequence&&(e.realObject.status.value=d,e.editable=u)});var p=_.findIndex(t,function(t){return t.length&&(t=t[0]),e[0].id===t.id});t[p]=e,t.sort(function(e,t){return(e.length?e[0].realObject.mainSequence:e.realObject.mainSequence)-(t.length?t[0].realObject.mainSequence:t.realObject.mainSequence)}),s(function(){n.relatedTasks=t},2e3),n.dirty=!0},n.updateChildSequence=function(e,t,a,i){function o(){s(function(){var e=m.find("#"+a);e[0].focus()})}var r=t.realObject.childSequence.split("."),l=r[0],c=r[1],d=(t.realObject.childSequence.match(/\./g)||[]).length;if(!l||1!==d)return void E(t,i);if(c&&1===d){t.realObject.mainSequence=i,t.realObject.sequence=isNaN(c)||_.isEmpty(c)||c<=0?t.realObject.sequence:parseInt(c),"Staged"!==t.realObject.status.value&&(t.realObject.status.value="Staged");var u=_.find(e,function(e){return t.realObject.sequence<=e.realObject.sequence&&("Closed"===e.realObject.status.value||"Bypassed"===e.realObject.status.value)});u&&(t.realObject.sequence=u.realObject.sequence+1);var p=_.find(e,function(e){return t.realObject.sequence<=e.realObject.sequence&&"Closed"!==e.realObject.status.value&&"Bypassed"!==e.realObject.status.value&&"Staged"!==e.realObject.status.value});p&&(t.realObject.status.value="Pending",t.realObject.sequence=p.realObject.sequence);var f=t.realObject.mainSequence,g=f+"."+t.realObject.sequence,h=t.realObject.status.value;_.forEach(e,function(e){e.realObject.mainSequence=f,e.realObject.childSequence=f+"."+e.realObject.sequence,g===e.realObject.childSequence&&(e.realObject.status.value=h)});var y=angular.copy(n.relatedTasks),v=_.findIndex(y,function(t){return t.length&&(t=t[0]),e[0].id===t.id});e=_.sortBy(angular.copy(e),"realObject.sequence"),y[v]=e,y.sort(function(e,t){return(e.length?e[0].realObject.mainSequence:e.realObject.mainSequence)-(t.length?t[0].realObject.mainSequence:t.realObject.mainSequence)}),s(function(){n.relatedTasks=y,o()},2e3),n.dirty=!0}else n.dirty=!1},n.setFocus=function(e){var t=e.target;t.focus()},n.onSaveClick=function(){var e=[];_.forEach(n.relatedTasks,function(t){if(t.length)_.forEach(t,function(t){var a=_.find(n.originalTasks,function(e){return e.id===t.id});if(a.realObject.mainSequence!==t.realObject.mainSequence||a.realObject.sequence!==t.realObject.sequence){var i=null;"Sequencing"===t.realObject.taskGroupType&&a.realObject.sequence!==t.realObject.sequence&&(i=t.realObject.sequence);var o={parentId:t.parentId,parentType:t.realObject.parentType,parentName:t.realObject.parentName,parentDisplayId:t.realObject.parentDisplayId,company:t.realObject.company,taskGroupId:t.realObject.taskGroupId,mainSequence:t.realObject.mainSequence,sequence:i,id:t.id};e.push(o)}});else{var a=_.find(n.originalTasks,function(e){return e.id===t.id});if(a.realObject.mainSequence!==t.realObject.mainSequence){var i={parentId:t.parentId,parentType:t.realObject.parentType,parentName:t.realObject.parentName,parentDisplayId:t.realObject.parentDisplayId,company:t.realObject.company,mainSequence:t.realObject.mainSequence,sequence:t.realObject.mainSequence,id:t.id};e.push(i)}}}),e.length&&(k.processing=!0,t.updateTaskSequence(e).then(function(e){var a=angular.copy(_.flatten(n.relatedTasks));_.forEach(e,function(e){var t=_.find(a,{id:e.responseObject.id});"Success"===e.statusInfo.type&&e.responseObject.id===t.id&&(t.realObject.status.value=e.responseObject.status.value,t.realObject.sequence=e.responseObject.sequence,"Staged"!==t.realObject.status.value&&(t.editable=!1))}),n.originalTasks=a,_.remove(t.cache[I.id],{type:EntityVO.TYPE_TASK}),_.forEach(a,function(e){t.cache[I.id].push((new RelationItemVO).build(e))})})["catch"](function(e){d.error({text:e.data.error,clear:!1})})["finally"](function(){k.processing=!1,n.dirty=!1}))},n.onRevertClick=function(){n.relatedTasks=angular.copy(b),n.dirty=!1},I.isDraft||t.getRelations(I.id,I.type)["finally"](function(){k.loadingTaskResources=!1}),n.createBlankTask=function(){if(n.dirty){var e=d.modal({title:c.getLocalizedString("common.notification.dirty.title"),text:c.getLocalizedString("common.notification.dirty.message"),buttons:[{text:c.getLocalizedString("common.notification.dirty.button1"),data:!0},{text:c.getLocalizedString("common.notification.dirty.button2"),data:!1}]});e.result.then(function(e){e&&(n.dirty=!1,p.isPwaEnabled()?T():S())})}else p.isPwaEnabled()?T():S()},n.getURLforTaskFlow=function(){k.processing=!0;var t=I.id,a={rootRequestId:I.displayId,taskParentType:I.type,summary:I.summary};e.getURLforTaskFlow(t,a)["finally"](function(){k.processing=!1})},n.createTaskFromTemplate=function(){if(n.dirty){var e=d.modal({title:c.getLocalizedString("common.notification.dirty.title"),text:c.getLocalizedString("common.notification.dirty.message"),buttons:[{text:c.getLocalizedString("common.notification.dirty.button1"),data:!0},{text:c.getLocalizedString("common.notification.dirty.button2"),data:!1}]});e.result.then(function(e){e&&(n.dirty=!1,p.isPwaEnabled()?C():O())})}else p.isPwaEnabled()?C():O()},n.state=k}}}])}(),function(){angular.module("ticketModule").controller("TicketTransitionController",["$scope","ticketModel","$stateParams","systemAlertService","$state","configurationModel","permissionModel","roles","metadataModel",function(e,t,a,n,i,o,r,s,l){var c={loginPending:!0,ticketNotFound:!1,ticket:""};e.state=c;var d=function(){c.loginPending=!0,t.getGUIDByDisplayID(a.type,a.displayid).then(function(e){c.loginPending=!1,void 0!==e?l.getMetadataByType("global").then(function(t){var n="T"===t.configurationParameters["Enable-Progressive-Views"]||"true"===t.configurationParameters["Enable-Progressive-Views"];n="T"!==localStorage.getItem("overridePV")&&n,n&&localStorage.getItem("midtierUrl")&&o.get("pwaEnabledTickets.tickets").indexOf(a.type)>=0?i.go(a.type+"PV",{id:e},{location:"replace",reload:!0}):i.go(a.type,{id:e},{location:"replace",reload:!0})})["catch"](function(e){e&&n.error({text:e.data.error,clear:!1})}):(c.loginPending=!1,c.ticketNotFound=!0,c.ticket=a.type)},function(e){var t=a.type;c.loginPending=!1,"incident"===t||"workorder"===t||"change"===t||"task"===t?(c.ticketNotFound=!0,c.ticket=a.type):n.error({text:e.data&&(e.data.detailedMessage||e.data.error)||e,clear:!1})})};d()}])}(),WorkOrderVO.prototype=new TicketVO,WorkOrderVO.prototype.constructor=WorkOrderVO,WorkOrderVO.prototype.getProps=function(){return TicketVO.prototype.getProps().concat("completedDate","impactedService","workorderType","manager","managerGroup","actualStartDate","actualEndDate","scheduledStartDate","scheduledEndDate","templateId","location","brokerVendorName","woAutomationStatus","needsAttention","templateName")},WorkOrderVO.prototype.postBuild=function(){TicketVO.prototype.postBuild.call(this),this.scheduledStartDate=this.scheduledStartDate?new Date(this.scheduledStartDate):null,this.scheduledEndDate=this.scheduledEndDate?new Date(this.scheduledEndDate):null,this.actualStartDate=this.actualStartDate?new Date(this.actualStartDate):null,this.actualEndDate=this.actualEndDate?new Date(this.actualEndDate):null,this.scheduledStartDateHumanized=this.scheduledStartDate?moment(this.scheduledStartDate).format("lll"):null,this.scheduledEndDateHumanized=this.scheduledEndDate?moment(this.scheduledEndDate).format("lll"):null,this.actualStartDateHumanized=this.actualStartDate?moment(this.actualStartDate).format("lll"):null,this.actualEndDateHumanized=this.actualEndDate?moment(this.actualEndDate).format("lll"):null},function(){angular.module("myitsmApp").controller("LoginController",["$rootScope","$scope","$cookies","authModel","events","utilityFunctions","$location",function(e,t,a,n,i,o,r){function s(){var e=4,t=Math.floor(Math.random()*e)+1;return"bgr-"+t}var l={loginPending:!1},c="",d="",u=function(){var e=t.loginForm;return e.username||(c="usernameRequired"),e.password||(c="passwordRequired"),e.username||e.password||(c="usernameAndPasswordRequired"),c};t.state=l,t.loginForm={username:"",password:"",accessibility:"true"===a.get("accessibility"),action:function(){var e=this;return c=null,d=null,l.loginPending=!0,u()?(t.errorMessageType=c,void(l.loginPending=!1)):(t.sendMessageToPwaDomain({username:e.username,password:e.password,isLoginCredential:!0}),void n.login(e.username,e.password).then(function(){var t=new Date;t.setDate(t.getDate()+365),"https"===r.protocol()?a.put("accessibility",e.accessibility,{expires:t,secure:!0,samesite:"strict"}):a.put("accessibility",e.accessibility,{expires:t,samesite:"strict"})},function(a){a&&(403===a.status&&"MOBILITY_ERROR_SESSION_EXPIRED"===a.data.error?c="403":401===a.status?(e.username="",c="401"):"MOBILITY_ERROR_LOGIN"===a.data.error&&"1006"==a.data.errorCode&&a.data.detailMessage.indexOf("(8102)")>=0?d=a.data.detailMessage:c="MOBILITY_ERROR_LOGIN"===a.data.error&&"1006"==a.data.errorCode&&a.data.ARConnectionProblem?"90":"MOBILITY_ERROR_LOGIN"===a.data.error&&"1006"==a.data.errorCode?"1006":"unknown"),sessionStorage.removeItem("calendarFilterState"),sessionStorage.removeItem("calendarFilterView"),sessionStorage.removeItem("calendarFilterDate"),t.errorMessageType=c,t.errorMessageTypeEnforcePwdConstraint=d,l.loginPending=!1,e.password=""}))}},t.showLoginHelp=function(){return!1},t.loginBgrClass=s()}])}(),function(){angular.module("userModule").service("loginHelpService",["$http","$resource",function(e,t){var a=t("/smartit/rest/contactInfo/search/:locale",{},{getContacts:{method:"POST",isArray:!0},getUrl:{method:"POST",isArray:!0}});this.getContacts=function(e,t){return a.getContacts(e,t).$promise.then(function(e){return _.filter(e[0].items,function(e){return e.phone})})},this.getUrl=function(e,t){return a.getUrl(e,t).$promise.then(function(e){return e[0].items.length?e[0].items[0]:{}})}}])}(),function(){angular.module("userModule").factory("userModel",["authService","localStorageService","userService","$q","$log","$rootScope","events","searchService",function(e,t,a,n,i,o,r,s){var l={userConfig:{},followCount:null,isAccessibleUser:!1,isAccessibleUserPreferenceId:null,bcmConfig:{integrated:!1,usermapped:!1,configLoaded:!1},userIdEncoded:!1,userId:t.get("user.userId"),decodedUserId:t.get("user.userId")};l.getUserDataForCurrentSession=function(){l.userId=t.get("user.userId"),l.getFullCurrentUserData()},l.getFullCurrentUserData=function(){return _.isUndefined(l.userFullData)||_.isUndefined(l.userFullData.loginId)||l.userFullData.loginId===l.userId||(l.userFullData=null),l.userId||(l.userId=t.get("user.userId")),l.userFullData||_.isUndefined(l.userId)||(l.userId&&!l.userIdEncoded&&(l.decodedUserId=angular.copy(l.userId),l.userId=encodeURIComponent(l.userId),l.userIdEncoded=!0),l.userFullData=a.getFullUserData(l.userId).then(function(e){return l.userFullData=e,l.userFullData.id||(l.userFullData.id=l.userId),e})["catch"](function(){i.error("Error while getting full user data")})),n.when(l.userFullData)},l.getOperatingCompanies=function(e){return l.operatingCompanies&&!e?n.when({companies:l.operatingCompanies,exceedsChunkSize:l.exceedsChunkSizeOperatingCompanies}):(e&&(e={chunkInfo:e}),s.getCompaniesByText("",e).then(function(t){return e||(l.operatingCompanies=t.companies,l.exceedsChunkSizeOperatingCompanies=t.exceedsChunkSize),t}))},l.getOperatingCompaniesByText=function(e){return s.getCompaniesByText(e).then(function(e){return e})};var c=function(e,t){t=_.filter(t,"id"),t.length&&_.map(t,function(e){e.value=_.isEmpty(e.value)?"":angular.fromJson(e.value)}),_.forEach(t,function(t){var a=_.findIndex(l.userConfig[e],{id:t.id});a>-1?l.userConfig[e][a]=t:l.userConfig[e].push(t)})};return l.getUserPreferences=function(e){if(l.userConfig[e])return n.when(l.userConfig[e]);l.userConfig[e]=[];var t={preferenceGroup:e,user:l.userIdEncoded?decodeURIComponent(l.userId):l.userId};return a.getUserPreferences(t).then(function(t){return c(e,t),l.userConfig[e]})},l.updateUserPreferences=function(e,t,n){var i=t.id&&_.find(l.userConfig[e],{id:t.id})||{},o={preferenceGroup:e,user:l.userIdEncoded?decodeURIComponent(l.userId):l.userId};return null!==t.value&&(_.isPlainObject(t.value)?n&&n.updateColumns?i.value=t.value:i.value=_.merge(i.value||{},t.value):i.value=t.value),o.preferenceDetails=[{id:i.id||null,name:i.name||t.name,defaultpreset:t.defaultpreset,systemgenerated:t.systemgenerated,label:t.label}],(t.value||"accessibility"===t.name)&&(o.preferenceDetails[0].value=angular.toJson(i.value)),t.systemgenerated&&(o.preferenceDetails[0].value="[{}]"),a.updateUserPreferences(o).then(function(t){return c(e,t),t})},l.removeUserPreferences=function(e,t){return l.userConfig[e].splice(_.findIndex(l.userConfig[e],{id:t.id}),1),a.removeUserPreferences(t.id)},l.getBCMIntegrationConfig=function(){return l.bcmConfig.configLoaded?n.when(l.bcmConfig):a.getBCMIntegrationConfig().then(function(e){
return l.bcmConfig={configLoaded:!0,integrated:e.integrated,usermapped:e.usermapped},l.bcmConfig})},l.doBCMLogin=function(e,t){return a.doBCMLogin(e,t).then(function(e){return l.bcmConfig={configLoaded:!0,integrated:e.integrated,usermapped:e.usermapped},l.bcmConfig})},l}])}(),function(){angular.module("userModule").service("userService",["$resource",function(e){var t=e("",{},{getFullUserData:{url:"/smartit/restapi/person/supportgroupperson/:userId",method:"GET",isArray:!0},getUpdatesFeed:{url:"/smartit/rest/v2/following/stream",method:"GET",isArray:!0},getUserPreferences:{url:"/smartit/rest/v2/preference/details/search",method:"GET",isArray:!0},setUserPreferences:{url:"/smartit/rest/preference/update",method:"POST",isArray:!0},removeUserPreferences:{url:"/smartit/rest/preference/delete/:id",method:"DELETE",isArray:!0},searchUserByName:{url:"/smartit/rest/person/search?name=:searchStr&thumbnail=true",method:"GET",isArray:!0},getBCMIntegrationConfig:{url:"/smartit/rest/bcm/configuration",method:"GET",isArray:!1},doBCMLogin:{url:"/smartit/rest/bcm/admin/connectivity",method:"POST",isArray:!1}}),a={clientType:"UC"};this.getFullUserData=function(e){return t.getFullUserData({userId:e}).$promise.then(function(e){return(new UserVO).build(e[0].items[0])})},this.getUpdatesFeed=function(e){return t.getUpdatesFeed(e).$promise.then(function(e){var t={};return t.feedItems=e[0].items.map(function(e){return(new FeedItemVO).build(e)}),e[0].followCount&&(t.followCount=e[0].followCount),t})},this.getUserPreferences=function(e){return t.getUserPreferences(angular.extend(e,a)).$promise},this.updateUserPreferences=function(e){return t.setUserPreferences(angular.extend(e,a)).$promise},this.removeUserPreferences=function(e){return t.removeUserPreferences({id:e}).$promise},this.doBCMLogin=function(e,a){return t.doBCMLogin({username:e,password:a}).$promise},this.getBCMIntegrationConfig=function(){return t.getBCMIntegrationConfig().$promise},this.searchUserByName=function(e){return t.searchUserByName({searchStr:e}).$promise.then(function(e){return console.log("searchUserByName",e),e[0].items})}}])}(),UserVO.prototype=Object.create(BaseVO.prototype),UserVO.prototype.constructor=UserVO,UserVO.prototype.getProps=function(){var e=Object.keys(new UserVO);return BaseVO.prototype.getProps().concat(e)},UserVO.prototype.postBuild=function(){this.entityLink="#/"+EntityVO.TYPE_PERSON+"/"+encodeURIComponent(this.loginId)},UserVO.prototype.getFullName=function(){return this.fullName?this.fullName:this.firstName+" "+this.lastName},function(){angular.module("myitsmApp").directive("editPoi",["events","locationModel","$state","$timeout",function(e,t,a,n){return{restrict:"E",templateUrl:"views/work-order/edit-poi.html",replace:!0,scope:{ticket:"=",isDraft:"=",editMode:"=mode",updateIsHandledByParent:"="},link:function(e){e.clearField=function(t){t?(e.viewData.location=null,e.viewData.poi=null):e.viewData.poi=null,e.state.pendingChanges=!0},e.filterLocationsByCriteria=function(e){return t.filterLocations(e).then(function(e){return e})},e.filterPOIbyCriteria=function(a){if(e.viewData.location&&e.viewData.location.id)return e.state.loadingPOI=!0,t.filterLocationPOI(e.viewData.location.id,a).then(function(e){return e})["finally"](function(){e.state.loadingPOI=!1})},e.handleLocationChange=function(){e.viewData.poi=null,e.ticket.location={},e.state.pendingChanges=!0},e.handlePOIChange=function(){e.state.pendingChanges=!0,e.viewData.poi&&e.viewData.poi.id&&(e.ticket.location.poiId=e.viewData.poi.id,e.ticket.location.poiName=e.viewData.poi.name,e.ticket.location.flooMapId=e.viewData.poi.floormap?e.viewData.poi.floormap.id:"")}},controller:["$scope","ticketModel","locationModel","googleMapService",function(t,i,o,r){function s(){t.save()}function l(){var a=t.viewData.poi||{};a.id?t.ticket.location={poiId:a.id,poiName:a.name,floorMapId:a.floormap?a.floormap.id:""}:t.ticket.location=null,t.state.pendingChanges=!1,t.updateIsHandledByParent&&!t.isDraft||t.$emit(e.SAVE_CHANGES_COMPLETE)}function c(){t.cancel()}function d(){var e={};if(t.state.pendingChanges){var a=t.initialData.poiId,n=t.viewData.poi&&t.viewData.poi.id||null;if(a!==n){var i=t.viewData.poi||{};e.poiId=i.id||null}}return e}function u(){t.initialData=_.clone(t.ticket.location)||{},t.state={pendingChanges:!1,dataIsLoading:!0,loadingPOI:!1},t.viewData={location:null,poi:t.initialData.poiName},t.initialData.poiId?o.getLocationByPoiId(t.initialData.poiId).then(function(e){if(t.state.dataIsLoading=!1,t.viewData.location=e,!t.viewData.poi){var a=o.poiByLocationCache[e.id]||[],i=_.find(a,{id:t.initialData.poiId});i&&n(function(){t.viewData.poi={name:i.name,id:i.id,floormap:{id:i.floorMapId}}})}o.getLocationsList()}):t.state.dataIsLoading=!1}function p(e){return i.update(f.id,f.type,e)}function m(){t.updateIsHandledByParent&&!t.isDraft&&l()}var f=t.ticket;t.showPOIMap=function(e){e&&e.poiId&&r.isAvailable&&a.go("location",{mapId:e.floorMapId,id:e.poiId})},t.save=function(){var a=d(),n=t.isDraft,i=!t.updateIsHandledByParent;t.$emit(e.SAVE_CHANGES_REQUEST,a,i||n),_.size(a)?n?l():i&&p(a).then(function(){l()}):(i||n)&&t.$emit(e.SAVE_CHANGES_COMPLETE)},t.cancel=function(){t.ticket.location=t.initialData,t.state.pendingChanges=!1};var g=t.$watch("ticket",function(e){e&&(u(),g())});t.$on(e.SAVE_CHANGES,s),t.$on(e.TOGGLE_EDIT_MODE,u),t.$on(e.DISCARD_CHANGES,c),t.$on(e.SAVE_ALL_CHANGES_COMPLETE,m)}]}}])}(),function(){angular.module("adminModule").controller("AdminConsoleConfigurationController",["$filter","$modal","$rootScope","$scope","$log","$q","adminConsoleConfigurationModel","systemAlertService","configurationModel",function(e,t,a,n,i,o,r,s,l){function c(e){n.selectedMenuItem=e||"home","home"!==e?(n.showHomePage=!1,n.dataLoading=!0,"configuration"===e?r.getDataByMenuItem(e).then(function(e){n.displayData=e,n.dataLoading=!1}):"reports"===e&&d(function(e){n.displayData={users:e[0].items,clients:e[1],uniqueUsers:e[0].totalItemCount},n.dataLoading=!1})):n.showHomePage=!0}function d(e){var t={after_date:"",before_date:"",app_name:"SmartIT"},a={after_date:"",before_date:"",app_name:"SmartIT",offset:0,limit:100,sidx:"",sord:"asc"};o.all([r.getActiveUsers(a),r.getClientTypesUsage(t)]).then(function(t){e(t)})}function u(){n.sideMenuItems=l.get("adminConsoleConfig.sideMenu")}function p(){u()}n.sideMenuItems=[],n.displayData=[],n.showHomePage=!0,n.showSideMenu=function(){var e=t.open({templateUrl:"views/admin/console-config/admin-console-side-menu.html",windowClass:"action-blade action-blade-left",size:"extra-small-left",controller:["$scope","sideMenuItems",function(t,a){t.sideMenuItems=a,t.handleMenuItemClick=function(t){e.close(),c(t)}}],resolve:{sideMenuItems:function(){return n.sideMenuItems}}})},p()}])}(),function(){angular.module("adminModule").factory("adminConsoleConfigurationModel",["$q","adminConsoleConfigurationService",function(e,t){var a={};return a.getDataByMenuItem=function(e){return t.getDataByMenuItem({item:e})},a.getClientTypesUsage=function(e){return t.getClientTypesUsage(e)},a.getActiveUsers=function(e){return t.getActiveUsers(e)},a.providerEnableStatusChange=function(e){return t.providerEnableStatusChange(e)},a.updateProviderSettings=function(e){return t.updateProviderSettings(e)},a.reloadProviders=function(){return t.reloadProviders()},a}])}(),function(){angular.module("adminModule").service("adminConsoleConfigurationService",["$resource",function(e){var t=e("",{},{getProvidersData:{url:"/smartit/rest/v2/tenant/provider",method:"GET",isArray:!0},getActiveUsers:{url:"/smartit/rest/reports/active_users",method:"GET",isArray:!1},getClientTypesUsage:{url:"/smartit/rest/reports/client_types_usage",method:"GET",isArray:!1},enableProvider:{url:"/smartit/rest/v2/tenant/provider/:id/enabled",method:"PUT"},updateProviderSettings:{url:"/smartit/rest/system/provider/settings",method:"PUT"},disableProvider:{url:"/smartit/rest/v2/tenant/provider/:id/enabled",method:"DELETE"},reloadProviders:{url:"/smartit/rest/system/provider/reload",method:"GET",isArray:!1}});this.getDataByMenuItem=function(e){return t.getProvidersData().$promise.then(function(e){return e})},this.getActiveUsers=function(e){return t.getActiveUsers(e).$promise.then(function(e){return e})},this.getClientTypesUsage=function(e){return t.getClientTypesUsage(e).$promise.then(function(e){return e.items})},this.providerEnableStatusChange=function(e){var a,n={id:e.id};return a=e.enabled?t.disableProvider(n).$promise:t.enableProvider(n,{}).$promise},this.updateProviderSettings=function(e){return t.updateProviderSettings({},e).$promise.then(function(e){return e.toJSON()})},this.reloadProviders=function(){return t.reloadProviders().$promise.then(function(e){return e})}}])}(),function(){angular.module("adminModule").controller("ProviderConfigurationController",["$filter","$modal","$rootScope","$scope","$log","$q","$state","events","adminConsoleConfigurationModel","systemAlertService","$timeout","configurationModel",function(e,t,a,n,i,o,r,s,l,c,d,u){n.settingsLabelData=n.sideMenuItems=u.get("adminConsoleConfig.settingsLabelMapping"),n.providerData=_.cloneDeep(n.displayData),n.formHolder={},n.providerStatusChange=function(t){return"mcsm"===t.instanceName&&(n.dataLoading=!0,void l.providerEnableStatusChange(t).then(function(a){t.enabled=!t.enabled,c.success({text:e("i18n")("console.config.providers.update.success"),clear:!0,hide:5e3}),n.dataLoading=!1}))},n.pagination={totalItems:n.providerData.length,currentPage:1,numPerPage:10},n.paginate=function(e){var t,a,i;return t=(n.pagination.currentPage-1)*n.pagination.numPerPage,a=t+n.pagination.numPerPage,i=n.providerData.indexOf(e),t<=i&&i<a},n.isSelectedRow=null,n.settingsDisplay=function(e){return 0==e.settings.length?(n.showSettings=!1,!1):(n.showSettings=!0,n.isSelectedRow=e.id,n.nativeSettings=e.settings,n.settingsData=_.cloneDeep(e.settings),n.oldSettings=_.cloneDeep(e.settings),void 0)},n.flipCheckbox=function(e){e.value="true"===e.value?"false":"true",n.formHolder.providerSettingsForm.$dirty=!0},n.submitSettings=function(){if(n.formHolder.providerSettingsForm.$dirty){var t=[],a=!0,i=null;_.each(n.settingsData,function(e){_.each(n.oldSettings,function(a){a.id===e.id&&a.value!==e.value&&t.push(e)}),"mcsm.password"===e.key&&null===e.value&&(i=e)}),t.length&&_.each(t,function(e){e.changed=!0,e.displayName=e.key,e.order=500,"mcsm.password"===e.key&&(a=!1)}),i&&a&&(i.changed=!0,i.displayName=i.key,i.order=500,i.value="",t.push(i)),n.dataLoading=!0,l.updateProviderSettings(t).then(function(t){t&&_.forEach(t,function(e){var t=_.find(n.settingsData,{id:e.id}),a=_.find(n.nativeSettings,{id:e.id});t.value=e.value,a.value=e.value}),n.oldSettings=angular.copy(n.settingsData),c.success({text:e("i18n")("console.config.settings.update.success"),clear:!0,hide:5e3}),n.dataLoading=!1})}},n.reloadProviders=function(){n.dataLoading=!0,l.reloadProviders().then(function(t){c.success({text:e("i18n")("console.config.providers.reload.success"),clear:!0,hide:5e3}),d(function(){r.reload(),n.dataLoading=!1},2e3)})},n.getValidLabel=function(e){var t=_.isUndefined(n.settingsLabelData[e.key])?e.key:n.settingsLabelData[e.key];return t},n.getValidInputType=function(e){return e.key.indexOf("password")!==-1?"password":"text"}}])}(),function(){angular.module("adminModule").directive("providerConfiguration",[function(){return{restrict:"E",scope:{displayData:"="},templateUrl:"views/admin/console-config/provider-configuration.html",controller:"ProviderConfigurationController"}}])}(),function(){angular.module("adminModule").controller("ReportsConfigurationController",["$scope","configurationModel","adminConsoleConfigurationModel","$q","$httpParamSerializer","$window",function(e,t,a,n,i,o){function r(){e.pagination={totalItems:e.reportsData.users&&_.isArray(e.reportsData.users)?e.reportsData.users.length:0,currentPage:1,numPerPage:20}}function s(){var t={after_date:e.reportsConfig.reportStartDate?moment(e.reportsConfig.reportStartDate).startOf("day").valueOf():"",before_date:e.reportsConfig.reportEndDate?moment(e.reportsConfig.reportEndDate).endOf("day").valueOf():"",app_name:"SmartIT"},i={offset:0,after_date:e.reportsConfig.reportStartDate?moment(e.reportsConfig.reportStartDate).startOf("day").valueOf():"",app_name:"SmartIT",before_date:e.reportsConfig.reportEndDate?moment(e.reportsConfig.reportEndDate).endOf("day").valueOf():"",limit:100,sidx:"",sord:"asc"};e.dataLoading=!0,n.all([a.getActiveUsers(i),a.getClientTypesUsage(t)]).then(function(t){e.reportsData={users:t[0].items,clients:t[1],uniqueUsers:t[0].totalItemCount},r(),e.dataLoading=!1})}e.reportsConfig={reportStartDatePicker:{open:!1},reportEndDatePicker:{open:!1}},e.datePickerOptions={startingDay:t.getWeekStartingDay(),"show-weeks":!1,minDate:moment().year(1970).month(0).date(1)},e.maxDate=new Date,e.updateDateTime=function(e){console.log(e)},e.reportsData=_.cloneDeep(e.displayData),r(),e.paginate=function(t){var a,n,i;return a=(e.pagination.currentPage-1)*e.pagination.numPerPage,n=a+e.pagination.numPerPage,i=e.reportsData.users.indexOf(t),a<=i&&i<n},e.openDatePicker=function(t,a,n){"start"===t?e.reportsConfig.reportEndDatePicker.open=!1:e.reportsConfig.reportStartDatePicker.open=!1,a.open=!0,n.stopPropagation()},e.getCustomReportData=function(){s()},e.clearReportDates=function(){e.reportsConfig.reportStartDate="",e.reportsConfig.reportEndDate="",s()},e.downloadCSV=function(){var t={after_date:e.reportsConfig.reportStartDate?moment(e.reportsConfig.reportStartDate).startOf("day").valueOf():"",app_name:"SmartIT",before_date:e.reportsConfig.reportEndDate?moment(e.reportsConfig.reportEndDate).endOf("day").valueOf():"",include_client_types_usage:!0},a="/smartit/rest/reports/active_users_csv?"+i(t);o.open(a,"_self","")},e.onDateChange=function(){e.reportsConfig.reportStartDate&&(e.reportsConfig.reportStartDate<e.datePickerOptions.minDate.toDate()||e.reportsConfig.reportStartDate>e.maxDate)?e.reportDateForm.reportStartDate.$setValidity("validStartDate",!1):e.reportDateForm.reportStartDate.$setValidity("validStartDate",!0),e.reportsConfig.reportEndDate&&(e.reportsConfig.reportEndDate<e.reportsConfig.reportStartDate||e.reportsConfig.reportEndDate>e.maxDate)?e.reportDateForm.reportEndDate.$setValidity("validEndDate",!1):e.reportDateForm.reportEndDate.$setValidity("validEndDate",!0)}}])}(),function(){angular.module("adminModule").directive("reportsConfiguration",[function(){return{restrict:"E",scope:{displayData:"="},templateUrl:"views/admin/console-config/reports.html",controller:"ReportsConfigurationController"}}])}(),function(){angular.module("adminModule").controller("KnowledgeStyleConfigController",["$scope","knowledgeArticleModel","systemAlertService","$filter",function(e,t,a,n){function i(){f=angular.extend(f,{dataIsLoading:!1}),e.state=f,e.styleMetadata=E,l(),o()}function o(){f.dataIsLoading=!0,t.getKnowledgeArticleTemplates().then(function(t){e.templates=angular.copy(t),_.remove(e.templates,{name:"Decision Tree"})})["finally"](function(){f.dataIsLoading=!1})}function r(t){l(),_.each(t.split(";"),function(t){var a=t.split(":"),n=!1;_.each(e.selected_css,function(e){if(a[0].trim()===e.name)return"text-decoration"===e.name?(e.value=a[1],a[1].indexOf("underline")>-1&&(e.underline=!0),a[1].indexOf("line-through")>-1&&(e.lineThrough=!0)):"font-weight"===e.name&&a[1].indexOf("bold")>-1?(e.value=a[1].trim(),e.bold=!0):"font-style"===e.name&&a[1].indexOf("italic")>-1?(e.value=a[1].trim(),e.italic=!0):e.value=a[1].trim(),void(n=!0)}),!n&&t&&t.length&&(e.additional.style+=t+";")}),e.selected_css.fontSize.value.length&&(e.selected_css.fontSize.label=e.selected_css.fontSize.value.replace("px","")),e.selected_css.fontFamily.value.length&&(e.selected_css.fontFamily.label=_.find(E.font,{value:e.selected_css.fontFamily.value}).label)}function s(){e.selectedStyle.text="",e.selectedStyle.styles="",_.each(e.selected_css,function(t){t.value&&t.value.length&&(e.selectedStyle.text+=t.value+" ,",e.selectedStyle.styles+=t.name+":"+t.value+";")}),e.additional.style.length&&(e.selectedStyle.styles+=e.additional.style,_.each(e.additional.style.split(";"),function(t){if(t){var a=t.split(":");a&&a[1]&&(e.selectedStyle.text+=a[1]+" ,")}})),e.selectedStyle.text=e.selectedStyle.text.replace(/ ,+$/,""),e.selectedStyle.styles=e.selectedStyle.styles.replace(/;+$/,"")}function l(){e.selected_css={fontWeight:{name:"font-weight",value:"",bold:!1},fontStyle:{name:"font-style",value:"",italic:!1},textDecoration:{name:"text-decoration",value:"",underLine:!1,lineThrough:!1},textAlign:{name:"text-align",value:""},fontFamily:{name:"font-family",value:"",label:""},fontSize:{name:"font-size",value:"",label:""},color:{name:"color",value:""},backgroundColor:{name:"background-color",value:""}},e.additional.style=""}function c(e){_.each(v,function(t){var a=_.find(e.templateObject.styles,{type:t.type});a?a.userStyle=!1:e.templateObject.styles.push(_.cloneDeep(t))}),e.templateObject.styles=_.sortBy(e.templateObject.styles,"type")}function d(t){e.selectedTemplate=_.cloneDeep(t),c(e.selectedTemplate),e.selectedTemplate.templateObject.styles=_.sortBy(e.selectedTemplate.templateObject.styles,"userStyle"),e.selectedStyle={},p()}function u(){g[e.selectedStyle.type]=!y[e.selectedStyle.type]||y[e.selectedStyle.type].styles!==e.selectedStyle.styles||y[e.selectedStyle.type].element!==e.selectedStyle.element,e.isDirtyState=!1,_.each(g,function(t){e.isDirtyState=e.isDirtyState||t})}function p(){e.isDirtyState=!1,g={},y={}}function m(){var e=a.modal({type:"info",title:n("i18n")("common.notification.dirty.title"),text:n("i18n")("common.notification.dirty.loseChanges"),buttons:[{text:n("i18n")("common.button.yes"),data:!0},{text:n("i18n")("common.button.no"),data:!1}]});return e.result}var f={},g={},h={},y={},E={fontSize:[{label:"8",value:"8px"},{label:"9",value:"9px"},{label:"10",value:"10px"},{label:"11",value:"11px"},{label:"12",value:"12px"},{label:"14",value:"14px"},{label:"16",value:"16px"},{label:"18",value:"18px"},{label:"20",value:"20px"},{label:"22",value:"22px"},{label:"24",value:"24px"},{label:"26",value:"26px"},{label:"28",value:"28px"},{label:"36",value:"36px"},{label:"48",value:"48px"},{label:"72",value:"72px"}],font:[{label:"Times",value:"times"},{label:"Arial",value:"arial"},{label:"Courier",value:"courier"}],element:["span","div"]},v=[{type:"Header 1",element:"h1",text:"",styles:"",userStyle:!1},{type:"Header 2",element:"h2",text:"",styles:"",userStyle:!1},{type:"Header 3",element:"h3",text:"",styles:"",userStyle:!1},{type:"Header 4",element:"h4",text:"",styles:"",userStyle:!1},{type:"Header 5",element:"h5",text:"",styles:"",userStyle:!1},{type:"Header 6",element:"h6",text:"",styles:"",userStyle:!1},{type:"Paragraph",element:"p",text:"",styles:"",userStyle:!1}];e.selectedTemplate={},e.selectedStyle={},e.selected_css={},e.additional={style:""},e.isDirtyState=!1,e.selectTemplate=function(t){t.name!==e.selectedTemplate.name&&(e.isDirtyState?m().then(function(e){e&&(h=t,d(t))}):(h=t,d(t)))},e.selectStyle=function(t){t.isExpanded?(t.isExpanded=!1,e.selectedStyle={}):(e.selectedStyle.isExpanded=!1,e.selectedStyle=t,t.isExpanded=!0,r(t.styles),s(),y[t.type]||(y[t.type]={styles:e.selectedStyle.styles,element:e.selectedStyle.element}))},e.deleteStyle=function(t,a){e.selectedTemplate.templateObject.styles.splice(t,1),e.isDirtyState=!0,a.stopPropagation()},e.addStyle=function(){var t={type:"",element:"span",text:"",styles:"",userStyle:!0};e.selectedTemplate.templateObject.styles.push(t),e.selectStyle(t),e.isDirtyState=!0},e.updateElement=function(t){e.selectedStyle.element=t||"",u()},e.updateFont=function(t){e.selected_css.fontFamily.label=t?t.label:"",e.selected_css.fontFamily.value=t?t.value:"",s(),u()},e.updateFontSize=function(t){e.selected_css.fontSize.label=t?t.label:"",e.selected_css.fontSize.value=t?t.value:"",s(),u()},e.updateFontWeight=function(){e.selected_css.fontWeight.value=e.selected_css.fontWeight.bold?"bold":"",s(),u()},e.updateFontStyle=function(){e.selected_css.fontStyle.value=e.selected_css.fontStyle.italic?"italic":"",s(),u()},e.updateTextDecoration=function(){e.selected_css.textDecoration.value="",e.selected_css.textDecoration.value+=e.selected_css.textDecoration.underline?"underline ":"",e.selected_css.textDecoration.value+=e.selected_css.textDecoration.lineThrough?"line-through":"",e.selected_css.textDecoration.value=e.selected_css.textDecoration.value.trim(),s(),u()},e.update_css=function(){s(),u()},e.saveStyles=function(){var i=!0;if(_.each(e.selectedTemplate.templateObject.styles,function(t,o){if(_.find(e.selectedTemplate.templateObject.styles.slice(o+1),{type:t.type})){var r=n("i18n")("config.kaStyle.nameNotUnique.message",t.type);a.error({text:r,clear:!1}),i=!1}}),i){f.dataIsLoading=!0;var o=e.selectedTemplate.templateObject.styles.slice(),r=[];_.remove(o,{styles:""}),_.each(o,function(e){r.push(_.omit(e,"isExpanded"))}),t.updateTemplateStyles(e.selectedTemplate.name,r).then(function(t){t&&t.styles&&t.styles.length&&(h.templateObject.styles=t.styles,e.selectedTemplate.templateObject.styles=_.cloneDeep(t.styles),c(e.selectedTemplate),e.selectedStyle={},p())},function(e){a.error({text:e.data&&e.data.error,clear:!1})})["finally"](function(){f.dataIsLoading=!1})}},e.discard=function(){m().then(function(e){e&&d(h)})},i()}])}(),function(){function e(e,t,a){function n(a){a=a||"";var n=[],o=[],r=[],s=e.get(a+"/smartit/rest/test/getHostNames").then(function(e){for(var t in e.data)n.push({name:t})})["catch"](function(){r.push("Cannot get list of tenants")}),l=e.get(a+"/smartit/rest/test/checks").then(function(e){o=e.data})["catch"](function(){r.push("Cannot get list of checks")});a?c.newHostDataLoading=!0:c.currentHost.tenantsChecksLoading=!0,t.all([s,l])["finally"](function(){if(a){c.newHostDataLoading=!1;var e=c.otherHosts.length;c.otherHosts.push({tenants:n,checks:o,hostName:a,errors:r}),c.otherHosts[e].tenants[0].active=!0,n.forEach(function(t,n){i(a,c.otherHosts[e].tenants[n],angular.copy(o))})}else c.currentHost.errors=r,c.currentHost.tenants=n,c.currentHost.checks=o,c.currentHost.tenants[0].active=!0,c.currentHost.tenantsChecksLoading=!1,n.forEach(function(e,t){i(a,c.currentHost.tenants[t],angular.copy(o))})})}function i(t,a,n){if(a&&n){a.checks=[];var i,o=n.length;for(i=0;i<o;i++)a.checks.push(n[i]),function(o){e.get(t+n[i].endpoint).then(function(e){a.checks[o].status=e.data.status||"UNKNOWN",a.checks[o].enabled=e.data.enabled,a.checks[o].additionalInfo=e.data.enabled?e.data.additionalInfo:e.data.additionalInfo||"DISABLED"})["catch"](function(e){a.checks[o].status="ERROR",a.checks[o].enabled=!1,a.checks[o].additionalInfo="ERROR "+e.status})}(i)}}function o(e,t){t.active||(e.forEach(function(e){e.active&&(e.active=!1)}),t.active=!0)}function r(){c.newHostName=c.newHostName.replace(/(http:|https:)\/\//g,"").split("/")[0],n(c.newHostProtocol+c.newHostName),c.newHostName=""}function s(e,t){t=t||"",e.checks.forEach(function(e){e.status=null,e.enabled=null,e.additionalInfo=null});var a=angular.copy(e.checks);i(t,e,a)}function l(e){var t=c.otherHosts.length-e-1;c.otherHosts.splice(t,1)}var c=this;c.changeActiveTenant=o,c.addNewHost=r,c.restartCheck=s,c.removeHostFromList=l,c.newHostName="",c.newHostProtocol="http://",c.showCurrentHostCheck=!0,c.currentHost={hostName:a.location.host,tenants:[]},c.otherHosts=[],c.$onInit=n}angular.module("adminModule").controller("MonitorController",e),e.$inject=["$http","$q","$window"]}(),function(){angular.module("myitsmApp").constant("accelerators",{ticket:[{key:"email.accelerators.key.casualCI",desc:"email.accelerators.label.casualCI",valueExpr:"exprContext.causalCI.name"},{key:"email.accelerators.key.affectedService",desc:"email.accelerators.label.affectedService",valueExpr:"exprContext.impactedService.name"},{key:"email.accelerators.key.assignedGroup",desc:"email.accelerators.label.assignedGroup",valueExpr:"exprContext.supportGroup.name",onlyFor:[EntityVO.TYPE_WORKORDER,EntityVO.TYPE_SERVICEREQUEST,EntityVO.TYPE_INCIDENT,EntityVO.TYPE_TASK,EntityVO.TYPE_KNOWLEDGE,EntityVO.TYPE_PROBLEM]},{key:"email.accelerators.key.assignee",desc:"email.accelerators.label.assignee",valueExpr:"exprContext.assignee.fullName || exprContext.assignee.firstName+' '+exprContext.assignee.lastName",onlyFor:[EntityVO.TYPE_WORKORDER,EntityVO.TYPE_SERVICEREQUEST,EntityVO.TYPE_INCIDENT,EntityVO.TYPE_TASK,EntityVO.TYPE_KNOWLEDGE,EntityVO.TYPE_PROBLEM,EntityVO.TYPE_KNOWNERROR]},{key:"email.accelerators.key.coordinatorGroup",desc:"email.accelerators.label.coordinatorGroup",valueExpr:"exprContext.supportGroup.name || exprContext.coordinatorGroup.name",onlyFor:[EntityVO.TYPE_CHANGE,EntityVO.TYPE_KNOWNERROR,EntityVO.TYPE_RELEASE]},{key:"email.accelerators.key.changeRequestCoordinator",desc:"email.accelerators.label.changeRequestCoordinator",valueExpr:"exprContext.assignee.fullName || exprContext.assignee.firstName+' '+exprContext.assignee.lastName",onlyFor:[EntityVO.TYPE_CHANGE]},{key:"email.accelerators.key.changeRequestManager",desc:"email.accelerators.label.changeRequestManager",valueExpr:"exprContext.manager.fullName || exprContext.manager.firstName+' '+exprContext.manager.lastName",onlyFor:[EntityVO.TYPE_CHANGE]},{key:"email.accelerators.key.company",desc:"email.accelerators.label.company",valueExpr:"exprContext.company.name"},{key:"email.accelerators.key.requestedFor",desc:"email.accelerators.label.requestedFor",valueExpr:"exprContext.customer.fullName || exprContext.customer.firstName+' '+exprContext.customer.lastName",onlyFor:[EntityVO.TYPE_CHANGE]},{key:"email.accelerators.key.contact",desc:"email.accelerators.label.contact",valueExpr:"exprContext.contact.fullName || exprContext.contact.firstName+' '+exprContext.contact.lastName",onlyFor:[EntityVO.TYPE_WORKORDER,EntityVO.TYPE_SERVICEREQUEST,EntityVO.TYPE_INCIDENT,EntityVO.TYPE_TASK,EntityVO.TYPE_KNOWLEDGE,EntityVO.TYPE_CHANGE]},{key:"email.accelerators.key.customer",desc:"email.accelerators.label.customer",valueExpr:"exprContext.customer.fullName || exprContext.customer.firstName+' '+exprContext.customer.lastName",onlyFor:[EntityVO.TYPE_WORKORDER,EntityVO.TYPE_SERVICEREQUEST,EntityVO.TYPE_INCIDENT,EntityVO.TYPE_TASK,EntityVO.TYPE_KNOWLEDGE]},{key:"email.accelerators.key.desc",desc:"email.accelerators.label.desc",valueExpr:"exprContext.desc"},{key:"email.accelerators.key.displayId",desc:"email.accelerators.label.displayId",valueExpr:"exprContext.displayId"},{key:"email.accelerators.key.investigationDriver",desc:"email.accelerators.label.investigationDriver",valueExpr:"exprContext.investigationDriver"},{key:"email.accelerators.key.location",desc:"email.accelerators.label.location",valueExpr:"exprContext.location.name"},{key:"email.accelerators.key.priority",desc:"email.accelerators.label.priority",valueExpr:"exprContext.priority",type:"priority"},{key:"email.accelerators.key.problemCoordinator",desc:"email.accelerators.label.problemCoordinator",valueExpr:"exprContext.coordinator.fullName || exprContext.coordinator.firstName+' '+exprContext.coordinator.lastName",onlyFor:[EntityVO.TYPE_KNOWNERROR,EntityVO.TYPE_PROBLEM]},{key:"email.accelerators.key.status",desc:"email.accelerators.label.status",valueExpr:"exprContext.status.value",type:"status"},{key:"email.accelerators.key.summary",desc:"email.accelerators.label.summary",valueExpr:"exprContext.summary"},{key:"email.accelerators.key.actualStart",desc:"email.accelerators.label.actualStart",valueExpr:"exprContext.actualStartDateHumanized"},{key:"email.accelerators.key.actualEnd",desc:"email.accelerators.label.actualEnd",valueExpr:"exprContext.actualEndDateHumanized"},{key:"email.accelerators.key.scheduledStart",desc:"email.accelerators.label.scheduledStart",valueExpr:"exprContext.scheduledStartDateHumanized"},{key:"email.accelerators.key.scheduledEnd",desc:"email.accelerators.label.scheduledEnd",valueExpr:"exprContext.scheduledEndDateHumanized"},{key:"email.accelerators.key.targetDate",desc:"email.accelerators.label.targetDate",valueExpr:"exprContext.targetDateHumanized"},{key:"email.accelerators.key.requestManager",desc:"email.accelerators.label.requestManager",valueExpr:"exprContext.manager.fullName",onlyFor:[EntityVO.TYPE_WORKORDER,EntityVO.TYPE_SERVICEREQUEST,EntityVO.TYPE_INCIDENT,EntityVO.TYPE_TASK,EntityVO.TYPE_KNOWLEDGE]},{key:"email.accelerators.key.requestGroup",desc:"email.accelerators.label.requestGroup",valueExpr:"exprContext.managerGroup.name",onlyFor:[EntityVO.TYPE_WORKORDER,EntityVO.TYPE_SERVICEREQUEST,EntityVO.TYPE_INCIDENT,EntityVO.TYPE_TASK,EntityVO.TYPE_KNOWLEDGE]},{key:"email.accelerators.key.releaseCoordinator",desc:"email.accelerators.label.releaseCoordinator",valueExpr:"exprContext.coordinator.fullName",onlyFor:[EntityVO.TYPE_RELEASE]},{key:"email.accelerators.key.requestCoordinator",desc:"email.accelerators.label.requestCoordinator",valueExpr:"exprContext.assignee.fullName",onlyFor:[EntityVO.TYPE_SERVICEREQUEST]},{key:"email.accelerators.key.requestCoordinatorGroup",desc:"email.accelerators.label.requestCoordinatorGroup",valueExpr:"exprContext.supportGroup.name",onlyFor:[EntityVO.TYPE_SERVICEREQUEST]},{key:"email.accelerators.key.resolution",desc:"email.accelerators.label.resolution",valueExpr:"exprContext.resolution",onlyFor:[EntityVO.TYPE_KNOWNERROR,EntityVO.TYPE_PROBLEM]},{key:"email.accelerators.key.rootCause",desc:"email.accelerators.label.rootCause",valueExpr:"exprContext.rootCause",onlyFor:[EntityVO.TYPE_KNOWNERROR,EntityVO.TYPE_PROBLEM]},{key:"email.accelerators.key.workaround",desc:"email.accelerators.label.workaround",valueExpr:"exprContext.workaround",onlyFor:[EntityVO.TYPE_KNOWNERROR,EntityVO.TYPE_PROBLEM]},{key:"email.accelerators.key.viewAccess",desc:"email.accelerators.label.viewAccess",valueExpr:"exprContext.viewAccess",onlyFor:[EntityVO.TYPE_KNOWNERROR]}]})}(),function(){angular.module("myitsmApp").constant("chatDefaults",{additional_namespaces:[{name:"SEARCH",def:"jabber:iq:search"},{name:"INVITE",def:"jabber:x:conference"},{name:"EVENT",def:"jabber:x:event"},{name:"SMARTITIQ",def:"smart-it:iq"},{name:"DELAY",def:"urn:xmpp:delay"},{name:"ARCHIVE",def:"urn:xmpp:archive"},{name:"RSM",def:"http://jabber.org/protocol/rsm"}],conference_service_name:"conference.",resource:"desktop",chatroom_default_config:{allowinvites:1,roomdesc:"Configured MUC room",changesubject:1,persistentroom:1,whois:"anyone",membersonly:0},users_status_list:[EntityVO.CHAT_STATUS_ONLINE,EntityVO.CHAT_STATUS_AWAY,EntityVO.CHAT_STATUS_OFFLINE],manual_statuses:[EntityVO.CHAT_STATUS_ONLINE,EntityVO.CHAT_STATUS_AWAY]})}(),function(){angular.module("myitsmApp").constant("events",{APP_AVAILABILITY_CONFIGURATION:"appAvailabilityConfig",RELOAD_APP_CONFIGURATION:"reloadAppConfiguration",RELOAD_APP_CONFIGURATION_COMPLETED:"reloadAppConfigurationCompleted",PERSON_PERMISSION_DATA_LOADED:"personPermissionDataLoaded",MIDTIER_URL_LOADED:"midtierUrlLoaded",PWA_IFRAME_LOADED:"pwaIframeLoaded",PWA_TASK_MODAL:"pwaTaskModal",PWA_UPDATED_KNOWLEDGE:"pwaUpdatedKnowledge",PERMISSIONS_CHANGED:"permissionsChanged",ERROR_UNAUTHORIZED:"errorUnauthorized",LOGIN_SUCCESS:"myitsm.user.login",LOGIN_REDIRECT:"myitsm.user.loginRedirect",LOGOUT_SUCCESS:"myitsm.user.logout",ADD_COMMENT:"addComment",KNOWLEDGE_ARTICLE_LOADED:"knowledgeArticleLoaded",KNOWLEDGE_ARTICLE_PREVIEW_LOADED:"knowledgeArticlePreviewLoaded",MULTILINE_CONTENT_CHANGED:"multilineContentChanged",TICKET_BASIC_DATA_LOADED:"ticketBasicDataLoaded",SAVE_TO_TICKET_FROM_RS:"saveToTicketFromResourceSlice",REMOVE_FROM_TICKET_FROM_RS:"removeFromTicketFromResourceSlice",RESOLVE_TICKET_FROM_RS:"resolveTicketFromResourceSlice",MARK_AS_DUPLICATE_OF_FROM_RS:"markTicketAsDuplicateOfFromResourceSlice",SELECT_TEMPLATE_FROM_RS:"selectTemplateFromResourceSlice",UNSELECT_TEMPLATE_FROM_RS:"unSelectTemplateFromResourceSlice",DRAFT_TICKET_RESOURCE_RELATED:"draftTicketResourceRelated",DRAFT_TICKET_RESOURCE_UNRELATED:"draftTicketResourceUnrelated",SAVE_CHANGES_REQUEST:"saveChangesRequest",SAVE_CHANGES_COMPLETE:"saveChangesComplete",SAVE_CHANGES_FAULT:"saveChangesFault",SAVE_CHANGES_FAULT_CONTINUE:"saveChangesFaultContinue",SAVE_ALL_CHANGES_COMPLETE:"saveAllChangesComplete",SAVE_ALL_CHANGES_FAULT:"saveAllChangesFault",
SAVE_TICKET_DRAFT:"saveTicketDraft",HIDE_TICKET_DRAFT_LOADER:"hideTicketDraftLoader",AFTER_SAVED_CHANGES:"afterSavedChanges",AFTER_RISK_UPDATE:"afterRiskUpdate",SET_TICKET_DRAFT_MENTIONED:"setTicketDraftMentioned",DISABLE_EDIT_MODE:"disableEditMode",TOGGLE_EDIT_MODE:"toggleEditMode",TOGGLE_DYNAMIC_FIELD_EDIT_MODE:"toggleDynamicFieldEditMode",OPEN_EDIT_MODE:"openEditMode",PROVIDER_SHOW_LOADING:"providerActionShowLoading",PROVIDER_HIDE_LOADING:"providerActionHideLoading",EDIT_COMPLETE:"editComplete",SAVE_CHANGES:"saveChanges",DISCARD_CHANGES:"discardChanges",DISCARD_DOCUMENTS:"discardDocuments",FIELD_VALUE_CHANGE:"fieldValueChange",FIELD_FORM_IS_DIRTY:"fieldFormIsDirty",MODAL_FORM_IS_DIRTY:"modalFormIsDirty",MODAL_BACKDROP_CLICK:"modalBackdropClick",MODAL_BACKDROP_CLICK_PROPOGATE:"modalBackdropClickPropogate",REFRESH_FIELD_VALUES:"refreshFieldValues",CLEAR_DEPENDANT_FIELDS:"clearDependantFieldValues",PROFILE_EDIT_HEADER:"profileEditHeader",TICKET_PREVIEW_LOADED:"addDraftEnd",SET_PREVIEW_ITEM:"setPreviewItem",REFRESH_SEARCH_FILTERS:"refreshSearchFilters",REFRESH_ACTIVITY_FEED:"refreshActivityFeed",REFRESH_RESOURCE_FEED:"refreshResourceFeed",REFRESH_KA_META:"refreshKAMeta",REFRESH_TICKET:"refreshTicket",REFRESH_TICKET_FROM_TITLE_BAR:"refreshTicketFromTitleBar",REFRESH_RELATED_ITEM_LIST:"refreshRelatedItemList",REFRESH_RELEASE_PLAN_LIST:"refreshReleasePlanList",REFRESH_APPROVAL_LIST:"refreshApprovalList",TICKET_PROFILE_RESEND_EVENT:"ticketProfileResendEvent",ASSET_DETAILS_LOADED:"assetDetailsLoaded",ASSET_DETAILS_CHANGED:"assetDetailsChanged",ADD_CUSTOMER_FROM_ASSET:"addCustomerFromAsset",SHOW_MORE_RECORDS:"showMoreRecords",SHOW_LESS_RECORDS:"showLessRecords",SET_FOCUS_TO_ACTIVITY_INPUT:"setFocusToActivityInput",DISMISS_NOTE_FORM:"dismissNoteForm",ADD_FLAG_NOTE:"addFlagNote",KA_UNFLAGGED:"ka-unflagged",SELECT_ACTIVITY_TAB:"selectActivityTab",SELECT_RESOURCE_TAB:"selectResourceTab",CHANGE_TO_EDIT_MODE:"changeToEditMode",CANCEL_EDIT_MODE:"CancelEditMode",CLOSE_TICKET_PREVIEW:"closeTicketPreview",REFRESH_KNOWLEDGE_ARTICLE:"refreshKnowledgeArticle",TOGGLE_KNOWLEDGE_ARTICLE_EDIT_MODE:"toggleKnowledgeArticleEditMode",SHOW_APPROVERS:"showApprovers",REMOVE_LINKED_ITEM:"removeLinkedItem",KNOWLEDGE_ARTICLE_GETTING_EDIT_STATUS:"knowledgeArticleGettingEditStatus",CHANGE_REQUEST_PLANS_EDIT_STATUS:"changeRequestPlansEditStatus",APPROVE_UPDATING_COMPLETE:"approveUpdatingComplete",LINKED_COUNT:"linkedCount",CI_SEARCH:"ciSearch",GLOBAL_MENU_ACTIONS_UPDATE:"globalMenuActionsUpdate",SHOW_PROGRESS_MODAL_FOR_EDIT:"showProgressModalOnEdit",CI_REMOVE_CUSTOM_FILTER:"removeCustomFilterOption",PRESET_REMOVE_FILTER:"presetRemoveFilter",TOGGLE_CHANGE_CALENDAR:"toggleChangeCalendar",CHANGE_WIZARD_FORM_STATE:"changeWizardFormState",RELEASE_WIZARD_FORM_STATE:"releaseWizardFormState",CLEAR_AFFECTED_SERVICE:"clearAffectedService",CLEAR_CATEGORY_DETAILS:"clearCategoryDetails",CLEAR_ALL_CATEGORIES:"clearAllCategories",CLEAR_FOUNDATION_SERVICE:"clearFoundationService",CHANGE_COLLISION_STATUS_CHANGED:"change-collision-status-changed",UPDATE_CHANGE_COLLISION_STATUS:"update-change-collision-status",CHANGE_COLLISION_SHOW_WEEKENDS:"change-collision-show-weekends",TICKET_UPDATE_ROOTCAUSE:"ticket-update-rootcause",ASSET_UPDATE_PRODUCT_CATEGORY_MANUFACTURER:"asset-update-product-category-manufacturer",AFFECTED_SERVICE_UPDATE_SAVED:"affected-service-update-saved",AFFECTED_SERVICE_UPDATED:"affected-service-updated",AFFECTED_SERVICE_VALUE_CHANGED:"affectedServiceValueChanged",AFFECTED_ASSET_UPDATED:"affected-asset-updated",LAST_REPEATER_ELEMENT:"lastRepeaterElement",LINKED_CI_SAVE_COMPLETE:"linked-ci-save-complete",TOGGLE_CHECK_DUPLICATE_MODE:"toggleCheckDuplicateMode",ZOOM_LEVEL_CHANGED:"zoom-level-changed",DUPLICATE_ARTICLE_FOUND:"duplicateArticleFound",DESC_CHANGED:"description-changed",RESOURCES_FOUND:"resources-found",PROBLEM_UPDATE_TARGET_DATE_EVENT:"problemUpdateTargetDate",ASSESSMENT_REMOVE_DUPLICATES:"assessmentRemoveDuplicates",TS_CUSTOM_FIELDS_AVAILABLE:"tsCustomFieldsAvailable",CLEAR_DESC:"clearDescription",FOUNDATION_ADD:"foundationAdd",SELECT_ALL_TICKETS:"selectAllTickets",RELEASE_PLAN_MILESTONE_CHANGE:"releasePlanMilestoneChange",RELEASE_PLAN_MILESTONE_NOT_DIRTY:"releasePlanMilestoneNotDirty",WIDGET_VALUE_CHANGE:"widgetValueChange",FIELD_AREA_ATTACHED:"fieldAreaAttached",WIDGET_VALUE_CHANGE_FROM_WIZARD:"widgetValueChangeFromWiz",FIELD_VALUE_CHANGE_FROM_WIZARD:"fieldValueChangeFromWiz",CONSOLE_REFRESH_METADATA:"refreshMetadata",SHOW_ASSIGN_TICKET_BLADE:"showAssignTicketBlade",TICKET_ASSIGNEES_UPDATED:"ticketAssigneesUpdated",TICKET_ASSIGNEES_UPDATED_FROM_BLADE:"ticketAssigneesUpdatedFromBlade",CHANGE_DATES_VALUE_CHANGED:"changeDatesValueChanged",DISABLE_EDITMODE:"disableEditmode",DISABLE_PARENT_EDITMODE:"disableParentEditmode",DISABLE_EDITPARENT:"disableEditparent",DISABLE_EDIT:"disableEdit",DISABLE_CHILD_EDITMODE:"disableChildEditmode",DISABLE_EDITCHILD:"disableEditchild",EDIT_STATUS_CLICK:"editStatusClick",CHANGE_CLASS_VALUE_CHANGED:"changeclassvaluechanged",CLEAR_CHANGE_DATES:"clearchangedates",TICKET_TEMPLATE_UPDATED:"ticketTemplateUpdated",SHOW_DYNAMIC_FIELDS_FROM_TEMPLATE:"showDynamicFieldsFromTemplate",CUSTOM_FIELD_VALUE_CHANGE:"customFieldValueChange",RELATIONS_UPDATE_COMPLETE:"relationsUpdateComplete",CLOSE_EDIT_MODE_ON_STATUS_CLOSED_FROM_BLADE:"closeEditModeOnStatusClosedFromBlade",RISK_LEVEL_CHANGE:"riskLevelChange",RISK_MODE_MANUAL:"riskModeManual",RISK_MODE_AUTO:"riskModeAuto",RISK_QUESTION_LOADED:"riskQuestionsLoaded",RELOAD_RISK_QUESTION:"reloadRiskQuestion",ELLIPSIS_EVENT:"dibari:refresh-ellipsis",REFRESH_RECOMMENDED_KNOWLEDGE:"refreshRecommendedKnowledge",PROVIDER_ACTION:"providerAction",SAVE_COPY_CHANGE_DRAFT:"save-copy-change-draft",SAVE_COPY_CHANGE_ACTIVITY:"save-copy-change-draft-activity",UPDATE_SCHEDULE_DATE:"updateScheduleDate",ADD_NEW_ACTIVITY_FEED_TO_LIST:"addNewActivityFeedToList",RESET_DYNAMIC_FIELDS:"resetDynamicFields",UPDATE_DYNAMIC_DATA:"updateDynamicData",WORKNOTE_REQUIRED:"workNoteRequired",UPDATE_CONTEXT_ON_REFRESH:"updateContextOnRefresh",STATUS_VALUE_CHANGED:"statusValueChanged",COMPANY_VALUE_CHANGED:"companyValueChanged",SERVICECI_REQUIRED:"serviceCiRequired",ON_SELECTED_LIVE_CHAT:"onSelectedChat",SHARE_KNOWLEDGE_TO_LIVE_CHAT:"shareKnowledgeToLiveChat",PERSON_DATA_LOADED:"personDataLoaded",SEARCH_TEXT_CHANGED:"searchTextChanged",TICKET_CREATED_FROM_DRAFT:"ticketCreatedFromDraft",RELATE_TICKET_TO_CHAT:"relateTicketToChat",UPDATE_DATE_LABEL_VISIBILITY:"updateDateLabelVisibility",UNRELATE_TICKET_TO_CHAT:"unrelateTicketToChat",LIVECHAT_CREATEINCIDENT_SUCCESS:"LIVECHAT_CREATEINCIDENT_SUCCESS",LIVECHAT_CREATEWORKORDER_SUCCESS:"LIVECHAT_CREATEWORKORDER_SUCCESS",TICKET_SHOW_LOADER:"ticketShowLoader",TICKET_HIDE_LOADER:"ticketHideLoader",DRAFT_TICKET_CLOSED:"draftTicketClosed",SAVE_INPUT_BEFORE_SAVE:"saveSmartRecorderInputBeforeSave",INSIDE_CHANGE_CALENDAR:"insideChangeCalendar",APPLY_COGNITIVE_SG:"applyCognitiveToSupportGroup"}).constant("AUTH_EVENTS",{LOGIN_SUCCESS:"auth-login-success",LOGIN_FAILED:"auth-login-failed",LOGOUT_SUCCESS:"auth-logout-success",SESSION_ACTIVE:"auth-session-active",SESSION_TIMEOUT:"auth-session-timeout",NOT_AUTHENTICATED:"auth-not-authenticated",NOT_AUTHORIZED:"auth-not-authorized",SESSION_EXPIRED:"auth-session-expired",UPDATE_GRID_COLUMNS:"update-grid-columns",AR_CONNECTION_FAILED:"ar-connection-failed",INITIALIZE_METADATA_ERROR:"initialize-metadata-error"})}(),function(){angular.module("myitsmApp").constant("roles",{ITSM_ADMIN_ROLE:"galileo-admin-access",ITSM_AGENT_ROLE:"galileo-normal-access",ITSM_CHANGE_USER_ROLE:"galileo-change-access",ITSM_KNOWLEDGE_USER_ROLE:"galileo-knowledge-access",ITSM_PROBLEM_USER_ROLE:"galileo-problem-access",ITSM_KCS_COACH_ROLE:"galileo-kcscoach-access",ITSM_PEOPLE_USER_ROLE:"galileo-people-access",ITSM_ASSET_USER_ROLE:"galileo-asset-access",ITSM_ASSET_ADMIN_ROLE:"galileo-asset-admin-access",ITSM_RELEASE_USER_ROLE:"galileo-release-access",ITSM_SBE_USER_ROLE:"galileo-sbe-access",ITSM_BROADCAST_USER_ROLE:"galileo-broadcast-access",ESCHAT_AGENT_ROLE:"galileo-eschat-access",ESCHAT_ADMIN_ROLE:"galileo-eschat-admin-access",ITSM_ASSET_CREATOR_ROLE:"galileo-asset-creator"})}(),function(){angular.module("adminModule").controller("CustomActionEditorController",["$filter","$modalInstance","$rootScope","$scope","$timeout","events","screenObj","screenConfigurationModel","systemAlertService","i18nService","$q","metadataModel",function(e,t,a,n,i,o,r,s,l,c,d,u){function p(e){var t,a,i=!0;return a=_.filter(n.templateList,function(t){return t.name===e.actionName}),0!==a.length||e["delete"]||(e.isTemplateFromList=!1,i=!1),_.forEach(e.mappings,function(e){e.error=!1,"input-ticket"!==e.type&&"output"!==e.type||(t=_.filter(n.acceleratorList,function(t){return t.key===e.mappedFieldValue}),0===t.length&&(e.error=!0,i=!1)),"input-default"===e.type&&(""===e.mappedFieldValue&&"text"===e.dataType||(""===e.mappedFieldValue.trim()||isNaN(e.mappedFieldValue))&&"number"===e.dataType)&&(e.error=!0,i=!1),e.error||delete e.error}),i}function m(){n.actionList=s.actionList,n.actionOrder=s.actionOrder,n.dataLoading=!1;var t=e("i18n")("screenConfiguration.customActionEditor.configurationUpdatedSuccessfully");l.success({text:t,clear:!0,hide:1e4}),g(),I?s.loadActionsForRuntimeV2(n.resouceType,!0).then(function(){"global"===n.resouceType&&a.$broadcast(o.GLOBAL_MENU_ACTIONS_UPDATE)}):s.loadActionsForRuntime(n.resouceType,!0).then(function(){"global"===n.resouceType&&a.$broadcast(o.GLOBAL_MENU_ACTIONS_UPDATE)})}function f(){n.dataLoading=!1;var t=e("i18n")("screenConfiguration.customActionEditor.configurationUpdateFailure");l.error({text:t,clear:!1}),g()}function g(){t.dismiss()}function h(){var t={},a=["default","en","es","fr","zh","it","ko","de","ru","ja","he","pt","pl"];return _.forEach(a,function(a){t[a]=e("i18n")("customization.locale.label."+a),console.log(a)}),t}function y(){n.dataLoading=!0;var e,t,a;n.screenObj=r,n.resouceType="undefined"!=typeof r&&r.hasOwnProperty("datasource")?r.datasource.toLowerCase():"global","global"!==n.resouceType&&(I=r.isV2Compatible()),I&&L(n.resouceType);var i=function(e,t){if(n.acceleratorsList=[],n.reverseMap={},e)for(var a in e)e.hasOwnProperty(a)&&(n.reverseMap[e[a]]=a,t?n.acceleratorsList.push({name:"["+a+"]",desc:e[a]}):n.acceleratorsList.push({name:"["+e[a]+"]",desc:a}))},o=function(e){n.acceleratorsListForExpressions=[],n.reverseMap={};var t;if(e){for(var a in e)e.hasOwnProperty(a)&&(t="$"+a,/[^a-zA-Z0-9_$]+/g.test(t)&&(t="'"+t.replace("'","'")+"'"),n.acceleratorsListForExpressions.push({name:t,desc:e[a]}));n.acceleratorsListForExpressions=_.sortBy(n.acceleratorsListForExpressions,"name")}};I?(e=n.resouceType.toLowerCase(),t=s.getAccelerators(e,n.screenObj.name).then(function(t){w(t,"accelerator"),i(t,!0),s.isTicketEnabledForProviderActionExpression(e)&&o(t)}),s.providerHardReload=!0,a=s.loadActionsNew(n.resouceType).then(function(){n.actionList=s.actionList,n.actionOrder=s.actionOrder,s.isTicketEnabledForProviderActionExpression(e)?(n.isExpressionDrivenAction=!0,n.actionList.length&&_.forEach(n.actionList,function(e){e.expressions&&e.expressions.length?_.forEach(e.expressions,function(t){e.expressionCondition=t.condition,e.showExecuteOn=!0,e.selectedExecuteOnProperty=t.executeOn?_.find(n.providerActionExecuteOnPropOptions,{value:t.executeOn}):n.providerActionExecuteOnPropOptions[0]}):(e.expressionCondition="",e.showExecuteOn=!1,e.selectedExecuteOnProperty=n.providerActionExecuteOnPropOptions[0])})):n.isExpressionDrivenAction=!1})):(e=n.resouceType.toLowerCase(),t=s.getAccelerators(e,n.screenObj.name).then(function(e){w(e,"accelerator"),i(e)}),a=s.loadActions(n.resouceType).then(function(){n.actionList=s.actionList,n.actionOrder=s.actionOrder})),n.assetTypes=[],n.assetTypesSelected=[],d.all([t,a]).then(function(){n.accelerators.availableExpressions=n.acceleratorsList,n.supportedLocales=h(),"custom"!==n.actionOrder?n.sortableOptions.disabled=!0:n.sortableOptions.disabled=!1,n.postValidate=!1,n.resouceType===EntityVO.TYPE_ASSET?(u.getMetadataByType(n.resouceType).then(function(e){n.assetTypes=e.assetTypes,n.allChecked=!0,n.dataLoading=!1}),n.assetUpdateFields=["name","status","statusReason","company","partNumber","productName","model","manufacturer","supplier","installationDate","room","floor","site","primaryCapability","productCategoryTier1","productCategoryTier2","productCategoryTier3"]):n.dataLoading=!1})}n.acceleratorsList=[],n.providerFieldList=[],n.providerMode=[{label:c.getLocalizedString("customization.globalMenu.action.mode.both"),value:"both"},{label:c.getLocalizedString("customization.globalMenu.action.mode.view"),value:"view"},{label:c.getLocalizedString("customization.globalMenu.action.mode.edit"),value:"edit"}],n.mappedSourceList=[{label:c.getLocalizedString("customization.globalMenu.action.fromTicket"),value:"ticket"},{label:c.getLocalizedString("customization.globalMenu.action.userPrompt"),value:"prompt"},{label:c.getLocalizedString("customization.globalMenu.action.defaultValue"),value:"default"}],n.isTemplateLoaded=!1;var E,v,T=!1,S=!1,C=0,O=0,A={enter:13,escape:27,tab:9,leftArrow:37,rightArrow:39,upArrow:38,downArrow:40,space:32},I=!1;n.actionObj={},n.hasInputFields=!1,n.hasOutputFields=!1;var b=[A.leftArrow,A.rightArrow,A.enter,A.upArrow,A.downArrow,A.tab];n.accelerators={expression:"",showAcceleratorsList:!1},n.acceleratorList=[],n.handleBodyKeyDown=function(e){219!==e.which&&219!==e.keyCode&&"["!==e.key||(n.accelerators.showAcceleratorsList=!0,C=e.target.selectionStart,T=!0),n.accelerators.showAcceleratorsList&&(b.indexOf(e.keyCode)>=0||e.keyCode===A.space&&S)&&e.preventDefault()},n.handleBodyChange=function(t){v=t.target;var a,o=v.value,r=-1,s=!1;if(!n.accelerators.showAcceleratorsList){for(a=0;a<o.length;a++)"["!==o[a]||s?"]"===o[a]&&s&&(s=!1,r=-1):(s=!0,r=a);r>-1&&(n.accelerators.showAcceleratorsList=!0,C=r,T=!0,(b.indexOf(t.keyCode)>=0||t.keyCode===A.space&&S)&&t.preventDefault())}if(O=t.target.selectionEnd,v.value.length>1&&T&&C>O)return void(n.accelerators.showAcceleratorsList=!1);if(n.accelerators.showAcceleratorsList){if(S&&[A.tab,A.rightArrow,A.space].indexOf(t.keyCode)>=0)return void(S=!1);if(T&&t.keyCode===A.tab){var l=v.value;n.typeAheadListPos===n.acceleratorsList.length-1?n.typeAheadListPos=0:n.typeAheadListPos++;var c=n.acceleratorsList[n.typeAheadListPos]?n.acceleratorsList[n.typeAheadListPos].name:"",d=[l.slice(0,C),c,l.slice(O)].join("");return O=parseInt(C+c.length),E=d.substring(C,O),void i(function(){v.setSelectionRange(C,O),v.selectionStart=C,v.selectionEnd=O})}if(t.ctrlKey===!0||t.altKey===!0||t.keyCode===A.leftArrow||t.keyCode===A.rightArrow)return;if(t.keyCode===A.upArrow)return void(n.typeAheadListPos>0&&n.typeAheadListPos--);if(t.keyCode===A.downArrow)return void(n.typeAheadListPos<n.acceleratorsList.length-1&&n.typeAheadListPos++);if(t.keyCode===A.enter)return n.accelerators.expression=E,void n.insertAcceleratorText();if(t.keyCode===A.escape)return void n.disableTypeAheadMode()}n.openActionItem.url&&n.openActionItem.url.length?T&&(E=v.value.substring(C,O),n.typeAheadListPos=0):T&&n.hideTypeAheadPopup(),T&&E.length>0&&E!==n.accelerators.expression&&(n.acceleratorsList=e("filter")(n.accelerators.availableExpressions,{name:E.substring(1)}),n.acceleratorsList.length>0||0===n.accelerators.expression.length?(n.acceleratorsList.length>0?n.accelerators.showAcceleratorsList=!0:angular.noop(),n.accelerators.expression=E,n.popupLeftPosition=0,n.popupTopPosition=0):0===n.acceleratorsList.length&&n.accelerators.expression.length>1&&n.hideTypeAheadPopup())},n.handleBodyClick=function(e){if(O=e.target.selectionEnd,e.target.value.length>1&&n.accelerators.showAcceleratorsList&&C>O)return void(n.accelerators.showAcceleratorsList=!1)},n.acceleratorMouseover=function(e){n.typeAheadListPos=e},n.insertAcceleratorText=function(e){var t=v.value,a=e||n.acceleratorsList[n.typeAheadListPos],i=a.name,o=t;if(n.accelerators.expression){if(0===C)o=i+" ";else if(O<t.length)o=[t.slice(0,C),i,t.slice(O)].join("");else if(O===t.length){var r=t.substr(0,t.length-E.length)+i;o=r}}else 0===t.length?o=i:O>0?o=[t.slice(0,O)," "+i+" ",t.slice(O)].join(""):o+=" "+i;n.disableTypeAheadMode(),n.openActionItem.url=o},n.hideTypeAheadPopup=function(){n.accelerators.showAcceleratorsList=!1},n.disableTypeAheadMode=function(){E="",n.accelerators.expression="",n.accelerators.showAcceleratorsList=!1,n.typeAheadListPos=0,n.acceleratorsList=null,T=!1,C=0,O=0},n.acceleratorsHelp=function(){E="[",n.accelerators.expression="",n.accelerators.showAcceleratorsList=!0,n.typeAheadListPos=0,n.acceleratorsList=n.accelerators.availableExpressions,C=angular.element(".active .action-url")[0].value.length},n.sortableOptions={update:function(e,t){"custom"!==n.actionOrder&&t.item.sortable.cancel()},stop:function(){n.actionList.forEach(function(e,t){e.sequenceNo=t+1})}},n.onCancelClick=function(){g()},n.onSaveClick=function(){var e=[];n.reOrderActionList(n.actionOrder);for(var t=0;t<n.actionList.length;t++){var a=n.actionList[t];if("provider"===a.actionType&&""===a.actionName||"client"===a.actionType&&""===a.url||a.isLabelEmpty())return I&&("provider"!==a.actionType||a["delete"]||a.parseItem(r)),a.closeItem(),n.openAction(a,!0),void(n.postValidate=!0);if("launch"===a.actionType){var i=_.find(a.subActions,{name:"assetUpdate"});if(a.convertToOldVO(),i&&!i.fields.length||!a.subActions.length)return a.closeItem(),n.openAction(a),void(n.postValidate=!0)}else if(I)if("provider"!==a.actionType||a["delete"])"client"===a.actionType&&(a.screenId=r.id);else{if(a.parseItem(r),!p(a))return a.closeItem(),void n.openAction(a);a.expressionCondition?(a.expressions?(a.expressions[0].condition=a.expressionCondition,a.expressions[0].executeOn=a.selectedExecuteOnProperty.value):(a.expressions=[],a.expressions.push({condition:a.expressionCondition,resource:a.resource,sequenceNo:a.sequenceNo,executeOn:a.selectedExecuteOnProperty.value})),delete a.expressionCondition):a.expressions&&(delete a.expressions,delete a.expressionCondition),delete a.isTemplateFromList}else a.convertToOldVO();delete a.label,e.push(a)}n.dataLoading=!0,I?(s.providerHardReload=!0,s.createUrlAction(e,n.actionOrder,n.resouceType).then(m,f)):s.saveActionConfiguration(e,n.actionOrder,n.resouceType).then(m,f)},n.clear=function(){n.actionObj.actionName="",n.isTemplateLoaded=!1},n.clearTemplateFields=function(){n.isTemplateLoaded=!1},n.reOrderActionList=function(t){n.closeAllAction(),n.actionOrder=t,"custom"!==t?(n.sortableOptions.disabled=!0,n.actionList=_.sortBy(n.actionList,function(t){return t.labels["default"]||e("i18n")("customization.globalMenu.action.label.default")}),n.actionList.forEach(function(e,t){e.sequenceNo=t+1})):n.sortableOptions.disabled=!1},n.closeAllAction=function(){n.actionList.forEach(function(e){e.closeItem()})};var k=function(e){if(n.hasInputFields=!1,n.hasOutputFields=!1,e&&e.length>0)for(var t in e)0===e[t].type.indexOf("input")&&(n.hasInputFields=!0),"output"===e[t].type&&(n.hasOutputFields=!0)},D=function(e,t){n.isTemplateLoading=!0,s.getTemplateById(e).then(function(e){n.actionObj=n.openActionItem,e&&n.actionObj.isV3ProviderAction()&&(n.actionObj.templateId!==e.id||t?(n.actionObj.mode=_.find(n.providerMode,{value:"both"}),n.actionObj.templateId=e.id,n.actionObj.formName=e.formName,_.forEach(e.mappings,function(e){R(e)}),n.actionObj.mappings=e.mappings,n.actionObj.isSynchronous=!_.isUndefined(_.find(e.mappings,{type:"output"}))):(_.forEach(n.actionObj.mappings,function(t){var a=_.find(e.mappings,{mappedFieldId:t.mappedFieldId,type:0===t.type.indexOf("input")?"input":"output"});t=a?_.assign(t,{paramType:0===t.type.indexOf("input")?"input":"output"}):_.assign(t,{"delete":!0})}),_.remove(n.actionObj.mappings,{"delete":!0}),_.forEach(e.mappings,function(e){var t=_.find(n.actionObj.mappings,{mappedFieldId:e.mappedFieldId,paramType:e.type});t?(t.mappedFieldName=e.mappedField&&e.mappedField.label||e.mappedFieldName,t.sequence=e.sequence,P(t,e),t.mappedSource=_.find(n.mappedSourceList,{value:t.type.substring(6)}),t.mappedFieldValue||(t.mappedFieldValue="")):n.actionObj.mappings.push(R(e))}))),k(n.actionObj.mappings),n.isTemplateLoaded=!0,n.isTemplateLoading=!1},function(){})},R=function(e){return e.mappedSource=_.find(n.mappedSourceList,{value:"ticket"}),P(e,e),e},P=function(e,t){e.dataType=t.mappedField&&t.mappedField.dataType?t.mappedField.dataType:"text",e.mappingOptions=n.mappedSourceList};n.openAction=function(e,t){e.isOpen?e.closeItem():(n.closeAllAction(),n.openActionItem=e,e.openItem(),"client"!==e.actionType&&(e.mode&&!e.mode.value&&(e.mode=_.find(n.providerMode,{value:e.mode})),D(e.templateId,t)))},n.createAction=function(){var e=new ActionVO,t=n.resouceType||"global";e.setResource(t),n.actionList||(n.actionList=[]),"asset"===n.resouceType&&e.setAssetScope(),e.mode="both";var a=n.resouceType.toLowerCase();s.isTicketEnabledForProviderActionExpression(a)&&(e.selectedExecuteOnProperty=n.providerActionExecuteOnPropOptions[0]),n.actionList.push(e),n.reOrderActionList(n.actionOrder),n.openAction(e)},n.addLabel=function(e){for(var t in n.supportedLocales)if(n.supportedLocales.hasOwnProperty(t)&&!e.labels.hasOwnProperty(t))return void(e.labels[t]="")},n.removeLabel=function(e,t){e.removeLabel(t)},n.updateLabel=function(e,t,a){e.labels[a]=e.labels[t],n.removeLabel(e,t)},n.deleteAction=function(e,t){e.stopPropagation();var a=l.modal({title:c.getLocalizedString("common.notification.delete.action.title"),text:c.getLocalizedString("common.notification.delete.action.message"),buttons:[{text:c.getLocalizedString("common.labels.yes"),data:t},{text:c.getLocalizedString("common.labels.no")}]});a.result.then(function(e){_.isEmpty(e)||(e.deleteItem(),_.remove(n.actionList,function(e){return!e.id&&e["delete"]}))})},n.toggleSupportedType=function(e,t){if(e.isSupported(t)){for(var a=0;a<e.supportedPlatforms.length&&e.supportedPlatforms[a]!==t;a++);e.supportedPlatforms.splice(a,1)}else e.supportedPlatforms.push(t)},n.toggleUserInput=function(e,t){if(_.find(e.subActions,{name:t}))e.subActions=_.reject(e.subActions,{name:t});else{var a={resource:"asset",name:t};"assetUpdate"===t&&(a.fields=[]),e.subActions.push(a)}},n.providerActionExecuteOnPropOptions=[{name:e("i18n")("screenConfiguration.providerAction.executeOn.OnFieldValueChange"),value:"On Field Value Change"},{name:e("i18n")("screenConfiguration.providerAction.executeOn.OnLoad"),value:"On Ticket Load"}],n.updateproviderActionExecuteOnProperty=function(e,t){t.selectedExecuteOnProperty=e},n.checkItem=function(e,t,a){var n=e.scope.assetClass,i=a?a.name:"ALL",o=t.name||t.label;e.scope.assetClass.ALL=!1,e.isAssetClassChecked(o,i)?n[o].splice(n[o].indexOf(i),1):"ALL"===i?n[o]=[i]:n[o]&&n[o].length?n[o].push(i):n[o]=[i]},n.expandType=function(e,t){"dropdown-item-inline_selected"!==t.target.className&&"dropdown-item-inline"!==t.target.className&&(_.forOwn(n.assetTypes,function(t){e.label!==t.label&&(t.expanded=!1)}),e.expanded=!e.expanded)},n.addAssetFieldToUpdate=function(e,t){_.forOwn(e.subActions,function(e){if("assetUpdate"===e.name){var a=e.fields.indexOf(t);a===-1?e.fields.push(t):1===e.fields.length?e.fields=[]:e.fields.splice(a,1)}})},n.checkAll=function(e){e.scope.assetClass.ALL=!e.scope.assetClass.ALL};var w=function(e,t){n[t+"List"]=[];for(var a in e)"accelerator"===t?n[t+"List"].push({label:e[a],key:a}):n[t+"List"].push(e[a])},L=function(e){s.getTemplateList(!1,e).then(function(e){w(e,"template")},function(){})};n.loadAcceleratorList=function(e){s.getAccelerators(e,n.screenObj.name).then(function(e){w(e,"accelerator")},function(){})},n.onTemplateSelect=function(e){n.isTemplateLoaded=!1,D(e.id)},n.updateFieldType=function(e,t){e.mappedSource=t},n.getFieldLabel=function(e){var t=_.find(n.acceleratorList,{key:e});return t?t.label:c.getLocalizedString("asset.explorer.field.na")},n.toggleExecuteOn=function(e){e.expressionCondition=e.showExecuteOn?e.expressionCondition:null},y()}])}(),function(){angular.module("adminModule").controller("CustomAreaEditorController",["$q","$log","$filter","$modalInstance","$rootScope","$scope","$timeout","customArea","allPanels","events","screenConfigurationModel","systemAlertService","metadataModel","layoutConfigurationModel","IconArray","keywordEvaluatorService","expressionSyntaxTreeBuilder",function(e,t,a,n,i,o,r,s,l,c,d,u,p,m,f,g,h){function y(e){return e.expanded=!e.expanded,e}function E(e){e.editable=!e.readOnly,e.hide&&0===e.hideConditionFlag&&(e.hide=!1),e.readOnly&&e.required&&0===e.requiredConditionFlag&&(e.required=!1),e.readOnly||(e.readOnlyCondition="",e.readOnlyConditionFlag=0),o.markFieldUpdated(e)}function v(){var e=_.uniqBy(o.AssociateActionLists,function(e){return e.entryId});for(var t in e){var a=_.uniqBy(e[t].mappedFields,function(e){return e.fieldId});e[t].mappedFields=angular.copy(a)}o.AssociateActionLists=angular.copy(e)}function T(e){for(var t in e)if(e[t].isMapped===!1&&o.AssociateActionLists.length>0)for(var a in o.AssociateActionLists){var n=o.AssociateActionLists[a].mappedFields;for(var i in n)e[t].itsmFieldId===n[i].fieldId&&(n.splice(i,1),o.AssociateActionLists[a].mappedFields=n)}else e[t].isMapped===!0&&null!==e[t].mappedAction&&o.AssociateActionLists.length>0&&z(e[t])}function S(e){for(var t in e)if(o.AssociateActionLists.length>0)for(var a in o.AssociateActionLists){var n=o.AssociateActionLists[a].mappedFields;for(var i in n)e[t].itsmFieldId===n[i].fieldId&&(n.splice(i,1),o.AssociateActionLists[a].mappedFields=n)}}function C(e){var t="";return t=e.isWidget()?o.getWidgetFieldLabel(e):e.arFieldName||e.label}function O(){o.availableFields=_.sortBy(G.filter(function(e){var t=!1;if(e.isWidget()&&!e.label&&L(e),e.searchLabel||(e.searchLabel=e.isWidget()?o.getWidgetFieldLabel(e):e.label),e.isWidget()){e.enableFieldForSelection();var a=e.members.some(function(e){return s.fields.concat($).some(function(t){return t.isGroupField()?t.members.some(function(t){return t.isEqual(e)}):e.isEqual(t)})});a&&e.disableFieldSelection()}if(e.isWidgetMember()){var n=s.fields.concat($).some(function(t){return!(!t.isWidget()||t.name===EntityVO.WIDGET_IMPACTED_AREAS&&e.name!==EntityVO.FIELD_REQUESTED_BY_COMPANY)&&_.findIndex(t.members,{name:e.name})>-1});n?e.disableFieldSelection():e.enableFieldForSelection()}return s.fields.forEach(function(a){t||(e.isEqual(a)?t=!0:a.isWidget()||a.members.forEach(function(a){t||e.isWidget()||e.name!==a.name||(t=!0)}))}),s.isFieldAvailableOnPanel(e)||e.disableFieldSelection(),!t}),"label"),o.showAvailabilityWarning=_.some(o.availableFields,function(e){return!e.isAvailable()})}function A(){n.dismiss()}function I(e){return ScreenConfigurationVO.prototype.isV2Compatible(e)&&!ScreenConfigurationVO.prototype.isCreateScreen(e)}function b(){var e=d.isV2CompatibleScreen(s.parentScreenName),t=e?{fromConfig:!0}:angular.noop();d.loadScreenConfigurationByName(s.parentScreenName,!0,t).then(function(){var t=o.availableFields.some(function(e){return e.isMissingSystemRequiredField()});if(o.AssociateActionLists.length>0&&I(o.screenName)){v();var n=s.dataSource.toLowerCase();d.providerHardReload=!0,d.createUrlAction(o.AssociateActionLists,"custom",n).then(function(e){console.log("actionlist save",e)})}var r=a("i18n")("screenConfiguration.customAreaEditor.fieldConfigurationUpdatedSuccessfully");u.success({text:r,clear:!0,hide:1e4}),i.$broadcast(c.RELOAD_APP_CONFIGURATION_COMPLETED,{invalidCustomizations:t?{missingSystemFields:!0}:null,screenName:s.parentScreenName}),t&&e&&u.warning({text:a("i18n")("customAreaEditor.invalidCustomizations.warning"),clear:!1})})["finally"](function(){o.dataLoading=!1,A()})}function k(){o.dataLoading=!1;var e=a("i18n")("screenConfiguration.customAreaEditor.fieldConfigurationUpdateFault");u.error({text:e,clear:!1})}function D(){_.forEach(o.AssociateActionLists,function(e){e.mappedFields&&e.mappedFields.length>0&&_.forEach(e.mappedFields,function(t){R(s.fields,t,e)})})}function R(e,t,a){_.forEach(e,function(e){e.name===t.fieldName&&P(e,a,t.iconName),"group"===e.dataType&&R(e.members,t,a)})}function P(e,t,a){e.isMapped=!0,e.mappedAction=t,e.selectedIcon=a}function w(){var t=angular.copy(d.screensCacheByName[s.parentScreenName]);o.dataLoading=!0,o.customArea=s,o.screenName=s.parentScreenName,x=s.fields,l&&l.length>1&&(o.allPanels=l,o.allPanels.forEach(function(e){e.selectedPanel=e.name===s.name})),t&&($=t.panels.reduce(function(e,t){return t.name===s.name?e:e.concat(t.fields)},[]));var a=s.dataSource.toLowerCase(),n=d.getAccelerators(a,s.parentScreenName).then(function(e){var t;if(o.acceleratorsList=[],e){for(var a in e)e.hasOwnProperty(a)&&(t="$"+a,/[^a-zA-Z0-9_$]+/g.test(t)&&(t="'"+t.replace("'","'")+"'"),o.acceleratorsList.push({name:t,desc:e[a]}));o.acceleratorsList=_.sortBy(o.acceleratorsList,"name"),o.acceleratorsList=_.union(o.acceleratorsList,g.getSupportedKeywords())}});if(I(o.screenName)){d.providerHardReload=!0;var i=d.loadActionsNew(a).then(function(){o.AssociateActionLists=d.actionList,D(),_.forEach(o.AssociateActionLists,function(e){e.name=e.actionType+":"+e.labels["default"],e.value=e.sequenceNo})})}o.enableExpression=_.includes(EntityVO.ENTITIES_WITH_NEW_CUSTOMIZATION,a);var r=p.getMetadataByType(a).then(function(e){if(o.diffFields=[],o.valueFieldNames={},e){o.assetTypes=e.assetTypes;for(var t in e.availableValueFields)e.availableValueFields.hasOwnProperty(t)&&(o.valueFieldNames[e.availableValueFields[t]]=t,o.diffFields.push({value:e.availableValueFields[t],name:t}))}});if(o.fieldsLoading=!1,"typeSpecific"===s.shortId)o.fieldsLoading=!0,o.selectedClass={},e.all([r,n]).then(function(){o.dataLoading=!1});else{o.fieldsLoading=!1;var c=d.loadFields(s).then(function(){s.initFields(d.selectedFieldDictionary),s.addFieldAllowed=s.hasAvailableSlots(),G=d.getAvailableFieldsForScreen(s.parentScreenName),N(),O()});e.all([r,c,n,i]).then(function(){s.initValueFieldNames(o.valueFieldNames),s.fields.forEach(function(e){L(e),e.isGroupField()&&(e.initialMembers=angular.copy(e.members))}),o.dataLoading=!1})}}function L(e){return e.isWidget()&&!e.label&&(e.label=a("i18n")("field.widget."+e.name+".label")),e.label}function N(){F();var e=G.filter(function(e){return e.isWidget()})||[],t=s.fields.concat($).filter(function(e){return e.isWidget()})||[],a=s.fields.reduce(function(e,t){return t.isWidget()||(t.isGroupField()?e=e.concat(t.members):e.push(t)),e},[]);e.concat(t).forEach(function(e){e.members.forEach(function(t){var n=_.find(G.concat(a),function(e){return e.isEqual(t)});n&&n.fillParentInfo(e)})})}function M(e){V(e)||G.push(e)}function V(e){return G.some(function(t){return t.isEqual(e)})}function F(){s.fields.forEach(function(e){e.isWidget()&&e.members.forEach(function(e){var t=V(e);e.label&&!t&&G.push(e)})})}var x,G=[],$=[];o.acceleratorsList=[],o.AssociateActionLists=[],o.icons=f,o.screenName="",o.sortableOptions={placeholder:"field-item-placeholder",connectWith:".group-field-item-container",update:function(e,t){if(!t.item.sortable.droptarget.hasClass("group-field-item-container")&&!t.item.sortable.droptarget.hasClass("group-field-item__dropbox")||t.item.sortable.model.isMenuField()){if((t.item.sortable.droptarget.hasClass("group-field-item-container")||t.item.sortable.droptarget.hasClass("group-field-item__dropbox"))&&t.item.sortable.model.isMenuField()){var a=t.item.sortable.model;o.enableExpression&&_.remove(s.addedFields,{name:a.name}),t.item.sortable.model.groupMember=!0}}else t.item.sortable.cancel();t.item.sortable.droptarget.hasClass("group-field-item-container")||t.item.sortable.droptarget.hasClass("group-field-item__dropbox")||!t.item.sortable.model.isGroupMember()||(t.item.sortable.model.groupMember=!1,t.item.sortable.model.id&&t.item.sortable.model.parentId&&(s.hasAvailableSlots()?s.addField(t.item.sortable.model):t.item.sortable.cancel()))}},o.onSelectIcon=function(e,t){t.selectedIcon=e},o.groupSortableOptions={placeholder:"field-item-placeholder",connectWith:".field-item-container",cancel:".group-field-item__dropbox, input",update:function(e,t){o.markFieldUpdated(t.item.sortable.sourceModel)}};var B=a("i18n")("screenConfiguration.customAreaEditor.fieldAvailabilityWarning"),U=a("i18n")("customAreaEditor.headerSection.maxFieldsWarning");
o.showAvailabilityWarning=!1,o.tooltipPosition=window.isRtl?"left":"right",o.onAddFieldClick=function(e){if(e.isAvailable()&&s.hasAvailableSlots()){if(e.id){var t=!1;s.removedFields.forEach(function(a,n){if(e.isEqual(a))return s.removedFields.splice(n,1),t=!0,!1}),t||(e.isNewField=!0),s.addField(e)}else{var a=angular.copy(e);a.sealed=e.isSealed(),a.isNewField=!0,s.addField(a)}O()}},o.onExpandFieldClick=function(e){y(e)},o.onRemoveFieldClick=function(e){s.removeField(e),e.id&&M(e),O()},o.onRemoveFieldClickFromGroup=function(e,t){_.remove(e.members,function(e){return e.name===t.name}),s.removeFieldFromGroup(t),o.markFieldUpdated(e),t.id&&M(t),O()},o.generateSystemFieldRemoveWarningText=function(e){var t=ScreenConfigurationVO.prototype.CREATE_SCREENS.indexOf(s.parentScreenName)!==-1,n=a("i18n")("ticket.type."+s.dataSource),i="customAreaEditor.field.systemRequired.remove.warning";return e.isGroupField()?i="customAreaEditor.groupField.systemRequired.remove.warning":e.isWidget()&&(i="customAreaEditor.widget.systemRequired.remove.warning"),i+=t?".create":".edit",a("i18n")(i,n)},o.handleRemoveGroupClick=function(e){var t=e.checkSystemRequiredFlag();t?e.showDeleteConfirmationTooltip=!0:o.removeGroupField(e)},o.removeGroupField=function(e){e.members.forEach(function(e){s.removeFieldFromGroup(e),e.id&&G.indexOf(e)===-1&&G.push(e)}),s.removeField(e),O()},o.cancelGroupFieldRemove=function(e){e.showDeleteConfirmationTooltip=!1},o.onHidePropertyChange=function(e){e.hide&&0===e.hideConditionFlag&&(e.readOnly=!!e.readOnlyCondition,e.required=!!e.requiredCondition),e.hide||(e.hideCondition="",e.hideConditionFlag=0),o.markFieldUpdated(e)},o.onSetValuePropertyChange=function(e){e.setValueConditionFlag||(e.setValueCondition=""),o.markFieldUpdated(e)},o.onRequiredPropertyChange=function(e){e.required&&(e.editable=!0),e.required&&e.readOnly&&0===e.readOnlyConditionFlag&&(e.readOnly=!1),e.required&&e.hide&&0===e.hideConditionFlag&&(e.hide=!1),e.required||(e.requiredCondition="",e.requiredConditionFlag=0),o.markFieldUpdated(e)},o.onAssociatedActionPropertyChange=function(e){e.isMapped||(e.selectedIcon="",e.mappedAction=null)},o.onEditablePropertyChange=function(e,t){t?E(e):!e.editable&&e.required&&(e.required=!1),o.markFieldUpdated(e)},o.markFieldUpdated=function(e){d.markFieldUpdated(e,s)},o.onCancelClick=function(){A()};var z=function(e){var t={},a={};t.fieldId=e.itsmFieldId,t.fieldName=e.name,t.sequence=1,t.iconName=e.selectedIcon,a=e.mappedAction,delete e.isMapped,delete e.mappedAction,delete e.selectedIcon,delete a.name,delete a.value;for(var n in o.AssociateActionLists)if(a.entryId===o.AssociateActionLists[n].entryId){if(o.AssociateActionLists[n].mappedFields.length>0)for(var i in o.AssociateActionLists[n].mappedFields)t.fieldId===o.AssociateActionLists[n].mappedFields[i].fieldId&&o.AssociateActionLists[n].mappedFields.splice(i,1);o.AssociateActionLists[n].mappedFields.push(t)}else if(a.entryId!==o.AssociateActionLists[n].entryId&&o.AssociateActionLists[n].mappedFields.length>0)for(var r in o.AssociateActionLists[n].mappedFields)t.fieldId===o.AssociateActionLists[n].mappedFields[r].fieldId&&o.AssociateActionLists[n].mappedFields.splice(r,1)};o.onSaveClick=function(){var e,t,n,i,r,l=1;for(e=0;e<s.fields.length;e++)if(n=s.fields[e],n.expanded=!1,n.isGroupField()){for(n.label=n.label+"_"+l,l++,t=0;t<n.members.length;t++){if(i=n.members[t],i.expanded=!1,i.requiredConditionFlag){if(!i.requiredCondition)return y(i),!1;try{h(i.requiredCondition)}catch(c){return y(i),!1}}if(i.readOnlyConditionFlag){if(!i.readOnlyCondition)return y(i),!1;try{h(i.readOnlyCondition)}catch(c){return y(i),!1}}if(i.hideConditionFlag){if(!i.hideCondition)return y(i),!1;try{h(i.hideCondition)}catch(c){return y(i),!1}}if(i.setValueConditionFlag){if(!i.setValueCondition)return y(i),!1;try{h(i.setValueCondition)}catch(c){return y(i),!1}}if(i.isMapped&&(!i.mappedAction||!i.selectedIcon))return y(i),!1}if(0===n.members.length){y(n);var p=a("i18n")("customAreaEditor.field.groupField.empty");return u.error({text:p,clear:!1}),!1}T(n.members)}else{if(n.requiredConditionFlag){if(!n.requiredCondition)return y(n),!1;try{r=h(n.requiredCondition)}catch(c){return y(n),!1}if(d.checkExpressionValid(r,o.acceleratorsList))return y(n),!1}if(n.readOnlyConditionFlag){if(!n.readOnlyCondition)return y(n),!1;try{r=h(n.readOnlyCondition)}catch(c){return y(n),!1}if(d.checkExpressionValid(r,o.acceleratorsList))return y(n),!1}if(n.hideConditionFlag){if(!n.hideCondition)return y(n),!1;try{r=h(n.hideCondition)}catch(c){return y(n),!1}if(d.checkExpressionValid(r,o.acceleratorsList))return y(n),!1}if(n.setValueConditionFlag){if(!n.setValueCondition)return y(n),!1;try{r=h(n.setValueCondition)}catch(c){return y(n),!1}if(d.checkExpressionValid(r,o.acceleratorsList))return y(n),!1}if(n.isMapped&&(!n.mappedAction||!n.selectedIcon))return y(n),!1}for(T(s.fields),e=0;e<s.addedFields.length;e++){var m=s.addedFields[e];if(m.isMapped&&null!==m.mappedAction&&o.AssociateActionLists.length>0&&z(m),m.dependency)for(var f=0;f<m.dependency.length;f++)if(m.dependency[f].availability&&0!==m.dependency[f].availability){y(m);var g=a("i18n")("customAreaEditor.field.dependency.warn");return u.error({text:g,clear:!1}),!1}"typeSpecific"===s.shortId&&m.extension.push({classId:o.selectedClass.name})}s.removedFields.length>0&&S(s.removedFields),o.dataLoading=!0,d.savePanelConfiguration(s).then(b,k)},o.onCreateGroup=function(){var e=(new FieldVO).build({type:"groupField",dataType:"group",editable:!0,name:"Customization Group",label:"Customization Group"});s.addField(angular.copy(e))},o.checkDiffValue=function(e){e.diffCheck||(e.valueField=""),o.markFieldUpdated(e)},o.updateDiffValueField=function(e,t){e.valueField=t.value,o.markFieldUpdated(e)},o.setDiffValueFieldonBlur=function(e){var t=_.get(_.find(o.diffFields,{name:e.valueFieldName}),"value");t&&(e.valueField=t,o.markFieldUpdated(e))},o.getFieldWarn=function(e){var t="";if(!e.isAvailable()||e.isSelectionDisabled())if(e.isWidget())if(s.isFieldAvailableOnPanel(e)){var n=s.fields.concat($).reduce(function(t,a){if(a.isGroupField())e.members.forEach(function(e){a.isFieldMemberOfThisGroup(e)&&t.push(e.label)});else{var n=e.members.some(function(e){return e.isEqual(a)});n&&t.push(a.label)}return t},[]);t=a("i18n")("customAreaEditor.field.widget.warn",n.join("; "))}else t=a("i18n")("customAreaEditor.field.widget.notAvailableOnPanelWarn");else if(e.widgetMember){var i="",o=_.find(s.fields.concat($),function(t){return!!t.isWidget()&&_.findIndex(t.members,{name:e.name})>-1});o&&(i=L(o)),t=a("i18n")("customAreaEditor.field.widgetMember.warn",i)}else{var r=e.fieldUnavailableOn.join(", ");t="["+C(e)+"]: "+a("i18n")("customAreaEditor.field.warn",r)}else t=C(e),e.isMissingSystemRequiredField()&&(t="["+C(e)+"]: "+a("i18n")("customAreaEditor.field.systemRequired.tooltip"));return t},o.getDependencyFieldWarn=function(e){var t="";return t=e.availability?a("i18n")("customAreaEditor.field.warn",e.fieldUnavailableOn.join(", ")):a("i18n")("customAreaEditor.field.dependency.ok")},o.getWidgetFieldLabel=function(e){return L(e)+" "+a("i18n")("customAreaEditor.fieldTypes.widget")},o.getFieldAvailabilityWarning=function(){var e=B;return s.isHeaderSection()&&!s.hasAvailableSlots()&&(e=U),e},o.selectClass=function(t){s.fields=x,o.customArea=s,o.selectedClass=t,o.dataLoading=!0,o.fieldsLoading=!1,s.classId=t.name;var a=d.loadFields(s).then(function(){s.initFields(d.selectedFieldDictionary),s.addFieldAllowed=s.hasAvailableSlots(),G=d.getAvailableFieldsForScreenByClassId(s.parentScreenName,o.selectedClass),N(),O()});e.all([a]).then(function(){s.initValueFieldNames(o.valueFieldNames),o.dataLoading=!1})},o.changeCustomArea=function(e){s.selectedPanel=!1,s=e,w()},w()}])}(),function(){angular.module("myitsmApp").directive("fieldItem",[function(){return{restrict:"E",replace:!0,templateUrl:"views/admin/screen-configuration/field-item.html",scope:{field:"=",pfield:"=?",isGroupField:"=",onExpandFieldClick:"=",onRemoveFieldClick:"=?",onRemoveFieldClickFromGroup:"=?",onRequiredPropertyChange:"=",onEditablePropertyChange:"=",checkDiffValue:"=",setDiffValueFieldonBlur:"=",getDependencyFieldWarn:"=",tooltipPosition:"=",updateDiffValueField:"=",diffFields:"=",associatedActionLists:"=",onAssociatedActionPropertyChange:"=",icons:"=",onSelectIcon:"=",screenName:"="},link:function(e){e.selectIconOptions=[{name:"@",value:0},{name:"&",value:1}]}}}])}(),function(){var e=angular.module("adminModule");e.constant("IconArray",["icon-align_center","icon-align_left","icon-align_right","icon-angle_down","icon-angle_left","icon-angle_right","icon-angle_up","icon-arrow_down_circle","icon-arrow_left_circle","icon-arrow_right_circle","icon-arrow_up_circle","icon-arrow_down","icon-arrow_left","icon-arrow_right","icon-arrow_up","icon-arrow_right_square_o","icon-at","icon-bars_right","icon-bars_left","icon-bell_o","icon-bell","icon-bold","icon-book_o","icon-bookmark","icon-box","icon-calendar","icon-cart_o","icon-cart","icon-case","icon-chart_area","icon-chart_bar","icon-chart_pie","icon-check_bookmark","icon-check_circle_o","icon-check_circle","icon-check_shield","icon-check_square_o","icon-check","icon-circle_25_o","icon-circle_50_o","icon-circle_75_o","icon-circle_thin_o","icon-circle_o","icon-circle_slash_o","icon-circle","icon-circles","icon-clock_o","icon-cloud_o","icon-cloud","icon-comment_dots","icon-comment","icon-comments_o","icon-comments","icon-cross_bookmark","icon-cross_circle_o","icon-cross_circle","icon-cross_square","icon-cross","icon-cube_square","icon-cube_o","icon-database_o","icon-database","icon-download","icon-drag_and_drop","icon-ellipsis","icon-envelope_o_circle","icon-envelope_o","icon-envelope","icon-exclamation_circle","icon-exclamation_hexagon","icon-exclamation_triangle","icon-exit","icon-expand","icon-file_arrow_png_o","icon-file_arrow_svg_o","icon-file_chart_o","icon-file_exclamation_o","icon-file_infinity_o","icon-file_o","icon-file_plus_o","icon-file_pulse_o","icon-file_question_o","icon-file_task_o","icon-file_template_o","icon-file_text_o","icon-file_text","icon-file_wrench_o","icon-files_change_o","icon-files_copy_o","icon-files_o","icon-filter","icon-flag_o","icon-flag","icon-flash","icon-flow","icon-folder","icon-gear","icon-heart_o","icon-heart","icon-image_square","icon-indent_decrease","icon-indent_increase","icon-infinity","icon-info_circle","icon-italic","icon-keyboard_close_o","icon-keyboard","icon-layout","icon-lightbulb_o","icon-link","icon-list_ordered","icon-list_unordered","icon-list","icon-load_balancer","icon-lock","icon-mapmarker","icon-microphone","icon-minus_circle","icon-minus","icon-nic_square","icon-nic","icon-paperclip_square","icon-paperclip","icon-pause_circle_o","icon-pause","icon-pdf_square","icon-pencil","icon-phone","icon-photocamera","icon-pin_circle","icon-pin","icon-play_o","icon-plus_circle","icon-plus","icon-pop_in","icon-pop_up","icon-printer","icon-qrcode","icon-question_circle","icon-refresh","icon-repeat","icon-reply","icon-sandglass","icon-screens","icon-search_exclamation","icon-search_minus","icon-search_plus","icon-search","icon-server_o","icon-server","icon-share","icon-snap_to_grid","icon-software_o","icon-software","icon-sort","icon-speaker","icon-square_o","icon-square","icon-squares_back","icon-squares_front","icon-star_half","icon-star_o","icon-star","icon-storage_o","icon-storage","icon-strikeout","icon-table","icon-thumbs_down","icon-thumbs_up","icon-trash","icon-tag","icon-text","icon-triangle_down_circle_o","icon-triangle_down","icon-triangle_left","icon-triangle_lower_right","icon-triangle_right","icon-triangle_up","icon-underline","icon-undo","icon-user_arrow_circle","icon-user_circle","icon-user_o","icon-user_plus_circle","icon-user_plus","icon-user","icon-users_circle","icon-users_o","icon-users","icon-vip","icon-wall","icon-word_square","icon-xls_square","icon-cube_users_o","icon-wrench","icon-uml","icon-dots","icon-app_cd","icon-app_lock","icon-arrow_chart","icon-arrow_left_square_o","icon-arrow_right_square_input","icon-arrow_upper_right","icon-arrows_right","icon-atom_gear","icon-atom","icon-calendar_exclamation_bubble","icon-calendar_solid","icon-car","icon-case_wrench","icon-connection","icon-dollar","icon-exclamation_bubble_o","icon-eye","icon-facilities","icon-file_atom_o","icon-file_check_o","icon-file_dollar_o","icon-file_info_o","icon-file_lightbulb_o","icon-file_triangle_o","icon-files_triangle_o","icon-filter_o","icon-hands","icon-hash","icon-internet","icon-mapmarker_o","icon-mobile","icon-monitor_gear_key","icon-monitor_key","icon-monitor_server","icon-monitor_user","icon-monitor_users_circle","icon-laptop_server","icon-laptop_user","icon-plane","icon-presentation_square","icon-question_circle_o","icon-research","icon-scales","icon-storages","icon-tag_dollar","icon-target_cursor","icon-user_check","icon-user_clock_o","icon-video_square","icon-webcamera","icon-wrench_o","icon-ticket","icon-file_cloud_o","icon-exclamation_mark","icon-phone_o","icon-folder_open","icon-binoculars","icon-txt_square","icon-constraint","icon-constraint_table","icon-constraint_check","icon-constraint_diamond","icon-file_refresh","icon-file_chart","icon-file_clock","icon-calendar_check","icon-arrow_schema","icon-database_pencil","icon-database_plus","icon-database_cross","icon-comment_text","icon-layout_copy","icon-layout_circle","icon-layout_circle_o","icon-exclamation_bubble","icon-internet_circle","icon-phone_circle","icon-arrow_upper_right_circle","icon-home","icon-envelope_microphone_o","icon-file_contract","icon-key","icon-table_plug","icon-collapse","icon-cross_shield","icon-exclamation_shield","icon-line_shield","icon-file_template_gear_o","icon-monitor","icon-layout_preview","icon-lines","icon-tiles","icon-arrow_squares","icon-epsilon","icon-compass","icon-send","icon-user_clock","icon-case_arrow_down","icon-cyclic","icon-file_dashed","icon-file_code_o","icon-folder_o","icon-java","icon-lock_open","icon-loader","icon-app_gear","icon-app_eye","icon-file_cube_o","icon-unlink","icon-app","icon-app_connection","icon-app_flag","icon-app_list","icon-calendar_clock_o","icon-colorpicker","icon-cube_o_chain","icon-user_o_chain","icon-container","icon-area_text","icon-field_text","icon-field_integer_number","icon-field_decimal_number","icon-field_floating_number","icon-field_dropdown","icon-form_record","icon-pannel_color","icon-ellipsis_horizontal","icon-ghost","icon-hadoop","icon-magic_ball","icon-folder_crown_o","icon-restart","icon-file_aft_o","icon-file_bo_o","icon-file_cognos_o","icon-file_datastage_o","icon-file_etl_infa_o","icon-file_mainframe_job_o","icon-file_msg_o","icon-file_oebs_o","icon-file_oracle_bi_o","icon-file_psb_o","icon-file_sap_o","icon-file_ws_o","icon-sticker_new","icon-app_check_circle","icon-app_cross_circle","icon-app_pencil_circle","icon-app_plus_circle","icon-cache_plus_circle","icon-comment_o","icon-database_refresh","icon-internet_plus_circle","icon-flash_circle","icon-plug_connect_square_heart","icon-plug_connect_square","icon-screens_plus_circle","icon-screens_triangle_down_circle","icon-wrench_circle","icon-file_json_o","icon-file_o_view","icon-files_o_view","icon-file_o_archive","icon-archive_square","icon-brackets_curly","icon-lock_shield","icon-arrow_right_brackets","icon-file_exclamation_bubble_o","icon-cube_lightbulb_o","icon-drive_arrow_down","icon-drive_arrow_right","icon-drive_arrow_up","icon-android","icon-angle_down_square","icon-angle_up_square","icon-app_atom","icon-app_cd_gear","icon-app_facilities","icon-app_gear_inside","icon-arrow_chart_circle","icon-arrow_chart_pause_circle","icon-arrow_chart_play_circle","icon-arrow_chart_restart_circle","icon-arrow_chart_scales","icon-arrows_cycle","icon-asterisk_circle_o","icon-balancer_arrow","icon-battery","icon-blackberry","icon-cache_web_node","icon-calendar_cross_circle_o","icon-calendar_restart_circle_o","icon-cassette","icon-cd_drive","icon-cd_drives","icon-cd_puzzle","icon-cd_storage","icon-cd_web_node","icon-cd","icon-cds","icon-chart_pie_gear","icon-chip_san","icon-chrome","icon-circle_curve","icon-circle_line_square","icon-circle_wide_o","icon-hexagon_circle","icon-cluster_one_drive","icon-cluster","icon-cubes_o","icon-curve_arrow_square","icon-data_center","icon-group_circle_o","icon-group_circle","icon-group_parent","icon-ellipsis_circle_o","icon-ellipsis_horizontal_bottom","icon-facilities_chain","icon-facilities_mapmarker","icon-facilities_puzzle","icon-file_o_gear_server","icon-file_o_arrows","icon-file_o_gear_mapmarker","icon-file_o_gear","icon-file_task_o_arrow_chart","icon-files_o_lns","icon-files_o_wall","icon-files_o_web_node","icon-firefox","icon-firewall","icon-floppy","icon-hands_atom","icon-hands_circle_atom","icon-hands_circle_file_atom_o","icon-hands_circle","icon-hands_gear","icon-hexagon_concave_down","icon-hexagon_concave_up","icon-hexagon_horizontal","icon-hexagon_vertical","icon-hub_san","icon-hub","icon-ie","icon-mainframe","icon-monitor_gear_arrow_up_circle","icon-monitor_gear_atom","icon-monitor_gear_check_circle","icon-monitor_gear_puzzle","icon-monitor_gear_web_node","icon-monitor_gear","icon-monitor_keyboard","icon-netscape","icon-nic_square_dashed_web_node","icon-nic_square_ipx","icon-nic_square_lan","icon-nic_square_wan","icon-number_square_one","icon-number_square_two","icon-number_square_three","icon-number_square_four","icon-number_square_five","icon-octagon_concave","icon-octagon_flash","icon-octagon_rectangle_o","icon-octagon_rectangle","icon-octagon","icon-opera","icon-parallelogram_ajax","icon-parallelogram_css","icon-parallelogram_html","icon-parallelogram_js","icon-parallelogram_xml","icon-parallelogram","icon-pentagon","icon-plug_connect_square_o","icon-puzzle","icon-router_san","icon-router","icon-safari","icon-server_app_cd","icon-server_cd_drive","icon-server_comment_o","icon-server_database","icon-server_dns","icon-server_envelope_o","icon-server_file_code_o","icon-server_file_o","icon-server_ftp","icon-server_gear","icon-server_internet","icon-server_key","icon-server_ldap","icon-server_lock","icon-server_mobile","icon-server_monitor_cube_o","icon-server_monitor_puzzle","icon-server_monitor_vm","icon-server_printer","icon-server_uddi","icon-server_web_node","icon-speedometer","icon-square_academic_cap","icon-square_concave","icon-storage_cd_drive","icon-storage_database","icon-storage_monitor_gear","icon-storage_raid","icon-storage_san","icon-switch_san","icon-switch","icon-switches_circle_o","icon-switches_circle","icon-switches","icon-tablet","icon-ups","icon-user_clock_gear","icon-web_node","icon-app_box_open_o","icon-file_chart_bar_o","icon-web","icon-layout_c","icon-layout_c46","icon-layout_c64","icon-hexagon_circle_o","icon-layout_c55","icon-layout_container","icon-layout_hcf","icon-layout_hc","icon-layout_hc46","icon-layout_hc55","icon-layout_hcf46","icon-layout_hcf64","icon-layout_hcf55","icon-drive_arrow_down_check_circle","icon-drive_arrow_down_clock","icon-drive_arrow_down_cross_circle","icon-drive_arrow_right_check_circle","icon-drive_arrow_right_clock","icon-drive_arrow_right_cross_circle","icon-drive_arrow_up_check_circle","icon-drive_arrow_up_clock","icon-drive_arrow_up_cross_circle","icon-case_gear","icon-envelope_o_gear","icon-upload","icon-dummy","icon-asterisk_circle","icon-switcher_active","icon-angles_left","icon-angles_right","icon-arrow_square_down","icon-bookmark_o","icon-clock_o_dashed","icon-cloud_arrow_down","icon-cloud_arrow_up","icon-cube_web_node","icon-flag_half","icon-flag_quarter_o","icon-flag_quarter","icon-lines_vertical","icon-minus_square_o","icon-parallelogram_case","icon-pinned","icon-plus_square_o","icon-rhomb_concave","icon-rhomb","icon-servers_circle_o","icon-triangle_isosceles_down","icon-triangle_isosceles_up","icon-triangle_right_circle_o","icon-case_bag","icon-text_colorpicker","icon-retro_multiple","icon-retro","icon-list_arrows","icon-field_dropdowns","icon-file_arrows","icon-bmc_helix","icon-switcher_check","icon-minus_circle_o","icon-plus_circle_o","icon-action_button_cursor","icon-paperclip_square_dashed","icon-file_circle_slash_pencil","icon-folder_lock","icon-comment_question_o","icon-lightbulb_uml","icon-brackets_curly_cross_circle","icon-brackets_curly_dropdown","icon-brackets_curly_plus_circle","icon-double_arrow","icon-laptop_server_storage","icon-export","icon-file_arrow_csv","icon-files_change_auto","icon-file_task_auto","icon-file_text_lock_shield","icon-milestone","icon-button_panel_o","icon-redo","icon-slider","icon-user_cross_circle","icon-key_right","icon-angle_right_circle","icon-app_chart_bar","icon-app_list_arrow_chart","icon-app_list_chart","icon-app_list_eye","icon-gear_play_circle","icon-group_parent_circle_o","icon-monitor_gear_eye","icon-move_expand","icon-note_pencil","icon-scissors","icon-user_check_circle","icon-app_arrows","icon-file_arrow_right","icon-files_text","icon-squares_arrows","icon-box_check_o","icon-circle_ibm","icon-file_2200","icon-file_checks_o","icon-file_psft","icon-file_tndm","icon-file_transfer","icon-lightbulbs_list","icon-check_adapt","icon-cross_adapt","icon-file_mft","icon-pause_adapt","icon-user_star","icon-angle_right_circle_o","icon-exclamation_circle_o","icon-list_arrow_exclamation_circle","icon-activity_feed_clock_o","icon-cloud_atom","icon-cloud_mapmarker","icon-field_autocomplete_search","icon-magic_ball_octagon_flash","icon-magic_ball_octagon_rectangle","icon-magic_ball_octagon_rectangle_o","icon-magic_ball_cross_circle","icon-meter_logo","icon-user_arrow_o","icon-file_arrow_down","icon-adjust_settings","icon-app_info_bar","icon-app_tab","icon-circles_arrows","icon-field_text_paperclip","icon-tag_key","icon-user_card","icon-calendar_server","icon-chart_donut","icon-toolbox","icon-app_arrow_chart_down","icon-app_arrow_chart_up","icon-box_arrows","icon-cloud_user","icon-cube_cloud","icon-file_text_arrows","icon-files_arrows","icon-arrows_right_app","icon-chart_bar_2","icon-filter_adapt","icon-flag_adapt","icon-pencil_adapt","icon-plus_adapt","icon-question_circle_adapt","icon-question_circle_o_adapt","icon-refresh_adapt","icon-trash_adapt","icon-arrow_left_eye","icon-arrow_right_eye","icon-box_search","icon-cube_cross_circle","icon-credit_card_user","icon-file_arrows_check","icon-file_monitor","icon-file_task_share","icon-file_task_undo","icon-headphones","icon-lines_search","icon-monitor_binoculars","icon-servers","icon-skip_next","icon-field_custom","icon-field_ootb","icon-widget"])}(),function(){angular.module("adminModule").controller("LaunchActionController",["$filter","$modal","$rootScope","$scope","$log","$q","events","metadataModel","screenConfigurationModel","screenConfigurationService","systemAlertService","layoutConfigurationModel","objectValueMapperService","$window","expressionEventManager","expressionEvaluatorService","$timeout",function(e,t,a,n,i,o,r,s,l,c,d,u,p,m,f,g,h){function y(e){p.clearProviderActionFieldName(e.actionFieldName,e.actionId),E(e),n.providerActionsList.length&&h(function(){n.launchActionFromExpression(n.providerActionsList)})}function E(e){p.clearProviderActionFromList(e)}var v,T,S,C,O;n.providerActionToExecute=p.providerActionToExecute,n.context=n.context?n.context:n.ticket,C=n.bulkContextType?n.bulkContextType:n.context.ticketType||n.context.type,s.getMetadataByType(C).then(function(e){T=e});var A=function(e){n.actionLists=e,n.fieldActionMapping={};for(var t in e)if(e[t].mappedFields&&e[t].mappedFields.length>0){var a=e[t].mappedFields,i=_.uniqBy(a,function(e){return e.fieldName});for(var o in i)n.fieldActionMapping[i[o].fieldName]={action:e[t],iconName:i[o].iconName}}p.setFieldActionMapping(n.fieldActionMapping,n.context.type)},I=function(e){var t;e&&(_.forEach(e,function(e){e.expressions&&e.expressions.length&&_.forEach(e.expressions,function(a){p.addToProviderActionExpressionMapper(a.condition,e),"On Ticket Load"===a.executeOn&&(t=!0)})}),t&&f.handleTicketLoadForActions())};EntityVO.ENTITIES_WITH_NEW_CUSTOMIZATION.indexOf(C)!==-1&&(l.providerHardReload=!0,n.associateActionPromise=l.loadActionsNew(n.context.type).then(function(){n.AssociateActionLists=l.actionList,A(n.AssociateActionLists),l.isTicketEnabledForProviderActionExpression(C)&&I(n.AssociateActionLists)})),n.showEditor=function(a,n,i,o){v=t.open({templateUrl:"views/admin/screen-configuration/provider-user-prompt.html",windowClass:"action-blade provider-user-prompt",backdrop:"custom",resolve:{ticket:["ticketModel",function(e){return e.getTicket(o,i.resource)}]},controller:["$scope","ticket",function(t,s){function l(){t.cancelExecution()}var c,u={},p={},m=function(e,t){if(e.isCheckboxField()){var a=e.options[0]||{};(_.includes(a,t)||["true","checked"].indexOf(t)!==-1||0===t)&&e.setValue(0)}else if(e.hasDateDataType()||e.hasDateTimeDataType()){var n=moment(t);if(n.isValid())e.setValue(n.valueOf());else{var i=moment(+t);i.isValid()&&e.setValue(i.valueOf())}}else if(e.hasTimeDataType()){var o=new RegExp(/am|pm/,"ig"),r="HH:mm";o.test(t)&&(r="hh:mma");var s=moment(t,r);s.isValid()&&(e.value=s.valueOf())}else if(e.isDropdownField()||e.isRadioField()){var l=_.find(e.options,function(e){return _.includes(e,t)});l&&e.setValue(l.name)}else e.setValue(t)};t.fieldArray=n.prompt,t.editMode=!0,t.ticket=s,t.fieldArray.forEach(function(e){e.defaultValue&&m(e.mappedField,e.defaultValue)}),t.getMappedFieldRenderType=function(e){var t="text";return e.isCheckboxField()?t="checkbox":e.hasDateDataType()?t="date":e.hasDateTimeDataType()?t="datetime":e.hasTimeDataType()?t="time":e.isNumberField()?t="number":(e.isDropdownField()||e.isRadioField())&&(t=e.options.length>0?"enum":"text"),t},t.executeAction=function(){var r=!1,s="";for(var l in t.fieldArray)c=t.fieldArray[l],u[c.mappedFieldId]=f(c.mappedField),null!==u[c.mappedFieldId]&&""!==u[c.mappedFieldId]||(s+=c.mappedFieldName+" ",r=!0);if(r){var m=s+e("i18n")("common.labels.nonEmpty");d.error({text:m,clear:!0,hide:1e4})}else p={},_.extend(p,n,u),a(p,i,o),v.dismiss()},t.cancelExecution=function(){O=!1,v.dismiss(),y(i)};var f=function(e){var t=e.getValue();return e.isDropdownField()?e.options.length&&!e.ootb&&null!==t&&(t=_.get(_.find(e.options,{name:t}),"name")):e.isCheckboxField()&&null===t&&(t=-1),t};t.$on(r.MODAL_BACKDROP_CLICK,l)}],size:"sm"})},n.displaypromptModal=function(e,t,a,i,o){l.getTemplateById(a).then(function(a){_.each(t.prompt,function(e){var t=e.mappedFieldId,n=_.find(a.mappings,{mappedFieldId:t});_.isUndefined(n)||(e.defaultValue=n.defaultValue||"",e.mappedFieldName=n.mappedField.label||n.mappedFieldName,e.dataType=n.mappedField.dataType,e.mappedField=(new FieldVO).build(n.mappedField),e.mappedField.hideLabel=!0,e.mappedField.isReadOnly=!1,e.mappedField.isRequired=!1,e.mappedField.isHidden=!1,e.sequence=n.sequence)}),t.prompt=_.sortBy(t.prompt,"sequence"),n.showEditor(e,t,i,o)})},n.launchAction=function(t,a,o,r){if(i.topic("actionExecution",t,a),"client"===a){for(var s=new RegExp("\\[\\w+\\]"),u=t.url,p="new"===t.target?"_blank":"_self",f=function(e){return e.name===h};u.search(s)!==-1;){var g=u.match(s),h=g[0].replace(/[\[\]']+/g,"");if(n.context.customFields&&angular.isDefined(n.context.customFields[h])){var y=_.find(l.fieldLabels,f);u=y&&y.options&&y.options.length>n.context.customFields[h]?u.replace(s,y.options[n.context.customFields[h]].label):u.replace(s,n.context.customFields[h])}else{var E=c.getContextPropertyByMetadataMapping(n.context,T,h)||"",v=e("localizeLabel")(E,h,n.context.type);u=u.replace(s,v||E)}}i.topic("actionExecution","Launch URL action",u,p),m.open(encodeURI(u),p)}else"launch"===a?n.launchActionCallback({actionItem:t,event:o}):(S=C===EntityVO.TYPE_ASSET?n.context.reconciliationId:n.context.id,EntityVO.ENTITIES_WITH_NEW_CUSTOMIZATION.indexOf(n.context.type)!==-1?(i.topic("providerExecution","New Provider action",t,S),r?n.getInputParams(t,n.context,n.executeActionFromExpressionCallback,S):n.getInputParams(t,n.context,n.executeActionCallback,S)):(i.topic("actionExecution","Old Provider action",t.id,S),l.executeProviderAction(t.id,S).then(function(){var a=e("i18n")("screenConfiguration.providerActionExecuted",t.actionName);d.success({text:a,clear:!0,hide:1e4})})["catch"](function(e){d.error({text:e.data&&e.data.error?e.data.error:e.defaultMessage,clear:!1})})))},n.getInputParams=function(e,t,a,o){var r,s,l,c,d,u={prompt:[]},m=!1;for(d in e.mappings)if(c=e.mappings[d],0===c.type.indexOf("input"))if(c.mappedFieldValue&&c.type.indexOf("ticket")!==-1){if(l=c.mappedFieldValue,s=p.getFieldDefinitionByName(l,c.mappedFieldId),r=p.getExactValueByFieldName(l),i.topic("providerExecution",c.type,"fieldName:",l,"value :",r),s&&(s.isDropdownField()||s.isRadioField())){var f=_.find(s.options,{name:r});r=f?f.index:void 0}_.isString(r)&&s&&(s.isCheckboxField()||""===r&&s.isNumberField())&&(r=void 0),s&&(s.isDateTimeField()||s.isDateField())&&!r&&(r=null),u[c.mappedFieldId]=r,i.topic("providerExecution",c.type,u)}else c.type.indexOf("prompt")!==-1?(m=!0,u.prompt.push(c),i.topic("providerExecution",c.type,u)):c.type.indexOf("default")!==-1&&(c.mappedFieldValue?u[c.mappedFieldId]=c.mappedFieldValue:u[c.mappedFieldId]="",i.topic("providerExecution",c.type,u));return m?n.displaypromptModal(a,u,e.templateId,e,o):(a(u,e,o),i.topic("providerExecution",e,u)),u};var b=function(e,t){i.topic("providerExecution","setOutputParams",t),_.isEmpty(t)||(i.topic("providerExecution","OPEN_EDIT_MODE"),a.$broadcast(r.OPEN_EDIT_MODE),h(function(){p.setFieldFromProvider(t,e.mappings).then(function(){i.topic("providerExecution","Loaded output values")})}))};n.executeActionCallback=function(t,a,o){delete t.prompt,a.isSynchronous&&n.$emit(r.PROVIDER_SHOW_LOADING),l.executeProviderActionV3(a.id,o,t).then(function(t){b(a,t);var o=e("i18n")("screenConfiguration.providerActionExecuted",a.label);n.$emit(r.PROVIDER_HIDE_LOADING),i.topic("providerExecution","Show success message"),d.success({text:o,clear:!0,hide:1e4})})["catch"](function(e){n.$emit(r.PROVIDER_HIDE_LOADING),d.error({text:e.data&&e.data.error?e.data.error:e.defaultMessage,clear:!1})})},n.executeActionFromExpressionCallback=function(t,a,o){delete t.prompt,a.isSynchronous&&n.$emit(r.PROVIDER_SHOW_LOADING),l.executeProviderActionV3(a.id,o,t).then(function(t){O=!1,b(a,t);var o=e("i18n")("screenConfiguration.providerActionExecutedFromExpression",a.label);n.$emit(r.PROVIDER_HIDE_LOADING),i.topic("providerExecution","Show success message"),d.success({text:o,clear:!0,hide:1e4}),y(a)})["catch"](function(e){n.$emit(r.PROVIDER_HIDE_LOADING),O=!1,y(a),d.error({text:e.data&&e.data.error?e.data.error:e.defaultMessage,clear:!1})})},n.checkForOutputMapping=function(e){var t=!1;return e&&e.mappings&&e.mappings.length&&(_.isUndefined(_.find(e.mappings,{type:"output"}))||(t=!0)),t},n.hide=function(){v.hide()},p.isProviderActionEventRegistered()||p.registerProviderActionCallExpressionEvent(a.$on(r.PROVIDER_ACTION,function(e,t){t.length&&(n.providerActionsList=p.getProviderActionsList(),_.size(n.providerActionsList)&&!O&&n.launchActionFromExpression(n.providerActionsList))})),n.launchActionFromExpression=function(e){if(_.isArray(e)&&!(e&&e.length<=0)){var t=g.evaluate(e[0].expression);t?(O=!0,n.launchAction(e[0].action,e[0].action.actionType,null,!0)):e[0]&&e[0].action&&p.clearProviderActionFieldName(e[0].action.actionFieldName,e[0].action.actionId)}}}])}(),function(){angular.module("myitsmApp").directive("newFieldItem",[function(){return{restrict:"E",templateUrl:"views/admin/screen-configuration/new-field-item.html",scope:{field:"=",pfield:"=?",isGroupField:"=",onExpandFieldClick:"=",onRemoveFieldClick:"=?",onRemoveFieldClickFromGroup:"=?",onHidePropertyChange:"=",onRequiredPropertyChange:"=",onSetValuePropertyChange:"=",onEditablePropertyChange:"=",checkDiffValue:"=",setDiffValueFieldonBlur:"=",getDependencyFieldWarn:"=",tooltipPosition:"=",updateDiffValueField:"=",diffFields:"=",acceleratorsList:"=",onAnyFieldPropertyChange:"&?",associatedActionLists:"=",onAssociatedActionPropertyChange:"=",icons:"=",onSelectIcon:"=",getWarningTextOnFieldRemove:"&",screenName:"=",disableHideLabelSetting:"=?"},controller:["$scope","$filter",function(e,t){
function a(t){e.isGroupField?e.onRemoveFieldClickFromGroup(e.pfield,t):e.onRemoveFieldClick(t)}e.showHideLabel=!0,e.isCreateScreens=ScreenConfigurationVO.prototype.isCreateScreen(e.screenName),_.includes(["changeRisk","changeRiskBadge","impactedAreas","customerLocationMap"],e.field.name)&&e.field.isWidget()&&(e.field.sealed=!0),_.includes(["emailField","phoneField","personLocationMap"],e.field.type)&&e.field.isWidget()&&(e.showHideLabel=!1),e.enableRemoveConfirmationTooltip=e.field.checkSystemRequiredFlag(),e.showDeleteConfirmationTooltip=!1,e.fieldPropertyOptions=[{name:t("i18n")("screenConfiguration.customAreaEditor.fieldPropertyAlways"),value:0},{name:t("i18n")("screenConfiguration.customAreaEditor.fieldPropertyCondition"),value:1}],e.getSelectedFieldPropertyOption=function(t){return _.find(e.fieldPropertyOptions,{value:t})},e.disableHideLabelSetting&&(e.field.hideLabel=!0),e.updateProperty=function(t,a){switch(e.field[a]=t.value,0===t.value&&(e.field[a.replace("Flag","")]=""),a){case"requiredConditionFlag":e.onRequiredPropertyChange(e.field);break;case"readOnlyConditionFlag":e.onEditablePropertyChange(e.field,!0);break;case"hideConditionFlag":e.onHidePropertyChange(e.field)}e.onFieldPropertyChange()},e.getMemberFieldLabel=function(t){if(t.label)return t.label;if(e.diffFields&&e.diffFields.length){var a=_.find(e.diffFields,function(e){return e.value===t.name})||{};return a.name}},e.getFieldTypeLabel=function(e){return angular.isFunction(e.isWidget)&&e.isWidget()?t("i18n")("customAreaEditor.fieldTypes.widget"):e.isCustomField()?t("i18n")("customAreaEditor.fieldTypes.customField"):t("i18n")("customAreaEditor.fieldTypes.regularField")},e.getFieldTooltip=function(e){return angular.isFunction(e.isWidget)&&e.isWidget()?t("i18n")("field.widget."+e.name+".label")+" "+t("i18n")("customAreaEditor.fieldTypes.widget"):e.arFieldName},e.isSetValueEnabled=function(){return e.field.isCustomField()||e.field.ootb&&"widget"!==e.field.dataType||"widget"===e.field.dataType&&(_.includes(["priority","summary","serviceType","status","desc","changeClass"],e.field.name)||"phoneField"===e.field.type||"emailField"===e.field.type)},e.onFieldPropertyChange=function(){angular.isFunction(e.onAnyFieldPropertyChange)&&e.onAnyFieldPropertyChange()},e.handleRemoveFieldClick=function(t){var n=t.checkSystemRequiredFlag();n?e.showDeleteConfirmationTooltip=!0:a(t)},e.confirmDelete=function(){a(e.field),e.showDeleteConfirmationTooltip=!1},e.cancelDelete=function(){e.showDeleteConfirmationTooltip=!1},e.generateSystemFieldRemoveWarningText=function(){return e.getWarningTextOnFieldRemove({field:e.field})},e.showAssociateAction=function(t){if(t)return!e.field.isWidget()&&ScreenConfigurationVO.prototype.isV2Compatible(t)&&!e.isCreateScreens}}]}}])}(),function(){angular.module("adminModule").controller("ScreenConfigurationController",["$filter","$modal","$rootScope","$scope","$log","$q","events","screenConfigurationModel","systemAlertService","layoutConfigurationModel","pwaModel",function(e,t,a,n,i,o,r,s,l,c,d){function u(e){return n.dataLoading=!0,o.all([s.loadConfiguration(),c.loadLayout(),s.loadAvailableFieldListForAllNewScreens(e)]).then(function(){n.screens=g(s.screenList),d.isPwaEnabled()&&(n.assetScreen=s.savedAssetScreen),m(n.screens,!0)})["finally"](function(){n.dataLoading=!1})}function p(e){n.dataLoading=!0,u(e)["finally"](function(){n.dataLoading=!1})}function m(e,t){e.forEach(function(e){e.layout=c.getLayoutFromCacheByScreenName(e.name),t&&s.availableFieldsCache[e.name]&&h(e,s.availableFieldsCache[e.name])})}function f(){y=a.$on(r.RELOAD_APP_CONFIGURATION,p),p(!0)}function g(e){var t=[],a=e.reduce(function(e,a){return a.isV2Compatible()?t.push(a):e.push(a),e},[]);return t.length&&t.sort(function(e,t){var a=e.getScreenOrderNumber(),n=t.getScreenOrderNumber();return a>n?1:a<n?-1:0}),t.concat(a)}function h(e,t){if(e.isV2Compatible()){var a=s.getAvailableFieldsForScreen(e.name,t),n=a.some(function(e){return e.isMissingSystemRequiredField()});n&&(e.invalidCustomizations={missingSystemFields:!0})}}n.showEditor=function(e,a){t.open({templateUrl:"views/admin/screen-configuration/custom-area-editor.html",windowClass:"action-blade",controller:"CustomAreaEditorController",size:"extra-lg",resolve:{customArea:function(){return angular.copy(e)},allPanels:function(){return angular.copy(a)}}})},n.showActionEditor=function(e){t.open({templateUrl:"views/admin/screen-configuration/custom-action-editor.html",windowClass:"action-blade",controller:"CustomActionEditorController",resolve:{screenObj:function(){return angular.copy(e)}}})},n.onPanelMouseOver=function(e,t){e.hoveredPanelId=t.shortId},n.onPanelMouseLeave=function(e){e.hoveredPanelId=""},n.onRefreshMetadataClick=function(t){var a=t.isV2Compatible()?t.name:"";n.dataLoading=!0,s.refreshMetadataForDatasource(t.datasource,a).then(function(){var e=t.isV2Compatible()?{fromConfig:!0}:angular.noop(),a=s.loadScreenConfigurationByName(t.name,!0,e),n=s.loadAvailableFieldList(t.panels[0]);return o.all([a,n])}).then(function(){var a=e("i18n")("customization.screen."+t.name),i=e("i18n")("screenConfiguration.metadataRefreshedSuccessfully",a);s.availableFieldsCache[t.name]=angular.copy(s.fieldList),m(s.screenList,!0),n.screens=g(s.screenList),l.success({text:i,clear:!0,hide:1e4})},function(e){l.error({text:e.data&&e.data.error,clear:!1})})["finally"](function(){n.dataLoading=!1})},n.getScreenInvalidationTooltip=function(t){var a=t.invalidCustomizations;if(a){var n=[];return a.missingSystemFields&&n.push(e("i18n")("customization.screen.invalidCustomization.tooltips.missingSystemFields")),e("i18n")("customization.screen.invalidCustomization.tooltip",n.join(", "))}},n.refreshServerCache=function(){n.dataLoading=!0,s.refreshServerCache().then(function(){l.success({text:e("i18n")("screenConfiguration.refreshServerCacheSuccessfully"),clear:!0,hide:1e4})},function(e){l.error({text:e.data&&e.data.error,clear:!1})})["finally"](function(){n.dataLoading=!1})};var y,E;E=a.$on(r.RELOAD_APP_CONFIGURATION_COMPLETED,function(e,t){if(n.screens=g(s.screenList),m(n.screens,!0),t){var a=_.find(n.screens,{name:t.screenName})||{};a.isV2Compatible()&&(a.invalidCustomizations=t.invalidCustomizations)}}),n.$on("$destroy",function(){console.log("destroy root scope events bound from here"),y(),E()}),f()}])}(),function(){angular.module("adminModule").factory("screenConfigurationModel",["$q","screenConfigurationService","configurationModel","i18nService","pwaModel",function(e,t,a,n,i){function o(e,t){var a=[];return t===P?a=e.addedFields:t===L&&(a=e.removedFields),a.reduce(function(a,n){var i=_.cloneDeep(n);if(n.isGroupField()){var o=t===L?n.initialMembers:n.members;i.members=o.map(function(e){return(new GalileoFieldV2VO).build(e)})}return n.isGroupMember()||a.push(angular.extend({state:t,screenId:e.parentScreenId,screenName:e.parentScreenName,panelId:e.id,panelName:e.name,datasource:e.dataSource},(new GalileoFieldV2VO).build(i))),a},[])}function r(e){return o(e,P)}function s(e){return o(e,L)}function l(e){return e.fields.reduce(function(t,a,n){var i=[];if(a.displayOrder!==n&&(a.displayOrder=n,A.markFieldUpdated(a,e)),a.dependency)for(var o=0;o<a.dependency.length;o++)delete a.dependency[o].availability,delete a.dependency[o].fieldUnavailableOn;if(a.isGroupField()&&(i=a.members.map(function(t,n){if(t.displayOrder!==n&&(t.displayOrder=n,A.markFieldUpdated(t,e)),t.dependency)for(var i=0;i<t.dependency.length;i++)delete t.dependency[i].availability,delete t.dependency[i].fieldUnavailableOn;return t.id&&!t.wasUpdated||A.markFieldUpdated(a,e),(new GalileoFieldV2VO).build(t)})),a.id&&a.wasUpdated){var r=_.cloneDeep(a);r.members=i,t.push(r)}return t},[])}function c(a,n,i){var o=a?"loadActionsNew":"loadActions",r=A.runtimeActionsCache[n];if(!i&&r)return e.when(r);var s=t[o]({resourceType:n}).then(function(e){A.runtimeActionsCache[n]=e});return A.runtimeActionsCache[n]=s,A.runtimeActionsCache[n]}function d(e,t){var a,n=e.members[0];return n?(a=_.last(t.ootbMapping[n.name]),_.head(a.split("."))):""}function u(e,t,a){if(a.members.length>0){var n={};return a.members.forEach(function(i){var o=t.ootbMapping[i.name];n[i.name]=o&&o.length>0?p(a.name,o,e):e[i.name]}),n}}function p(e,t,a){var n=_.cloneDeep(a);return(e.indexOf("CategoryTier")!==-1||"resProductName"===e||_.startsWith(_.last(t),"categorizations"))&&(n.categorizations.tiers||(n.categorizations.tiers={},n.categorizations.forEach(function(e){_.extend(n.categorizations.tiers,e.tiers)})),n.resCategorizations&&!n.resCategorizations.tiers&&(n.resCategorizations.tiers={},n.resCategorizations.forEach(function(e){_.extend(n.resCategorizations.tiers,e.tiers)}))),_.get(n,_.last(t))}function m(e){var t={};return _.forEach(e,function(e){t[e.name]=e.selectedValue}),t}function f(e){if(e.dirty){var t={name:e.name,tiers:m(e.listOfTiers)};return e.primary&&(t.primary=!0),e.company&&(t.company=e.company),t}return null}function g(e){return angular.copy(A.screensCacheByName[e])}function h(e){return angular.isDefined(e)&&null!==e}function y(e){var t=A.getScreenNameByTicketType(e);return g(t)}function E(e){A.appConfig=e;var t;i.isPwaEnabled()&&_.remove(e.screens,function(e){return"assetScreen"===e.name&&_.includes(a.get("pwaEnabledTickets.tickets"),e.datasource.toLowerCase())&&(t=e),e.datasource&&_.includes(a.get("pwaEnabledTickets.tickets"),e.datasource.toLowerCase())});var n=e.screens;_.forEach(e.screens,function(e){"Person"===e.datasource||a.isServerApplicationEnabled(e.datasource.toLowerCase())||(n=_.reject(n,{datasource:e.datasource})),A.screensCacheByName[e.name]=e}),A.screenList=angular.copy(n),t&&(A.savedAssetScreen=t,A.screensCacheByName[t.name]=t),e.screens.length||(console.log("Warning: screen list of application configuration is empty."),N.reject())}function v(e){var t=e.reduce(function(e,t){var a=e.some(function(e){return e.name===t.name&&e.dataType===t.dataType});return a||e.push(t),e},[]);A.fieldList=_.sortBy(t,"name"),A.fieldDictionary=_.keyBy(t,"name")}function T(e){_.forEach(e.actionList,function(e){e.label=e.labels[n.language]||e.labels["default"]}),"alphabetical"===e.actionOrder?A.actionList=_.sortBy(e.actionList,"label"):A.actionList=_.sortBy(e.actionList,"sequenceNo"),A.actionOrder=e.actionOrder}function S(e){A.actionUrlParams=e}function C(e){A.selectedFieldDictionary=_.keyBy(e,"name")}function O(e,t){k[t]||(k[t]=e),A.fieldLabels=e.items}var A={appConfig:null,screenList:null,screensCacheByName:{},fieldList:null,fieldLabels:null,selectedFieldList:null,actionList:null,actionOrder:"custom",actionUrlParams:null,availableFieldsCache:{},runtimeActionsCache:{},dynamicSelectionFieldLabelsCache:{},providerPromise:{},providerHardReload:!0,allFieldsLoaded:{basicTab:!1,datesTab:!1}},I=null,b={},k={},D={incident:ScreenConfigurationVO.prototype.INCIDENT_VIEW_SCREEN,workorder:ScreenConfigurationVO.prototype.WORK_ORDER_VIEW_SCREEN,task:ScreenConfigurationVO.prototype.TASK_VIEW_SCREEN,person:ScreenConfigurationVO.prototype.PERSON_DETAILS_SCREEN,change:ScreenConfigurationVO.prototype.CHANGE_VIEW_SCREEN,problem:ScreenConfigurationVO.prototype.PROBLEM_DETAILS_SCREEN,knownerror:ScreenConfigurationVO.prototype.KNOWN_ERROR_DETAILS_SCREEN,asset:ScreenConfigurationVO.prototype.ASSET_SCREEN,create:{incident:ScreenConfigurationVO.prototype.CREATE_INCIDENT_SCREEN,change:ScreenConfigurationVO.prototype.CREATE_CHANGE_SCREEN,workorder:ScreenConfigurationVO.prototype.CREATE_WORK_ORDER_SCREEN,task:ScreenConfigurationVO.prototype.CREATE_TASK_SCREEN}},R={incident:EntityVO.TYPE_INCIDENT,workorder:EntityVO.TYPE_WORKORDER,task:EntityVO.TYPE_TASK,person:"Person",change:EntityVO.TYPE_CHANGE,problem:EntityVO.TYPE_PROBLEM,knownerror:EntityVO.TYPE_KNOWNERROR,asset:"Asset"},P="create",w="update",L="remove",N=e.defer();return A.loadConfiguration=function(){return A.appConfig={},A.screenList=[],t.loadConfiguration({fromConfig:!0}).then(E)},A.loadScreenConfigurationByName=function(n,i,o){var r,s=i?angular.noop():g(n);return s?r=e.when(s):(b[n]||(b[n]=t.loadScreenConfigurationByName(n,o).then(function(e){return A.screensCacheByName[n]=e.screens[0],A.screenList=_.reject(A.screensCacheByName,function(e){return"Person"!==e.datasource&&!a.isServerApplicationEnabled(e.datasource.toLowerCase())}),b[n]=null,angular.copy(A.screensCacheByName[n])})),r=b[n]),r},A.loadScreenConfigurationAndCustomFieldLabels=function(t,a,n){var i=e.defer();return A.loadScreenConfigurationByName(t,n).then(function(){return A.loadFieldsLabels(a)})["finally"](function(){i.resolve()}),i.promise},A.refreshMetadataForDatasource=function(e,a){var n={datasource:e};a&&(n.screen=a);var i=function(){k[e]&&delete k[e]};return A.isV2CompatibleScreen(a)?t.refreshMetadataV2(n).then(i):t.refreshMetadata(n).then(i)},A.loadFields=function(t){var a=A.loadAvailableFieldList(t),n=A.loadSelectedFieldList(t);return e.all([a,n])},A.loadAvailableFieldList=function(e){var a,n={datasource:e.dataSource};return"Asset"===e.dataSource&&(n.assetType=e.shortId,"typeSpecific"===e.shortId&&(n.classId=e.classId)),A.isV2CompatibleScreen(e.parentScreenName)?(n.screen=e.parentScreenName,a=t.loadAvailableFieldListV2(n)):a=t.loadAvailableFieldList(n),a.then(v)},A.loadAvailableFieldListForAllNewScreens=function(n){var i=[];a.isServerApplicationEnabled(EntityVO.TYPE_INCIDENT)&&i.push({datasource:EntityVO.TYPE_INCIDENT,screen:ScreenConfigurationVO.prototype.INCIDENT_VIEW_SCREEN},{datasource:EntityVO.TYPE_INCIDENT,screen:ScreenConfigurationVO.prototype.CREATE_INCIDENT_SCREEN}),a.isServerApplicationEnabled(EntityVO.TYPE_CHANGE)&&i.push({datasource:EntityVO.TYPE_CHANGE,screen:ScreenConfigurationVO.prototype.CHANGE_VIEW_SCREEN},{datasource:EntityVO.TYPE_CHANGE,screen:ScreenConfigurationVO.prototype.CREATE_CHANGE_SCREEN}),a.isServerApplicationEnabled(EntityVO.TYPE_WORKORDER)&&i.push({datasource:EntityVO.TYPE_WORKORDER,screen:ScreenConfigurationVO.prototype.WORK_ORDER_VIEW_SCREEN},{datasource:EntityVO.TYPE_WORKORDER,screen:ScreenConfigurationVO.prototype.CREATE_WORK_ORDER_SCREEN}),a.isServerApplicationEnabled(EntityVO.TYPE_TASK)&&i.push({datasource:EntityVO.TYPE_TASK,screen:ScreenConfigurationVO.prototype.TASK_VIEW_SCREEN},{datasource:EntityVO.TYPE_TASK,screen:ScreenConfigurationVO.prototype.CREATE_TASK_SCREEN});var o={};return n?i.forEach(function(e){o[e.screen]=t.loadAvailableFieldListV2(e).then(function(t){A.availableFieldsCache[e.screen]=t})}):o=[e.when(A.availableFieldsCache)],e.all(o).then(function(){return angular.copy(A.availableFieldsCache)})},A.loadActions=function(e){return t.loadActions({resourceType:e}).then(T)},A.loadActionUrlParams=function(e){return t.loadActionUrlParams({resourceType:e}).then(S)},A.loadActionsNew=function(e){return!A.providerPromise[e]||A.providerHardReload?(A.providerPromise[e]=t.loadActionsNew({resourceType:e}).then(T),A.providerHardReload=!1,A.providerPromise[e]):A.providerPromise[e]},A.loadSelectedFieldList=function(e){var a={datasource:e.dataSource};return"Asset"===e.dataSource&&(a.assetType=e.shortId,"typeSpecific"===e.shortId&&(a.classId=e.classId)),t.loadSelectedFieldList(a).then(C)},A.loadFieldsLabels=function(a){var n=D[a],i=D.create[a],o=_.find(A.screensCacheByName,function(e){return[n,i].indexOf((e||{}).name)!==-1}),r=e.when(1);if(o){var s=o.datasource,l=k[s];l?O(l,s):(null===I&&(I=t.loadFieldsLabels({datasource:s}).then(function(e){return O(e,s),I=null,A.fieldLabels})),r=I)}else console.log("Warning: screen configuration for "+a+" not found.");return r},A.loadMockDependantFieldMappings=function(){return t.loadMockDependantFieldMappings()},A.loadDynamicSelectionFieldLabels=function(a,n,i,o,r,s,l,c){function d(e){return e.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")}var u=y(l?"create."+a:a),p={datasource:u?u.datasource:a,menuName:n,searchText:i};if(r&&(p.classId=r),u){var m=A.dynamicSelectionFieldLabelsCache[s];if(c=!!(m&&m.searchData&&m.searchData.exceedsChunkSize)||c,!c&&angular.isDefined(m)&&(!m.searchData.exceedsChunkSize&&_.startsWith(i,m.searchText)||m.searchData.exceedsChunkSize&&i===m.searchText)&&m.datasource===p.datasource&&_.isEqual(o,m.dependencies)){var f=_.cloneDeep(m.searchData),g=d(i),h=g.replace(/%/g,".*");h=".*"+h+".*",h=new RegExp("^"+h+"$","im");var E=void 0;return f&&Array.isArray(f)?E=f:f&&f.items&&Array.isArray(f.items)&&(E=f.items),_.remove(E,function(e){if(!e.displayLabel.match(h)&&!e.value.match(h))return!0}),e.when(f)}return t.loadDynamicSelectionFieldLabels(p,o).then(function(e){return A.dynamicSelectionFieldLabelsCache[s]={searchText:i,searchData:e,datasource:p.datasource,dependencies:o},{items:e.items,exceedsChunkSize:e.exceedsChunkSize}})}return console.log("Warning: screen configuration for "+a+" not found."),e.reject()},A.markFieldUpdated=function(e,t){var a=!e.id||t.addedFields.some(function(t){return e.id===t.id});a||(e.wasUpdated=!0)},A.isV2CompatibleScreen=function(e){return ScreenConfigurationVO.prototype.isV2Compatible(e)},A.savePanelConfiguration=function(e){function a(e,t){"typeSpecific"!==t.shortId&&delete e.extension,c?n.push(angular.extend({state:w,screenId:t.parentScreenId,screenName:t.parentScreenName,panelId:t.id,panelName:t.name,datasource:t.dataSource},(new GalileoFieldV2VO).build(e))):n.push(angular.extend({state:w,areaId:t.id},(new GalileoFieldVO).build(e)))}var n=[],i=[],o=[],c=A.isV2CompatibleScreen(e.parentScreenName);if(c){var d=l(e);d.forEach(function(t){a(t,e)})}else e.fields.forEach(function(t,n){var i=[];if(t.displayOrder=n,t.groupMember=!1,t.dependency)for(var o=0;o<t.dependency.length;o++)delete t.dependency[o].availability,delete t.dependency[o].fieldUnavailableOn;t.isWidget()||(t.members.forEach(function(t,n){var o={name:t.name};if(t.displayOrder=n,t.groupMember=!0,t.dependency)for(var r=0;r<t.dependency.length;r++)delete t.dependency[r].availability,delete t.dependency[r].fieldUnavailableOn;t.id&&(a(t,e),t.current&&(o=t.current)),i.push(o)}),t.members=i),t.id&&a(t,e)});c?(i=r(e),o=s(e)):(i=e.addedFields.map(function(t){var a;return"typeSpecific"!==e.shortId&&delete t.extension,a=angular.extend({state:P,areaId:e.id},(new GalileoFieldVO).build(t))}),o=e.removedFields.map(function(t){var a;return"typeSpecific"!==e.shortId&&delete t.extension,a=angular.extend({state:L,areaId:e.id},(new GalileoFieldVO).build(t))})),c||i.forEach(function(e,t){var a=_.findIndex(n,{name:e.name});a!=-1&&(n=_.slice(n,0,a))});var u=c?t.saveFieldConfigurationV2:t.saveFieldConfiguration;return u([].concat(o,i,n),e.shortId)["catch"](function(e){throw e})["finally"](function(){A.clearActionsListCacheForType(e.dataSource.toLowerCase())})},A.saveActionConfiguration=function(e,a){var n={actionOrder:a,actionList:[]};return e.forEach(function(e){delete e.isOpen,n.actionList.push(e)}),t.saveActionConfiguration(n).then(T)},A.saveFieldConfigurationV2=function(e,a){var n={actionOrder:a,actionList:[]};return e.forEach(function(e){delete e.isOpen,n.actionList.push(e)}),t.saveFieldConfigurationV2(n).then(T)},A.getPanelById=function(e){var t=e.split(".")[0],a=e.split(".")[1],n=g(t);return n?n.getPanelByName(a):null},A.getEditableFieldsForScreen=function(e){var t=g(e);return _.filter(t?t.getFields():[],{editable:!0})},A.getRequiredFieldsForScreen=function(e){var t=g(e);return _.filter(t?t.getFields():[],{required:!0})},A.getAvailableFieldsForScreen=function(e,t){var a=g(e),n=a?a.getFields():[];return(t||A.fieldList).filter(function(e){return!_.filter(n,{name:e.name,dataType:e.dataType}).length})},A.getFieldByName=function(e,t){var a=g(e),n=a?a.getFields():[];return _.find(n,{name:t})},A.getAvailableFieldsForScreenByClassId=function(e,t){var a=g(e),n=a?a.getFields():[];return A.fieldList.filter(function(e){var a,i,o=_.filter(n,{name:e.name});if(o.length){for(a=0;a<o.length;a++)for(i=0;i<o[a].extension.length;i++)if(o[a].extension[i].classId===t.name)return!1;return!0}return!0})},A.getAssignmentPanel=function(e){var t;if(e.type){var a=y(e.type);a&&(t=a.getPanelByName("Assignment"))}return t||{}},A.getAccelerators=function(e,a){var n;return n=A.isV2CompatibleScreen(a)?t.getNewAcceleratorsByType({datasource:e,screen:a}).then(function(e){return e}):t.getAcceleratorsByType({datasource:e}).then(function(e){return e})},A.collectChanges=function(e,t,a){var n={};return _.forEach(e,function(e){var i=e.isGroupMember();if(e.editable||i){var o=e.getValue(),r=t?t[e.name]:"",s=h(o)&&o!==r||null===o&&h(r)&&""!==r;if(s||i){if("category"===e.type){var l=f(o);l&&(_.find(a.resCategorizations,{name:l.name})?n.resCategorizations instanceof Array?n.resCategorizations.push(l):n.resCategorizations=[l]:_.find(a.categorizations,{name:l.name})&&(n.categorizations instanceof Array?n.categorizations.push(l):n.categorizations=[l]))}else"widget"===e.dataType?_.forEach(e.members,function(t){n[t.name]=e.value[t.name]}):n[e.name]=o;e.isMenuField()&&""===o&&(n[e.name]=null),e.linkedFieldExist()&&(n[e.valueField]=e.getLinkedValue())}}}),n},A.composePanelId=function(e,t){return A.getScreenNameByTicketType(e)+"."+t},A.initFieldValues=function(t,a,i,o){var r,s=e.defer(),l=0;if(t&&t.length>0){var c;_.each(t,function(e){if("incident"!==a.type&&"change"!==a.type||"summary"!==e.name?"task"===a.type&&"summary"===e.name&&(e.charLimit=255):e.charLimit=100,e.isWidget()&&(e.label=n.getLocalizedString("field.widget."+e.name+".label")),e.type===FieldVO.prototype.PERSON_NAME){var m="requestedFor"===e.name?"customer":e.name;c=a[m],"contact"===e.name?_.isEmpty(a[m])&&(c=void 0):e.isAssigneeWidget()&&(e.primaryKey=d(e,i),c=a[e.primaryKey]),e.setValue(c),l++}else if(e.type===FieldVO.prototype.PRIORITY)e.setValue({impact:a.impact,urgency:a.urgency,priority:a.priority}),l++;else if(e.type===FieldVO.prototype.TICKET_CLASS)e.setValue({timing:a.timing,timingReason:a.timingReason}),l++;else if(e.type===FieldVO.prototype.AFFECTED_ASSET)c={ci:a[e.name],company:a.company,customer:a.customer,ticketType:a.type},(_.isEmpty(a[e.name])||_.isEmpty(a[e.name].name))&&(c.ci=null),e.setValue(c),l++;else if(e.type===FieldVO.prototype.TICKET_LOCATION)c=a.location?{siteId:a.location.siteId,region:a.location.region,siteGroup:a.location.siteGroup,name:a.location.name,companyName:a.location.companyName,address:a.location.address}:{siteId:null,region:null,siteGroup:null,name:null,companyName:null,address:null},e.setValue(c),l++;else if(e.type===FieldVO.prototype.IMPACTED_AREAS)e.setValue({impactedAreas:a.impactedAreas}),l++;else if(e.type===FieldVO.prototype.CATEGORY_FIELD)e.setValue(_.findLast(_.cloneDeep(a.allCategories),{name:e.getCategorizationPropertyName()})),l++;else if(e.type===FieldVO.prototype.PERSON_SITE){var f=_.cloneDeep(a.customer.site);f=f?f:{};var g={site:{name:f.name,id:f.siteId,attributeMap:{siteAddress:f.address,regionName:f.region,siteGroupName:f.siteGroup}},siteGroup:{name:f.siteGroup,attributeMap:{regionName:f.region}},region:{name:f.region},company:a.customer.company};e.setValue(g),l++}else if(e.type===FieldVO.prototype.PERSON_LOCATION_MAP)a.customer.site&&e.setValue(a.customer.site.address),l++;else if(e.type===FieldVO.prototype.POI_LOCATION)e.setValue(_.cloneDeep(a.location)),l++;else if(e.type===FieldVO.prototype.CATEGORY_COMPANY)a.locationCompany&&a.locationCompany.name&&e.setValue(a.locationCompany.name),l++;else if(e.type===FieldVO.prototype.TASK_PHASE)a.selectedPhase&&e.setValue({phaseGuid:a.selectedPhase.guid,phaseName:a.selectedPhase.name}),l++;else if(e.isSupportGroupWidget()){e.primaryKey=d(e,i);var h=angular.copy(a[e.primaryKey]);h&&(h.supportGroups=h.name||h.supportGroups),e.setValue(h),l++}else if(e.isGroupField())A.initFieldValues(e.members,a,i),l++;else if(e.isWidget()&&e.members.length>0)e.setValue(u(a,i,e)),l++;else if(i&&(r=i.ootbMapping[e.name]),e.ootb)if(r&&r.length>0){if(e.setValue(p(e.name,r,a)),"assignee"===e.name||"assigneeName"===e.name||"managerName"===e.name){var y=r[0].split(".");e.assigneeLoginId=a[y[0]]?a[y[0]].loginId:null}l++}else o||e.setValue(a[e.name]),l++;else o||e.setValue(_.get(a.customFields,e.name)),l++;l===t.length&&s.resolve()})}else s.resolve();return s.promise},A.updateTicketData=function(e,t){_.size(t)&&(e.customFields||(e.customFields={}),_.forOwn(t,function(t,a){e.customFields[a]=t}))},A.ticketDataIsValid=function(e){var t=A.getScreenNameByTicketType(e.type),a=A.getRequiredFieldsForScreen(t),n=!0;return _.each(a,function(t){t.isCheckboxField()||(n=n&&h(e.customFields[t.name]))}),n},A.ticketNumOfRequiredFieldMissing=function(e){var t=A.getScreenNameByTicketType(e.type),a=A.getRequiredFieldsForScreen(t),n=0;return _.each(a,function(t){h(e.customFields[t.name])||(n+=1)}),n},A.loadActionsForRuntime=function(e,t){return c(!1,e,t)},A.loadActionsForRuntimeV2=function(e,t){return c(!0,e,t)},A.clearActionsListCacheForType=function(e){A.runtimeActionsCache[e]&&delete A.runtimeActionsCache[e]},A.executeProviderAction=function(e,a){return t.executeProviderAction(e,a)},A.executeProviderActionV3=function(e,a,n){return t.executeProviderActionV3(e,a,n)},A.getSmartReporterUrl=function(){return t.getSmartReporterUrl()},A.getExternalUrl=function(a){return A.externalUrl?e.when(A.externalUrl[a]):t.getExternalUrl().then(function(e){return A.externalUrl||(A.externalUrl=e),e[a]})},A.getTemplateList=function(e,a){return t.getTemplateList({withMetadata:e,resourceType:a})},A.getTemplateById=function(e){return t.getTemplateById({templateId:e})},A.getExistingContainer=function(e,a){return t.getExistingContainer({resourceType:e,supportedPlatforms:a})},A.createUrlAction=function(e,a,n){var i={actionOrder:a,actionList:e,resourceType:n};return t.createUrlAction(i).then(T)},A.refreshServerCache=function(){return t.refreshServerCache()},A.getScreenNameByTicketType=function(e){return _.get(D,e)},A.getLocalizedFieldByNameForTicketType=function(e,t,a){var n;if(a&&(n=_.find(A.fieldLabels,function(t){return t.name==e&&t.classIds[0]==a})),(!n||!n.label)&&t){var i=R[t];n=_.find(k&&k[i]&&k[i].items,{name:e})}return n&&n.label||(n=_.find(A.fieldLabels,{name:e})),n},A.checkExpressionValid=function(e,t){var a="",i=function(e){var o;if(a||!e)return a;if(e.left)return i(e.left);if(e.right)return i(e.right);if("Identifier"===e.type){if(!_.startsWith(e.name,"$")||!_.find(t,{name:e.name}))return a=n.getLocalizedStringwithParams("expression.builder.error.invalidIdentifier",e.name)}else{if("Compound"===e.type)return a=n.getLocalizedString("expression.builder.standard.error");if("CallExpression"===e.type){if(!_.includes(["NOOP","REPLACE","DATEADD","DATEDIFF","HASROLE","INGROUP","SELECTIONINDEX","SELECTIONLABEL","ISREQUIRED","ISREADONLY","ISHIDDEN","ONCHANGE"],e.callee.name))return a=n.getLocalizedStringwithParams("expression.builder.error.functionNotSupported",e.callee.name);_.each(e.arguments,function(e){return i(e)})}else if("ConditionalExpression"===e.type&&(o=i(e.test),!o&&(o=i(e.consequent),!o)))return i(e.alternate)}};return i(e)},A.isTicketEnabledForProviderActionExpression=function(e){return ScreenConfigurationVO.prototype.isTicketEnabledForProviderActionExpression(e)},A}])}(),function(){angular.module("adminModule").service("screenConfigurationService",["$resource","$q","$http",function(e,t,a){function n(e){function t(e,n){_.forEach(e,function(e){e.subMenu&&e.subMenu.length?(e.parent=n&&n.length?n.concat([e.label]):[e.label],t(e.subMenu,e.parent)):(n&&(e.parent=n.slice(0)),a.push(e))})}var a=[];return t(e),_.forEach(a,function(e){e.displayLabel=e.parent&&e.parent.length?e.parent.join(" > ")+" > "+e.label:e.label})}function i(e){return(new ApplicationConfigurationVO).build(e)}function o(e){return e.map(function(e){return(new FieldVO).build(e)})}function r(e){var t=[];e[0].items[0].actionList&&(t=e[0].items[0].actionList.map(function(e){return(new ActionVO).build(e)}));var a={actionList:t,actionOrder:e[0].items[0].actionOrder||"alphabetical"};return a}function s(e){return e.forEach(function(e){e.name="["+e.name+"]"}),e}var l=e("/smartit/rest/customization",{},{loadConfiguration:{url:"/smartit/rest/v2/customization/application/search?name=Galileo&phase=2",method:"GET",isArray:!1},refreshMetadata:{url:"/smartit/rest/customization/metadata/field/available/refresh",method:"GET",isArray:!1},refreshMetadataV2:{url:"/smartit/rest/v2/customization/metadata/field/available/refresh",method:"GET",isArray:!1},loadAvailableFieldList:{url:"/smartit/rest/customization/field/available/search",method:"GET",isArray:!0},loadAvailableFieldListV2:{url:"/smartit/rest/v2/customization/field/available/search",method:"GET",isArray:!0},loadSelectedFieldList:{url:"/smartit/rest/customization/field/search",method:"GET",isArray:!0},loadActions:{url:"/smartit/rest/action/search",method:"GET",isArray:!0},loadActionsNew:{url:"/smartit/rest/v3/action/search",method:"GET",isArray:!0},loadActionUrlParams:{url:"/smartit/rest/customization/action/search/urlparams",method:"GET",isArray:!0},loadMockConfiguration:{url:"mocks/application-custom-field-configuration.json",method:"GET",isArray:!1},loadMockAvailableFieldList:{url:"mocks/available-field-list.json",method:"GET",isArray:!0},loadMockFieldList:{url:"mocks/custom-field-list.json",method:"GET",isArray:!0},saveFieldConfiguration:{url:"/smartit/rest/customization/cell/update",method:"POST"},saveFieldConfigurationV2:{url:"/smartit/rest/v2/customization/cell/update",method:"POST"},saveActionConfiguration:{url:"/smartit/rest/action",method:"POST",isArray:!0},saveActionConfigurationV2:{url:"/smartit/rest/action",method:"POST",isArray:!0},loadFieldsLabels:{url:"/smartit/rest/customization/field/summary/search",method:"GET",isArray:!1},getAcceleratorsByType:{url:"/smartit/rest/customization/available/accelerators",method:"GET",isArray:!1},getNewAcceleratorsByType:{url:"/smartit/rest/v2/customization/available/accelerators",method:"GET",isArray:!1},loadMockFieldLabels:{url:"mocks/custom-field-labels.json",method:"GET",isArray:!0},loadMockActions:{url:"mocks/configuration-actions.json",method:"GET",isArray:!0},loadMockActionUrlParams:{url:"mocks/configuration-action-url-params.json",method:"GET",isArray:!0},loadMockDependantFieldMappings:{url:"mocks/custom-field-dependency-mappings.json",method:"GET"},loadDynamicSelectionFieldLabels:{url:"/smartit/rest/v2/customization/menu/expand",method:"POST",transformResponse:function(e){return{items:angular.fromJson(e)}},isArray:!1},executeProviderAction:{url:"/smartit/rest/action/execute",method:"POST",isArray:!0},executeProviderActionV3:{url:"/smartit/rest/v3/action/execute",method:"POST",isArray:!1},getSmartReporterUrl:{url:"/smartit/rest/reporting/url",method:"GET",isArray:!0},getExternalUrl:{url:"/smartit/rest/external/url",method:"GET",isArray:!0},getTemplateList:{url:"/smartit/rest/v3/action/templates",method:"GET",isArray:!0},getTemplateById:{url:"/smartit/rest/v3/action/templates",method:"GET",isArray:!0},createUrlAction:{url:"/smartit/rest/v3/action",method:"POST",isArray:!0},refreshServerCache:{url:"/smartit/rest/system/provider/management/all/cache/reset",method:"DELETE",isArray:!1}});this.loadConfiguration=function(e){return l.loadConfiguration(e).$promise.then(function(e){return i(e)})},this.loadScreenConfigurationByName=function(e,t){var a={screen:e};return this.loadConfiguration(_.merge(a,t))},this.refreshMetadata=function(e){return l.refreshMetadata(e).$promise},this.refreshMetadataV2=function(e){return l.refreshMetadataV2(e).$promise},this.loadAvailableFieldList=function(e){return l.loadAvailableFieldList(e).$promise.then(o)},this.loadAvailableFieldListV2=function(e){return l.loadAvailableFieldListV2(e).$promise.then(o)},this.loadSelectedFieldList=function(e){return l.loadSelectedFieldList(e).$promise.then(o)},this.loadActions=function(e){return l.loadActions(e).$promise.then(r)},this.loadActionsForRuntime=function(){return l.loadActions().$promise.then(function(e){return e[0].items})},this.loadActionsForRuntimeV2=function(){return l.loadActionsNew().$promise.then(function(e){return e[0].items})},this.loadActionsNew=function(e){return l.loadActionsNew(e).$promise.then(r)},this.getAcceleratorsByType=function(e){return l.getAcceleratorsByType(e).$promise.then(function(e){return e.items})},this.getNewAcceleratorsByType=function(e){return l.getNewAcceleratorsByType(e).$promise.then(function(e){return e.items})},this.loadActionUrlParams=function(e){
return l.loadActionUrlParams(e).$promise.then(s)},this.loadFieldsLabels=function(e){return l.loadFieldsLabels(e).$promise},this.saveFieldConfiguration=function(e,t){var a={};return"typeSpecific"===t&&(a.assetType=t),l.saveFieldConfiguration(a,e).$promise},this.saveFieldConfigurationV2=function(e,t){var a={};return"typeSpecific"===t&&(a.assetType=t),l.saveFieldConfigurationV2(a,e).$promise},this.saveActionConfiguration=function(e){return l.saveActionConfiguration({},e).$promise.then(r)},this.saveActionConfigurationV2=function(e){return l.saveActionConfigurationV2({},e).$promise.then(r)},this.loadMockDependantFieldMappings=function(){return l.loadMockDependantFieldMappings().$promise},this.loadDynamicSelectionFieldLabels=function(e,t){return l.loadDynamicSelectionFieldLabels(e,t).$promise.then(function(e){var t=_.isArray(e.items)&&e.items[0].items?e.items[0].items:e.items,a=n(t);return{items:a,exceedsChunkSize:e.items[0].exceedsChunkSize}})},this.executeProviderAction=function(e,t){var a={actionId:e,resourceId:t};return l.executeProviderAction(a).$promise},this.executeProviderActionV3=function(e,t,a){var n={actionId:e,resourceId:t,parameters:a};return l.executeProviderActionV3(n).$promise.then(function(e){return delete e.actionId,delete e.resourceId,delete e.parameters,JSON.parse(angular.toJson(e))})},this.getContextPropertyByMetadataMapping=function(e,t,a,n){var i,o=t.ootbMapping[a];if(o&&o.length)for(var r=0,s=o.length;r<s;r++){var l=o[r].split(".");if("resCategorizations"===l[0]||"categorizations"===l[0]){for(var c in e.allCategories)if(e.allCategories.hasOwnProperty(c)){var d=_.find(e.allCategories[c].listOfTiers,{name:l[l.length-1]});if(d){i=d.selectedValue;break}}}else if(n&&(e.type===EntityVO.TYPE_PROBLEM||e.type===EntityVO.TYPE_KNOWNERROR)&&_.includes([EntityVO.TYPE_PRIORITY,EntityVO.TYPE_URGENCY,EntityVO.TYPE_IMPACT,EntityVO.TYPE_STATUS],o[r])){switch(o[r]){case EntityVO.TYPE_PRIORITY:i=_.get(e,EntityVO.TYPE_CALCULATED_PRIORITY,"");break;case EntityVO.TYPE_URGENCY:i=_.get(e,EntityVO.TYPE_SELECTED_URGENCY,"");break;case EntityVO.TYPE_IMPACT:i=_.get(e,EntityVO.TYPE_SELECTED_IMPACT,"");break;case EntityVO.TYPE_STATUS:i=_.get(e,EntityVO.TYPE_SELECTED_STATUS,"");break;default:i=_.get(e,o[r],"")}_.isObject(i)&&(i=i.name)}else i=_.get(e,o[r],"");if(angular.isDefined(i)&&!_.isObject(i))break;i=""}return i},this.getSmartReporterUrl=function(){return l.getSmartReporterUrl().$promise.then(function(e){return e[0].items[0].reportingServerURL})},this.getExternalUrl=function(){return l.getExternalUrl().$promise.then(function(e){return e[0].items[0]})},this.getTemplateList=function(e){return l.getTemplateList(e).$promise.then(function(e){return e})},this.getTemplateById=function(e){return l.getTemplateById(e).$promise.then(function(e){return e[0]})},this.createUrlAction=function(e){return l.createUrlAction({},e).$promise.then(r)},this.refreshServerCache=function(){return l.refreshServerCache().$promise}}])}(),function(){function e(e,t){function a(){e.layout.isCreateChangeLayout()&&n(e.layout),e.layout.panels.forEach(function(e){var t=i(e.panels);e.sections=t.filter(function(e){return!e.layout})})}function n(e){var a={name:"basicSection",id:t.getRandomId(),layout:"fixed",panels:e.panels.filter(function(e){return"fixed"!==e.layout})||[]};e.panels=[].concat(a,e.panels.filter(function(e){return"fixed"===e.layout}))}function i(e){return e.reduce(function(e,t){return e.concat(t.children?t:[],i(t.panels||[]))},[])}function o(t,a){var n=_.find(e.screen.panels,function(e){return e.id===a.id}),i=[];n||(n=r({name:a.name,id:a.id})),t.sections.forEach(function(a){var n=_.find(e.screen.panels,function(e){return a.id===e.id});n||(n=r({name:a.name,id:a.id})),n.sectionName=t.name,i.push(n)}),s.openSectionEditor(n,i)}function r(t){var a={id:"",name:"",type:"simplePanel",fields:[]},n=(new PanelVO).build(_.assign(a,t));return n.parentScreenTitle=e.screen.title,n.parentScreenName=e.screen.name,n.parentScreenId=e.screen.id,n.dataSource=e.screen.datasource,e.screen.panels.push(n),n}var s=this;this.handleSectionHeaderClick=function(t){if(e.layout.specialHandlingSections.indexOf(t.name)!==-1||1===t.sections.length){var a=t.sections[0];o(t,a)}},this.handleSectionItemClick=function(e,t){o(e,t)},this.onMouseOver=function(t,a){t.stopPropagation(),t.stopImmediatePropagation(),e.screen.hoveredPanelId=a.name},this.onMouseLeave=function(t){t.stopPropagation(),t.stopImmediatePropagation(),e.screen.hoveredPanelId=""},this.openSectionEditor=function(t,a){angular.isFunction(e.onItemClick)&&e.onItemClick({panel:t,allPanels:a})},e.$watch("layout",a)}angular.module("adminModule").directive("screenSectionsTree",[function(){return{restrict:"E",scope:{layout:"=",onItemClick:"&",screen:"="},templateUrl:"views/admin/screen-configuration/screen-sections-tree.html",controller:["$scope","idService",e],controllerAs:"$ctrl"}}])}(),function(){angular.module("ticketModule").controller("CategoriesEditorController",["$scope","categoriesService","$state","$q","events","systemAlertService","$filter","$timeout","searchModel","$rootScope","metadataModel","objectValueMapperService",function(e,t,a,n,i,o,r,s,l,c,d,u){function p(){e.save()}function m(t,a){e.updateIsHandledByParent&&!w()&&(L(a),P())}function f(e){for(var t=1,a=e.listOfTiers.length;t<a;t++)e.listOfTiers[t].disabled=!e.listOfTiers[t-1].selectedValue}function g(e,t){for(var a=t+1,n=e.listOfTiers.length;a<n;a++)e.listOfTiers[a].selectedValue="",e.listOfTiers[a].availableValues=[]}function h(t){var a=u.getFieldByName("productManufacturer");a&&(a.value=t),F=t,e.$emit(i.ASSET_UPDATE_PRODUCT_CATEGORY_MANUFACTURER,{productManufacturer:t})}function y(t,a){for(var n={company:v(),depends:{}};a.dependAttribute;){var i=_.find(t.listOfTiers,{name:a.dependAttribute});i&&(n.depends[i.name]=i.selectedValue,"productName"==i.name&&F&&(n.depends.manufacturerName=F),"resProductName"==i.name&&selectedResProductManufacturerName&&(n.depends.manufacturerName=selectedResProductManufacturerName),a=i)}return!_.isEmpty(n.depends)&&e.multiple&&(n.company=t.company),B&&(n.depends.id=e.entity.id),U&&(n.classId=e.entity.classId),e.entity.type===EntityVO.TYPE_KNOWLEDGE&&(n.knowledgeCompanies=M()),e.entity.type===EntityVO.TYPE_INCIDENT&&e.serviceType&&("operationCategoryTier1"!==a.name&&"productCategoryTier1"!==a.name&&"resOperationCategoryTier1"!==a.name&&"resProductCategoryTier1"!==a.name||(n.serviceType=e.serviceType)),_.forEach(t.dependAttributes,function(t){_.forEach(e.categories,function(e){var a=_.find(e.listOfTiers,{name:t});a&&(n.depends[a.name]=a.selectedValue)}),e.dependentCategories&&e.dependentCategories.length&&_.forEach(e.dependentCategories,function(e){var a=_.find(e.listOfTiers,{name:t});a&&(n.depends[a.name]=a.selectedValue)}),_.forEach(e.entity.customFields,function(e,a){a===t&&(n.depends[a]=e)})}),angular.toJson(n)}function E(t){var a=B?{id:e.entity.id}:{};return _.forEach(t.dependAttributes,function(t){_.forEach(e.categories,function(e){var n=_.find(e.listOfTiers,{name:t});n&&(a[n.name]=n.selectedValue)}),e.dependentCategories&&e.dependentCategories.length&&_.forEach(e.dependentCategories,function(e){var n=_.find(e.listOfTiers,{name:t});n&&(a[n.name]=n.selectedValue)}),_.forEach(e.entity.customFields,function(e,n){n===t&&(a[n]=e)})}),a}function v(){var t=e.useLocationCompany?e.locationCompany:e.ticketCompany;return{name:t.name}}function T(){var t=_.find(e.entity.allCompanies,{primary:!0});return{name:t&&t.name||"All"}}function S(){return e.multiple?{name:"All"}:e.company?e.company:e.entity.company&&e.entity.company.name?e.entity.company:e.entity.customer&&e.entity.customer.company?e.entity.customer.company:{name:""}}function C(){e.allowLocationCompanyEdit||e.allowLocationCompany?e.locationCompany||(e.locationCompany=e.entity.locationCompany?_.cloneDeep(e.entity.locationCompany):{name:""}):e.locationCompany=null}function O(){l.getOperatingCompanies(null,-1).then(function(t){e.companies=_.cloneDeep(t.companies),G.tooManyCompanies=t.exceedsChunkSize})}function A(){e.company?e.$watch("company",function(){e.ticketCompany=S()}):U||e.entity.type===EntityVO.TYPE_CHANGE?e.$watch("entity.company.name",function(t){e.ticketCompany={name:t}}):e.$watch("entity.customer.company",function(){e.ticketCompany=S()})}function I(t,a){a&&(e.serviceType=a),_.each(e.categories,function(t){e.clear(t,!0)})}function b(){var t=!0;return _.each(e.categories,function(e){e.serializedValue.length&&(t=!1)}),t}function k(t){var a=_.find(e.entity.allCategories,{name:t.name});a&&(a.dirty=!0)}function D(t){return _.forEach(t.categorizations,k),_.forEach(t.resCategorizations,k),t.locationCompany&&(e.entity.locationCompany=t.locationCompany),!0}function R(a){if(U){var n=a[0].tiers;return n.classId=e.entity.classId,n.instanceId=e.entity.instanceId,t.updateAssetCategory({reconciliationId:e.entity.reconciliationId},n)}return t.updateCategory({entityType:e.entity.type,entityId:e.entity.id},a)}function P(){G.pendingChanges=!1,e.updateIsHandledByParent&&!w()||e.$emit(i.SAVE_CHANGES_COMPLETE)}function w(){return"/draft-incident"===a.current.url||"/draft-workorder"===a.current.url||"/draft-problem"===a.current.url||"/draft-knownerror"===a.current.url}function L(a){_.forEach(e.categories,function(a){if(a.dirty){var n=_.find(e.entity.allCategories,{name:a.name});if(n){for(var i=0;i<a.listOfTiers.length;i++)n.listOfTiers[i].selectedValue=a.listOfTiers[i].selectedValue;n.serializedValue=t.getDisplayValues(n)}}}),t.updateValueToShow(e.entity.allCategories),e.entity.noCategories=_.filter(e.entity.allCategories,"valueToShow").length;var n=t.collectValues(angular.copy(e.entity.allCategories),e.entity,null,!0);w()&&(e.entity.categorizations=n.categorizations),e.entity.resCategorizations=n.resCategorizations,a&&a.locationCompany&&(e.entity.locationCompany=a.locationCompany)}function N(){var e=o.modal({type:"info",title:r("i18n")("common.notification.dirty.title"),text:r("i18n")("categorization.companyChange.warning"),buttons:[{text:r("i18n")("common.button.yes"),data:!0},{text:r("i18n")("common.button.no"),data:!1}]});return e.result}function M(){return _.map(e.entity.allCompanies,function(e){return{name:e.name}})}function V(t,a){e.ticketCompany!==a&&(I(),e.ticketCompany=a)}var F,x=!1;e.isCognitiveRecommendation=!1,e.$on(i.SAVE_CHANGES,p),e.$on(i.SAVE_ALL_CHANGES_COMPLETE,m);var G={loadingTierData:!1,submittingCategories:!1,pendingChanges:!1,tooManyCompanies:!1},B=e.entity.type===EntityVO.TYPE_INCIDENT||e.entity.type===EntityVO.TYPE_CHANGE||e.entity.type===EntityVO.TYPE_RELEASE,U=e.entity.type===EntityVO.TYPE_ASSET||e.entity.ticketType===EntityVO.TYPE_ASSET,z="v4";e.entity.serviceType?e.serviceType=e.entity.serviceType:e.serviceType=e.entity.selectedServiceType&&e.entity.selectedServiceType.name,e.state=G,e.ticketCompany=S(),(e.allowLocationCompanyEdit||e.allowLocationCompany)&&(C(),e.useLocationCompany=e.locationCompany&&e.locationCompany.name&&e.locationCompany.name!==e.ticketCompany.name,O()),A(),_.forEach(e.categories,function(e){_.forEach(e.listOfTiers,function(e,t){e.index=t}),f(e),e.serializedValue=t.getDisplayValues(e)}),_.forEach(e.categoriesSet,function(e){e.serializedValue=t.getDisplayValues(e)}),d.getMetadataByType("global").then(function(t){x=!("No"===t.applyCognitiveForCategorization),e.useCognitive=x,e.productAliasBasedSearch=String(t.configurationParameters.productAliasBasedSearch)}),e.selectTierValue=function(a,n,o,r){var s=_.isObject(o)?o.tier:o;angular.equals(n.selectedValue,s)?"productName"===n.name&&h(o.manufacturer):(n.selectedValue=s,a.dirty=!0,"productName"!==n.name&&(a.company=o.company),g(a,n.index),f(a),"productName"===n.name&&h(o.manufacturer),a.serializedValue=t.getDisplayValues(a),e.onTierInputChange()),e.$emit(i.TICKET_UPDATE_ROOTCAUSE,e.categories),r&&e.focusNextInputElement(r)},e.loadDataForTier=function(a,n,i,o){if(!G.loadingTierData){G.loadingTierData=!0,o?n.isTypeaheadLoading=!0:n.populatingAvailableValues=!0;var r=e.entity.ticketType?e.entity.ticketType:e.entity.type;U=e.entity.ticketType===EntityVO.TYPE_ASSET||U;var l={entityType:U?EntityVO.TYPE_ASSET:e.entity.type,categoryType:a.name,tierName:n.name,criteria:y(a,n),searchText:i};return"productName"===n.name||"resProductName"===n.name?l.restVersion="v3":EntityVO.TYPE_KNOWLEDGE===r?l.restVersion="v2":[EntityVO.TYPE_ASSET,EntityVO.TYPE_KNOWNERROR,EntityVO.TYPE_PROBLEM,EntityVO.TYPE_RELEASE,EntityVO.TYPE_INCIDENT].indexOf(r)===-1&&(l.restVersion=z),t.getCategoryTierData(l).then(function(e){return o?(n.tooManyItems=e.exceedsChunkSize,e.tiers):(n.availableValues=e.tiers,n.exceedsChunkSize=e.exceedsChunkSize,void s(function(){a.isTooltipOpen=!1}))})["finally"](function(){G.loadingTierData=!1,o?n.isTypeaheadLoading=!1:n.populatingAvailableValues=!1})}},e.onSelectCompany=function(t){b()||t.name===e.locationCompany.name?e.locationCompany=t:N().then(function(a){a&&(e.locationCompany=t,I())})},e.clear=function(t,a){G.pendingChanges=!0,t.dirty=e.entity.type!==EntityVO.TYPE_KNOWLEDGE,t.serializedValue="",t.company=null,_.forEach(t.listOfTiers,function(e){e.selectedValue=""}),f(t),e.entity.type!==EntityVO.TYPE_PROBLEM&&e.entity.type!==EntityVO.TYPE_KNOWNERROR&&e.entity.type!==EntityVO.TYPE_RELEASE&&e.entity.type!==EntityVO.TYPE_KNOWLEDGE&&!a&&e.getCategories("",t,!0),e.$emit(i.TICKET_UPDATE_ROOTCAUSE,e.categories)},e.isShowDefaultListAction=!1,e.showDefaultList=function(t,a){e.isCategoryInputChange=!1,e.isTypeaheadListVisible(a)||e.getCategories("",t,!0).then(function(a){x&&a&&a.length&&"COGNITIVE"===e.recommendationMethod?(e.updateCategory(a[0],t),e.isCognitiveRecommendation=!1,t.cognitiveFlag=!0):x&&(e.isCognitiveRecommendation=!0)})["finally"](function(){e.isShowDefaultListAction=!0,x||angular.element("#category-typeahead-"+t.name).focus()})},e.onFocus=function(t){e.isShowDefaultListAction&&(s(function(){$(t.target).click()}),e.isShowDefaultListAction=!1)},e.getCategories=function(a,n,i){function o(t){var a=_.isArray(t)?{serializedValue:_.compact(t).join(" > "),tiers:t}:{serializedValue:_.compact(t.tiers).join(" > "),tiers:t.tiers,company:t.company};if(a&&a.tiers&&a.tiers.length>5&&""!==a.tiers[5]&&"true"===e.productAliasBasedSearch){var n=a.tiers.slice(0),i=n.pop();a.serializedValue=_.compact(n).join(" > ")+" ("+i+")"}return a}var r;return z="true"!==e.productAliasBasedSearch||"product"!=n.name&&"resolutionProduct"!=n.name||i?i?"v2":"v4":"v5",n.isDataLoading=!0,n.recommendations=[],U=e.entity.ticketType===EntityVO.TYPE_ASSET||U,a.length>0?(r={restVersion:z,entityType:U?EntityVO.TYPE_ASSET:e.entity.type,categoryType:n.name,searchText:a,criteria:{company:v()}},r.criteria.depends=E(n),U&&(r.criteria.classId=e.entity.classId||""),e.entity.type===EntityVO.TYPE_INCIDENT&&e.serviceType&&(r.criteria.serviceType=e.serviceType),e.entity.type===EntityVO.TYPE_KNOWLEDGE&&(r.criteria.knowledgeCompanies=M(),i&&x&&(r.criteria.primaryCompany=T())),t.searchCategories(r).then(function(e){return n.isTooltipOpen=n.exceedsChunkSize=e.exceedsChunkSize||!1,s(function(){n.isTooltipOpen=!1},1e4),_.map(e.items,function(e){return o(e)})})["finally"](function(){n.isDataLoading=!1})):U?void(n.isDataLoading=!1):(r={restVersion:z,entityType:e.entity.type,categoryType:n.name,searchData:{company:v(),summary:e.entity.summary||e.entity.title},size:5},B&&(r.searchData.id=e.entity.id),e.entity.type===EntityVO.TYPE_INCIDENT&&e.serviceType&&(r.searchData.serviceType=e.serviceType),e.entity.type===EntityVO.TYPE_KNOWLEDGE&&(r.searchData.knowledgeCompanies=M(),i&&x&&(r.searchData.primaryCompany=T())),t.getRecommendedCategory(r).then(function(t){if(e.recommendationMethod=t.categorizationMethod,!n.serializedValue)return x&&t.items&&t.items.length&&(e.isCognitiveRecommendation=!1,n.cognitiveFlag=!0),n.isTooltipOpen=n.exceedsChunkSize=t.exceedsChunkSize||!1,s(function(){n.isTooltipOpen=!1},1e4),n.recommendations=_.map(t.items,function(e){return o(e)})})["finally"](function(){n.isDataLoading=!1}))},e.onInputFocusBlur=function(e){e.isTooltipOpen=!1},e.onTierInputBlur=function(e){s(function(){e.searchText=""},250)},e.updateCategory=function(t,a){if(a.serializedValue&&a.serializedValue.tiers&&a.serializedValue.tiers.length>5&&0===a.recommendations.length&&"true"===e.productAliasBasedSearch){var n=a.serializedValue.tiers.slice(0);n.pop(),a.serializedValue.serializedValue=_.compact(n).join(" > ")}a.serializedValue=t.serializedValue,a.company=t.company;for(var o=0;o<a.listOfTiers.length;o++)a.listOfTiers[o].selectedValue=t.tiers[o];a.dirty=!0,G.pendingChanges=!0,e.multiple&&e.addCategoryToSet(a),e.$emit(i.TICKET_UPDATE_ROOTCAUSE,e.categories)},e.updateCategoryFromData=function(a){var n=_.head(_.filter(e.categories,{name:a.name}));n&&(e.updateCategory(a,n),n.serializedValue=t.getDisplayValues(n))};var Y=c.$on(i.AFFECTED_SERVICE_UPDATED,function(t,a){var n=_.head(a.product.categorizations);if(n){var i={name:n.name,company:a.company,tiers:[n.tiers.productCategoryTier1,n.tiers.productCategoryTier2,n.tiers.productCategoryTier3,n.tiers.productName,n.tiers.productModelVersion]};i.serializedValue=_.compact(i.tiers).join(" > "),e.updateCategoryFromData(i)}}),q=c.$on(i.AFFECTED_ASSET_UPDATED,function(t,a){var n=_.head(a.product.categorizations);if(n){var i={name:"resolutionProduct",company:a.company,tiers:[n.tiers.productCategoryTier1,n.tiers.productCategoryTier2,n.tiers.productCategoryTier3,n.tiers.productName,n.tiers.productModelVersion]};e.updateCategoryFromData(i)}});e.$on("$destroy",function(){Y(),q()}),e.isCategoryInputChange=!1,e.onCategoryInputChange=function(){e.isCategoryInputChange=!0,G.pendingChanges=!0},e.onTierInputChange=function(){G.pendingChanges=!0},e.onBrowseCategoriesClick=function(t,a){t.edit=!0,f(t),e.focusFirstTierElement(a)},e.onSearchCategoriesClick=function(t,a){t.edit=!1,e.focusInputElement(a)},e.onUseLocationCompanyChange=function(t){var a=t.target;e.useLocationCompany=a.checked,e.useLocationCompany||b()||e.locationCompany.name===e.ticketCompany.name?e.locationCompany=e.ticketCompany:N().then(function(t){t?(e.locationCompany={name:""},I()):(s(function(){e.useLocationCompany=a.checked},0),s(function(){e.useLocationCompany=!a.checked},0))})},e.isLocationCompanyLocked=function(){return e.entity.type===EntityVO.TYPE_INCIDENT&&e.entity.status&&~[EntityVO.STATUS_CLOSED,EntityVO.STATUS_RESOLVED].indexOf(e.entity.status.value.toLowerCase())},e.addCategoryToSet=function(t,a){_.find(e.categoriesSet,{serializedValue:t.serializedValue})||e.categoriesSet.push(_.cloneDeep(t));var n=_.filter(e.categoriesSet,{name:t.name});1!==n.length||"All"!==t.company.name&&e.company.name!==t.company.name||e.setPrimaryCategory(t),e.clear(t,!0),e.focusFirstTierElement(a)},e.setPrimaryCategory=function(t){return t.primary?void(t.primary=!1):void _.forEach(_.filter(e.categoriesSet,{name:t.name}),function(e){e.primary=e.serializedValue===t.serializedValue})},e.removeCategoryFromSet=function(t){_.pull(e.categoriesSet,t)},e.getCompaniesByName=function(e){return l.getCompaniesByText(e).then(function(e){return e.companies})},e.getSerializedValue=function(e){var a="";return e&&e.serializedValue?a=e.serializedValue:e&&(a=t.getDisplayValues(e)),a},e.save=function(){var a=w(),o=!e.updateIsHandledByParent,r=t.collectValues(e.categories,e.entity,e.locationCompany),s=n.when(1);G.pendingChanges=e.entity.type!==EntityVO.TYPE_KNOWLEDGE,G.pendingChanges=G.pendingChanges||!!r.locationCompany,r&&U&&e.updateIsHandledByParent&&(r=r[0]?r[0].tiers:{},r.classId=e.entity.classId,r.instanceId=e.entity.instanceId),e.$emit(i.SAVE_CHANGES_REQUEST,G.pendingChanges?r:{},o||a),G.pendingChanges&&(o||a)&&(G.submittingCategories=!0,s=a?D(r):R(r)),(o||a)&&n.when(s,function(){L()})["finally"](function(){P(),G.submittingCategories=!1})},e.cancel=function(){P()},e.$on(i.CLEAR_CATEGORY_DETAILS,V),e.$on(i.CLEAR_ALL_CATEGORIES,I)}])}(),function(){angular.module("ticketModule").directive("categoriesEditor",["$timeout",function(e){return{restrict:"E",replace:!0,templateUrl:"views/common/categories-editor.html",scope:{entity:"=",categories:"=",dependentCategories:"=",updateIsHandledByParent:"=",hideLabel:"=",hideRecommendations:"=",multiple:"=",categoriesSet:"=",company:"=",editDisabled:"=",locationCompany:"=?",allowLocationCompanyEdit:"=",allowLocationCompany:"=",tooltipPosition:"="},controller:"CategoriesEditorController",link:function(t){t.focusInputElement=function(t){e(function(){$(t.currentTarget).closest("div#category").find('input[type="text"]').focus()},0)},t.focusFirstTierElement=function(t){e(function(){$(t.currentTarget).closest("div#category").find("button.dropdown-input__button").first().focus()},0)},t.focusNextInputElement=function(t){e(function(){var e=$(t.target).parents(".dropdown").next();e.hasClass("dropdown")?e.find(".dropdown-input__button").focus():$(t.target).parents(".dropdown-menu").next().find(".small-btn_secondary").focus()},0)},t.isTypeaheadListVisible=function(e){var t=$(e.currentTarget).closest("div#category").find('ul.dropdown-menu[id^="typeahead"]');return $(t).is(":visible")}}}}])}(),function(){angular.module("ticketModule").directive("categoriesSection",[function(){return{restrict:"AE",replace:!0,templateUrl:"views/common/categories-section.html",scope:{context:"=",updateIsHandledByParent:"=",isCategoriesEmpty:"=?",editDisabled:"=",tooltipPosition:"@"},controller:["$scope","events","categoriesService","systemAlertService","$filter","createTicketService",function(e,t,a,n,i,o){function r(){e.editDisabled||(e.originalCategories=angular.copy(e.ticket.allCategories),e.editCategories())}function s(){e.ticket.allCategories=angular.copy(e.originalCategories),e.originalCategories={},e.close()}function l(){e.close(),e.ticket.type===EntityVO.TYPE_CHANGE&&u()}function c(){e.allCategories=angular.copy(e.context.allCategories),_.forEach(e.allCategories,function(e){e.serializedValue=a.getDisplayValues(e),_.forEach(e.listOfTiers,function(e,t){e.index=t})}),e.categories=_.filter(e.context.allCategories,function(t){return _.find(e.context.categorizations,{name:t.name})}),_.forEach(e.categories,function(e){e.edit=!1})}function d(t){var a=!0;_.each(t,function(e){e.serializedValue.length&&(a=!1)}),e.isCategoriesEmpty=a}function u(){var t=!1,a={companies:[e.ticket.company],categorizations:e.ticket.categorizations};o.getListOfRiskQuestions(a).then(function(a){if(e.newQuestionResponses=a[0].items[0].objects,e.oldQuestionResponses&&0===e.oldQuestionResponses.length&&e.newQuestionResponses&&e.newQuestionResponses.length>0)t=!0;else if(e.oldQuestionResponses&&e.oldQuestionResponses.length>0&&e.newQuestionResponses&&e.newQuestionResponses.length>0)for(var o=0;o<e.newQuestionResponses.length;o++)if(!_.find(e.oldQuestionResponses,{id:e.newQuestionResponses[o].id})){t=!0;break}t&&n.warning({text:i("i18n")("create.change.wizard.risks.riskQuestions.reloaded"),hide:1e4})})}var p={editMode:!1};e.state=p,e.ticket=e.context,e.originalCategories={},e.allowLocationCompanyEdit=e.ticket.type===EntityVO.TYPE_INCIDENT||e.ticket.type===EntityVO.TYPE_WORKORDER,e.tooltipPosition=e.tooltipPosition?e.tooltipPosition:"right",e.$on(t.TOGGLE_EDIT_MODE,r),e.$on(t.DISCARD_CHANGES,s),e.$on(t.SAVE_CHANGES_COMPLETE,l),e.$on(t.SAVE_ALL_CHANGES_COMPLETE,l),c(),e.$watch("allCategories",d,!0),e.editCategories=function(){if(p.editMode=!0,c(),e.ticket.type===EntityVO.TYPE_CHANGE||e.ticket.type===EntityVO.TYPE_RELEASE){var t={companies:[e.ticket.company],categorizations:e.ticket.categorizations};o.getListOfRiskQuestions(t).then(function(t){e.oldQuestionResponses=t[0].items[0].objects})}},e.close=function(){p.editMode=!1}}]}}])}(),function(){angular.module("ticketModule").service("categoriesService",["$resource",function(e){var t=e("/smartit/rest/:restVersion/category/:entityType/:categoryType/:tierName",{},{getCategoryTierData:{method:"GET",isArray:!0},checkCategoryTierData:{url:"/smartit/rest/category/:entityType/:categoryType",method:"GET",isArray:!1,transformResponse:function(e){return{results:angular.fromJson(e)}}},updateCategory:{url:"/smartit/rest/:entityType/all/:entityId",method:"PUT",isArray:!0},updateAssetCategory:{url:"/smartit/rest/asset/update/all/:reconciliationId",method:"PUT",isArray:!0},searchCategory:{url:"/smartit/rest/:restVersion/category/query/:entityType/:categoryType",isArray:!0,method:"GET"},getRecommendedCategory:{url:"/smartit/rest/:restVersion/category/recommendation/:entityType/:categoryType",isArray:!0,method:"GET"}});this.updateValueToShow=function(e){_.forEach(e,function(e){e.valueToShow=void 0,_.forEach(e.listOfTiersToShow,function(t){var a=_.find(e.listOfTiers,function(e){return e.name===t&&!!e.selectedValue});if(a)return e.valueToShow=a.selectedValue,!1})})},this.populateCategories=function(e,t){var a=_.map(t.allCategories||t.categories,function(t){var a=_.find(e,{name:t.name});if(void 0===a)return!1;var n=angular.copy(t);return n.cognitiveFlag=!!a.cognitiveFlag,a.company&&(n.company=a.company),_.forEach(n.listOfTiers,function(e){e.selectedValue=a.tiers[e.name]}),n});return a=_.compact(a),this.updateValueToShow(a),a},this.populateMultipleCategories=function(e,t){var a=this,n=_.map(e,function(e){var a=_.find(t.allCategories,{name:e.name});if(void 0===a)return!1;var n=angular.copy(a);return _.forEach(n.listOfTiers,function(t){t.selectedValue=e.tiers[t.name]}),n.primary=e.primary,n.company=e.company,n.dirty=!0,n});return n=_.compact(n),a.updateValueToShow(n),n},this.buildCategoriesForRootCause=function(e,t){var a={};return _.each(t,function(e){_.each(e.listOfTiers,function(e){"productModelVersion"!==e.name&&(a[e.name]=null)})}),_.each(e,function(e){e.tiers?_.each(e.tiers,function(e,t){"productModelVersion"!==t&&(a[t]=e?e:null)}):e.listOfTiers&&_.each(e.listOfTiers,function(e){"productModelVersion"!==e.name&&(a[e.name]=e.selectedValue?e.selectedValue:null)})}),a},this.getDisplayValues=function(e){return _.compact(_.map(e.listOfTiers,function(e){return e.selectedValue})).join(" > ")},this.getCategoryTierData=function(e){return t.getCategoryTierData(e).$promise.then(function(t){var a=t[0].items,n=[];return"v2"===e.restVersion?_.forEach(a,function(e){_.forEach(e.tiers,function(t){n.push({company:e.company,tier:t})})}):"v3"===e.restVersion?_.forEach(a,function(t){n.push({manufacturer:t.manufacturer,tier:t.productName,company:e.criteria&&e.criteria.company})}):n=a[0],{tiers:n,exceedsChunkSize:t[0].exceedsChunkSize}})},this.checkCategoryTierData=function(e){return t.checkCategoryTierData(e).$promise.then(function(e){return e.results})},this.searchCategories=function(e){return t.searchCategory(e).$promise.then(function(t){var a=e.restVersion?t[0].items:t[0].items[0];return{exceedsChunkSize:t[0].exceedsChunkSize,items:a}})},this.searchCategoriesV3WithChunkSize=function(e){return t.searchCategory(e).$promise.then(function(e){return e[0].items[0]})},this.searchCategoriesV4WithChunkSize=function(e){return t.searchCategory(e).$promise.then(function(e){return{items:e[0].items,exceedsChunkSize:e[0].exceedsChunkSize}})},this.updateCategory=function(e,a){return t.updateCategory(e,a).$promise},this.updateAssetCategory=function(e,a){return t.updateAssetCategory(e,a).$promise},this.getRecommendedCategory=function(e,a){return t.getRecommendedCategory(e,a).$promise.then(function(t){var a={items:e.restVersion?t[0].items:t[0].items[0],categorizationMethod:t[0].categorizationMethod,exceedsChunkSize:t[0].exceedsChunkSize};return a})},this.isDirtyValues=function(e){var t=!1;return _.forEach(e,function(e){e.dirty&&(t=!0)}),t},this.clearDirtyValues=function(e){_.forEach(e,function(e){e.dirty=!1})},this.collectValues=function(e,t,a,n){var i=this,o={},r=[];return _.forEach(e,function(e){if(e.dirty||n){var t={name:e.name,tiers:i.collectTiersValues(e.listOfTiers)};e.primary&&(t.primary=!0),e.company&&(t.company=e.company),r.push(t)}}),t instanceof AssetVO?o=_.filter(r,function(e){return _.find(t.product.categorizations,{name:e.name})}):t.type===EntityVO.TYPE_KNOWLEDGE?o=_.filter(r,function(e){return _.find(t.defaultCategorization,{name:e.name})}):(o.categorizations=_.filter(r,function(e){return _.find(t.categorizations,{name:e.name})}),o.resCategorizations=_.filter(r,function(e){return _.find(t.resCategorizations,{name:e.name})})),a&&(a.name?t.locationCompany&&t.locationCompany.name&&a.name===t.locationCompany.name||(o.locationCompany=a):t.locationCompany&&t.locationCompany.name&&(o.locationCompany=a)),o},this.collectTiersValues=function(e){var t={};return _.forEach(e,function(e){t[e.name]=e.selectedValue}),t}}])}(),function(){angular.module("myitsmApp").factory("expressionEvaluatorService",["expressionSyntaxTreeBuilder","objectValueMapperService","keywordEvaluatorService","functionEvaluatorService",function(e,t,a,n){function i(e,t){return Boolean(e)&&Boolean(t)}function o(e,t){return Boolean(e)||Boolean(t)}function r(e,t){return _.isString(e)&&_.isString(t)?e.length>t.length?t&&_.includes(e,t):e&&_.includes(t,e):_.isArray(e)?_.includes(e,t):!!_.isArray(t)&&_.includes(t,e)}function s(e){return(_.isString(e)&&"NULL"===e.toUpperCase()||null===e)&&(e=""),e}function l(t){if(!p[t]){var a=e(t);if(!c(a))throw new Error("Invalid syntax found during parsing");p[t]=a}return p[t]}function c(e){var t=!1;switch(e.type){case"LogicalExpression":case"BinaryExpression":t=c(e.left)&&c(e.right);break;case"CallExpression":t=!0;break;case"UnaryExpression":t=c(e.argument);break;case"Identifier":case"Literal":t=!0;break;case"ConditionalExpression":t=!0}return t}function d(e){var i,o,r,s;switch(e.type){case"CallExpression":var l=e.arguments,c=e.callee.name,u=[];return _.indexOf(["ISREQUIRED","ISREADONLY","ISHIDDEN","ONCHANGE"],c)>-1?_.each(l,function(e){if("Literal"===e.type)_.startsWith(e.raw,"'$")&&(r=e.raw.replace(/['$]/g,""),u.push(r));else{if(!_.startsWith(e.name,"$"))throw new Error("Function "+c+" has invalid arguments.");r=e.name.substr(1,e.name.length-1),u.push(r)}}):_.each(l,function(e){if(u.push(d(e)),s="Identifier"===e.type?e.name:e.value,c.indexOf("SELECTION")!==-1&&s){var a=t.getFieldByName(s.substr(1));a&&a.options&&u.push(a.options)}}),n.execute(c,u);case"ConditionalExpression":var p=d(e.test);return d(p?e.consequent:e.alternate);case"LogicalExpression":if(i=d(e.left),o=d(e.right),m[e.operator]){var g=m[e.operator](i,o);if(_.isNaN(g))throw new Error("Operator: "+e.operator+" has invalid arguments: "+i+", "+o);return g}throw new Error("Unknown Logical operator: "+e.operator);case"BinaryExpression":if(i=d(e.left),o=d(e.right),m[e.operator]){var h=m[e.operator](i,o);if(_.isNaN(h))throw new Error("Operator: "+e.operator+" has invalid arguments: "+i+", "+o);return h}throw new Error("Unknown binary operator: "+e.operator);case"Literal":return _.startsWith(e.raw,"'$")?_.endsWith(e.raw,"$'")?(r=e.raw.replace(/['$]/g,""),a.evaluate(r)):(r=e.raw.replace(/['$]/g,""),t.getExactValueByFieldName(r)):0===e.value||e.value===!1?e.value:e.value||"";case"Identifier":return _.startsWith(e.name,"$")?_.endsWith(e.name,"$")?(r=e.name.substr(1,e.name.length-2),a.evaluate(r)):t.getExactValueByFieldName(e.name.substr(1)):e.name;case"UnaryExpression":if(f[e.operator]){var y=d(e.argument),E=f[e.operator](y);if(_.isNaN(E))throw new Error("Operator: "+e.operator+" has invalid argument: "+y);return E}throw new Error("Unknown unary operator: "+e.operator);default:throw new Error("Invalid syntax")}}function u(e){var t=e;if(_.isString(e))if(e=_.trim(e)){var a,n=e;try{a=l(n)}catch(i){throw new Error('Cannot parse expression "'+e+'": '+i.message+".")}try{t=d(a)}catch(i){throw new Error('Cannot evaluate expression "'+e+'": '+i.message+".")}}else t=null;return t}var p={},m={"==":function(e,t){return Boolean(s(e)===s(t))},"+":function(e,t){return _.isUndefined(e)||null===e&&_.isString(t)?t:_.isUndefined(t)||null===t&&_.isString(e)?e:null===e&&null===t?null:e+t},"-":function(e,t){return _.isUndefined(e)&&(e=0),_.isUndefined(t)&&(t=0),e-t},"*":function(e,t){return _.isUndefined(e)&&(e=0),_.isUndefined(t)&&(t=0),e*t},"/":function(e,t){return _.isUndefined(e)||_.isUndefined(t)?0:e/t},"<":function(e,t){return e<t},">":function(e,t){return e>t},">=":function(e,t){return e>=t},"<=":function(e,t){return e<=t},"!=":function(e,t){return s(e)!==s(t)},"%":function(e,t){return _.isUndefined(e)||_.isUndefined(t)?0:e%t;
},"&&":i,"||":o,LIKE:r,like:r},f={"-":function(e){return _.isUndefined(e)?0:-Number(e)},"!":function(e){return!Boolean(e)}};return{evaluate:u,parseExpression:l,validateChildNodeTypes:c}}])}(),function(){angular.module("myitsmApp").service("expressionEventManager",["objectValueMapperService","expressionEvaluatorService","widgetDependencyHandlerService","$log","$timeout",function(e,t,a,n,i){function o(a,i){if(!e.isCopyChange()){n.topic("expressions","Applying expression "+a.expression+' to field "'+a.field+'", property "'+a.property+'"');var o=t.evaluate(a.expression);e.setByProperty(a.field,a.property,o,a.isWidget,i)}}function r(a,i){if(!e.isCopyChange()){n.topic("expressions",'Applying Provider action "'+i.action.actionName+'" with expression "'+i.expression+'"');var o=t.evaluate(i.expression);o?e.setProviderActionToExecute(i):(e.clearProviderActionFromList(i.action),e.clearProviderActionFieldName(a,i.actionId))}}function s(t,i){n.topic("expressions",'Widget change "'+t+'"');var r=e.getExpreesionMapByFieldName(t);r&&r.length&&_.each(r,function(e){o(e,i)}),"company"!==t&&"customerCompany"!==t||a.handleValueChange(t,null,i)}function l(t){n.topic("provider action expressions",'Widget change "'+t+'"');var a=_.sortBy(e.getProviderActionExpressionMapByFieldName(t),function(e){return e.action&&e.action.sequenceNo});a&&a.length&&_.each(a,function(a){i(function(){a.action&&(a.action.actionFieldName=t,a.action.actionId=a.actionId),e.setProviderActionFieldName(t,a.actionId),r(t,a)})})}function c(){var t=e.getAllExpressionFields();_.each(t,function(e){s(e,"fromTicketLoad")})}function d(){var t=e.getAllProviderActionExpressionFields();_.each(t,function(e){l(e)})}function u(t,i,o){var r=e.getWidgetMembers(t);_.each(r,function(e){n.topic("expressions",'Field Change "'+t+'"'),s(e,o)}),a.handleValueChange(t,i)}return{handleFieldChange:s,handleOOTBFieldValueChange:u,handleTicketLoad:c,handleTicketLoadForActions:d,handleFieldChangeForActions:l}}])}(),function(){angular.module("myitsmApp").service("objectValueMapperService",["$q","metadataModel","configurationModel","$log","$timeout","$rootScope","events","fieldValidationModel",function(e,t,a,n,i,o,r,s){function l(e,t,a){console.log("Set field value: "+e+"="+t);var n=T[e];n&&(n.setValueFlag=t,n.isFromTicketLoad="fromTicketLoad"===a,n.isTextField()||n.isTextareaField()||n.isNumberField()?(t=(n.isTextField()||n.isTextareaField())&&null!==t?t+"":t,""!==t&&null!==t?n.setValue(t):n.clearValue()):n.hasDateDataType()||n.hasDateTimeDataType()||n.hasTimeDataType()?c(n,t):(n.isMenuField()||n.isDropdownField()||n.isRadioField())&&n.setValue(t))}function c(e,t){t&&moment(t).isValid()?e.hasDateDataType?(e.value=new Date(t).getTime(),e.hasValue=!0):e.setValue(new Date(t).getTime()):e.clearValue()}function d(e,t,a){console.log("Set widget value: "+e+"="+t);var n=T[e];n&&(n.setValueFlag=t,n.isFromTicketLoad="fromTicketLoad"===a)}function u(e,t){return P[e]&&P[e].indexOf(t)}function p(e){var t=e.isWidget();e.requiredCondition&&m(e.requiredCondition,e.name,"required",t),e.hideCondition&&m(e.hideCondition,e.name,"hide",t),e.setValueCondition&&m(e.setValueCondition,e.name,"value",t),e.readOnlyCondition&&m(e.readOnlyCondition,e.name,"readOnly",t)}function m(e,t,a,n){var i=f(e);i.length||O.__constantExpressions.push({expression:e,field:t,property:a,isWidget:n}),_.each(i,function(i){O[i]||(O[i]=[]),_.find(O[i],{field:t,property:a})||O[i].push({expression:e,field:t,property:a,isWidget:n})})}function f(e){for(var t,a=/(?:^|\W)\$(\w+)(?!\w)/g,n=/['"]\$(.*?)['"]/g,i=[];null!==(t=a.exec(e));)i.push(t[1]);for(;null!==(t=n.exec(e));)i.push(t[1].replace(/['$]/g,""));return i}var g,h,y,E,v="",T={},S={},C={},O={__constantExpressions:[]},A={__constantExpressions:[]},I={},b={},k={},D=[],R={},P={},w=!1,L=!1,N={};this.clearMap=function(e){T={},O={__constantExpressions:[]},A={__constantExpressions:[]},v=e,w=!1},this.shelveAsParent=function(e){S=T,N={expressionMapper:O,providerActionExpressionMapper:A,isCopyChangeScreen:w},L=!0,this.clearMap(e)},this.unshelveParent=function(e){this.clearMap(e),T=S,O=N.expressionMapper,A=N.providerActionExpressionMapper,w=N.isCopyChangeScreen,L=!1},this.isShelvedParentEmpty=function(){return!L},this.setCopyChangeTicket=function(){w=!0},this.isCopyChange=function(){return w},this.changeMode=function(e,n,i){n&&(k=a.get("ootbFieldValueMap."+(v||i.type)),b=a.get("widgetFieldMap"),y=i,t.getMetadataByType(v||i.type).then(function(e){h=e.ootbMapping,g=e}))},this.getTicketType=function(){return v},this.getFieldList=function(){return T},this.addFields=function(e){_.each(e,function(e){e.isWidgetMember()||"group"===e.dataType?"group"===e.dataType?_.each(e.members,function(e){T[e.name]=e,p(e)}):C[e.name]=e:(console.log(e.name+" "+e.dataType),b[v]&&b[v][e.name]?_.each(b[v][e.name],function(t){I[t]=e.name}):e.members.length&&_.each(e.members,function(t){I[t.name]=e.name}),T[e.name]=e,p(e))})},this.getFieldsByType=function(e){var t=[];return _.forEach(T,function(a){a.type===e&&t.push(a)}),t},this.getValueByFieldName=function(e){return T[e]?T[e].value:""},this.getExactValueByFieldName=function(e){var t,a,n,i,o=k[e];return"assigneeName"===e&&(e="assignee"),T[e]&&"menu"===T[e].dataType&&null!==T[e].value&&void 0!==T[e].value?t=T[e].value:o&&T[o.fieldName]?(t=_.get(T[o.fieldName].value,o.path,""),"object"==typeof t&&null!==t&&t.name&&(t=t.name)):I[e]&&T[I[e]]&&"category"===T[I[e]].type&&(a=_.find(T[I[e]].value.listOfTiers,{name:e}),t=a.selectedValue||""),t||(t=T[e]?T[e].value:void 0),void 0===t&&h&&h[e]&&(t=_.get(y,h[e][0],""),!t&&h[e][1]&&(t=_.get(y,h[e][1],""))),t&&t.name?t=t.name:t&&"[object Object]"===t.toString()&&(t=""),I[e]&&T[I[e]]&&(i=_.find(T[I[e]].members,{name:e}),n=i?i.type:""),n||(n=T[e]?T[e].type:""),t&&_.includes(["dateField","dateTimeField"],n)&&(t=new Date(t).getTime()),t||0===t||t===!1?t:""},this.setValueByFieldName=function(e,t){var a=T[e];a&&a.setValue(t)},this.getFieldByName=function(e){if(T[e])return T[e]},this.getFieldPropertyValue=function(e,t){var a,n,i,o,r;if(a=this.getFieldByName(e),a||(n=I[e],i=this.getFieldByName(n),a=_.find(i.members,{name:e})),"statusReason"!==e&&"taskStatusReason"!==e)return i&&"category"===i.type&&e.indexOf("Tier1")===-1&&"isRequired"===t?a&&a[t]:a&&a[t]||i&&i[t];if("isReadOnly"===t)return a&&a[t];if(o="taskStatusReason"===e?this.getValueByFieldName("taskStatus"):this.getValueByFieldName("status"),r=_.find(g.statuses,{name:o}),"isRequired"===t){var l="statusReason",c=void 0;if(this.getTicketType()===EntityVO.TYPE_CHANGE){var d=this.getValueByFieldName("changeClass");c=d.timing}return!!r.statusReasons&&s.isFieldRequired(v,o,c,l)}return"isHidden"===t?!r.statusReasons:void 0},this.getFieldDefinitionByName=function(e,t){var a=this.getFieldByName(e),n=k[e]||{},i=I[e];if(!a||t&&t!==a.itsmFieldId){var o=this.getFieldByName(n.fieldName||i);if(o){var r={name:e};t&&(r.itsmFieldId=t),a=_.find(o.members,r)}}return a},this.setByProperty=function(e,t,a,i,s){n.debug("Set "+e+" property "+t+" to "+a);var c=!0;if("function"!=typeof a){switch(t){case"required":c=!(T[e].isRequired===a),T[e].isRequired=a;break;case"hide":c=!(T[e].isHidden===a),T[e].isHidden=a;break;case"readOnly":c=!(T[e].isReadOnly===a),T[e].isReadOnly=a;break;case"value":i?d(e,a,s):l(e,a,s)}if(a&&c&&("required"===t||"hide"===t||"readOnly"===t))if(i){var u=this.getWidgetMembers(e);u&&o.$broadcast(r.WIDGET_VALUE_CHANGE,{fieldName:e,memberName:u,isCalledFromSetProp:!0,source:s})}else o.$broadcast(r.FIELD_VALUE_CHANGE,{name:e,isCalledFromSetProp:!0,source:s})}},this.setFieldFromProvider=function(t,a){var n=e.defer(),i=this,o={impactedService:"ASSET",causalCI:"ASSET",assignee:"PERSON",assigneeSupportGroups:"GROUP",customer:"PERSON",site:"SITE",changeLocation:"SITE",locationCompany:"LOCATION",contact:"PERSON",requestedFor:"PERSON",changeManager:"PERSON",changeCoordinator:"PERSON",changeCoordinatorSupportGroups:"GROUP",changeManagerSupportGroups:"GROUP",product:"CATEGORY",resolutionOperational:"CATEGORY",resolutionProduct:"CATEGORY",operational:"CATEGORY",targetDate:"DATE",scheduledDates:"DATE",actualDates:"DATE"},r={ASSET:{ci:{instanceId:"",name:"",classId:""}},GROUP:{supportGroups:"",name:"",id:"",organization:"",company:{name:""}},SITE:{site:{name:""},region:{name:""},siteGroup:{name:""},attributeMap:{siteAddress:{street:"",city:"",state:"",country:"",zip:""}}},LOCATION:{locationCompany:""},PERSON:{firstName:"",lastName:"",fullName:"",organization:"",loginId:"",personId:"",id:"",isVIP:"",site:{name:"",siteGroup:"",region:"",address:{street:"",city:"",state:"",country:"",zip:""}},company:{name:""}},CATEGORY:{name:"",tiers:{}},DATE:{scheduledStartDate:"",scheduledEndDate:"",actualStartDate:"",actualEndDate:"",targetDate:""}},s={},c={},u={};return _.each(a,function(e){var a=e.mappedFieldValue;if("output"===e.type){var n=i.getFieldDefinitionByName(a,e.mappedFieldId),l=t[e.mappedFieldId];if(n&&n.isDropdownField()){var d=_.find(n.options,{name:l});d&&(l=d.name)}if(T[a]&&!T[a].isWidget())c[a]=l;else if(T[a]&&_.includes(["priority","status","taskStatus","desc","phoneNumber","internetEmail","changeClass","organization"],a))u[a]=l;else if(I[a]&&T[I[a]]&&"category"===T[I[a]].type)s[I[a]]||(s[I[a]]=_.cloneDeep(r[o[I[a]]]),s[I[a]].name=I[a]),s[I[a]].tiers[a]=l,l&&(s[I[a]].changedTiers||(s[I[a]].changedTiers=[]),s[I[a]].changedTiers.push(a));else if(k[a]&&k[a].fieldName){if(!s[k[a].fieldName]){var p=r[o[k[a].fieldName]];p?s[k[a].fieldName]=_.cloneDeep(r[o[k[a].fieldName]]):s[k[a].fieldName]={}}_.set(s[k[a].fieldName],k[a].path,l)}}}),console.log("customSetFields-",c),Object.keys(c).forEach(function(e){l(e,c[e])}),console.log("customSetWidgets-",u),Object.keys(u).forEach(function(e){d(e,u[e])}),console.log("widgetSetFields-",s),Object.keys(s).forEach(function(e){T[e].setValueFlag=s[e]}),n.resolve(),n.promise},this.setProviderActionToExecute=function(e){_.find(D,{actionId:e.actionId})||(D.push(e),o.$broadcast(r.PROVIDER_ACTION,D))},this.getProviderActionsList=function(){return D},this.clearProviderActionFromList=function(e){D.length&&_.remove(D,{actionId:e.id})},this.getExpreesionMapByFieldName=function(e){return O[e]},this.getAllExpressionFields=function(){return Object.keys(O)},this.getWidgetMembers=function(e){var t=[];return b[v]&&b[v][e]?b[v][e]:T[e]&&T[e].members&&T[e].members.length?(_.each(T[e].members,function(e){t.push(e.name)}),t):[e]},this.setProviderActionFieldName=function(e,t){P[e]||(P[e]=[]),t&&u(e,t)===-1&&P[e].push(t)},this.clearProviderActionFieldName=function(e,t){if(t&&P[e]&&P[e].length>0){var a=u(e,t);a!==-1&&P[e].splice(a,1)}},this.getProviderActionFieldName=function(e){return!!(P[e]&&P[e].length>0)&&e},this.getProviderActionExpressionMapByFieldName=function(e){return A[e]},this.getAllProviderActionExpressionFields=function(){return Object.keys(A)},this.addToProviderActionExpressionMapper=function(e,t){var a=f(e);a.length||A.__constantExpressions.push({expression:e,action:t,actionId:t.id}),_.each(a,function(a){A[a]||(A[a]=[]),_.find(A[a],{actionId:t.id})||A[a].push({expression:e,action:t,actionId:t.id})})},this.setFieldActionMapping=function(e,t){t&&!R[t]&&(R[t]=e)},this.getFieldActionMapping=function(e){return R[e]},this.registerProviderActionCallExpressionEvent=function(e){E=e},this.isProviderActionEventRegistered=function(){return E}}])}(),function(){var e=window.jsep;angular.module("myitsmApp").service("expressionSyntaxTreeBuilder",[function(){return e.addBinaryOp("LIKE",7),e.removeBinaryOp("="),e.removeBinaryOp("|"),e.removeBinaryOp("^"),e.removeBinaryOp("&"),e.removeBinaryOp("==="),e.removeBinaryOp("!=="),e.removeBinaryOp("<<"),e.removeBinaryOp(">>"),e.removeBinaryOp(">>>"),e.removeUnaryOp("~"),e}])}(),function(){angular.module("myitsmApp").service("functionEvaluatorService",["userModel","objectValueMapperService",function(e,t){function a(e){return e="m"===e.toLowerCase()?"M":"mn"===e.toLowerCase()?"m":e.toLowerCase()}var n;e.getFullCurrentUserData().then(function(e){n=e});var i={NOOP:function(){return angular.noop},REPLACE:function(e,t,a){if(3===arguments.length)return e.replace(t,a)},DATEADD:function(e,t,n){if(3===arguments.length)return moment(n).add(t,a(e))},DATEDIFF:function(e,t,n){if(3===arguments.length)return moment(t).diff(moment(n),a(e))},HASROLE:function(e){if(1===arguments.length&&n.roles){var t=parseInt(e),a=!1;return _.forEach(n.roles,function(e){a||(a=!!_.find(e,{id:t}))}),a}return!1},INGROUP:function(e){if(1===arguments.length){var t=parseInt(e);return!_.isUndefined(_.find(n.groups,{id:t}))}return!1},SELECTIONINDEX:function(e,t){var a=-1;return _.forEach(t,function(t){e===t.name&&(a=t.index)}),a},SELECTIONLABEL:function(e,t){var a=e;return _.forEach(t,function(t){e===t.name&&(a=t.label)}),a},ISREQUIRED:function(e){if(1===arguments.length&&""!==e)return t.getFieldPropertyValue(e,"isRequired")},ISREADONLY:function(e){if(1===arguments.length&&""!==e)return t.getFieldPropertyValue(e,"isReadOnly")},ISHIDDEN:function(e){if(1===arguments.length&&""!==e)return t.getFieldPropertyValue(e,"isHidden")},ONCHANGE:function(e){var a=t.getProviderActionFieldName(e);if(1===arguments.length&&""!==e&&e===a)return!0}};this.execute=function(e,t){if(!_.isUndefined(i[e]))return i[e].apply(this,t)}}])}(),function(){angular.module("myitsmApp").service("keywordEvaluatorService",["userModel","metadataModel","$window",function(e,t,a){var n,i=[{name:"$HOMEURL$",desc:"Returns the base url"},{name:"$MIDTIERURL$",desc:"Returns the url of mid-tier"},{name:"$NOW$",desc:"Returns milliseconds since EPOCH"},{name:"$NULL$",desc:"Returns null"},{name:"$USER$",desc:"Returns login id for current user"}];t.getMetadataByType(EntityVO.TYPE_GLOBAL).then(function(e){n=e}),this.evaluate=function(t){switch(t){case"NULL":return"";case"USER":return e.userId;case"NOW":return moment().valueOf();case"MIDTIERURL":return n.configurationParameters&&n.configurationParameters.midTierURL?n.configurationParameters.midTierURL:"";case"HOMEURL":return a.location.origin+a.location.pathname}},this.getSupportedKeywords=function(){return i}}])}(),function(){angular.module("myitsmApp").controller("FoundationSelectorController",["$scope","foundationService","events","searchModel","i18nService","$timeout",function(e,t,a,n,i,o){var r={loadingFieldData:!1,showTooltip:!1};e.fdSelector=t.buildControls(e.type,e.options),e.search={typeaheadText:""},e.loadDataForField=function(a,i){if(e.searchFilterText="",!r.loadingFieldData){r.loadingFieldData=!0,i.populatingAvailableValues=!0;var o={type:i.name,searchOptions:t.prepareSearchOptions(a,i)};e.useChunking&&(o.chunkInfo={startIndex:0,chunkSize:n.locationSiteChunkSize}),t.getFieldData(o).then(function(t){i.availableValues=t.foundationItems,e.typeaheadMode&&e.useChunking?t.length>=n.locationSiteChunkSize?e.state.tooManyData=!0:e.state.tooManyData=!1:e.typeaheadMode&&!e.useChunking&&(e.state.tooManyData=t.exceedsChunkSize)})["finally"](function(){r.loadingFieldData=!1,i.populatingAvailableValues=!1})}},e.loadDataByText=function(a,i,o){var s={type:i.name,searchOptions:t.prepareSearchOptions(a,i)};return e.useChunking&&(s.chunkInfo={startIndex:0,chunkSize:n.locationSiteChunkSize}),o&&(s.searchText=o),t.getFieldData(s).then(function(e){if(r.showTooltip=e.exceedsChunkSize,i.connected.searchOptionName)for(var t=0;t<e.foundationItems.length;t++)e.foundationItems[t].attributeMap.searchOptionName=i.connected.searchOptionName;return e.foundationItems})["finally"](function(){r.loadingFieldData=!1,i.populatingAvailableValues=!1})},e.handleKeyup=function(t){e.searchFilterText=t.target.value},e.clearSearchText=function(){o(function(){e.search.typeaheadText=""},250)},e.selectFieldValue=function(a,n,i,o){n.value!==i.name&&(t.setDependantFieldValues(a,n,i),n.value=i.name,n.id=i.id,t.resetFurtherFieldValues(a,n.index),e.multiple||(e.selectedFoundations=t.collectValues(e.fdSelector),e.selectedFoundations.fieldChanged=n.name),o&&e.focusNextInputElement(o),e.search.typeaheadText="")},e.resetFieldValue=function(a,n,i){i.stopPropagation(),e.focusInputElement(i),t.resetFieldValue(a,n),e.multiple||(e.selectedFoundations=t.collectValues(e.fdSelector),e.selectedFoundations.fieldChanged=n.name),e.loadDataForField(a,n)},e.add=function(n){var i=t.collectValues(e.fdSelector);e.selectedFoundations.push(i),t.resetFurtherFieldValues(e.fdSelector.fdFields,-1),e.$emit(a.FOUNDATION_ADD,i),e.focusFirstInputElement(n)},e.isAddButtonDisabled=function(){var a=!1,n=t.collectValues(e.fdSelector);return _.filter(e.fdSelector.fdFields,"value").length||(a=!0),a||_.forEach(e.selectedFoundations,function(e){angular.equals(e,n)&&(a=!0)}),a},e.getLabel=function(e){var t;return e.name&&(t=i.getLocalizedString(e.name)),t},e.filterDropDown=function(t){if(t)return function(a){return _.includes(e.getLabel(a).toLowerCase(),t.toLowerCase())}},e.state=r}])}(),function(){angular.module("myitsmApp").directive("foundationSelector",["events","foundationService",function(e,t){return{restrict:"E",replace:!0,templateUrl:"views/common/foundation-selector.html",scope:{type:"@",inline:"=",typeaheadMode:"=",useChunking:"=",multiple:"=",options:"=",selectedFoundations:"=",isEditable:"=?",isRequired:"=?",isFullWidth:"=?"},controller:"FoundationSelectorController",link:function(a,n){function i(){!a.multiple&&a.selectedFoundations&&_.forEach(a.fdSelector.fdFields,function(e){e.value=a.selectedFoundations[e.attribute]})}function o(e,n){a.selectedFoundations.companyName!==n.name&&(a.selectedFoundations.companyName=n.name,_.forEach(a.fdSelector.fdFields,function(e){e.value="company"===e.name?a.selectedFoundations[e.attribute]:null}),a.multiple||(a.selectedFoundations=t.collectValues(a.fdSelector)))}a.isFullWidth&&(a.fieldLengthForSm4=!0),a.$parent.$parent.isNew?a.fieldLengthForSm6=!0:n.closest(".layout-renderer__child-column")[0]&&(a.fieldLengthForSm6=_.includes(n.closest(".layout-renderer__child-column")[0].className,"col-sm-6"),a.fieldLengthForSm4=_.includes(n.closest(".layout-renderer__child-column")[0].className,"col-sm-4")),_.isBoolean(a.isEditable)||(a.isEditable=!0),a.focusInputElement=function(e){$(e.currentTarget).parent().focus()},a.focusFirstInputElement=function(e){$(e.currentTarget).parents(".fd-selector").children().first().find(".dropdown-input__button").focus()},i(),a.focusNextInputElement=function(e){var t=$(e.currentTarget).parents(".dropdown").next();t.hasClass("dropdown")?t.find(".dropdown-input__button").focus():t.find("button").focus()},a.$watch("selectedFoundations",function(e){e&&i()}),a.$on(e.CLEAR_FOUNDATION_SERVICE,o)}}}])}(),function(){angular.module("myitsmApp").service("foundationService",["configurationModel","searchService",function(e,t){function a(e){var t=_.keyBy(e,"name"),a={name:"site",region:"region",siteGroup:"siteGroup",companyName:"company"},n={};return _.forEach(a,function(e,a){n[a]=t[e].value,"name"===a&&(n.siteId=t[e].id)}),n}function n(e){var t=_.keyBy(e,"name"),a={organization:"organization",department:"department",companyName:"company"},n={};return _.forEach(a,function(e,a){n[a]=t[e].value}),n}this.getFieldData=function(e){return t.getFoundationItems(e)},this.buildControls=function(t,a){var n=_.cloneDeep(e.get("foundation."+t));return _.merge(n.fdFields,a),_.forEach(n.fdFields,function(e){e.connected&&(e.connected=n.fdFields[e.connected])}),n.fdFields=_.sortBy(n.fdFields,"index"),n},this.prepareSearchOptions=function(e,t){var a={},n=_.filter(e,function(e){return e.index<t.index});return _.forEach(n,function(e){e.value&&(a[e.searchOptionName]=e.value)}),_.isEmpty(a)?angular.noop():a},this.setDependantFieldValues=function(e,t,a){_.forEach(e,function(e){e.value=a.attributeMap[e.searchOptionName]?a.attributeMap[e.searchOptionName]:""})},this.resetFurtherFieldValues=function(e,t){_.forEach(e,function(e){e.index>t&&(e.value=null,e.id=null)})},this.resetFieldValue=function(e,t){t.value=null,t.id=null,t.connected&&t.connected.name&&(t.connected.value="",t.connected.id=""),this.resetFurtherFieldValues(e,t.index)},this.collectValues=function(e){var t={site:a,organization:n};return t[e.label](e.fdFields)}}])}(),function(){angular.module("myitsmApp").factory("ccsModel",["$rootScope","ccsService",function(e,t){var a={};return a.getCCSParameters=function(){return t.getCCSParameters().then(function(e){return e})},a}])}(),function(){angular.module("myitsmApp").service("ccsService",["$resource",function(e){var t=e("/smartit/rest/ccs/properties",{},{getCCSParameters:{url:"/smartit/rest/ccs/properties",method:"GET",async:!1,isArray:!1,transformResponse:function(e){return{results:angular.fromJson(e)}}}});this.getCCSParameters=function(){return t.getCCSParameters().$promise.then(function(e){return e.results||[]})}}])}(),function(){angular.module("myitsmApp").constant("queryStringParser",{parse:function(e){if("string"==typeof e||"undefined"==typeof e){for(var t,a=/([^=?&]+)=([^&]*)/g,n={};null!==(t=a.exec(e));)n[decodeURIComponent(t[1])]=decodeURIComponent(t[2]);return n}throw new Error("Not a string")},build:function(e){if(null!==e&&"object"==typeof e)return Object.keys(e).reduce(function(t,a,n){return t+(n?"&":"")+a+"="+e[a].toString()},"");throw new Error("Not object value")}})}(),function(){angular.module("myitsmApp").factory("utilityFunctions",[function(){var e={},t=1;return e.calculateConditionalQuestionVisibility=function(e,t,a){return t.isHidden===!a&&_.matchConditionValues(e,t)&&!e.isHidden&&e.visibility},e.matchConditionValues=function(e,t){return"RADIO_BUTTONS"===e.format||"STATIC_MENU"===e.format?t.conditionValues===e.answer:!("CHECK_BOXES"!==e.format||!e.answer)&&e.answer.sort().join(";")===t.conditionValues.split(";").sort().join(";")},e.windowPostMessage=function(e,t,a){a&&e&&e.postMessage(JSON.stringify(t),a)},e.checkIfJson=function(e){if(0===e.length)return!1;try{if(JSON.parse(e),!isNaN(e))return!1}catch(t){return!1}return!0},e.convertDateTimeAnswerToISO8601=function(e){var t;if(e.date&&e.time){var a=moment(e.time);t=moment(e.date).hour(a.hour()).minute(a.minute())}else t=moment(e);return t.format()},e.getTicketCreatedSuccessMessageWithLink=function(e,t,a,n){var i;return i=n?"<a href=#/"+a+"/"+e+' target="_blank">'+t+"</a>":"<a href=#/"+a+"/"+e+">"+t+"</a>"},e.getUniqueId=function(){return t++},e.trimFirstThreeWildCardCharacters=function(e,t){for(var a=!1,n=0;n<e.length&&3!==n;n++)t.indexOf(e[n])!==-1&&(e=e.substring(0,n)+e.substring(n+1,e.length),n--,a=!0);return{text:e,showTooltip:a}},e.escapeHTML=function(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")},e.decodeHTML=function(e){return e.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&apos;/g,"'").replace(/&#039;/g,"'")},e.isValidHttpUrl=function(e){var t;try{t=new URL(e)}catch(a){return!1}return"http:"===t.protocol||"https:"===t.protocol},e.convertToUserPreferenceTimezone=function(e,t){if(!e)return null;var a=new Date(e).toLocaleString("en-US");return moment.tz(a,"M/D/YYYY, h:mm:ss A",t).toDate()},e.convertToLocalTimezone=function(e,t){if(!e)return null;var a=moment.tz(e,t).toArray(),n=new(Date.bind.apply(Date,[void 0].concat(a)));return n.getTime()},e}])}(),function(){angular.module("myitsmApp").factory("relationModel",["relationService","systemAlertService","$filter","$q",function(e,t,a,n){function i(e,t){return t.length&&_.forEach(t,function(e){angular.isDefined(e.visited)&&delete e.visited}),{ids:[e],relationship:t}}function o(e){_.forEach(e,function(e,t){r.cache[t]?(r.cache[t].length=0,Array.prototype.push.apply(r.cache[t],e.relations)):r.cache[t]=e.relations,1===e.relations.length&&r.cache[e.relations[0].id]&&r.refreshRelations(e.relations[0].id,e.relations[0].type)})}var r={cache:{},unlinked:[]};return r.getRelations=function(t,a,i,o){var s={};if(i&&(s={criteria:'{"parentDisplayId": '+i+"}"}),o)return s=_.assign(s,o),e.getRelations(t,a,s);if(!r.cache[t]){var l=e.getRelations(t,a,s).then(function(e){return e&&e.length>0?r.cache[t]&&r.cache[t].length?r.cache[t].concat(e):r.cache[t]=e:r.cache[t]&&r.cache[t].length||(r.cache[t]=[]),r.cache[t]});return r.cache[t]=l,l}var c=_.has(r.cache[t],"$$state.status");return n.when(c?r.cache[t]:angular.copy(r.cache[t]))},r.refreshRelations=function(t,a){return e.getRelations(t,a).then(function(e){return r.cache[t]=e,r.cache[t]})},r.addRelation=function(t,a,n){return e.bulkAddRelation(i(t,a)).then(function(e){if(o(e),n)return e})},r.bulkAddRelationHKM=function(t,a){return e.bulkAddRelationHKM(i(t,a)).then(function(e){return e})},r.markRelationForAdd=function(e,t){t instanceof Array?r.cache[e]=r.cache[e].concat(t):(r.cache[e]instanceof Array==!1&&(r.cache[e]=[]),r.cache[e].push(t))},r.markRelationForDelete=function(e,t){var a=_.findIndex(r.cache[e],{id:t.id});r.cache[e].splice(a,1)},r.bulkAddRelation=function(t,a){return e.bulkAddRelation({ids:t,relationship:a}).then(function(e){_.forEach(e,function(e){if("Failure"==e.status.type)throw e.status}),o(e)})},r.relateBulkCI=function(t,a,n){return e.relateBulkCI(t,a,n)},r.removeRelation=function(n,i){return e.removeRelation(n,i).then(function(e){_.forEach(i,function(e){var t;t=e.type===EntityVO.TYPE_OUTAGE?{displayId:e.id}:e.type===EntityVO.TYPE_ASSET?e.isParent?{realObject:{instanceId:e.parentId}}:{realObject:{instanceId:e.id}}:{id:e.id};var a=_.findIndex(r.cache[n.parentId],t);r.unlinked=r.cache[n.parentId]&&a>-1?r.cache[n.parentId].splice(a,1):[]}),e&&e.data&&e.data.additionalInformation&&e.data.additionalInformation.needsReconciliation&&t.error({text:a("i18n")("asset.actionBlade.assetAction.warning.reconciliation"),clear:!1})})},r.deleteActivity=function(t){return e.deleteActivity(t)},r.updateTaskSequence=function(t){return e.updateTaskSequence(t)},r.updateReleasePlanItemsSequence=function(t){return e.updateReleasePlanItemsSequence(t)},r.getRelationsByTag=function(t,a,n){var i=e.getRelations(t,a,{tags:n}).then(function(e){return e});return i},r.deleteCacheById=function(e){r.cache[e]&&delete r.cache[e]},r}])}(),function(){angular.module("myitsmApp").service("relationService",["$resource","$http","systemAlertService","$q",function(e,t,a,n){var i=e("/smartit/rest/relations/:type/:id",{},{getRelations:{method:"GET",isArray:!0},bulkAddRelation:{url:"/smartit/rest/bulkupdate/relations/bulk",method:"POST",transformResponse:function(e){return{results:angular.fromJson(e)}}},bulkAddRelationHKM:{url:"/smartit/rest/knowledge/pin",method:"POST",transformResponse:function(e){return{results:angular.fromJson(e)}}},deleteActivity:{url:"/smartit/rest/activity/:id",method:"DELETE",isArray:!1},relateBulkCI:{url:"/smartit/rest/:type/relateBulkCI/:id",method:"POST",isArray:!1},updateTaskSequence:{url:"/smartit/rest/task/updatesequence",method:"POST",isArray:!0},updateReleasePlanItemsSequence:{url:"/smartit/rest/release/updatesequence",method:"POST",isArray:!0}});this.getRelations=function(e,t,a){return a=a||{},a.id=e,a.type=t,i.getRelations(a).$promise.then(function(e){var t=e[0].items[0]&&e[0].items[0].objects;if(t)return _.map(t,function(e){return(new RelationItemVO).build(e)})})},this.bulkAddRelation=function(e){return i.bulkAddRelation(e).$promise.then(function(e){return _.forEach(e.results,function(t,a){e.results[a]={relations:_.map(t.objects,function(e){return(new RelationItemVO).build(e)}),status:t.statusInfoList[0]}})})},this.bulkAddRelationHKM=function(e){return i.bulkAddRelationHKM(e).$promise.then(function(e){return e})},this.relateBulkCI=function(e,t,a){var n={id:e.id,type:e.type},o={relationshipType:"",tag:"",type:""},r={relationship:{},searchCriteria:a};return n.type===EntityVO.TYPE_CHANGE&&(n.source="cisearchv2"),_.forEach(o,function(e,a){r.relationship[a]=t[a]}),i.relateBulkCI(n,r).$promise},this.removeRelation=function(e,i){return t({method:"DELETE",headers:{"Content-Type":"application/json"},url:"/smartit/rest/relations/"+e.parentType+"/"+e.parentId,data:i})["catch"](function(e){return a.error({text:e.data.errorCode?$filter("i18n")("error.unknown"):e.data.error||e.data.results.error,clear:!1}),n.reject(err)})},this.deleteActivity=function(e){var t={id:e.id};return i.deleteActivity(t).$promise},this.getRelatedTasks=function(e){return _.filter(e,{type:EntityVO.TYPE_TASK})},this.getRelatedLinkedItems=function(e,t,a){return a=(!t||EntityVO.TYPE_CHANGE!==t.type)&&a,_.chain(e).filter({tag:RelationItemVO.TAG_LINKEDITEM}).reject(function(e){var n=!a&&t&&t.type&&_.includes([t.causalCI&&t.causalCI.reconciliationId,t.impactedService&&t.impactedService.reconciliationId],e.id),i=n&&t.type===EntityVO.TYPE_INCIDENT,o=!a&&t&&t.type&&EntityVO.TYPE_CHANGE===t.type&&e.type===EntityVO.TYPE_ASSET,r=!a&&t&&t.type&&t.type===EntityVO.TYPE_WORKORDER&&_.includes([t.impactedService&&t.impactedService.reconciliationId],e.id),s=n&&(t.type===EntityVO.TYPE_PROBLEM||t.type===EntityVO.TYPE_KNOWNERROR),l=n&&t.type===EntityVO.TYPE_RELEASE;return i||o||r||s||l}).value()},this.getRelatedCIs=function(e){return _.filter(e,{type:EntityVO.TYPE_ASSET})},this.updateTaskSequence=function(e){return i.updateTaskSequence(e).$promise.then(function(e){return e[0].items})},this.updateReleasePlanItemsSequence=function(e){return i.updateReleasePlanItemsSequence(e).$promise.then(function(e){return e[0].items})}}])}(),function(){angular.module("layoutConfigModule").directive("layoutRenderer",["events","expressionEventManager","screenConfigurationModel","objectValueMapperService","$timeout",function(e,t,a,n,i){return{restrict:"E",replace:!0,templateUrl:"views/layout-configuration/layout-renderer/layout-renderer.html",scope:{screenLayout:"=",ticket:"=",metadata:"=",editMode:"=",isNew:"="},link:function(o,r){function s(e){return e.panels?e.panels.reduce(function(e,t){return e&&(e=s(t)),e},!0):!h.some(function(t){return t.name===e.name&&(t.fields||[]).length>0})}function l(){o.editMode=!0}function c(){o.editMode=!1}function d(){o.editMode=!1}var u,p=function(){_.isEmpty(n.getFieldByName("customer"))&&(o.ticket.company=n.getExactValueByFieldName("company"),o.ticket.selectedCompany=o.ticket.selectedCompany?o.ticket.selectedCompany:o.ticket.company)},m=function(){_.isEmpty(n.getFieldByName("customer"))&&o.ticket.ticketType===EntityVO.TYPE_WORKORDER&&(o.ticket.company=n.getExactValueByFieldName("customerCompany"),o.ticket.selectedCompany=o.ticket.selectedCompany?o.ticket.selectedCompany:o.ticket.company)};if(o.isNew){n.changeMode(2,!0,o.ticket),o.$on(e.WIDGET_VALUE_CHANGE,function(a,n){console.log("Widget value changed :"+n.fieldName),t.handleOOTBFieldValueChange(n.fieldName),o.$broadcast(e.REFRESH_FIELD_VALUES)}),o.$on(e.FIELD_VALUE_CHANGE,function(e,a){if(console.log("Field value changed :"+a.name),t.handleFieldChange(a.name),"company"===a.name){var i=n.getFieldByName(a.name);i.isLocationCompany||p()}else"customerCompany"===a.name&&m()}),o.$on(e.WIDGET_VALUE_CHANGE_FROM_WIZARD,function(e,a){console.log("Widget value changed :"+a.fieldName),t.handleOOTBFieldValueChange(a.fieldName)}),o.$on(e.FIELD_VALUE_CHANGE_FROM_WIZARD,function(e,a){console.log("Field value changed :"+a.name),t.handleFieldChange(a.name)});var f,g=0;o.$on(e.FIELD_AREA_ATTACHED,function(e,n){f=f||r.find(".panel-field-area").length,g++,f===g&&(console.log("All custom-area directives are loaded!"),i(function(){n===ScreenConfigurationVO.prototype.CREATE_CHANGE_SCREEN?(a.allFieldsLoaded.basicTab=!0,a.allFieldsLoaded.datesTab&&t.handleTicketLoad()):t.handleTicketLoad(),o.ticket.type===EntityVO.TYPE_INCIDENT&&t.handleOOTBFieldValueChange("customer")}))}),"incident"===o.ticket.type?u=ScreenConfigurationVO.prototype.CREATE_INCIDENT_SCREEN:"workorder"===o.ticket.type?u=ScreenConfigurationVO.prototype.CREATE_WORK_ORDER_SCREEN:"change"===o.ticket.type?u=ScreenConfigurationVO.prototype.CREATE_CHANGE_SCREEN:"task"===o.ticket.type&&(u=ScreenConfigurationVO.prototype.CREATE_TASK_SCREEN)}else u=a.getScreenNameByTicketType(o.ticket.type);var h=a.screensCacheByName[u]?a.screensCacheByName[u].panels:[];o.screenLayout.panels.forEach(function(e){e.emptyPanel=s(e)}),o.panelChildrenCount=function(e){var t=_.find(h,{name:e});return t&&t.fields?t.fields.length:0},o.$on(e.TOGGLE_EDIT_MODE,l),o.$on(e.AFTER_SAVED_CHANGES,c),o.$on(e.DISCARD_CHANGES,d)}}}])}(),function(){angular.module("layoutConfigModule").controller("StatusBarController",["$scope","events","objectValueMapperService","fieldValidationModel","ticketModel","$rootScope","$modal","screenConfigurationModel",function(e,t,a,n,i,o,r,s){
function l(){if(v.status=_.cloneDeep(_.find(e.metadata.statuses,{name:e.ticket.status.value})),m=_.cloneDeep(v.status),_.isEmpty(v.status))v.statusReason=null;else if(v.statusReason=_.find(v.status.statusReasons,{name:e.ticket.status.reason}),e.ticket.status.reason&&!v.statusReason){var t,n;_.forEach(E,function(e){if(t=_.findLast(e.fields,{name:"status"}))return!1}),n=_.find(t.members,{name:O.name}),v.statusReason=_.find(n.options,{name:e.ticket.status.reason})}f=_.cloneDeep(v.statusReason),v.resolutionNote=e.ticket.resolution?e.ticket.resolution:"",v.resolutionNoteLength=v.resolutionNote?v.resolutionNote.length:0,v.resolutionNoteLength>e.defaultResolutionNoteLength&&(e.displayTruncatedText=!0),e.ticket.type!==EntityVO.TYPE_WORKORDER&&e.ticket.type!==EntityVO.TYPE_INCIDENT||!e.isDraft&&!e.isNew?v.status&&v.status.invalidStatusTransitions&&v.status.invalidStatusTransitions.length?e.availableStatuses=_.filter(e.metadata.statuses,function(e){return e.name&&!~_.indexOf(v.status.invalidStatusTransitions,e.name)}):v.status&&v.status.validKnowledgeTransitions?v.status.validKnowledgeTransitions.length?e.availableStatuses=_.filter(e.metadata.statuses,function(e){return _.find(v.status.validKnowledgeTransitions,{validStatus:e.name})}):e.availableStatuses=[]:e.ticket.type!==EntityVO.TYPE_CHANGE&&(e.ticket.type!==EntityVO.TYPE_PROBLEM&&e.ticket.type!==EntityVO.TYPE_KNOWNERROR||e.isDraft)?e.ticket.type!==EntityVO.TYPE_RELEASE||e.isDraft?e.availableStatuses=e.metadata.statuses:(e.availableMilestoneStatuses=_.filter(e.metadata.milestones,function(e){return _.findIndex(g,{milestone:e.name})!==-1}),e.changeMileStone(v.milestone,"release")):i.getAvailableStatuses(e.ticket.id,e.ticket.type).then(function(t){e.availableStatuses=_.filter(e.metadata.statuses,function(e){return t.indexOf(e.name)!==-1})}):e.availableStatuses=_.reject(e.metadata.statuses,{isValidForCreate:!1}),T.value=v.status&&v.status.name,O.value=v.statusReason&&v.statusReason.name,A.value=v.resolutionNote;var o=[T,O,A];e.ticket.type===EntityVO.TYPE_WORKORDER&&o.pop(),a.addFields(o),e.selected=v,T.value=v.status&&v.status.name,O.value=v.statusReason?v.statusReason.name:"",A.value=v.resolutionNote||"",v.status&&"Pending"===v.status.name&&v.status.statusReasons&&_.remove(v.status.statusReasons,function(e){return"Pending Original Incident"===e.name})}function c(){e.editMode=!0}function d(){e.editMode=!1,m=_.cloneDeep(v.status),f=_.cloneDeep(v.statusReason)}function u(){e.editMode=!1,v.status=_.cloneDeep(m),v.statusReason=_.cloneDeep(f),l()}function p(){var t=e.ticket.scheduledStartDate.valueOf(),a=e.ticket.scheduledEndDate.valueOf();e.fixScheduledDates=e.ticket&&"change"===e.ticket.type&&"Scheduled For Review"===v.status.name&&(t<=e.ticket.earliestStartDate||a<=e.ticket.earliestStartDate)}var m,f,g,h,y=s.getScreenNameByTicketType(e.ticket.type),E=s.screensCacheByName[y]?s.screensCacheByName[y].panels:[],v={status:null,statusReason:null,resolutionNote:null},T=(new FieldVO).build({name:e.ticket.type===EntityVO.TYPE_TASK?"taskStatus":"status",type:"characterField",dataType:"text",ootb:!0,editable:!0,readOnly:!1});if(e.data)T=angular.copy(e.data);else{var S=_.find(E,{name:"statusBarPanel"});if(S&&S.fields){var C=_.find(S.fields,{name:"status"});C&&(T=angular.copy(C),e.ticket.type===EntityVO.TYPE_TASK&&(T.name="taskStatus"))}}e.statusField=T,e.defaultResolutionNoteLength=250,e.displayTruncatedText=!1,e.isStatusDisabled=function(){return e.ticket.accessMappings.allEditAllowed===!1||(e.ticket.type===EntityVO.TYPE_TASK?"read"===e.ticket.accessMappings.fieldMappings.taskStatus:"read"===e.ticket.accessMappings.fieldMappings.status)},e.isStatusReasonDisabled=function(){return e.ticket.accessMappings.allEditAllowed===!1||(e.ticket.type===EntityVO.TYPE_TASK?"read"===e.ticket.accessMappings.fieldMappings.taskStatusReason:"read"===e.ticket.accessMappings.fieldMappings.statusReason)},e.isResolutionDisabled=function(){return"read"===e.ticket.accessMappings.fieldMappings.statusReason},e.isWindowRTL=function(){return window.isRtl};var O=(new FieldVO).build({name:e.ticket.type===EntityVO.TYPE_TASK?"taskStatusReason":"statusReason",type:"characterField",dataType:"text",ootb:!0}),A=(new FieldVO).build({name:"resolution",type:"characterField",dataType:"text",ootb:!0});e.statusReasonField=O,e.resolutionNoteField=A,l(),e.loadMore=function(){e.selected.expanded=!!_.isUndefined(e.selected.expanded)||!e.selected.expanded},e.$watch("statusField.setValueFlag",function(t){var a;"#$#"!==t&&(t&&(a=_.find(e.metadata.statuses,{name:t}),a&&e.changeStatus(a)),e.statusField.setValueFlag="#$#")}),e.$watch("statusReasonField.setValueFlag",function(t){var a;"#$#"!==t&&(t&&(a=_.find(v.status.statusReasons,{name:t}),a&&e.changeStatusReason(a)),e.statusReasonField.setValueFlag="#$#")}),e.$watch("resolutionNoteField.setValueFlag",function(t){"#$#"!==t&&(v.resolutionNote=t,e.changeResolutionNote(),e.resolutionNoteField.setValueFlag="#$#")}),e.changeStatus=function(n){v.status=n,v.statusReason=null,e.ticket.type&&"incident"===e.ticket.type&&null===e.ticket.resolution&&"Closed"!==v.status.name&&"Resolved"!==v.status.name&&(v.resolutionNote="",e.changeResolutionNote());var i=a.getFieldByName(e.ticket.type===EntityVO.TYPE_TASK?"taskStatus":"status");i.value=v.status.name;var o=a.getFieldByName(e.ticket.type===EntityVO.TYPE_TASK?"taskStatusReason":"statusReason");o.value=v.statusReason&&v.statusReason.name;var r=e.ticket.type===EntityVO.TYPE_TASK?"taskStatus":"status";e.$emit(t.WIDGET_VALUE_CHANGE,{fieldName:i.name,memberName:r,fieldValue:i.value}),e.fixScheduledDates="change"===e.ticket.type&&"Scheduled For Review"===v.status.name&&(e.ticket.scheduledStartDate&&e.ticket.scheduledStartDate.valueOf()<=e.ticket.earliestStartDate||e.ticket.scheduledEndDate&&e.ticket.scheduledEndDate.valueOf()<=e.ticket.earliestStartDate),e.ticket.type&&"change"===e.ticket.type&&"Completed"===v.status.name&&(v.statusReason=_.find(n.statusReasons,{name:"Final Review Required"})),v.status&&"Pending"===v.status.name&&v.status.statusReasons&&_.remove(v.status.statusReasons,function(e){return"Pending Original Incident"===e.name})},e.changeStatusReason=function(n){v.statusReason=n;var i=a.getFieldByName(e.ticket.type===EntityVO.TYPE_TASK?"taskStatusReason":"statusReason");i.value=v.statusReason.name;var o=e.ticket.type===EntityVO.TYPE_TASK?"taskStatusReason":"statusReason";e.$emit(t.WIDGET_VALUE_CHANGE,{fieldName:i.name,memberName:o})},e.changeResolutionNote=function(){var n=a.getFieldByName("resolution");n.value=v.resolutionNote,e.$emit(t.WIDGET_VALUE_CHANGE,{fieldName:n.name,memberName:"resolution"})},e.needResolutionNote=function(){return e.ticket.type===EntityVO.TYPE_INCIDENT&&(~[EntityVO.STATUS_CLOSED,EntityVO.STATUS_RESOLVED].indexOf(v.status.name.toLowerCase())||!_.isEmpty(e.ticket.resolution))},e.isFieldRequired=function(t){return"statusReason"===t?e.ticket.type===EntityVO.TYPE_INCIDENT||e.ticket.type===EntityVO.TYPE_CHANGE||e.ticket.type===EntityVO.TYPE_RELEASE||e.ticket.type===EntityVO.TYPE_PROBLEM||e.ticket.type===EntityVO.TYPE_TASK||e.ticket.type===EntityVO.TYPE_KNOWNERROR?n.isFieldRequired(e.ticket.type,e.selected.status.name,e.ticket.timing,t):e.ticket.type!==EntityVO.TYPE_WORKORDER&&e.ticket.type!==EntityVO.TYPE_ACTIVITY:n.isFieldRequired(e.ticket.type,e.ticket.status.value,e.ticket.timing,t)&&!n.isFieldRequired(e.ticket.type,h.status.value,e.ticket.timing,t)},e.switchState=function(t,a){var n,i,o,r={};n="release"!==a?_.findIndex(e.availableStatuses,function(t){return t.index===e.selected.status.index}):_.findIndex(e.availableMilestoneStatuses,function(t){return t.index===e.selected.milestone.index}),n!==-1&&("prev"===t?(i="change"!==a&&"problem"!==a||"Completed"!==e.availableStatuses[n].name?0!==n?parseInt(n-1):0:0!==n?parseInt(n-2):0,r="release"===a?e.availableMilestoneStatuses[i]||{}:e.availableStatuses[i]||{}):"next"===t&&(o=("change"!==a||"Implementation In Progress"!==e.availableStatuses[n].name&&"Planning In Progress"!==e.availableStatuses[n].name)&&"problem"!==a||!e.availableStatuses[n+1]||"Pending"!==e.availableStatuses[n+1].name?n!==e.availableStatuses.length-1?parseInt(n+1):e.availableStatuses.length-1:n!==e.availableStatuses.length-1?parseInt(n+2):e.availableStatuses.length-1,r="release"===a?e.availableMilestoneStatuses[o]||{}:e.availableStatuses[o]||{})),"release"!==a?e.changeStatus(r,a):(v.status={},e.changeMileStone(r,a))},e.clearStatusReason=function(t){var n=a.getFieldByName(e.ticket.type===EntityVO.TYPE_TASK?"taskStatusReason":"statusReason");n.value=""},e.checkStatusSwitcherIsDisabled=function(t,a){var n,i,o,r=["Pending","Cancelled","Closed","Rejected"];if(n="release"!==a?_.findIndex(e.availableStatuses,function(t){return t.index===e.selected.status.index}):_.findIndex(e.availableMilestoneStatuses,function(t){return t.index===e.selected.milestone.index}),n!==-1&&"release"!==a){if("prev"===t)return 0===n||r.indexOf(e.selected.status.name)>=0;if("next"===t)return("change"!==a||"Implementation In Progress"!==e.availableStatuses[n].name&&"Planning In Progress"!==e.availableStatuses[n].name)&&"problem"!==a&&"knownerror"!==a||!e.availableStatuses[n+1]||"Pending"!==e.availableStatuses[n+1].name&&"Cancelled"!==e.availableStatuses[n+1].name?(i=parseInt(n+1),o=e.availableStatuses[i]||{}):(i=parseInt(n+2),o=e.availableStatuses[i]||{}),"Completed"===e.selected.status.name&&"Closed"===o.name?r.indexOf(e.selected.status.name)>=0:r.indexOf(o.name)>=0||r.indexOf(e.selected.status.name)>=0}if(n!==-1&&"release"===a){if("prev"===t)return 0===n;if("next"===t&&(i=parseInt(n+1),void 0===e.availableMilestoneStatuses[i]))return!0}},e.$on(t.TOGGLE_EDIT_MODE,c),e.$on(t.AFTER_SAVED_CHANGES,d),e.$on(t.DISCARD_CHANGES,u);var I=o.$on(t.TICKET_TEMPLATE_UPDATED,function(e,t){t.type!==EntityVO.TYPE_TASK&&(v.status=t.selectedStatus,v.statusReason=t.selectedStatusReason,T.value=t.selectedStatus.name,v.resolutionNote=t.resolution)});e.$watch("ticket.scheduledStartDate",function(){e.ticket&&"change"===e.ticket.type&&"Scheduled For Review"===v.status.name&&e.ticket.scheduledStartDate&&p()}),e.$watch("ticket.scheduledEndDate",function(){e.ticket&&"change"===e.ticket.type&&"Scheduled For Review"===v.status.name&&e.ticket.scheduledEndDate&&p()}),e.editTicketStatus=function(){e.$emit(t.EDIT_STATUS_CLICK)},e.$on("$destroy",function(){I()})}])}(),function(){angular.module("layoutConfigModule").directive("statusBar",["customFieldLinkFunction","screenConfigurationModel",function(e,t){return{restrict:"E",replace:!0,scope:{ticket:"=",metadata:"=",editStatus:"&",isDraft:"=",isEditable:"=?",data:"=?",isCopyChange:"=?",isNew:"=?"},templateUrl:"views/layout-configuration/status-bar-component/status-bar.html",controller:"StatusBarController",link:function(a,n,i){i.isEditable||(a.handleEditableFlagManually=!0),a.$parent.isNew?(a.accessible=!0,a.fieldLengthForSm6=!0,a.fieldLengthForSm4=!0):n.closest(".layout-renderer__child-column")[0]&&(a.fieldLengthForSm6=_.includes(n.closest(".layout-renderer__child-column")[0].className,"col-sm-6"),a.fieldLengthForSm4=_.includes(n.closest(".layout-renderer__child-column")[0].className,"col-sm-4"));var o=t.getScreenNameByTicketType(a.ticket.type),r=t.screensCacheByName[o]?t.screensCacheByName[o].panels:[],s=_.find(r,{name:"statusBarPanel"});if(s&&s.fields){var l=_.find(s.fields,{name:"status"});a.accessible=l.isAccessible(),a.handleEditableFlagManually&&(a.isEditable=l.isEditable(a.ticket.accessMappings))}e(a)}}}])}(),function(){angular.module("myitsmApp").directive("titleBar",["events","chatModel","ticketModel","systemAlertService","ticketActionService","relationService","$filter","relationModel","objectValueMapperService","userModel","screenConfigurationModel","$modal","roles","permissionModel","metadataModel","configurationModel","$timeout",function(e,t,a,n,i,o,r,s,l,c,d,u,p,m,f,g,h){return{restrict:"EA",scope:{state:"=",isDraft:"=",ticket:"=",isFullVersion:"=",screenLayout:"=",metadata:"=",update:"&",moreDropDownOptions:"="},templateUrl:"views/layout-configuration/title-bar-component/title-bar.html",link:function(a){function n(){a.editMode=!0}function p(e,t){a.editMode=!1,a.ticket=t}function y(){a.editMode=!1,a.summaryField.value=_.cloneDeep(a.ticket.summary)}function E(){a.editMode||a.editButtonClickHandler()}function v(){var e;return a.ticket.type===EntityVO.TYPE_INCIDENT?e=r("i18n")("search.preview.viewFullIncident"):a.ticket.type===EntityVO.TYPE_WORKORDER?e=r("i18n")("search.preview.viewFullWorkorder"):a.ticket.type===EntityVO.TYPE_CHANGE?e=r("i18n")("search.preview.viewFullChange"):a.ticket.type===EntityVO.TYPE_TASK&&(e=r("i18n")("search.preview.viewFullTask")),e}var T,S,C,O,A={};a.editMode=!1,a.chatModel=t,a.hideMoreActionsButton=!0,a.needsAttentionFlag={value:"Yes"===a.ticket.needsAttention?"Yes":"No",visibility:!1},f.getMetadataByType(EntityVO.TYPE_GLOBAL).then(function(e){a.needsAttentionFlag.visibility=g.showNeedsAttentionFlag}),a.metadata&&a.metadata.configurationParameters&&(a.displayEncodedCharacters="true"===a.metadata.configurationParameters.displayEncodedCharacters),a.isFullVersion||(a.fullDetailsText=v()),a.isSummaryEditable=a.ticket.accessMappings&&a.ticket.accessMappings.fieldMappings&&a.ticket.accessMappings.fieldMappings.summary&&"write"===a.ticket.accessMappings.fieldMappings.summary,a.ticket.summary&&(a.ticket.summary=a.ticket.summary.replace("&#92;","\\")),a.iconClass=function(){return O=g.showSecurityTickets&&"Security Incident"===a.ticket.serviceType?"icon-security-incident":"icon-"+a.ticket.type,a.isAutomatic&&(O+="-auto"),a.ticket.brokerVendorName&&(O+="-brokered"),O},_.forEach(a.screenLayout.panels,function(e){"titleSection"!==e.name&&"titleBarSection"!==e.name||(a.titleBarLayout=e.panels[0],a.titleBarPanelId=a.screenLayout.name+"."+a.titleBarLayout.name)}),T=s.cache,A.tasks=o.getRelatedTasks(T[a.ticket.id]).length,A.linkedItems=o.getRelatedLinkedItems(T[a.ticket.id],a.ticket,!1).length,A.CIs=o.getRelatedCIs(T[a.ticket.id]).length,a.ticketActions={assignToMe:function(t){var n={originalEvent:t,assignToMe:!0,saveSelection:!0,role:"assignee"};a.$emit(e.SHOW_ASSIGN_TICKET_BLADE,n)},share:function(){i.share(a.ticket)},follow:function(){return i.follow(a.ticket)},unfollow:function(){return i.unfollow(a.ticket)},showPrintDialog:function(e){i.showPrintDialog(e,a.ticket,A,a.ticket.feed,a.metadata,a.screenLayout)},confirmAction:function(t){i.confirmAction(a.ticket,t,a).then(function(){a.$emit(e.TICKET_PROFILE_RESEND_EVENT,{eventName:e.REFRESH_ACTIVITY_FEED}),i.applyAction(a.ticket,t,a)})},applyAction:function(e){i.applyAction(a.ticket,e,a)},copyChangeAllowed:function(){return!!m.hasPermissionForTicket(EntityVO.TYPE_CHANGE)},toggleNeedAttentionFlag:function(){a.$emit(e.SELECT_ACTIVITY_TAB),h(function(){a.$emit(e.TICKET_PROFILE_RESEND_EVENT,{eventName:e.ADD_FLAG_NOTE,data:{flag:!("Yes"===a.needsAttentionFlag.value),isNeedAttentionFlag:!0}})},0)}},a.isAssignToMeEnabled=function(){var e=l.getValueByFieldName("assignee");return e&&c.userId!==e.id},a.editButtonClickHandler=function(){a.$parent.handleExternalEditClick()},a.summaryField=(new FieldVO).build({name:"summary",value:a.ticket.summary,type:"characterField",dataType:"text",maxLength:100,ootb:!0,required:!0}),"incident"===a.ticket.type?S=d.getPanelById("incidentViewScreen.summaryPanel"):"change"===a.ticket.type?S=d.getPanelById("changeViewScreen.summaryPanel"):"task"===a.ticket.type?S=d.getPanelById("taskViewScreen.summaryPanel"):"workorder"===a.ticket.type&&(S=d.getPanelById("workOrderViewScreen.summaryPanel")),S&&(C=_.find(S.fields,{name:"summary"}),C&&C.maxLength&&(a.summaryField.maxLength=C.maxLength)),l.addFields([a.summaryField]),a.onSummaryChange=function(){a.$emit(e.WIDGET_VALUE_CHANGE,{fieldName:a.summaryField.name,memberName:a.summaryField.name})},a.toggleFollowingFlag=function(){var e=a.ticket.following?a.ticketActions.unfollow:a.ticketActions.follow;e(a.ticket).then(function(){a.ticket.following=!a.ticket.following})},a.refreshTicket=function(){a.$emit(e.REFRESH_TICKET_FROM_TITLE_BAR)},a.copyChangeTicket=function(){var e=u.open({templateUrl:"views/ticket/copy-change.html",controller:"CopyChangeController",windowClass:"action-blade",backdrop:"custom",size:"md",resolve:{ticket:function(){return a.ticket}}});e.result.then(function(e){})},a.$on(e.TOGGLE_EDIT_MODE,n),a.$on(e.AFTER_SAVED_CHANGES,p),a.$on(e.DISCARD_CHANGES,y),a.$on(e.OPEN_EDIT_MODE,E)}}}])}(),function(){angular.module("layoutConfigModule").directive("editableLayoutSection",function(){return{restrict:"E",replace:!0,transclude:!0,scope:{editModeAllowed:"=",ticket:"=",metadata:"=",editButtonLabel:"=",isDraft:"=",isFullVersion:"=",hasRelatedCis:"=?",fromCopyChange:"=?"},templateUrl:"views/layout-configuration/layout-section/editable-layout-section.html",controller:["$element","$transclude","$scope","$timeout","events","ticketModel","expressionEventManager","objectValueMapperService","createTicketModel","$q","i18nService","systemAlertService","$state","feedModel",function(e,t,a,n,i,o,r,s,l,c,d,u,p,m){function f(){e.find('input[type="text"]').first().focus()}function g(){function e(e){return e.companyName=e.companyName||angular.noop,e.name=e.name||"",e.regionName=e.regionName||"",e.siteGroupName=e.siteGroupName||"",e.siteId=e.siteId||null,e.address?(e.address.address=e.address.address||"",e.address.city=e.address.city||"",e.address.country=e.address.country||"",e.address.state=e.address.state||"",e.address.street=e.address.street||"",e.address.zip=e.address.zip||""):e.address={address:"",city:"",country:"",state:"",street:"",zip:""},e}var t=s.getFieldList(),n={customFields:{}},i=[],o=[];return _.forEach(t,function(r,c){if(r.type===FieldVO.prototype.DESCRIPTION)h(G[r.name],r.value.desc)||r.value.desc===G[r.name]||(n.desc=r.value.desc);else if(r.type===FieldVO.prototype.PERSON_SITE){var p=r.value.site;p||(p={name:"",id:null,attributeMap:{siteAddress:null,regionName:r.value.region?r.value.region.name:null,siteGroupName:r.value.siteGroup?r.value.siteGroup.name:null,companyName:r.value.company&&r.value.company.name||null}});var m=G.customer.site;if(m&&(m.name!==p.name||m.siteGroup!==p.attributeMap.siteGroupName||m.region!==p.attributeMap.regionName||a.isDraft)){var f={},g=void 0;p.attributeMap.siteAddress&&(f.address=p.attributeMap.siteAddress.address||"",f.city=p.attributeMap.siteAddress.city||"",f.country=p.attributeMap.siteAddress.country||"",f.state=p.attributeMap.siteAddress.state||"",f.street=p.attributeMap.siteAddress.street||"",f.zip=p.attributeMap.siteAddress.zip||""),g={address:f,companyName:p.attributeMap.companyName,name:p.name,region:p.attributeMap.regionName||"",siteGroup:p.attributeMap.siteGroupName||"",siteId:p.attributeMap.siteId};var T=void 0;n.customer?(T=n.customer,T.site=g):(T=G.customer,T.site=g),n.customer=T}else if(m&&!p){var f={},g=void 0;f.address="",f.city="",f.country="",f.state="",f.street="",f.zip="",g={address:f,companyName:"",name:"",region:r.value.region&&r.value.region.name?r.value.region.name:"",siteGroup:r.value.siteGroup&&r.value.siteGroup.name?r.value.siteGroup.name:"",siteId:null};var T=void 0;n.customer?(T=n.customer,T.site=g):T={loginId:G.customer.loginId,site:g},n.customer=T}}else if(r.type===FieldVO.prototype.PERSON_NAME){var S={};if(r.isAssigneeWidget()){var C=r.name+"SupportGroups",O=_.find(t,{name:C});if(r.value&&r.value.loginId!==G[r.primaryKey].loginId||O&&O.value&&O.value.supportGroups!==G[O.primaryKey].name)if(a.isDraft)n[r.primaryKey]=r.value;else{var A=v(r);_.extend(n,A)}}else{var I="requestedFor"===r.name?"customer":r.name;if(!r.value&&G[I])return void(n[I]={isDeleted:!0});if((r.value.loginId&&r.value.loginId!==G[I].loginId||!_.isEqual(r.value,G[I]))&&((r.isCustomerWidget()||r.isContactWidget())&&(S=angular.copy(r.value)),n[I]&&n[I].site?S.site=n[I]:S&&delete S.site,n[I]=S),"requestedFor"===r.name&&r.value.loginId&&r.value.loginId!==G[I].loginId){var b=s.getExactValueByFieldName("company");b?n.locationCompany={name:b}:n.locationCompany={name:r.value&&r.value.company.name}}}}else if(r.type===FieldVO.prototype.TICKET_LOCATION){var k=s.getWidgetMembers(r.name),D={},R={siteId:"siteId",siteRegion:"region",siteName:"name",siteGroup:"siteGroup"};_.each(k,function(e){var t=a.metadata.ootbMapping[e];t=_.last(t);var n=_.get(G,t),i=R[e];n!==r.value[i]&&(D[i]=r.value[i])}),_.isEmpty(D)||(D.siteId=r.value.siteId,n.location=D)}else if(r.type===FieldVO.prototype.POI_LOCATION)n.poiId=r.value?r.value.poiId:"";else if(r.type===FieldVO.prototype.CATEGORY_COMPANY||"locationCompany"===r.name){var P=G.locationCompany&&G.locationCompany.name;h(P,r.value)||r.value===P||(n.locationCompany=r.value?{name:r.value}:"")}else if(r.type===FieldVO.prototype.AFFECTED_ASSET){if(null===r.value.ci||G[r.name]&&r.value.ci.reconciliationId===G[r.name].reconciliationId)return;"causalCI"===r.name&&(void 0===r.value.ci.name||null===r.value.ci.name||""===r.value.ci.name?n.causalCI="":a.isDraft?n.causalCI=r.value.ci:n.causalCI=r.value.ci.name,void 0===r.value.ci.reconciliationId||null===r.value.ci.reconciliationId||""===r.value.ci.reconciliationId?n.causalCIreconId="":n.causalCIreconId=r.value.ci.reconciliationId,r.value.isCheckedValue&&void 0!==r.value.ci.name&&null!==r.value.ci.name&&""!==r.value.ci.name&&G[r.name]&&r.value.ci.reconciliationId!==G[r.name].reconciliationId?(r.value.isCheckedValue=!0,r.value.oldDataValue=r.value.ci):r.value.oldDataValue&&(n.previousCausalCI=r.value.oldDataValue.name,n.previousCausalCIreconId=r.value.oldDataValue.reconciliationId)),"impactedService"===r.name&&(void 0===r.value.ci.name||null===r.value.ci.name||""===r.value.ci.name?n.impactedService="":a.isDraft?n.impactedService=r.value.ci:n.impactedService=r.value.ci.name,void 0===r.value.ci.reconciliationId||null===r.value.ci.reconciliationId||""===r.value.ci.reconciliationId?n.impactedServiceReconId="":n.impactedServiceReconId=r.value.ci.reconciliationId,r.value.isCheckedValue?(r.value.isCheckedValue=!0,r.value.oldDataValue=r.value.ci):r.value.oldDataValue&&(n.previousImpactedService=r.value.oldDataValue.name,n.previousImpactedServiceReconId=r.value.oldDataValue.reconciliationId))}else if(r.type===FieldVO.prototype.CATEGORY_FIELD&&r.value){var w={},L=r.getCategorizationPropertyName();_.forEach(r.value.listOfTiers,function(e){w[e.name]=e.selectedValue});var N,M={name:L,tiers:w},V=!1;_.forEach(G.allCategories,function(e){e.name===L&&(N=e)}),_.forEach(N.listOfTiers,function(e){_.forEach(r.value.listOfTiers,function(t){t.name===e.name&&e.selectedValue!==t.selectedValue&&(V=!0)})}),V&&("operational"===L||"product"===L?(i.push(M),n.categorizations=i):(o.push(M),n.resCategorizations=o))}else if(r.type===FieldVO.prototype.PRIORITY){if(r.value.impact.name!==G.impact||r.value.urgency.name!==G.urgency||r.value.priority.name!==G.priority){var F={impact:r.value.impact.name,urgency:r.value.urgency.name,priority:r.value.priority.name};angular.extend(n,F)}}else if(r.isSupportGroupWidget()){if(!G[r.primaryKey]&&r.value||r.value&&G[r.primaryKey]&&(r.value.assignedToGroup||r.value.id!==G[r.primaryKey].id))if(a.isDraft)n[r.primaryKey]=r.value;else{var x,$={};"supportGroup"===r.primaryKey?($={group:r.value.name,groupId:r.value.id},!n.company&&r.value&&r.value.company&&r.value.company.name&&($.company=r.value.company.name),!n.organization&&r.value&&r.value.organization&&($.organization=r.value.organization),r.value&&r.value.cognitiveFlag&&($.cognitiveFlag=r.value.cognitiveFlag)):"managerGroup"===r.primaryKey?($={managerGroup:r.value.name,managerGroupId:r.value.id},!n.managerCompany&&r.value&&r.value.company&&r.value.company.name&&($.managerCompany=r.value.company.name),!n.managerOrganization&&r.value&&r.value.organization&&($.managerOrganization=r.value.organization)):"coordinatorGroup"===r.primaryKey&&($={coordinatorGroup:r.value.name,coordinatorGroupId:r.value.id},!n.coordinatorCompany&&r.value&&r.value.company&&r.value.company.name&&($.coordinatorCompany=r.value.company.name),!n.coordinatorOrganization&&r.value&&r.value.organization&&($.coordinatorOrganization=r.value.organization)),_.extend(n,$),"assigneeSupportGroups"===r.name?x=t.assignee:"changeCoordinatorSupportGroups"===r.name?x=t.assigneeName:"changeManagerSupportGroups"!==r.name&&"requestManagerSupportGroups"!==r.name||(x=t.managerName),x&&""!==x.value&&"widget"!==x.dataType&&_.extend(n,v(x))}}else if(r.type===FieldVO.prototype.TICKET_RISK){if(r.name===FieldVO.prototype.WIDET_NAMES.changeRisk){var B=_.last(r.members).name;if("manual"!==r.value.mode||r.value[B]===G[B]&&r.riskIsUserSpecified===G.riskIsUserSpecified||(n[B]=r.value[B]),r.modeCheck===!0&&"auto"===r.value.mode){var Y={questionResponses:r.value.questionResponses,company:a.ticket.company,id:a.ticket.id};a.fromCopyChange?n.questionResponses=Y.questionResponses:z=l.saveRiskResponse.bind(l,Y,!0)}}}else if("status"===c||"statusReason"===c||"taskStatus"===c||"taskStatusReason"===c){if(null===r.value||"object"!=typeof r.value||!_.isEmpty(r.value)){var q=a.metadata.ootbMapping[r.name];q=_.last(q);var H=_.get(G,q);if(h(H,r.value)||H===r.value)H===r.value&&(a.isDraft?_.set(n,q,r.value):"status"!==c&&"taskStatus"!==c||!U.status?"statusReason"!==c&&"taskStatusReason"!==c||!U.statusReason?"statusReason"===c&&n.status&&(n.statusReason=r.value):delete U.statusReason:delete U.status);else if(a.isDraft)_.set(n,q,r.value);else if(a.ticket.type===EntityVO.TYPE_CHANGE&&"status"===c){var K,j=s.getValueByFieldName("changeCoordinator"),W=s.getValueByFieldName("changeManager"),Q=s.getValueByFieldName("assigneeName"),J=s.getValueByFieldName("managerName");if("Draft"!==r.value){if(!(!_.isEmpty(j)&&j.loginId||Q||"Latent"===a.ticket.timing&&a.ticket.enableAssginmentEngineIntegration))return K=[d.getLocalizedString("change.detail.changeCoordinator")],u.error({text:d.getLocalizedStringwithParams("ticket.notification.draft.missingField",K),clear:!1}),n=null,!1;if(n[c]=r.value,"Request For Authorization"!==r.value&&"Request For Change"!==r.value&&"Planning In Progress"!==r.value&&"Rejected"!==r.value&&"Pending"!==r.value&&"Cancelled"!==r.value){if(!(!_.isEmpty(W)&&W.loginId||J||"Latent"===a.ticket.timing&&a.ticket.enableAssginmentEngineIntegration))return K=[d.getLocalizedString("change.detail.changeManager")],u.error({text:d.getLocalizedStringwithParams("ticket.notification.draft.missingField",K),clear:!1}),n=null,!1;n[c]=r.value}}else n[c]=r.value}else"taskStatus"===c?n.status=r.value:"taskStatusReason"===c?n.statusReason=r.value:n[c]=r.value||""}}else if(r.dataType===FieldVO.prototype.DATA_TYPE_WIDGET){if(c===FieldVO.prototype.IMPACTED_AREAS)for(var Z in r.value)r.value.hasOwnProperty(Z)&&(n[Z]=r.value[Z]);else for(var X in r.value)if(r.value.hasOwnProperty(X)){var ee,te=!1,ae=!1;if(a.metadata.ootbMapping[X]){var ne=_.last(a.metadata.ootbMapping[X]);if(ee=_.get(G,ne),r.value[X]instanceof Date||ee instanceof Date?(ae=!0,Date.parse(ee)!==Date.parse(r.value[X])&&(te=!0)):ee!==r.value[X]&&(te=!0),te){var ie=_.head(ne.split("."));n[ie]||(n[ie]=_.cloneDeep(G[ie]),t.site&&"widget"===t.site.dataType&&G[ie]&&G[ie].site&&(n[ie].site=e(n[ie].site))),ae?null===r.value[X]?_.set(n,ne,null):_.set(n,ne,r.value[X].valueOf()):ee!==r.value[X]&&_.set(n,ne,r.value[X]?r.value[X]:"")}}else ee=G[X],ee!==r.value[X]&&(n[c]=r.value[X])}}else if("assignee"===r.name||"assigneeName"===r.name||"managerName"===r.name)(r.value&&("assignee"===r.name||"assigneeName"===r.name)&&r.assigneeLoginId!==G.assignee.loginId||"managerName"===r.name&&r.assigneeLoginId!==G.manager.loginId)&&(a.isDraft?"assignee"===r.name||"assigneeName"===r.name?n.assignee={fullName:r.value,loginId:r.assigneeLoginId}:"managerName"===r.name&&(n.manager={loginId:r.assigneeLoginId,fullName:r.value}):_.extend(n,v(r)));else if(null===r.value||"object"!=typeof r.value||!_.isEmpty(r.value)||r.hasDataTypeValueFormat()&&r.ootb)if(r.ootb){var oe="resolution"===r.name?["resNote"]:a.metadata.ootbMapping[r.name],re=y(r.name,oe,G);h(re,r.value)||re===r.value||E(n,r,G,oe,i,o),"resolution"===r.name&&h(re,r.value)&&re!==r.value&&E(n,r,G,oe,i,o)}else((a.ticket.isDraft||G.customFields[c]!==r.value)&&(G.customFields[c]||r.value)||("integer"===r.dataType||"decimal"===r.dataType||"real"===r.dataType)&&0===r.value||r.isCheckboxField()&&0===r.value)&&(a.ticket.isDraft||!r.isCheckboxField()?n.customFields[c]=r.value:a.ticket.isDraft||!r.isCheckboxField()||G.customFields[c]===r.value||void 0===G.customFields[c]&&r.value===-1||(n.customFields[c]=r.value));else null!==r.value&&"object"==typeof r.value&&(r.ootb||r.dataType!==FieldVO.prototype.DATA_TYPE_DATE&&r.dataType!==FieldVO.prototype.DATA_TYPE_DATE_TIME&&r.dataType!==FieldVO.prototype.DATA_TYPE_TIME||G.customFields[c]!==r.getValue()&&(n.customFields[c]=r.getValue()));if(r.linkedFieldExist()&&!t[r.valueField]){var se=a.metadata.ootbMapping[r.valueField];se&&se.length?_.set(n,_.last(se),r.getLinkedValue()):n.customFields[r.valueField]=r.getLinkedValue()}}),_.forEach(n,function(e,t){e&&e.isDeleted&&(n[t]={})}),n}function h(e,t){if(!(null!==e&&void 0!==e&&""!==e||null!==t&&void 0!==t&&""!==t))return!0}function y(e,t,a){var n=angular.copy(a);return e.indexOf("CategoryTier")===-1&&"resProductName"!==e||(n.categorizations.tiers||(n.categorizations.tiers={},n.categorizations.forEach(function(e){_.extend(n.categorizations.tiers,e.tiers)})),n.resCategorizations&&!n.resCategorizations.tiers&&(n.resCategorizations.tiers={},n.resCategorizations.forEach(function(e){_.extend(n.resCategorizations.tiers,e.tiers)}))),_.get(n,_.last(t))}function E(e,t,a,n,i,o){var r,s,l=angular.copy(a);!n||_.last(n).indexOf("categorizations")===-1&&_.last(n).indexOf("resCategorizations")===-1?(null!==t.value||t.hasDataTypeValueFormat()||(t.value=""),t.hasDataTypeValueFormat()&&(t.value=t.value&&t.value.valueOf()),_.set(e,_.last(n),t.value)):(r=_.find(l.allCategories,function(e){return _.findIndex(e.listOfTiers,function(e){return e.name===t.name&&e.selectedValue!==t.value})>-1}),r&&(s=_.find("operational"===r.name||"product"===r.name?i:o,{name:r.name}),s||(s={name:r.name,tiers:{}},"operational"===r.name||"product"===r.name?i.push(s):o.push(s)),s.tiers[t.name]=t.value,"operational"===r.name||"product"===r.name?e.categorizations=i:e.resCategorizations=o))}function v(e){var t={};return"assignee"===e.primaryKey||("assignee"===e.name||"assigneeName"===e.name)&&e.assigneeLoginId?e.value.autoAssign?t=e.value:e.value.loginId?t={loginId:e.value.loginId,fullName:e.value.fullName,group:e.value.supportGroup?e.value.supportGroup:"",groupId:e.value.supportGroupId?e.value.supportGroupId:e.value.groupId,company:e.value.company&&e.value.company.name?e.value.company.name:"",organization:e.value.organization?e.value.organization:"",autoAssign:!1}:e.assigneeLoginId&&(t={loginId:e.assigneeLoginId,fullName:e.value}):"manager"===e.primaryKey||"managerName"===e.name&&e.assigneeLoginId?e.value.managerAutoAssign?t=e.value:e.value.loginId?t={managerLoginId:e.value.loginId,managerFullName:e.value.fullName,managerGroup:e.value.supportGroup?e.value.supportGroup:"",managerCompany:e.value.company.name?e.value.company.name:"",managerOrganization:e.value.organization?e.value.organization:"",managerGroupId:e.value.supportGroupId||e.value.groupId?e.value.supportGroupId||e.value.groupId:"",managerAutoAssign:!1}:e.assigneeLoginId&&(t={managerLoginId:e.assigneeLoginId,managerFullName:e.value}):"coordinator"===e.primaryKey&&e.value.coordinatorAutoAssign&&(t={coordinatorLoginId:e.value.loginId,coordinatorFullName:e.value.fullName,coordinatorGroup:e.value.supportGroup?e.value.supportGroup:"",coordinatorCompany:e.value.company.name?e.value.company.name:"",coordinatorOrganization:e.value.organization?e.value.organization:"",coordinatorGroupId:e.value.supportGroupId?e.value.supportGroupId:"",coordinatorAutoAssign:!1}),t}function T(e){if(A(),e&&_.size(e)&&angular.extend(U,e),_.size(U)){console.log("combined changes object:"),console.log(U);var t,n;if(e.addedImpactedAreas&&e.addedImpactedAreas.length&&(t=o.saveImpactedAreas(a.ticket.id,a.ticket.type,e.addedImpactedAreas).then(function(){var e=s.getFieldByName(FieldVO.prototype.IMPACTED_AREAS);e.value.addedImpactedAreas.length=0})),e.removedImpactedAreas&&e.removedImpactedAreas.length&&(n=o.deleteImpactedAreas(a.ticket.id,a.ticket.type,e.removedImpactedAreas).then(function(){
var e=s.getFieldByName(FieldVO.prototype.IMPACTED_AREAS);e.value.removedImpactedAreas.length=0})),a.isDraft)(U.categorizations&&U.categorizations.length||U.resCategorizations&&U.resCategorizations.length)&&_.each(a.ticket.allCategories,function(e){var t=_.find("operational"===e.name||"product"===e.name?U.categorizations:U.resCategorizations,{name:e.name});if(t)_.each(e.listOfTiers,function(e){t.tiers&&t.tiers[e.name]!==e.selectedValue&&(_.has(t.tiers,e.name)?e.selectedValue=t.tiers[e.name]:e.selectedValue&&(t.tiers[e.name]=e.selectedValue))});else{var a={name:e.name,tiers:{}};_.each(e.listOfTiers,function(e){e.selectedValue&&(a.tiers[e.name]=e.selectedValue)}),_.isEmpty(a.tiers)||("operational"===e.name||"product"===e.name?(U.categorizations||(U.categorizations=[]),U.categorizations.push(a)):(U.resCategorizations||(U.resCategorizations=[]),U.resCategorizations.push(a)))}}),void 0!==U.resNote&&(U.resolution=U.resNote),angular.extend(a.ticket,U),C({ticket:a.ticket});else{var i=o.update(a.ticket.id,a.ticket.type,U,!0);c.all({ticket:i,saveImpactedAreas:t,deleteImpactedAreas:n}).then(S,O)}}else console.log("nothing changed or child sections saved themselves, closing edit mode"),C({})}function S(e){500!==e.ticket.status?z().then(function(t){t&&t.additionalInformation&&angular.extend(e.ticket,{questionResponses:t.additionalInformation.questionResponses,riskLevel:t.additionalInformation.riskLevel,riskIsUserSpecified:t.additionalInformation.riskIsUserSpecified}),500!==t.status?C(e):O(e)}):O(e)}function C(e){var t=e.ticket,n=e.risks;if(500!==t.status){if(a.isDraft)F.$broadcast(i.AFTER_SAVED_CHANGES,t);else if(t.attachments&&t.attachments.length){var r=o.getAttachmentsInfo(t.id,t.type);r.then(function(e){t.attachments=e,F.$broadcast(i.AFTER_SAVED_CHANGES,t)})}else F.$broadcast(i.AFTER_SAVED_CHANGES,t);t&&a.$emit(i.AFTER_SAVED_CHANGES,t),_.isObject(n)&&F.$broadcast(i.AFTER_RISK_UPDATE),I()}else O(e)}function O(e){U={};var t=e.ticket||e.saveImpactedAreas||e.deleteImpactedAreas;t&&t.data&&u.error({text:t.data.error||error,clear:!1,displayOnStateChange:!0}),a.dataSaving=!1}function A(){a.dataSaving=!0}function I(){a.dataSaving=!1,b(),a.$parent.$parent.$parent.dirty=!1,P(),a.$emit(i.EDIT_COMPLETE),F.isFullVersion=!F.isFullVersion,F.editModeAllowed=!F.editModeAllowed}function b(){U={},G={}}function k(){a.hasRequiredFields=D()}function D(){return e.find("div.editable-content-section__content .required").length}function R(){return e[0].id}function P(){a.editMode=!1,F.editMode=!1,s.changeMode(0)}function w(e){L("Resolved"==e.fieldValue&&a.ticket.CIRequiredOnResolved?{isRequired:!0,name:"causalCI"}:{isRequired:!1,name:"causalCI"})}function L(e){F.$broadcast(i.SERVICECI_REQUIRED,{isRequired:e.isRequired,name:e.name})}function N(e){a.ticket.riskRulesConfigured&&F.$broadcast(i.RISK_LEVEL_CHANGE,{isRequired:M(e)}),a.ticket.riskRulesConfigured&&a.$emit(i.WORKNOTE_REQUIRED,{isRequired:V(e)})}function M(e){var t=!1;return _.forEach(a.ticket.riskLevelForChangeReason,function(a){a===e.fieldValue&&(t=!0)}),t}function V(e){var t=!1;return _.forEach(a.ticket.riskLevelForNote,function(a){a===e.fieldValue&&(t=!0)}),t}var F,x,G,B=[],U={},z=c.when.bind(null,{status:200});a.editMode=!1,a.isNew=!1,a.dataSaving=!1,a.editableContentInvalid=!1,a.isChildEditProgress=!1,t(function(t,n){F=n,F.handleExternalEditClick=function(){a.onEditButtonClick()};var i=e.find("div.editable-content-section__content");i.append(t);var o=i.find("form");o.length&&_.forEach(o,function(e){B.push(e.name)}),x=t}),a.$on(i.DISABLE_EDITPARENT,function(e,t){a.isChildEditProgress=t}),s.changeMode(0,!0,a.ticket),F.$on(i.PROVIDER_SHOW_LOADING,function(){a.dataSaving=!0}),F.$on(i.PROVIDER_HIDE_LOADING,function(){a.dataSaving=!1}),F.$on(i.EDIT_STATUS_CLICK,function(){a.isFullVersion&&!a.isChildEditProgress&&(a.onEditButtonClick(),n(function(){var t=e.find(".status-bar__section");t.length&&(t[0].focus(),$(".editable-layout-section__content").scrollTop(t[0].offsetTop))},100))}),a.onEditButtonClick=function(){var e=R();b(),F.$broadcast(i.TOGGLE_EDIT_MODE,e),a.$emit(i.TOGGLE_EDIT_MODE,e),a.editMode=!a.editMode,F.editMode=!F.editMode,F.isFullVersion=!F.isFullVersion,F.editModeAllowed=!F.editModeAllowed,G=angular.copy(a.ticket),n(k),n(f,100),s.changeMode(1)},p.params&&p.params.editMode&&a.onEditButtonClick(),a.onErrorClick=function(){var t=e.find(".ng-invalid-required"),a=e.find(".status-bar__error");if(t.length||a.length)return t[0].focus(),!1},a.onSaveClick=function(){var e=g();e&&T(e)},a.$on(i.SAVE_TICKET_DRAFT,a.onSaveClick),a.isSaveValid=function(){var t=e.find(".ng-invalid-required");return!t.length},a.onCancelClick=function(){F.$broadcast(i.DISCARD_CHANGES),a.$emit(i.EDIT_COMPLETE),F.isFullVersion=!F.isFullVersion,F.editModeAllowed=!F.editModeAllowed,P(),r.handleTicketLoad()},a.editableContentIsInvalid=function(){var e=!1;if(B&&B.length)try{_.forEach(B,function(t){var a=_.get(F,t)||F[t];e=e||a.$invalid})}catch(t){}return a.editableContentInvalid=e,e},F.$on(i.RISK_MODE_AUTO,function(e,t){F.$broadcast(i.RISK_LEVEL_CHANGE,{isRequired:!1}),a.$emit(i.WORKNOTE_REQUIRED,{isRequired:!1})}),F.$on(i.WIDGET_VALUE_CHANGE,function(e,t){console.log("Widget value changed :"+t.fieldName),t.isCalledFromSetProp||r.handleOOTBFieldValueChange(t.fieldName,t.action,t.source),"fromTicketLoad"!==t.source&&t.memberName&&(_.isArray(t.memberName)?_.forEach(t.memberName,function(e){r.handleFieldChangeForActions(e)}):r.handleFieldChangeForActions(t.memberName)),t.fieldName===EntityVO.FIELD_CHANGE_RISK&&N({fieldName:t.fieldName,fieldValue:t.fieldValue}),t.fieldName===EntityVO.TYPE_STATUS&&w(t)}),F.$on(i.FIELD_VALUE_CHANGE,function(e,t){console.log("Field value changed :"+t.name),t.isCalledFromSetProp||r.handleFieldChange(t.name),"fromTicketLoad"!==t.source&&r.handleFieldChangeForActions(t.name)}),F.$on(i.CUSTOM_FIELD_VALUE_CHANGE,function(){F.$broadcast(i.REFRESH_FIELD_VALUES)}),a.$on(i.CHANGE_TO_EDIT_MODE,function(e,t){a.onEditButtonClick()});var Y,q=0;F.$on(i.FIELD_AREA_ATTACHED,function(){Y=Y||e.find(".panel-field-area").length,q++,Y===q&&(console.log("All custom-area directives are loaded!"),r.handleTicketLoad())}),a.$on("$destroy",function(){x.remove(),F.$destroy()}),a.isDraft&&n(a.onEditButtonClick,0)}]}})}(),function(){angular.module("myitsmApp").directive("actionAccelerators",[function(){return{restrict:"E",replace:!0,templateUrl:"views/admin/screen-configuration/action-accelerators.html",link:function(e,t,a){t.show(function(){var e=a.inputId,n=angular.element.find("#"+e)[0];t.css({top:n.offsetTop+30,left:n.offsetLeft,width:"88%"})})}}}])}(),function(){angular.module("myitsmApp").directive("expressionBuilder",[function(){return{restrict:"E",scope:{fieldName:"=",expression:"=",propertyName:"=",fieldAcceleratorsList:"=",onExpressionChange:"&",isRequired:"=?"},templateUrl:"views/admin/screen-configuration/expression-builder.html",controller:["$scope","$element","$filter","$timeout","expressionSyntaxTreeBuilder","i18nService","screenConfigurationModel",function(e,t,a,n,i,o,r){function s(t){var a,n,s,l,c,d;e.errorMsg="";try{a=i(t)}catch(u){s={errorMessage1:"Expected expression after",errorMessage2:"Expected :",errorMessage3:"Expected expression",errorMessage4:"Expected exponent (",errorMessage5:"Variable names cannot start with a number (",errorMessage6:"Unexpected period",errorMessage7:"Unclosed quote after",errorMessage8:"Unexpected",errorMessage9:"Unclosed [",errorMessage10:"Unclosed (",errorMessage11:"Expected [",errorMessage12:"Expected ]",errorMessage13:"Expected (",errorMessage14:"Expected )",errorMessage15:"Expected comma"};for(d in s)if(_.includes(u.description,s[d])){n=d;break}s[n]&&(l=u.message.substring(s[n].length,u.message.indexOf("at character"))),c=[l,u.index],n?e.errorMsg=o.getLocalizedStringwithParams("expression.builder."+n,c):e.errorMsg=o.getLocalizedString("expression.builder.standard.error")}e.errorMsg||(e.errorMsg=r.checkExpressionValid(a,e.fieldAcceleratorsList))}var l,c=!1,d=!1,u=0,p=0,m=t.find(".text-input")[0],f={enter:13,escape:27,tab:9,upArrow:38,downArrow:40,space:32},g=[f.enter,f.upArrow,f.downArrow,f.tab];e.accelerators={expression:"",showAcceleratorsList:!1,availableExpressions:e.fieldAcceleratorsList},e.errorMsg="",e.expression&&s(e.expression),e.handleBodyKeyDown=function(t){52!==t.which&&52!==t.keyCode&&"$"!==t.key||(e.accelerators.showAcceleratorsList=!0,u=t.target.selectionStart,c=!0),e.accelerators.showAcceleratorsList&&(g.indexOf(t.keyCode)>=0||t.keyCode===f.space&&d)&&t.preventDefault()},e.handleBodyChange=function(t){var i,o=m.value,r=-1,s=!1;if(!e.accelerators.showAcceleratorsList){for(i=0;i<o.length;i++)"$"!==o[i]||s?" "===o[i]&&s&&(s=!1,r=-1):(s=!0,r=i);r>-1&&(e.accelerators.showAcceleratorsList=!0,u=r,c=!0,(g.indexOf(t.keyCode)>=0||t.keyCode===f.space&&d)&&t.preventDefault())}if(p=t.target.selectionEnd,m.value.length>1&&c&&u>p)return void(e.accelerators.showAcceleratorsList=!1);if(e.accelerators.showAcceleratorsList){if(d&&[f.tab,f.rightArrow,f.space].indexOf(t.keyCode)>=0)return void(d=!1);if(c&&t.keyCode===f.tab){var h=m.value;e.typeAheadListPos===e.acceleratorsList.length-1?e.typeAheadListPos=0:e.typeAheadListPos++;var y=e.acceleratorsList[e.typeAheadListPos]?e.acceleratorsList[e.typeAheadListPos].name:"",E=[h.slice(0,u),y,h.slice(p)].join("");return p=parseInt(u+y.length),l=E.substring(u,p),m.value=E,void n(function(){m.setSelectionRange(u,p),m.selectionStart=u,m.selectionEnd=p})}if(t.ctrlKey===!0||t.altKey===!0||t.keyCode===f.leftArrow||t.keyCode===f.rightArrow)return;if(t.keyCode===f.upArrow)return void(e.typeAheadListPos>0&&e.typeAheadListPos--);if(t.keyCode===f.downArrow)return void(e.typeAheadListPos<e.acceleratorsList.length-1&&e.typeAheadListPos++);if(t.keyCode===f.enter)return e.accelerators.expression=l,void e.insertAcceleratorText();if(t.keyCode===f.escape)return void e.disableTypeAheadMode()}e.expression&&e.expression.length&&c&&(l=m.value.substring(u,p),e.typeAheadListPos=0),c&&(l&&l.length>0&&l!==e.accelerators.expression?(e.acceleratorsList=a("filter")(e.accelerators.availableExpressions,{name:l.substring(1)}),e.acceleratorsList.length>0||0===e.accelerators.expression.length?(e.acceleratorsList.length>0?e.accelerators.showAcceleratorsList=!0:angular.noop(),e.accelerators.expression=l,e.popupLeftPosition=0,e.popupTopPosition=0):0===e.acceleratorsList.length&&e.accelerators.expression.length>1&&e.hideTypeAheadPopup()):"$"!==l&&"$"!==m.value||(e.acceleratorsList=e.accelerators.availableExpressions))},e.handleBodyClick=function(t){t.target.value.length>1&&e.accelerators.showAcceleratorsList&&u>p&&(e.accelerators.showAcceleratorsList=!1)},e.acceleratorMouseover=function(t){e.typeAheadListPos=t},e.insertAcceleratorText=function(t){var a=m.value,n=t||e.acceleratorsList[e.typeAheadListPos],i=n.name,o=a;e.accelerators.expression?0===u?o=i+" ":p<a.length?o=[a.slice(0,u),i+" ",a.slice(p)].join(""):p===a.length&&(o=a.substr(0,a.length-l.length)+i+" "):0===a.length?o=i:p>0?o=[a.slice(0,u),i+" ",a.slice(p)].join(""):o+=i+" ",e.disableTypeAheadMode(),e.expression=o,e.handleExpressionChange()},e.hideTypeAheadPopup=function(){e.accelerators.showAcceleratorsList=!1},e.disableTypeAheadMode=function(){l="",e.accelerators.expression="",e.accelerators.showAcceleratorsList=!1,e.typeAheadListPos=0,e.acceleratorsList=null,c=!1,u=0,p=0},e.acceleratorsHelp=function(){l="$",e.accelerators.expression="",e.accelerators.showAcceleratorsList=!0,e.typeAheadListPos=0,e.acceleratorsList=e.accelerators.availableExpressions,u=e.expression.length},e.handleExpressionChange=function(){s(e.expression),angular.isFunction(e.onExpressionChange)&&e.onExpressionChange()}}]}}])}(),ActionVO.prototype=Object.create(BaseVO.prototype),ActionVO.prototype.constructor=ActionVO,ActionVO.prototype.getProps=function(){return BaseVO.prototype.getProps().concat("resource","actionType","actionName","supportedPlatforms","url","labels","sequenceNo","scope","target","subActions","entryId","templateId","mappings","formName","isSynchronous","expressions","mappedFields","mode","screenId")},ActionVO.prototype.openItem=function(){this.isOpen=!0},ActionVO.prototype.closeItem=function(){this.isOpen=!1,delete this.isOpen},ActionVO.prototype.deleteItem=function(){this["delete"]=!0},ActionVO.prototype.isSupported=function(e){for(var t=0;t<this.supportedPlatforms.length;t++)if(this.supportedPlatforms[t]===e)return!0;return!1},ActionVO.prototype.setResource=function(e){this.resource=e},ActionVO.prototype.setAssetScope=function(){this.scope={assetClass:{ALL:!0}},this.subActions=[]},ActionVO.prototype.removeLabel=function(e){delete this.labels[e]},ActionVO.prototype.getFirstLabel=function(){var e="";for(var t in this.labels)if(this.labels.hasOwnProperty(t)){e=this.labels[t];break}return e},ActionVO.prototype.isLabelEmpty=function(){for(var e in this.labels)if(this.labels.hasOwnProperty(e)&&!this.labels[e])return!0;return!1},ActionVO.prototype.isAssetClassChecked=function(e,t){return"ALL"===e?!!this.scope.assetClass.ALL:t?this.scope.assetClass[e]&&this.scope.assetClass[e].indexOf(t)>-1:this.scope.assetClass[e]&&this.scope.assetClass[e].indexOf("ALL")>-1},ActionVO.prototype.isUserInputChecked=function(e){var t=_.find(this.subActions,{name:e});return!!t},ActionVO.prototype.isAssetFieldChecked=function(e){var t=_.find(this.subActions,{name:"assetUpdate"});return t.fields.indexOf(e)>-1},ActionVO.prototype.setMapping=function(e){var t=function(e,t){t.mappings.push(e)};for(var a in e)t(e[a],this)},ActionVO.prototype.parseItem=function(e){if(this.closeItem(),this.mappings.length>0){this.actionOrder="custom",this.screenId=e.id,delete this.scope,this.mode&&this.mode.value&&(this.mode=this.mode.value);for(var t in this.mappings)this.mappings[t].mappedSource&&!this.mappings[t].mappedSource.value||this["delete"]||(this.mappings[t].mappedFieldValue||(this.mappings[t].mappedFieldValue=""),this.mappings[t].mappedSource&&"output"!==this.mappings[t].type&&(this.mappings[t].type="input-"+this.mappings[t].mappedSource.value)),delete this.mappings[t].mappedField,delete this.mappings[t].mappingOptions,delete this.mappings[t].defaultValue,delete this.mappings[t].mappedSource,delete this.mappings[t].sequence,delete this.mappings[t].mappedFieldName}},ActionVO.prototype.convertToOldVO=function(){delete this.mappings,delete this.isSynchronous,delete this.isExpression,delete this.expressions,delete this.templateId,delete this.entryId,delete this.actionOrder,delete this.mappedFields,delete this.formName,delete this.mode,delete this.screenId},ActionVO.prototype.isV3ProviderAction=function(){return this.resource===EntityVO.TYPE_INCIDENT||this.resource===EntityVO.TYPE_CHANGE||this.resource===EntityVO.TYPE_WORKORDER||this.resource===EntityVO.TYPE_TASK},ApplicationConfigurationVO.prototype=Object.create(BaseVO.prototype),ApplicationConfigurationVO.prototype.constructor=ApplicationConfigurationVO,ApplicationConfigurationVO.prototype.getProps=function(){return["id","name","version","tenantId","screens"]},ApplicationConfigurationVO.prototype.postBuild=function(){this.screens=this.screens.map(function(e){return(new ScreenConfigurationVO).build(e)})},FieldVO.prototype=Object.create(BaseVO.prototype),FieldVO.prototype.constructor=FieldVO,FieldVO.prototype.CHARACTER_FIELD="characterField",FieldVO.prototype.TIME_FIELD="timeField",FieldVO.prototype.DATE_FIELD="dateField",FieldVO.prototype.DATE_TIME_FIELD="dateTimeField",FieldVO.prototype.STATIC_SELECTION_FIELD="staticSelectionField",FieldVO.prototype.SELECTION_FIELD="selectionField",FieldVO.prototype.DYNAMIC_SELECTION_FIELD="dynamicSelectionField",FieldVO.prototype.NUMBER_FIELD="numberField",FieldVO.prototype.EMAIL_FIELD="emailField",FieldVO.prototype.PHONE_FIELD="phoneField",FieldVO.prototype.TICKET_TYPE="ticketType",FieldVO.prototype.GROUP_FIELD="groupField",FieldVO.prototype.PERSON_NAME="personName",FieldVO.prototype.PERSON_SITE="personSite",FieldVO.prototype.AFFECTED_ASSET="affectedAsset",FieldVO.prototype.DESCRIPTION="description",FieldVO.prototype.PRIORITY="priority",FieldVO.prototype.STATUS="status",FieldVO.prototype.STATUS_REASON="statusReason",FieldVO.prototype.TICKET_CLASS="ticketClass",FieldVO.prototype.TICKET_RISK="ticketRisk",FieldVO.prototype.CATEGORY_FIELD="category",FieldVO.prototype.CATEGORY_COMPANY="categoryCompany",FieldVO.prototype.ORGANIZATION_FIELD="organization",FieldVO.prototype.SUPPORT_GROUP_FIELD="supportGroups",FieldVO.prototype.PERSON_LOCATION_MAP="personLocationMap",FieldVO.prototype.TICKET_LOCATION="ticketLocation",FieldVO.prototype.TICKET_TEMPLATE="ticketTemplate",FieldVO.prototype.IMPACTED_AREAS="impactedAreas",FieldVO.prototype.TICKET_DATE="ticketDate",FieldVO.prototype.POI_LOCATION="poiLocation",FieldVO.prototype.TASK_PHASE="taskPhase",FieldVO.prototype.DATA_TYPE_TEXT="text",FieldVO.prototype.DATA_TYPE_TEXTAREA="textarea",FieldVO.prototype.DATA_TYPE_DATE_TIME="datetime",FieldVO.prototype.DATA_TYPE_DATE="date",FieldVO.prototype.DATA_TYPE_TIME="time",FieldVO.prototype.DATA_TYPE_RADIO="radio",FieldVO.prototype.DATA_TYPE_DROPDOWN="dropdown",FieldVO.prototype.DATA_TYPE_CHECKBOX="checkbox",FieldVO.prototype.DATA_TYPE_MENU="menu",FieldVO.prototype.DATA_TYPE_INTEGER="integer",FieldVO.prototype.DATA_TYPE_REAL="real",FieldVO.prototype.DATA_TYPE_DECIMAL="decimal",FieldVO.prototype.DATA_TYPE_GROUP="group",FieldVO.prototype.DATA_TYPE_WIDGET="widget",FieldVO.prototype.WIDET_NAMES={assignee:"assignee",assigneeName:"assigneeName",changeCoordinator:"changeCoordinator",changeManager:"changeManager",requestManager:"requestManager",customer:"customer",requestedFor:"requestedFor",contact:"contact",assigneeSupportGroups:"assigneeSupportGroups",priority:"priority",changeRisk:"changeRisk",changeRiskBadge:"changeRiskBadge",changeClass:"changeClass",changeLocation:"changeLocation",impactedAreas:"impactedAreas",taskPhase:"taskPhase"},FieldVO.prototype.ASSIGNMENT_WIDGETS=[FieldVO.prototype.WIDET_NAMES.assignee,FieldVO.prototype.WIDET_NAMES.assigneeName,FieldVO.prototype.WIDET_NAMES.changeCoordinator,FieldVO.prototype.WIDET_NAMES.changeManager,FieldVO.prototype.WIDET_NAMES.requestManager],FieldVO.prototype.WIDGET_NAMES_TO_TICKET_PROPERTY_MAP={assignee:"assignee",changeCoordinator:"assignee",changeManager:"manager",resolutionOperational:"resolution"},FieldVO.prototype.SPECIAL_HANDLING_SYSTEM_FIELD_NAMES_LIST={submitter:{arFieldName:"Submitter",itsmFieldId:2},submittedBy:{arFieldName:"Submitter",itsmFieldId:2},company:{arFieldName:"Location Company",itsmFieldId:1000000001},type:{arFieldName:"Change Type",itsmFieldId:1000000181},workOrderType:{arFieldName:"Work Order Type",itsmFieldId:1000000181},locationCompany:{arFieldName:"Location Company",itsmFieldId:1000000001},rootRequestName:{arFieldName:"RootRequestName",itsmFieldId:10000001},rootRequestMode:{arFieldName:"RootRequestMode",itsmFieldId:10000003},name:{arFieldName:"TaskName",itsmFieldId:10007e3},rootRequestInstanceId:{arFieldName:"RootRequestInstanceID",itsmFieldId:1e7},taskType:{arFieldName:"TaskType",itsmFieldId:10001980}},FieldVO.prototype.getProps=function(){return BaseVO.prototype.getProps().concat("name","label","type","dataType","required","itsmRequired","requiredCondition","requiredConditionFlag","itsmEditable","editable","readOnly","readOnlyCondition","readOnlyConditionFlag","hide","hideCondition","hideConditionFlag","setValueCondition","setValueConditionFlag","displayOrder","columnIndex","hideLabel","min","max","maxLength","precision","availability","menu","dependency","valueField","isDynamic","fieldUnavailableOn","members","groupMember","rowCount","arFieldName","value","extension","itsmFieldId","ootb","widgetMember","parentId","accessible","options")},FieldVO.prototype.postBuild=function(){this.readOnly=!this.editable,this.requiredConditionFlag=this.requiredCondition?1:0,this.readOnlyConditionFlag=this.readOnlyCondition?1:0,this.hideConditionFlag=this.hideCondition?1:0,this.setValueConditionFlag=!!this.setValueCondition,this.isRequired=this.required&&!this.requiredCondition,this.isReadOnly=this.readOnly&&!this.readOnlyCondition,this.isHidden=this.hide&&!this.hideCondition,this.isWidget()&&(this.members=this.members.map(function(e){return(new FieldVO).build(e)}))},FieldVO.prototype.isSealed=function(){return this.itsmRequired||!this.itsmEditable},FieldVO.prototype.isStaticSelectionField=function(){return this.type===FieldVO.prototype.STATIC_SELECTION_FIELD},FieldVO.prototype.isSelectionField=function(){return this.type===FieldVO.prototype.SELECTION_FIELD},FieldVO.prototype.isDynamicSelectionField=function(){return this.type===FieldVO.prototype.DYNAMIC_SELECTION_FIELD},FieldVO.prototype.isTextField=function(){return this.dataType===FieldVO.prototype.DATA_TYPE_TEXT},FieldVO.prototype.isTextareaField=function(){return this.dataType===FieldVO.prototype.DATA_TYPE_TEXTAREA},FieldVO.prototype.isRadioField=function(){return this.dataType===FieldVO.prototype.DATA_TYPE_RADIO},FieldVO.prototype.isDropdownField=function(){return this.dataType===FieldVO.prototype.DATA_TYPE_DROPDOWN},FieldVO.prototype.isCheckboxField=function(){return this.dataType===FieldVO.prototype.DATA_TYPE_CHECKBOX},FieldVO.prototype.isMenuField=function(){return this.dataType===FieldVO.prototype.DATA_TYPE_MENU},FieldVO.prototype.isNumberField=function(){return this.type===FieldVO.prototype.NUMBER_FIELD},FieldVO.prototype.isEmailField=function(){return this.type===FieldVO.prototype.EMAIL_FIELD},FieldVO.prototype.isPhoneField=function(){return this.type===FieldVO.prototype.PHONE_FIELD},FieldVO.prototype.isTicketType=function(){return this.type===FieldVO.prototype.TICKET_TYPE},FieldVO.prototype.isTicketDate=function(){return this.type===FieldVO.prototype.TICKET_DATE},FieldVO.prototype.isDateField=function(){return this.type===FieldVO.prototype.DATE_FIELD},FieldVO.prototype.isTimeField=function(){return this.type===FieldVO.prototype.TIME_FIELD},FieldVO.prototype.isDateTimeField=function(){return this.type===FieldVO.prototype.DATE_TIME_FIELD},FieldVO.prototype.hasDateDataType=function(){return this.dataType===FieldVO.prototype.DATA_TYPE_DATE},FieldVO.prototype.hasDateTimeDataType=function(){return this.dataType===FieldVO.prototype.DATA_TYPE_DATE_TIME},FieldVO.prototype.hasTimeDataType=function(){return this.dataType===FieldVO.prototype.DATA_TYPE_TIME},FieldVO.prototype.hasDataTypeValueFormat=function(){return[FieldVO.prototype.DATA_TYPE_DATE,FieldVO.prototype.DATA_TYPE_DATE_TIME,FieldVO.prototype.DATA_TYPE_TIME].indexOf(this.dataType)!==-1},FieldVO.prototype.isAvailable=function(){return 0===+this.availability},FieldVO.prototype.linkedFieldExist=function(){return!!this.valueField},FieldVO.prototype.isGroupField=function(){return this.type===FieldVO.prototype.GROUP_FIELD},FieldVO.prototype.isGroupMember=function(){return this.groupMember},FieldVO.prototype.isWidgetMember=function(){return this.widgetMember},FieldVO.prototype.isCategoryField=function(){return this.type===FieldVO.prototype.CATEGORY_FIELD},FieldVO.prototype.isCategoryCompany=function(){return this.type===FieldVO.prototype.CATEGORY_COMPANY},FieldVO.prototype.parseNumberValue=function(e){if(_.isUndefined(e))return null;switch(this.dataType){case FieldVO.prototype.DATA_TYPE_DECIMAL:case FieldVO.prototype.DATA_TYPE_REAL:return parseFloat(e);case FieldVO.prototype.DATA_TYPE_INTEGER:return parseInt(parseInt(e,10).toFixed(0));default:return e}},FieldVO.prototype.getValue=function(){function e(e){return e&&_.isDate(e)?60*(60*e.getHours()+e.getMinutes())*1e3:e}var t,a;return this.hasValue?this.isDateField()?(t=1e3*moment(this.value).unix(),this.hasDateDataType()&&(t-=this.getLocalOffsetInMillisecondsForDate(this.value)),console.log("milliseconds: "+t),t):this.isTimeField()?(t=1e3*moment(this.value).unix(),this.hasTimeDataType()&&(t=e(this.value)),console.log("milliseconds: "+t),t):this.isDateTimeField()?(t=1e3*moment(this.value).unix(),this.hasTimeDataType()?t=e(this.value):this.hasDateDataType()&&(t-=this.getLocalOffsetInMillisecondsForDate(this.value)),console.log("milliseconds: "+t),t):this.isNumberField()?(a=this.parseNumberValue(this.value),isNaN(a)?null:a):this.value:null},FieldVO.prototype.getLinkedValue=function(){return this.valueLinkedField},FieldVO.prototype.setValue=function(e){if(this.isNumberField())this.value=this.parseNumberValue(e);else if((e||0===e)&&this.isDateTimeField()){if(this.hasTimeDataType())this.value=this.prepareDateForTimeInput(e/1e3),console.log("time: "+this.value);else if(this.hasDateTimeDataType())this.value=new Date((+e)),console.log("datetime: "+this.value);else if(this.hasDateDataType()){var t=new Date(e);this.value=new Date(+e+this.getLocalOffsetInMillisecondsForDate(t)),console.log("date: "+this.value)}}else(e||0===e)&&this.isTimeField()?this.hasTimeDataType()&&(this.value=this.prepareDateForTimeInput(e/1e3),console.log("time: "+this.value)):this.value=e;null!==this.value&&void 0!==this.value&&(this.hasValue=!0)},FieldVO.prototype.setLinkedFieldValue=function(e){this.linkedFieldExist()&&(this.valueLinkedField=e)},FieldVO.prototype.clearValue=function(){this.value=null,this.hasValue=!1},FieldVO.prototype.clearLinkedFieldValue=function(){this.valueLinkedField=null},FieldVO.prototype.isValid=function(){return!this.required||angular.isDefined(this.value)&&null!==this.value},FieldVO.prototype.isVisible=function(){if(this.isGroupField())for(var e=0,t=this.members.length;e<t;e++)if(this.members[e].isVisible())return!0;return this.required||this.ootb||this.dynamicField||(this.isCheckboxField()?this.value!=-1&&void 0!==this.value:null!==this.value&&""!==this.value)},FieldVO.prototype.prepareDateForTimeInput=function(e){var t=Math.floor(e/3600),a=Math.floor(e%3600/60),n=new Date;return console.log("hours: "+t+", minutes: "+a),n.setHours(t),n.setMinutes(a),n.setSeconds(0),n.setMilliseconds(0),n},FieldVO.prototype.getLocalOffsetInMilliseconds=function(){return 6e4*(new Date).getTimezoneOffset()},FieldVO.prototype.getLocalOffsetInMillisecondsForDate=function(e){var t=new Date(e);return console.log("for date timezoneoffset ="+t.getTimezoneOffset()),6e4*t.getTimezoneOffset()},FieldVO.prototype.isPersonName=function(){return this.type===FieldVO.prototype.PERSON_NAME},FieldVO.prototype.isAffectedAsset=function(){return this.type===FieldVO.prototype.AFFECTED_ASSET},FieldVO.prototype.isDescription=function(){return this.type===FieldVO.prototype.DESCRIPTION},FieldVO.prototype.isPersonSite=function(){return this.type===FieldVO.prototype.PERSON_SITE},FieldVO.prototype.isPriority=function(){return this.type===FieldVO.prototype.PRIORITY},FieldVO.prototype.isStatus=function(){return this.type===FieldVO.prototype.STATUS},FieldVO.prototype.isTicketRisk=function(){return this.type===FieldVO.prototype.TICKET_RISK},FieldVO.prototype.isPOILocation=function(){return this.type===FieldVO.prototype.POI_LOCATION},FieldVO.prototype.isOrganizationField=function(){return this.type===FieldVO.prototype.ORGANIZATION_FIELD},FieldVO.prototype.isPersonLocationMap=function(){return this.type===FieldVO.prototype.PERSON_LOCATION_MAP},FieldVO.prototype.isSupportGroupField=function(){return this.type===FieldVO.prototype.SUPPORT_GROUP_FIELD},FieldVO.prototype.isTicketTemplate=function(){return this.type===FieldVO.prototype.TICKET_TEMPLATE},FieldVO.prototype.isWidget=function(){return this.dataType===FieldVO.prototype.DATA_TYPE_WIDGET},FieldVO.prototype.markFieldUnavailable=function(){return this.availability=1,this},FieldVO.prototype.markFieldAvailable=function(){return this.availability=0,this},FieldVO.prototype.disableFieldSelection=function(){return this.selectionDisabled=!0,this},FieldVO.prototype.enableFieldForSelection=function(){return this.selectionDisabled=!1,this},FieldVO.prototype.isSelectionDisabled=function(){return this.selectionDisabled},FieldVO.prototype.isEqual=function(e){return this.name===e.name&&this.dataType===e.dataType},FieldVO.prototype.isCustomField=function(){return!this.isWidget()&&!this.ootb},FieldVO.prototype.fillParentInfo=function(e){return e.isWidget()&&(this.widgetMember=!0),this.parentId=e.id,this},FieldVO.prototype.isAccessible=function(){var e;if(this.isWidget()){var t=_.findIndex(this.members,{accessible:!1});e=t===-1}else e=this.accessible;return e},FieldVO.prototype.isEditable=function(e){var t,a=function(t){var a=e.fieldMappings?e.fieldMappings[t]:null;return a?"write"===a:e.detailsEditAllowed};if(this.isWidget()){if(!(this.members.length>0))return e.detailsEditAllowed;_.forEach(this.members,function(e){if(t=a(e.name),!t)return t})}else t=a(this.name);return t},FieldVO.prototype.isPriorityWidget=function(){return this.isWidget()&&this.name===this.WIDET_NAMES.priority},FieldVO.prototype.isChangeClassWidget=function(){return this.isWidget()&&this.name===this.WIDET_NAMES.changeClass},FieldVO.prototype.isAssigneeWidget=function(){return this.isWidget()&&this.ASSIGNMENT_WIDGETS.indexOf(this.name)!==-1},FieldVO.prototype.isCustomerWidget=function(){return this.isWidget()&&(this.name===this.WIDET_NAMES.customer||this.name===this.WIDET_NAMES.requestedFor)},FieldVO.prototype.isRequestedForWidget=function(){return this.isWidget()&&this.name===this.WIDET_NAMES.requestedFor},FieldVO.prototype.isContactWidget=function(){return this.isWidget()&&this.name===this.WIDET_NAMES.contact},FieldVO.prototype.isSupportGroupWidget=function(){return this.isWidget()&&this.type===this.SUPPORT_GROUP_FIELD},FieldVO.prototype.isChangeRiskWidget=function(){return this.isWidget()&&this.name===this.WIDET_NAMES.changeRisk},FieldVO.prototype.isChangeRiskBadgeWidget=function(){return this.isWidget()&&this.name===this.WIDET_NAMES.changeRiskBadge},FieldVO.prototype.isChangeLocation=function(){return this.isWidget()&&this.name===this.WIDET_NAMES.changeLocation},FieldVO.prototype.isImpactedAreas=function(){return this.isWidget()&&this.name===this.WIDET_NAMES.impactedAreas},FieldVO.prototype.isTaskPhaseWidget=function(){return this.isWidget()&&this.name===this.WIDET_NAMES.taskPhase},FieldVO.prototype.getCategorizationPropertyName=function(){return this.WIDGET_NAMES_TO_TICKET_PROPERTY_MAP[this.name]||this.name},FieldVO.prototype.isFieldMemberOfThisGroup=function(e){var t=!1;return this.isGroupField()&&e&&(t=this.members.some(function(t){return t.isEqual(e)})),t},FieldVO.prototype.checkSystemRequiredFlag=function(){var e=this.isSystemRequired(),t=(this.members||[]).some(function(e){return e.isSystemRequired()});return e||t},FieldVO.prototype.isSystemPopulatedField=function(){var e=this.SPECIAL_HANDLING_SYSTEM_FIELD_NAMES_LIST[this.name],t=this;return!!e&&!Object.keys(e).some(function(a){return e[a]!==t[a]})},FieldVO.prototype.isSystemRequired=function(){return this.itsmRequired&&!this.isSystemPopulatedField()&&this.isAvailable()},FieldVO.prototype.isMissingSystemRequiredField=function(){return this.isSystemRequired()&&!this.isSelectionDisabled()},FieldVO.prototype.hasValuesInMembers=function(){var e=!1;return e=this.members.some(function(e){return e.value||0===e.value})},GalileoFieldVO.prototype=Object.create(BaseVO.prototype),GalileoFieldVO.prototype.constructor=GalileoFieldVO,GalileoFieldVO.prototype.getProps=function(){return["id","displayOrder","type","dataType","columnIndex","name","label","required","editable","areaId","hideLabel","min","max","maxLength","precision","menu","dependency","valueField","members","groupMember","extension","rowCount"]},GalileoFieldV2VO.prototype=Object.create(BaseVO.prototype),GalileoFieldV2VO.prototype.constructor=GalileoFieldV2VO,GalileoFieldV2VO.prototype.getProps=function(){return["id","datasource","displayOrder","type","dataType","name","label","itsmFieldId","ootb","screenId","panelId","panelName","members","required","editable","hide","hideLabel","menu","dependency","valueField","groupMember","setValueCondition","requiredCondition","readOnlyCondition","hideCondition","valueFieldName"]},PanelVO.prototype=Object.create(BaseVO.prototype),PanelVO.prototype.constructor=PanelVO,PanelVO.prototype.MAX_FIELDS=Number.MAX_VALUE,PanelVO.prototype.MAX_FIELDS_BY_PANELS={titleBar:5,titleBarPanel:5},PanelVO.prototype.FIELD_RESTRICTIONS_BY_PANEL={titleBar:function(e){return e.isPriorityWidget()||!e.isWidget();
},titleBarPanel:function(e){return e.isPriorityWidget()||e.isChangeRiskBadgeWidget()||e.isChangeClassWidget()||!e.isWidget()}},PanelVO.prototype.getProps=function(){return BaseVO.prototype.getProps().concat("name","type","columnCount","fields")},PanelVO.prototype.postBuild=function(){this.fields=_.sortBy(this.fields.map(function(e){return(new FieldVO).build(e)}),"displayOrder"),this.shortId=this.name.substr(0,1).toLowerCase()+this.name.substr(1).replace(" ",""),processGroupFields(this.fields)},PanelVO.prototype.contains=function(e){return this.fields.some(function(t){return t.name===e.name})},PanelVO.prototype.hasAvailableSlots=function(){var e=0;return this.fields.forEach(function(t){t.isGroupField()?e+=t.members.length:e++}),e<this.getPanelMaxFields()},PanelVO.prototype.addField=function(e){if(e.id){var t=this.removedFields.indexOf(e);t>-1?this.removedFields.splice(t,1):this.addedFields.push(e)}else this.addedFields.push(e);"group"===e.dataType?this.fields.push(e):_.findIndex(this.fields,{name:e.name})===-1&&this.fields.push(e),this.addFieldAllowed=this.hasAvailableSlots()},PanelVO.prototype.removeField=function(e){var t=this.fields.indexOf(e);t>-1&&(this.fields.splice(t,1),e.id?(e.isNewField||this.removedFields.push(e),_.remove(this.addedFields,{name:e.name})):_.remove(this.addedFields,{name:e.name})),this.addFieldAllowed=this.hasAvailableSlots()},PanelVO.prototype.removeFieldFromGroup=function(e){e.isNewField?_.remove(this.addedFields,{name:e.name}):this.removedFields.push(e),this.addFieldAllowed=this.hasAvailableSlots()},PanelVO.prototype.removeWidgetMemberField=function(e){e.id?this.removedFields.push(e):_.remove(this.addedFields,{name:e.name}),this.addFieldAllowed=this.hasAvailableSlots()},PanelVO.prototype.initFields=function(e){var t=this.shortId,a=[];if("typeSpecific"===t){var n=this.classId;_.each(this.fields,function(e){for(var t=0;t<e.extension.length;t++)if(e.extension[t].classId===n){a.push(e);break}}),this.fields=a}this.fields=_.reject(this.fields,function(e){return!!e.groupMember}),this.fields.forEach(function(t){e[t.name]&&(t.label=e[t.name].label,t.sealed=e[t.name].isSealed())})},PanelVO.prototype.isValid=function(){return 0===this.fields.filter(function(e){return!e.isValid()}).length},PanelVO.prototype.hasCustomFields=function(){return this.fields&&this.fields.length},PanelVO.prototype.initValueFieldNames=function(e){this.fields.forEach(function(t){t.linkedFieldExist&&(t.valueFieldName=e[t.valueField]),t.members.forEach(function(t){t.linkedFieldExist&&(t.valueFieldName=e[t.valueField])})})},PanelVO.prototype.getPanelMaxFields=function(){return this.MAX_FIELDS_BY_PANELS[this.name]||this.MAX_FIELDS},PanelVO.prototype.isFieldAvailableOnPanel=function(e){var t=this.FIELD_RESTRICTIONS_BY_PANEL[this.name];return!t||t(e)},PanelVO.prototype.isHeaderSection=function(){return["titleBar","titleBarPanel"].indexOf(this.name)!==-1},ScreenConfigurationVO.prototype=Object.create(BaseVO.prototype),ScreenConfigurationVO.prototype.constructor=ScreenConfigurationVO,ScreenConfigurationVO.prototype.getProps=function(){return["id","name","title","datasource","panels"]},ScreenConfigurationVO.prototype.postBuild=function(){this.panels=this.panels.map(function(e){return(new PanelVO).build(e)});var e=this.id,t=this.title,a=this.datasource,n=this.name;this.panels.forEach(function(i){i.parentScreenId=e,i.parentScreenTitle=t,i.parentScreenName=n,i.dataSource=a})},ScreenConfigurationVO.prototype.getFields=function(){var e=[];return this.panels.forEach(function(t){t.fields.forEach(function(a){a.panelId=t.id,e.push(a)})}),e},ScreenConfigurationVO.prototype.getPanelByName=function(e){return _.find(this.panels,{name:e})},ScreenConfigurationVO.prototype.INCIDENT_DETAILS_SCREEN="incidentDetailsScreen",ScreenConfigurationVO.prototype.WORK_ORDER_DETAILS_SCREEN="workOrderDetailsScreen",ScreenConfigurationVO.prototype.TASK_DETAILS_SCREEN="taskDetailsScreen",ScreenConfigurationVO.prototype.PERSON_DETAILS_SCREEN="personDetailsScreen",ScreenConfigurationVO.prototype.CHANGE_REQUEST_SCREEN="changeRequestScreen",ScreenConfigurationVO.prototype.PROBLEM_DETAILS_SCREEN="problemScreen",ScreenConfigurationVO.prototype.KNOWN_ERROR_DETAILS_SCREEN="knownErrorScreen",ScreenConfigurationVO.prototype.ASSET_SCREEN="assetScreen",ScreenConfigurationVO.prototype.INCIDENT_VIEW_SCREEN="incidentViewScreen",ScreenConfigurationVO.prototype.WORK_ORDER_VIEW_SCREEN="workOrderViewScreen",ScreenConfigurationVO.prototype.TASK_VIEW_SCREEN="taskViewScreen",ScreenConfigurationVO.prototype.CHANGE_VIEW_SCREEN="changeViewScreen",ScreenConfigurationVO.prototype.CREATE_INCIDENT_SCREEN="createIncidentScreen",ScreenConfigurationVO.prototype.CREATE_WORK_ORDER_SCREEN="createWorkOrderScreen",ScreenConfigurationVO.prototype.CREATE_TASK_SCREEN="createTaskScreen",ScreenConfigurationVO.prototype.CREATE_CHANGE_SCREEN="createChangeScreen",ScreenConfigurationVO.prototype.V2_COMPATIBLE_SCREENS=[ScreenConfigurationVO.prototype.INCIDENT_VIEW_SCREEN,ScreenConfigurationVO.prototype.CREATE_INCIDENT_SCREEN,ScreenConfigurationVO.prototype.CHANGE_VIEW_SCREEN,ScreenConfigurationVO.prototype.CREATE_CHANGE_SCREEN,ScreenConfigurationVO.prototype.WORK_ORDER_VIEW_SCREEN,ScreenConfigurationVO.prototype.CREATE_WORK_ORDER_SCREEN,ScreenConfigurationVO.prototype.TASK_VIEW_SCREEN,ScreenConfigurationVO.prototype.CREATE_TASK_SCREEN],ScreenConfigurationVO.prototype.CREATE_SCREENS=[ScreenConfigurationVO.prototype.CREATE_CHANGE_SCREEN,ScreenConfigurationVO.prototype.CREATE_INCIDENT_SCREEN,ScreenConfigurationVO.prototype.CREATE_WORK_ORDER_SCREEN,ScreenConfigurationVO.prototype.CREATE_TASK_SCREEN],ScreenConfigurationVO.prototype.isV2Compatible=function(e){return e||(e=this.name),this.V2_COMPATIBLE_SCREENS.indexOf(e)!==-1},ScreenConfigurationVO.prototype.isCreateScreen=function(e){return e||(e=this.name),ScreenConfigurationVO.prototype.CREATE_SCREENS.indexOf(e)!==-1},ScreenConfigurationVO.prototype.getScreenOrderNumber=function(){return ScreenConfigurationVO.prototype.V2_COMPATIBLE_SCREENS.indexOf(this.name)},ScreenConfigurationVO.prototype.isTicketEnabledForProviderActionExpression=function(e){return e===EntityVO.TYPE_INCIDENT||e===EntityVO.TYPE_CHANGE||e===EntityVO.TYPE_WORKORDER||e===EntityVO.TYPE_TASK},$(function(){function e(){$.getJSON("/smartit/rest/map_api_properties").always(function(e){bmcMaps.adapters.init(e).always(function(){t()})})}function t(){$.cookie("user_locale")&&(f=$.cookie("user_locale").value?$.cookie("user_locale").value:$.cookie("user_locale")),f?(h=f,f=o(f),a()):$.ajax("/smartit/rest/serverstates/acceptLanguage",{cache:!1,success:function(e){f=i(e),a()}})}function a(){window.myitsmLocale=f,window.showMeridian=c(h),$("html").attr("lang",f),/(msie) ([\w.]+)/.exec(navigator.userAgent.toLowerCase())&&$.cookie("myitsm_locale",f,{expires:31}),u.indexOf(f)>-1&&(window.isRtl=!0,n()),$.when($.getScript(s(h.toLowerCase())),$.getJSON("scripts/app/i18n/resources-locale_"+f+".json"),$.getScript(l(g.toLowerCase()))).fail(function(){return $.when($.getScript(s(p)),$.getJSON("scripts/app/i18n/resources-locale_"+p+".json"),$.getScript(l(p))).then(r)}).then(r)}function n(){var e={development:["styles/vendor/bootstrap/bootstrap-rtl.css","styles/css/smart-it-rtl.css"],distribution:["styles/vendor/css/vendor-rtl.min.css","styles/css/smart-it-rtl.min.css"]},t="";window.ENV&&($.each(e[window.ENV],function(e,a){t+='<link rel="stylesheet" href="'+a+'" />'}),$("head").append(t))}function i(e){if(!e)return p;for(var t=e.trim().toLowerCase().split(";"),a=0;a<t.length;a++)for(var n=t[a].split(","),i=0;i<n.length;i++){var o=n[i];if(o.search("q=")===-1){if(d.indexOf(o)!==-1)return h=g=o,o;var r=o.substr(0,2);if(d.indexOf(r)!==-1)return h=o,g="en-au"===o.toLowerCase()?o:r,r}}return p}function o(e){if(e){if(e=e.toLowerCase(),d.indexOf(e)!==-1)return g=e,e;var t=e.substr(0,2);if(d.indexOf(t)!==-1)return g="en-us"===e.toLowerCase()?e:t,t}return p}function r(){window.appLocalilzation=arguments[1][0],angular.bootstrap(document.documentElement,["myitsmApp"])}function s(e){return moment.locale("zh"===e?"zh-cn":e),"scripts/vendor/angular-i18n/angular-locale_"+e+".js"}function l(e){return"scripts/app/i18n-custom/angular-custom-locale_"+e+".js"}function c(e){var t=new Date,a=new Date(t);return a.setHours(t.getHours()+12),t=t.toLocaleTimeString(e).match(/\d+/),a=a.toLocaleTimeString(e).match(/\d+/),!(0==t[0]||t[0]>12||0==a[0]||a[0]>12)}var d=["de","en","en-ca","es","fr","fr-ca","he","it","ja","ko","pl","pt","ru","zh"],u=["he"],p="en",m=window.navigator,f=!window.navigator.userAgent.match(/Trident\/7\./)&&(m.languages&&m.languages[0]||m.language)||$.cookie("myitsm_locale"),g=p,h=p;jQuery.ajaxSetup({cache:!0}),e(),"function"!=typeof String.prototype.trimLeft&&(String.prototype.trimLeft=function(){return this.replace(/^\s+/g,"")}),"function"!=typeof String.prototype.trim&&(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),"function"!=typeof String.prototype.trimRight&&(String.prototype.trimRight=function(){return this.replace(/\s+$/g,"")}),String.prototype.startsWith||Object.defineProperty(String.prototype,"startsWith",{value:function(e,t){return t=!t||t<0?0:+t,this.substring(t,t+e.length)===e}})}),function(){angular.module("myitsmApp").controller("MainController",["$scope","$state","$filter","session","l10nModel","authModel","ccsModel","userModel","searchModel","studioModel","$window","AUTH_EVENTS","$timeout","chatModel","emailModel","mobileClientCheckerService","systemAlertService","i18nService","$rootScope","$http","$modal","$cookies","$sce","events","personModel","localStorageService","utilityFunctions","configurationModel","$q","$location","browser","gainsightModel",function(e,t,a,n,i,o,r,s,l,c,d,u,p,m,f,g,h,y,E,v,T,S,C,O,A,I,b,k,D,R,P,w){"ngInject";function L(){v({method:"GET",url:"/smartit/rest/keepAlive"}).then(function(){},function(e){console.error("keepAlive : "+e)})}function L(){v({method:"GET",url:"/smartit/rest/keepAlive"}).then(function(){},function(e){console.error("keepAlive : "+e)})}function N(a,n){var i,o=n.eventData?n.eventData:null;if(o)if(i=n.eventData.split("|"),"assetPV"===a||"asset"===a)i&&2===i.length&&t.go(a,{assetId:i[0],assetClassId:i[1]},{location:!e.isLastStateDraft||"replace"});else if("broadcast"===a)t.go("dashboard");else{if(!P.isMobile&&"openKnowledgeArticle"===n.eventType)return e.selectedItem={id:o,type:"knowledge"},i&&i.length>=2&&(e.selectedItem.id=i[0],e.selectedItem.showSaveAndResolve="true"===i[1],e.selectedItem.showDeleteFromTicket="true"===i[2],e.selectedItem.showSaveToTicket="true"===i[3]),T.open({template:'<pwa-rs-preview resource-preview-item="selectedItem" close-modal="closeModal()" class="full-height"></pwa-rs-preview>',windowClass:"action-blade preview",size:"lg",backdrop:"false",controller:["$scope","$modalInstance","selectedItem",function(e,t,a){e.selectedItem=a,e.closeModal=function(){t.close()}}],resolve:{selectedItem:function(){return e.selectedItem}}});var r="#/"+a+"/"+i[0];i&&2===i.length&&"newTab"===i[1]?window.open(r,"_blank"):window.open(r,"_top")}}function M(t){if("string"==typeof t.data&&b.checkIfJson(t.data)){var a=JSON.parse(t.data);if(a.action&&"eventRelayedFromIS"===a.action){var n=JSON.parse(a.eventData),i=[{openEvent:"openIncident",name:"incidentPV"},{openEvent:"openWorkorder",name:"workorderPV"},{openEvent:"openRequest",name:"request"},{openEvent:"openChange",name:"changePV"},{openEvent:"openKnownError",name:"knownerrorPV"},{openEvent:"openProblem",name:"problemPV"},{openEvent:"openRelease",name:"releasePV"},{openEvent:"openTask",name:"taskPV"},{openEvent:"openOutage",name:"outage"},{openEvent:"openKnowledgeArticle",name:"knowledge"},{openEvent:"openPersonProfile",name:"personPV"},{openEvent:"openAsset",name:"assetPV"},{openEvent:"openActivity",name:"activityPV"},{openEvent:"openSBERequest",name:"sberequest"}],r=_.find(i,{openEvent:n.eventType});r&&N(r.name,n)}if(a.action&&"keepAlive"===a.action?L():a.homeServer&&(localStorage.setItem("homeServer",a.homeServer),o.isSSOEnabled()&&e.sendMessageToPwaDomain({isSsoEnabled:!0}),e.homeServerDefer.resolve()),a.parent&&a.action&&"hideNavigationBar"===a.action&&(E.hasParent=!0,E.hideNavigationBar=!0),"rx-runtime-view-ready"===a.messageType&&(c.enableISCalendar||c.enableSharedConsole||c.enableISAssetConsole||c.enableHelixGPTGlobalChat)){var s=document.getElementsByClassName("app__studio-iframe")&&document.getElementsByClassName("app__studio-iframe").length?document.getElementsByClassName("app__studio-iframe")[0].contentWindow:null,l=JSON.stringify({messageType:"rx-runtime-view-keep-session-alive"});s&&c.baseUrlForIS?(s.postMessage(l,c.baseUrlForIS),console.log("Keep session alive message sent to IS frame:"+l)):console.warn("IS frame not found")}}}function V(e){var t=e.lastIndexOf("/");return t===e.length-1&&(e=e.substr(0,t)),e.search("/arsys")>-1?e:e+"/arsys"}function F(){var t=document.getElementsByClassName("app__pwa-iframe");console.info("Inside setPwaFrameUrl method - url : "+e.finalUrl),t&&0!==t.length?e.finalUrl&&(setTimeout(function(){t[0].contentWindow.location.replace(e.finalUrl)}),console.info("Inside setPwaFrameUrl method - location url changed")):console.error("Inside setPwaFrameUrl method : pwa iframe not loaded")}function x(){if((c.enableISCalendar||c.enableSharedConsole||c.enableISAssetConsole||c.enableHelixGPTGlobalChat)&&window.location.hash.indexOf("Studio")===-1){var e=document.getElementsByClassName("app__studio-iframe");if(console.info("Inside setStudioFrameUrl method - url : Setting iframe blank"),e&&0!==e.length){var t=c.baseUrlForIS+"/helix/index.html#/com.bmc.dsm.itsm-applications/iview/com.bmc.dsm.itsm-applications:Placeholder%20view%20for%20nav%20items";setTimeout(function(){e[0].contentWindow.location.replace(t)}),console.info("Inside setStudioFrameUrl method - Setting iframe blank: "+t)}else setTimeout(function(){var e=document.getElementsByClassName("app__studio-iframe");if(console.info("Inside setStudioFrameUrl method - url : Setting iframe blank"),e&&0!==e.length){var t=c.baseUrlForIS+"/helix/index.html#/com.bmc.dsm.itsm-applications/iview/com.bmc.dsm.itsm-applications:Placeholder%20view%20for%20nav%20items";e[0].contentWindow.location.replace(t),console.info("Inside setStudioFrameUrl method - Setting iframe blank: "+t)}else console.error("Inside setStudioFrameUrl method : studio iframe not loaded")},1e3)}}function G(e,t){switch(e.name){case"pwaDraftIncident":return t?t+"_CREATEINCIDENT":"SMARTRECORDER_CREATEINCIDENT";case"pwaDraftWorkorder":return t?t+"_CREATEWORKORDER":"SMARTRECORDER_CREATEWORKORDER";case"pwaDraftProblem":return t?t+"_CREATEPROBLEM":"";case"pwaDraftKnownerror":return t?t+"_CREATEKNOWNERROR":"";case"pwaDraftChange":return t?t+"_CREATECHANGE":"";default:return""}}function B(t,a,n){if(E.hideNavigationBar=!!E.hasParent||a&&a.name.indexOf("changeCalendar")!==-1,e.insideIframe=!!(a&&a.name&&_.endsWith(a.name,"Preview")),a&&a.name&&_.endsWith(a.name,"Studio"))E.showStudioFrame=!0,e.finalUrl=U();else if(localStorage.getItem("midtierUrl")){E.showStudioFrame=!1,c.ccsFetched?x():e.studioCCSDetailsDefer.promise.then(function(){x()});var i=n&&n.id?n.id:null;!a||"assetPV"!==a.name&&"editAssetPV"!==a.name||(i=n.assetId+"|"+n.assetClassId);var r=n&&n.crossLaunchContext?n.crossLaunchContext:"",s=a&&a.name&&(_.endsWith(a.name,"PV")||a.name.indexOf("pwaDraft")>=0),l=["search.incidentPV","search.workorderPV","search.taskPV","search.problemPV","search.problemPV","search.knownerrorPV","search.personPV","search.assetPV","search.changePV"];if("true"===localStorage.getItem("enableReleasePV")&&l.push("search.releasePV","search.activityPV"),s&&!_.includes(l,a.name)){var d=U(a);a.data.targetForm&&(d+="&targetForm="+a.data.targetForm),a.data.targetView&&(d+="&targetView="+a.data.targetView),a.data.mode&&(d+="&mode="+a.data.mode),i&&(a.data.targetForm&&"People"===a.data.targetForm&&(i=encodeURIComponent(i)),d+=a.data.targetForm?"&targetId="+i:"&guid="+i),a.name.indexOf("pwaDraft")>=0?d+="&context="+G(a,r):a.name.indexOf("edit")!=-1&&n.context&&(d+="&context="+n.context),E.showFrame=!0,e.finalUrl=d+"&rand="+Math.random()}else a.name.indexOf("pwaAction")>=0&&n.data&&n.data.formName?(E.showFrame=!0,e.finalUrl=U(n,!0)):(E.showFrame=!1,e.finalUrl=U())}else E.showStudioFrame=!1;if(Z){var u=V(o.getMidtierUrl());u&&localStorage.getItem("midtierUrl")&&u!==localStorage.getItem("midtierUrl")&&(localStorage.setItem("midtierUrl",u),B(t,a,n))}else e.midTierUrlDeferred.promise.then(function(e){console.log("Midtier URL: "+e),Z=!0,B(t,a,n)})}function U(e,t){var a=localStorage.getItem("midtierUrl");if(!a)return console.warn("Mid-tier URL is not available"),"about:blank";var n=localStorage.getItem("homeServer"),i=window.location.origin,o="goto",r="";n&&(o="forms/"+n);var s=e&&e.data&&e.data.formName?o+"/"+e.data.formName:"fake-route";return r=a+"/pwa/#/"+s,t||(r+="?origin="+i),r}function z(){console.log("$scope.$on(AUTH_EVENTS.SESSION_ACTIVE)"),window.localStorage.sessionActive=!0,e.sendMessageToPwaDomain({smartITsessionActive:window.localStorage.sessionActive}),1==window.localStorage.tabCount&&o.deRegister(),q()}function Y(){H(),K(),j(),p(function(){e.appState=Q.INDETERMINATE,I.remove("user.userId"),sessionStorage.removeItem("calendarFilterState"),sessionStorage.removeItem("calendarFilterView"),sessionStorage.removeItem("calendarFilterDate"),n.destroy(),localStorage.removeItem("tabCount"),localStorage.sessionActive=!1,localStorage.removeItem("smartITActivity"),e.sendMessageToPwaDomain({smartITsessionActive:window.localStorage.sessionActive}),d.location.href="./"},1e3)}function q(){e.appState=Q.INDETERMINATE,s.getUserDataForCurrentSession(),i.loadSystemMessages(),W()}function H(){localStorage.homeServer&&localStorage.removeItem("homeServer"),e.sendMessageToPwaDomain({message:"logout",logout:!0})}function K(){if(c.enableISCalendar||c.enableSharedConsole||c.enableISAssetConsole||c.enableHelixGPTGlobalChat){var e=document.getElementsByClassName("app__studio-iframe")&&document.getElementsByClassName("app__studio-iframe").length?document.getElementsByClassName("app__studio-iframe")[0].contentWindow:null,t=JSON.stringify({messageType:"rx-runtime-view-logout",payload:{redirectToLoginPage:!1}});e&&c.baseUrlForIS?(e.postMessage(t,c.baseUrlForIS),console.log("Message sent To IS Frame:"+t)):console.warn("IS frame not found")}}function j(){var e=I.get("eschatServerUrl");if(e){var t=window.frames.liveChatFrame;if(void 0!==t&&null!==t){var a={event:"app_logout",data:{logout:!0,isRSSO:o.isSSOEnabled()}};t.postMessage(a,e),console.log("Message Sent To LiveChat Frame:"+JSON.stringify(a)),I.remove("eschatServerUrl")}return!0}return!1}function W(){if(e.showMeridian=window.showMeridian,c.init().then(function(t){e.studioCCSDetailsDefer.resolve(t)}),l.init(),e.chatModel=m,e.userModel=s,e.emailModel={emailInstances:f.emailInstances},e.state.$current.data&&e.state.$current.data.separateWindowMode)e.appState=Q.SHOW_WINDOW;else{var t=!!S.get("accessibility")&&JSON.parse(S.get("accessibility"));s.getUserPreferences("interface").then(function(a){(_.isObject(a[0])||t)&&(s.isAccessibleUser=!!_.isObject(a[0])&&a[0].value,s.isAccessibleUserPreferenceId=_.isObject(a[0])?a[0].id:null,s.isAccessibleUser!==t&&e.setAccessibility())})["finally"](function(){e.appState=Q.SHOW_MAIN})}e.$on("$viewContentLoaded",function(){m.connected||e.isMobile||m.openChatConnection(),F()})}var Q={INDETERMINATE:-1,SHOW_LOGIN:0,SHOW_MAIN:1,SHOW_WINDOW:2},J={DashBoardWithHash:"#/","Ticket Console":"ticket-consoleStudio","Asset Console":"asset-consoleStudio","Knowledge Console":"knowledge-console","Smart Recorder":"create/smart-recorder",Calendar:"calendarStudio"};e.homeServerDefer=D.defer(),e.isMobile=P.isMobile,e.insideChangeCalendar=!1,e.$on(O.INSIDE_CHANGE_CALENDAR,function(t){e.insideChangeCalendar=!0}),e.studioCCSDetailsDefer=D.defer(),E.showStudioFrame=!1,E.studioFrameUrl=C.trustAsResourceUrl(""),window.onmessage=M,e.iframeLoadedCallBack=function(){e.pwaFrameLoaded=!0,E.$broadcast(O.PWA_IFRAME_LOADED)},e.midTierUrlDeferred=D.defer();var Z=!1;E.$on(O.MIDTIER_URL_LOADED,function(t,a){var n=o.getMidtierUrl(),i=V(n);localStorage.setItem("midtierUrl",i),localStorage.setItem("pwaDomain",n.search("arsys")>-1?n.substr(0,n.lastIndexOf("/")):n),n&&(e.pwaHomeSrc=C.trustAsResourceUrl(i+"/pwa/login-light.html?origin="+window.location.origin)),e.midTierUrlDeferred.resolve(i)}),e.APP_STATES=Q,e.appState=Q.INDETERMINATE,e.state=t;var X=E.$on("i18nResourcesUpdated",function(){g.checkForMobileDevice()});e.$on("$destroy",function(){console.log("destroy root scope events bound from here"),X()}),$(document).ready(function(){window.localStorage.tabCount?window.localStorage.tabCount++:window.localStorage.tabCount=1}),window.addEventListener("beforeunload",function(e){if(window.localStorage.tabCount&&window.localStorage.tabCount--,0==window.localStorage.tabCount&&"true"==window.localStorage.sessionActive)if(navigator.sendBeacon)navigator.sendBeacon("/smartit/rest/arlicense/timeout/register");else{var t=new XMLHttpRequest;t.open("POST","/smartit/rest/arlicense/timeout/register",!1),t.send()}}),setInterval(function(){"true"==window.localStorage.smartITActivity&&(e.sendMessageToPwaDomain({keepAlive:"true"}),window.localStorage.smartITActivity="false")},6e4),e.$on("$stateChangeSuccess",function(e,t,a){B(e,t,a)}),e.sendMessageToPwaDomain=function(t){if(localStorage.getItem("midtierUrl")){var a=localStorage.getItem("pwaDomain");if(a){console.info("pwa iframe load status : "+e.pwaFrameLoaded);var n=setInterval(function(){console.info("sendMessageToPwaDomain - setInterval");var i=document.getElementsByClassName("app__pwa-home-iframe")&&document.getElementsByClassName("app__pwa-home-iframe").length?document.getElementsByClassName("app__pwa-home-iframe")[0].contentWindow:null;null!=i&&e.pwaFrameLoaded&&(console.info("message sent to pwa iframe "),b.windowPostMessage(i,t,a),clearInterval(n))})}}},e.onLogoutClick=function(){H(),K(),j(),p(function(){e.appState=Q.INDETERMINATE,o.logout()},1e3)},e.onOptinConfigClick=function(){w.showOptinConfig()},e.onAboutClick=function(){T.open({templateUrl:"views/about.html",windowClass:"bmc-system-about-modal",size:"lg"})},e.toggleAccessibility=function(){s.isAccessibleUser=!s.isAccessibleUser,e.setAccessibility()},e.setAccessibility=function(){var e=new Date;e.setDate(e.getDate()+365),"https"===R.protocol()?S.put("accessibility",s.isAccessibleUser,{expires:e,secure:!0,samesite:"strict"}):S.put("accessibility",s.isAccessibleUser,{expires:e,samesite:"strict"}),s.updateUserPreferences("interface",{id:s.isAccessibleUserPreferenceId,name:"accessibility",value:s.isAccessibleUser})},e.setFocus=function(e){$("#"+e).focus()},e.$on(u.LOGIN_SUCCESS,function(t,a){console.log("$scope.$on(AUTH_EVENTS.LOGIN_SUCCESS)");var i=[];J.DashBoardWithHash===window.location.hash?(i.push(r.getCCSParameters()),localStorage.midtierUrl&&!a.isSsoEnabled&&"T"!==localStorage.getItem("overridePV")&&i.push(e.homeServerDefer.promise),D.all(i).then(function(t){e.ccsProperties=t[0],e.ccsProperties&&e.ccsProperties.landingPage&&J[e.ccsProperties.landingPage]&&("calendar"===J[e.ccsProperties.landingPage]&&e.ccsProperties.calendarFeatureEnabled&&"false"===e.ccsProperties.calendarFeatureEnabled.trim()?console.log("Landing page :: Dashboard. calendarFeatureEnabled :"+e.ccsProperties.calendarFeatureEnabled):(console.log("Landing page :: Diverting to  === "+J[e.ccsProperties.landingPage]),e.isMobile?window.location.hash=J["Ticket Console"]:window.location.hash=J[e.ccsProperties.landingPage])),a.isSsoEnabled?n.alive&&(console.info("location hash : session alive"),e.sendMessageToPwaDomain({isSsoEnabled:a.isSsoEnabled}),z(),e.isMobile&&(window.location.hash=J["Ticket Console"])):window.location.reload(!1)})):a.isSsoEnabled?n.alive&&(console.info("session alive"),e.sendMessageToPwaDomain({isSsoEnabled:a.isSsoEnabled}),z()):(localStorage.midtierUrl?i.push(e.homeServerDefer.promise):i.push(Promise.resolve()),D.all(i).then(function(){window.location.reload(!1)}))}),e.$on(u.LOGOUT_SUCCESS,function(t,a){if(console.log("$scope.$on(AUTH_EVENTS.LOGOUT_SUCCESS)"),localStorage.removeItem("tabCount"),window.localStorage.sessionActive=!1,localStorage.removeItem("smartITActivity"),e.sendMessageToPwaDomain({smartITsessionActive:window.localStorage.sessionActive}),o.isSSOEnabled())if(a&&a.postLogoutUrl){var n=a.postLogoutUrl;n+=n.indexOf("?")>-1?"&callback=JSON_CALLBACK":"?callback=JSON_CALLBACK",v.jsonp(n)["finally"](function(){d.location.href="./?"+moment().valueOf()})}else a&&a.redirectUrl?d.location.href=a.redirectUrl:d.location.href="./?"+moment().valueOf();else d.location.href="./"}),e.$on(u.SESSION_ACTIVE,z),e.$on(u.NOT_AUTHENTICATED,function(){console.log("$scope.$on(AUTH_EVENTS.NOT_AUTHENTICATED)"),e.appState=Q.SHOW_LOGIN}),e.$on(u.AR_CONNECTION_FAILED,function(e,t){console.log("$scope.$on(AUTH_EVENTS.AR_CONNECTION_FAILED)"),h.error({text:t.data.error})}),e.$on(u.SESSION_EXPIRED,function(){if(console.log("$scope.$on(AUTH_EVENTS.SESSION_EXPIRED)"),window.localStorage.sessionActive=!1,e.sendMessageToPwaDomain({smartITsessionActive:window.localStorage.sessionActive}),localStorage.removeItem("tabCount"),localStorage.removeItem("smartITActivity"),o.isSSOEnabled()){e.appState=Q.INDETERMINATE;var t=h.modal({title:a("i18n")("error.sessionExpired.title"),text:a("i18n")("error.sessionExpired.message"),backdrop:"static",buttons:[{text:y.getLocalizedString("common.button.signInAgain"),data:!0}]});t.result.then(function(e){e&&(localStorage.removeItem("homeServer"),d.location.reload())})}else H(),K(),e.appState=Q.SHOW_LOGIN}),e.$on(u.INITIALIZE_METADATA_ERROR,function(){if(!e.showingErrorModal){e.appState=Q.INDETERMINATE,e.showingErrorModal=!0,console.log("$scope.$on(AUTH_EVENTS.INITIALIZE_METADATA_ERROR)"),window.localStorage.sessionActive=!1,e.sendMessageToPwaDomain({smartITsessionActive:window.localStorage.sessionActive}),localStorage.removeItem("tabCount"),localStorage.removeItem("smartITActivity");var t=h.modal({title:a("i18n")("error.invalidMetadata.title"),text:a("i18n")("error.invalidMetadata.message"),backdrop:"static",buttons:[{text:y.getLocalizedString("common.button.signInAgain"),data:!0}]});t.result.then(function(t){e.showingErrorModal=!1,t&&o.isSSOEnabled()?d.location.reload():t&&Y()})}})}])}();